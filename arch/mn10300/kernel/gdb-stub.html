<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › mn10300 › kernel › gdb-stub.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>gdb-stub.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* MN10300 GDB stub</span>
<span class="cm"> *</span>
<span class="cm"> * Originally written by Glenn Engel, Lake Stevens Instrument Division</span>
<span class="cm"> *</span>
<span class="cm"> * Contributed by HP Systems</span>
<span class="cm"> *</span>
<span class="cm"> * Modified for SPARC by Stu Grossman, Cygnus Support.</span>
<span class="cm"> *</span>
<span class="cm"> * Modified for Linux/MIPS (and MIPS in general) by Andreas Busse</span>
<span class="cm"> * Send complaints, suggestions etc. to &lt;andy@waldorf-gmbh.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1995 Andreas Busse</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007 Red Hat, Inc. All Rights Reserved.</span>
<span class="cm"> * Modified for Linux/mn10300 by David Howells &lt;dhowells@redhat.com&gt;</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *  To enable debugger support, two things need to happen.  One, a</span>
<span class="cm"> *  call to set_debug_traps() is necessary in order to allow any breakpoints</span>
<span class="cm"> *  or error conditions to be properly intercepted and reported to gdb.</span>
<span class="cm"> *  Two, a breakpoint needs to be generated to begin communication.  This</span>
<span class="cm"> *  is most easily accomplished by a call to breakpoint().  Breakpoint()</span>
<span class="cm"> *  simulates a breakpoint by executing a BREAK instruction.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *    The following gdb commands are supported:</span>
<span class="cm"> *</span>
<span class="cm"> * command          function                               Return value</span>
<span class="cm"> *</span>
<span class="cm"> *    g             return the value of the CPU registers  hex data or ENN</span>
<span class="cm"> *    G             set the value of the CPU registers     OK or ENN</span>
<span class="cm"> *</span>
<span class="cm"> *    mAA..AA,LLLL  Read LLLL bytes at address AA..AA      hex data or ENN</span>
<span class="cm"> *    MAA..AA,LLLL: Write LLLL bytes at address AA.AA      OK or ENN</span>
<span class="cm"> *</span>
<span class="cm"> *    c             Resume at current address              SNN   ( signal NN)</span>
<span class="cm"> *    cAA..AA       Continue at address AA..AA             SNN</span>
<span class="cm"> *</span>
<span class="cm"> *    s             Step one instruction                   SNN</span>
<span class="cm"> *    sAA..AA       Step one instruction from AA..AA       SNN</span>
<span class="cm"> *</span>
<span class="cm"> *    k             kill</span>
<span class="cm"> *</span>
<span class="cm"> *    ?             What was the last sigval ?             SNN   (signal NN)</span>
<span class="cm"> *</span>
<span class="cm"> *    bBB..BB	    Set baud rate to BB..BB		   OK or BNN, then sets</span>
<span class="cm"> *							   baud rate</span>
<span class="cm"> *</span>
<span class="cm"> * All commands and responses are sent with a packet which includes a</span>
<span class="cm"> * checksum.  A packet consists of</span>
<span class="cm"> *</span>
<span class="cm"> * $&lt;packet info&gt;#&lt;checksum&gt;.</span>
<span class="cm"> *</span>
<span class="cm"> * where</span>
<span class="cm"> * &lt;packet info&gt; :: &lt;characters representing the command or response&gt;</span>
<span class="cm"> * &lt;checksum&gt;    :: &lt; two hex digits computed as modulo 256 sum of &lt;packetinfo&gt;&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * When a packet is received, it is first acknowledged with either &#39;+&#39; or &#39;-&#39;.</span>
<span class="cm"> * &#39;+&#39; indicates a successful transfer.  &#39;-&#39; indicates a failed transfer.</span>
<span class="cm"> *</span>
<span class="cm"> * Example:</span>
<span class="cm"> *</span>
<span class="cm"> * Host:                  Reply:</span>
<span class="cm"> * $m0,10#2a               +$00010203040506070809101112131415#42</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *  ==============</span>
<span class="cm"> *  MORE EXAMPLES:</span>
<span class="cm"> *  ==============</span>
<span class="cm"> *</span>
<span class="cm"> *  For reference -- the following are the steps that one</span>
<span class="cm"> *  company took (RidgeRun Inc) to get remote gdb debugging</span>
<span class="cm"> *  going. In this scenario the host machine was a PC and the</span>
<span class="cm"> *  target platform was a Galileo EVB64120A MIPS evaluation</span>
<span class="cm"> *  board.</span>
<span class="cm"> *</span>
<span class="cm"> *  Step 1:</span>
<span class="cm"> *  First download gdb-5.0.tar.gz from the internet.</span>
<span class="cm"> *  and then build/install the package.</span>
<span class="cm"> *</span>
<span class="cm"> *  Example:</span>
<span class="cm"> *    $ tar zxf gdb-5.0.tar.gz</span>
<span class="cm"> *    $ cd gdb-5.0</span>
<span class="cm"> *    $ ./configure --target=am33_2.0-linux-gnu</span>
<span class="cm"> *    $ make</span>
<span class="cm"> *    $ install</span>
<span class="cm"> *    am33_2.0-linux-gnu-gdb</span>
<span class="cm"> *</span>
<span class="cm"> *  Step 2:</span>
<span class="cm"> *  Configure linux for remote debugging and build it.</span>
<span class="cm"> *</span>
<span class="cm"> *  Example:</span>
<span class="cm"> *    $ cd ~/linux</span>
<span class="cm"> *    $ make menuconfig &lt;go to &quot;Kernel Hacking&quot; and turn on remote debugging&gt;</span>
<span class="cm"> *    $ make dep; make vmlinux</span>
<span class="cm"> *</span>
<span class="cm"> *  Step 3:</span>
<span class="cm"> *  Download the kernel to the remote target and start</span>
<span class="cm"> *  the kernel running. It will promptly halt and wait</span>
<span class="cm"> *  for the host gdb session to connect. It does this</span>
<span class="cm"> *  since the &quot;Kernel Hacking&quot; option has defined</span>
<span class="cm"> *  CONFIG_REMOTE_DEBUG which in turn enables your calls</span>
<span class="cm"> *  to:</span>
<span class="cm"> *     set_debug_traps();</span>
<span class="cm"> *     breakpoint();</span>
<span class="cm"> *</span>
<span class="cm"> *  Step 4:</span>
<span class="cm"> *  Start the gdb session on the host.</span>
<span class="cm"> *</span>
<span class="cm"> *  Example:</span>
<span class="cm"> *    $ am33_2.0-linux-gnu-gdb vmlinux</span>
<span class="cm"> *    (gdb) set remotebaud 115200</span>
<span class="cm"> *    (gdb) target remote /dev/ttyS1</span>
<span class="cm"> *    ...at this point you are connected to</span>
<span class="cm"> *       the remote target and can use gdb</span>
<span class="cm"> *       in the normal fasion. Setting</span>
<span class="cm"> *       breakpoints, single stepping,</span>
<span class="cm"> *       printing variables, etc.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/signal.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/bug.h&gt;</span>

<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#include &lt;asm/gdb-stub.h&gt;</span>
<span class="cp">#include &lt;asm/exceptions.h&gt;</span>
<span class="cp">#include &lt;asm/debugger.h&gt;</span>
<span class="cp">#include &lt;asm/serial-regs.h&gt;</span>
<span class="cp">#include &lt;asm/busctl-regs.h&gt;</span>
<span class="cp">#include &lt;unit/leds.h&gt;</span>
<span class="cp">#include &lt;unit/serial.h&gt;</span>

<span class="cm">/* define to use F7F7 rather than FF which is subverted by JTAG debugger */</span>
<span class="cp">#undef GDBSTUB_USE_F7F7_AS_BREAKPOINT</span>

<span class="cm">/*</span>
<span class="cm"> * BUFMAX defines the maximum number of characters in inbound/outbound buffers</span>
<span class="cm"> * at least NUMREGBYTES*2 are needed for register packets</span>
<span class="cm"> */</span>
<span class="cp">#define BUFMAX 2048</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">gdbstub_banner</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;Linux/MN10300 GDB Stub (c) RedHat 2007</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="n">u8</span>	<span class="n">gdbstub_rx_buffer</span><span class="p">[</span><span class="n">PAGE_SIZE</span><span class="p">]</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">)));</span>
<span class="n">u32</span>	<span class="n">gdbstub_rx_inp</span><span class="p">;</span>
<span class="n">u32</span>	<span class="n">gdbstub_rx_outp</span><span class="p">;</span>
<span class="n">u8</span>	<span class="n">gdbstub_busy</span><span class="p">;</span>
<span class="n">u8</span>	<span class="n">gdbstub_rx_overflow</span><span class="p">;</span>
<span class="n">u8</span>	<span class="n">gdbstub_rx_unget</span><span class="p">;</span>

<span class="k">static</span> <span class="n">u8</span>	<span class="n">gdbstub_flush_caches</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span>	<span class="n">input_buffer</span><span class="p">[</span><span class="n">BUFMAX</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">char</span>	<span class="n">output_buffer</span><span class="p">[</span><span class="n">BUFMAX</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">char</span>	<span class="n">trans_buffer</span><span class="p">[</span><span class="n">BUFMAX</span><span class="p">];</span>

<span class="k">struct</span> <span class="n">gdbstub_bkpt</span> <span class="p">{</span>
	<span class="n">u8</span>	<span class="o">*</span><span class="n">addr</span><span class="p">;</span>		<span class="cm">/* address of breakpoint */</span>
	<span class="n">u8</span>	<span class="n">len</span><span class="p">;</span>		<span class="cm">/* size of breakpoint */</span>
	<span class="n">u8</span>	<span class="n">origbytes</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>	<span class="cm">/* original bytes */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gdbstub_bkpt</span> <span class="n">gdbstub_bkpts</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

<span class="cm">/*</span>
<span class="cm"> * local prototypes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">getpacket</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">putpacket</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">computeSignal</span><span class="p">(</span><span class="k">enum</span> <span class="n">exception_code</span> <span class="n">excep</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hex</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hexToInt</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">intValue</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mem2hex</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">mem</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">may_fault</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hex2mem</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_mem</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">may_fault</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Convert ch from a hex digit to an int</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hex</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&gt;=</span> <span class="sc">&#39;a&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span> <span class="o">&lt;=</span> <span class="sc">&#39;f&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ch</span> <span class="o">-</span> <span class="sc">&#39;a&#39;</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ch</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&gt;=</span> <span class="sc">&#39;A&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span> <span class="o">&lt;=</span> <span class="sc">&#39;F&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ch</span> <span class="o">-</span> <span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_GDBSTUB_DEBUGGING</span>

<span class="kt">void</span> <span class="nf">debug_to_serial</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__debug_to_serial</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
	<span class="cm">/* gdbstub_console_write(NULL, p, n); */</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gdbstub_printk</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="cm">/* Emit the output into the temporary buffer */</span>
	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">vsnprintf</span><span class="p">(</span><span class="n">trans_buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">trans_buffer</span><span class="p">),</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
	<span class="n">debug_to_serial</span><span class="p">(</span><span class="n">trans_buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">gdbstub_strcpy</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">dst</span><span class="p">[</span><span class="n">loop</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="n">loop</span><span class="p">]))</span>
	       <span class="n">loop</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dst</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * scan for the sequence $&lt;data&gt;#&lt;checksum&gt;</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">getpacket</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">checksum</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">xmitcsum</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * wait around for the start character,</span>
<span class="cm">		 * ignore all other characters</span>
<span class="cm">		 */</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">gdbstub_io_rx_char</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ch</span> <span class="o">!=</span> <span class="sc">&#39;$&#39;</span><span class="p">);</span>

		<span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">xmitcsum</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * now, read until a # or end of buffer is found</span>
<span class="cm">		 */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">BUFMAX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">gdbstub_io_rx_char</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">error</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">&#39;#&#39;</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">checksum</span> <span class="o">+=</span> <span class="n">ch</span><span class="p">;</span>
			<span class="n">buffer</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gdbstub_proto</span><span class="p">(</span><span class="s">&quot;### GDB Rx Error - Skipping packet&quot;</span>
				      <span class="s">&quot; ###</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">gdbstub_proto</span><span class="p">(</span><span class="s">&quot;### GDB Tx NAK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">gdbstub_io_tx_char</span><span class="p">(</span><span class="sc">&#39;-&#39;</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">BUFMAX</span> <span class="o">||</span> <span class="n">error</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">buffer</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* read the checksum */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gdbstub_io_rx_char</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">xmitcsum</span> <span class="o">=</span> <span class="n">hex</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">gdbstub_io_rx_char</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">xmitcsum</span> <span class="o">|=</span> <span class="n">hex</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span>
				<span class="n">gdbstub_io</span><span class="p">(</span><span class="s">&quot;### GDB Rx Error -&quot;</span>
					   <span class="s">&quot; Skipping packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">gdbstub_io</span><span class="p">(</span><span class="s">&quot;### GDB Tx NAK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">gdbstub_io_tx_char</span><span class="p">(</span><span class="sc">&#39;-&#39;</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* check the checksum */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">checksum</span> <span class="o">!=</span> <span class="n">xmitcsum</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gdbstub_io</span><span class="p">(</span><span class="s">&quot;### GDB Tx NAK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">gdbstub_io_tx_char</span><span class="p">(</span><span class="sc">&#39;-&#39;</span><span class="p">);</span>	<span class="cm">/* failed checksum */</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">gdbstub_proto</span><span class="p">(</span><span class="s">&quot;### GDB Rx &#39;$%s#%02x&#39; ###</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">checksum</span><span class="p">);</span>
		<span class="n">gdbstub_io</span><span class="p">(</span><span class="s">&quot;### GDB Tx ACK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">gdbstub_io_tx_char</span><span class="p">(</span><span class="sc">&#39;+&#39;</span><span class="p">);</span> <span class="cm">/* successful transfer */</span>

		<span class="cm">/*</span>
<span class="cm">		 * if a sequence char is present,</span>
<span class="cm">		 * reply the sequence ID</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gdbstub_io_tx_char</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">gdbstub_io_tx_char</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

			<span class="cm">/*</span>
<span class="cm">			 * remove sequence chars from buffer</span>
<span class="cm">			 */</span>
			<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">count</span><span class="p">])</span>
				<span class="n">count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">buffer</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * send the packet in buffer.</span>
<span class="cm"> * - return 0 if successfully ACK&#39;d</span>
<span class="cm"> * - return 1 if abandoned due to new incoming packet</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">putpacket</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">checksum</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * $&lt;packet info&gt;#&lt;checksum&gt;.</span>
<span class="cm">	 */</span>
	<span class="n">gdbstub_proto</span><span class="p">(</span><span class="s">&quot;### GDB Tx $&#39;%s&#39;#?? ###</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">gdbstub_io_tx_char</span><span class="p">(</span><span class="sc">&#39;$&#39;</span><span class="p">);</span>
		<span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">((</span><span class="n">ch</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">count</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gdbstub_io_tx_char</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
			<span class="n">checksum</span> <span class="o">+=</span> <span class="n">ch</span><span class="p">;</span>
			<span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">gdbstub_io_tx_char</span><span class="p">(</span><span class="sc">&#39;#&#39;</span><span class="p">);</span>
		<span class="n">gdbstub_io_tx_char</span><span class="p">(</span><span class="n">hex_asc_hi</span><span class="p">(</span><span class="n">checksum</span><span class="p">));</span>
		<span class="n">gdbstub_io_tx_char</span><span class="p">(</span><span class="n">hex_asc_lo</span><span class="p">(</span><span class="n">checksum</span><span class="p">));</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">gdbstub_io_rx_char</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		 <span class="n">ch</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">gdbstub_io</span><span class="p">(</span><span class="s">&quot;### GDB Rx NAK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span>
		 <span class="n">ch</span> <span class="o">!=</span> <span class="sc">&#39;-&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span> <span class="o">!=</span> <span class="sc">&#39;+&#39;</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">gdbstub_io</span><span class="p">(</span><span class="s">&quot;### GDB Rx ??? %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span>
		 <span class="n">ch</span> <span class="o">!=</span> <span class="sc">&#39;+&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span> <span class="o">!=</span> <span class="sc">&#39;$&#39;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">&#39;+&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gdbstub_io</span><span class="p">(</span><span class="s">&quot;### GDB Rx ACK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gdbstub_io</span><span class="p">(</span><span class="s">&quot;### GDB Tx Abandoned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">gdbstub_rx_unget</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * While we find nice hex chars, build an int.</span>
<span class="cm"> * Return number of chars processed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hexToInt</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">intValue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">numChars</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hexValue</span><span class="p">;</span>

	<span class="o">*</span><span class="n">intValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">**</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hexValue</span> <span class="o">=</span> <span class="n">hex</span><span class="p">(</span><span class="o">**</span><span class="n">ptr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hexValue</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="o">*</span><span class="n">intValue</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">intValue</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">hexValue</span><span class="p">;</span>
		<span class="n">numChars</span><span class="o">++</span><span class="p">;</span>

		<span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">numChars</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_GDBSTUB_ALLOW_SINGLE_STEP</span>
<span class="cm">/*</span>
<span class="cm"> * We single-step by setting breakpoints. When an exception</span>
<span class="cm"> * is handled, we need to restore the instructions hoisted</span>
<span class="cm"> * when the breakpoints were set.</span>
<span class="cm"> *</span>
<span class="cm"> * This is where we save the original instructions.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">gdb_bp_save</span> <span class="p">{</span>
	<span class="n">u8</span>	<span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">opcode</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">}</span> <span class="n">step_bp</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">gdbstub_insn_sizes</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="cm">/* 1  2  3  4  5  6  7  8  9  a  b  c  d  e  f */</span>
	<span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>	<span class="cm">/* 0 */</span>
	<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="cm">/* 1 */</span>
	<span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="cm">/* 2 */</span>
	<span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="cm">/* 3 */</span>
	<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="cm">/* 4 */</span>
	<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="cm">/* 5 */</span>
	<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="cm">/* 6 */</span>
	<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="cm">/* 7 */</span>
	<span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="cm">/* 8 */</span>
	<span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="cm">/* 9 */</span>
	<span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="cm">/* a */</span>
	<span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="cm">/* b */</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="cm">/* c */</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="cm">/* d */</span>
	<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="cm">/* e */</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span>  <span class="cm">/* f */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__gdbstub_mark_bp</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* vmalloc area */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">VMALLOC_START</span> <span class="o">&lt;=</span> <span class="n">addr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">VMALLOC_END</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">okay</span><span class="p">;</span>
	<span class="cm">/* SRAM, SDRAM */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="mh">0x80000000UL</span> <span class="o">&lt;=</span> <span class="n">addr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="mh">0xa0000000UL</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">okay</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">okay:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_read_byte</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">step_bp</span><span class="p">[</span><span class="n">ix</span><span class="p">].</span><span class="n">opcode</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">gdbstub_read_byte</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">step_bp</span><span class="p">[</span><span class="n">ix</span><span class="p">].</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">step_bp</span><span class="p">[</span><span class="n">ix</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__gdbstub_restore_bp</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef GDBSTUB_USE_F7F7_AS_BREAKPOINT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">step_bp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gdbstub_write_byte</span><span class="p">(</span><span class="n">step_bp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">opcode</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">step_bp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">gdbstub_write_byte</span><span class="p">(</span><span class="n">step_bp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">step_bp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">step_bp</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gdbstub_write_byte</span><span class="p">(</span><span class="n">step_bp</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">opcode</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">step_bp</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">gdbstub_write_byte</span><span class="p">(</span><span class="n">step_bp</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">step_bp</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">step_bp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span><span class="p">)</span>
		<span class="n">gdbstub_write_byte</span><span class="p">(</span><span class="n">step_bp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">opcode</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">step_bp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">step_bp</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span><span class="p">)</span>
		<span class="n">gdbstub_write_byte</span><span class="p">(</span><span class="n">step_bp</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">opcode</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">step_bp</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">gdbstub_flush_caches</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">step_bp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">step_bp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">opcode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">step_bp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">step_bp</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">step_bp</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">opcode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">step_bp</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * emulate single stepping by means of breakpoint instructions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gdbstub_single_step</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">x</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">cur</span><span class="p">,</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>

	<span class="n">step_bp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">step_bp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">opcode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">step_bp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">step_bp</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">step_bp</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">opcode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">step_bp</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pc</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">;</span>
	<span class="n">sp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_read_byte</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cur</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">gdbstub_bkpt</span><span class="p">(</span><span class="s">&quot;Single Step from %p { %02x }</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">cur</span><span class="p">);</span>

	<span class="n">gdbstub_flush_caches</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">gdbstub_insn_sizes</span><span class="p">[</span><span class="n">cur</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__gdbstub_mark_bp</span><span class="p">(</span><span class="n">pc</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cur</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Bxx (d8,PC) */</span>
		<span class="k">case</span> <span class="mh">0xc0</span> <span class="p">...</span> <span class="mh">0xca</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_read_byte</span><span class="p">(</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__gdbstub_mark_bp</span><span class="p">(</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">__gdbstub_mark_bp</span><span class="p">(</span><span class="n">pc</span> <span class="o">+</span> <span class="p">(</span><span class="n">s8</span><span class="p">)</span> <span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* LXX (d8,PC) */</span>
		<span class="k">case</span> <span class="mh">0xd0</span> <span class="p">...</span> <span class="mh">0xda</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__gdbstub_mark_bp</span><span class="p">(</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">!=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">lar</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">__gdbstub_mark_bp</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">lar</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* SETLB - loads the next for bytes into the LIR</span>
<span class="cm">			 * register */</span>
		<span class="k">case</span> <span class="mh">0xdb</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__gdbstub_mark_bp</span><span class="p">(</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* JMP (d16,PC) or CALL (d16,PC) */</span>
		<span class="k">case</span> <span class="mh">0xcc</span>:
		<span class="k">case</span> <span class="mh">0xcd</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_read_byte</span><span class="p">(</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
			    <span class="n">gdbstub_read_byte</span><span class="p">(</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__gdbstub_mark_bp</span><span class="p">(</span><span class="n">pc</span> <span class="o">+</span> <span class="p">(</span><span class="n">s16</span><span class="p">)</span> <span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* JMP (d32,PC) or CALL (d32,PC) */</span>
		<span class="k">case</span> <span class="mh">0xdc</span>:
		<span class="k">case</span> <span class="mh">0xdd</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_read_byte</span><span class="p">(</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
			    <span class="n">gdbstub_read_byte</span><span class="p">(</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
			    <span class="n">gdbstub_read_byte</span><span class="p">(</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
			    <span class="n">gdbstub_read_byte</span><span class="p">(</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__gdbstub_mark_bp</span><span class="p">(</span><span class="n">pc</span> <span class="o">+</span> <span class="p">(</span><span class="n">s32</span><span class="p">)</span> <span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* RETF */</span>
		<span class="k">case</span> <span class="mh">0xde</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__gdbstub_mark_bp</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">mdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* RET */</span>
		<span class="k">case</span> <span class="mh">0xdf</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_read_byte</span><span class="p">(</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
			<span class="n">sp</span> <span class="o">+=</span> <span class="p">(</span><span class="n">s8</span><span class="p">)</span><span class="n">x</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_read_byte</span><span class="p">(</span><span class="n">sp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
			    <span class="n">gdbstub_read_byte</span><span class="p">(</span><span class="n">sp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
			    <span class="n">gdbstub_read_byte</span><span class="p">(</span><span class="n">sp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
			    <span class="n">gdbstub_read_byte</span><span class="p">(</span><span class="n">sp</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__gdbstub_mark_bp</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0xf0</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_read_byte</span><span class="p">(</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cur</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">&gt;=</span> <span class="mh">0xf0</span> <span class="o">&amp;&amp;</span> <span class="n">cur</span> <span class="o">&lt;=</span> <span class="mh">0xf7</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* JMP (An) / CALLS (An) */</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">cur</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mi">0</span>: <span class="n">x</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">a0</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">1</span>: <span class="n">x</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">a1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">2</span>: <span class="n">x</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">a2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">3</span>: <span class="n">x</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">a3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__gdbstub_mark_bp</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">==</span> <span class="mh">0xfc</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* RETS */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_read_byte</span><span class="p">(</span>
					    <span class="n">sp</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
				    <span class="n">gdbstub_read_byte</span><span class="p">(</span>
					    <span class="n">sp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
				    <span class="n">gdbstub_read_byte</span><span class="p">(</span>
					    <span class="n">sp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
				    <span class="n">gdbstub_read_byte</span><span class="p">(</span>
					    <span class="n">sp</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__gdbstub_mark_bp</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">==</span> <span class="mh">0xfd</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* RTI */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_read_byte</span><span class="p">(</span>
					    <span class="n">sp</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
				    <span class="n">gdbstub_read_byte</span><span class="p">(</span>
					    <span class="n">sp</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
				    <span class="n">gdbstub_read_byte</span><span class="p">(</span>
					    <span class="n">sp</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
				    <span class="n">gdbstub_read_byte</span><span class="p">(</span>
					    <span class="n">sp</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__gdbstub_mark_bp</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__gdbstub_mark_bp</span><span class="p">(</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* potential 3-byte conditional branches */</span>
		<span class="k">case</span> <span class="mh">0xf8</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_read_byte</span><span class="p">(</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cur</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__gdbstub_mark_bp</span><span class="p">(</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">&gt;=</span> <span class="mh">0xe8</span> <span class="o">&amp;&amp;</span> <span class="n">cur</span> <span class="o">&lt;=</span> <span class="mh">0xeb</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_read_byte</span><span class="p">(</span>
					    <span class="n">pc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="o">!</span><span class="n">__gdbstub_mark_bp</span><span class="p">(</span><span class="n">pc</span> <span class="o">+</span> <span class="p">(</span><span class="n">s8</span><span class="p">)</span> <span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0xfa</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_read_byte</span><span class="p">(</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cur</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* CALLS (d16,PC) */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_read_byte</span><span class="p">(</span>
					    <span class="n">pc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
				    <span class="n">gdbstub_read_byte</span><span class="p">(</span>
					    <span class="n">pc</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__gdbstub_mark_bp</span><span class="p">(</span><span class="n">pc</span> <span class="o">+</span> <span class="p">(</span><span class="n">s16</span><span class="p">)</span> <span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__gdbstub_mark_bp</span><span class="p">(</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0xfc</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_read_byte</span><span class="p">(</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cur</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* CALLS (d32,PC) */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_read_byte</span><span class="p">(</span>
					    <span class="n">pc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
				    <span class="n">gdbstub_read_byte</span><span class="p">(</span>
					    <span class="n">pc</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
				    <span class="n">gdbstub_read_byte</span><span class="p">(</span>
					    <span class="n">pc</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
				    <span class="n">gdbstub_read_byte</span><span class="p">(</span>
					    <span class="n">pc</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__gdbstub_mark_bp</span><span class="p">(</span>
					    <span class="n">pc</span> <span class="o">+</span> <span class="p">(</span><span class="n">s32</span><span class="p">)</span> <span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__gdbstub_mark_bp</span><span class="p">(</span>
					    <span class="n">pc</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">gdbstub_bkpt</span><span class="p">(</span><span class="s">&quot;Step: %02x at %p; %02x at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">step_bp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">opcode</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">step_bp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span>
		     <span class="n">step_bp</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">opcode</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">step_bp</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">step_bp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef GDBSTUB_USE_F7F7_AS_BREAKPOINT</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_write_byte</span><span class="p">(</span><span class="mh">0xF7</span><span class="p">,</span> <span class="n">step_bp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">gdbstub_write_byte</span><span class="p">(</span><span class="mh">0xF7</span><span class="p">,</span> <span class="n">step_bp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_write_byte</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span> <span class="n">step_bp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">step_bp</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef GDBSTUB_USE_F7F7_AS_BREAKPOINT</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_write_byte</span><span class="p">(</span><span class="mh">0xF7</span><span class="p">,</span> <span class="n">step_bp</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">gdbstub_write_byte</span><span class="p">(</span><span class="mh">0xF7</span><span class="p">,</span> <span class="n">step_bp</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_write_byte</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span> <span class="n">step_bp</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">fault:</span>
	<span class="cm">/* uh-oh - silly address alert, try and restore things */</span>
	<span class="n">__gdbstub_restore_bp</span><span class="p">();</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_GDBSTUB_ALLOW_SINGLE_STEP */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_GDBSTUB_CONSOLE</span>

<span class="kt">void</span> <span class="nf">gdbstub_console_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">con</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">gdbstub_cr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x0d</span> <span class="p">};</span>
	<span class="kt">char</span> <span class="n">outbuf</span><span class="p">[</span><span class="mi">26</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">qty</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">busy</span><span class="p">;</span>

	<span class="n">busy</span> <span class="o">=</span> <span class="n">gdbstub_busy</span><span class="p">;</span>
	<span class="n">gdbstub_busy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">outbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;O&#39;</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">qty</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mem2hex</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">outbuf</span> <span class="o">+</span> <span class="n">qty</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">qty</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="mh">0x0a</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mem2hex</span><span class="p">(</span><span class="n">gdbstub_cr</span><span class="p">,</span> <span class="n">outbuf</span> <span class="o">+</span> <span class="n">qty</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">qty</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="n">n</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">outbuf</span><span class="p">[</span><span class="n">qty</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">putpacket</span><span class="p">(</span><span class="n">outbuf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">gdbstub_busy</span> <span class="o">=</span> <span class="n">busy</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">kdev_t</span> <span class="nf">gdbstub_console_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">con</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">MKDEV</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span> <span class="cm">/* /dev/null */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">console</span> <span class="n">gdbstub_console</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;gdb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>	<span class="o">=</span> <span class="n">gdbstub_console_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">device</span>	<span class="o">=</span> <span class="n">gdbstub_console_dev</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">CON_PRINTBUFFER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Convert the memory pointed to by mem into hex, placing result in buf.</span>
<span class="cm"> * - if successful, return a pointer to the last char put in buf (NUL)</span>
<span class="cm"> * - in case of mem fault, return NULL</span>
<span class="cm"> * may_fault is non-zero if we are reading from arbitrary memory, but is</span>
<span class="cm"> * currently not used.</span>
<span class="cm"> */</span>
<span class="k">static</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">mem2hex</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_mem</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">may_fault</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mem</span> <span class="o">=</span> <span class="n">_mem</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ch</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">mem</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_read_byte</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">mem</span><span class="o">++</span><span class="p">;</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">mem</span> <span class="o">&amp;</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_read_word</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">mem</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_read_dword</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ch</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ch</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">mem</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_read_word</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">mem</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_read_byte</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * convert the hex array pointed to by buf into binary to be placed in mem</span>
<span class="cm"> * return a pointer to the character AFTER the last byte written</span>
<span class="cm"> * may_fault is non-zero if we are reading from arbitrary memory, but is</span>
<span class="cm"> * currently not used.</span>
<span class="cm"> */</span>
<span class="k">static</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">hex2mem</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_mem</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">may_fault</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">mem</span> <span class="o">=</span> <span class="n">_mem</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">ch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">mem</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_write_byte</span><span class="p">(</span><span class="n">ch</span><span class="p">.</span><span class="n">val</span><span class="p">,</span> <span class="n">mem</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mem</span><span class="o">++</span><span class="p">;</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">mem</span> <span class="o">&amp;</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">);</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="o">=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_write_word</span><span class="p">(</span><span class="n">ch</span><span class="p">.</span><span class="n">val</span><span class="p">,</span> <span class="n">mem</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mem</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">);</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="o">=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">);</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="o">=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">);</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="o">=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_write_dword</span><span class="p">(</span><span class="n">ch</span><span class="p">.</span><span class="n">val</span><span class="p">,</span> <span class="n">mem</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mem</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">);</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="o">=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_write_word</span><span class="p">(</span><span class="n">ch</span><span class="p">.</span><span class="n">val</span><span class="p">,</span> <span class="n">mem</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mem</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_write_byte</span><span class="p">(</span><span class="n">ch</span><span class="p">.</span><span class="n">val</span><span class="p">,</span> <span class="n">mem</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This table contains the mapping between MN10300 exception codes, and</span>
<span class="cm"> * signals, which are primarily what GDB understands.  It also indicates</span>
<span class="cm"> * which hardware traps we need to commandeer when initializing the stub.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">excep_to_sig_map</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="n">exception_code</span>	<span class="n">excep</span><span class="p">;</span>	<span class="cm">/* MN10300 exception code */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">signo</span><span class="p">;</span>	<span class="cm">/* Signal that we map this into */</span>
<span class="p">}</span> <span class="n">excep_to_sig_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">EXCEP_ITLBMISS</span><span class="p">,</span>	<span class="n">SIGSEGV</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">EXCEP_DTLBMISS</span><span class="p">,</span>	<span class="n">SIGSEGV</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">EXCEP_TRAP</span><span class="p">,</span>		<span class="n">SIGTRAP</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">EXCEP_ISTEP</span><span class="p">,</span>		<span class="n">SIGTRAP</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">EXCEP_IBREAK</span><span class="p">,</span>		<span class="n">SIGTRAP</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">EXCEP_OBREAK</span><span class="p">,</span>		<span class="n">SIGTRAP</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">EXCEP_UNIMPINS</span><span class="p">,</span>	<span class="n">SIGILL</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">EXCEP_UNIMPEXINS</span><span class="p">,</span>	<span class="n">SIGILL</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">EXCEP_MEMERR</span><span class="p">,</span>		<span class="n">SIGSEGV</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">EXCEP_MISALIGN</span><span class="p">,</span>	<span class="n">SIGSEGV</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">EXCEP_BUSERROR</span><span class="p">,</span>	<span class="n">SIGBUS</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">EXCEP_ILLINSACC</span><span class="p">,</span>	<span class="n">SIGSEGV</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">EXCEP_ILLDATACC</span><span class="p">,</span>	<span class="n">SIGSEGV</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">EXCEP_IOINSACC</span><span class="p">,</span>	<span class="n">SIGSEGV</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">EXCEP_PRIVINSACC</span><span class="p">,</span>	<span class="n">SIGSEGV</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">EXCEP_PRIVDATACC</span><span class="p">,</span>	<span class="n">SIGSEGV</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">EXCEP_FPU_DISABLED</span><span class="p">,</span>	<span class="n">SIGFPE</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">EXCEP_FPU_UNIMPINS</span><span class="p">,</span>	<span class="n">SIGFPE</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">EXCEP_FPU_OPERATION</span><span class="p">,</span>	<span class="n">SIGFPE</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">EXCEP_WDT</span><span class="p">,</span>		<span class="n">SIGALRM</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">EXCEP_NMI</span><span class="p">,</span>		<span class="n">SIGQUIT</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">EXCEP_IRQ_LEVEL0</span><span class="p">,</span>	<span class="n">SIGINT</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">EXCEP_IRQ_LEVEL1</span><span class="p">,</span>	<span class="n">SIGINT</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">EXCEP_IRQ_LEVEL2</span><span class="p">,</span>	<span class="n">SIGINT</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">EXCEP_IRQ_LEVEL3</span><span class="p">,</span>	<span class="n">SIGINT</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">EXCEP_IRQ_LEVEL4</span><span class="p">,</span>	<span class="n">SIGINT</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">EXCEP_IRQ_LEVEL5</span><span class="p">,</span>	<span class="n">SIGINT</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">EXCEP_IRQ_LEVEL6</span><span class="p">,</span>	<span class="n">SIGINT</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * convert the MN10300 exception code into a UNIX signal number</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">computeSignal</span><span class="p">(</span><span class="k">enum</span> <span class="n">exception_code</span> <span class="n">excep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">excep_to_sig_map</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">map</span> <span class="o">=</span> <span class="n">excep_to_sig_map</span><span class="p">;</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">signo</span><span class="p">;</span> <span class="n">map</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">excep</span> <span class="o">==</span> <span class="n">excep</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">signo</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">SIGHUP</span><span class="p">;</span> <span class="cm">/* default for things we don&#39;t know about */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">gdbstub_fpcr</span><span class="p">,</span> <span class="n">gdbstub_fpufs_array</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gdbstub_store_fpu</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_FPU</span>

	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span>
		<span class="s">&quot;or %2,epsw</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="cp">#ifdef CONFIG_MN10300_PROC_MN103E010</span>
		<span class="s">&quot;nop</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;nop</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="cp">#endif</span>
		<span class="s">&quot;mov %1, a1</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov fs0,  (a1+)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov fs1,  (a1+)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov fs2,  (a1+)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov fs3,  (a1+)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov fs4,  (a1+)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov fs5,  (a1+)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov fs6,  (a1+)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov fs7,  (a1+)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov fs8,  (a1+)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov fs9,  (a1+)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov fs10, (a1+)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov fs11, (a1+)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov fs12, (a1+)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov fs13, (a1+)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov fs14, (a1+)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov fs15, (a1+)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov fs16, (a1+)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov fs17, (a1+)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov fs18, (a1+)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov fs19, (a1+)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov fs20, (a1+)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov fs21, (a1+)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov fs22, (a1+)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov fs23, (a1+)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov fs24, (a1+)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov fs25, (a1+)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov fs26, (a1+)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov fs27, (a1+)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov fs28, (a1+)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov fs29, (a1+)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov fs30, (a1+)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov fs31, (a1+)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov fpcr, %0</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="o">:</span> <span class="s">&quot;=d&quot;</span><span class="p">(</span><span class="n">gdbstub_fpcr</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;g&quot;</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">gdbstub_fpufs_array</span><span class="p">),</span> <span class="s">&quot;i&quot;</span><span class="p">(</span><span class="n">EPSW_FE</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;a1&quot;</span>
		<span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gdbstub_load_fpu</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_FPU</span>

	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span>
		<span class="s">&quot;or %1,epsw</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="cp">#ifdef CONFIG_MN10300_PROC_MN103E010</span>
		<span class="s">&quot;nop</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;nop</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="cp">#endif</span>
		<span class="s">&quot;mov %0, a1</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov (a1+), fs0</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov (a1+), fs1</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov (a1+), fs2</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov (a1+), fs3</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov (a1+), fs4</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov (a1+), fs5</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov (a1+), fs6</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov (a1+), fs7</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov (a1+), fs8</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov (a1+), fs9</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov (a1+), fs10</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov (a1+), fs11</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov (a1+), fs12</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov (a1+), fs13</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov (a1+), fs14</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov (a1+), fs15</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov (a1+), fs16</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov (a1+), fs17</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov (a1+), fs18</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov (a1+), fs19</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov (a1+), fs20</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov (a1+), fs21</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov (a1+), fs22</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov (a1+), fs23</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov (a1+), fs24</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov (a1+), fs25</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov (a1+), fs26</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov (a1+), fs27</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov (a1+), fs28</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov (a1+), fs29</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov (a1+), fs30</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov (a1+), fs31</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fmov %2, fpcr</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="o">:</span>
		<span class="o">:</span> <span class="s">&quot;g&quot;</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">gdbstub_fpufs_array</span><span class="p">),</span> <span class="s">&quot;i&quot;</span><span class="p">(</span><span class="n">EPSW_FE</span><span class="p">),</span> <span class="s">&quot;d&quot;</span><span class="p">(</span><span class="n">gdbstub_fpcr</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;a1&quot;</span>
	<span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set a software breakpoint</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">gdbstub_set_breakpoint</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bkpt</span><span class="p">,</span> <span class="n">loop</span><span class="p">,</span> <span class="n">xloop</span><span class="p">;</span>

<span class="cp">#ifdef GDBSTUB_USE_F7F7_AS_BREAKPOINT</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">gdbstub_bkpt</span><span class="p">(</span><span class="s">&quot;setbkpt(%p,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bkpt</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span> <span class="n">bkpt</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bkpt</span><span class="o">--</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdbstub_bkpts</span><span class="p">[</span><span class="n">bkpt</span><span class="p">].</span><span class="n">addr</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bkpt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_read_byte</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">[</span><span class="n">loop</span><span class="p">],</span>
				      <span class="o">&amp;</span><span class="n">gdbstub_bkpts</span><span class="p">[</span><span class="n">bkpt</span><span class="p">].</span><span class="n">origbytes</span><span class="p">[</span><span class="n">loop</span><span class="p">]</span>
				      <span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">gdbstub_flush_caches</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cp">#ifdef GDBSTUB_USE_F7F7_AS_BREAKPOINT</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_write_byte</span><span class="p">(</span><span class="mh">0xF7</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">[</span><span class="n">loop</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">restore</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_write_byte</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">[</span><span class="n">loop</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">restore</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">gdbstub_bkpts</span><span class="p">[</span><span class="n">bkpt</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">gdbstub_bkpts</span><span class="p">[</span><span class="n">bkpt</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">gdbstub_bkpt</span><span class="p">(</span><span class="s">&quot;Set BKPT[%02x]: %p-%p {%02x%02x%02x%02x%02x%02x%02x}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">bkpt</span><span class="p">,</span>
		     <span class="n">gdbstub_bkpts</span><span class="p">[</span><span class="n">bkpt</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span>
		     <span class="n">gdbstub_bkpts</span><span class="p">[</span><span class="n">bkpt</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span> <span class="n">gdbstub_bkpts</span><span class="p">[</span><span class="n">bkpt</span><span class="p">].</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		     <span class="n">gdbstub_bkpts</span><span class="p">[</span><span class="n">bkpt</span><span class="p">].</span><span class="n">origbytes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		     <span class="n">gdbstub_bkpts</span><span class="p">[</span><span class="n">bkpt</span><span class="p">].</span><span class="n">origbytes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		     <span class="n">gdbstub_bkpts</span><span class="p">[</span><span class="n">bkpt</span><span class="p">].</span><span class="n">origbytes</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
		     <span class="n">gdbstub_bkpts</span><span class="p">[</span><span class="n">bkpt</span><span class="p">].</span><span class="n">origbytes</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
		     <span class="n">gdbstub_bkpts</span><span class="p">[</span><span class="n">bkpt</span><span class="p">].</span><span class="n">origbytes</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
		     <span class="n">gdbstub_bkpts</span><span class="p">[</span><span class="n">bkpt</span><span class="p">].</span><span class="n">origbytes</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
		     <span class="n">gdbstub_bkpts</span><span class="p">[</span><span class="n">bkpt</span><span class="p">].</span><span class="n">origbytes</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
		     <span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">restore:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">xloop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">xloop</span> <span class="o">&lt;</span> <span class="n">loop</span><span class="p">;</span> <span class="n">xloop</span><span class="o">++</span><span class="p">)</span>
		<span class="n">gdbstub_write_byte</span><span class="p">(</span><span class="n">gdbstub_bkpts</span><span class="p">[</span><span class="n">bkpt</span><span class="p">].</span><span class="n">origbytes</span><span class="p">[</span><span class="n">xloop</span><span class="p">],</span>
				   <span class="n">addr</span> <span class="o">+</span> <span class="n">xloop</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * clear a software breakpoint</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">gdbstub_clear_breakpoint</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bkpt</span><span class="p">,</span> <span class="n">loop</span><span class="p">;</span>

<span class="cp">#ifdef GDBSTUB_USE_F7F7_AS_BREAKPOINT</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">gdbstub_bkpt</span><span class="p">(</span><span class="s">&quot;clearbkpt(%p,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bkpt</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span> <span class="n">bkpt</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bkpt</span><span class="o">--</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_bkpts</span><span class="p">[</span><span class="n">bkpt</span><span class="p">].</span><span class="n">addr</span> <span class="o">==</span> <span class="n">addr</span> <span class="o">&amp;&amp;</span>
		    <span class="n">gdbstub_bkpts</span><span class="p">[</span><span class="n">bkpt</span><span class="p">].</span><span class="n">len</span> <span class="o">==</span> <span class="n">len</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bkpt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">gdbstub_bkpts</span><span class="p">[</span><span class="n">bkpt</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">gdbstub_flush_caches</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_write_byte</span><span class="p">(</span><span class="n">gdbstub_bkpts</span><span class="p">[</span><span class="n">bkpt</span><span class="p">].</span><span class="n">origbytes</span><span class="p">[</span><span class="n">loop</span><span class="p">],</span>
				       <span class="n">addr</span> <span class="o">+</span> <span class="n">loop</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function does all command processing for interfacing to gdb</span>
<span class="cm"> * - returns 0 if the exception should be skipped, -ERROR otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gdbstub</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="k">enum</span> <span class="n">exception_code</span> <span class="n">excep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">stack</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">epsw</span><span class="p">,</span> <span class="n">mdr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">zero</span><span class="p">,</span> <span class="n">ssp</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">broke</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sigval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loop</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">excep</span> <span class="o">==</span> <span class="n">EXCEP_FPU_DISABLED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>

	<span class="n">gdbstub_flush_caches</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mn10300_set_gdbleds</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;mov mdr,%0&quot;</span> <span class="o">:</span> <span class="s">&quot;=d&quot;</span><span class="p">(</span><span class="n">mdr</span><span class="p">));</span>
	<span class="n">local_save_flags</span><span class="p">(</span><span class="n">epsw</span><span class="p">);</span>
	<span class="n">arch_local_change_intr_mask_level</span><span class="p">(</span>
		<span class="n">NUM2EPSW_IM</span><span class="p">(</span><span class="n">CONFIG_DEBUGGER_IRQ_LEVEL</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">gdbstub_store_fpu</span><span class="p">();</span>

<span class="cp">#ifdef CONFIG_GDBSTUB_IMMEDIATE</span>
	<span class="cm">/* skip the initial pause loop */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">__gdbstub_pause</span><span class="p">)</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">start_kernel</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* if we were single stepping, restore the opcodes hoisted for the</span>
<span class="cm">	 * breakpoint[s] */</span>
	<span class="n">broke</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_GDBSTUB_ALLOW_SINGLE_STEP</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">step_bp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">&amp;&amp;</span> <span class="n">step_bp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">==</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">step_bp</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span> <span class="o">&amp;&amp;</span> <span class="n">step_bp</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span> <span class="o">==</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">))</span>
		<span class="n">broke</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">__gdbstub_restore_bp</span><span class="p">();</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_rx_unget</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sigval</span> <span class="o">=</span> <span class="n">SIGINT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_rx_unget</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">packet_waiting</span><span class="p">;</span>
		<span class="n">gdbstub_rx_unget</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">stack</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">sp</span><span class="p">;</span>
	<span class="n">sigval</span> <span class="o">=</span> <span class="n">broke</span> <span class="o">?</span> <span class="n">SIGTRAP</span> <span class="o">:</span> <span class="n">computeSignal</span><span class="p">(</span><span class="n">excep</span><span class="p">);</span>

	<span class="cm">/* send information about a BUG() */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">excep</span> <span class="o">==</span> <span class="n">EXCEP_SYSCALL15</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">bug_entry</span> <span class="o">*</span><span class="n">bug</span><span class="p">;</span>

		<span class="n">bug</span> <span class="o">=</span> <span class="n">find_bug</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bug</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">found_bug</span><span class="p">;</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">trans_buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">trans_buffer</span><span class="p">),</span>
				  <span class="s">&quot;BUG() at address %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">send_bug_pkt</span><span class="p">;</span>

	<span class="nl">found_bug:</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">trans_buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">trans_buffer</span><span class="p">),</span>
				  <span class="s">&quot;BUG() at address %lx (%s:%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">,</span> <span class="n">bug</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">,</span> <span class="n">bug</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>

	<span class="nl">send_bug_pkt:</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">output_buffer</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;O&#39;</span><span class="p">;</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="n">trans_buffer</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">putpacket</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">);</span>

		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">sigval</span> <span class="o">=</span> <span class="n">SIGABRT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">__gdbstub_bug_trap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">mdr</span><span class="p">;</span>
		<span class="n">sigval</span> <span class="o">=</span> <span class="n">SIGABRT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * send a message to the debugger&#39;s user saying what happened if it may</span>
<span class="cm">	 * not be clear cut (we can&#39;t map exceptions onto signals properly)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sigval</span> <span class="o">!=</span> <span class="n">SIGINT</span> <span class="o">&amp;&amp;</span> <span class="n">sigval</span> <span class="o">!=</span> <span class="n">SIGTRAP</span> <span class="o">&amp;&amp;</span> <span class="n">sigval</span> <span class="o">!=</span> <span class="n">SIGILL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">title</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;Excep &quot;</span><span class="p">,</span> <span class="n">tbcberr</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;BCBERR &quot;</span><span class="p">;</span>
		<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">crlf</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">hx</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">bcberr</span> <span class="o">=</span> <span class="n">BCBERR</span><span class="p">;</span>

		<span class="n">ptr</span> <span class="o">=</span> <span class="n">output_buffer</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;O&#39;</span><span class="p">;</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">hx</span> <span class="o">=</span> <span class="n">hex_asc_hi</span><span class="p">(</span><span class="n">excep</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">hx</span><span class="p">);</span>
		<span class="n">hx</span> <span class="o">=</span> <span class="n">hex_asc_lo</span><span class="p">(</span><span class="n">excep</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">hx</span><span class="p">);</span>
		<span class="n">hx</span> <span class="o">=</span> <span class="n">hex_asc_hi</span><span class="p">(</span><span class="n">excep</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">hx</span><span class="p">);</span>
		<span class="n">hx</span> <span class="o">=</span> <span class="n">hex_asc_lo</span><span class="p">(</span><span class="n">excep</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">hx</span><span class="p">);</span>

		<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="n">crlf</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">crlf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">putpacket</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">);</span>	<span class="cm">/* send it off... */</span>

		<span class="cm">/* BCBERR */</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">output_buffer</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;O&#39;</span><span class="p">;</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="n">tbcberr</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tbcberr</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">hx</span> <span class="o">=</span> <span class="n">hex_asc_hi</span><span class="p">(</span><span class="n">bcberr</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">hx</span><span class="p">);</span>
		<span class="n">hx</span> <span class="o">=</span> <span class="n">hex_asc_lo</span><span class="p">(</span><span class="n">bcberr</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">hx</span><span class="p">);</span>
		<span class="n">hx</span> <span class="o">=</span> <span class="n">hex_asc_hi</span><span class="p">(</span><span class="n">bcberr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">hx</span><span class="p">);</span>
		<span class="n">hx</span> <span class="o">=</span> <span class="n">hex_asc_lo</span><span class="p">(</span><span class="n">bcberr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">hx</span><span class="p">);</span>
		<span class="n">hx</span> <span class="o">=</span> <span class="n">hex_asc_hi</span><span class="p">(</span><span class="n">bcberr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">hx</span><span class="p">);</span>
		<span class="n">hx</span> <span class="o">=</span> <span class="n">hex_asc_lo</span><span class="p">(</span><span class="n">bcberr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">hx</span><span class="p">);</span>
		<span class="n">hx</span> <span class="o">=</span> <span class="n">hex_asc_hi</span><span class="p">(</span><span class="n">bcberr</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">hx</span><span class="p">);</span>
		<span class="n">hx</span> <span class="o">=</span> <span class="n">hex_asc_lo</span><span class="p">(</span><span class="n">bcberr</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">hx</span><span class="p">);</span>

		<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="n">crlf</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">crlf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">putpacket</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">);</span>	<span class="cm">/* send it off... */</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * tell the debugger that an exception has occurred</span>
<span class="cm">	 */</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">output_buffer</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Send trap type (converted to signal)</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;T&#39;</span><span class="p">;</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">sigval</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Send Error PC</span>
<span class="cm">	 */</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">GDB_REGID_PC</span><span class="p">);</span>
	<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;:&#39;</span><span class="p">;</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;;&#39;</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Send frame pointer</span>
<span class="cm">	 */</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">GDB_REGID_FP</span><span class="p">);</span>
	<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;:&#39;</span><span class="p">;</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">a3</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;;&#39;</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Send stack pointer</span>
<span class="cm">	 */</span>
	<span class="n">ssp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">GDB_REGID_SP</span><span class="p">);</span>
	<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;:&#39;</span><span class="p">;</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ssp</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;;&#39;</span><span class="p">;</span>

	<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">putpacket</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">);</span>	<span class="cm">/* send it off... */</span>

<span class="nl">packet_waiting:</span>
	<span class="cm">/*</span>
<span class="cm">	 * Wait for input from remote GDB</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">output_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">getpacket</span><span class="p">(</span><span class="n">input_buffer</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">input_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="cm">/* request repeat of last signal number */</span>
		<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
			<span class="n">output_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;S&#39;</span><span class="p">;</span>
			<span class="n">output_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">hex_asc_hi</span><span class="p">(</span><span class="n">sigval</span><span class="p">);</span>
			<span class="n">output_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">hex_asc_lo</span><span class="p">(</span><span class="n">sigval</span><span class="p">);</span>
			<span class="n">output_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">&#39;d&#39;</span>:
			<span class="cm">/* toggle debug flag */</span>
			<span class="k">break</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * Return the value of the CPU registers</span>
<span class="cm">			 */</span>
		<span class="k">case</span> <span class="sc">&#39;g&#39;</span>:
			<span class="n">zero</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ssp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">output_buffer</span><span class="p">;</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">d0</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">d1</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">d2</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">d3</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">a0</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">a1</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">a2</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">a3</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ssp</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* 8 */</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">mdr</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">epsw</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">lir</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">lar</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">mdrq</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">e0</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* 15 */</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">e1</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">e2</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">e3</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">e4</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">e5</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">e6</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">e7</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ssp</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sp</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">mcrh</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* 26 */</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">mcrl</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">mcvf</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdbstub_fpcr</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* 29 - FPCR */</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zero</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zero</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span>
				<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdbstub_fpufs_array</span><span class="p">[</span><span class="n">loop</span><span class="p">],</span>
					      <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* 32 - FS0-31 */</span>

			<span class="k">break</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * set the value of the CPU registers - return OK</span>
<span class="cm">			 */</span>
		<span class="k">case</span> <span class="sc">&#39;G&#39;</span>:
		<span class="p">{</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

			<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">input_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">d0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">d1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">d2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">d3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">a0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">a1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">a2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">a3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ssp</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* 8 */</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">mdr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">epsw</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">lir</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">lar</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">mdrq</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">e0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* 15 */</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">e1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">e2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">e3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">e4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">e5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">e6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">e7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ssp</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zero</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sp</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">mcrh</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* 26 */</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">mcrl</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">mcvf</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zero</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* 29 - FPCR */</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zero</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zero</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span>     <span class="cm">/* 32 - FS0-31 */</span>
				<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zero</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">			/*</span>
<span class="c">			 * See if the stack pointer has moved. If so, then copy</span>
<span class="c">			 * the saved locals and ins to the new location.</span>
<span class="c">			 */</span>
<span class="c">			unsigned long *newsp = (unsigned long *) registers[SP];</span>
<span class="c">			if (sp != newsp)</span>
<span class="c">				sp = memcpy(newsp, sp, 16 * 4);</span>
<span class="cp">#endif</span>

			<span class="n">gdbstub_strcpy</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * mAA..AA,LLLL  Read LLLL bytes at address AA..AA</span>
<span class="cm">		 */</span>
		<span class="k">case</span> <span class="sc">&#39;m&#39;</span>:
			<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">input_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">hexToInt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span> <span class="o">&amp;&amp;</span>
			    <span class="n">hexToInt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">)</span>
			    <span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mem2hex</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">,</span> <span class="n">output_buffer</span><span class="p">,</span>
					    <span class="n">length</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">gdbstub_strcpy</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span> <span class="s">&quot;E03&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">gdbstub_strcpy</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span> <span class="s">&quot;E01&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * MAA..AA,LLLL: Write LLLL bytes at address AA.AA</span>
<span class="cm">			 * return OK</span>
<span class="cm">			 */</span>
		<span class="k">case</span> <span class="sc">&#39;M&#39;</span>:
			<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">input_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">hexToInt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span> <span class="o">&amp;&amp;</span>
			    <span class="n">hexToInt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">==</span> <span class="sc">&#39;:&#39;</span>
			    <span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
					<span class="n">gdbstub_strcpy</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">gdbstub_strcpy</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span> <span class="s">&quot;E03&quot;</span><span class="p">);</span>

				<span class="n">gdbstub_flush_caches</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">gdbstub_strcpy</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span> <span class="s">&quot;E02&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * cAA..AA    Continue at address AA..AA(optional)</span>
<span class="cm">			 */</span>
		<span class="k">case</span> <span class="sc">&#39;c&#39;</span>:
			<span class="cm">/* try to read optional parameter, pc unchanged if no</span>
<span class="cm">			 * parm */</span>

			<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">input_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hexToInt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">))</span>
				<span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * kill the program</span>
<span class="cm">			 */</span>
		<span class="k">case</span> <span class="sc">&#39;k&#39;</span> :
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>	<span class="cm">/* just continue */</span>

			<span class="cm">/*</span>
<span class="cm">			 * Reset the whole machine (FIXME: system dependent)</span>
<span class="cm">			 */</span>
		<span class="k">case</span> <span class="sc">&#39;r&#39;</span>:
			<span class="k">break</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * Step to next instruction</span>
<span class="cm">			 */</span>
		<span class="k">case</span> <span class="sc">&#39;s&#39;</span>:
			<span class="cm">/* Using the T flag doesn&#39;t seem to perform single</span>
<span class="cm">			 * stepping (it seems to wind up being caught by the</span>
<span class="cm">			 * JTAG unit), so we have to use breakpoints and</span>
<span class="cm">			 * continue instead.</span>
<span class="cm">			 */</span>
<span class="cp">#ifdef CONFIG_GDBSTUB_ALLOW_SINGLE_STEP</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_single_step</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="cm">/* ignore any fault error for now */</span>
				<span class="n">gdbstub_printk</span><span class="p">(</span><span class="s">&quot;unable to set single-step&quot;</span>
					       <span class="s">&quot; bp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
<span class="cp">#else</span>
			<span class="n">gdbstub_strcpy</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span> <span class="s">&quot;E01&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>

			<span class="cm">/*</span>
<span class="cm">			 * Set baud rate (bBB)</span>
<span class="cm">			 */</span>
		<span class="k">case</span> <span class="sc">&#39;b&#39;</span>:
			<span class="k">do</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">baudrate</span><span class="p">;</span>

				<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">input_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hexToInt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">baudrate</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">gdbstub_strcpy</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span> <span class="s">&quot;B01&quot;</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">baudrate</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* ACK before changing speed */</span>
					<span class="n">putpacket</span><span class="p">(</span><span class="s">&quot;OK&quot;</span><span class="p">);</span>
					<span class="n">gdbstub_io_set_baud</span><span class="p">(</span><span class="n">baudrate</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * Set breakpoint</span>
<span class="cm">			 */</span>
		<span class="k">case</span> <span class="sc">&#39;Z&#39;</span>:
			<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">input_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hexToInt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">loop</span><span class="p">)</span> <span class="o">||</span> <span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">&#39;,&#39;</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">hexToInt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">)</span> <span class="o">||</span> <span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">&#39;,&#39;</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">hexToInt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">)</span>
			    <span class="p">)</span> <span class="p">{</span>
				<span class="n">gdbstub_strcpy</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span> <span class="s">&quot;E01&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* only support software breakpoints */</span>
			<span class="n">gdbstub_strcpy</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span> <span class="s">&quot;E03&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">loop</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
			    <span class="n">length</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span>
			    <span class="n">length</span> <span class="o">&gt;</span> <span class="mi">7</span> <span class="o">||</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="mi">4096</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_set_breakpoint</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">gdbstub_strcpy</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * Clear breakpoint</span>
<span class="cm">			 */</span>
		<span class="k">case</span> <span class="sc">&#39;z&#39;</span>:
			<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">input_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hexToInt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">loop</span><span class="p">)</span> <span class="o">||</span> <span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">&#39;,&#39;</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">hexToInt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">)</span> <span class="o">||</span> <span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">&#39;,&#39;</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">hexToInt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">)</span>
			    <span class="p">)</span> <span class="p">{</span>
				<span class="n">gdbstub_strcpy</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span> <span class="s">&quot;E01&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* only support software breakpoints */</span>
			<span class="n">gdbstub_strcpy</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span> <span class="s">&quot;E03&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">loop</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
			    <span class="n">length</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span>
			    <span class="n">length</span> <span class="o">&gt;</span> <span class="mi">7</span> <span class="o">||</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="mi">4096</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_clear_breakpoint</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">gdbstub_strcpy</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">gdbstub_proto</span><span class="p">(</span><span class="s">&quot;### GDB Unsupported Cmd &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">input_buffer</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* reply to the request */</span>
		<span class="n">putpacket</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="cm">/*</span>
<span class="cm">	 * Need to flush the instruction cache here, as we may</span>
<span class="cm">	 * have deposited a breakpoint, and the icache probably</span>
<span class="cm">	 * has no way of knowing that a data ref to some location</span>
<span class="cm">	 * may have changed something that is in the instruction</span>
<span class="cm">	 * cache.</span>
<span class="cm">	 * NB: We flush both caches, just to be sure...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_flush_caches</span><span class="p">)</span>
		<span class="n">debugger_local_cache_flushinv</span><span class="p">();</span>

	<span class="n">gdbstub_load_fpu</span><span class="p">();</span>
	<span class="n">mn10300_set_gdbleds</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">excep</span> <span class="o">==</span> <span class="n">EXCEP_NMI</span><span class="p">)</span>
		<span class="n">NMICR</span> <span class="o">=</span> <span class="n">NMICR_NMIF</span><span class="p">;</span>

	<span class="n">touch_softlockup_watchdog</span><span class="p">();</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">epsw</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Determine if we hit a debugger special breakpoint that needs skipping over</span>
<span class="cm"> * automatically.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">at_debugger_breakpoint</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * handle event interception</span>
<span class="cm"> */</span>
<span class="n">asmlinkage</span> <span class="kt">int</span> <span class="nf">debugger_intercept</span><span class="p">(</span><span class="k">enum</span> <span class="n">exception_code</span> <span class="n">excep</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">signo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">si_code</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">notfirst</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_busy</span><span class="p">)</span>
		<span class="n">gdbstub_printk</span><span class="p">(</span><span class="s">&quot;--&gt; gdbstub reentered itself</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">gdbstub_busy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">notfirst</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mdr</span><span class="p">;</span>
		<span class="n">asm</span><span class="p">(</span><span class="s">&quot;mov mdr,%0&quot;</span> <span class="o">:</span> <span class="s">&quot;=d&quot;</span><span class="p">(</span><span class="n">mdr</span><span class="p">));</span>

		<span class="n">gdbstub_entry</span><span class="p">(</span>
			<span class="s">&quot;--&gt; debugger_intercept(%p,%04x) [MDR=%lx PC=%lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">regs</span><span class="p">,</span> <span class="n">excep</span><span class="p">,</span> <span class="n">mdr</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">);</span>

		<span class="n">gdbstub_entry</span><span class="p">(</span>
			<span class="s">&quot;PC:  %08lx EPSW:  %08lx  SSP: %08lx mode: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">epsw</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">,</span>
			<span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;User&quot;</span> <span class="o">:</span> <span class="s">&quot;Super&quot;</span><span class="p">);</span>
		<span class="n">gdbstub_entry</span><span class="p">(</span>
			<span class="s">&quot;d0:  %08lx   d1:  %08lx   d2: %08lx   d3: %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">d0</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">d1</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">d2</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">d3</span><span class="p">);</span>
		<span class="n">gdbstub_entry</span><span class="p">(</span>
			<span class="s">&quot;a0:  %08lx   a1:  %08lx   a2: %08lx   a3: %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">a0</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">a1</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">a2</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">a3</span><span class="p">);</span>
		<span class="n">gdbstub_entry</span><span class="p">(</span>
			<span class="s">&quot;e0:  %08lx   e1:  %08lx   e2: %08lx   e3: %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">e0</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">e1</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">e2</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">e3</span><span class="p">);</span>
		<span class="n">gdbstub_entry</span><span class="p">(</span>
			<span class="s">&quot;e4:  %08lx   e5:  %08lx   e6: %08lx   e7: %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">e4</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">e5</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">e6</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">e7</span><span class="p">);</span>
		<span class="n">gdbstub_entry</span><span class="p">(</span>
			<span class="s">&quot;lar: %08lx   lir: %08lx  mdr: %08lx  usp: %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">lar</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">lir</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">mdr</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">sp</span><span class="p">);</span>
		<span class="n">gdbstub_entry</span><span class="p">(</span>
			<span class="s">&quot;cvf: %08lx   crl: %08lx  crh: %08lx  drq: %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">mcvf</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">mcrl</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">mcrh</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">mdrq</span><span class="p">);</span>
		<span class="n">gdbstub_entry</span><span class="p">(</span>
			<span class="s">&quot;threadinfo=%p task=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">current_thread_info</span><span class="p">(),</span> <span class="n">current</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">notfirst</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gdbstub</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">excep</span><span class="p">);</span>

	<span class="n">gdbstub_entry</span><span class="p">(</span><span class="s">&quot;&lt;-- debugger_intercept()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">gdbstub_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * handle the GDB stub itself causing an exception</span>
<span class="cm"> */</span>
<span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">gdbstub_exception</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">exception_code</span> <span class="n">excep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mdr</span><span class="p">;</span>

	<span class="n">asm</span><span class="p">(</span><span class="s">&quot;mov mdr,%0&quot;</span> <span class="o">:</span> <span class="s">&quot;=d&quot;</span><span class="p">(</span><span class="n">mdr</span><span class="p">));</span>
	<span class="n">gdbstub_entry</span><span class="p">(</span><span class="s">&quot;--&gt; gdbstub exception({%p},%04x) [MDR=%lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">regs</span><span class="p">,</span> <span class="n">excep</span><span class="p">,</span> <span class="n">mdr</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">regs</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="p">{}</span>

	<span class="cm">/* handle guarded memory accesses where we know it might fault */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">gdbstub_read_byte_guard</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">gdbstub_read_byte_cont</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">gdbstub_read_word_guard</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">gdbstub_read_word_cont</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">gdbstub_read_dword_guard</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">gdbstub_read_dword_cont</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">gdbstub_write_byte_guard</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">gdbstub_write_byte_cont</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">gdbstub_write_word_guard</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">gdbstub_write_word_cont</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">gdbstub_write_dword_guard</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">gdbstub_write_dword_cont</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gdbstub_printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">### GDB stub caused an exception ###</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* something went horribly wrong */</span>
	<span class="n">console_verbose</span><span class="p">();</span>
	<span class="n">show_registers</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>

	<span class="n">panic</span><span class="p">(</span><span class="s">&quot;GDB Stub caused an unexpected exception - can&#39;t continue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* we caught an attempt by the stub to access silly memory */</span>
<span class="nl">fault:</span>
	<span class="n">gdbstub_entry</span><span class="p">(</span><span class="s">&quot;&lt;-- gdbstub exception() = EFAULT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">d0</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * send an exit message to GDB</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">gdbstub_exit</span><span class="p">(</span><span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">checksum</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">gdbstub_busy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">output_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;W&#39;</span><span class="p">;</span>
	<span class="n">output_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">hex_asc_hi</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
	<span class="n">output_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">hex_asc_lo</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
	<span class="n">output_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">gdbstub_io_tx_char</span><span class="p">(</span><span class="sc">&#39;$&#39;</span><span class="p">);</span>
	<span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">ch</span> <span class="o">=</span> <span class="n">output_buffer</span><span class="p">[</span><span class="n">count</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gdbstub_io_tx_char</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
		<span class="n">checksum</span> <span class="o">+=</span> <span class="n">ch</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gdbstub_io_tx_char</span><span class="p">(</span><span class="sc">&#39;#&#39;</span><span class="p">);</span>
	<span class="n">gdbstub_io_tx_char</span><span class="p">(</span><span class="n">hex_asc_hi</span><span class="p">(</span><span class="n">checksum</span><span class="p">));</span>
	<span class="n">gdbstub_io_tx_char</span><span class="p">(</span><span class="n">hex_asc_lo</span><span class="p">(</span><span class="n">checksum</span><span class="p">));</span>

	<span class="cm">/* make sure the output is flushed, or else RedBoot might clobber it */</span>
	<span class="n">gdbstub_io_tx_flush</span><span class="p">();</span>

	<span class="n">gdbstub_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * initialise the GDB stub</span>
<span class="cm"> */</span>
<span class="n">asmlinkage</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">gdbstub_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_GDBSTUB_IMMEDIATE</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">gdbstub_busy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">gdbstub_banner</span><span class="p">);</span>

	<span class="n">gdbstub_io_init</span><span class="p">();</span>

	<span class="n">gdbstub_entry</span><span class="p">(</span><span class="s">&quot;--&gt; gdbstub_init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* try to talk to GDB (or anyone insane enough to want to type GDB</span>
<span class="cm">	 * protocol by hand) */</span>
	<span class="n">gdbstub_io</span><span class="p">(</span><span class="s">&quot;### GDB Tx ACK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">gdbstub_io_tx_char</span><span class="p">(</span><span class="sc">&#39;+&#39;</span><span class="p">);</span> <span class="cm">/* &#39;hello world&#39; */</span>

<span class="cp">#ifdef CONFIG_GDBSTUB_IMMEDIATE</span>
	<span class="n">gdbstub_printk</span><span class="p">(</span><span class="s">&quot;GDB Stub waiting for packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* in case GDB is started before us, ACK any packets that are already</span>
<span class="cm">	 * sitting there (presumably &quot;$?#xx&quot;)</span>
<span class="cm">	 */</span>
	<span class="k">do</span> <span class="p">{</span> <span class="n">gdbstub_io_rx_char</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ch</span> <span class="o">!=</span> <span class="sc">&#39;$&#39;</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span> <span class="n">gdbstub_io_rx_char</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ch</span> <span class="o">!=</span> <span class="sc">&#39;#&#39;</span><span class="p">);</span>
	<span class="cm">/* eat first csum byte */</span>
	<span class="k">do</span> <span class="p">{</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">gdbstub_io_rx_char</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* eat second csum byte */</span>
	<span class="k">do</span> <span class="p">{</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">gdbstub_io_rx_char</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">gdbstub_io</span><span class="p">(</span><span class="s">&quot;### GDB Tx NAK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">gdbstub_io_tx_char</span><span class="p">(</span><span class="sc">&#39;-&#39;</span><span class="p">);</span> <span class="cm">/* NAK it */</span>

<span class="cp">#else</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;GDB Stub ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">gdbstub_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">gdbstub_entry</span><span class="p">(</span><span class="s">&quot;&lt;-- gdbstub_init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * register the console at a more appropriate time</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_GDBSTUB_CONSOLE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">gdbstub_postinit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;registering console</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">register_console</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdbstub_console</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__initcall</span><span class="p">(</span><span class="n">gdbstub_postinit</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * handle character reception on GDB serial port</span>
<span class="cm"> * - jump into the GDB stub if BREAK is detected on the serial line</span>
<span class="cm"> */</span>
<span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">gdbstub_rx_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="k">enum</span> <span class="n">exception_code</span> <span class="n">excep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">gdbstub_entry</span><span class="p">(</span><span class="s">&quot;--&gt; gdbstub_rx_irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gdbstub_io_rx_char</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EIO</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">)</span>
				<span class="n">gdbstub_rx_unget</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
			<span class="n">gdbstub</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">excep</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">);</span>

	<span class="n">gdbstub_entry</span><span class="p">(</span><span class="s">&quot;&lt;-- gdbstub_rx_irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
