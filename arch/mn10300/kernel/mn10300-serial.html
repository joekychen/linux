<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › mn10300 › kernel › mn10300-serial.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>mn10300-serial.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* MN10300 On-chip serial port UART driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007 Red Hat, Inc. All Rights Reserved.</span>
<span class="cm"> * Written by David Howells (dhowells@redhat.com)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public Licence</span>
<span class="cm"> * as published by the Free Software Foundation; either version</span>
<span class="cm"> * 2 of the Licence, or (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">serial_name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;MN10300 Serial driver&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">serial_version</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;mn10300_serial-1.0&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">serial_revdate</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;2007-11-06&quot;</span><span class="p">;</span>

<span class="cp">#if defined(CONFIG_MN10300_TTYSM_CONSOLE) &amp;&amp; defined(CONFIG_MAGIC_SYSRQ)</span>
<span class="cp">#define SUPPORT_SYSRQ</span>
<span class="cp">#endif</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/serial.h&gt;</span>
<span class="cp">#include &lt;linux/circ_buf.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/signal.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>
<span class="cp">#include &lt;linux/major.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/sysrq.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/bitops.h&gt;</span>
<span class="cp">#include &lt;asm/serial-regs.h&gt;</span>
<span class="cp">#include &lt;unit/timex.h&gt;</span>
<span class="cp">#include &quot;mn10300-serial.h&quot;</span>

<span class="cp">#ifdef CONFIG_SMP</span>
<span class="cp">#undef  GxICR</span>
<span class="cp">#define GxICR(X) CROSS_GxICR(X, 0)</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SMP */</span><span class="cp"></span>

<span class="cp">#define kenter(FMT, ...) \</span>
<span class="cp">	printk(KERN_DEBUG &quot;--&gt;%s(&quot; FMT &quot;)\n&quot;, __func__, ##__VA_ARGS__)</span>
<span class="cp">#define _enter(FMT, ...) \</span>
<span class="cp">	no_printk(KERN_DEBUG &quot;--&gt;%s(&quot; FMT &quot;)\n&quot;, __func__, ##__VA_ARGS__)</span>
<span class="cp">#define kdebug(FMT, ...) \</span>
<span class="cp">	printk(KERN_DEBUG &quot;--- &quot; FMT &quot;\n&quot;, ##__VA_ARGS__)</span>
<span class="cp">#define _debug(FMT, ...) \</span>
<span class="cp">	no_printk(KERN_DEBUG &quot;--- &quot; FMT &quot;\n&quot;, ##__VA_ARGS__)</span>
<span class="cp">#define kproto(FMT, ...) \</span>
<span class="cp">	printk(KERN_DEBUG &quot;### MNSERIAL &quot; FMT &quot; ###\n&quot;, ##__VA_ARGS__)</span>
<span class="cp">#define _proto(FMT, ...) \</span>
<span class="cp">	no_printk(KERN_DEBUG &quot;### MNSERIAL &quot; FMT &quot; ###\n&quot;, ##__VA_ARGS__)</span>

<span class="cp">#ifndef CODMSB</span>
<span class="cm">/* c_cflag bit meaning */</span>
<span class="cp">#define CODMSB	004000000000	</span><span class="cm">/* change Transfer bit-order */</span><span class="cp"></span>
<span class="cp">#endif</span>

<span class="cp">#define NR_UARTS 3</span>

<span class="cp">#ifdef CONFIG_MN10300_TTYSM_CONSOLE</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mn10300_serial_console_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">co</span><span class="p">,</span>
					   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">count</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="n">mn10300_serial_console_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">co</span><span class="p">,</span>
						 <span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uart_driver</span> <span class="n">mn10300_serial_driver</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">console</span> <span class="n">mn10300_serial_console</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ttySM&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">mn10300_serial_console_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">uart_console_device</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup</span>		<span class="o">=</span> <span class="n">mn10300_serial_console_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">CON_PRINTBUFFER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">mn10300_serial_driver</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uart_driver</span> <span class="n">mn10300_serial_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver_name</span>	<span class="o">=</span> <span class="s">&quot;mn10300-serial&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev_name</span>	<span class="o">=</span> <span class="s">&quot;ttySM&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">major</span>		<span class="o">=</span> <span class="n">TTY_MAJOR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">minor</span>		<span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nr</span>		<span class="o">=</span> <span class="n">NR_UARTS</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_MN10300_TTYSM_CONSOLE</span>
	<span class="p">.</span><span class="n">cons</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">mn10300_serial_console</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mn10300_serial_tx_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mn10300_serial_set_mctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mctrl</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mn10300_serial_get_mctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mn10300_serial_stop_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mn10300_serial_start_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mn10300_serial_send_xchar</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mn10300_serial_stop_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mn10300_serial_enable_ms</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mn10300_serial_break_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ctl</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mn10300_serial_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mn10300_serial_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mn10300_serial_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mn10300_serial_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mn10300_serial_release_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mn10300_serial_request_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mn10300_serial_config_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mn10300_serial_verify_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">serial_struct</span> <span class="o">*</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_CONSOLE_POLL</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mn10300_serial_poll_put_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mn10300_serial_poll_get_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">uart_ops</span> <span class="n">mn10300_serial_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">tx_empty</span>	<span class="o">=</span> <span class="n">mn10300_serial_tx_empty</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_mctrl</span>	<span class="o">=</span> <span class="n">mn10300_serial_set_mctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_mctrl</span>	<span class="o">=</span> <span class="n">mn10300_serial_get_mctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_tx</span>	<span class="o">=</span> <span class="n">mn10300_serial_stop_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_tx</span>	<span class="o">=</span> <span class="n">mn10300_serial_start_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send_xchar</span>	<span class="o">=</span> <span class="n">mn10300_serial_send_xchar</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_rx</span>	<span class="o">=</span> <span class="n">mn10300_serial_stop_rx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_ms</span>	<span class="o">=</span> <span class="n">mn10300_serial_enable_ms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">break_ctl</span>	<span class="o">=</span> <span class="n">mn10300_serial_break_ctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">startup</span>	<span class="o">=</span> <span class="n">mn10300_serial_startup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">mn10300_serial_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span>	<span class="o">=</span> <span class="n">mn10300_serial_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">mn10300_serial_type</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release_port</span>	<span class="o">=</span> <span class="n">mn10300_serial_release_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">request_port</span>	<span class="o">=</span> <span class="n">mn10300_serial_request_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_port</span>	<span class="o">=</span> <span class="n">mn10300_serial_config_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">verify_port</span>	<span class="o">=</span> <span class="n">mn10300_serial_verify_port</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_CONSOLE_POLL</span>
	<span class="p">.</span><span class="n">poll_put_char</span>	<span class="o">=</span> <span class="n">mn10300_serial_poll_put_char</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll_get_char</span>	<span class="o">=</span> <span class="n">mn10300_serial_poll_get_char</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">mn10300_serial_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * the first on-chip serial port: ttySM0 (aka SIF0)</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_MN10300_TTYSM0</span>
<span class="k">struct</span> <span class="n">mn10300_serial_port</span> <span class="n">mn10300_serial_port_sif0</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">mn10300_serial_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">membase</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">SC0CTR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">mapbase</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">SC0CTR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">iotype</span>	<span class="o">=</span> <span class="n">UPIO_MEM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">irq</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">uartclk</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="cm">/* MN10300_IOCLK, */</span>
	<span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">fifosize</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">UPF_BOOT_AUTOCONF</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">line</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">type</span>	<span class="o">=</span> <span class="n">PORT_MN10300</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">lock</span>	<span class="o">=</span>
	<span class="n">__SPIN_LOCK_UNLOCKED</span><span class="p">(</span><span class="n">mn10300_serial_port_sif0</span><span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">lock</span><span class="p">),</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ttySM0&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_iobase</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">SC0CTR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_control</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">SC0CTR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_status</span>	<span class="o">=</span> <span class="p">(</span><span class="k">volatile</span> <span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">SC0STR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_intr</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">SC0ICR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_rxb</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">SC0RXB</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_txb</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">SC0TXB</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rx_name</span>	<span class="o">=</span> <span class="s">&quot;ttySM0:Rx&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tx_name</span>	<span class="o">=</span> <span class="s">&quot;ttySM0:Tx&quot;</span><span class="p">,</span>
<span class="cp">#if defined(CONFIG_MN10300_TTYSM0_TIMER8)</span>
	<span class="p">.</span><span class="n">tm_name</span>	<span class="o">=</span> <span class="s">&quot;ttySM0:Timer8&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_tmxmd</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">TM8MD</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_tmxbr</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">TM8BR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_tmicr</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">TM8ICR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tm_irq</span>		<span class="o">=</span> <span class="n">TM8IRQ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">div_timer</span>	<span class="o">=</span> <span class="n">MNSCx_DIV_TIMER_16BIT</span><span class="p">,</span>
<span class="cp">#elif defined(CONFIG_MN10300_TTYSM0_TIMER0)</span>
	<span class="p">.</span><span class="n">tm_name</span>	<span class="o">=</span> <span class="s">&quot;ttySM0:Timer0&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_tmxmd</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">TM0MD</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_tmxbr</span>		<span class="o">=</span> <span class="p">(</span><span class="k">volatile</span> <span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">TM0BR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_tmicr</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">TM0ICR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tm_irq</span>		<span class="o">=</span> <span class="n">TM0IRQ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">div_timer</span>	<span class="o">=</span> <span class="n">MNSCx_DIV_TIMER_8BIT</span><span class="p">,</span>
<span class="cp">#elif defined(CONFIG_MN10300_TTYSM0_TIMER2)</span>
	<span class="p">.</span><span class="n">tm_name</span>	<span class="o">=</span> <span class="s">&quot;ttySM0:Timer2&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_tmxmd</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">TM2MD</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_tmxbr</span>		<span class="o">=</span> <span class="p">(</span><span class="k">volatile</span> <span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">TM2BR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_tmicr</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">TM2ICR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tm_irq</span>		<span class="o">=</span> <span class="n">TM2IRQ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">div_timer</span>	<span class="o">=</span> <span class="n">MNSCx_DIV_TIMER_8BIT</span><span class="p">,</span>
<span class="cp">#else</span>
<span class="cp">#error &quot;Unknown config for ttySM0&quot;</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">rx_irq</span>		<span class="o">=</span> <span class="n">SC0RXIRQ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tx_irq</span>		<span class="o">=</span> <span class="n">SC0TXIRQ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rx_icr</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">GxICR</span><span class="p">(</span><span class="n">SC0RXIRQ</span><span class="p">),</span>
	<span class="p">.</span><span class="n">tx_icr</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">GxICR</span><span class="p">(</span><span class="n">SC0TXIRQ</span><span class="p">),</span>
	<span class="p">.</span><span class="n">clock_src</span>	<span class="o">=</span> <span class="n">MNSCx_CLOCK_SRC_IOCLK</span><span class="p">,</span>
	<span class="p">.</span><span class="n">options</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_GDBSTUB_ON_TTYSM0</span>
	<span class="p">.</span><span class="n">gdbstub</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MN10300_TTYSM0 */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * the second on-chip serial port: ttySM1 (aka SIF1)</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_MN10300_TTYSM1</span>
<span class="k">struct</span> <span class="n">mn10300_serial_port</span> <span class="n">mn10300_serial_port_sif1</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">mn10300_serial_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">membase</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">SC1CTR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">mapbase</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">SC1CTR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">iotype</span>	<span class="o">=</span> <span class="n">UPIO_MEM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">irq</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">uartclk</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="cm">/* MN10300_IOCLK, */</span>
	<span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">fifosize</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">UPF_BOOT_AUTOCONF</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">line</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">type</span>	<span class="o">=</span> <span class="n">PORT_MN10300</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">lock</span>	<span class="o">=</span>
	<span class="n">__SPIN_LOCK_UNLOCKED</span><span class="p">(</span><span class="n">mn10300_serial_port_sif1</span><span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">lock</span><span class="p">),</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ttySM1&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_iobase</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">SC1CTR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_control</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">SC1CTR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_status</span>	<span class="o">=</span> <span class="p">(</span><span class="k">volatile</span> <span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">SC1STR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_intr</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">SC1ICR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_rxb</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">SC1RXB</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_txb</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">SC1TXB</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rx_name</span>	<span class="o">=</span> <span class="s">&quot;ttySM1:Rx&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tx_name</span>	<span class="o">=</span> <span class="s">&quot;ttySM1:Tx&quot;</span><span class="p">,</span>
<span class="cp">#if defined(CONFIG_MN10300_TTYSM1_TIMER9)</span>
	<span class="p">.</span><span class="n">tm_name</span>	<span class="o">=</span> <span class="s">&quot;ttySM1:Timer9&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_tmxmd</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">TM9MD</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_tmxbr</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">TM9BR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_tmicr</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">TM9ICR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tm_irq</span>		<span class="o">=</span> <span class="n">TM9IRQ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">div_timer</span>	<span class="o">=</span> <span class="n">MNSCx_DIV_TIMER_16BIT</span><span class="p">,</span>
<span class="cp">#elif defined(CONFIG_MN10300_TTYSM1_TIMER3)</span>
	<span class="p">.</span><span class="n">tm_name</span>	<span class="o">=</span> <span class="s">&quot;ttySM1:Timer3&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_tmxmd</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">TM3MD</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_tmxbr</span>		<span class="o">=</span> <span class="p">(</span><span class="k">volatile</span> <span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">TM3BR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_tmicr</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">TM3ICR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tm_irq</span>		<span class="o">=</span> <span class="n">TM3IRQ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">div_timer</span>	<span class="o">=</span> <span class="n">MNSCx_DIV_TIMER_8BIT</span><span class="p">,</span>
<span class="cp">#elif defined(CONFIG_MN10300_TTYSM1_TIMER12)</span>
	<span class="p">.</span><span class="n">tm_name</span>	<span class="o">=</span> <span class="s">&quot;ttySM1/Timer12&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_tmxmd</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">TM12MD</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_tmxbr</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">TM12BR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_tmicr</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">TM12ICR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tm_irq</span>		<span class="o">=</span> <span class="n">TM12IRQ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">div_timer</span>	<span class="o">=</span> <span class="n">MNSCx_DIV_TIMER_16BIT</span><span class="p">,</span>
<span class="cp">#else</span>
<span class="cp">#error &quot;Unknown config for ttySM1&quot;</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">rx_irq</span>		<span class="o">=</span> <span class="n">SC1RXIRQ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tx_irq</span>		<span class="o">=</span> <span class="n">SC1TXIRQ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rx_icr</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">GxICR</span><span class="p">(</span><span class="n">SC1RXIRQ</span><span class="p">),</span>
	<span class="p">.</span><span class="n">tx_icr</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">GxICR</span><span class="p">(</span><span class="n">SC1TXIRQ</span><span class="p">),</span>
	<span class="p">.</span><span class="n">clock_src</span>	<span class="o">=</span> <span class="n">MNSCx_CLOCK_SRC_IOCLK</span><span class="p">,</span>
	<span class="p">.</span><span class="n">options</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_GDBSTUB_ON_TTYSM1</span>
	<span class="p">.</span><span class="n">gdbstub</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MN10300_TTYSM1 */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * the third on-chip serial port: ttySM2 (aka SIF2)</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_MN10300_TTYSM2</span>
<span class="k">struct</span> <span class="n">mn10300_serial_port</span> <span class="n">mn10300_serial_port_sif2</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">mn10300_serial_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">membase</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">SC2CTR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">mapbase</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">SC2CTR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">iotype</span>	<span class="o">=</span> <span class="n">UPIO_MEM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">irq</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">uartclk</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="cm">/* MN10300_IOCLK, */</span>
	<span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">fifosize</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">UPF_BOOT_AUTOCONF</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">line</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_MN10300_TTYSM2_CTS</span>
	<span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">type</span>	<span class="o">=</span> <span class="n">PORT_MN10300_CTS</span><span class="p">,</span>
<span class="cp">#else</span>
	<span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">type</span>	<span class="o">=</span> <span class="n">PORT_MN10300</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">lock</span>	<span class="o">=</span>
	<span class="n">__SPIN_LOCK_UNLOCKED</span><span class="p">(</span><span class="n">mn10300_serial_port_sif2</span><span class="p">.</span><span class="n">uart</span><span class="p">.</span><span class="n">lock</span><span class="p">),</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ttySM2&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_iobase</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">SC2CTR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_control</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">SC2CTR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_status</span>	<span class="o">=</span> <span class="p">(</span><span class="k">volatile</span> <span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">SC2STR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_intr</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">SC2ICR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_rxb</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">SC2RXB</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_txb</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">SC2TXB</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rx_name</span>	<span class="o">=</span> <span class="s">&quot;ttySM2:Rx&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tx_name</span>	<span class="o">=</span> <span class="s">&quot;ttySM2:Tx&quot;</span><span class="p">,</span>
<span class="cp">#if defined(CONFIG_MN10300_TTYSM2_TIMER10)</span>
	<span class="p">.</span><span class="n">tm_name</span>	<span class="o">=</span> <span class="s">&quot;ttySM2/Timer10&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_tmxmd</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">TM10MD</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_tmxbr</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">TM10BR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_tmicr</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">TM10ICR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tm_irq</span>		<span class="o">=</span> <span class="n">TM10IRQ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">div_timer</span>	<span class="o">=</span> <span class="n">MNSCx_DIV_TIMER_16BIT</span><span class="p">,</span>
<span class="cp">#elif defined(CONFIG_MN10300_TTYSM2_TIMER9)</span>
	<span class="p">.</span><span class="n">tm_name</span>	<span class="o">=</span> <span class="s">&quot;ttySM2/Timer9&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_tmxmd</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">TM9MD</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_tmxbr</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">TM9BR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_tmicr</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">TM9ICR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tm_irq</span>		<span class="o">=</span> <span class="n">TM9IRQ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">div_timer</span>	<span class="o">=</span> <span class="n">MNSCx_DIV_TIMER_16BIT</span><span class="p">,</span>
<span class="cp">#elif defined(CONFIG_MN10300_TTYSM2_TIMER1)</span>
	<span class="p">.</span><span class="n">tm_name</span>	<span class="o">=</span> <span class="s">&quot;ttySM2/Timer1&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_tmxmd</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">TM1MD</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_tmxbr</span>		<span class="o">=</span> <span class="p">(</span><span class="k">volatile</span> <span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">TM1BR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_tmicr</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">TM1ICR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tm_irq</span>		<span class="o">=</span> <span class="n">TM1IRQ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">div_timer</span>	<span class="o">=</span> <span class="n">MNSCx_DIV_TIMER_8BIT</span><span class="p">,</span>
<span class="cp">#elif defined(CONFIG_MN10300_TTYSM2_TIMER3)</span>
	<span class="p">.</span><span class="n">tm_name</span>	<span class="o">=</span> <span class="s">&quot;ttySM2/Timer3&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_tmxmd</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">TM3MD</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_tmxbr</span>		<span class="o">=</span> <span class="p">(</span><span class="k">volatile</span> <span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">TM3BR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">_tmicr</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">TM3ICR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tm_irq</span>		<span class="o">=</span> <span class="n">TM3IRQ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">div_timer</span>	<span class="o">=</span> <span class="n">MNSCx_DIV_TIMER_8BIT</span><span class="p">,</span>
<span class="cp">#else</span>
<span class="cp">#error &quot;Unknown config for ttySM2&quot;</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">rx_irq</span>		<span class="o">=</span> <span class="n">SC2RXIRQ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tx_irq</span>		<span class="o">=</span> <span class="n">SC2TXIRQ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rx_icr</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">GxICR</span><span class="p">(</span><span class="n">SC2RXIRQ</span><span class="p">),</span>
	<span class="p">.</span><span class="n">tx_icr</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">GxICR</span><span class="p">(</span><span class="n">SC2TXIRQ</span><span class="p">),</span>
	<span class="p">.</span><span class="n">clock_src</span>	<span class="o">=</span> <span class="n">MNSCx_CLOCK_SRC_IOCLK</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_MN10300_TTYSM2_CTS</span>
	<span class="p">.</span><span class="n">options</span>	<span class="o">=</span> <span class="n">MNSCx_OPT_CTS</span><span class="p">,</span>
<span class="cp">#else</span>
	<span class="p">.</span><span class="n">options</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_GDBSTUB_ON_TTYSM2</span>
	<span class="p">.</span><span class="n">gdbstub</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MN10300_TTYSM2 */</span><span class="cp"></span>


<span class="cm">/*</span>
<span class="cm"> * list of available serial ports</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mn10300_serial_port</span> <span class="o">*</span><span class="n">mn10300_serial_ports</span><span class="p">[</span><span class="n">NR_UARTS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_MN10300_TTYSM0</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">mn10300_serial_port_sif0</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_MN10300_TTYSM1</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">mn10300_serial_port_sif1</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_MN10300_TTYSM2</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">mn10300_serial_port_sif2</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">[</span><span class="n">NR_UARTS</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * we abuse the serial ports&#39; baud timers&#39; interrupt lines to get the ability</span>
<span class="cm"> * to deliver interrupts to userspace as we use the ports&#39; interrupt lines to</span>
<span class="cm"> * do virtual DMA on account of the ports having no hardware FIFOs</span>
<span class="cm"> *</span>
<span class="cm"> * we can generate an interrupt manually in the assembly stubs by writing to</span>
<span class="cm"> * the enable and detect bits in the interrupt control register, so all we need</span>
<span class="cm"> * to do here is disable the interrupt line</span>
<span class="cm"> *</span>
<span class="cm"> * note that we can&#39;t just leave the line enabled as the baud rate timer *also*</span>
<span class="cm"> * generates interrupts</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mn10300_serial_mask_ack</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">arch_local_cli_save</span><span class="p">();</span>
	<span class="n">GxICR</span><span class="p">(</span><span class="n">irq</span><span class="p">)</span> <span class="o">=</span> <span class="n">GxICR_LEVEL_6</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">GxICR</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span> <span class="cm">/* flush write buffer */</span>
	<span class="n">arch_local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mn10300_serial_chip_mask_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mn10300_serial_mask_ack</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mn10300_serial_nop</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">mn10300_serial_pic</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;mnserial&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_ack</span>	<span class="o">=</span> <span class="n">mn10300_serial_chip_mask_ack</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask</span>	<span class="o">=</span> <span class="n">mn10300_serial_chip_mask_ack</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask_ack</span>	<span class="o">=</span> <span class="n">mn10300_serial_chip_mask_ack</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span>	<span class="o">=</span> <span class="n">mn10300_serial_nop</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * serial virtual DMA interrupt jump table</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mn10300_serial_int</span> <span class="n">mn10300_serial_int_tbl</span><span class="p">[</span><span class="n">NR_IRQS</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mn10300_serial_dis_tx_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">mn10300_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">x</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">arch_local_cli_save</span><span class="p">();</span>
	<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tx_icr</span> <span class="o">=</span> <span class="n">NUM2GxICR_LEVEL</span><span class="p">(</span><span class="n">CONFIG_MN10300_SERIAL_IRQ_LEVEL</span><span class="p">);</span>
	<span class="n">x</span> <span class="o">=</span> <span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tx_icr</span><span class="p">;</span>
	<span class="n">arch_local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mn10300_serial_en_tx_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">mn10300_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">x</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">arch_local_cli_save</span><span class="p">();</span>
	<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tx_icr</span> <span class="o">=</span>
		<span class="n">NUM2GxICR_LEVEL</span><span class="p">(</span><span class="n">CONFIG_MN10300_SERIAL_IRQ_LEVEL</span><span class="p">)</span> <span class="o">|</span> <span class="n">GxICR_ENABLE</span><span class="p">;</span>
	<span class="n">x</span> <span class="o">=</span> <span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tx_icr</span><span class="p">;</span>
	<span class="n">arch_local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mn10300_serial_dis_rx_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">mn10300_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">x</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">arch_local_cli_save</span><span class="p">();</span>
	<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_icr</span> <span class="o">=</span> <span class="n">NUM2GxICR_LEVEL</span><span class="p">(</span><span class="n">CONFIG_MN10300_SERIAL_IRQ_LEVEL</span><span class="p">);</span>
	<span class="n">x</span> <span class="o">=</span> <span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_icr</span><span class="p">;</span>
	<span class="n">arch_local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * multi-bit equivalent of test_and_clear_bit()</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mask_test_and_clear</span><span class="p">(</span><span class="k">volatile</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">epsw</span><span class="p">;</span>
	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;	bclr	%1,(%2)		</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;	mov	epsw,%0		</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="o">:</span> <span class="s">&quot;=d&quot;</span><span class="p">(</span><span class="n">epsw</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;d&quot;</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="s">&quot;a&quot;</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
		     <span class="o">:</span> <span class="s">&quot;cc&quot;</span><span class="p">,</span> <span class="s">&quot;memory&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">epsw</span> <span class="o">&amp;</span> <span class="n">EPSW_FLAG_Z</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * receive chars from the ring buffer for this serial port</span>
<span class="cm"> * - must do break detection here (not done in the UART)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mn10300_serial_receive_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">mn10300_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uart_icount</span> <span class="o">*</span><span class="n">icount</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">icount</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">ix</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">st</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">push</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">overrun</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">push</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">CIRC_CNT</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_inp</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_outp</span><span class="p">,</span> <span class="n">MNSC_BUFFER_SIZE</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">tty_buffer_request_room</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">low_latency</span><span class="p">)</span>
			<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">try_again:</span>
	<span class="cm">/* pull chars out of the hat */</span>
	<span class="n">ix</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_outp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ix</span> <span class="o">==</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_inp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">push</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">low_latency</span><span class="p">)</span>
			<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ch</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_buffer</span><span class="p">[</span><span class="n">ix</span><span class="o">++</span><span class="p">];</span>
	<span class="n">st</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_buffer</span><span class="p">[</span><span class="n">ix</span><span class="o">++</span><span class="p">];</span>
	<span class="n">smp_rmb</span><span class="p">();</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_outp</span> <span class="o">=</span> <span class="n">ix</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MNSC_BUFFER_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span><span class="o">++</span><span class="p">;</span>

	<span class="n">st</span> <span class="o">&amp;=</span> <span class="n">SC01STR_FEF</span> <span class="o">|</span> <span class="n">SC01STR_PEF</span> <span class="o">|</span> <span class="n">SC01STR_OEF</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">overrun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* the UART doesn&#39;t detect BREAK, so we have to do that ourselves</span>
<span class="cm">	 * - it starts as a framing error on a NUL character</span>
<span class="cm">	 * - then we count another two NUL characters before issuing TTY_BREAK</span>
<span class="cm">	 * - then we end on a normal char or one that has all the bottom bits</span>
<span class="cm">	 *   zero and the top bits set</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_brk</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* not breaking at the moment */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">st</span> <span class="o">&amp;</span> <span class="n">SC01STR_FEF</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_brk</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">try_again</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">not_break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">st</span> <span class="o">&amp;</span> <span class="n">SC01STR_FEF</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_brk</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">_proto</span><span class="p">(</span><span class="s">&quot;Rx Break Detected&quot;</span><span class="p">);</span>
			<span class="n">icount</span><span class="o">-&gt;</span><span class="n">brk</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">uart_handle_break</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">ignore_char</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TTY_BREAK</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">insert</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">not_break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">st</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SC01STR_FEF</span> <span class="o">|</span> <span class="n">SC01STR_PEF</span> <span class="o">|</span> <span class="n">SC01STR_OEF</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">try_again</span><span class="p">;</span> <span class="cm">/* still breaking */</span>

		<span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_brk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* end of the break */</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0xFF</span>:
		<span class="k">case</span> <span class="mh">0xFE</span>:
		<span class="k">case</span> <span class="mh">0xFC</span>:
		<span class="k">case</span> <span class="mh">0xF8</span>:
		<span class="k">case</span> <span class="mh">0xF0</span>:
		<span class="k">case</span> <span class="mh">0xE0</span>:
		<span class="k">case</span> <span class="mh">0xC0</span>:
		<span class="k">case</span> <span class="mh">0x80</span>:
		<span class="k">case</span> <span class="mh">0x00</span>:
			<span class="cm">/* discard char at probable break end */</span>
			<span class="k">goto</span> <span class="n">try_again</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">process_errors:</span>
	<span class="cm">/* handle framing error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">st</span> <span class="o">&amp;</span> <span class="n">SC01STR_FEF</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* framing error with NUL char is probably a BREAK */</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_brk</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">try_again</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">_proto</span><span class="p">(</span><span class="s">&quot;Rx Framing Error&quot;</span><span class="p">);</span>
		<span class="n">icount</span><span class="o">-&gt;</span><span class="n">frame</span><span class="o">++</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TTY_FRAME</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* handle parity error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">st</span> <span class="o">&amp;</span> <span class="n">SC01STR_PEF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_proto</span><span class="p">(</span><span class="s">&quot;Rx Parity Error&quot;</span><span class="p">);</span>
		<span class="n">icount</span><span class="o">-&gt;</span><span class="n">parity</span><span class="o">++</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">TTY_PARITY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* handle normal char */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uart_handle_sysrq_char</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">ignore_char</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TTY_NORMAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* handle overrun error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">st</span> <span class="o">&amp;</span> <span class="n">SC01STR_OEF</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_brk</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">try_again</span><span class="p">;</span>

		<span class="n">_proto</span><span class="p">(</span><span class="s">&quot;Rx Overrun Error&quot;</span><span class="p">);</span>
		<span class="n">icount</span><span class="o">-&gt;</span><span class="n">overrun</span><span class="o">++</span><span class="p">;</span>
		<span class="n">overrun</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">insert:</span>
	<span class="n">status</span> <span class="o">&amp;=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">read_status_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">overrun</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">ignore_status_mask</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">flag</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TTY_BREAK</span><span class="p">))</span>
			<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_BREAK</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TTY_PARITY</span><span class="p">))</span>
			<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_PARITY</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TTY_FRAME</span><span class="p">))</span>
			<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_FRAME</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_NORMAL</span><span class="p">;</span>

		<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* overrun is special, since it&#39;s reported immediately, and doesn&#39;t</span>
<span class="cm">	 * affect the current character</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">overrun</span><span class="p">)</span>
		<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TTY_OVERRUN</span><span class="p">);</span>

	<span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">low_latency</span><span class="p">)</span>
			<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">ignore_char:</span>
	<span class="n">push</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">try_again</span><span class="p">;</span>

<span class="nl">not_break:</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_brk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">process_errors</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * handle an interrupt from the serial transmission &quot;virtual DMA&quot; driver</span>
<span class="cm"> * - note: the interrupt routine will disable its own interrupts when the Tx</span>
<span class="cm"> *   buffer is empty</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mn10300_serial_transmit_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">mn10300_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">state</span> <span class="o">||</span> <span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mn10300_serial_dis_tx_intr</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uart_tx_stopped</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">uart_circ_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">))</span>
		<span class="n">mn10300_serial_dis_tx_intr</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uart_circ_chars_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">WAKEUP_CHARS</span><span class="p">)</span>
		<span class="n">uart_write_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * deal with a change in the status of the CTS line</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mn10300_serial_cts_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">mn10300_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u8</span> <span class="n">st</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ctr</span><span class="p">;</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">tx_cts</span> <span class="o">=</span> <span class="n">st</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">icount</span><span class="p">.</span><span class="n">cts</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* flip the CTS state selector flag to interrupt when it changes</span>
<span class="cm">	 * back */</span>
	<span class="n">ctr</span> <span class="o">=</span> <span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_control</span><span class="p">;</span>
	<span class="n">ctr</span> <span class="o">^=</span> <span class="n">SC2CTR_TWS</span><span class="p">;</span>
	<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_control</span> <span class="o">=</span> <span class="n">ctr</span><span class="p">;</span>

	<span class="n">uart_handle_cts_change</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">,</span> <span class="n">st</span> <span class="o">&amp;</span> <span class="n">SC2STR_CTS</span><span class="p">);</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">delta_msr_wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * handle a virtual interrupt generated by the lower level &quot;virtual DMA&quot;</span>
<span class="cm"> * routines (irq is the baud timer interrupt)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">mn10300_serial_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mn10300_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">st</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">intr_flags</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;INT %s: %x&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">intr_flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mask_test_and_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">intr_flags</span><span class="p">,</span> <span class="n">MNSCx_RX_AVAIL</span><span class="p">))</span>
			<span class="n">mn10300_serial_receive_interrupt</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mask_test_and_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">intr_flags</span><span class="p">,</span>
					<span class="n">MNSCx_TX_SPACE</span> <span class="o">|</span> <span class="n">MNSCx_TX_EMPTY</span><span class="p">))</span>
			<span class="n">mn10300_serial_transmit_interrupt</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* the only modem control line amongst the whole lot is CTS on</span>
<span class="cm">	 * serial port 2 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_MN10300_CTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">st</span> <span class="o">=</span> <span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_status</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tx_cts</span> <span class="o">^</span> <span class="n">st</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SC2STR_CTS</span><span class="p">)</span>
			<span class="n">mn10300_serial_cts_changed</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">st</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * return indication of whether the hardware transmit buffer is empty</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">mn10300_serial_tx_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mn10300_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">_port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mn10300_serial_port</span><span class="p">,</span> <span class="n">uart</span><span class="p">);</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SC01STR_TXF</span> <span class="o">|</span> <span class="n">SC01STR_TBF</span><span class="p">))</span> <span class="o">?</span>
		<span class="mi">0</span> <span class="o">:</span> <span class="n">TIOCSER_TEMT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set the modem control lines (we don&#39;t have any)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mn10300_serial_set_mctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">_port</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mn10300_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">unused</span><span class="p">))</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">_port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mn10300_serial_port</span><span class="p">,</span> <span class="n">uart</span><span class="p">);</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;%s,%x&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mctrl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * get the modem control line statuses</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">mn10300_serial_get_mctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mn10300_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">_port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mn10300_serial_port</span><span class="p">,</span> <span class="n">uart</span><span class="p">);</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_MN10300_CTS</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_status</span> <span class="o">&amp;</span> <span class="n">SC2STR_CTS</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">TIOCM_CAR</span> <span class="o">|</span> <span class="n">TIOCM_DSR</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">TIOCM_CAR</span> <span class="o">|</span> <span class="n">TIOCM_CTS</span> <span class="o">|</span> <span class="n">TIOCM_DSR</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stop transmitting characters</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mn10300_serial_stop_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mn10300_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">_port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mn10300_serial_port</span><span class="p">,</span> <span class="n">uart</span><span class="p">);</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* disable the virtual DMA */</span>
	<span class="n">mn10300_serial_dis_tx_intr</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * start transmitting characters</span>
<span class="cm"> * - jump-start transmission if it has stalled</span>
<span class="cm"> *   - enable the serial Tx interrupt (used by the virtual DMA controller)</span>
<span class="cm"> *   - force an interrupt to happen if necessary</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mn10300_serial_start_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mn10300_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">_port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mn10300_serial_port</span><span class="p">,</span> <span class="n">uart</span><span class="p">);</span>

	<span class="n">u16</span> <span class="n">x</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;%s{%lu}&quot;</span><span class="p">,</span>
	       <span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">CIRC_CNT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">head</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">tail</span><span class="p">,</span>
			<span class="n">UART_XMIT_SIZE</span><span class="p">));</span>

	<span class="cm">/* kick the virtual DMA controller */</span>
	<span class="n">arch_local_cli</span><span class="p">();</span>
	<span class="n">x</span> <span class="o">=</span> <span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tx_icr</span><span class="p">;</span>
	<span class="n">x</span> <span class="o">|=</span> <span class="n">GxICR_ENABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_status</span> <span class="o">&amp;</span> <span class="n">SC01STR_TBF</span><span class="p">)</span>
		<span class="n">x</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">GxICR_REQUEST</span> <span class="o">|</span> <span class="n">GxICR_DETECT</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">x</span> <span class="o">|=</span> <span class="n">GxICR_REQUEST</span> <span class="o">|</span> <span class="n">GxICR_DETECT</span><span class="p">;</span>

	<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;CTR=%04hx ICR=%02hx STR=%04x TMD=%02hx TBR=%04hx ICR=%04hx&quot;</span><span class="p">,</span>
	       <span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_control</span><span class="p">,</span> <span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_intr</span><span class="p">,</span> <span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_status</span><span class="p">,</span>
	       <span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_tmxmd</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">div_timer</span> <span class="o">==</span> <span class="n">MNSCx_DIV_TIMER_8BIT</span><span class="p">)</span> <span class="o">?</span>
	           <span class="o">*</span><span class="p">(</span><span class="k">volatile</span> <span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_tmxbr</span> <span class="o">:</span> <span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_tmxbr</span><span class="p">,</span>
	       <span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tx_icr</span><span class="p">);</span>

	<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tx_icr</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
	<span class="n">x</span> <span class="o">=</span> <span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tx_icr</span><span class="p">;</span>
	<span class="n">arch_local_sti</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * transmit a high-priority XON/XOFF character</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mn10300_serial_send_xchar</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">_port</span><span class="p">,</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mn10300_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">_port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mn10300_serial_port</span><span class="p">,</span> <span class="n">uart</span><span class="p">);</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;%s,%02x&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">gdbstub</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">tx_xchar</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="p">)</span>
			<span class="n">mn10300_serial_en_tx_intr</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stop receiving characters</span>
<span class="cm"> * - called whilst the port is being closed</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mn10300_serial_stop_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mn10300_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">_port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mn10300_serial_port</span><span class="p">,</span> <span class="n">uart</span><span class="p">);</span>

	<span class="n">u16</span> <span class="n">ctr</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">ctr</span> <span class="o">=</span> <span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_control</span><span class="p">;</span>
	<span class="n">ctr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SC01CTR_RXE</span><span class="p">;</span>
	<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_control</span> <span class="o">=</span> <span class="n">ctr</span><span class="p">;</span>

	<span class="n">mn10300_serial_dis_rx_intr</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * enable modem status interrupts</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mn10300_serial_enable_ms</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mn10300_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">_port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mn10300_serial_port</span><span class="p">,</span> <span class="n">uart</span><span class="p">);</span>

	<span class="n">u16</span> <span class="n">ctr</span><span class="p">,</span> <span class="n">cts</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_MN10300_CTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* want to interrupt when CTS goes low if CTS is now high and</span>
<span class="cm">		 * vice versa</span>
<span class="cm">		 */</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">tx_cts</span> <span class="o">=</span> <span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_status</span><span class="p">;</span>

		<span class="n">cts</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tx_cts</span> <span class="o">&amp;</span> <span class="n">SC2STR_CTS</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">SC2CTR_TWE</span> <span class="o">:</span> <span class="n">SC2CTR_TWE</span> <span class="o">|</span> <span class="n">SC2CTR_TWS</span><span class="p">;</span>

		<span class="n">ctr</span> <span class="o">=</span> <span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_control</span><span class="p">;</span>
		<span class="n">ctr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SC2CTR_TWS</span><span class="p">;</span>
		<span class="n">ctr</span> <span class="o">|=</span> <span class="n">cts</span><span class="p">;</span>
		<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_control</span> <span class="o">=</span> <span class="n">ctr</span><span class="p">;</span>

		<span class="n">mn10300_serial_en_tx_intr</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * transmit or cease transmitting a break signal</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mn10300_serial_break_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">_port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ctl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mn10300_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">_port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mn10300_serial_port</span><span class="p">,</span> <span class="n">uart</span><span class="p">);</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;%s,%d&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ctl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* tell the virtual DMA handler to assert BREAK */</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">tx_break</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mn10300_serial_en_tx_intr</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">tx_break</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SC01CTR_BKE</span><span class="p">;</span>
		<span class="n">mn10300_serial_en_tx_intr</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * grab the interrupts and enable the port for reception</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mn10300_serial_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mn10300_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">_port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mn10300_serial_port</span><span class="p">,</span> <span class="n">uart</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mn10300_serial_int</span> <span class="o">*</span><span class="n">pint</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;%s{%d}&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">gdbstub</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">gdbstub</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* allocate an Rx buffer for the virtual DMA handler */</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">MNSC_BUFFER_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_inp</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_outp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* finally, enable the device */</span>
	<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_intr</span> <span class="o">=</span> <span class="n">SC01ICR_TI</span><span class="p">;</span>
	<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_control</span> <span class="o">|=</span> <span class="n">SC01CTR_TXE</span> <span class="o">|</span> <span class="n">SC01CTR_RXE</span><span class="p">;</span>

	<span class="n">pint</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mn10300_serial_int_tbl</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_irq</span><span class="p">];</span>
	<span class="n">pint</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">pint</span><span class="o">-&gt;</span><span class="n">vdma</span> <span class="o">=</span> <span class="n">mn10300_serial_vdma_rx_handler</span><span class="p">;</span>
	<span class="n">pint</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mn10300_serial_int_tbl</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tx_irq</span><span class="p">];</span>
	<span class="n">pint</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">pint</span><span class="o">-&gt;</span><span class="n">vdma</span> <span class="o">=</span> <span class="n">mn10300_serial_vdma_tx_handler</span><span class="p">;</span>

	<span class="n">set_intr_level</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_irq</span><span class="p">,</span>
		<span class="n">NUM2GxICR_LEVEL</span><span class="p">(</span><span class="n">CONFIG_MN10300_SERIAL_IRQ_LEVEL</span><span class="p">));</span>
	<span class="n">set_intr_level</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tx_irq</span><span class="p">,</span>
		<span class="n">NUM2GxICR_LEVEL</span><span class="p">(</span><span class="n">CONFIG_MN10300_SERIAL_IRQ_LEVEL</span><span class="p">));</span>
	<span class="n">irq_set_chip</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tm_irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mn10300_serial_pic</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_irq</span><span class="p">,</span> <span class="n">mn10300_serial_interrupt</span><span class="p">,</span>
			<span class="n">IRQF_DISABLED</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_name</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tx_irq</span><span class="p">,</span> <span class="n">mn10300_serial_interrupt</span><span class="p">,</span>
			<span class="n">IRQF_DISABLED</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">tx_name</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tm_irq</span><span class="p">,</span> <span class="n">mn10300_serial_interrupt</span><span class="p">,</span>
			<span class="n">IRQF_DISABLED</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">tm_name</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error3</span><span class="p">;</span>
	<span class="n">mn10300_serial_mask_ack</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tm_irq</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error3:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tx_irq</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
<span class="nl">error2:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_irq</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_buffer</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * shutdown the port and release interrupts</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mn10300_serial_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">x</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mn10300_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">_port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mn10300_serial_port</span><span class="p">,</span> <span class="n">uart</span><span class="p">);</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* disable the serial port and its baud rate timer */</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">tx_break</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SC01CTR_TXE</span> <span class="o">|</span> <span class="n">SC01CTR_RXE</span> <span class="o">|</span> <span class="n">SC01CTR_BKE</span><span class="p">);</span>
	<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_tmxmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_buffer</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* disable all intrs */</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tm_irq</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_irq</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tx_irq</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="n">arch_local_cli</span><span class="p">();</span>
	<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_icr</span> <span class="o">=</span> <span class="n">NUM2GxICR_LEVEL</span><span class="p">(</span><span class="n">CONFIG_MN10300_SERIAL_IRQ_LEVEL</span><span class="p">);</span>
	<span class="n">x</span> <span class="o">=</span> <span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_icr</span><span class="p">;</span>
	<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tx_icr</span> <span class="o">=</span> <span class="n">NUM2GxICR_LEVEL</span><span class="p">(</span><span class="n">CONFIG_MN10300_SERIAL_IRQ_LEVEL</span><span class="p">);</span>
	<span class="n">x</span> <span class="o">=</span> <span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tx_icr</span><span class="p">;</span>
	<span class="n">arch_local_sti</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * this routine is called to set the UART divisor registers to match the</span>
<span class="cm"> * specified baud rate for a serial port.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mn10300_serial_change_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">mn10300_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ioclk</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">ioclk</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">cflag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">baud</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">xdiv</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmxbr</span><span class="p">,</span> <span class="n">scxctr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmxmd</span><span class="p">,</span> <span class="n">battempt</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">div_timer</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">div_timer</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;%s{%lu}&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioclk</span><span class="p">);</span>

	<span class="cm">/* byte size and parity */</span>
	<span class="n">cflag</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CS7</span>: <span class="n">scxctr</span> <span class="o">=</span> <span class="n">SC01CTR_CLN_7BIT</span><span class="p">;</span> <span class="n">bits</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS8</span>: <span class="n">scxctr</span> <span class="o">=</span> <span class="n">SC01CTR_CLN_8BIT</span><span class="p">;</span> <span class="n">bits</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>  <span class="n">scxctr</span> <span class="o">=</span> <span class="n">SC01CTR_CLN_8BIT</span><span class="p">;</span> <span class="n">bits</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSTOPB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scxctr</span> <span class="o">|=</span> <span class="n">SC01CTR_STB_2BIT</span><span class="p">;</span>
		<span class="n">bits</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARENB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bits</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span><span class="p">)</span>
			<span class="n">scxctr</span> <span class="o">|=</span> <span class="n">SC01CTR_PB_ODD</span><span class="p">;</span>
<span class="cp">#ifdef CMSPAR</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CMSPAR</span><span class="p">)</span>
			<span class="n">scxctr</span> <span class="o">|=</span> <span class="n">SC01CTR_PB_FIXED0</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">else</span>
			<span class="n">scxctr</span> <span class="o">|=</span> <span class="n">SC01CTR_PB_EVEN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Determine divisor based on baud rate */</span>
	<span class="n">battempt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">line</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_MN10300_TTYSM0</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* ttySM0 */</span>
<span class="cp">#if   defined(CONFIG_MN10300_TTYSM0_TIMER8)</span>
		<span class="n">scxctr</span> <span class="o">|=</span> <span class="n">SC0CTR_CK_TM8UFLOW_8</span><span class="p">;</span>
<span class="cp">#elif defined(CONFIG_MN10300_TTYSM0_TIMER0)</span>
		<span class="n">scxctr</span> <span class="o">|=</span> <span class="n">SC0CTR_CK_TM0UFLOW_8</span><span class="p">;</span>
<span class="cp">#elif defined(CONFIG_MN10300_TTYSM0_TIMER2)</span>
		<span class="n">scxctr</span> <span class="o">|=</span> <span class="n">SC0CTR_CK_TM2UFLOW_8</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="cp">#error &quot;Unknown config for ttySM0&quot;</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MN10300_TTYSM0 */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_MN10300_TTYSM1</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* ttySM1 */</span>
<span class="cp">#if defined(CONFIG_AM33_2) || defined(CONFIG_AM33_3)</span>
<span class="cp">#if   defined(CONFIG_MN10300_TTYSM1_TIMER9)</span>
		<span class="n">scxctr</span> <span class="o">|=</span> <span class="n">SC1CTR_CK_TM9UFLOW_8</span><span class="p">;</span>
<span class="cp">#elif defined(CONFIG_MN10300_TTYSM1_TIMER3)</span>
		<span class="n">scxctr</span> <span class="o">|=</span> <span class="n">SC1CTR_CK_TM3UFLOW_8</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="cp">#error &quot;Unknown config for ttySM1&quot;</span>
<span class="cp">#endif</span>
<span class="cp">#else </span><span class="cm">/* CONFIG_AM33_2 || CONFIG_AM33_3 */</span><span class="cp"></span>
<span class="cp">#if defined(CONFIG_MN10300_TTYSM1_TIMER12)</span>
		<span class="n">scxctr</span> <span class="o">|=</span> <span class="n">SC1CTR_CK_TM12UFLOW_8</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="cp">#error &quot;Unknown config for ttySM1&quot;</span>
<span class="cp">#endif</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_AM33_2 || CONFIG_AM33_3 */</span><span class="cp"></span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MN10300_TTYSM1 */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_MN10300_TTYSM2</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* ttySM2 */</span>
<span class="cp">#if defined(CONFIG_AM33_2)</span>
<span class="cp">#if   defined(CONFIG_MN10300_TTYSM2_TIMER10)</span>
		<span class="n">scxctr</span> <span class="o">|=</span> <span class="n">SC2CTR_CK_TM10UFLOW</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="cp">#error &quot;Unknown config for ttySM2&quot;</span>
<span class="cp">#endif</span>
<span class="cp">#else </span><span class="cm">/* CONFIG_AM33_2 */</span><span class="cp"></span>
<span class="cp">#if   defined(CONFIG_MN10300_TTYSM2_TIMER9)</span>
		<span class="n">scxctr</span> <span class="o">|=</span> <span class="n">SC2CTR_CK_TM9UFLOW_8</span><span class="p">;</span>
<span class="cp">#elif defined(CONFIG_MN10300_TTYSM2_TIMER1)</span>
		<span class="n">scxctr</span> <span class="o">|=</span> <span class="n">SC2CTR_CK_TM1UFLOW_8</span><span class="p">;</span>
<span class="cp">#elif defined(CONFIG_MN10300_TTYSM2_TIMER3)</span>
		<span class="n">scxctr</span> <span class="o">|=</span> <span class="n">SC2CTR_CK_TM3UFLOW_8</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="cp">#error &quot;Unknown config for ttySM2&quot;</span>
<span class="cp">#endif</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_AM33_2 */</span><span class="cp"></span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MN10300_TTYSM2 */</span><span class="cp"></span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">try_alternative:</span>
	<span class="n">baud</span> <span class="o">=</span> <span class="n">uart_get_baud_rate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="n">port</span><span class="o">-&gt;</span><span class="n">ioclk</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;ALT %d [baud %d]&quot;</span><span class="p">,</span> <span class="n">battempt</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">baud</span><span class="p">)</span>
		<span class="n">baud</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>	<span class="cm">/* B0 transition handled in rs_set_termios */</span>
	<span class="n">xdiv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">==</span> <span class="mi">134</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">baud</span> <span class="o">=</span> <span class="mi">269</span><span class="p">;</span>	<span class="cm">/* 134 is really 134.5 */</span>
		<span class="n">xdiv</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">==</span> <span class="mi">38400</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UPF_SPD_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">UPF_SPD_CUST</span>
	    <span class="p">)</span> <span class="p">{</span>
		<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;CUSTOM %u&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">custom_divisor</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">div_timer</span> <span class="o">==</span> <span class="n">MNSCx_DIV_TIMER_16BIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">custom_divisor</span> <span class="o">&lt;=</span> <span class="mi">65535</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tmxmd</span> <span class="o">=</span> <span class="n">TM8MD_SRC_IOCLK</span><span class="p">;</span>
				<span class="n">tmxbr</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">custom_divisor</span><span class="p">;</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">uartclk</span> <span class="o">=</span> <span class="n">ioclk</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">timer_okay</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">custom_divisor</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">&lt;=</span> <span class="mi">65535</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tmxmd</span> <span class="o">=</span> <span class="n">TM8MD_SRC_IOCLK_8</span><span class="p">;</span>
				<span class="n">tmxbr</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">custom_divisor</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">custom_divisor</span> <span class="o">=</span> <span class="n">tmxbr</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">uartclk</span> <span class="o">=</span> <span class="n">ioclk</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">timer_okay</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">custom_divisor</span> <span class="o">/</span> <span class="mi">32</span> <span class="o">&lt;=</span> <span class="mi">65535</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tmxmd</span> <span class="o">=</span> <span class="n">TM8MD_SRC_IOCLK_32</span><span class="p">;</span>
				<span class="n">tmxbr</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">custom_divisor</span> <span class="o">/</span> <span class="mi">32</span><span class="p">;</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">custom_divisor</span> <span class="o">=</span> <span class="n">tmxbr</span> <span class="o">*</span> <span class="mi">32</span><span class="p">;</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">uartclk</span> <span class="o">=</span> <span class="n">ioclk</span> <span class="o">/</span> <span class="mi">32</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">timer_okay</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">div_timer</span> <span class="o">==</span> <span class="n">MNSCx_DIV_TIMER_8BIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">custom_divisor</span> <span class="o">&lt;=</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tmxmd</span> <span class="o">=</span> <span class="n">TM2MD_SRC_IOCLK</span><span class="p">;</span>
				<span class="n">tmxbr</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">custom_divisor</span><span class="p">;</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">uartclk</span> <span class="o">=</span> <span class="n">ioclk</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">timer_okay</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">custom_divisor</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">&lt;=</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tmxmd</span> <span class="o">=</span> <span class="n">TM2MD_SRC_IOCLK_8</span><span class="p">;</span>
				<span class="n">tmxbr</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">custom_divisor</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">custom_divisor</span> <span class="o">=</span> <span class="n">tmxbr</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">uartclk</span> <span class="o">=</span> <span class="n">ioclk</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">timer_okay</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">custom_divisor</span> <span class="o">/</span> <span class="mi">32</span> <span class="o">&lt;=</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tmxmd</span> <span class="o">=</span> <span class="n">TM2MD_SRC_IOCLK_32</span><span class="p">;</span>
				<span class="n">tmxbr</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">custom_divisor</span> <span class="o">/</span> <span class="mi">32</span><span class="p">;</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">custom_divisor</span> <span class="o">=</span> <span class="n">tmxbr</span> <span class="o">*</span> <span class="mi">32</span><span class="p">;</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">uartclk</span> <span class="o">=</span> <span class="n">ioclk</span> <span class="o">/</span> <span class="mi">32</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">timer_okay</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">div_timer</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MNSCx_DIV_TIMER_16BIT</span>:
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">uartclk</span> <span class="o">=</span> <span class="n">ioclk</span><span class="p">;</span>
		<span class="n">tmxmd</span> <span class="o">=</span> <span class="n">TM8MD_SRC_IOCLK</span><span class="p">;</span>
		<span class="n">tmxbr</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioclk</span> <span class="o">/</span> <span class="p">(</span><span class="n">baud</span> <span class="o">*</span> <span class="n">xdiv</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">tmp</span> <span class="o">&lt;=</span> <span class="mi">65535</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">timer_okay</span><span class="p">;</span>

		<span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">uartclk</span> <span class="o">=</span> <span class="n">ioclk</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">tmxmd</span> <span class="o">=</span> <span class="n">TM8MD_SRC_IOCLK_8</span><span class="p">;</span>
		<span class="n">tmxbr</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioclk</span> <span class="o">/</span> <span class="p">(</span><span class="n">baud</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">xdiv</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">tmp</span> <span class="o">&lt;=</span> <span class="mi">65535</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">timer_okay</span><span class="p">;</span>

		<span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">uartclk</span> <span class="o">=</span> <span class="n">ioclk</span> <span class="o">/</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">tmxmd</span> <span class="o">=</span> <span class="n">TM8MD_SRC_IOCLK_32</span><span class="p">;</span>
		<span class="n">tmxbr</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioclk</span> <span class="o">/</span> <span class="p">(</span><span class="n">baud</span> <span class="o">*</span> <span class="mi">32</span> <span class="o">*</span> <span class="n">xdiv</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">tmp</span> <span class="o">&lt;=</span> <span class="mi">65535</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">timer_okay</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MNSCx_DIV_TIMER_8BIT</span>:
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">uartclk</span> <span class="o">=</span> <span class="n">ioclk</span><span class="p">;</span>
		<span class="n">tmxmd</span> <span class="o">=</span> <span class="n">TM2MD_SRC_IOCLK</span><span class="p">;</span>
		<span class="n">tmxbr</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioclk</span> <span class="o">/</span> <span class="p">(</span><span class="n">baud</span> <span class="o">*</span> <span class="n">xdiv</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">tmp</span> <span class="o">&lt;=</span> <span class="mi">255</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">timer_okay</span><span class="p">;</span>

		<span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">uartclk</span> <span class="o">=</span> <span class="n">ioclk</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">tmxmd</span> <span class="o">=</span> <span class="n">TM2MD_SRC_IOCLK_8</span><span class="p">;</span>
		<span class="n">tmxbr</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioclk</span> <span class="o">/</span> <span class="p">(</span><span class="n">baud</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">xdiv</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">tmp</span> <span class="o">&lt;=</span> <span class="mi">255</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">timer_okay</span><span class="p">;</span>

		<span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">uartclk</span> <span class="o">=</span> <span class="n">ioclk</span> <span class="o">/</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">tmxmd</span> <span class="o">=</span> <span class="n">TM2MD_SRC_IOCLK_32</span><span class="p">;</span>
		<span class="n">tmxbr</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioclk</span> <span class="o">/</span> <span class="p">(</span><span class="n">baud</span> <span class="o">*</span> <span class="mi">32</span> <span class="o">*</span> <span class="n">xdiv</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">tmp</span> <span class="o">&lt;=</span> <span class="mi">255</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">timer_okay</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* refuse to change to a baud rate we can&#39;t support */</span>
	<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;CAN&#39;T SUPPORT&quot;</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">battempt</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">new</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CBAUD</span><span class="p">;</span>
			<span class="n">new</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">|=</span> <span class="p">(</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">);</span>
			<span class="n">battempt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">try_alternative</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">case</span> <span class="mi">1</span>:
		<span class="cm">/* as a last resort, if the quotient is zero, default to 9600</span>
<span class="cm">		 * bps */</span>
		<span class="n">new</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CBAUD</span><span class="p">;</span>
		<span class="n">new</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">|=</span> <span class="n">B9600</span><span class="p">;</span>
		<span class="n">battempt</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">try_alternative</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* hmmm... can&#39;t seem to support 9600 either</span>
<span class="cm">		 * - we could try iterating through the speeds we know about to</span>
<span class="cm">		 *   find the lowest</span>
<span class="cm">		 */</span>
		<span class="n">new</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CBAUD</span><span class="p">;</span>
		<span class="n">new</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">|=</span> <span class="n">B0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">div_timer</span> <span class="o">==</span> <span class="n">MNSCx_DIV_TIMER_16BIT</span><span class="p">)</span>
			<span class="n">tmxmd</span> <span class="o">=</span> <span class="n">TM8MD_SRC_IOCLK_32</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">div_timer</span> <span class="o">==</span> <span class="n">MNSCx_DIV_TIMER_8BIT</span><span class="p">)</span>
			<span class="n">tmxmd</span> <span class="o">=</span> <span class="n">TM2MD_SRC_IOCLK_32</span><span class="p">;</span>
		<span class="n">tmxbr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">uartclk</span> <span class="o">=</span> <span class="n">ioclk</span> <span class="o">/</span> <span class="mi">32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">timer_okay:</span>

	<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;UARTCLK: %u / %hu&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">uartclk</span><span class="p">,</span> <span class="n">tmxbr</span><span class="p">);</span>

	<span class="cm">/* make the changes */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">uart_update_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>

	<span class="cm">/* set the timer to produce the required baud rate */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">div_timer</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MNSCx_DIV_TIMER_16BIT</span>:
		<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_tmxmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_tmxbr</span> <span class="o">=</span> <span class="n">tmxbr</span><span class="p">;</span>
		<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_tmxmd</span> <span class="o">=</span> <span class="n">TM8MD_INIT_COUNTER</span><span class="p">;</span>
		<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_tmxmd</span> <span class="o">=</span> <span class="n">tmxmd</span> <span class="o">|</span> <span class="n">TM8MD_COUNT_ENABLE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MNSCx_DIV_TIMER_8BIT</span>:
		<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_tmxmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="k">volatile</span> <span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">_tmxbr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">tmxbr</span><span class="p">;</span>
		<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_tmxmd</span> <span class="o">=</span> <span class="n">TM2MD_INIT_COUNTER</span><span class="p">;</span>
		<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_tmxmd</span> <span class="o">=</span> <span class="n">tmxmd</span> <span class="o">|</span> <span class="n">TM2MD_COUNT_ENABLE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* CTS flow control flag and modem status interrupts */</span>
	<span class="n">scxctr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SC2CTR_TWE</span> <span class="o">|</span> <span class="n">SC2CTR_TWS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_MN10300_CTS</span> <span class="o">&amp;&amp;</span> <span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* want to interrupt when CTS goes low if CTS is now</span>
<span class="cm">		 * high and vice versa</span>
<span class="cm">		 */</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">tx_cts</span> <span class="o">=</span> <span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_status</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tx_cts</span> <span class="o">&amp;</span> <span class="n">SC2STR_CTS</span><span class="p">)</span>
			<span class="n">scxctr</span> <span class="o">|=</span> <span class="n">SC2CTR_TWE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">scxctr</span> <span class="o">|=</span> <span class="n">SC2CTR_TWE</span> <span class="o">|</span> <span class="n">SC2CTR_TWS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set up parity check flag */</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">read_status_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TTY_NORMAL</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TTY_OVERRUN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">INPCK</span><span class="p">)</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">read_status_mask</span> <span class="o">|=</span>
			<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TTY_PARITY</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TTY_FRAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BRKINT</span> <span class="o">|</span> <span class="n">PARMRK</span><span class="p">))</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">read_status_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TTY_BREAK</span><span class="p">);</span>

	<span class="cm">/* characters to ignore */</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">ignore_status_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">IGNPAR</span><span class="p">)</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">ignore_status_mask</span> <span class="o">|=</span>
			<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TTY_PARITY</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TTY_FRAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">IGNBRK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TTY_BREAK</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * If we&#39;re ignoring parity and break indicators,</span>
<span class="cm">		 * ignore overruns to (for real raw support).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">IGNPAR</span><span class="p">)</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TTY_OVERRUN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Ignore all characters if CREAD is not set */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CREAD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TTY_NORMAL</span><span class="p">);</span>

	<span class="n">scxctr</span> <span class="o">|=</span> <span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_control</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SC01CTR_TXE</span> <span class="o">|</span> <span class="n">SC01CTR_RXE</span> <span class="o">|</span> <span class="n">SC01CTR_BKE</span><span class="p">);</span>
	<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_control</span> <span class="o">=</span> <span class="n">scxctr</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set the terminal I/O parameters</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mn10300_serial_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">_port</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mn10300_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">_port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mn10300_serial_port</span><span class="p">,</span> <span class="n">uart</span><span class="p">);</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;%s,%p,%p&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">old</span><span class="p">);</span>

	<span class="n">mn10300_serial_change_speed</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">old</span><span class="p">);</span>

	<span class="cm">/* handle turning off CRTSCTS */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">ctr</span> <span class="o">=</span> <span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_control</span><span class="p">;</span>
		<span class="n">ctr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SC2CTR_TWE</span><span class="p">;</span>
		<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_control</span> <span class="o">=</span> <span class="n">ctr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* change Transfer bit-order (LSB/MSB) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CODMSB</span><span class="p">)</span>
		<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_control</span> <span class="o">|=</span> <span class="n">SC01CTR_OD_MSBFIRST</span><span class="p">;</span> <span class="cm">/* MSB MODE */</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SC01CTR_OD_MSBFIRST</span><span class="p">;</span> <span class="cm">/* LSB MODE */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * return description of port type</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">mn10300_serial_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mn10300_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">_port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mn10300_serial_port</span><span class="p">,</span> <span class="n">uart</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_MN10300_CTS</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot;MN10300 SIF_CTS&quot;</span><span class="p">;</span>

	<span class="k">return</span> <span class="s">&quot;MN10300 SIF&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * release I/O and memory regions in use by port</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mn10300_serial_release_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mn10300_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">_port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mn10300_serial_port</span><span class="p">,</span> <span class="n">uart</span><span class="p">);</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">release_mem_region</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">_iobase</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * request I/O and memory regions for port</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mn10300_serial_request_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mn10300_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">_port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mn10300_serial_port</span><span class="p">,</span> <span class="n">uart</span><span class="p">);</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">request_mem_region</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">_iobase</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * configure the type and reserve the ports</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mn10300_serial_config_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">_port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mn10300_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">_port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mn10300_serial_port</span><span class="p">,</span> <span class="n">uart</span><span class="p">);</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PORT_MN10300</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MNSCx_OPT_CTS</span><span class="p">)</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PORT_MN10300_CTS</span><span class="p">;</span>

	<span class="n">mn10300_serial_request_port</span><span class="p">(</span><span class="n">_port</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * verify serial parameters are suitable for this port type</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mn10300_serial_verify_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">_port</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">serial_struct</span> <span class="o">*</span><span class="n">ss</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mn10300_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">_port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mn10300_serial_port</span><span class="p">,</span> <span class="n">uart</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">mapbase</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">mapbase</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* these things may not be changed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">irq</span>		<span class="o">!=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">irq</span>	<span class="o">||</span>
	    <span class="n">ss</span><span class="o">-&gt;</span><span class="n">port</span>		<span class="o">!=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">iobase</span>	<span class="o">||</span>
	    <span class="n">ss</span><span class="o">-&gt;</span><span class="n">io_type</span>		<span class="o">!=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">iotype</span>	<span class="o">||</span>
	    <span class="n">ss</span><span class="o">-&gt;</span><span class="n">iomem_base</span>	<span class="o">!=</span> <span class="n">mapbase</span> <span class="o">||</span>
	    <span class="n">ss</span><span class="o">-&gt;</span><span class="n">iomem_reg_shift</span>	<span class="o">!=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">regshift</span>	<span class="o">||</span>
	    <span class="n">ss</span><span class="o">-&gt;</span><span class="n">hub6</span>		<span class="o">!=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">hub6</span>	<span class="o">||</span>
	    <span class="n">ss</span><span class="o">-&gt;</span><span class="n">xmit_fifo_size</span>	<span class="o">!=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">fifosize</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* type may be changed on a port that supports CTS */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MNSCx_OPT_CTS</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PORT_MN10300</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ss</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PORT_MN10300_CTS</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * initialise the MN10300 on-chip UARTs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">mn10300_serial_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mn10300_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s version %s (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">serial_name</span><span class="p">,</span> <span class="n">serial_version</span><span class="p">,</span> <span class="n">serial_revdate</span><span class="p">);</span>

<span class="cp">#if defined(CONFIG_MN10300_TTYSM2) &amp;&amp; defined(CONFIG_AM33_2)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">SC2TIM</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* make the baud base of timer 2 IOCLK/8 */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">SC2TIM</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">set_intr_stub</span><span class="p">(</span><span class="n">NUM2EXCEP_IRQ_LEVEL</span><span class="p">(</span><span class="n">CONFIG_MN10300_SERIAL_IRQ_LEVEL</span><span class="p">),</span>
		<span class="n">mn10300_serial_vdma_interrupt</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uart_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mn10300_serial_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_PORTS</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">port</span> <span class="o">=</span> <span class="n">mn10300_serial_ports</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span> <span class="o">||</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">gdbstub</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">clock_src</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">MNSCx_CLOCK_SRC_IOCLK</span>:
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">ioclk</span> <span class="o">=</span> <span class="n">MN10300_IOCLK</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

<span class="cp">#ifdef MN10300_IOBCLK</span>
			<span class="k">case</span> <span class="n">MNSCx_CLOCK_SRC_IOBCLK</span>:
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">ioclk</span> <span class="o">=</span> <span class="n">MN10300_IOBCLK</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="nl">default:</span>
				<span class="n">BUG</span><span class="p">();</span>
			<span class="p">}</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">uart_add_one_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mn10300_serial_driver</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">_debug</span><span class="p">(</span><span class="s">&quot;ERROR %d&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">ret</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">uart_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mn10300_serial_driver</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__initcall</span><span class="p">(</span><span class="n">mn10300_serial_init</span><span class="p">);</span>


<span class="cp">#ifdef CONFIG_MN10300_TTYSM_CONSOLE</span>

<span class="cm">/*</span>
<span class="cm"> * print a string to the serial port without disturbing the real user of the</span>
<span class="cm"> * port too much</span>
<span class="cm"> * - the console must be locked by the caller</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mn10300_serial_console_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">co</span><span class="p">,</span>
					   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mn10300_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">scxctr</span><span class="p">,</span> <span class="n">txicr</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmxmd</span><span class="p">;</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">mn10300_serial_ports</span><span class="p">[</span><span class="n">co</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>

	<span class="cm">/* firstly hijack the serial port from the &quot;virtual DMA&quot; controller */</span>
	<span class="n">arch_local_cli</span><span class="p">();</span>
	<span class="n">txicr</span> <span class="o">=</span> <span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tx_icr</span><span class="p">;</span>
	<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tx_icr</span> <span class="o">=</span> <span class="n">NUM2GxICR_LEVEL</span><span class="p">(</span><span class="n">CONFIG_MN10300_SERIAL_IRQ_LEVEL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tx_icr</span><span class="p">;</span>
	<span class="n">arch_local_sti</span><span class="p">();</span>

	<span class="cm">/* the transmitter may be disabled */</span>
	<span class="n">scxctr</span> <span class="o">=</span> <span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_control</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">scxctr</span> <span class="o">&amp;</span> <span class="n">SC01CTR_TXE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* restart the UART clock */</span>
		<span class="n">tmxmd</span> <span class="o">=</span> <span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_tmxmd</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">div_timer</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MNSCx_DIV_TIMER_16BIT</span>:
			<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_tmxmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_tmxmd</span> <span class="o">=</span> <span class="n">TM8MD_INIT_COUNTER</span><span class="p">;</span>
			<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_tmxmd</span> <span class="o">=</span> <span class="n">tmxmd</span> <span class="o">|</span> <span class="n">TM8MD_COUNT_ENABLE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MNSCx_DIV_TIMER_8BIT</span>:
			<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_tmxmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_tmxmd</span> <span class="o">=</span> <span class="n">TM2MD_INIT_COUNTER</span><span class="p">;</span>
			<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_tmxmd</span> <span class="o">=</span> <span class="n">tmxmd</span> <span class="o">|</span> <span class="n">TM2MD_COUNT_ENABLE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* enable the transmitter */</span>
		<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_control</span> <span class="o">=</span> <span class="p">(</span><span class="n">scxctr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SC01CTR_BKE</span><span class="p">)</span> <span class="o">|</span> <span class="n">SC01CTR_TXE</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scxctr</span> <span class="o">&amp;</span> <span class="n">SC01CTR_BKE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* stop transmitting BREAK */</span>
		<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_control</span> <span class="o">=</span> <span class="p">(</span><span class="n">scxctr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SC01CTR_BKE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* send the chars into the serial port (with LF -&gt; LFCR conversion) */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">ch</span> <span class="o">=</span> <span class="o">*</span><span class="n">s</span><span class="o">++</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_status</span> <span class="o">&amp;</span> <span class="n">SC01STR_TBF</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">_txb</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="mh">0x0a</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_status</span> <span class="o">&amp;</span> <span class="n">SC01STR_TBF</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">_txb</span> <span class="o">=</span> <span class="mh">0xd</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* can&#39;t let the transmitter be turned off if it&#39;s actually</span>
<span class="cm">	 * transmitting */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SC01STR_TXF</span> <span class="o">|</span> <span class="n">SC01STR_TBF</span><span class="p">))</span>
		<span class="k">continue</span><span class="p">;</span>

	<span class="cm">/* disable the transmitter if we re-enabled it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">scxctr</span> <span class="o">&amp;</span> <span class="n">SC01CTR_TXE</span><span class="p">))</span>
		<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_control</span> <span class="o">=</span> <span class="n">scxctr</span><span class="p">;</span>

	<span class="n">arch_local_cli</span><span class="p">();</span>
	<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tx_icr</span> <span class="o">=</span> <span class="n">txicr</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tx_icr</span><span class="p">;</span>
	<span class="n">arch_local_sti</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set up a serial port as a console</span>
<span class="cm"> * - construct a cflag setting for the first rs_open()</span>
<span class="cm"> * - initialize the serial port</span>
<span class="cm"> * - return non-zero if we didn&#39;t find a serial port.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">mn10300_serial_console_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">co</span><span class="p">,</span>
						 <span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mn10300_serial_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">parity</span> <span class="o">=</span> <span class="sc">&#39;n&#39;</span><span class="p">,</span> <span class="n">baud</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">,</span> <span class="n">bits</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">flow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_PORTS</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port</span> <span class="o">=</span> <span class="n">mn10300_serial_ports</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">gdbstub</span> <span class="o">&amp;&amp;</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">.</span><span class="n">line</span> <span class="o">==</span> <span class="n">co</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">found_device</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

<span class="nl">found_device:</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">clock_src</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MNSCx_CLOCK_SRC_IOCLK</span>:
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">ioclk</span> <span class="o">=</span> <span class="n">MN10300_IOCLK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cp">#ifdef MN10300_IOBCLK</span>
	<span class="k">case</span> <span class="n">MNSCx_CLOCK_SRC_IOBCLK</span>:
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">ioclk</span> <span class="o">=</span> <span class="n">MN10300_IOBCLK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="p">)</span>
		<span class="n">uart_parse_options</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">baud</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parity</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bits</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flow</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">uart_set_options</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">uart</span><span class="p">,</span> <span class="n">co</span><span class="p">,</span> <span class="n">baud</span><span class="p">,</span> <span class="n">parity</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">flow</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * register console</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">mn10300_serial_console_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">register_console</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mn10300_serial_console</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">console_initcall</span><span class="p">(</span><span class="n">mn10300_serial_console_init</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_CONSOLE_POLL</span>
<span class="cm">/*</span>
<span class="cm"> * Polled character reception for the kernel debugger</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mn10300_serial_poll_get_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mn10300_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">_port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mn10300_serial_port</span><span class="p">,</span> <span class="n">uart</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">ix</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">st</span><span class="p">,</span> <span class="n">ch</span><span class="p">;</span>

	<span class="n">_enter</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* pull chars out of the hat */</span>
		<span class="n">ix</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_outp</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ix</span> <span class="o">==</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_inp</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">NO_POLL_CHAR</span><span class="p">;</span>

		<span class="n">ch</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_buffer</span><span class="p">[</span><span class="n">ix</span><span class="o">++</span><span class="p">];</span>
		<span class="n">st</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_buffer</span><span class="p">[</span><span class="n">ix</span><span class="o">++</span><span class="p">];</span>
		<span class="n">smp_rmb</span><span class="p">();</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">rx_outp</span> <span class="o">=</span> <span class="n">ix</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MNSC_BUFFER_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">st</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SC01STR_FEF</span> <span class="o">|</span> <span class="n">SC01STR_PEF</span> <span class="o">|</span> <span class="n">SC01STR_OEF</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">ch</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Polled character transmission for the kernel debugger</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mn10300_serial_poll_put_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">_port</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mn10300_serial_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">_port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mn10300_serial_port</span><span class="p">,</span> <span class="n">uart</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">intr</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* wait for the transmitter to finish anything it might be doing (and</span>
<span class="cm">	 * this includes the virtual DMA handler, so it might take a while) */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SC01STR_TBF</span> <span class="o">|</span> <span class="n">SC01STR_TXF</span><span class="p">))</span>
		<span class="k">continue</span><span class="p">;</span>

	<span class="cm">/* disable the Tx ready interrupt */</span>
	<span class="n">intr</span> <span class="o">=</span> <span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_intr</span><span class="p">;</span>
	<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_intr</span> <span class="o">=</span> <span class="n">intr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SC01ICR_TI</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_intr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="mh">0x0a</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">_txb</span> <span class="o">=</span> <span class="mh">0x0d</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_status</span> <span class="o">&amp;</span> <span class="n">SC01STR_TBF</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">_txb</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_status</span> <span class="o">&amp;</span> <span class="n">SC01STR_TBF</span><span class="p">)</span>
		<span class="k">continue</span><span class="p">;</span>

	<span class="cm">/* restore the Tx interrupt flag */</span>
	<span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_intr</span> <span class="o">=</span> <span class="n">intr</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">_intr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_CONSOLE_POLL */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
