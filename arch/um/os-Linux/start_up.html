<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › um › os-Linux › start_up.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>start_up.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2000 - 2007 Jeff Dike (jdike@{addtoit,linux.intel}.com)</span>
<span class="cm"> * Licensed under the GPL</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;stdarg.h&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;errno.h&gt;</span>
<span class="cp">#include &lt;fcntl.h&gt;</span>
<span class="cp">#include &lt;sched.h&gt;</span>
<span class="cp">#include &lt;signal.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>
<span class="cp">#include &lt;sys/mman.h&gt;</span>
<span class="cp">#include &lt;sys/stat.h&gt;</span>
<span class="cp">#include &lt;sys/wait.h&gt;</span>
<span class="cp">#include &lt;asm/unistd.h&gt;</span>
<span class="cp">#include &quot;init.h&quot;</span>
<span class="cp">#include &quot;os.h&quot;</span>
<span class="cp">#include &quot;mem_user.h&quot;</span>
<span class="cp">#include &quot;ptrace_user.h&quot;</span>
<span class="cp">#include &quot;registers.h&quot;</span>
<span class="cp">#include &quot;skas.h&quot;</span>
<span class="cp">#include &quot;skas_ptrace.h&quot;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ptrace_child</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="cm">/* Calling os_getpid because some libcs cached getpid incorrectly */</span>
	<span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">os_getpid</span><span class="p">(),</span> <span class="n">ppid</span> <span class="o">=</span> <span class="n">getppid</span><span class="p">();</span>
	<span class="kt">int</span> <span class="n">sc_result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">change_sig</span><span class="p">(</span><span class="n">SIGWINCH</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">ptrace</span><span class="p">(</span><span class="n">PTRACE_TRACEME</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">perror</span><span class="p">(</span><span class="s">&quot;ptrace&quot;</span><span class="p">);</span>
		<span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">SIGKILL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">SIGSTOP</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * This syscall will be intercepted by the parent. Don&#39;t call more than</span>
<span class="cm">	 * once, please.</span>
<span class="cm">	 */</span>
	<span class="n">sc_result</span> <span class="o">=</span> <span class="n">os_getpid</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc_result</span> <span class="o">==</span> <span class="n">pid</span><span class="p">)</span>
		<span class="cm">/* Nothing modified by the parent, we are running normally. */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sc_result</span> <span class="o">==</span> <span class="n">ppid</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * Expected in check_ptrace and check_sysemu when they succeed</span>
<span class="cm">		 * in modifying the stack frame</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="cm">/* Serious trouble! This could be caused by a bug in host 2.6</span>
<span class="cm">		 * SKAS3/2.6 patch before release -V6, together with a bug in</span>
<span class="cm">		 * the UML code itself.</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">exit</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fatal_perror</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">perror</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
	<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fatal</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">list</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">vfprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>

	<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">non_fatal</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">list</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">vfprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">start_ptraced_child</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pid</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ptrace_child</span><span class="p">();</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">fatal_perror</span><span class="p">(</span><span class="s">&quot;start_ptraced_child : fork failed&quot;</span><span class="p">);</span>

	<span class="n">CATCH_EINTR</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">waitpid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="n">WUNTRACED</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">fatal_perror</span><span class="p">(</span><span class="s">&quot;check_ptrace : waitpid failed&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">WIFSTOPPED</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">WSTOPSIG</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SIGSTOP</span><span class="p">))</span>
		<span class="n">fatal</span><span class="p">(</span><span class="s">&quot;check_ptrace : expected SIGSTOP, got status = %d&quot;</span><span class="p">,</span>
		      <span class="n">status</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pid</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* When testing for SYSEMU support, if it is one of the broken versions, we</span>
<span class="cm"> * must just avoid using sysemu, not panic, but only if SYSEMU features are</span>
<span class="cm"> * broken.</span>
<span class="cm"> * So only for SYSEMU features we test mustpanic, while normal host features</span>
<span class="cm"> * must work anyway!</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">stop_ptraced_child</span><span class="p">(</span><span class="kt">int</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">exitcode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mustexit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ptrace</span><span class="p">(</span><span class="n">PTRACE_CONT</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">perror</span><span class="p">(</span><span class="s">&quot;stop_ptraced_child : ptrace failed&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">CATCH_EINTR</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">waitpid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">WIFEXITED</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">WEXITSTATUS</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">!=</span> <span class="n">exitcode</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">exit_with</span> <span class="o">=</span> <span class="n">WEXITSTATUS</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">exit_with</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">non_fatal</span><span class="p">(</span><span class="s">&quot;check_ptrace : child exited with status 2. &quot;</span>
				  <span class="s">&quot;</span><span class="se">\n</span><span class="s">Disabling SYSEMU support.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">non_fatal</span><span class="p">(</span><span class="s">&quot;check_ptrace : child exited with exitcode %d, while &quot;</span>
			  <span class="s">&quot;expecting %d; status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">exit_with</span><span class="p">,</span>
			  <span class="n">exitcode</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mustexit</span><span class="p">)</span>
			<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Changed only during early boot */</span>
<span class="kt">int</span> <span class="n">ptrace_faultinfo</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">disable_ptrace_faultinfo</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">ptrace_ldt</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">disable_ptrace_ldt</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">proc_mm</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">disable_proc_mm</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">have_switch_mm</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">disable_switch_mm</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">skas_needs_stub</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">skas0_cmd_param</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">add</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">disable_ptrace_faultinfo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">disable_ptrace_ldt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">disable_proc_mm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">disable_switch_mm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The two __uml_setup would conflict, without this stupid alias. */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="n">mode_skas0_cmd_param</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">add</span><span class="p">)</span>
	<span class="n">__attribute__</span><span class="p">((</span><span class="n">alias</span><span class="p">(</span><span class="s">&quot;skas0_cmd_param&quot;</span><span class="p">)));</span>

<span class="n">__uml_setup</span><span class="p">(</span><span class="s">&quot;skas0&quot;</span><span class="p">,</span> <span class="n">skas0_cmd_param</span><span class="p">,</span>
<span class="s">&quot;skas0</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    Disables SKAS3 and SKAS4 usage, so that SKAS0 is used</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="n">__uml_setup</span><span class="p">(</span><span class="s">&quot;mode=skas0&quot;</span><span class="p">,</span> <span class="n">mode_skas0_cmd_param</span><span class="p">,</span>
<span class="s">&quot;mode=skas0</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    Disables SKAS3 and SKAS4 usage, so that SKAS0 is used.</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="cm">/* Changed only during early boot */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">force_sysemu_disabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">nosysemu_cmd_param</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">add</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">force_sysemu_disabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__uml_setup</span><span class="p">(</span><span class="s">&quot;nosysemu&quot;</span><span class="p">,</span> <span class="n">nosysemu_cmd_param</span><span class="p">,</span>
<span class="s">&quot;nosysemu</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    Turns off syscall emulation patch for ptrace (SYSEMU) on.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    SYSEMU is a performance-patch introduced by Laurent Vivier. It changes</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    behaviour of ptrace() and helps reducing host context switch rate.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    To make it working, you need a kernel patch for your host, too.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    See http://perso.wanadoo.fr/laurent.vivier/UML/ for further </span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    information.</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">check_sysemu</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">regs</span><span class="p">[</span><span class="n">MAX_REG_NR</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">pid</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="n">non_fatal</span><span class="p">(</span><span class="s">&quot;Checking syscall emulation patch for ptrace...&quot;</span><span class="p">);</span>
	<span class="n">sysemu_supported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pid</span> <span class="o">=</span> <span class="n">start_ptraced_child</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ptrace</span><span class="p">(</span><span class="n">PTRACE_SYSEMU</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">CATCH_EINTR</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">waitpid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="n">WUNTRACED</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">fatal_perror</span><span class="p">(</span><span class="s">&quot;check_sysemu : wait failed&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">WIFSTOPPED</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">WSTOPSIG</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SIGTRAP</span><span class="p">))</span>
		<span class="n">fatal</span><span class="p">(</span><span class="s">&quot;check_sysemu : expected SIGTRAP, got status = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ptrace</span><span class="p">(</span><span class="n">PTRACE_GETREGS</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">regs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">fatal_perror</span><span class="p">(</span><span class="s">&quot;check_sysemu : PTRACE_GETREGS failed&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PT_SYSCALL_NR</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">!=</span> <span class="n">__NR_getpid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">non_fatal</span><span class="p">(</span><span class="s">&quot;check_sysemu got system call number %d, &quot;</span>
			  <span class="s">&quot;expected %d...&quot;</span><span class="p">,</span> <span class="n">PT_SYSCALL_NR</span><span class="p">(</span><span class="n">regs</span><span class="p">),</span> <span class="n">__NR_getpid</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">ptrace</span><span class="p">(</span><span class="n">PTRACE_POKEUSER</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">PT_SYSCALL_RET_OFFSET</span><span class="p">,</span> <span class="n">os_getpid</span><span class="p">());</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">non_fatal</span><span class="p">(</span><span class="s">&quot;check_sysemu : failed to modify system call &quot;</span>
			  <span class="s">&quot;return&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stop_ptraced_child</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_stopped</span><span class="p">;</span>

	<span class="n">sysemu_supported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">non_fatal</span><span class="p">(</span><span class="s">&quot;OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">set_using_sysemu</span><span class="p">(</span><span class="o">!</span><span class="n">force_sysemu_disabled</span><span class="p">);</span>

	<span class="n">non_fatal</span><span class="p">(</span><span class="s">&quot;Checking advanced syscall emulation patch for ptrace...&quot;</span><span class="p">);</span>
	<span class="n">pid</span> <span class="o">=</span> <span class="n">start_ptraced_child</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ptrace</span><span class="p">(</span><span class="n">PTRACE_OLDSETOPTIONS</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">PTRACE_O_TRACESYSGOOD</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">fatal_perror</span><span class="p">(</span><span class="s">&quot;check_sysemu: PTRACE_OLDSETOPTIONS failed&quot;</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ptrace</span><span class="p">(</span><span class="n">PTRACE_SYSEMU_SINGLESTEP</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="n">CATCH_EINTR</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">waitpid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="n">WUNTRACED</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">fatal_perror</span><span class="p">(</span><span class="s">&quot;check_sysemu: wait failed&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">WIFSTOPPED</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">WSTOPSIG</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">SIGTRAP</span><span class="o">|</span><span class="mh">0x80</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">non_fatal</span><span class="p">(</span><span class="s">&quot;check_sysemu: SYSEMU_SINGLESTEP &quot;</span>
					  <span class="s">&quot;doesn&#39;t singlestep&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">ptrace</span><span class="p">(</span><span class="n">PTRACE_POKEUSER</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">PT_SYSCALL_RET_OFFSET</span><span class="p">,</span>
				   <span class="n">os_getpid</span><span class="p">());</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">fatal_perror</span><span class="p">(</span><span class="s">&quot;check_sysemu : failed to modify &quot;</span>
					     <span class="s">&quot;system call return&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">WIFSTOPPED</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">WSTOPSIG</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">==</span> <span class="n">SIGTRAP</span><span class="p">))</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">non_fatal</span><span class="p">(</span><span class="s">&quot;check_sysemu: expected SIGTRAP or &quot;</span>
				  <span class="s">&quot;(SIGTRAP | 0x80), got status = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">status</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stop_ptraced_child</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_stopped</span><span class="p">;</span>

	<span class="n">sysemu_supported</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">non_fatal</span><span class="p">(</span><span class="s">&quot;OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">force_sysemu_disabled</span><span class="p">)</span>
		<span class="n">set_using_sysemu</span><span class="p">(</span><span class="n">sysemu_supported</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">stop_ptraced_child</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nl">fail_stopped:</span>
	<span class="n">non_fatal</span><span class="p">(</span><span class="s">&quot;missing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">check_ptrace</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pid</span><span class="p">,</span> <span class="n">syscall</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">non_fatal</span><span class="p">(</span><span class="s">&quot;Checking that ptrace can change system call numbers...&quot;</span><span class="p">);</span>
	<span class="n">pid</span> <span class="o">=</span> <span class="n">start_ptraced_child</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ptrace</span><span class="p">(</span><span class="n">PTRACE_OLDSETOPTIONS</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">PTRACE_O_TRACESYSGOOD</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">fatal_perror</span><span class="p">(</span><span class="s">&quot;check_ptrace: PTRACE_OLDSETOPTIONS failed&quot;</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ptrace</span><span class="p">(</span><span class="n">PTRACE_SYSCALL</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">fatal_perror</span><span class="p">(</span><span class="s">&quot;check_ptrace : ptrace failed&quot;</span><span class="p">);</span>

		<span class="n">CATCH_EINTR</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">waitpid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="n">WUNTRACED</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">fatal_perror</span><span class="p">(</span><span class="s">&quot;check_ptrace : wait failed&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">WIFSTOPPED</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">WSTOPSIG</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">SIGTRAP</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">)))</span>
			<span class="n">fatal</span><span class="p">(</span><span class="s">&quot;check_ptrace : expected (SIGTRAP|0x80), &quot;</span>
			       <span class="s">&quot;got status = %d&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

		<span class="n">syscall</span> <span class="o">=</span> <span class="n">ptrace</span><span class="p">(</span><span class="n">PTRACE_PEEKUSER</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">PT_SYSCALL_NR_OFFSET</span><span class="p">,</span>
				 <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">syscall</span> <span class="o">==</span> <span class="n">__NR_getpid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">ptrace</span><span class="p">(</span><span class="n">PTRACE_POKEUSER</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">PT_SYSCALL_NR_OFFSET</span><span class="p">,</span>
				   <span class="n">__NR_getppid</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">fatal_perror</span><span class="p">(</span><span class="s">&quot;check_ptrace : failed to modify &quot;</span>
					     <span class="s">&quot;system call&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">stop_ptraced_child</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">non_fatal</span><span class="p">(</span><span class="s">&quot;OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">check_sysemu</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">check_tmpexec</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">check_coredump_limit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rlimit</span> <span class="n">lim</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">getrlimit</span><span class="p">(</span><span class="n">RLIMIT_CORE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lim</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">perror</span><span class="p">(</span><span class="s">&quot;Getting core dump limit&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Core dump limits :</span><span class="se">\n\t</span><span class="s">soft - &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lim</span><span class="p">.</span><span class="n">rlim_cur</span> <span class="o">==</span> <span class="n">RLIM_INFINITY</span><span class="p">)</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;NONE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lim</span><span class="p">.</span><span class="n">rlim_cur</span><span class="p">);</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">hard - &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lim</span><span class="p">.</span><span class="n">rlim_max</span> <span class="o">==</span> <span class="n">RLIM_INFINITY</span><span class="p">)</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;NONE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lim</span><span class="p">.</span><span class="n">rlim_max</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">os_early_checks</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pid</span><span class="p">;</span>

	<span class="cm">/* Print out the core dump limits early */</span>
	<span class="n">check_coredump_limit</span><span class="p">();</span>

	<span class="n">check_ptrace</span><span class="p">();</span>

	<span class="cm">/* Need to check this early because mmapping happens before the</span>
<span class="cm">	 * kernel is running.</span>
<span class="cm">	 */</span>
	<span class="n">check_tmpexec</span><span class="p">();</span>

	<span class="n">pid</span> <span class="o">=</span> <span class="n">start_ptraced_child</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">init_registers</span><span class="p">(</span><span class="n">pid</span><span class="p">))</span>
		<span class="n">fatal</span><span class="p">(</span><span class="s">&quot;Failed to initialize default registers&quot;</span><span class="p">);</span>
	<span class="n">stop_ptraced_child</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">noprocmm_cmd_param</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">add</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">disable_proc_mm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__uml_setup</span><span class="p">(</span><span class="s">&quot;noprocmm&quot;</span><span class="p">,</span> <span class="n">noprocmm_cmd_param</span><span class="p">,</span>
<span class="s">&quot;noprocmm</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    Turns off usage of /proc/mm, even if host supports it.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    To support /proc/mm, the host needs to be patched using</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    the current skas3 patch.</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">noptracefaultinfo_cmd_param</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">add</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">disable_ptrace_faultinfo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__uml_setup</span><span class="p">(</span><span class="s">&quot;noptracefaultinfo&quot;</span><span class="p">,</span> <span class="n">noptracefaultinfo_cmd_param</span><span class="p">,</span>
<span class="s">&quot;noptracefaultinfo</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    Turns off usage of PTRACE_FAULTINFO, even if host supports</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    it. To support PTRACE_FAULTINFO, the host needs to be patched</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    using the current skas3 patch.</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">noptraceldt_cmd_param</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">add</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">disable_ptrace_ldt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__uml_setup</span><span class="p">(</span><span class="s">&quot;noptraceldt&quot;</span><span class="p">,</span> <span class="n">noptraceldt_cmd_param</span><span class="p">,</span>
<span class="s">&quot;noptraceldt</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    Turns off usage of PTRACE_LDT, even if host supports it.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    To support PTRACE_LDT, the host needs to be patched using</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    the current skas3 patch.</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">check_skas3_ptrace_faultinfo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ptrace_faultinfo</span> <span class="n">fi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pid</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">non_fatal</span><span class="p">(</span><span class="s">&quot;  - PTRACE_FAULTINFO...&quot;</span><span class="p">);</span>
	<span class="n">pid</span> <span class="o">=</span> <span class="n">start_ptraced_child</span><span class="p">();</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">ptrace</span><span class="p">(</span><span class="n">PTRACE_FAULTINFO</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EIO</span><span class="p">)</span>
			<span class="n">non_fatal</span><span class="p">(</span><span class="s">&quot;not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">perror</span><span class="p">(</span><span class="s">&quot;not found&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">disable_ptrace_faultinfo</span><span class="p">)</span>
		<span class="n">non_fatal</span><span class="p">(</span><span class="s">&quot;found but disabled on command line</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">ptrace_faultinfo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">non_fatal</span><span class="p">(</span><span class="s">&quot;found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">stop_ptraced_child</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">check_skas3_ptrace_ldt</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef PTRACE_LDT</span>
	<span class="kt">int</span> <span class="n">pid</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ldtbuf</span><span class="p">[</span><span class="mi">40</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ptrace_ldt</span> <span class="n">ldt_op</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ptrace_ldt</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="cm">/* read default ldt */</span>
		<span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">ldtbuf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bytecount</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ldtbuf</span><span class="p">)};</span>

	<span class="n">non_fatal</span><span class="p">(</span><span class="s">&quot;  - PTRACE_LDT...&quot;</span><span class="p">);</span>
	<span class="n">pid</span> <span class="o">=</span> <span class="n">start_ptraced_child</span><span class="p">();</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">ptrace</span><span class="p">(</span><span class="n">PTRACE_LDT</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ldt_op</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EIO</span><span class="p">)</span>
			<span class="n">non_fatal</span><span class="p">(</span><span class="s">&quot;not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">perror</span><span class="p">(</span><span class="s">&quot;not found&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">disable_ptrace_ldt</span><span class="p">)</span>
		<span class="n">non_fatal</span><span class="p">(</span><span class="s">&quot;found, but use is disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">ptrace_ldt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">non_fatal</span><span class="p">(</span><span class="s">&quot;found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">stop_ptraced_child</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">check_skas3_proc_mm</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">non_fatal</span><span class="p">(</span><span class="s">&quot;  - /proc/mm...&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="s">&quot;/proc/mm&quot;</span><span class="p">,</span> <span class="n">W_OK</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">perror</span><span class="p">(</span><span class="s">&quot;not found&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">disable_proc_mm</span><span class="p">)</span>
		<span class="n">non_fatal</span><span class="p">(</span><span class="s">&quot;found but disabled on command line</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">proc_mm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">non_fatal</span><span class="p">(</span><span class="s">&quot;found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">can_do_skas</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">non_fatal</span><span class="p">(</span><span class="s">&quot;Checking for the skas3 patch in the host:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">check_skas3_proc_mm</span><span class="p">();</span>
	<span class="n">check_skas3_ptrace_faultinfo</span><span class="p">();</span>
	<span class="n">check_skas3_ptrace_ldt</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">proc_mm</span> <span class="o">||</span> <span class="o">!</span><span class="n">ptrace_faultinfo</span> <span class="o">||</span> <span class="o">!</span><span class="n">ptrace_ldt</span><span class="p">)</span>
		<span class="n">skas_needs_stub</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">parse_iomem</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">add</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iomem_region</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stat64</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="o">*</span><span class="n">driver</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">driver</span> <span class="o">=</span> <span class="n">str</span><span class="p">;</span>
	<span class="n">file</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="sc">&#39;,&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">file</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;parse_iomem : failed to parse iomem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">file</span><span class="o">++</span><span class="p">;</span>
	<span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">perror</span><span class="p">(</span><span class="s">&quot;parse_iomem - Couldn&#39;t open io file&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fstat64</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">perror</span><span class="p">(</span><span class="s">&quot;parse_iomem - cannot stat_fd file&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_close</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">new</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">perror</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t allocate iomem_region struct&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_close</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">st_size</span> <span class="o">+</span> <span class="n">UM_KERN_PAGE_SIZE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">UM_KERN_PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="o">*</span><span class="n">new</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">iomem_region</span><span class="p">)</span> <span class="p">{</span> <span class="p">.</span><span class="n">next</span>		<span class="o">=</span> <span class="n">iomem_regions</span><span class="p">,</span>
					<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="n">driver</span><span class="p">,</span>
					<span class="p">.</span><span class="n">fd</span>		<span class="o">=</span> <span class="n">fd</span><span class="p">,</span>
					<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="n">size</span><span class="p">,</span>
					<span class="p">.</span><span class="n">phys</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
					<span class="p">.</span><span class="n">virt</span>		<span class="o">=</span> <span class="mi">0</span> <span class="p">});</span>
	<span class="n">iomem_regions</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
	<span class="n">iomem_size</span> <span class="o">+=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+</span> <span class="n">UM_KERN_PAGE_SIZE</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">out_close:</span>
	<span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
