<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › um › os-Linux › aio.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>aio.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2004 - 2007 Jeff Dike (jdike@{addtoit,linux.intel}.com)</span>
<span class="cm"> * Licensed under the GPL</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;sched.h&gt;</span>
<span class="cp">#include &lt;signal.h&gt;</span>
<span class="cp">#include &lt;errno.h&gt;</span>
<span class="cp">#include &lt;sys/time.h&gt;</span>
<span class="cp">#include &lt;asm/unistd.h&gt;</span>
<span class="cp">#include &quot;aio.h&quot;</span>
<span class="cp">#include &quot;init.h&quot;</span>
<span class="cp">#include &quot;kern_util.h&quot;</span>
<span class="cp">#include &quot;os.h&quot;</span>

<span class="k">struct</span> <span class="n">aio_thread_req</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="n">aio_type</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">io_fd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aio_context</span> <span class="o">*</span><span class="n">aio</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#if defined(HAVE_AIO_ABI)</span>
<span class="cp">#include &lt;linux/aio_abi.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * If we have the headers, we are going to build with AIO enabled.</span>
<span class="cm"> * If we don&#39;t have aio in libc, we define the necessary stubs here.</span>
<span class="cm"> */</span>

<span class="cp">#if !defined(HAVE_AIO_LIBC)</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">io_setup</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">aio_context_t</span> <span class="o">*</span><span class="n">ctxp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">syscall</span><span class="p">(</span><span class="n">__NR_io_setup</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">ctxp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">io_submit</span><span class="p">(</span><span class="n">aio_context_t</span> <span class="n">ctx</span><span class="p">,</span> <span class="kt">long</span> <span class="n">nr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iocb</span> <span class="o">**</span><span class="n">iocbpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">syscall</span><span class="p">(</span><span class="n">__NR_io_submit</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">iocbpp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">io_getevents</span><span class="p">(</span><span class="n">aio_context_t</span> <span class="n">ctx_id</span><span class="p">,</span> <span class="kt">long</span> <span class="n">min_nr</span><span class="p">,</span> <span class="kt">long</span> <span class="n">nr</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">io_event</span> <span class="o">*</span><span class="n">events</span><span class="p">,</span> <span class="k">struct</span> <span class="n">timespec</span> <span class="o">*</span><span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">syscall</span><span class="p">(</span><span class="n">__NR_io_getevents</span><span class="p">,</span> <span class="n">ctx_id</span><span class="p">,</span> <span class="n">min_nr</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * The AIO_MMAP cases force the mmapped page into memory here</span>
<span class="cm"> * rather than in whatever place first touches the data.  I used</span>
<span class="cm"> * to do this by touching the page, but that&#39;s delicate because</span>
<span class="cm"> * gcc is prone to optimizing that away.  So, what&#39;s done here</span>
<span class="cm"> * is we read from the descriptor from which the page was</span>
<span class="cm"> * mapped.  The caller is required to pass an offset which is</span>
<span class="cm"> * inside the page that was mapped.  Thus, when the read</span>
<span class="cm"> * returns, we know that the page is in the page cache, and</span>
<span class="cm"> * that it now backs the mmapped area.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_aio</span><span class="p">(</span><span class="n">aio_context_t</span> <span class="n">ctx</span><span class="p">,</span> <span class="k">enum</span> <span class="n">aio_type</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		  <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aio_context</span> <span class="o">*</span><span class="n">aio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iocb</span> <span class="o">*</span><span class="n">iocbp</span> <span class="o">=</span> <span class="o">&amp;</span> <span class="p">((</span><span class="k">struct</span> <span class="n">iocb</span><span class="p">)</span> <span class="p">{</span>
				    <span class="p">.</span><span class="n">aio_data</span>       <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">aio</span><span class="p">,</span>
				    <span class="p">.</span><span class="n">aio_fildes</span>     <span class="o">=</span> <span class="n">fd</span><span class="p">,</span>
				    <span class="p">.</span><span class="n">aio_buf</span>        <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">buf</span><span class="p">,</span>
				    <span class="p">.</span><span class="n">aio_nbytes</span>     <span class="o">=</span> <span class="n">len</span><span class="p">,</span>
				    <span class="p">.</span><span class="n">aio_offset</span>     <span class="o">=</span> <span class="n">offset</span>
			     <span class="p">});</span>
	<span class="kt">char</span> <span class="n">c</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AIO_READ</span>:
		<span class="n">iocbp</span><span class="o">-&gt;</span><span class="n">aio_lio_opcode</span> <span class="o">=</span> <span class="n">IOCB_CMD_PREAD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AIO_WRITE</span>:
		<span class="n">iocbp</span><span class="o">-&gt;</span><span class="n">aio_lio_opcode</span> <span class="o">=</span> <span class="n">IOCB_CMD_PWRITE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AIO_MMAP</span>:
		<span class="n">iocbp</span><span class="o">-&gt;</span><span class="n">aio_lio_opcode</span> <span class="o">=</span> <span class="n">IOCB_CMD_PREAD</span><span class="p">;</span>
		<span class="n">iocbp</span><span class="o">-&gt;</span><span class="n">aio_buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">;</span>
		<span class="n">iocbp</span><span class="o">-&gt;</span><span class="n">aio_nbytes</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">UM_KERN_ERR</span> <span class="s">&quot;Bogus op in do_aio - %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">io_submit</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iocbp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Initialized in an initcall and unchanged thereafter */</span>
<span class="k">static</span> <span class="n">aio_context_t</span> <span class="n">ctx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aio_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aio_thread_reply</span> <span class="n">reply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">io_event</span> <span class="n">event</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">reply_fd</span><span class="p">;</span>

	<span class="n">signal</span><span class="p">(</span><span class="n">SIGWINCH</span><span class="p">,</span> <span class="n">SIG_IGN</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">io_getevents</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EINTR</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">UM_KERN_ERR</span> <span class="s">&quot;aio_thread - io_getevents failed, &quot;</span>
			       <span class="s">&quot;errno = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">errno</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">reply</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">aio_thread_reply</span><span class="p">)</span>
				<span class="p">{</span> <span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">event</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
						<span class="p">.</span><span class="n">err</span>	<span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="n">res</span> <span class="p">});</span>
			<span class="n">reply_fd</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">aio_context</span> <span class="o">*</span><span class="p">)</span> <span class="n">reply</span><span class="p">.</span><span class="n">data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">reply_fd</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">reply_fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reply</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">reply</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">reply</span><span class="p">))</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">UM_KERN_ERR</span> <span class="s">&quot;aio_thread - write failed, &quot;</span>
				       <span class="s">&quot;fd = %d, err = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reply_fd</span><span class="p">,</span> <span class="n">errno</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_not_aio</span><span class="p">(</span><span class="k">struct</span> <span class="n">aio_thread_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">actual</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">actual</span> <span class="o">=</span> <span class="n">lseek64</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">io_fd</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">actual</span> <span class="o">!=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AIO_READ</span>:
		<span class="n">n</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">io_fd</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AIO_WRITE</span>:
		<span class="n">n</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">io_fd</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AIO_MMAP</span>:
		<span class="n">n</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">io_fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">UM_KERN_ERR</span> <span class="s">&quot;do_not_aio - bad request type : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">req</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* These are initialized in initcalls and not changed */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aio_req_fd_r</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aio_req_fd_w</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aio_pid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">aio_stack</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">not_aio_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aio_thread_req</span> <span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aio_thread_reply</span> <span class="n">reply</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">signal</span><span class="p">(</span><span class="n">SIGWINCH</span><span class="p">,</span> <span class="n">SIG_IGN</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">aio_req_fd_r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">UM_KERN_ERR</span> <span class="s">&quot;not_aio_thread - &quot;</span>
				       <span class="s">&quot;read failed, fd = %d, err = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">aio_req_fd_r</span><span class="p">,</span>
				       <span class="n">errno</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">UM_KERN_ERR</span> <span class="s">&quot;not_aio_thread - short &quot;</span>
				       <span class="s">&quot;read, fd = %d, length = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">aio_req_fd_r</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">do_not_aio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
		<span class="n">reply</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">aio_thread_reply</span><span class="p">)</span> <span class="p">{</span> <span class="p">.</span><span class="n">data</span> 	<span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="n">aio</span><span class="p">,</span>
						     <span class="p">.</span><span class="n">err</span>	<span class="o">=</span> <span class="n">err</span> <span class="p">});</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">aio</span><span class="o">-&gt;</span><span class="n">reply_fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reply</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">reply</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">reply</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">UM_KERN_ERR</span> <span class="s">&quot;not_aio_thread - write failed, &quot;</span>
			       <span class="s">&quot;fd = %d, err = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">.</span><span class="n">aio</span><span class="o">-&gt;</span><span class="n">reply_fd</span><span class="p">,</span> <span class="n">errno</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_aio_24</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">os_pipe</span><span class="p">(</span><span class="n">fds</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">aio_req_fd_w</span> <span class="o">=</span> <span class="n">fds</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">aio_req_fd_r</span> <span class="o">=</span> <span class="n">fds</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">os_set_fd_block</span><span class="p">(</span><span class="n">aio_req_fd_w</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_close_pipe</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">run_helper_thread</span><span class="p">(</span><span class="n">not_aio_thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				<span class="n">CLONE_FILES</span> <span class="o">|</span> <span class="n">CLONE_VM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aio_stack</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_close_pipe</span><span class="p">;</span>

	<span class="n">aio_pid</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">out_close_pipe:</span>
	<span class="n">close</span><span class="p">(</span><span class="n">fds</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">close</span><span class="p">(</span><span class="n">fds</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">aio_req_fd_w</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">aio_req_fd_r</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="nl">out:</span>
<span class="cp">#ifndef HAVE_AIO_ABI</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">UM_KERN_INFO</span> <span class="s">&quot;/usr/include/linux/aio_abi.h not present during &quot;</span>
	       <span class="s">&quot;build</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">UM_KERN_INFO</span> <span class="s">&quot;2.6 host AIO support not used - falling back to &quot;</span>
	       <span class="s">&quot;I/O thread</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef HAVE_AIO_ABI</span>
<span class="cp">#define DEFAULT_24_AIO 0</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_aio_26</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">io_setup</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">UM_KERN_ERR</span> <span class="s">&quot;aio_thread failed to initialize context, &quot;</span>
		       <span class="s">&quot;err = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">errno</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">run_helper_thread</span><span class="p">(</span><span class="n">aio_thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				<span class="n">CLONE_FILES</span> <span class="o">|</span> <span class="n">CLONE_VM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aio_stack</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">aio_pid</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">UM_KERN_INFO</span> <span class="s">&quot;Using 2.6 host AIO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">submit_aio_26</span><span class="p">(</span><span class="k">enum</span> <span class="n">aio_type</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">io_fd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aio_context</span> <span class="o">*</span><span class="n">aio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aio_thread_reply</span> <span class="n">reply</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">do_aio</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">io_fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">aio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reply</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">aio_thread_reply</span><span class="p">)</span> <span class="p">{</span> <span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">aio</span><span class="p">,</span>
					 <span class="p">.</span><span class="n">err</span>  <span class="o">=</span> <span class="n">err</span> <span class="p">});</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">aio</span><span class="o">-&gt;</span><span class="n">reply_fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reply</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">reply</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">reply</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">UM_KERN_ERR</span> <span class="s">&quot;submit_aio_26 - write failed, &quot;</span>
			       <span class="s">&quot;fd = %d, err = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">aio</span><span class="o">-&gt;</span><span class="n">reply_fd</span><span class="p">,</span> <span class="o">-</span><span class="n">err</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="cp">#define DEFAULT_24_AIO 1</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_aio_26</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">submit_aio_26</span><span class="p">(</span><span class="k">enum</span> <span class="n">aio_type</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">io_fd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aio_context</span> <span class="o">*</span><span class="n">aio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* Initialized in an initcall and unchanged thereafter */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aio_24</span> <span class="o">=</span> <span class="n">DEFAULT_24_AIO</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">set_aio_24</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">add</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">aio_24</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__uml_setup</span><span class="p">(</span><span class="s">&quot;aio=2.4&quot;</span><span class="p">,</span> <span class="n">set_aio_24</span><span class="p">,</span>
<span class="s">&quot;aio=2.4</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    This is used to force UML to use 2.4-style AIO even when 2.6 AIO is</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    available.  2.4 AIO is a single thread that handles one request at a</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    time, synchronously.  2.6 AIO is a thread which uses the 2.6 AIO </span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    interface to handle an arbitrary number of pending requests.  2.6 AIO </span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    is not available in tt mode, on 2.4 hosts, or when UML is built with</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    /usr/include/linux/aio_abi.h not available.  Many distributions don&#39;t</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    include aio_abi.h, so you will need to copy it from a kernel tree to</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;    your /usr/include/linux in order to build an AIO-capable UML</span><span class="se">\n\n</span><span class="s">&quot;</span>
<span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_aio</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aio_24</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">init_aio_26</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">ENOSYS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">UM_KERN_INFO</span> <span class="s">&quot;2.6 AIO not supported on the &quot;</span>
			       <span class="s">&quot;host - reverting to 2.4 AIO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">aio_24</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aio_24</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">init_aio_24</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The reason for the __initcall/__uml_exitcall asymmetry is that init_aio</span>
<span class="cm"> * needs to be called when the kernel is running because it calls run_helper,</span>
<span class="cm"> * which needs get_free_page.  exit_aio is a __uml_exitcall because the generic</span>
<span class="cm"> * kernel does not run __exitcalls on shutdown, and can&#39;t because many of them</span>
<span class="cm"> * break when called outside of module unloading.</span>
<span class="cm"> */</span>
<span class="n">__initcall</span><span class="p">(</span><span class="n">init_aio</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">exit_aio</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aio_pid</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">os_kill_process</span><span class="p">(</span><span class="n">aio_pid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">free_stack</span><span class="p">(</span><span class="n">aio_stack</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">__uml_exitcall</span><span class="p">(</span><span class="n">exit_aio</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">submit_aio_24</span><span class="p">(</span><span class="k">enum</span> <span class="n">aio_type</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">io_fd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span> <span class="k">struct</span> <span class="n">aio_context</span> <span class="o">*</span><span class="n">aio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aio_thread_req</span> <span class="n">req</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">type</span> 		<span class="o">=</span> <span class="n">type</span><span class="p">,</span>
				      <span class="p">.</span><span class="n">io_fd</span>		<span class="o">=</span> <span class="n">io_fd</span><span class="p">,</span>
				      <span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="n">offset</span><span class="p">,</span>
				      <span class="p">.</span><span class="n">buf</span>		<span class="o">=</span> <span class="n">buf</span><span class="p">,</span>
				      <span class="p">.</span><span class="n">len</span>		<span class="o">=</span> <span class="n">len</span><span class="p">,</span>
				      <span class="p">.</span><span class="n">aio</span>		<span class="o">=</span> <span class="n">aio</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">aio_req_fd_w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">submit_aio</span><span class="p">(</span><span class="k">enum</span> <span class="n">aio_type</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">io_fd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
	       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reply_fd</span><span class="p">,</span>
	       <span class="k">struct</span> <span class="n">aio_context</span> <span class="o">*</span><span class="n">aio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">aio</span><span class="o">-&gt;</span><span class="n">reply_fd</span> <span class="o">=</span> <span class="n">reply_fd</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aio_24</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">submit_aio_24</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">io_fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">aio</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">submit_aio_26</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">io_fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">aio</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
