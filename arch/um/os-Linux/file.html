<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › um › os-Linux › file.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>file.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2002 - 2007 Jeff Dike (jdike@{addtoit,linux.intel}.com)</span>
<span class="cm"> * Licensed under the GPL</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;errno.h&gt;</span>
<span class="cp">#include &lt;fcntl.h&gt;</span>
<span class="cp">#include &lt;signal.h&gt;</span>
<span class="cp">#include &lt;sys/ioctl.h&gt;</span>
<span class="cp">#include &lt;sys/mount.h&gt;</span>
<span class="cp">#include &lt;sys/socket.h&gt;</span>
<span class="cp">#include &lt;sys/stat.h&gt;</span>
<span class="cp">#include &lt;sys/un.h&gt;</span>
<span class="cp">#include &quot;os.h&quot;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">copy_stat</span><span class="p">(</span><span class="k">struct</span> <span class="n">uml_stat</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">stat64</span> <span class="o">*</span><span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">uml_stat</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ust_dev</span>     <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">st_dev</span><span class="p">,</span>     <span class="cm">/* device */</span>
		<span class="p">.</span><span class="n">ust_ino</span>     <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">st_ino</span><span class="p">,</span>     <span class="cm">/* inode */</span>
		<span class="p">.</span><span class="n">ust_mode</span>    <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">st_mode</span><span class="p">,</span>    <span class="cm">/* protection */</span>
		<span class="p">.</span><span class="n">ust_nlink</span>   <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">st_nlink</span><span class="p">,</span>   <span class="cm">/* number of hard links */</span>
		<span class="p">.</span><span class="n">ust_uid</span>     <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">st_uid</span><span class="p">,</span>     <span class="cm">/* user ID of owner */</span>
		<span class="p">.</span><span class="n">ust_gid</span>     <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">st_gid</span><span class="p">,</span>     <span class="cm">/* group ID of owner */</span>
		<span class="p">.</span><span class="n">ust_size</span>    <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">st_size</span><span class="p">,</span>    <span class="cm">/* total size, in bytes */</span>
		<span class="p">.</span><span class="n">ust_blksize</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">st_blksize</span><span class="p">,</span> <span class="cm">/* blocksize for filesys I/O */</span>
		<span class="p">.</span><span class="n">ust_blocks</span>  <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">st_blocks</span><span class="p">,</span>  <span class="cm">/* number of blocks allocated */</span>
		<span class="p">.</span><span class="n">ust_atime</span>   <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">st_atime</span><span class="p">,</span>   <span class="cm">/* time of last access */</span>
		<span class="p">.</span><span class="n">ust_mtime</span>   <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">st_mtime</span><span class="p">,</span>   <span class="cm">/* time of last modification */</span>
		<span class="p">.</span><span class="n">ust_ctime</span>   <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">st_ctime</span><span class="p">,</span>   <span class="cm">/* time of last change */</span>
	<span class="p">});</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">os_stat_fd</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uml_stat</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stat64</span> <span class="n">sbuf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">CATCH_EINTR</span><span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">fstat64</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sbuf</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ubuf</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">copy_stat</span><span class="p">(</span><span class="n">ubuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sbuf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">os_stat_file</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">file_name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uml_stat</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stat64</span> <span class="n">sbuf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">CATCH_EINTR</span><span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">stat64</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sbuf</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ubuf</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">copy_stat</span><span class="p">(</span><span class="n">ubuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sbuf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">os_access</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">amode</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">amode</span> <span class="o">=</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">OS_ACC_R_OK</span> <span class="o">?</span> <span class="n">R_OK</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">OS_ACC_W_OK</span> <span class="o">?</span> <span class="n">W_OK</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">OS_ACC_X_OK</span> <span class="o">?</span> <span class="n">X_OK</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">OS_ACC_F_OK</span> <span class="o">?</span> <span class="n">F_OK</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">access</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">amode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* FIXME? required only by hostaudio (because it passes ioctls verbatim) */</span>
<span class="kt">int</span> <span class="nf">os_ioctl_generic</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* FIXME: ensure namebuf in os_get_if_name is big enough */</span>
<span class="kt">int</span> <span class="nf">os_get_ifname</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">namebuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">SIOCGIFNAME</span><span class="p">,</span> <span class="n">namebuf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">os_set_slip</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">disc</span><span class="p">,</span> <span class="n">sencap</span><span class="p">;</span>

	<span class="n">disc</span> <span class="o">=</span> <span class="n">N_SLIP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">TIOCSETD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">disc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>

	<span class="n">sencap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">SIOCSIFENCAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sencap</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">os_mode_fd</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">CATCH_EINTR</span><span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">fchmod</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">mode</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">os_file_type</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uml_stat</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">os_stat_file</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">ust_mode</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">OS_TYPE_DIR</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S_ISLNK</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">ust_mode</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">OS_TYPE_SYMLINK</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S_ISCHR</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">ust_mode</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">OS_TYPE_CHARDEV</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S_ISBLK</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">ust_mode</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">OS_TYPE_BLOCKDEV</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S_ISFIFO</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">ust_mode</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">OS_TYPE_FIFO</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S_ISSOCK</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">ust_mode</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">OS_TYPE_SOCK</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">return</span> <span class="n">OS_TYPE_FILE</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">os_file_mode</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">openflags</span> <span class="o">*</span><span class="n">mode_out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="o">*</span><span class="n">mode_out</span> <span class="o">=</span> <span class="n">OPENFLAGS</span><span class="p">();</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">access</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">W_OK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">EACCES</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="o">*</span><span class="n">mode_out</span> <span class="o">=</span> <span class="n">of_write</span><span class="p">(</span><span class="o">*</span><span class="n">mode_out</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">access</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">R_OK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">EACCES</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="o">*</span><span class="n">mode_out</span> <span class="o">=</span> <span class="n">of_read</span><span class="p">(</span><span class="o">*</span><span class="n">mode_out</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">os_open_file</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">openflags</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span><span class="p">.</span><span class="n">r</span> <span class="o">&amp;&amp;</span> <span class="n">flags</span><span class="p">.</span><span class="n">w</span><span class="p">)</span>
		<span class="n">f</span> <span class="o">=</span> <span class="n">O_RDWR</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flags</span><span class="p">.</span><span class="n">r</span><span class="p">)</span>
		<span class="n">f</span> <span class="o">=</span> <span class="n">O_RDONLY</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flags</span><span class="p">.</span><span class="n">w</span><span class="p">)</span>
		<span class="n">f</span> <span class="o">=</span> <span class="n">O_WRONLY</span><span class="p">;</span>
	<span class="k">else</span> <span class="n">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span><span class="p">.</span><span class="n">s</span><span class="p">)</span>
		<span class="n">f</span> <span class="o">|=</span> <span class="n">O_SYNC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span><span class="p">.</span><span class="n">c</span><span class="p">)</span>
		<span class="n">f</span> <span class="o">|=</span> <span class="n">O_CREAT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span><span class="p">.</span><span class="n">t</span><span class="p">)</span>
		<span class="n">f</span> <span class="o">|=</span> <span class="n">O_TRUNC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span><span class="p">.</span><span class="n">e</span><span class="p">)</span>
		<span class="n">f</span> <span class="o">|=</span> <span class="n">O_EXCL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span><span class="p">.</span><span class="n">a</span><span class="p">)</span>
		<span class="n">f</span> <span class="o">|=</span> <span class="n">O_APPEND</span><span class="p">;</span>

	<span class="n">fd</span> <span class="o">=</span> <span class="n">open64</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span><span class="p">.</span><span class="n">cl</span> <span class="o">&amp;&amp;</span> <span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_SETFD</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
		<span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">fd</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">os_connect_socket</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr_un</span> <span class="n">sock</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">sock</span><span class="p">.</span><span class="n">sun_family</span> <span class="o">=</span> <span class="n">AF_UNIX</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">sock</span><span class="p">.</span><span class="n">sun_path</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sock</span><span class="p">.</span><span class="n">sun_path</span><span class="p">),</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="n">fd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">sock</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sock</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_close</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">fd</span><span class="p">;</span>

<span class="nl">out_close:</span>
	<span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">os_close_file</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">os_seek_file</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">actual</span><span class="p">;</span>

	<span class="n">actual</span> <span class="o">=</span> <span class="n">lseek64</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">actual</span> <span class="o">!=</span> <span class="n">offset</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">os_read_file</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">os_write_file</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">os_file_size</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="n">size_out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uml_stat</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">os_stat_file</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">UM_KERN_ERR</span> <span class="s">&quot;Couldn&#39;t stat </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> : err = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span>
		       <span class="o">-</span><span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">S_ISBLK</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">ust_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
		<span class="kt">long</span> <span class="n">blocks</span><span class="p">;</span>

		<span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">UM_KERN_ERR</span> <span class="s">&quot;Couldn&#39;t open </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">, &quot;</span>
			       <span class="s">&quot;errno = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">errno</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">BLKGETSIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blocks</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">UM_KERN_ERR</span> <span class="s">&quot;Couldn&#39;t get the block size of &quot;</span>
			       <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">, errno = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">errno</span><span class="p">);</span>
			<span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">size_out</span> <span class="o">=</span> <span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">blocks</span><span class="p">)</span> <span class="o">*</span> <span class="mi">512</span><span class="p">;</span>
		<span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="o">*</span><span class="n">size_out</span> <span class="o">=</span> <span class="n">buf</span><span class="p">.</span><span class="n">ust_size</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">os_file_modtime</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">modtime</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uml_stat</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">os_stat_file</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">UM_KERN_ERR</span> <span class="s">&quot;Couldn&#39;t stat </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> : err = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span>
		       <span class="o">-</span><span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">modtime</span> <span class="o">=</span> <span class="n">buf</span><span class="p">.</span><span class="n">ust_mtime</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">os_set_exec_close</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">CATCH_EINTR</span><span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_SETFD</span><span class="p">,</span> <span class="n">FD_CLOEXEC</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">os_pipe</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">fds</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">close_on_exec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="n">stream</span> <span class="o">?</span> <span class="n">SOCK_STREAM</span> <span class="o">:</span> <span class="n">SOCK_DGRAM</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">socketpair</span><span class="p">(</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fds</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">close_on_exec</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">os_set_exec_close</span><span class="p">(</span><span class="n">fds</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">os_set_exec_close</span><span class="p">(</span><span class="n">fds</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">error:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">UM_KERN_ERR</span> <span class="s">&quot;os_pipe : Setting FD_CLOEXEC failed, err = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="o">-</span><span class="n">err</span><span class="p">);</span>
	<span class="n">close</span><span class="p">(</span><span class="n">fds</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">close</span><span class="p">(</span><span class="n">fds</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">os_set_fd_async</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_GETFL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">|=</span> <span class="n">O_ASYNC</span> <span class="o">|</span> <span class="n">O_NONBLOCK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_SETFL</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">UM_KERN_ERR</span> <span class="s">&quot;os_set_fd_async : failed to set O_ASYNC &quot;</span>
		       <span class="s">&quot;and O_NONBLOCK on fd # %d, errno = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">errno</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_SETSIG</span><span class="p">,</span> <span class="n">SIGIO</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_SETOWN</span><span class="p">,</span> <span class="n">os_getpid</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">UM_KERN_ERR</span> <span class="s">&quot;os_set_fd_async : Failed to fcntl F_SETOWN &quot;</span>
		       <span class="s">&quot;(or F_SETSIG) fd %d, errno = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">errno</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">os_clear_fd_async</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_GETFL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">O_ASYNC</span> <span class="o">|</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_SETFL</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">os_set_fd_block</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">blocking</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_GETFL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">blocking</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">O_NONBLOCK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">O_NONBLOCK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_SETFL</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">os_accept_connection</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">new</span><span class="p">;</span>

	<span class="n">new</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">new</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifndef SHUT_RD</span>
<span class="cp">#define SHUT_RD 0</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef SHUT_WR</span>
<span class="cp">#define SHUT_WR 1</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef SHUT_RDWR</span>
<span class="cp">#define SHUT_RDWR 2</span>
<span class="cp">#endif</span>

<span class="kt">int</span> <span class="nf">os_shutdown_socket</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="kt">int</span> <span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">what</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&amp;&amp;</span> <span class="n">w</span><span class="p">)</span>
		<span class="n">what</span> <span class="o">=</span> <span class="n">SHUT_RDWR</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="n">what</span> <span class="o">=</span> <span class="n">SHUT_RD</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="p">)</span>
		<span class="n">what</span> <span class="o">=</span> <span class="n">SHUT_WR</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">shutdown</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">what</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">os_rcv_fd</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">helper_pid_out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">new</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">CMSG_SPACE</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">new</span><span class="p">))];</span>
	<span class="k">struct</span> <span class="n">msghdr</span> <span class="n">msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmsghdr</span> <span class="o">*</span><span class="n">cmsg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iovec</span> <span class="n">iov</span><span class="p">;</span>

	<span class="n">msg</span><span class="p">.</span><span class="n">msg_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">msg_namelen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">iov</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">iovec</span><span class="p">)</span> <span class="p">{</span> <span class="p">.</span><span class="n">iov_base</span>  <span class="o">=</span> <span class="n">helper_pid_out</span><span class="p">,</span>
				<span class="p">.</span><span class="n">iov_len</span>   <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">helper_pid_out</span><span class="p">)</span> <span class="p">});</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">msg_iov</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iov</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">msg_iovlen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">msg_control</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">msg_controllen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">msg_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">recvmsg</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">!=</span> <span class="n">iov</span><span class="p">.</span><span class="n">iov_len</span><span class="p">)</span>
		<span class="o">*</span><span class="n">helper_pid_out</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">cmsg</span> <span class="o">=</span> <span class="n">CMSG_FIRSTHDR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmsg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">UM_KERN_ERR</span> <span class="s">&quot;rcv_fd didn&#39;t receive anything, &quot;</span>
		       <span class="s">&quot;error = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">errno</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">cmsg_level</span> <span class="o">!=</span> <span class="n">SOL_SOCKET</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">cmsg_type</span> <span class="o">!=</span> <span class="n">SCM_RIGHTS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">UM_KERN_ERR</span> <span class="s">&quot;rcv_fd didn&#39;t receive a descriptor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">new</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">CMSG_DATA</span><span class="p">(</span><span class="n">cmsg</span><span class="p">))[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">new</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">os_create_unix_socket</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">close_on_exec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr_un</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sock</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">PF_UNIX</span><span class="p">,</span> <span class="n">SOCK_DGRAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">close_on_exec</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">os_set_exec_close</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">UM_KERN_ERR</span> <span class="s">&quot;create_unix_socket : &quot;</span>
			       <span class="s">&quot;close_on_exec failed, err = %d&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">addr</span><span class="p">.</span><span class="n">sun_family</span> <span class="o">=</span> <span class="n">AF_UNIX</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">addr</span><span class="p">.</span><span class="n">sun_path</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">bind</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sock</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">os_flush_stdout</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">os_lock_file</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">excl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">excl</span> <span class="o">?</span> <span class="n">F_WRLCK</span> <span class="o">:</span> <span class="n">F_RDLCK</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">flock</span> <span class="n">lock</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">flock</span><span class="p">)</span> <span class="p">{</span> <span class="p">.</span><span class="n">l_type</span>	<span class="o">=</span> <span class="n">type</span><span class="p">,</span>
					      <span class="p">.</span><span class="n">l_whence</span>	<span class="o">=</span> <span class="n">SEEK_SET</span><span class="p">,</span>
					      <span class="p">.</span><span class="n">l_start</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
					      <span class="p">.</span><span class="n">l_len</span>	<span class="o">=</span> <span class="mi">0</span> <span class="p">}</span> <span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">save</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_SETLK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">save</span> <span class="o">=</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_GETLK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">UM_KERN_ERR</span> <span class="s">&quot;F_SETLK failed, file already locked by pid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">lock</span><span class="p">.</span><span class="n">l_pid</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">save</span><span class="p">;</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="nf">os_major</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">major</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="nf">os_minor</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">minor</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="nf">os_makedev</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">major</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">minor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">makedev</span><span class="p">(</span><span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
