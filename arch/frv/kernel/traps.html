<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › frv › kernel › traps.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>traps.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* traps.c: high-level exception handler for FR-V</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2003 Red Hat, Inc. All Rights Reserved.</span>
<span class="cm"> * Written by David Howells (dhowells@redhat.com)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version</span>
<span class="cm"> * 2 of the License, or (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/signal.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/user.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/linkage.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;asm/asm-offsets.h&gt;</span>
<span class="cp">#include &lt;asm/setup.h&gt;</span>
<span class="cp">#include &lt;asm/fpu.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#include &lt;asm/siginfo.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="kt">void</span> <span class="n">show_backtrace</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>

<span class="k">extern</span> <span class="n">asmlinkage</span> <span class="kt">void</span> <span class="n">__break_hijack_kernel_event</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * instruction access error</span>
<span class="cm"> */</span>
<span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">insn_access_error</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">esfr1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">epcr0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">esr0</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">siginfo_t</span> <span class="n">info</span><span class="p">;</span>

	<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;-- Insn Access Error --</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;EPCR0 : %08lx</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;ESR0  : %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">epcr0</span><span class="p">,</span> <span class="n">esr0</span><span class="p">);</span>

	<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span>	<span class="o">=</span> <span class="n">SIGSEGV</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_code</span>	<span class="o">=</span> <span class="n">SEGV_ACCERR</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_errno</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="n">epcr0</span> <span class="o">&amp;</span> <span class="n">EPCR0_V</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">epcr0</span> <span class="o">&amp;</span> <span class="n">EPCR0_PC</span><span class="p">)</span> <span class="o">:</span> <span class="n">__frame</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">);</span>

	<span class="n">force_sig_info</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">si_signo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* end insn_access_error() */</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * handler for:</span>
<span class="cm"> * - illegal instruction</span>
<span class="cm"> * - privileged instruction</span>
<span class="cm"> * - unsupported trap</span>
<span class="cm"> * - debug exceptions</span>
<span class="cm"> */</span>
<span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">illegal_instruction</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">esfr1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">epcr0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">esr0</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">siginfo_t</span> <span class="n">info</span><span class="p">;</span>

	<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;-- Illegal Instruction --</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;EPCR0 : %08lx</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;ESR0  : %08lx</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;ESFR1 : %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">epcr0</span><span class="p">,</span> <span class="n">esr0</span><span class="p">,</span> <span class="n">esfr1</span><span class="p">);</span>

	<span class="n">info</span><span class="p">.</span><span class="n">si_errno</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="n">epcr0</span> <span class="o">&amp;</span> <span class="n">EPCR0_V</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">epcr0</span> <span class="o">&amp;</span> <span class="n">EPCR0_PC</span><span class="p">)</span> <span class="o">:</span> <span class="n">__frame</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">__frame</span><span class="o">-&gt;</span><span class="n">tbr</span> <span class="o">&amp;</span> <span class="n">TBR_TT</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TBR_TT_ILLEGAL_INSTR</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span>	<span class="o">=</span> <span class="n">SIGILL</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span>	<span class="o">=</span> <span class="n">ILL_ILLOPC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TBR_TT_PRIV_INSTR</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span>	<span class="o">=</span> <span class="n">SIGILL</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span>	<span class="o">=</span> <span class="n">ILL_PRVOPC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TBR_TT_TRAP2</span> <span class="p">...</span> <span class="n">TBR_TT_TRAP126</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span>	<span class="o">=</span> <span class="n">SIGILL</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span>	<span class="o">=</span> <span class="n">ILL_ILLTRP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* GDB uses &quot;tira gr0, #1&quot; as a breakpoint instruction.  */</span>
	<span class="k">case</span> <span class="n">TBR_TT_TRAP1</span>:
	<span class="k">case</span> <span class="n">TBR_TT_BREAK</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span>	<span class="o">=</span> <span class="n">SIGTRAP</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span>	<span class="o">=</span>
			<span class="p">(</span><span class="n">__frame</span><span class="o">-&gt;</span><span class="n">__status</span> <span class="o">&amp;</span> <span class="n">REG__STATUS_STEPPED</span><span class="p">)</span> <span class="o">?</span> <span class="n">TRAP_TRACE</span> <span class="o">:</span> <span class="n">TRAP_BRKPT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">force_sig_info</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">si_signo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* end illegal_instruction() */</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * handle atomic operations with errors</span>
<span class="cm"> * - arguments in gr8, gr9, gr10</span>
<span class="cm"> * - original memory value placed in gr5</span>
<span class="cm"> * - replacement memory value placed in gr9</span>
<span class="cm"> */</span>
<span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">atomic_operation</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">esfr1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">epcr0</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">esr0</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">atomic_op_lock</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">mm_segment_t</span> <span class="n">oldfs</span><span class="p">;</span>
	<span class="n">siginfo_t</span> <span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">oldfs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">user_mode</span><span class="p">(</span><span class="n">__frame</span><span class="p">))</span>
		<span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">__frame</span><span class="o">-&gt;</span><span class="n">tbr</span> <span class="o">&amp;</span> <span class="n">TBR_TT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* TIRA gr0,#120</span>
<span class="cm">		 * u32 __atomic_user_cmpxchg32(u32 *ptr, u32 test, u32 new)</span>
<span class="cm">		 */</span>
	<span class="k">case</span> <span class="n">TBR_TT_ATOMIC_CMPXCHG32</span>:
		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">__frame</span><span class="o">-&gt;</span><span class="n">gr8</span><span class="p">;</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">__frame</span><span class="o">-&gt;</span><span class="n">gr9</span><span class="p">;</span>
		<span class="n">y</span> <span class="o">=</span> <span class="n">__frame</span><span class="o">-&gt;</span><span class="n">gr10</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">z</span> <span class="o">!=</span> <span class="n">x</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atomic_op_lock</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">__get_user</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">z</span> <span class="o">!=</span> <span class="n">x</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">done2</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">__put_user</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">done2</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">error2</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atomic_op_lock</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* TIRA gr0,#121</span>
<span class="cm">		 * u32 __atomic_kernel_xchg32(void *v, u32 new)</span>
<span class="cm">		 */</span>
	<span class="k">case</span> <span class="n">TBR_TT_ATOMIC_XCHG32</span>:
		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">__frame</span><span class="o">-&gt;</span><span class="n">gr8</span><span class="p">;</span>
		<span class="n">y</span> <span class="o">=</span> <span class="n">__frame</span><span class="o">-&gt;</span><span class="n">gr9</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atomic_op_lock</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">__get_user</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">__put_user</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">done2</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">error2</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atomic_op_lock</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* TIRA gr0,#122</span>
<span class="cm">		 * ulong __atomic_kernel_XOR_return(ulong i, ulong *v)</span>
<span class="cm">		 */</span>
	<span class="k">case</span> <span class="n">TBR_TT_ATOMIC_XOR</span>:
		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">__frame</span><span class="o">-&gt;</span><span class="n">gr8</span><span class="p">;</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">__frame</span><span class="o">-&gt;</span><span class="n">gr9</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atomic_op_lock</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">__get_user</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">y</span> <span class="o">=</span> <span class="n">x</span> <span class="o">^</span> <span class="n">z</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">__put_user</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">done2</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">error2</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atomic_op_lock</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* TIRA gr0,#123</span>
<span class="cm">		 * ulong __atomic_kernel_OR_return(ulong i, ulong *v)</span>
<span class="cm">		 */</span>
	<span class="k">case</span> <span class="n">TBR_TT_ATOMIC_OR</span>:
		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">__frame</span><span class="o">-&gt;</span><span class="n">gr8</span><span class="p">;</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">__frame</span><span class="o">-&gt;</span><span class="n">gr9</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atomic_op_lock</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">__get_user</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">y</span> <span class="o">=</span> <span class="n">x</span> <span class="o">^</span> <span class="n">z</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">__put_user</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">done2</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">error2</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atomic_op_lock</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* TIRA gr0,#124</span>
<span class="cm">		 * ulong __atomic_kernel_AND_return(ulong i, ulong *v)</span>
<span class="cm">		 */</span>
	<span class="k">case</span> <span class="n">TBR_TT_ATOMIC_AND</span>:
		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">__frame</span><span class="o">-&gt;</span><span class="n">gr8</span><span class="p">;</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">__frame</span><span class="o">-&gt;</span><span class="n">gr9</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atomic_op_lock</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">__get_user</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">y</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&amp;</span> <span class="n">z</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">__put_user</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">done2</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">error2</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atomic_op_lock</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* TIRA gr0,#125</span>
<span class="cm">		 * int __atomic_user_sub_return(atomic_t *v, int i)</span>
<span class="cm">		 */</span>
	<span class="k">case</span> <span class="n">TBR_TT_ATOMIC_SUB</span>:
		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">__frame</span><span class="o">-&gt;</span><span class="n">gr8</span><span class="p">;</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">__frame</span><span class="o">-&gt;</span><span class="n">gr9</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atomic_op_lock</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">__get_user</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">y</span> <span class="o">=</span> <span class="n">z</span> <span class="o">-</span> <span class="n">x</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">__put_user</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">done2</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">error2</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atomic_op_lock</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* TIRA gr0,#126</span>
<span class="cm">		 * int __atomic_user_add_return(atomic_t *v, int i)</span>
<span class="cm">		 */</span>
	<span class="k">case</span> <span class="n">TBR_TT_ATOMIC_ADD</span>:
		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">__frame</span><span class="o">-&gt;</span><span class="n">gr8</span><span class="p">;</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">__frame</span><span class="o">-&gt;</span><span class="n">gr9</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atomic_op_lock</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">__get_user</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">y</span> <span class="o">=</span> <span class="n">z</span> <span class="o">+</span> <span class="n">x</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">__put_user</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">done2</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">error2</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atomic_op_lock</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

<span class="nl">done2:</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atomic_op_lock</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">user_mode</span><span class="p">(</span><span class="n">__frame</span><span class="p">))</span>
		<span class="n">set_fs</span><span class="p">(</span><span class="n">oldfs</span><span class="p">);</span>
	<span class="n">__frame</span><span class="o">-&gt;</span><span class="n">gr5</span> <span class="o">=</span> <span class="n">z</span><span class="p">;</span>
	<span class="n">__frame</span><span class="o">-&gt;</span><span class="n">gr9</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">error2:</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atomic_op_lock</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">user_mode</span><span class="p">(</span><span class="n">__frame</span><span class="p">))</span>
		<span class="n">set_fs</span><span class="p">(</span><span class="n">oldfs</span><span class="p">);</span>
	<span class="n">__frame</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;-- Atomic Op Error --</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span>	<span class="o">=</span> <span class="n">SIGSEGV</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_code</span>	<span class="o">=</span> <span class="n">SEGV_ACCERR</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_errno</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">__frame</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">;</span>

	<span class="n">force_sig_info</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">si_signo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">media_exception</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">msr0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">msr1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">siginfo_t</span> <span class="n">info</span><span class="p">;</span>

	<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;-- Media Exception --</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;MSR0 : %08lx</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;MSR1 : %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">msr0</span><span class="p">,</span> <span class="n">msr1</span><span class="p">);</span>

	<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span>	<span class="o">=</span> <span class="n">SIGFPE</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_code</span>	<span class="o">=</span> <span class="n">FPE_MDAOVF</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_errno</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">__frame</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">;</span>

	<span class="n">force_sig_info</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">si_signo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* end media_exception() */</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * instruction or data access exception</span>
<span class="cm"> */</span>
<span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">memory_access_exception</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">esr0</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ear0</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">epcr0</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">siginfo_t</span> <span class="n">info</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_MMU</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fixup</span><span class="p">;</span>

	<span class="n">fixup</span> <span class="o">=</span> <span class="n">search_exception_table</span><span class="p">(</span><span class="n">__frame</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fixup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__frame</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">=</span> <span class="n">fixup</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;-- Memory Access Exception --</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;ESR0  : %08lx</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;EAR0  : %08lx</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;EPCR0 : %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">esr0</span><span class="p">,</span> <span class="n">ear0</span><span class="p">,</span> <span class="n">epcr0</span><span class="p">);</span>

	<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span>	<span class="o">=</span> <span class="n">SIGSEGV</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_code</span>	<span class="o">=</span> <span class="n">SEGV_ACCERR</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_errno</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">esr0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ESRx_VALID</span> <span class="o">|</span> <span class="n">ESR0_EAV</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="n">ESRx_VALID</span> <span class="o">|</span> <span class="n">ESR0_EAV</span><span class="p">))</span>
		<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">ear0</span><span class="p">;</span>

	<span class="n">force_sig_info</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">si_signo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>

<span class="p">}</span> <span class="cm">/* end memory_access_exception() */</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * data access error</span>
<span class="cm"> * - double-word data load from CPU control area (0xFExxxxxx)</span>
<span class="cm"> * - read performed on inactive or self-refreshing SDRAM</span>
<span class="cm"> * - error notification from slave device</span>
<span class="cm"> * - misaligned address</span>
<span class="cm"> * - access to out of bounds memory region</span>
<span class="cm"> * - user mode accessing privileged memory region</span>
<span class="cm"> * - write to R/O memory region</span>
<span class="cm"> */</span>
<span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">data_access_error</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">esfr1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">esr15</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ear15</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">siginfo_t</span> <span class="n">info</span><span class="p">;</span>

	<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;-- Data Access Error --</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;ESR15 : %08lx</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;EAR15 : %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">esr15</span><span class="p">,</span> <span class="n">ear15</span><span class="p">);</span>

	<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span>	<span class="o">=</span> <span class="n">SIGSEGV</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_code</span>	<span class="o">=</span> <span class="n">SEGV_ACCERR</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_errno</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">(((</span><span class="n">esr15</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ESRx_VALID</span><span class="o">|</span><span class="n">ESR15_EAV</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="n">ESRx_VALID</span><span class="o">|</span><span class="n">ESR15_EAV</span><span class="p">))</span> <span class="o">?</span> <span class="n">ear15</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">force_sig_info</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">si_signo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* end data_access_error() */</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * data store error - should only happen if accessing inactive or self-refreshing SDRAM</span>
<span class="cm"> */</span>
<span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">data_store_error</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">esfr1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">esr15</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;-- Data Store Error --</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;ESR15 : %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">esr15</span><span class="p">);</span>
	<span class="n">BUG</span><span class="p">();</span>
<span class="p">}</span> <span class="cm">/* end data_store_error() */</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">division_exception</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">esfr1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">esr0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">isr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">siginfo_t</span> <span class="n">info</span><span class="p">;</span>

	<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;-- Division Exception --</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;ESR0 : %08lx</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;ISR  : %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">esr0</span><span class="p">,</span> <span class="n">isr</span><span class="p">);</span>

	<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span>	<span class="o">=</span> <span class="n">SIGFPE</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_code</span>	<span class="o">=</span> <span class="n">FPE_INTDIV</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_errno</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">__frame</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">;</span>

	<span class="n">force_sig_info</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">si_signo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* end division_exception() */</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">compound_exception</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">esfr1</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">esr0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">esr14</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">esr15</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">msr0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">msr1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;-- Compound Exception --</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;ESR0  : %08lx</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;ESR15 : %08lx</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;ESR15 : %08lx</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;MSR0  : %08lx</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;MSR1  : %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">esr0</span><span class="p">,</span> <span class="n">esr14</span><span class="p">,</span> <span class="n">esr15</span><span class="p">,</span> <span class="n">msr0</span><span class="p">,</span> <span class="n">msr1</span><span class="p">);</span>
	<span class="n">BUG</span><span class="p">();</span>
<span class="p">}</span> <span class="cm">/* end compound_exception() */</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * The architecture-independent backtrace generator</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">dump_stack</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">show_stack</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dump_stack</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">show_stack</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">show_trace_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">tsk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;CONTEXT: stack=0x%lx frame=0x%p LR=0x%lx RET=0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">tsk</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">sp</span><span class="p">,</span> <span class="n">tsk</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">frame</span><span class="p">,</span> <span class="n">tsk</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">lr</span><span class="p">,</span> <span class="n">tsk</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">sched_lr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">regnames</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;PSR &quot;</span><span class="p">,</span> <span class="s">&quot;ISR &quot;</span><span class="p">,</span> <span class="s">&quot;CCR &quot;</span><span class="p">,</span> <span class="s">&quot;CCCR&quot;</span><span class="p">,</span>
	<span class="s">&quot;LR  &quot;</span><span class="p">,</span> <span class="s">&quot;LCR &quot;</span><span class="p">,</span> <span class="s">&quot;PC  &quot;</span><span class="p">,</span> <span class="s">&quot;_stt&quot;</span><span class="p">,</span>
	<span class="s">&quot;sys &quot;</span><span class="p">,</span> <span class="s">&quot;GR8*&quot;</span><span class="p">,</span> <span class="s">&quot;GNE0&quot;</span><span class="p">,</span> <span class="s">&quot;GNE1&quot;</span><span class="p">,</span>
	<span class="s">&quot;IACH&quot;</span><span class="p">,</span> <span class="s">&quot;IACL&quot;</span><span class="p">,</span>
	<span class="s">&quot;TBR &quot;</span><span class="p">,</span> <span class="s">&quot;SP  &quot;</span><span class="p">,</span> <span class="s">&quot;FP  &quot;</span><span class="p">,</span> <span class="s">&quot;GR3 &quot;</span><span class="p">,</span>
	<span class="s">&quot;GR4 &quot;</span><span class="p">,</span> <span class="s">&quot;GR5 &quot;</span><span class="p">,</span> <span class="s">&quot;GR6 &quot;</span><span class="p">,</span> <span class="s">&quot;GR7 &quot;</span><span class="p">,</span>
	<span class="s">&quot;GR8 &quot;</span><span class="p">,</span> <span class="s">&quot;GR9 &quot;</span><span class="p">,</span> <span class="s">&quot;GR10&quot;</span><span class="p">,</span> <span class="s">&quot;GR11&quot;</span><span class="p">,</span>
	<span class="s">&quot;GR12&quot;</span><span class="p">,</span> <span class="s">&quot;GR13&quot;</span><span class="p">,</span> <span class="s">&quot;GR14&quot;</span><span class="p">,</span> <span class="s">&quot;GR15&quot;</span><span class="p">,</span>
	<span class="s">&quot;GR16&quot;</span><span class="p">,</span> <span class="s">&quot;GR17&quot;</span><span class="p">,</span> <span class="s">&quot;GR18&quot;</span><span class="p">,</span> <span class="s">&quot;GR19&quot;</span><span class="p">,</span>
	<span class="s">&quot;GR20&quot;</span><span class="p">,</span> <span class="s">&quot;GR21&quot;</span><span class="p">,</span> <span class="s">&quot;GR22&quot;</span><span class="p">,</span> <span class="s">&quot;GR23&quot;</span><span class="p">,</span>
	<span class="s">&quot;GR24&quot;</span><span class="p">,</span> <span class="s">&quot;GR25&quot;</span><span class="p">,</span> <span class="s">&quot;GR26&quot;</span><span class="p">,</span> <span class="s">&quot;GR27&quot;</span><span class="p">,</span>
	<span class="s">&quot;EFRM&quot;</span><span class="p">,</span> <span class="s">&quot;CURR&quot;</span><span class="p">,</span> <span class="s">&quot;GR30&quot;</span><span class="p">,</span> <span class="s">&quot;BFRM&quot;</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">show_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loop</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Frame: @%08lx [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">regs</span><span class="p">,</span>
	       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">psr</span> <span class="o">&amp;</span> <span class="n">PSR_S</span> <span class="o">?</span> <span class="s">&quot;kernel&quot;</span> <span class="o">:</span> <span class="s">&quot;user&quot;</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;</span> <span class="n">NR_PT_REGS</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s %08lx&quot;</span><span class="p">,</span> <span class="n">regnames</span><span class="p">[</span><span class="n">loop</span> <span class="o">+</span> <span class="mi">0</span><span class="p">],</span> <span class="n">reg</span><span class="p">[</span><span class="n">loop</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">loop</span> <span class="o">==</span> <span class="n">NR_PT_REGS</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">loop</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; | &quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Process %s (pid: %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">die_if_kernel</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="kt">va_list</span> <span class="n">va</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">user_mode</span><span class="p">(</span><span class="n">__frame</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">va</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
	<span class="n">vsprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">va</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">va</span><span class="p">);</span>

	<span class="n">console_verbose</span><span class="p">();</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">===================================</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
	<span class="n">show_backtrace</span><span class="p">(</span><span class="n">__frame</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">__break_hijack_kernel_event</span><span class="p">();</span>
	<span class="n">do_exit</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * dump the contents of an exception frame</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">show_backtrace_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">frame</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loop</span><span class="p">;</span>

	<span class="cm">/* print the registers for this frame */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;&lt;-- %s Frame: @%p --&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">frame</span><span class="o">-&gt;</span><span class="n">psr</span> <span class="o">&amp;</span> <span class="n">PSR_S</span> <span class="o">?</span> <span class="s">&quot;Kernel Mode&quot;</span> <span class="o">:</span> <span class="s">&quot;User Mode&quot;</span><span class="p">,</span>
	       <span class="n">frame</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">frame</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;</span> <span class="n">NR_PT_REGS</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s %08lx&quot;</span><span class="p">,</span> <span class="n">regnames</span><span class="p">[</span><span class="n">loop</span> <span class="o">+</span> <span class="mi">0</span><span class="p">],</span> <span class="n">reg</span><span class="p">[</span><span class="n">loop</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">loop</span> <span class="o">==</span> <span class="n">NR_PT_REGS</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">loop</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; | &quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;--------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* end show_backtrace_regs() */</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * generate a backtrace of the kernel stack</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">show_backtrace</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">frame</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">frame0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">format</span><span class="p">;</span>

	<span class="n">base</span> <span class="o">=</span> <span class="p">((((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">frame</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8191</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">8191</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">user_context</span><span class="p">);</span>
	<span class="n">frame0</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">)</span> <span class="n">base</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tos</span> <span class="o">=</span> <span class="n">sp</span><span class="p">;</span>
		<span class="n">stop</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">frame</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Process %s (pid: %d)</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="cm">/* dump stack segment between frames */</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>printk("%08lx -> %08lx\n", tos, stop);</p></td><td class="code"><div class="highlight"><pre>		<span class="n">format</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">tos</span> <span class="o">&lt;</span> <span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">format</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %04lx :&quot;</span><span class="p">,</span> <span class="n">tos</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>

			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %08lx&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">tos</span><span class="p">);</span>

			<span class="n">tos</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">format</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">format</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">format</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">format</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* dump frame 0 outside of the loop */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frame</span> <span class="o">==</span> <span class="n">frame0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">tos</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">sp</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">frame</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">frame</span><span class="p">)</span> <span class="o">!=</span> <span class="n">tos</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;-- TOS %08lx does not follow frame %p --</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">tos</span><span class="p">,</span> <span class="n">frame</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">show_backtrace_regs</span><span class="p">(</span><span class="n">frame</span><span class="p">);</span>

		<span class="cm">/* dump the stack between this frame and the next */</span>
		<span class="n">stop</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">next_frame</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stop</span> <span class="o">!=</span> <span class="n">base</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">stop</span> <span class="o">&lt;</span> <span class="n">tos</span> <span class="o">||</span>
		     <span class="n">stop</span> <span class="o">&gt;</span> <span class="n">base</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">stop</span> <span class="o">&lt;</span> <span class="n">base</span> <span class="o">&amp;&amp;</span> <span class="n">stop</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">frame</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">base</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">stop</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;-- next_frame %08lx is invalid (range %08lx-%08lx) --</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">stop</span><span class="p">,</span> <span class="n">tos</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* move to next frame */</span>
		<span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">next_frame</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* we can always dump frame 0, even if the rest of the stack is corrupt */</span>
	<span class="n">show_backtrace_regs</span><span class="p">(</span><span class="n">frame0</span><span class="p">);</span>

<span class="p">}</span> <span class="cm">/* end show_backtrace() */</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * initialise traps</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">trap_init</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span> <span class="cm">/* end trap_init() */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
