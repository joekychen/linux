<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › frv › kernel › gdb-stub.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>gdb-stub.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* gdb-stub.c: FRV GDB stub</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2003,4 Red Hat, Inc. All Rights Reserved.</span>
<span class="cm"> * Written by David Howells (dhowells@redhat.com)</span>
<span class="cm"> * - Derived from Linux/MIPS version, Copyright (C) 1995 Andreas Busse</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version</span>
<span class="cm"> * 2 of the License, or (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *  To enable debugger support, two things need to happen.  One, a</span>
<span class="cm"> *  call to set_debug_traps() is necessary in order to allow any breakpoints</span>
<span class="cm"> *  or error conditions to be properly intercepted and reported to gdb.</span>
<span class="cm"> *  Two, a breakpoint needs to be generated to begin communication.  This</span>
<span class="cm"> *  is most easily accomplished by a call to breakpoint().  Breakpoint()</span>
<span class="cm"> *  simulates a breakpoint by executing a BREAK instruction.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *    The following gdb commands are supported:</span>
<span class="cm"> *</span>
<span class="cm"> * command          function                               Return value</span>
<span class="cm"> *</span>
<span class="cm"> *    g             return the value of the CPU registers  hex data or ENN</span>
<span class="cm"> *    G             set the value of the CPU registers     OK or ENN</span>
<span class="cm"> *</span>
<span class="cm"> *    mAA..AA,LLLL  Read LLLL bytes at address AA..AA      hex data or ENN</span>
<span class="cm"> *    MAA..AA,LLLL: Write LLLL bytes at address AA.AA      OK or ENN</span>
<span class="cm"> *</span>
<span class="cm"> *    c             Resume at current address              SNN   ( signal NN)</span>
<span class="cm"> *    cAA..AA       Continue at address AA..AA             SNN</span>
<span class="cm"> *</span>
<span class="cm"> *    s             Step one instruction                   SNN</span>
<span class="cm"> *    sAA..AA       Step one instruction from AA..AA       SNN</span>
<span class="cm"> *</span>
<span class="cm"> *    k             kill</span>
<span class="cm"> *</span>
<span class="cm"> *    ?             What was the last sigval ?             SNN   (signal NN)</span>
<span class="cm"> *</span>
<span class="cm"> *    bBB..BB	    Set baud rate to BB..BB		   OK or BNN, then sets</span>
<span class="cm"> *							   baud rate</span>
<span class="cm"> *</span>
<span class="cm"> * All commands and responses are sent with a packet which includes a</span>
<span class="cm"> * checksum.  A packet consists of</span>
<span class="cm"> *</span>
<span class="cm"> * $&lt;packet info&gt;#&lt;checksum&gt;.</span>
<span class="cm"> *</span>
<span class="cm"> * where</span>
<span class="cm"> * &lt;packet info&gt; :: &lt;characters representing the command or response&gt;</span>
<span class="cm"> * &lt;checksum&gt;    :: &lt; two hex digits computed as modulo 256 sum of &lt;packetinfo&gt;&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * When a packet is received, it is first acknowledged with either &#39;+&#39; or &#39;-&#39;.</span>
<span class="cm"> * &#39;+&#39; indicates a successful transfer.  &#39;-&#39; indicates a failed transfer.</span>
<span class="cm"> *</span>
<span class="cm"> * Example:</span>
<span class="cm"> *</span>
<span class="cm"> * Host:                  Reply:</span>
<span class="cm"> * $m0,10#2a               +$00010203040506070809101112131415#42</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *  ==============</span>
<span class="cm"> *  MORE EXAMPLES:</span>
<span class="cm"> *  ==============</span>
<span class="cm"> *</span>
<span class="cm"> *  For reference -- the following are the steps that one</span>
<span class="cm"> *  company took (RidgeRun Inc) to get remote gdb debugging</span>
<span class="cm"> *  going. In this scenario the host machine was a PC and the</span>
<span class="cm"> *  target platform was a Galileo EVB64120A MIPS evaluation</span>
<span class="cm"> *  board.</span>
<span class="cm"> *</span>
<span class="cm"> *  Step 1:</span>
<span class="cm"> *  First download gdb-5.0.tar.gz from the internet.</span>
<span class="cm"> *  and then build/install the package.</span>
<span class="cm"> *</span>
<span class="cm"> *  Example:</span>
<span class="cm"> *    $ tar zxf gdb-5.0.tar.gz</span>
<span class="cm"> *    $ cd gdb-5.0</span>
<span class="cm"> *    $ ./configure --target=frv-elf-gdb</span>
<span class="cm"> *    $ make</span>
<span class="cm"> *    $ frv-elf-gdb</span>
<span class="cm"> *</span>
<span class="cm"> *  Step 2:</span>
<span class="cm"> *  Configure linux for remote debugging and build it.</span>
<span class="cm"> *</span>
<span class="cm"> *  Example:</span>
<span class="cm"> *    $ cd ~/linux</span>
<span class="cm"> *    $ make menuconfig &lt;go to &quot;Kernel Hacking&quot; and turn on remote debugging&gt;</span>
<span class="cm"> *    $ make vmlinux</span>
<span class="cm"> *</span>
<span class="cm"> *  Step 3:</span>
<span class="cm"> *  Download the kernel to the remote target and start</span>
<span class="cm"> *  the kernel running. It will promptly halt and wait</span>
<span class="cm"> *  for the host gdb session to connect. It does this</span>
<span class="cm"> *  since the &quot;Kernel Hacking&quot; option has defined</span>
<span class="cm"> *  CONFIG_REMOTE_DEBUG which in turn enables your calls</span>
<span class="cm"> *  to:</span>
<span class="cm"> *     set_debug_traps();</span>
<span class="cm"> *     breakpoint();</span>
<span class="cm"> *</span>
<span class="cm"> *  Step 4:</span>
<span class="cm"> *  Start the gdb session on the host.</span>
<span class="cm"> *</span>
<span class="cm"> *  Example:</span>
<span class="cm"> *    $ frv-elf-gdb vmlinux</span>
<span class="cm"> *    (gdb) set remotebaud 115200</span>
<span class="cm"> *    (gdb) target remote /dev/ttyS1</span>
<span class="cm"> *    ...at this point you are connected to</span>
<span class="cm"> *       the remote target and can use gdb</span>
<span class="cm"> *       in the normal fasion. Setting</span>
<span class="cm"> *       breakpoints, single stepping,</span>
<span class="cm"> *       printing variables, etc.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/signal.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/nmi.h&gt;</span>

<span class="cp">#include &lt;asm/asm-offsets.h&gt;</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#include &lt;asm/gdb-stub.h&gt;</span>

<span class="cp">#define LEDS(x) do { </span><span class="cm">/* *(u32*)0xe1200004 = ~(x); mb(); */</span><span class="cp"> } while(0)</span>

<span class="cp">#undef GDBSTUB_DEBUG_PROTOCOL</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">debug_to_serial</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">gdbstub_console_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">co</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">n</span><span class="p">);</span>

<span class="k">extern</span> <span class="k">volatile</span> <span class="kt">uint32_t</span> <span class="n">__break_error_detect</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="cm">/* ESFR1, ESR15, EAR15 */</span>

<span class="k">struct</span> <span class="n">__debug_amr</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">L</span><span class="p">,</span> <span class="n">P</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="mi">8</span><span class="p">)));</span>

<span class="k">struct</span> <span class="n">__debug_mmu</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">hsr0</span><span class="p">,</span> <span class="n">pcsr</span><span class="p">,</span> <span class="n">esr0</span><span class="p">,</span> <span class="n">ear0</span><span class="p">,</span> <span class="n">epcr0</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_MMU</span>
		<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">tplr</span><span class="p">,</span> <span class="n">tppr</span><span class="p">,</span> <span class="n">tpxr</span><span class="p">,</span> <span class="n">cxnr</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="n">regs</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">__debug_amr</span>	<span class="n">iamr</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">__debug_amr</span>	<span class="n">damr</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

<span class="cp">#ifdef CONFIG_MMU</span>
	<span class="k">struct</span> <span class="n">__debug_amr</span>	<span class="n">tlb</span><span class="p">[</span><span class="mi">64</span><span class="o">*</span><span class="mi">2</span><span class="p">];</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">__debug_mmu</span> <span class="n">__debug_mmu</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * BUFMAX defines the maximum number of characters in inbound/outbound buffers</span>
<span class="cm"> * at least NUMREGBYTES*2 are needed for register packets</span>
<span class="cm"> */</span>
<span class="cp">#define BUFMAX 2048</span>

<span class="cp">#define BREAK_INSN	0x801000c0	</span><span class="cm">/* use &quot;break&quot; as bkpt */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">gdbstub_banner</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;Linux/FR-V GDB Stub (c) RedHat 2003</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="k">volatile</span> <span class="n">u8</span>	<span class="n">gdbstub_rx_buffer</span><span class="p">[</span><span class="n">PAGE_SIZE</span><span class="p">]</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">)));</span>
<span class="k">volatile</span> <span class="n">u32</span>	<span class="n">gdbstub_rx_inp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">volatile</span> <span class="n">u32</span>	<span class="n">gdbstub_rx_outp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">volatile</span> <span class="n">u8</span>	<span class="n">gdbstub_rx_overflow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">u8</span>		<span class="n">gdbstub_rx_unget</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/* set with GDB whilst running to permit step through exceptions */</span>
<span class="k">extern</span> <span class="k">volatile</span> <span class="n">u32</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">section</span><span class="p">(</span><span class="s">&quot;.bss&quot;</span><span class="p">)))</span> <span class="n">gdbstub_trace_through_exceptions</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">char</span>	<span class="n">input_buffer</span><span class="p">[</span><span class="n">BUFMAX</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">char</span>	<span class="n">output_buffer</span><span class="p">[</span><span class="n">BUFMAX</span><span class="p">];</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">regnames</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;PSR &quot;</span><span class="p">,</span> <span class="s">&quot;ISR &quot;</span><span class="p">,</span> <span class="s">&quot;CCR &quot;</span><span class="p">,</span> <span class="s">&quot;CCCR&quot;</span><span class="p">,</span>
	<span class="s">&quot;LR  &quot;</span><span class="p">,</span> <span class="s">&quot;LCR &quot;</span><span class="p">,</span> <span class="s">&quot;PC  &quot;</span><span class="p">,</span> <span class="s">&quot;_stt&quot;</span><span class="p">,</span>
	<span class="s">&quot;sys &quot;</span><span class="p">,</span> <span class="s">&quot;GR8*&quot;</span><span class="p">,</span> <span class="s">&quot;GNE0&quot;</span><span class="p">,</span> <span class="s">&quot;GNE1&quot;</span><span class="p">,</span>
	<span class="s">&quot;IACH&quot;</span><span class="p">,</span> <span class="s">&quot;IACL&quot;</span><span class="p">,</span>
	<span class="s">&quot;TBR &quot;</span><span class="p">,</span> <span class="s">&quot;SP  &quot;</span><span class="p">,</span> <span class="s">&quot;FP  &quot;</span><span class="p">,</span> <span class="s">&quot;GR3 &quot;</span><span class="p">,</span>
	<span class="s">&quot;GR4 &quot;</span><span class="p">,</span> <span class="s">&quot;GR5 &quot;</span><span class="p">,</span> <span class="s">&quot;GR6 &quot;</span><span class="p">,</span> <span class="s">&quot;GR7 &quot;</span><span class="p">,</span>
	<span class="s">&quot;GR8 &quot;</span><span class="p">,</span> <span class="s">&quot;GR9 &quot;</span><span class="p">,</span> <span class="s">&quot;GR10&quot;</span><span class="p">,</span> <span class="s">&quot;GR11&quot;</span><span class="p">,</span>
	<span class="s">&quot;GR12&quot;</span><span class="p">,</span> <span class="s">&quot;GR13&quot;</span><span class="p">,</span> <span class="s">&quot;GR14&quot;</span><span class="p">,</span> <span class="s">&quot;GR15&quot;</span><span class="p">,</span>
	<span class="s">&quot;GR16&quot;</span><span class="p">,</span> <span class="s">&quot;GR17&quot;</span><span class="p">,</span> <span class="s">&quot;GR18&quot;</span><span class="p">,</span> <span class="s">&quot;GR19&quot;</span><span class="p">,</span>
	<span class="s">&quot;GR20&quot;</span><span class="p">,</span> <span class="s">&quot;GR21&quot;</span><span class="p">,</span> <span class="s">&quot;GR22&quot;</span><span class="p">,</span> <span class="s">&quot;GR23&quot;</span><span class="p">,</span>
	<span class="s">&quot;GR24&quot;</span><span class="p">,</span> <span class="s">&quot;GR25&quot;</span><span class="p">,</span> <span class="s">&quot;GR26&quot;</span><span class="p">,</span> <span class="s">&quot;GR27&quot;</span><span class="p">,</span>
	<span class="s">&quot;EFRM&quot;</span><span class="p">,</span> <span class="s">&quot;CURR&quot;</span><span class="p">,</span> <span class="s">&quot;GR30&quot;</span><span class="p">,</span> <span class="s">&quot;BFRM&quot;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">gdbstub_bkpt</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">addr</span><span class="p">;</span>		<span class="cm">/* address of breakpoint */</span>
	<span class="kt">unsigned</span>	<span class="n">len</span><span class="p">;</span>		<span class="cm">/* size of breakpoint */</span>
	<span class="kt">uint32_t</span>	<span class="n">originsns</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>	<span class="cm">/* original instructions */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gdbstub_bkpt</span> <span class="n">gdbstub_bkpts</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

<span class="cm">/*</span>
<span class="cm"> * local prototypes</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">gdbstub_recv_packet</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gdbstub_send_packet</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gdbstub_compute_signal</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tbr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hex</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hexToInt</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">intValue</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mem2hex</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">mem</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">may_fault</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hex2mem</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_mem</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Convert ch from a hex digit to an int</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hex</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&gt;=</span> <span class="sc">&#39;a&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span> <span class="o">&lt;=</span> <span class="sc">&#39;f&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ch</span><span class="o">-</span><span class="sc">&#39;a&#39;</span><span class="o">+</span><span class="mi">10</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ch</span><span class="o">-</span><span class="sc">&#39;0&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&gt;=</span> <span class="sc">&#39;A&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span> <span class="o">&lt;=</span> <span class="sc">&#39;F&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ch</span><span class="o">-</span><span class="sc">&#39;A&#39;</span><span class="o">+</span><span class="mi">10</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gdbstub_printk</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="cm">/* Emit the output into the temporary buffer */</span>
	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">vsnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
	<span class="n">debug_to_serial</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">gdbstub_strcpy</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">dst</span><span class="p">[</span><span class="n">loop</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="n">loop</span><span class="p">]))</span>
	       <span class="n">loop</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dst</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gdbstub_purge_cache</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;	dcef	@(gr0,gr0),#1	</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;	icei	@(gr0,gr0),#1	</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;	membar			</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;	bar			</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * scan for the sequence $&lt;data&gt;#&lt;checksum&gt;</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gdbstub_recv_packet</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">checksum</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">xmitcsum</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="cm">/* wait around for the start character, ignore all other characters */</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">gdbstub_rx_char</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ch</span> <span class="o">!=</span> <span class="sc">&#39;$&#39;</span><span class="p">);</span>

		<span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">xmitcsum</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* now, read until a # or end of buffer is found */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">BUFMAX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">gdbstub_rx_char</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">error</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">&#39;#&#39;</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">checksum</span> <span class="o">+=</span> <span class="n">ch</span><span class="p">;</span>
			<span class="n">buffer</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gdbstub_proto</span><span class="p">(</span><span class="s">&quot;### GDB Rx Error - Skipping packet ###</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">gdbstub_proto</span><span class="p">(</span><span class="s">&quot;### GDB Tx NAK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">gdbstub_tx_char</span><span class="p">(</span><span class="sc">&#39;-&#39;</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">BUFMAX</span> <span class="o">||</span> <span class="n">error</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">buffer</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* read the checksum */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gdbstub_rx_char</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">xmitcsum</span> <span class="o">=</span> <span class="n">hex</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">gdbstub_rx_char</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">xmitcsum</span> <span class="o">|=</span> <span class="n">hex</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span>
				<span class="n">gdbstub_proto</span><span class="p">(</span><span class="s">&quot;### GDB Rx Error - Skipping packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">gdbstub_proto</span><span class="p">(</span><span class="s">&quot;### GDB Tx NAK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">gdbstub_tx_char</span><span class="p">(</span><span class="sc">&#39;-&#39;</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* check the checksum */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">checksum</span> <span class="o">!=</span> <span class="n">xmitcsum</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gdbstub_proto</span><span class="p">(</span><span class="s">&quot;### GDB Tx NAK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">gdbstub_tx_char</span><span class="p">(</span><span class="sc">&#39;-&#39;</span><span class="p">);</span>	<span class="cm">/* failed checksum */</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">gdbstub_proto</span><span class="p">(</span><span class="s">&quot;### GDB Rx &#39;$%s#%02x&#39; ###</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">checksum</span><span class="p">);</span>
		<span class="n">gdbstub_proto</span><span class="p">(</span><span class="s">&quot;### GDB Tx ACK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">gdbstub_tx_char</span><span class="p">(</span><span class="sc">&#39;+&#39;</span><span class="p">);</span> <span class="cm">/* successful transfer */</span>

		<span class="cm">/* if a sequence char is present, reply the sequence ID */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gdbstub_tx_char</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">gdbstub_tx_char</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

			<span class="cm">/* remove sequence chars from buffer */</span>
			<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">count</span><span class="p">])</span> <span class="n">count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">buffer</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span> <span class="cm">/* end gdbstub_recv_packet() */</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * send the packet in buffer.</span>
<span class="cm"> * - return 0 if successfully ACK&#39;d</span>
<span class="cm"> * - return 1 if abandoned due to new incoming packet</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gdbstub_send_packet</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">checksum</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>

	<span class="cm">/* $&lt;packet info&gt;#&lt;checksum&gt; */</span>
	<span class="n">gdbstub_proto</span><span class="p">(</span><span class="s">&quot;### GDB Tx &#39;%s&#39; ###</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">gdbstub_tx_char</span><span class="p">(</span><span class="sc">&#39;$&#39;</span><span class="p">);</span>
		<span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">((</span><span class="n">ch</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">count</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gdbstub_tx_char</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
			<span class="n">checksum</span> <span class="o">+=</span> <span class="n">ch</span><span class="p">;</span>
			<span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">gdbstub_tx_char</span><span class="p">(</span><span class="sc">&#39;#&#39;</span><span class="p">);</span>
		<span class="n">gdbstub_tx_char</span><span class="p">(</span><span class="n">hex_asc_hi</span><span class="p">(</span><span class="n">checksum</span><span class="p">));</span>
		<span class="n">gdbstub_tx_char</span><span class="p">(</span><span class="n">hex_asc_lo</span><span class="p">(</span><span class="n">checksum</span><span class="p">));</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">gdbstub_rx_char</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
<span class="cp">#ifdef GDBSTUB_DEBUG_PROTOCOL</span>
		 <span class="n">ch</span><span class="o">==</span><span class="sc">&#39;-&#39;</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">gdbstub_proto</span><span class="p">(</span><span class="s">&quot;### GDB Rx NAK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">),</span><span class="mi">0</span><span class="p">),</span>
		 <span class="n">ch</span><span class="o">!=</span><span class="sc">&#39;-&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span><span class="o">!=</span><span class="sc">&#39;+&#39;</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">gdbstub_proto</span><span class="p">(</span><span class="s">&quot;### GDB Rx ??? %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">ch</span><span class="p">),</span><span class="mi">0</span><span class="p">),</span>
<span class="cp">#endif</span>
		 <span class="n">ch</span><span class="o">!=</span><span class="sc">&#39;+&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span><span class="o">!=</span><span class="sc">&#39;$&#39;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">==</span><span class="sc">&#39;+&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gdbstub_proto</span><span class="p">(</span><span class="s">&quot;### GDB Rx ACK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gdbstub_proto</span><span class="p">(</span><span class="s">&quot;### GDB Tx Abandoned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">gdbstub_rx_unget</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end gdbstub_send_packet() */</span>

<span class="cm">/*</span>
<span class="cm"> * While we find nice hex chars, build an int.</span>
<span class="cm"> * Return number of chars processed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hexToInt</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">_value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ch</span><span class="p">;</span>

	<span class="o">*</span><span class="n">_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">**</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ch</span> <span class="o">=</span> <span class="n">hex</span><span class="p">(</span><span class="o">**</span><span class="n">ptr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="o">*</span><span class="n">_value</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">_value</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="n">ch</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>

		<span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * probe an address to see whether it maps to anything</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">gdbstub_addr_probe</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">vaddr</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_MMU</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">paddr</span><span class="p">;</span>

	<span class="n">asm</span><span class="p">(</span><span class="s">&quot;lrad %1,%0,#1,#0,#0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">paddr</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">vaddr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">paddr</span> <span class="o">&amp;</span> <span class="n">xAMPRx_V</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end gdbstub_addr_probe() */</span>

<span class="cp">#ifdef CONFIG_MMU</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__saved_dampr</span><span class="p">,</span> <span class="n">__saved_damlr</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">gdbstub_virt_to_pte</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pgd_t</span> <span class="o">*</span><span class="n">pgd</span><span class="p">;</span>
	<span class="n">pud_t</span> <span class="o">*</span><span class="n">pud</span><span class="p">;</span>
	<span class="n">pmd_t</span> <span class="o">*</span><span class="n">pmd</span><span class="p">;</span>
	<span class="n">pte_t</span> <span class="o">*</span><span class="n">pte</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">,</span> <span class="n">dampr5</span><span class="p">;</span>

	<span class="n">pgd</span> <span class="o">=</span> <span class="p">(</span><span class="n">pgd_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">__get_DAMLR</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">pgd_index</span><span class="p">(</span><span class="n">vaddr</span><span class="p">);</span>
	<span class="n">pud</span> <span class="o">=</span> <span class="n">pud_offset</span><span class="p">(</span><span class="n">pgd</span><span class="p">,</span> <span class="n">vaddr</span><span class="p">);</span>
	<span class="n">pmd</span> <span class="o">=</span> <span class="n">pmd_offset</span><span class="p">(</span><span class="n">pud</span><span class="p">,</span> <span class="n">vaddr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pmd_bad</span><span class="p">(</span><span class="o">*</span><span class="n">pmd</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">pmd_present</span><span class="p">(</span><span class="o">*</span><span class="n">pmd</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* make sure dampr5 maps to the correct pmd */</span>
	<span class="n">dampr5</span> <span class="o">=</span> <span class="n">__get_DAMPR</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">pmd_val</span><span class="p">(</span><span class="o">*</span><span class="n">pmd</span><span class="p">);</span>
	<span class="n">__set_DAMPR</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">xAMPRx_L</span> <span class="o">|</span> <span class="n">xAMPRx_SS_16Kb</span> <span class="o">|</span> <span class="n">xAMPRx_S</span> <span class="o">|</span> <span class="n">xAMPRx_C</span> <span class="o">|</span> <span class="n">xAMPRx_V</span><span class="p">);</span>

	<span class="cm">/* now its safe to access pmd */</span>
	<span class="n">pte</span> <span class="o">=</span> <span class="p">(</span><span class="n">pte_t</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_DAMLR</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">__pte_index</span><span class="p">(</span><span class="n">vaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pte_present</span><span class="p">(</span><span class="o">*</span><span class="n">pte</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">pte_val</span><span class="p">(</span><span class="o">*</span><span class="n">pte</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* restore original dampr5 */</span>
	<span class="n">__set_DAMPR</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dampr5</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">gdbstub_addr_map</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">vaddr</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_MMU</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pte</span><span class="p">;</span>

	<span class="n">__saved_dampr</span> <span class="o">=</span> <span class="n">__get_DAMPR</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">__saved_damlr</span> <span class="o">=</span> <span class="n">__get_DAMLR</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_addr_probe</span><span class="p">(</span><span class="n">vaddr</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_MMU</span>
	<span class="n">pte</span> <span class="o">=</span> <span class="n">gdbstub_virt_to_pte</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">vaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pte</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__set_DAMPR</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">pte</span><span class="p">);</span>
		<span class="n">__set_DAMLR</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">vaddr</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gdbstub_addr_unmap</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_MMU</span>
	<span class="n">__set_DAMPR</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">__saved_dampr</span><span class="p">);</span>
	<span class="n">__set_DAMLR</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">__saved_damlr</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * access potentially dodgy memory through a potentially dodgy pointer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">gdbstub_read_dword</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">_res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">brr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdbstub_addr_map</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;	movgs	gr0,brr	</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;	ld%I2	%M2,%0	</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;	movsg	brr,%1	</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">brr</span><span class="p">)</span>
		     <span class="o">:</span> <span class="s">&quot;m&quot;</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">));</span>
	<span class="o">*</span><span class="n">_res</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">gdbstub_addr_unmap</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">brr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">gdbstub_write_dword</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">brr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdbstub_addr_map</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;	movgs	gr0,brr	</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;	st%I2	%1,%M2	</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;	movsg	brr,%0	</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">brr</span><span class="p">)</span>
		     <span class="o">:</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="s">&quot;m&quot;</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">));</span>
	<span class="n">gdbstub_addr_unmap</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">brr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">gdbstub_read_word</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">_res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">brr</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdbstub_addr_map</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;	movgs	gr0,brr	</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;	lduh%I2	%M2,%0	</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;	movsg	brr,%1	</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">brr</span><span class="p">)</span>
		     <span class="o">:</span> <span class="s">&quot;m&quot;</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">));</span>
	<span class="o">*</span><span class="n">_res</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">gdbstub_addr_unmap</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">brr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">gdbstub_write_word</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">brr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdbstub_addr_map</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;	movgs	gr0,brr	</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;	sth%I2	%1,%M2	</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;	movsg	brr,%0	</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">brr</span><span class="p">)</span>
		     <span class="o">:</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="s">&quot;m&quot;</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">));</span>
	<span class="n">gdbstub_addr_unmap</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">brr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">gdbstub_read_byte</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">_res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">brr</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdbstub_addr_map</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;	movgs	gr0,brr	</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;	ldub%I2	%M2,%0	</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;	movsg	brr,%1	</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">brr</span><span class="p">)</span>
		     <span class="o">:</span> <span class="s">&quot;m&quot;</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">));</span>
	<span class="o">*</span><span class="n">_res</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">gdbstub_addr_unmap</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">brr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">gdbstub_write_byte</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">brr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdbstub_addr_map</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;	movgs	gr0,brr	</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;	stb%I2	%1,%M2	</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;	movsg	brr,%0	</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">brr</span><span class="p">)</span>
		     <span class="o">:</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="s">&quot;m&quot;</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">));</span>
	<span class="n">gdbstub_addr_unmap</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">brr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__gdbstub_console_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">co</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">outbuf</span><span class="p">[</span><span class="mi">26</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">qty</span><span class="p">;</span>

	<span class="n">outbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;O&#39;</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">qty</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mem2hex</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">outbuf</span> <span class="o">+</span> <span class="n">qty</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">qty</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="mh">0x0a</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">outbuf</span><span class="p">[</span><span class="n">qty</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
				<span class="n">outbuf</span><span class="p">[</span><span class="n">qty</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;d&#39;</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="n">n</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">outbuf</span><span class="p">[</span><span class="n">qty</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">gdbstub_send_packet</span><span class="p">(</span><span class="n">outbuf</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">void debug_to_serial(const char *p, int n)</span>
<span class="c">{</span>
<span class="c">	gdbstub_console_write(NULL,p,n);</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_GDB_CONSOLE</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">console</span> <span class="n">gdbstub_console</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;gdb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>	<span class="o">=</span> <span class="n">gdbstub_console_write</span><span class="p">,</span>	<span class="cm">/* in break.S */</span>
	<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">CON_PRINTBUFFER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#endif</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * Convert the memory pointed to by mem into hex, placing result in buf.</span>
<span class="cm"> * - if successful, return a pointer to the last char put in buf (NUL)</span>
<span class="cm"> * - in case of mem fault, return NULL</span>
<span class="cm"> * may_fault is non-zero if we are reading from arbitrary memory, but is currently</span>
<span class="cm"> * not used.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">mem2hex</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_mem</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">may_fault</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">mem</span> <span class="o">=</span> <span class="n">_mem</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">ch</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="mi">4</span><span class="p">)));</span>

	<span class="k">if</span> <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">mem</span><span class="o">&amp;</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">count</span><span class="o">&gt;=</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdbstub_read_byte</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span><span class="n">ch</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">mem</span><span class="o">++</span><span class="p">;</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">mem</span><span class="o">&amp;</span><span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">count</span><span class="o">&gt;=</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdbstub_read_word</span><span class="p">(</span><span class="n">mem</span><span class="p">,(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ch</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">mem</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">&gt;=</span><span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdbstub_read_dword</span><span class="p">(</span><span class="n">mem</span><span class="p">,(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ch</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ch</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ch</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">mem</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="o">&gt;=</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdbstub_read_word</span><span class="p">(</span><span class="n">mem</span><span class="p">,(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ch</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">mem</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="o">&gt;=</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdbstub_read_byte</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span><span class="n">ch</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end mem2hex() */</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * convert the hex array pointed to by buf into binary to be placed in mem</span>
<span class="cm"> * return a pointer to the character AFTER the last byte of buffer consumed</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">hex2mem</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_mem</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">mem</span> <span class="o">=</span> <span class="n">_mem</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="kt">uint32_t</span> <span class="n">l</span><span class="p">;</span>
		<span class="kt">uint16_t</span> <span class="n">w</span><span class="p">;</span>
		<span class="kt">uint8_t</span>  <span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">ch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">mem</span><span class="o">&amp;</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">count</span><span class="o">&gt;=</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdbstub_write_byte</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span><span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">mem</span><span class="o">++</span><span class="p">;</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">mem</span><span class="o">&amp;</span><span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">count</span><span class="o">&gt;=</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">);</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="o">=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdbstub_write_word</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span><span class="n">ch</span><span class="p">.</span><span class="n">w</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">mem</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">&gt;=</span><span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">);</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="o">=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">);</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="o">=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">);</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="o">=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdbstub_write_dword</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span><span class="n">ch</span><span class="p">.</span><span class="n">l</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">mem</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="o">&gt;=</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">);</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="o">=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdbstub_write_word</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span><span class="n">ch</span><span class="p">.</span><span class="n">w</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">mem</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="o">&gt;=</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">hex</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdbstub_write_byte</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span><span class="n">ch</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end hex2mem() */</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * This table contains the mapping between FRV TBR.TT exception codes,</span>
<span class="cm"> * and signals, which are primarily what GDB understands.  It also</span>
<span class="cm"> * indicates which hardware traps we need to commandeer when</span>
<span class="cm"> * initializing the stub.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">brr_to_sig_map</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">brr_mask</span><span class="p">;</span>	<span class="cm">/* BRR bitmask */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">tbr_tt</span><span class="p">;</span>		<span class="cm">/* TBR.TT code (in BRR.EBTT) */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">signo</span><span class="p">;</span>		<span class="cm">/* Signal that we map this into */</span>
<span class="p">}</span> <span class="n">brr_to_sig_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">BRR_EB</span><span class="p">,</span>	<span class="n">TBR_TT_INSTR_ACC_ERROR</span><span class="p">,</span>	<span class="n">SIGSEGV</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">BRR_EB</span><span class="p">,</span>	<span class="n">TBR_TT_ILLEGAL_INSTR</span><span class="p">,</span>	<span class="n">SIGILL</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">BRR_EB</span><span class="p">,</span>	<span class="n">TBR_TT_PRIV_INSTR</span><span class="p">,</span>	<span class="n">SIGILL</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">BRR_EB</span><span class="p">,</span>	<span class="n">TBR_TT_MP_EXCEPTION</span><span class="p">,</span>	<span class="n">SIGFPE</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">BRR_EB</span><span class="p">,</span>	<span class="n">TBR_TT_DATA_ACC_ERROR</span><span class="p">,</span>	<span class="n">SIGSEGV</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">BRR_EB</span><span class="p">,</span>	<span class="n">TBR_TT_DATA_STR_ERROR</span><span class="p">,</span>	<span class="n">SIGSEGV</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">BRR_EB</span><span class="p">,</span>	<span class="n">TBR_TT_DIVISION_EXCEP</span><span class="p">,</span>	<span class="n">SIGFPE</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">BRR_EB</span><span class="p">,</span>	<span class="n">TBR_TT_COMPOUND_EXCEP</span><span class="p">,</span>	<span class="n">SIGSEGV</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">BRR_EB</span><span class="p">,</span>	<span class="n">TBR_TT_INTERRUPT_13</span><span class="p">,</span>	<span class="n">SIGALRM</span>		<span class="p">},</span>	<span class="cm">/* watchdog */</span>
	<span class="p">{</span> <span class="n">BRR_EB</span><span class="p">,</span>	<span class="n">TBR_TT_INTERRUPT_14</span><span class="p">,</span>	<span class="n">SIGINT</span>		<span class="p">},</span>	<span class="cm">/* GDB serial */</span>
	<span class="p">{</span> <span class="n">BRR_EB</span><span class="p">,</span>	<span class="n">TBR_TT_INTERRUPT_15</span><span class="p">,</span>	<span class="n">SIGQUIT</span>		<span class="p">},</span>	<span class="cm">/* NMI */</span>
	<span class="p">{</span> <span class="n">BRR_CB</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>			<span class="n">SIGUSR1</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">BRR_TB</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>			<span class="n">SIGUSR2</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">BRR_DBNEx</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>			<span class="n">SIGTRAP</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">BRR_DBx</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>			<span class="n">SIGTRAP</span>		<span class="p">},</span>	<span class="cm">/* h/w watchpoint */</span>
	<span class="p">{</span> <span class="n">BRR_IBx</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>			<span class="n">SIGTRAP</span>		<span class="p">},</span>	<span class="cm">/* h/w breakpoint */</span>
	<span class="p">{</span> <span class="n">BRR_CBB</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>			<span class="n">SIGTRAP</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">BRR_SB</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>			<span class="n">SIGTRAP</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">BRR_ST</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>			<span class="n">SIGTRAP</span>		<span class="p">},</span>	<span class="cm">/* single step */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span>		<span class="mi">0</span><span class="p">,</span>			<span class="n">SIGHUP</span>		<span class="p">}</span>	<span class="cm">/* default */</span>
<span class="p">};</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * convert the FRV BRR register contents into a UNIX signal number</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">gdbstub_compute_signal</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">brr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">brr_to_sig_map</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tbr</span> <span class="o">=</span> <span class="p">(</span><span class="n">brr</span> <span class="o">&amp;</span> <span class="n">BRR_EBTT</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">map</span> <span class="o">=</span> <span class="n">brr_to_sig_map</span><span class="p">;</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">brr_mask</span><span class="p">;</span> <span class="n">map</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">brr_mask</span> <span class="o">&amp;</span> <span class="n">brr</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">tbr_tt</span> <span class="o">||</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">tbr_tt</span> <span class="o">==</span> <span class="n">tbr</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">signo</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end gdbstub_compute_signal() */</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * set a software breakpoint or a hardware breakpoint or watchpoint</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gdbstub_set_breakpoint</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bkpt</span><span class="p">,</span> <span class="n">loop</span><span class="p">,</span> <span class="n">xloop</span><span class="p">;</span>

	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mask0</span><span class="p">,</span> <span class="n">mask1</span><span class="p">;</span>
		<span class="p">};</span>
		<span class="kt">uint8_t</span> <span class="n">bytes</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">dbmr</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>gdbstub_printk("setbkpt(%ld,%08lx,%ld)\n", type, addr, len);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* set software breakpoint */</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">bkpt</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span> <span class="n">bkpt</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bkpt</span><span class="o">--</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdbstub_bkpts</span><span class="p">[</span><span class="n">bkpt</span><span class="p">].</span><span class="n">addr</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bkpt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;</span> <span class="n">len</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdbstub_read_dword</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">)[</span><span class="n">loop</span><span class="p">],</span>
						<span class="o">&amp;</span><span class="n">gdbstub_bkpts</span><span class="p">[</span><span class="n">bkpt</span><span class="p">].</span><span class="n">originsns</span><span class="p">[</span><span class="n">loop</span><span class="p">]))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;</span> <span class="n">len</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdbstub_write_dword</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">)[</span><span class="n">loop</span><span class="p">],</span>
						 <span class="n">BREAK_INSN</span><span class="p">)</span>
			    <span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* need to undo the changes if possible */</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">xloop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">xloop</span> <span class="o">&lt;</span> <span class="n">loop</span><span class="p">;</span> <span class="n">xloop</span><span class="o">++</span><span class="p">)</span>
					<span class="n">gdbstub_write_dword</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">)[</span><span class="n">xloop</span><span class="p">],</span>
							    <span class="n">gdbstub_bkpts</span><span class="p">[</span><span class="n">bkpt</span><span class="p">].</span><span class="n">originsns</span><span class="p">[</span><span class="n">xloop</span><span class="p">]);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="n">gdbstub_bkpts</span><span class="p">[</span><span class="n">bkpt</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
		<span class="n">gdbstub_bkpts</span><span class="p">[</span><span class="n">bkpt</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		gdbstub_printk(&quot;Set BKPT[%02x]: %08lx #%d {%04x, %04x} -&gt; { %04x, %04x }\n&quot;,</span>
<span class="c">			       bkpt,</span>
<span class="c">			       gdbstub_bkpts[bkpt].addr,</span>
<span class="c">			       gdbstub_bkpts[bkpt].len,</span>
<span class="c">			       gdbstub_bkpts[bkpt].originsns[0],</span>
<span class="c">			       gdbstub_bkpts[bkpt].originsns[1],</span>
<span class="c">			       ((uint32_t *) addr)[0],</span>
<span class="c">			       ((uint32_t *) addr)[1]</span>
<span class="c">			       );</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* set hardware breakpoint */</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">len</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dcr</span> <span class="o">&amp;</span> <span class="n">DCR_IBE0</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>gdbstub_printk("set h/w break 0: %08lx\n", addr);</p></td><td class="code"><div class="highlight"><pre>			<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dcr</span> <span class="o">|=</span> <span class="n">DCR_IBE0</span><span class="p">;</span>
			<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">ibar</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
			<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movgs %0,ibar0&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dcr</span> <span class="o">&amp;</span> <span class="n">DCR_IBE1</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>gdbstub_printk("set h/w break 1: %08lx\n", addr);</p></td><td class="code"><div class="highlight"><pre>			<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dcr</span> <span class="o">|=</span> <span class="n">DCR_IBE1</span><span class="p">;</span>
			<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">ibar</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
			<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movgs %0,ibar1&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dcr</span> <span class="o">&amp;</span> <span class="n">DCR_IBE2</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>gdbstub_printk("set h/w break 2: %08lx\n", addr);</p></td><td class="code"><div class="highlight"><pre>			<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dcr</span> <span class="o">|=</span> <span class="n">DCR_IBE2</span><span class="p">;</span>
			<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">ibar</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
			<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movgs %0,ibar2&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dcr</span> <span class="o">&amp;</span> <span class="n">DCR_IBE3</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>gdbstub_printk("set h/w break 3: %08lx\n", addr);</p></td><td class="code"><div class="highlight"><pre>			<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dcr</span> <span class="o">|=</span> <span class="n">DCR_IBE3</span><span class="p">;</span>
			<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">ibar</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
			<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movgs %0,ibar3&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>

		<span class="cm">/* set data read/write/access watchpoint */</span>
	<span class="k">case</span> <span class="mi">2</span>:
	<span class="k">case</span> <span class="mi">3</span>:
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">)</span> <span class="o">!=</span> <span class="p">((</span><span class="n">addr</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">dbmr</span><span class="p">.</span><span class="n">bytes</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dbmr</span><span class="p">.</span><span class="n">bytes</span><span class="p">));</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span>
			<span class="n">dbmr</span><span class="p">.</span><span class="n">bytes</span><span class="p">[</span><span class="n">tmp</span> <span class="o">+</span> <span class="n">loop</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">addr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dcr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DCR_DRBE0</span><span class="o">|</span><span class="n">DCR_DWBE0</span><span class="p">)))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>gdbstub_printk("set h/w watchpoint 0 type %ld: %08lx\n", type, addr);</p></td><td class="code"><div class="highlight"><pre>			<span class="n">tmp</span> <span class="o">=</span> <span class="n">type</span><span class="o">==</span><span class="mi">2</span> <span class="o">?</span> <span class="n">DCR_DWBE0</span> <span class="o">:</span> <span class="n">type</span><span class="o">==</span><span class="mi">3</span> <span class="o">?</span> <span class="n">DCR_DRBE0</span> <span class="o">:</span> <span class="n">DCR_DRBE0</span><span class="o">|</span><span class="n">DCR_DWBE0</span><span class="p">;</span>

			<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dcr</span> <span class="o">|=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dbar</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
			<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dbmr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dbmr</span><span class="p">.</span><span class="n">mask0</span><span class="p">;</span>
			<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dbmr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dbmr</span><span class="p">.</span><span class="n">mask1</span><span class="p">;</span>
			<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dbdr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dbdr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;	movgs	%0,dbar0	</span><span class="se">\n</span><span class="s">&quot;</span>
				     <span class="s">&quot;	movgs	%1,dbmr00	</span><span class="se">\n</span><span class="s">&quot;</span>
				     <span class="s">&quot;	movgs	%2,dbmr01	</span><span class="se">\n</span><span class="s">&quot;</span>
				     <span class="s">&quot;	movgs	gr0,dbdr00	</span><span class="se">\n</span><span class="s">&quot;</span>
				     <span class="s">&quot;	movgs	gr0,dbdr01	</span><span class="se">\n</span><span class="s">&quot;</span>
				     <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">dbmr</span><span class="p">.</span><span class="n">mask0</span><span class="p">),</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">dbmr</span><span class="p">.</span><span class="n">mask1</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dcr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DCR_DRBE1</span><span class="o">|</span><span class="n">DCR_DWBE1</span><span class="p">)))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>gdbstub_printk("set h/w watchpoint 1 type %ld: %08lx\n", type, addr);</p></td><td class="code"><div class="highlight"><pre>			<span class="n">tmp</span> <span class="o">=</span> <span class="n">type</span><span class="o">==</span><span class="mi">2</span> <span class="o">?</span> <span class="n">DCR_DWBE1</span> <span class="o">:</span> <span class="n">type</span><span class="o">==</span><span class="mi">3</span> <span class="o">?</span> <span class="n">DCR_DRBE1</span> <span class="o">:</span> <span class="n">DCR_DRBE1</span><span class="o">|</span><span class="n">DCR_DWBE1</span><span class="p">;</span>

			<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dcr</span> <span class="o">|=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dbar</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
			<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dbmr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dbmr</span><span class="p">.</span><span class="n">mask0</span><span class="p">;</span>
			<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dbmr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dbmr</span><span class="p">.</span><span class="n">mask1</span><span class="p">;</span>
			<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dbdr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dbdr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;	movgs	%0,dbar1	</span><span class="se">\n</span><span class="s">&quot;</span>
				     <span class="s">&quot;	movgs	%1,dbmr10	</span><span class="se">\n</span><span class="s">&quot;</span>
				     <span class="s">&quot;	movgs	%2,dbmr11	</span><span class="se">\n</span><span class="s">&quot;</span>
				     <span class="s">&quot;	movgs	gr0,dbdr10	</span><span class="se">\n</span><span class="s">&quot;</span>
				     <span class="s">&quot;	movgs	gr0,dbdr11	</span><span class="se">\n</span><span class="s">&quot;</span>
				     <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">dbmr</span><span class="p">.</span><span class="n">mask0</span><span class="p">),</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">dbmr</span><span class="p">.</span><span class="n">mask1</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span> <span class="cm">/* end gdbstub_set_breakpoint() */</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * clear a breakpoint or watchpoint</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">gdbstub_clear_breakpoint</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bkpt</span><span class="p">,</span> <span class="n">loop</span><span class="p">;</span>

	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mask0</span><span class="p">,</span> <span class="n">mask1</span><span class="p">;</span>
		<span class="p">};</span>
		<span class="kt">uint8_t</span> <span class="n">bytes</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">dbmr</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>gdbstub_printk("clearbkpt(%ld,%08lx,%ld)\n", type, addr, len);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* clear software breakpoint */</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">bkpt</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span> <span class="n">bkpt</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bkpt</span><span class="o">--</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_bkpts</span><span class="p">[</span><span class="n">bkpt</span><span class="p">].</span><span class="n">addr</span> <span class="o">==</span> <span class="n">addr</span> <span class="o">&amp;&amp;</span> <span class="n">gdbstub_bkpts</span><span class="p">[</span><span class="n">bkpt</span><span class="p">].</span><span class="n">len</span> <span class="o">==</span> <span class="n">len</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bkpt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

		<span class="n">gdbstub_bkpts</span><span class="p">[</span><span class="n">bkpt</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;</span> <span class="n">len</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdbstub_write_dword</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">)[</span><span class="n">loop</span><span class="p">],</span>
						 <span class="n">gdbstub_bkpts</span><span class="p">[</span><span class="n">bkpt</span><span class="p">].</span><span class="n">originsns</span><span class="p">[</span><span class="n">loop</span><span class="p">]))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* clear hardware breakpoint */</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">len</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="cp">#define __get_ibar(X) ({ unsigned long x; asm volatile(&quot;movsg ibar&quot;#X&quot;,%0&quot; : &quot;=r&quot;(x)); x; })</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dcr</span> <span class="o">&amp;</span> <span class="n">DCR_IBE0</span> <span class="o">&amp;&amp;</span> <span class="n">__get_ibar</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">addr</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>gdbstub_printk("clear h/w break 0: %08lx\n", addr);</p></td><td class="code"><div class="highlight"><pre>			<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DCR_IBE0</span><span class="p">;</span>
			<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">ibar</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movgs gr0,ibar0&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dcr</span> <span class="o">&amp;</span> <span class="n">DCR_IBE1</span> <span class="o">&amp;&amp;</span> <span class="n">__get_ibar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">addr</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>gdbstub_printk("clear h/w break 1: %08lx\n", addr);</p></td><td class="code"><div class="highlight"><pre>			<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DCR_IBE1</span><span class="p">;</span>
			<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">ibar</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movgs gr0,ibar1&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dcr</span> <span class="o">&amp;</span> <span class="n">DCR_IBE2</span> <span class="o">&amp;&amp;</span> <span class="n">__get_ibar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="n">addr</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>gdbstub_printk("clear h/w break 2: %08lx\n", addr);</p></td><td class="code"><div class="highlight"><pre>			<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DCR_IBE2</span><span class="p">;</span>
			<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">ibar</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movgs gr0,ibar2&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dcr</span> <span class="o">&amp;</span> <span class="n">DCR_IBE3</span> <span class="o">&amp;&amp;</span> <span class="n">__get_ibar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="n">addr</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>gdbstub_printk("clear h/w break 3: %08lx\n", addr);</p></td><td class="code"><div class="highlight"><pre>			<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DCR_IBE3</span><span class="p">;</span>
			<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">ibar</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movgs gr0,ibar3&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="cm">/* clear data read/write/access watchpoint */</span>
	<span class="k">case</span> <span class="mi">2</span>:
	<span class="k">case</span> <span class="mi">3</span>:
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">)</span> <span class="o">!=</span> <span class="p">((</span><span class="n">addr</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">dbmr</span><span class="p">.</span><span class="n">bytes</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dbmr</span><span class="p">.</span><span class="n">bytes</span><span class="p">));</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span>
			<span class="n">dbmr</span><span class="p">.</span><span class="n">bytes</span><span class="p">[</span><span class="n">tmp</span> <span class="o">+</span> <span class="n">loop</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">addr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>

<span class="cp">#define __get_dbar(X) ({ unsigned long x; asm volatile(&quot;movsg dbar&quot;#X&quot;,%0&quot; : &quot;=r&quot;(x)); x; })</span>
<span class="cp">#define __get_dbmr0(X) ({ unsigned long x; asm volatile(&quot;movsg dbmr&quot;#X&quot;0,%0&quot; : &quot;=r&quot;(x)); x; })</span>
<span class="cp">#define __get_dbmr1(X) ({ unsigned long x; asm volatile(&quot;movsg dbmr&quot;#X&quot;1,%0&quot; : &quot;=r&quot;(x)); x; })</span>

		<span class="cm">/* consider DBAR 0 */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">type</span><span class="o">==</span><span class="mi">2</span> <span class="o">?</span> <span class="n">DCR_DWBE0</span> <span class="o">:</span> <span class="n">type</span><span class="o">==</span><span class="mi">3</span> <span class="o">?</span> <span class="n">DCR_DRBE0</span> <span class="o">:</span> <span class="n">DCR_DRBE0</span><span class="o">|</span><span class="n">DCR_DWBE0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dcr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DCR_DRBE0</span><span class="o">|</span><span class="n">DCR_DWBE0</span><span class="p">))</span> <span class="o">!=</span> <span class="n">tmp</span> <span class="o">||</span>
		    <span class="n">__get_dbar</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">addr</span> <span class="o">||</span>
		    <span class="n">__get_dbmr0</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dbmr</span><span class="p">.</span><span class="n">mask0</span> <span class="o">||</span>
		    <span class="n">__get_dbmr1</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dbmr</span><span class="p">.</span><span class="n">mask1</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">skip_dbar0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>gdbstub_printk("clear h/w watchpoint 0 type %ld: %08lx\n", type, addr);</p></td><td class="code"><div class="highlight"><pre>		<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">DCR_DRBE0</span><span class="o">|</span><span class="n">DCR_DWBE0</span><span class="p">);</span>
		<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dbar</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dbmr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dbmr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dbdr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dbdr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;	movgs	gr0,dbar0	</span><span class="se">\n</span><span class="s">&quot;</span>
			     <span class="s">&quot;	movgs	gr0,dbmr00	</span><span class="se">\n</span><span class="s">&quot;</span>
			     <span class="s">&quot;	movgs	gr0,dbmr01	</span><span class="se">\n</span><span class="s">&quot;</span>
			     <span class="s">&quot;	movgs	gr0,dbdr00	</span><span class="se">\n</span><span class="s">&quot;</span>
			     <span class="s">&quot;	movgs	gr0,dbdr01	</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="nl">skip_dbar0:</span>
		<span class="cm">/* consider DBAR 0 */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">type</span><span class="o">==</span><span class="mi">2</span> <span class="o">?</span> <span class="n">DCR_DWBE1</span> <span class="o">:</span> <span class="n">type</span><span class="o">==</span><span class="mi">3</span> <span class="o">?</span> <span class="n">DCR_DRBE1</span> <span class="o">:</span> <span class="n">DCR_DRBE1</span><span class="o">|</span><span class="n">DCR_DWBE1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dcr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DCR_DRBE1</span><span class="o">|</span><span class="n">DCR_DWBE1</span><span class="p">))</span> <span class="o">!=</span> <span class="n">tmp</span> <span class="o">||</span>
		    <span class="n">__get_dbar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">addr</span> <span class="o">||</span>
		    <span class="n">__get_dbmr0</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dbmr</span><span class="p">.</span><span class="n">mask0</span> <span class="o">||</span>
		    <span class="n">__get_dbmr1</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dbmr</span><span class="p">.</span><span class="n">mask1</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">skip_dbar1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>gdbstub_printk("clear h/w watchpoint 1 type %ld: %08lx\n", type, addr);</p></td><td class="code"><div class="highlight"><pre>		<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">DCR_DRBE1</span><span class="o">|</span><span class="n">DCR_DWBE1</span><span class="p">);</span>
		<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dbar</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dbmr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dbmr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dbdr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dbdr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;	movgs	gr0,dbar1	</span><span class="se">\n</span><span class="s">&quot;</span>
			     <span class="s">&quot;	movgs	gr0,dbmr10	</span><span class="se">\n</span><span class="s">&quot;</span>
			     <span class="s">&quot;	movgs	gr0,dbmr11	</span><span class="se">\n</span><span class="s">&quot;</span>
			     <span class="s">&quot;	movgs	gr0,dbdr10	</span><span class="se">\n</span><span class="s">&quot;</span>
			     <span class="s">&quot;	movgs	gr0,dbdr11	</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="nl">skip_dbar1:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span> <span class="cm">/* end gdbstub_clear_breakpoint() */</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * check a for an internal software breakpoint, and wind the PC back if necessary</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gdbstub_check_breakpoint</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bkpt</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bkpt</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span> <span class="n">bkpt</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bkpt</span><span class="o">--</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_bkpts</span><span class="p">[</span><span class="n">bkpt</span><span class="p">].</span><span class="n">addr</span> <span class="o">==</span> <span class="n">addr</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bkpt</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>gdbstub<em>printk("alter pc [%d] %08lx\n", bkpt, _</em>debug_frame->pc);</p></td><td class="code"><div class="highlight"><pre><span class="p">}</span> <span class="cm">/* end gdbstub_check_breakpoint() */</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__maybe_unused</span> <span class="nf">gdbstub_show_regs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loop</span><span class="p">;</span>

	<span class="n">gdbstub_printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">gdbstub_printk</span><span class="p">(</span><span class="s">&quot;Frame: @%p [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__debug_frame</span><span class="p">,</span>
		       <span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">psr</span> <span class="o">&amp;</span> <span class="n">PSR_S</span> <span class="o">?</span> <span class="s">&quot;kernel&quot;</span> <span class="o">:</span> <span class="s">&quot;user&quot;</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">__debug_frame</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;</span> <span class="n">NR_PT_REGS</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s %08lx&quot;</span><span class="p">,</span> <span class="n">regnames</span><span class="p">[</span><span class="n">loop</span> <span class="o">+</span> <span class="mi">0</span><span class="p">],</span> <span class="n">reg</span><span class="p">[</span><span class="n">loop</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">loop</span> <span class="o">==</span> <span class="n">NR_PT_REGS</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">loop</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; | &quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">gdbstub_printk</span><span class="p">(</span><span class="s">&quot;Process %s (pid: %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* end gdbstub_show_regs() */</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * dump debugging regs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__maybe_unused</span> <span class="nf">gdbstub_dump_debugregs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gdbstub_printk</span><span class="p">(</span><span class="s">&quot;DCR    %08lx  &quot;</span><span class="p">,</span> <span class="n">__debug_status</span><span class="p">.</span><span class="n">dcr</span><span class="p">);</span>
	<span class="n">gdbstub_printk</span><span class="p">(</span><span class="s">&quot;BRR    %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__debug_status</span><span class="p">.</span><span class="n">brr</span><span class="p">);</span>

	<span class="n">gdbstub_printk</span><span class="p">(</span><span class="s">&quot;IBAR0  %08lx  &quot;</span><span class="p">,</span> <span class="n">__get_ibar</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">gdbstub_printk</span><span class="p">(</span><span class="s">&quot;IBAR1  %08lx  &quot;</span><span class="p">,</span> <span class="n">__get_ibar</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">gdbstub_printk</span><span class="p">(</span><span class="s">&quot;IBAR2  %08lx  &quot;</span><span class="p">,</span> <span class="n">__get_ibar</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
	<span class="n">gdbstub_printk</span><span class="p">(</span><span class="s">&quot;IBAR3  %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__get_ibar</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>

	<span class="n">gdbstub_printk</span><span class="p">(</span><span class="s">&quot;DBAR0  %08lx  &quot;</span><span class="p">,</span> <span class="n">__get_dbar</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">gdbstub_printk</span><span class="p">(</span><span class="s">&quot;DBMR00 %08lx  &quot;</span><span class="p">,</span> <span class="n">__get_dbmr0</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">gdbstub_printk</span><span class="p">(</span><span class="s">&quot;DBMR01 %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__get_dbmr1</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>

	<span class="n">gdbstub_printk</span><span class="p">(</span><span class="s">&quot;DBAR1  %08lx  &quot;</span><span class="p">,</span> <span class="n">__get_dbar</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">gdbstub_printk</span><span class="p">(</span><span class="s">&quot;DBMR10 %08lx  &quot;</span><span class="p">,</span> <span class="n">__get_dbmr0</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">gdbstub_printk</span><span class="p">(</span><span class="s">&quot;DBMR11 %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__get_dbmr1</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>

	<span class="n">gdbstub_printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* end gdbstub_dump_debugregs() */</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * dump the MMU state into a structure so that it can be accessed with GDB</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">gdbstub_get_mmu_state</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movsg hsr0,%0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">__debug_mmu</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">hsr0</span><span class="p">));</span>
	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movsg pcsr,%0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">__debug_mmu</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">pcsr</span><span class="p">));</span>
	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movsg esr0,%0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">__debug_mmu</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">esr0</span><span class="p">));</span>
	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movsg ear0,%0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">__debug_mmu</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">ear0</span><span class="p">));</span>
	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movsg epcr0,%0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">__debug_mmu</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">epcr0</span><span class="p">));</span>

	<span class="cm">/* read the protection / SAT registers */</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">iamr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">L</span>  <span class="o">=</span> <span class="n">__get_IAMLR</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">iamr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">P</span>  <span class="o">=</span> <span class="n">__get_IAMPR</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">iamr</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">L</span>  <span class="o">=</span> <span class="n">__get_IAMLR</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">iamr</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">P</span>  <span class="o">=</span> <span class="n">__get_IAMPR</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">iamr</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">L</span>  <span class="o">=</span> <span class="n">__get_IAMLR</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">iamr</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">P</span>  <span class="o">=</span> <span class="n">__get_IAMPR</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">iamr</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">L</span>  <span class="o">=</span> <span class="n">__get_IAMLR</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">iamr</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">P</span>  <span class="o">=</span> <span class="n">__get_IAMPR</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">iamr</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">L</span>  <span class="o">=</span> <span class="n">__get_IAMLR</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">iamr</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">P</span>  <span class="o">=</span> <span class="n">__get_IAMPR</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">iamr</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">L</span>  <span class="o">=</span> <span class="n">__get_IAMLR</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">iamr</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">P</span>  <span class="o">=</span> <span class="n">__get_IAMPR</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">iamr</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">L</span>  <span class="o">=</span> <span class="n">__get_IAMLR</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">iamr</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">P</span>  <span class="o">=</span> <span class="n">__get_IAMPR</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">iamr</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">L</span>  <span class="o">=</span> <span class="n">__get_IAMLR</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">iamr</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">P</span>  <span class="o">=</span> <span class="n">__get_IAMPR</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">iamr</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">L</span>  <span class="o">=</span> <span class="n">__get_IAMLR</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">iamr</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">P</span>  <span class="o">=</span> <span class="n">__get_IAMPR</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">iamr</span><span class="p">[</span><span class="mi">9</span><span class="p">].</span><span class="n">L</span>  <span class="o">=</span> <span class="n">__get_IAMLR</span><span class="p">(</span><span class="mi">9</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">iamr</span><span class="p">[</span><span class="mi">9</span><span class="p">].</span><span class="n">P</span>  <span class="o">=</span> <span class="n">__get_IAMPR</span><span class="p">(</span><span class="mi">9</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">iamr</span><span class="p">[</span><span class="mi">10</span><span class="p">].</span><span class="n">L</span> <span class="o">=</span> <span class="n">__get_IAMLR</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">iamr</span><span class="p">[</span><span class="mi">10</span><span class="p">].</span><span class="n">P</span> <span class="o">=</span> <span class="n">__get_IAMPR</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">iamr</span><span class="p">[</span><span class="mi">11</span><span class="p">].</span><span class="n">L</span> <span class="o">=</span> <span class="n">__get_IAMLR</span><span class="p">(</span><span class="mi">11</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">iamr</span><span class="p">[</span><span class="mi">11</span><span class="p">].</span><span class="n">P</span> <span class="o">=</span> <span class="n">__get_IAMPR</span><span class="p">(</span><span class="mi">11</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">iamr</span><span class="p">[</span><span class="mi">12</span><span class="p">].</span><span class="n">L</span> <span class="o">=</span> <span class="n">__get_IAMLR</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">iamr</span><span class="p">[</span><span class="mi">12</span><span class="p">].</span><span class="n">P</span> <span class="o">=</span> <span class="n">__get_IAMPR</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">iamr</span><span class="p">[</span><span class="mi">13</span><span class="p">].</span><span class="n">L</span> <span class="o">=</span> <span class="n">__get_IAMLR</span><span class="p">(</span><span class="mi">13</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">iamr</span><span class="p">[</span><span class="mi">13</span><span class="p">].</span><span class="n">P</span> <span class="o">=</span> <span class="n">__get_IAMPR</span><span class="p">(</span><span class="mi">13</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">iamr</span><span class="p">[</span><span class="mi">14</span><span class="p">].</span><span class="n">L</span> <span class="o">=</span> <span class="n">__get_IAMLR</span><span class="p">(</span><span class="mi">14</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">iamr</span><span class="p">[</span><span class="mi">14</span><span class="p">].</span><span class="n">P</span> <span class="o">=</span> <span class="n">__get_IAMPR</span><span class="p">(</span><span class="mi">14</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">iamr</span><span class="p">[</span><span class="mi">15</span><span class="p">].</span><span class="n">L</span> <span class="o">=</span> <span class="n">__get_IAMLR</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">iamr</span><span class="p">[</span><span class="mi">15</span><span class="p">].</span><span class="n">P</span> <span class="o">=</span> <span class="n">__get_IAMPR</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>

	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">damr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">L</span>  <span class="o">=</span> <span class="n">__get_DAMLR</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">damr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">P</span>  <span class="o">=</span> <span class="n">__get_DAMPR</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">damr</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">L</span>  <span class="o">=</span> <span class="n">__get_DAMLR</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">damr</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">P</span>  <span class="o">=</span> <span class="n">__get_DAMPR</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">damr</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">L</span>  <span class="o">=</span> <span class="n">__get_DAMLR</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">damr</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">P</span>  <span class="o">=</span> <span class="n">__get_DAMPR</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">damr</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">L</span>  <span class="o">=</span> <span class="n">__get_DAMLR</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">damr</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">P</span>  <span class="o">=</span> <span class="n">__get_DAMPR</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">damr</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">L</span>  <span class="o">=</span> <span class="n">__get_DAMLR</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">damr</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">P</span>  <span class="o">=</span> <span class="n">__get_DAMPR</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">damr</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">L</span>  <span class="o">=</span> <span class="n">__get_DAMLR</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">damr</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">P</span>  <span class="o">=</span> <span class="n">__get_DAMPR</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">damr</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">L</span>  <span class="o">=</span> <span class="n">__get_DAMLR</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">damr</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">P</span>  <span class="o">=</span> <span class="n">__get_DAMPR</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">damr</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">L</span>  <span class="o">=</span> <span class="n">__get_DAMLR</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">damr</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">P</span>  <span class="o">=</span> <span class="n">__get_DAMPR</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">damr</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">L</span>  <span class="o">=</span> <span class="n">__get_DAMLR</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">damr</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">P</span>  <span class="o">=</span> <span class="n">__get_DAMPR</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">damr</span><span class="p">[</span><span class="mi">9</span><span class="p">].</span><span class="n">L</span>  <span class="o">=</span> <span class="n">__get_DAMLR</span><span class="p">(</span><span class="mi">9</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">damr</span><span class="p">[</span><span class="mi">9</span><span class="p">].</span><span class="n">P</span>  <span class="o">=</span> <span class="n">__get_DAMPR</span><span class="p">(</span><span class="mi">9</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">damr</span><span class="p">[</span><span class="mi">10</span><span class="p">].</span><span class="n">L</span> <span class="o">=</span> <span class="n">__get_DAMLR</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">damr</span><span class="p">[</span><span class="mi">10</span><span class="p">].</span><span class="n">P</span> <span class="o">=</span> <span class="n">__get_DAMPR</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">damr</span><span class="p">[</span><span class="mi">11</span><span class="p">].</span><span class="n">L</span> <span class="o">=</span> <span class="n">__get_DAMLR</span><span class="p">(</span><span class="mi">11</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">damr</span><span class="p">[</span><span class="mi">11</span><span class="p">].</span><span class="n">P</span> <span class="o">=</span> <span class="n">__get_DAMPR</span><span class="p">(</span><span class="mi">11</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">damr</span><span class="p">[</span><span class="mi">12</span><span class="p">].</span><span class="n">L</span> <span class="o">=</span> <span class="n">__get_DAMLR</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">damr</span><span class="p">[</span><span class="mi">12</span><span class="p">].</span><span class="n">P</span> <span class="o">=</span> <span class="n">__get_DAMPR</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">damr</span><span class="p">[</span><span class="mi">13</span><span class="p">].</span><span class="n">L</span> <span class="o">=</span> <span class="n">__get_DAMLR</span><span class="p">(</span><span class="mi">13</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">damr</span><span class="p">[</span><span class="mi">13</span><span class="p">].</span><span class="n">P</span> <span class="o">=</span> <span class="n">__get_DAMPR</span><span class="p">(</span><span class="mi">13</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">damr</span><span class="p">[</span><span class="mi">14</span><span class="p">].</span><span class="n">L</span> <span class="o">=</span> <span class="n">__get_DAMLR</span><span class="p">(</span><span class="mi">14</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">damr</span><span class="p">[</span><span class="mi">14</span><span class="p">].</span><span class="n">P</span> <span class="o">=</span> <span class="n">__get_DAMPR</span><span class="p">(</span><span class="mi">14</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">damr</span><span class="p">[</span><span class="mi">15</span><span class="p">].</span><span class="n">L</span> <span class="o">=</span> <span class="n">__get_DAMLR</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>
	<span class="n">__debug_mmu</span><span class="p">.</span><span class="n">damr</span><span class="p">[</span><span class="mi">15</span><span class="p">].</span><span class="n">P</span> <span class="o">=</span> <span class="n">__get_DAMPR</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_MMU</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* read the DAT entries from the TLB */</span>
		<span class="k">struct</span> <span class="n">__debug_amr</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">loop</span><span class="p">;</span>

		<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movsg tplr,%0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">__debug_mmu</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">tplr</span><span class="p">));</span>
		<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movsg tppr,%0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">__debug_mmu</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">tppr</span><span class="p">));</span>
		<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movsg tpxr,%0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">__debug_mmu</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">tpxr</span><span class="p">));</span>
		<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movsg cxnr,%0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">__debug_mmu</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">cxnr</span><span class="p">));</span>

		<span class="n">p</span> <span class="o">=</span> <span class="n">__debug_mmu</span><span class="p">.</span><span class="n">tlb</span><span class="p">;</span>

		<span class="cm">/* way 0 */</span>
		<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movgs %0,tpxr&quot;</span> <span class="o">::</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">TPXR_WAY_SHIFT</span><span class="p">));</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;tlbpr %0,gr0,#1,#0&quot;</span> <span class="o">::</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">loop</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">));</span>
			<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movsg tplr,%0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">L</span><span class="p">));</span>
			<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movsg tppr,%0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">));</span>
			<span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* way 1 */</span>
		<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movgs %0,tpxr&quot;</span> <span class="o">::</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TPXR_WAY_SHIFT</span><span class="p">));</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;tlbpr %0,gr0,#1,#0&quot;</span> <span class="o">::</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">loop</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">));</span>
			<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movsg tplr,%0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">L</span><span class="p">));</span>
			<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movsg tppr,%0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">));</span>
			<span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movgs %0,tplr&quot;</span> <span class="o">::</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">__debug_mmu</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">tplr</span><span class="p">));</span>
		<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movgs %0,tppr&quot;</span> <span class="o">::</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">__debug_mmu</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">tppr</span><span class="p">));</span>
		<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movgs %0,tpxr&quot;</span> <span class="o">::</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">__debug_mmu</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">tpxr</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="p">}</span> <span class="cm">/* end gdbstub_get_mmu_state() */</span>

<span class="cm">/*</span>
<span class="cm"> * handle general query commands of the form &#39;qXXXXX&#39;</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gdbstub_handle_query</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">input_buffer</span><span class="p">,</span> <span class="s">&quot;qAttached&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* return current thread ID */</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span> <span class="s">&quot;1&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">input_buffer</span><span class="p">,</span> <span class="s">&quot;qC&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* return current thread ID */</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span> <span class="s">&quot;QC 0&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">input_buffer</span><span class="p">,</span> <span class="s">&quot;qOffsets&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* return relocation offset of text and data segments */</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span> <span class="s">&quot;Text=0;Data=0;Bss=0&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">input_buffer</span><span class="p">,</span> <span class="s">&quot;qSymbol::&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">input_buffer</span><span class="p">,</span> <span class="s">&quot;qSupported&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* query of supported features */</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span> <span class="s">&quot;PacketSize=%u;ReverseContinue-;ReverseStep-&quot;</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">input_buffer</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gdbstub_strcpy</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span><span class="s">&quot;E01&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * handle event interception and GDB remote protocol processing</span>
<span class="cm"> * - on entry:</span>
<span class="cm"> *	PSR.ET==0, PSR.S==1 and the CPU is in debug mode</span>
<span class="cm"> *	__debug_frame points to the saved registers</span>
<span class="cm"> *	__frame points to the kernel mode exception frame, if it was in kernel</span>
<span class="cm"> *      mode when the break happened</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">gdbstub</span><span class="p">(</span><span class="kt">int</span> <span class="n">sigval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">loop</span><span class="p">,</span> <span class="n">dbar</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">temp2</span><span class="p">,</span> <span class="n">temp3</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">zero</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flush_cache</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">LEDS</span><span class="p">(</span><span class="mh">0x5000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sigval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifndef CONFIG_GDBSTUB_IMMEDIATE</span>
		<span class="cm">/* return immediately if GDB immediate activation option not set */</span>
		<span class="k">return</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">sigval</span> <span class="o">=</span> <span class="n">SIGINT</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="n">save_user_regs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__debug_frame0</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	gdbstub_printk(&quot;--&gt; gdbstub() %08x %p %08x %08x\n&quot;,</span>
<span class="c">		       __debug_frame-&gt;pc,</span>
<span class="c">		       __debug_frame,</span>
<span class="c">		       __debug_regs-&gt;brr,</span>
<span class="c">		       __debug_regs-&gt;bpsr);</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>gdbstub<em>show</em>regs();</p></td><td class="code"><div class="highlight"><pre><span class="cp">#endif</span>

	<span class="n">LEDS</span><span class="p">(</span><span class="mh">0x5001</span><span class="p">);</span>

	<span class="cm">/* if we were interrupted by input on the serial gdbstub serial port,</span>
<span class="cm">	 * restore the context prior to the interrupt so that we return to that</span>
<span class="cm">	 * directly</span>
<span class="cm">	 */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">__entry_kerneltrap_table</span><span class="p">;</span>
	<span class="n">temp2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">__entry_usertrap_table</span><span class="p">;</span>
	<span class="n">temp3</span> <span class="o">=</span> <span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">15</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">temp3</span> <span class="o">==</span> <span class="n">temp</span> <span class="o">+</span> <span class="n">TBR_TT_INTERRUPT_15</span> <span class="o">||</span>
	    <span class="n">temp3</span> <span class="o">==</span> <span class="n">temp2</span> <span class="o">+</span> <span class="n">TBR_TT_INTERRUPT_15</span>
	    <span class="p">)</span> <span class="p">{</span>
		<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movsg pcsr,%0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">));</span>
		<span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">psr</span> <span class="o">|=</span> <span class="n">PSR_ET</span><span class="p">;</span>
		<span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">psr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PSR_S</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">psr</span> <span class="o">&amp;</span> <span class="n">PSR_PS</span><span class="p">)</span>
			<span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">psr</span> <span class="o">|=</span> <span class="n">PSR_S</span><span class="p">;</span>
		<span class="n">__debug_status</span><span class="p">.</span><span class="n">brr</span> <span class="o">=</span> <span class="p">(</span><span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">tbr</span> <span class="o">&amp;</span> <span class="n">TBR_TT</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>
		<span class="n">__debug_status</span><span class="p">.</span><span class="n">brr</span> <span class="o">|=</span> <span class="n">BRR_EB</span><span class="p">;</span>
		<span class="n">sigval</span> <span class="o">=</span> <span class="n">SIGINT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* handle the decrement timer going off (FR451 only) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp3</span> <span class="o">==</span> <span class="n">temp</span> <span class="o">+</span> <span class="n">TBR_TT_DECREMENT_TIMER</span> <span class="o">||</span>
	    <span class="n">temp3</span> <span class="o">==</span> <span class="n">temp2</span> <span class="o">+</span> <span class="n">TBR_TT_DECREMENT_TIMER</span>
	    <span class="p">)</span> <span class="p">{</span>
		<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movgs %0,timerd&quot;</span> <span class="o">::</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="mi">10000000</span><span class="p">));</span>
		<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movsg pcsr,%0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">));</span>
		<span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">psr</span> <span class="o">|=</span> <span class="n">PSR_ET</span><span class="p">;</span>
		<span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">psr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PSR_S</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">psr</span> <span class="o">&amp;</span> <span class="n">PSR_PS</span><span class="p">)</span>
			<span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">psr</span> <span class="o">|=</span> <span class="n">PSR_S</span><span class="p">;</span>
		<span class="n">__debug_status</span><span class="p">.</span><span class="n">brr</span> <span class="o">=</span> <span class="p">(</span><span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">tbr</span> <span class="o">&amp;</span> <span class="n">TBR_TT</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>
		<span class="n">__debug_status</span><span class="p">.</span><span class="n">brr</span> <span class="o">|=</span> <span class="n">BRR_EB</span><span class="p">;</span>
		<span class="n">sigval</span> <span class="o">=</span> <span class="n">SIGXCPU</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">LEDS</span><span class="p">(</span><span class="mh">0x5002</span><span class="p">);</span>

	<span class="cm">/* after a BREAK insn, the PC lands on the far side of it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__debug_status</span><span class="p">.</span><span class="n">brr</span> <span class="o">&amp;</span> <span class="n">BRR_SB</span><span class="p">)</span>
		<span class="n">gdbstub_check_breakpoint</span><span class="p">();</span>

	<span class="n">LEDS</span><span class="p">(</span><span class="mh">0x5003</span><span class="p">);</span>

	<span class="cm">/* handle attempts to write console data via GDB &quot;O&quot; commands */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">gdbstub_console_write</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__gdbstub_console_write</span><span class="p">((</span><span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="p">)</span> <span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">gr8</span><span class="p">,</span>
					<span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">gr9</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">gr10</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_rx_unget</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sigval</span> <span class="o">=</span> <span class="n">SIGINT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">packet_waiting</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sigval</span><span class="p">)</span>
		<span class="n">sigval</span> <span class="o">=</span> <span class="n">gdbstub_compute_signal</span><span class="p">(</span><span class="n">__debug_status</span><span class="p">.</span><span class="n">brr</span><span class="p">);</span>

	<span class="n">LEDS</span><span class="p">(</span><span class="mh">0x5004</span><span class="p">);</span>

	<span class="cm">/* send a message to the debugger&#39;s user saying what happened if it may</span>
<span class="cm">	 * not be clear cut (we can&#39;t map exceptions onto signals properly)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sigval</span> <span class="o">!=</span> <span class="n">SIGINT</span> <span class="o">&amp;&amp;</span> <span class="n">sigval</span> <span class="o">!=</span> <span class="n">SIGTRAP</span> <span class="o">&amp;&amp;</span> <span class="n">sigval</span> <span class="o">!=</span> <span class="n">SIGILL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">title</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;Break &quot;</span><span class="p">;</span>
		<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">crlf</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">brr</span> <span class="o">=</span> <span class="n">__debug_status</span><span class="p">.</span><span class="n">brr</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">hx</span><span class="p">;</span>

		<span class="n">ptr</span> <span class="o">=</span> <span class="n">output_buffer</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;O&#39;</span><span class="p">;</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

		<span class="n">hx</span> <span class="o">=</span> <span class="n">hex_asc_hi</span><span class="p">(</span><span class="n">brr</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">hx</span><span class="p">);</span>
		<span class="n">hx</span> <span class="o">=</span> <span class="n">hex_asc_lo</span><span class="p">(</span><span class="n">brr</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">hx</span><span class="p">);</span>
		<span class="n">hx</span> <span class="o">=</span> <span class="n">hex_asc_hi</span><span class="p">(</span><span class="n">brr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">hx</span><span class="p">);</span>
		<span class="n">hx</span> <span class="o">=</span> <span class="n">hex_asc_lo</span><span class="p">(</span><span class="n">brr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">hx</span><span class="p">);</span>
		<span class="n">hx</span> <span class="o">=</span> <span class="n">hex_asc_hi</span><span class="p">(</span><span class="n">brr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">hx</span><span class="p">);</span>
		<span class="n">hx</span> <span class="o">=</span> <span class="n">hex_asc_lo</span><span class="p">(</span><span class="n">brr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">hx</span><span class="p">);</span>
		<span class="n">hx</span> <span class="o">=</span> <span class="n">hex_asc_hi</span><span class="p">(</span><span class="n">brr</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">hx</span><span class="p">);</span>
		<span class="n">hx</span> <span class="o">=</span> <span class="n">hex_asc_lo</span><span class="p">(</span><span class="n">brr</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">hx</span><span class="p">);</span>

		<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="n">crlf</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">crlf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">gdbstub_send_packet</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">);</span>	<span class="cm">/* send it off... */</span>
	<span class="p">}</span>

	<span class="n">LEDS</span><span class="p">(</span><span class="mh">0x5005</span><span class="p">);</span>

	<span class="cm">/* tell the debugger that an exception has occurred */</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">output_buffer</span><span class="p">;</span>

	<span class="cm">/* Send trap type (converted to signal) */</span>
	<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;T&#39;</span><span class="p">;</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">sigval</span><span class="p">);</span>

	<span class="cm">/* Send Error PC */</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">GDB_REG_PC</span><span class="p">);</span>
	<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;:&#39;</span><span class="p">;</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;;&#39;</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Send frame pointer</span>
<span class="cm">	 */</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">GDB_REG_FP</span><span class="p">);</span>
	<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;:&#39;</span><span class="p">;</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;;&#39;</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Send stack pointer</span>
<span class="cm">	 */</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">GDB_REG_SP</span><span class="p">);</span>
	<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;:&#39;</span><span class="p">;</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">sp</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;;&#39;</span><span class="p">;</span>

	<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">gdbstub_send_packet</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">);</span>	<span class="cm">/* send it off... */</span>

	<span class="n">LEDS</span><span class="p">(</span><span class="mh">0x5006</span><span class="p">);</span>

 <span class="nl">packet_waiting:</span>
	<span class="n">gdbstub_get_mmu_state</span><span class="p">();</span>

	<span class="cm">/* wait for input from remote GDB */</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">output_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">LEDS</span><span class="p">(</span><span class="mh">0x5007</span><span class="p">);</span>
		<span class="n">gdbstub_recv_packet</span><span class="p">(</span><span class="n">input_buffer</span><span class="p">);</span>
		<span class="n">LEDS</span><span class="p">(</span><span class="mh">0x5600</span> <span class="o">|</span> <span class="n">input_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">input_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="cm">/* request repeat of last signal number */</span>
		<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
			<span class="n">output_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;S&#39;</span><span class="p">;</span>
			<span class="n">output_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">hex_asc_hi</span><span class="p">(</span><span class="n">sigval</span><span class="p">);</span>
			<span class="n">output_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">hex_asc_lo</span><span class="p">(</span><span class="n">sigval</span><span class="p">);</span>
			<span class="n">output_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">&#39;d&#39;</span>:
			<span class="cm">/* toggle debug flag */</span>
			<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* return the value of the CPU registers</span>
<span class="cm">			 * - GR0,  GR1,  GR2,  GR3,  GR4,  GR5,  GR6,  GR7,</span>
<span class="cm">			 * - GR8,  GR9,  GR10, GR11, GR12, GR13, GR14, GR15,</span>
<span class="cm">			 * - GR16, GR17, GR18, GR19, GR20, GR21, GR22, GR23,</span>
<span class="cm">			 * - GR24, GR25, GR26, GR27, GR28, GR29, GR30, GR31,</span>
<span class="cm">			 * - GR32, GR33, GR34, GR35, GR36, GR37, GR38, GR39,</span>
<span class="cm">			 * - GR40, GR41, GR42, GR43, GR44, GR45, GR46, GR47,</span>
<span class="cm">			 * - GR48, GR49, GR50, GR51, GR52, GR53, GR54, GR55,</span>
<span class="cm">			 * - GR56, GR57, GR58, GR59, GR60, GR61, GR62, GR63,</span>
<span class="cm">			 * - FP0,  FP1,  FP2,  FP3,  FP4,  FP5,  FP6,  FP7,</span>
<span class="cm">			 * - FP8,  FP9,  FP10, FP11, FP12, FP13, FP14, FP15,</span>
<span class="cm">			 * - FP16, FP17, FP18, FP19, FP20, FP21, FP22, FP23,</span>
<span class="cm">			 * - FP24, FP25, FP26, FP27, FP28, FP29, FP30, FP31,</span>
<span class="cm">			 * - FP32, FP33, FP34, FP35, FP36, FP37, FP38, FP39,</span>
<span class="cm">			 * - FP40, FP41, FP42, FP43, FP44, FP45, FP46, FP47,</span>
<span class="cm">			 * - FP48, FP49, FP50, FP51, FP52, FP53, FP54, FP55,</span>
<span class="cm">			 * - FP56, FP57, FP58, FP59, FP60, FP61, FP62, FP63,</span>
<span class="cm">			 * - PC, PSR, CCR, CCCR,</span>
<span class="cm">			 * - _X132, _X133, _X134</span>
<span class="cm">			 * - TBR, BRR, DBAR0, DBAR1, DBAR2, DBAR3,</span>
<span class="cm">			 * - _X141, _X142, _X143, _X144,</span>
<span class="cm">			 * - LR, LCR</span>
<span class="cm">			 */</span>
		<span class="k">case</span> <span class="sc">&#39;g&#39;</span>:
			<span class="n">zero</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">output_buffer</span><span class="p">;</span>

			<span class="cm">/* deal with GR0, GR1-GR27, GR28-GR31, GR32-GR63 */</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zero</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;=</span> <span class="mi">27</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span>
				<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__debug_user_context</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">gr</span><span class="p">[</span><span class="n">loop</span><span class="p">],</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">__frame</span><span class="p">;</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__debug_user_context</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">gr</span><span class="p">[</span><span class="mi">29</span><span class="p">],</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__debug_user_context</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">gr</span><span class="p">[</span><span class="mi">30</span><span class="p">],</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_MMU</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__debug_user_context</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">gr</span><span class="p">[</span><span class="mi">31</span><span class="p">],</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#else</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">__debug_frame</span><span class="p">;</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;=</span> <span class="mi">63</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span>
				<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__debug_user_context</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">gr</span><span class="p">[</span><span class="n">loop</span><span class="p">],</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="cm">/* deal with FR0-FR63 */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;=</span> <span class="mi">63</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span>
				<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__debug_user_context</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">fr</span><span class="p">[</span><span class="n">loop</span><span class="p">],</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="cm">/* deal with special registers */</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">,</span>    <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">psr</span><span class="p">,</span>   <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">ccr</span><span class="p">,</span>   <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">cccr</span><span class="p">,</span>  <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zero</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zero</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zero</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">tbr</span><span class="p">,</span>   <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__debug_status</span><span class="p">.</span><span class="n">brr</span> <span class="p">,</span>   <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movsg dbar0,%0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">dbar</span><span class="p">));</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbar</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movsg dbar1,%0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">dbar</span><span class="p">));</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbar</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movsg dbar2,%0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">dbar</span><span class="p">));</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbar</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movsg dbar3,%0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">dbar</span><span class="p">));</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbar</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movsg scr0,%0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">dbar</span><span class="p">));</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbar</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movsg scr1,%0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">dbar</span><span class="p">));</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbar</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movsg scr2,%0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">dbar</span><span class="p">));</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbar</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movsg scr3,%0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">dbar</span><span class="p">));</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbar</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">lr</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">lcr</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">iacc0</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__debug_user_context</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">fsr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span>
				<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__debug_user_context</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">acc</span><span class="p">[</span><span class="n">loop</span><span class="p">],</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__debug_user_context</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">accg</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span>
				<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__debug_user_context</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">msr</span><span class="p">[</span><span class="n">loop</span><span class="p">],</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">gner0</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">gner1</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__debug_user_context</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">fner</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__debug_user_context</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">fner</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* set the values of the CPU registers */</span>
		<span class="k">case</span> <span class="sc">&#39;G&#39;</span>:
			<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">input_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

			<span class="cm">/* deal with GR0, GR1-GR27, GR28-GR31, GR32-GR63 */</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;=</span> <span class="mi">27</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span>
				<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__debug_user_context</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">gr</span><span class="p">[</span><span class="n">loop</span><span class="p">],</span> <span class="mi">4</span><span class="p">);</span>

			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">__frame</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">)</span> <span class="n">temp</span><span class="p">;</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">gr29</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">gr30</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_MMU</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">gr31</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="cp">#else</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="cp">#endif</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;=</span> <span class="mi">63</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span>
				<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__debug_user_context</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">gr</span><span class="p">[</span><span class="n">loop</span><span class="p">],</span> <span class="mi">4</span><span class="p">);</span>

			<span class="cm">/* deal with FR0-FR63 */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;=</span> <span class="mi">63</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span>
				<span class="n">ptr</span> <span class="o">=</span> <span class="n">mem2hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__debug_user_context</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">fr</span><span class="p">[</span><span class="n">loop</span><span class="p">],</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="cm">/* deal with special registers */</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">,</span>  <span class="mi">4</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">psr</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">ccr</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">cccr</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">132</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;=</span> <span class="mi">140</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span>
				<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movgs %0,scr0&quot;</span> <span class="o">::</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">temp</span><span class="p">));</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movgs %0,scr1&quot;</span> <span class="o">::</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">temp</span><span class="p">));</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movgs %0,scr2&quot;</span> <span class="o">::</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">temp</span><span class="p">));</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movgs %0,scr3&quot;</span> <span class="o">::</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">temp</span><span class="p">));</span>

			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">lr</span><span class="p">,</span>  <span class="mi">4</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">lcr</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">iacc0</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__debug_user_context</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">fsr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span>
				<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__debug_user_context</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">acc</span><span class="p">[</span><span class="n">loop</span><span class="p">],</span> <span class="mi">4</span><span class="p">);</span>

			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__debug_user_context</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">accg</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span>
				<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__debug_user_context</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">msr</span><span class="p">[</span><span class="n">loop</span><span class="p">],</span> <span class="mi">4</span><span class="p">);</span>

			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">gner0</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">gner1</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__debug_user_context</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">fner</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__debug_user_context</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">fner</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">4</span><span class="p">);</span>

			<span class="n">gdbstub_strcpy</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span><span class="s">&quot;OK&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* mAA..AA,LLLL  Read LLLL bytes at address AA..AA */</span>
		<span class="k">case</span> <span class="sc">&#39;m&#39;</span>:
			<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">input_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">hexToInt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span> <span class="o">&amp;&amp;</span>
			    <span class="n">hexToInt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">)</span>
			    <span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mem2hex</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">,</span> <span class="n">output_buffer</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">gdbstub_strcpy</span> <span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span> <span class="s">&quot;E03&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">gdbstub_strcpy</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span><span class="s">&quot;E01&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* MAA..AA,LLLL: Write LLLL bytes at address AA.AA return OK */</span>
		<span class="k">case</span> <span class="sc">&#39;M&#39;</span>:
			<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">input_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">hexToInt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span> <span class="o">&amp;&amp;</span>
			    <span class="n">hexToInt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">==</span> <span class="sc">&#39;:&#39;</span>
			    <span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">hex2mem</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">,</span> <span class="n">length</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">gdbstub_strcpy</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="n">gdbstub_strcpy</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span> <span class="s">&quot;E03&quot;</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">else</span>
				<span class="n">gdbstub_strcpy</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span> <span class="s">&quot;E02&quot;</span><span class="p">);</span>

			<span class="n">flush_cache</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* pNN: Read value of reg N and return it */</span>
		<span class="k">case</span> <span class="sc">&#39;p&#39;</span>:
			<span class="cm">/* return no value, indicating that we don&#39;t support</span>
<span class="cm">			 * this command and that gdb should use &#39;g&#39; instead */</span>
			<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* PNN,=RRRRRRRR: Write value R to reg N return OK */</span>
		<span class="k">case</span> <span class="sc">&#39;P&#39;</span>:
			<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">input_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hexToInt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">)</span> <span class="o">||</span>
			    <span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">&#39;=&#39;</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">hexToInt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">)</span>
			    <span class="p">)</span> <span class="p">{</span>
				<span class="n">gdbstub_strcpy</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span> <span class="s">&quot;E01&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">temp2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">GDB_REG_GR</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>:
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">GDB_REG_GR</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">...</span> <span class="n">GDB_REG_GR</span><span class="p">(</span><span class="mi">63</span><span class="p">)</span>:
				<span class="n">__debug_user_context</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">gr</span><span class="p">[</span><span class="n">addr</span> <span class="o">-</span> <span class="n">GDB_REG_GR</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">GDB_REG_FR</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">...</span> <span class="n">GDB_REG_FR</span><span class="p">(</span><span class="mi">63</span><span class="p">)</span>:
				<span class="n">__debug_user_context</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">fr</span><span class="p">[</span><span class="n">addr</span> <span class="o">-</span> <span class="n">GDB_REG_FR</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">GDB_REG_PC</span>:
				<span class="n">__debug_user_context</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">pc</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">GDB_REG_PSR</span>:
				<span class="n">__debug_user_context</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">psr</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">GDB_REG_CCR</span>:
				<span class="n">__debug_user_context</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">ccr</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">GDB_REG_CCCR</span>:
				<span class="n">__debug_user_context</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">cccr</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">GDB_REG_BRR</span>:
				<span class="n">__debug_status</span><span class="p">.</span><span class="n">brr</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">GDB_REG_LR</span>:
				<span class="n">__debug_user_context</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">lr</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">GDB_REG_LCR</span>:
				<span class="n">__debug_user_context</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">lcr</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">GDB_REG_FSR0</span>:
				<span class="n">__debug_user_context</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">fsr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">GDB_REG_ACC</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">...</span> <span class="n">GDB_REG_ACC</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>:
				<span class="n">__debug_user_context</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">acc</span><span class="p">[</span><span class="n">addr</span> <span class="o">-</span> <span class="n">GDB_REG_ACC</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">GDB_REG_ACCG</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>:
				<span class="o">*</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">__debug_user_context</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">accg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">GDB_REG_ACCG</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>:
				<span class="o">*</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">__debug_user_context</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">accg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">GDB_REG_MSR</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">...</span> <span class="n">GDB_REG_MSR</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>:
				<span class="n">__debug_user_context</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">msr</span><span class="p">[</span><span class="n">addr</span> <span class="o">-</span> <span class="n">GDB_REG_MSR</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">GDB_REG_GNER</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">...</span> <span class="n">GDB_REG_GNER</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>:
				<span class="n">__debug_user_context</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">gner</span><span class="p">[</span><span class="n">addr</span> <span class="o">-</span> <span class="n">GDB_REG_GNER</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">GDB_REG_FNER</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">...</span> <span class="n">GDB_REG_FNER</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>:
				<span class="n">__debug_user_context</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">fner</span><span class="p">[</span><span class="n">addr</span> <span class="o">-</span> <span class="n">GDB_REG_FNER</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">temp2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">temp2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">gdbstub_strcpy</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">gdbstub_strcpy</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span> <span class="s">&quot;E02&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* cAA..AA    Continue at address AA..AA(optional) */</span>
		<span class="k">case</span> <span class="sc">&#39;c&#39;</span>:
			<span class="cm">/* try to read optional parameter, pc unchanged if no parm */</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">input_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hexToInt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">))</span>
				<span class="n">__debug_frame</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

			<span class="cm">/* kill the program */</span>
		<span class="k">case</span> <span class="sc">&#39;k&#39;</span> :
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>	<span class="cm">/* just continue */</span>

			<span class="cm">/* detach */</span>
		<span class="k">case</span> <span class="sc">&#39;D&#39;</span>:
			<span class="n">gdbstub_strcpy</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* reset the whole machine (FIXME: system dependent) */</span>
		<span class="k">case</span> <span class="sc">&#39;r&#39;</span>:
			<span class="k">break</span><span class="p">;</span>


			<span class="cm">/* step to next instruction */</span>
		<span class="k">case</span> <span class="sc">&#39;s&#39;</span>:
			<span class="n">__debug_regs</span><span class="o">-&gt;</span><span class="n">dcr</span> <span class="o">|=</span> <span class="n">DCR_SE</span><span class="p">;</span>
			<span class="n">__debug_status</span><span class="p">.</span><span class="n">dcr</span> <span class="o">|=</span> <span class="n">DCR_SE</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

			<span class="cm">/* extended command */</span>
		<span class="k">case</span> <span class="sc">&#39;v&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">input_buffer</span><span class="p">,</span> <span class="s">&quot;vCont?&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">output_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">unsupported_cmd</span><span class="p">;</span>

			<span class="cm">/* set baud rate (bBB) */</span>
		<span class="k">case</span> <span class="sc">&#39;b&#39;</span>:
			<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">input_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hexToInt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">gdbstub_strcpy</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span><span class="s">&quot;B01&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* ack before changing speed */</span>
				<span class="n">gdbstub_send_packet</span><span class="p">(</span><span class="s">&quot;OK&quot;</span><span class="p">);</span>
				<span class="n">gdbstub_set_baud</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* set breakpoint */</span>
		<span class="k">case</span> <span class="sc">&#39;Z&#39;</span>:
			<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">input_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hexToInt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span><span class="o">&amp;</span><span class="n">temp</span><span class="p">)</span> <span class="o">||</span> <span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">&#39;,&#39;</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">hexToInt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">)</span> <span class="o">||</span> <span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">&#39;,&#39;</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">hexToInt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span><span class="o">&amp;</span><span class="n">length</span><span class="p">)</span>
			    <span class="p">)</span> <span class="p">{</span>
				<span class="n">gdbstub_strcpy</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span><span class="s">&quot;E01&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">gdbstub_strcpy</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span><span class="s">&quot;E03&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_set_breakpoint</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">gdbstub_strcpy</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span><span class="s">&quot;E03&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">flush_cache</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* soft bkpt by modified memory */</span>

			<span class="n">gdbstub_strcpy</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span><span class="s">&quot;OK&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* clear breakpoint */</span>
		<span class="k">case</span> <span class="sc">&#39;z&#39;</span>:
			<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">input_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hexToInt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span><span class="o">&amp;</span><span class="n">temp</span><span class="p">)</span> <span class="o">||</span> <span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">&#39;,&#39;</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">hexToInt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">)</span> <span class="o">||</span> <span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">&#39;,&#39;</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">hexToInt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span><span class="o">&amp;</span><span class="n">length</span><span class="p">)</span>
			    <span class="p">)</span> <span class="p">{</span>
				<span class="n">gdbstub_strcpy</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span><span class="s">&quot;E01&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">gdbstub_strcpy</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span><span class="s">&quot;E03&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">gdbstub_clear_breakpoint</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">gdbstub_strcpy</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span><span class="s">&quot;E03&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">flush_cache</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* soft bkpt by modified memory */</span>

			<span class="n">gdbstub_strcpy</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span><span class="s">&quot;OK&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* Thread-setting packet */</span>
		<span class="k">case</span> <span class="sc">&#39;H&#39;</span>:
			<span class="n">gdbstub_strcpy</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">&#39;q&#39;</span>:
			<span class="n">gdbstub_handle_query</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
		<span class="nl">unsupported_cmd:</span>
			<span class="n">gdbstub_proto</span><span class="p">(</span><span class="s">&quot;### GDB Unsupported Cmd &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">input_buffer</span><span class="p">);</span>
			<span class="n">gdbstub_strcpy</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span><span class="s">&quot;E01&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* reply to the request */</span>
		<span class="n">LEDS</span><span class="p">(</span><span class="mh">0x5009</span><span class="p">);</span>
		<span class="n">gdbstub_send_packet</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">);</span>
	<span class="p">}</span>

 <span class="nl">done:</span>
	<span class="n">restore_user_regs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__debug_frame0</span><span class="o">-&gt;</span><span class="n">uc</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>gdbstub<em>dump</em>debugregs();
gdbstub<em>printk("&lt;-- gdbstub() %08x\n", _</em>debug_frame->pc);</p></td><td class="code"><div class="highlight"><pre>	<span class="cm">/* need to flush the instruction cache before resuming, as we may have</span>
<span class="cm">	 * deposited a breakpoint, and the icache probably has no way of</span>
<span class="cm">	 * knowing that a data ref to some location may have changed something</span>
<span class="cm">	 * that is in the instruction cache.  NB: We flush both caches, just to</span>
<span class="cm">	 * be sure...</span>
<span class="cm">	 */</span>

	<span class="cm">/* note: flushing the icache will clobber EAR0 on the FR451 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flush_cache</span><span class="p">)</span>
		<span class="n">gdbstub_purge_cache</span><span class="p">();</span>

	<span class="n">LEDS</span><span class="p">(</span><span class="mh">0x5666</span><span class="p">);</span>

<span class="p">}</span> <span class="cm">/* end gdbstub() */</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * initialise the GDB stub</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">gdbstub_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_GDBSTUB_IMMEDIATE</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">gdbstub_printk</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">gdbstub_banner</span><span class="p">);</span>

	<span class="n">gdbstub_io_init</span><span class="p">();</span>

	<span class="cm">/* try to talk to GDB (or anyone insane enough to want to type GDB protocol by hand) */</span>
	<span class="n">gdbstub_proto</span><span class="p">(</span><span class="s">&quot;### GDB Tx ACK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">gdbstub_tx_char</span><span class="p">(</span><span class="sc">&#39;+&#39;</span><span class="p">);</span> <span class="cm">/* &#39;hello world&#39; */</span>

<span class="cp">#ifdef CONFIG_GDBSTUB_IMMEDIATE</span>
	<span class="n">gdbstub_printk</span><span class="p">(</span><span class="s">&quot;GDB Stub waiting for packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * In case GDB is started before us, ack any packets</span>
<span class="cm">	 * (presumably &quot;$?#xx&quot;) sitting there.</span>
<span class="cm">	 */</span>
	<span class="k">do</span> <span class="p">{</span> <span class="n">gdbstub_rx_char</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ch</span> <span class="o">!=</span> <span class="sc">&#39;$&#39;</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span> <span class="n">gdbstub_rx_char</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ch</span> <span class="o">!=</span> <span class="sc">&#39;#&#39;</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">gdbstub_rx_char</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* eat first csum byte */</span>
	<span class="k">do</span> <span class="p">{</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">gdbstub_rx_char</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* eat second csum byte */</span>

	<span class="n">gdbstub_proto</span><span class="p">(</span><span class="s">&quot;### GDB Tx NAK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">gdbstub_tx_char</span><span class="p">(</span><span class="sc">&#39;-&#39;</span><span class="p">);</span> <span class="cm">/* nak it */</span>

<span class="cp">#else</span>
	<span class="n">gdbstub_printk</span><span class="p">(</span><span class="s">&quot;GDB Stub set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* send banner */</span>
<span class="c">	ptr = output_buffer;</span>
<span class="c">	*ptr++ = &#39;O&#39;;</span>
<span class="c">	ptr = mem2hex(gdbstub_banner, ptr, sizeof(gdbstub_banner) - 1, 0);</span>
<span class="c">	gdbstub_send_packet(output_buffer);</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(CONFIG_GDB_CONSOLE) &amp;&amp; defined(CONFIG_GDBSTUB_IMMEDIATE)</span>
	<span class="n">register_console</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdbstub_console</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="p">}</span> <span class="cm">/* end gdbstub_init() */</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * register the console at a more appropriate time</span>
<span class="cm"> */</span>
<span class="cp">#if defined (CONFIG_GDB_CONSOLE) &amp;&amp; !defined(CONFIG_GDBSTUB_IMMEDIATE)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">gdbstub_postinit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;registering console</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">register_console</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdbstub_console</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end gdbstub_postinit() */</span>

<span class="n">__initcall</span><span class="p">(</span><span class="n">gdbstub_postinit</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * send an exit message to GDB</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">gdbstub_exit</span><span class="p">(</span><span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">checksum</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">,</span><span class="s">&quot;W%02x&quot;</span><span class="p">,</span><span class="n">status</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">);</span>

	<span class="n">gdbstub_tx_char</span><span class="p">(</span><span class="sc">&#39;$&#39;</span><span class="p">);</span>
	<span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">ch</span> <span class="o">=</span> <span class="n">output_buffer</span><span class="p">[</span><span class="n">count</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gdbstub_tx_char</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
		<span class="n">checksum</span> <span class="o">+=</span> <span class="n">ch</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gdbstub_tx_char</span><span class="p">(</span><span class="sc">&#39;#&#39;</span><span class="p">);</span>
	<span class="n">gdbstub_tx_char</span><span class="p">(</span><span class="n">hex_asc_hi</span><span class="p">(</span><span class="n">checksum</span><span class="p">));</span>
	<span class="n">gdbstub_tx_char</span><span class="p">(</span><span class="n">hex_asc_lo</span><span class="p">(</span><span class="n">checksum</span><span class="p">));</span>

	<span class="cm">/* make sure the output is flushed, or else RedBoot might clobber it */</span>
	<span class="n">gdbstub_tx_char</span><span class="p">(</span><span class="sc">&#39;-&#39;</span><span class="p">);</span>
	<span class="n">gdbstub_tx_flush</span><span class="p">();</span>

<span class="p">}</span> <span class="cm">/* end gdbstub_exit() */</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * GDB wants to call malloc() and free() to allocate memory for calling kernel</span>
<span class="cm"> * functions directly from its command line</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">malloc</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span> <span class="n">__maybe_unused</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">malloc</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">free</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="n">__maybe_unused</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">free</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span> <span class="n">___get_HSR0</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">__maybe_unused</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">uint32_t</span> <span class="nf">___get_HSR0</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__get_HSR</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span> <span class="n">___set_HSR0</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">x</span><span class="p">)</span> <span class="n">__maybe_unused</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">uint32_t</span> <span class="nf">___set_HSR0</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__set_HSR</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">__get_HSR</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
