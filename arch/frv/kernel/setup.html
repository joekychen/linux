<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › frv › kernel › setup.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>setup.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* setup.c: FRV specific setup</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2003-5 Red Hat, Inc. All Rights Reserved.</span>
<span class="cm"> * Written by David Howells (dhowells@redhat.com)</span>
<span class="cm"> * - Derived from arch/m68k/kernel/setup.c</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version</span>
<span class="cm"> * 2 of the License, or (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;generated/utsrelease.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/genhd.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/major.h&gt;</span>
<span class="cp">#include &lt;linux/bootmem.h&gt;</span>
<span class="cp">#include &lt;linux/highmem.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/serial.h&gt;</span>
<span class="cp">#include &lt;linux/serial_core.h&gt;</span>
<span class="cp">#include &lt;linux/serial_reg.h&gt;</span>
<span class="cp">#include &lt;linux/serial_8250.h&gt;</span>

<span class="cp">#include &lt;asm/setup.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/sections.h&gt;</span>
<span class="cp">#include &lt;asm/pgalloc.h&gt;</span>
<span class="cp">#include &lt;asm/busctl-regs.h&gt;</span>
<span class="cp">#include &lt;asm/serial-regs.h&gt;</span>
<span class="cp">#include &lt;asm/timer-regs.h&gt;</span>
<span class="cp">#include &lt;asm/irc-regs.h&gt;</span>
<span class="cp">#include &lt;asm/spr-regs.h&gt;</span>
<span class="cp">#include &lt;asm/mb-regs.h&gt;</span>
<span class="cp">#include &lt;asm/mb93493-regs.h&gt;</span>
<span class="cp">#include &lt;asm/gdb-stub.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cp">#ifdef CONFIG_BLK_DEV_INITRD</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#include &quot;local.h&quot;</span>

<span class="cp">#ifdef CONFIG_MB93090_MB00</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="n">mb93090_display</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_MMU</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="n">setup_linux_memory</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="n">setup_uclinux_memory</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_MB93090_MB00</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">__initdata</span> <span class="n">mb93090_banner</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;FJ/RH FR-V Linux&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">__initdata</span> <span class="n">mb93090_version</span><span class="p">[]</span> <span class="o">=</span> <span class="n">UTS_RELEASE</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">__nongprelbss</span> <span class="n">mb93090_mb00_detected</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="k">const</span> <span class="kt">char</span> <span class="n">__frv_unknown_system</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span> <span class="n">__frv_mb93091_cb10</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;mb93091-cb10&quot;</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span> <span class="n">__frv_mb93091_cb11</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;mb93091-cb11&quot;</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span> <span class="n">__frv_mb93091_cb30</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;mb93091-cb30&quot;</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span> <span class="n">__frv_mb93091_cb41</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;mb93091-cb41&quot;</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span> <span class="n">__frv_mb93091_cb60</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;mb93091-cb60&quot;</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span> <span class="n">__frv_mb93091_cb70</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;mb93091-cb70&quot;</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span> <span class="n">__frv_mb93091_cb451</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;mb93091-cb451&quot;</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span> <span class="n">__frv_mb93090_mb00</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;mb93090-mb00&quot;</span><span class="p">;</span>

<span class="k">const</span> <span class="kt">char</span> <span class="n">__frv_mb93493</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;mb93493&quot;</span><span class="p">;</span>

<span class="k">const</span> <span class="kt">char</span> <span class="n">__frv_mb93093</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;mb93093&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">__nongprelbss</span> <span class="n">cpu_series</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">__nongprelbss</span> <span class="n">cpu_core</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">__nongprelbss</span> <span class="n">cpu_silicon</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">__nongprelbss</span> <span class="n">cpu_mmu</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">__nongprelbss</span> <span class="n">cpu_system</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">__nongprelbss</span> <span class="n">cpu_board1</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">__nongprelbss</span> <span class="n">cpu_board2</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__nongprelbss</span> <span class="n">cpu_psr_all</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__nongprelbss</span> <span class="n">cpu_hsr0_all</span><span class="p">;</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__nongprelbss</span> <span class="n">pdm_suspend_mode</span><span class="p">;</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__nongprelbss</span> <span class="n">rom_length</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__nongprelbss</span> <span class="n">memory_start</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__nongprelbss</span> <span class="n">memory_end</span><span class="p">;</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__nongprelbss</span> <span class="n">dma_coherent_mem_start</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__nongprelbss</span> <span class="n">dma_coherent_mem_end</span><span class="p">;</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__initdata</span> <span class="n">__sdram_old_base</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__initdata</span> <span class="n">num_mappedpages</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">cpuinfo_frv</span> <span class="n">__nongprelbss</span> <span class="n">boot_cpu_data</span><span class="p">;</span>

<span class="kt">char</span> <span class="n">__initdata</span> <span class="n">command_line</span><span class="p">[</span><span class="n">COMMAND_LINE_SIZE</span><span class="p">];</span>
<span class="kt">char</span> <span class="n">__initdata</span> <span class="n">redboot_command_line</span><span class="p">[</span><span class="n">COMMAND_LINE_SIZE</span><span class="p">];</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="cp">#define __pminit</span>
<span class="cp">#define __pminitdata</span>
<span class="cp">#else</span>
<span class="cp">#define __pminit __init</span>
<span class="cp">#define __pminitdata __initdata</span>
<span class="cp">#endif</span>

<span class="k">struct</span> <span class="n">clock_cmode</span> <span class="p">{</span>
	<span class="kt">uint8_t</span>	<span class="n">xbus</span><span class="p">,</span> <span class="n">sdram</span><span class="p">,</span> <span class="n">corebus</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">dsu</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define _frac(N,D) ((N)&lt;&lt;4 | (D))</span>
<span class="cp">#define _x0_16	_frac(1,6)</span>
<span class="cp">#define _x0_25	_frac(1,4)</span>
<span class="cp">#define _x0_33	_frac(1,3)</span>
<span class="cp">#define _x0_375	_frac(3,8)</span>
<span class="cp">#define _x0_5	_frac(1,2)</span>
<span class="cp">#define _x0_66	_frac(2,3)</span>
<span class="cp">#define _x0_75	_frac(3,4)</span>
<span class="cp">#define _x1	_frac(1,1)</span>
<span class="cp">#define _x1_5	_frac(3,2)</span>
<span class="cp">#define _x2	_frac(2,1)</span>
<span class="cp">#define _x3	_frac(3,1)</span>
<span class="cp">#define _x4	_frac(4,1)</span>
<span class="cp">#define _x4_5	_frac(9,2)</span>
<span class="cp">#define _x6	_frac(6,1)</span>
<span class="cp">#define _x8	_frac(8,1)</span>
<span class="cp">#define _x9	_frac(9,1)</span>

<span class="kt">int</span> <span class="n">__nongprelbss</span> <span class="n">clock_p0_current</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">__nongprelbss</span> <span class="n">clock_cm_current</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">__nongprelbss</span> <span class="n">clock_cmode_current</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PM</span>
<span class="kt">int</span> <span class="n">__nongprelbss</span> <span class="n">clock_cmodes_permitted</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__nongprelbss</span> <span class="n">clock_bits_settable</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clock_cmode</span> <span class="n">__pminitdata</span> <span class="n">undef_clock_cmode</span> <span class="o">=</span> <span class="p">{</span> <span class="n">_x1</span><span class="p">,</span> <span class="n">_x1</span><span class="p">,</span> <span class="n">_x1</span><span class="p">,</span> <span class="n">_x1</span><span class="p">,</span> <span class="n">_x1</span> <span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clock_cmode</span> <span class="n">__pminitdata</span> <span class="n">clock_cmodes_fr401_fr403</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">4</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span>	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x2</span><span class="p">,</span>	<span class="n">_x2</span><span class="p">,</span>	<span class="n">_x0_25</span>	<span class="p">},</span>
	<span class="p">[</span><span class="mi">5</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> 	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x2</span><span class="p">,</span>	<span class="n">_x4</span><span class="p">,</span>	<span class="n">_x4</span><span class="p">,</span>	<span class="n">_x0_5</span>	<span class="p">},</span>
	<span class="p">[</span><span class="mi">8</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> 	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x2</span><span class="p">,</span>	<span class="n">_x0_25</span>	<span class="p">},</span>
	<span class="p">[</span><span class="mi">9</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> 	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x2</span><span class="p">,</span>	<span class="n">_x2</span><span class="p">,</span>	<span class="n">_x4</span><span class="p">,</span>	<span class="n">_x0_5</span>	<span class="p">},</span>
	<span class="p">[</span><span class="mi">11</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> 	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x4</span><span class="p">,</span>	<span class="n">_x4</span><span class="p">,</span>	<span class="n">_x8</span><span class="p">,</span>	<span class="n">_x1</span>	<span class="p">},</span>
	<span class="p">[</span><span class="mi">12</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> 	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x2</span><span class="p">,</span>	<span class="n">_x4</span><span class="p">,</span>	<span class="n">_x0_5</span>	<span class="p">},</span>
	<span class="p">[</span><span class="mi">13</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> 	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x2</span><span class="p">,</span>	<span class="n">_x4</span><span class="p">,</span>	<span class="n">_x8</span><span class="p">,</span>	<span class="n">_x1</span>	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clock_cmode</span> <span class="n">__pminitdata</span> <span class="n">clock_cmodes_fr405</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span>	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x0_5</span>	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span>	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x3</span><span class="p">,</span>	<span class="n">_x0_25</span>	<span class="p">},</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span>	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x2</span><span class="p">,</span>	<span class="n">_x6</span><span class="p">,</span>	<span class="n">_x0_5</span>	<span class="p">},</span>
	<span class="p">[</span><span class="mi">3</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span>	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x2</span><span class="p">,</span>	<span class="n">_x2</span><span class="p">,</span>	<span class="n">_x6</span><span class="p">,</span>	<span class="n">_x0_5</span>	<span class="p">},</span>
	<span class="p">[</span><span class="mi">4</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span>	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x2</span><span class="p">,</span>	<span class="n">_x2</span><span class="p">,</span>	<span class="n">_x0_16</span>	<span class="p">},</span>
	<span class="p">[</span><span class="mi">8</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> 	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x2</span><span class="p">,</span>	<span class="n">_x0_16</span>	<span class="p">},</span>
	<span class="p">[</span><span class="mi">9</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> 	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x2</span><span class="p">,</span>	<span class="n">_x2</span><span class="p">,</span>	<span class="n">_x4</span><span class="p">,</span>	<span class="n">_x0_33</span>	<span class="p">},</span>
	<span class="p">[</span><span class="mi">12</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> 	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x2</span><span class="p">,</span>	<span class="n">_x4</span><span class="p">,</span>	<span class="n">_x0_33</span>	<span class="p">},</span>
	<span class="p">[</span><span class="mi">14</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> 	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x3</span><span class="p">,</span>	<span class="n">_x3</span><span class="p">,</span>	<span class="n">_x9</span><span class="p">,</span>	<span class="n">_x0_75</span>	<span class="p">},</span>
	<span class="p">[</span><span class="mi">15</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> 	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x1_5</span><span class="p">,</span>	<span class="n">_x1_5</span><span class="p">,</span>	<span class="n">_x4_5</span><span class="p">,</span>	<span class="n">_x0_375</span>	<span class="p">},</span>

<span class="cp">#define CLOCK_CMODES_PERMITTED_FR405 0xd31f</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clock_cmode</span> <span class="n">__pminitdata</span> <span class="n">clock_cmodes_fr555</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span>	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x2</span><span class="p">,</span>	<span class="n">_x2</span><span class="p">,</span>	<span class="n">_x4</span><span class="p">,</span>	<span class="n">_x0_33</span>	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span>	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x3</span><span class="p">,</span>	<span class="n">_x3</span><span class="p">,</span>	<span class="n">_x6</span><span class="p">,</span>	<span class="n">_x0_5</span>	<span class="p">},</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span>	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x2</span><span class="p">,</span>	<span class="n">_x4</span><span class="p">,</span>	<span class="n">_x8</span><span class="p">,</span>	<span class="n">_x0_66</span>	<span class="p">},</span>
	<span class="p">[</span><span class="mi">3</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span>	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x1_5</span><span class="p">,</span>	<span class="n">_x3</span><span class="p">,</span>	<span class="n">_x6</span><span class="p">,</span>	<span class="n">_x0_5</span>	<span class="p">},</span>
	<span class="p">[</span><span class="mi">4</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span>	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x3</span><span class="p">,</span>	<span class="n">_x3</span><span class="p">,</span>	<span class="n">_x9</span><span class="p">,</span>	<span class="n">_x0_75</span>	<span class="p">},</span>
	<span class="p">[</span><span class="mi">5</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span>	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x2</span><span class="p">,</span>	<span class="n">_x2</span><span class="p">,</span>	<span class="n">_x6</span><span class="p">,</span>	<span class="n">_x0_5</span>	<span class="p">},</span>
	<span class="p">[</span><span class="mi">6</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span>	<span class="n">_x1</span><span class="p">,</span>	<span class="n">_x1_5</span><span class="p">,</span>	<span class="n">_x1_5</span><span class="p">,</span>	<span class="n">_x4_5</span><span class="p">,</span>	<span class="n">_x0_375</span>	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">clock_cmode</span> <span class="n">__pminitdata</span> <span class="o">*</span><span class="n">clock_cmodes</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__pminitdata</span> <span class="n">clock_doubled</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uart_port</span> <span class="n">__pminitdata</span> <span class="n">__frv_uart0</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">uartclk</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">membase</span>		<span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">UART0_BASE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq</span>			<span class="o">=</span> <span class="n">IRQ_CPU_UART0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">regshift</span>		<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iotype</span>			<span class="o">=</span> <span class="n">UPIO_MEM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>			<span class="o">=</span> <span class="n">UPF_BOOT_AUTOCONF</span> <span class="o">|</span> <span class="n">UPF_SKIP_TEST</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uart_port</span> <span class="n">__pminitdata</span> <span class="n">__frv_uart1</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">uartclk</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">membase</span>		<span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">UART1_BASE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq</span>			<span class="o">=</span> <span class="n">IRQ_CPU_UART1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">regshift</span>		<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iotype</span>			<span class="o">=</span> <span class="n">UPIO_MEM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>			<span class="o">=</span> <span class="n">UPF_BOOT_AUTOCONF</span> <span class="o">|</span> <span class="n">UPF_SKIP_TEST</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static void __init printk_xampr(unsigned long ampr, unsigned long amlr, char i_d, int n)</span>
<span class="c">{</span>
<span class="c">	unsigned long phys, virt, cxn, size;</span>

<span class="cp">#ifdef CONFIG_MMU</span>
<span class="c">	virt = amlr &amp; 0xffffc000;</span>
<span class="c">	cxn = amlr &amp; 0x3fff;</span>
<span class="cp">#else</span>
<span class="c">	virt = ampr &amp; 0xffffc000;</span>
<span class="c">	cxn = 0;</span>
<span class="cp">#endif</span>
	<span class="n">phys</span> <span class="o">=</span> <span class="n">ampr</span> <span class="o">&amp;</span> <span class="n">xAMPRx_PPFN</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(((</span><span class="n">ampr</span> <span class="o">&amp;</span> <span class="n">xAMPRx_SS</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">17</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%cAMPR%d: va %08lx-%08lx [pa %08lx] %c%c%c%c [cxn:%04lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">i_d</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span>
	       <span class="n">virt</span><span class="p">,</span> <span class="n">virt</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
	       <span class="n">phys</span><span class="p">,</span>
	       <span class="n">ampr</span> <span class="o">&amp;</span> <span class="n">xAMPRx_S</span>  <span class="o">?</span> <span class="sc">&#39;S&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span>
	       <span class="n">ampr</span> <span class="o">&amp;</span> <span class="n">xAMPRx_C</span>  <span class="o">?</span> <span class="sc">&#39;C&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span>
	       <span class="n">ampr</span> <span class="o">&amp;</span> <span class="n">DAMPRx_WP</span> <span class="o">?</span> <span class="sc">&#39;W&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span>
	       <span class="n">ampr</span> <span class="o">&amp;</span> <span class="n">xAMPRx_V</span>  <span class="o">?</span> <span class="sc">&#39;V&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span>
	       <span class="n">cxn</span>
	       <span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * dump the memory map</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="n">dump_memory_map</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* dump the protection map */</span>
<span class="c">	printk_xampr(__get_IAMPR(0),  __get_IAMLR(0),  &#39;I&#39;, 0);</span>
<span class="c">	printk_xampr(__get_IAMPR(1),  __get_IAMLR(1),  &#39;I&#39;, 1);</span>
<span class="c">	printk_xampr(__get_IAMPR(2),  __get_IAMLR(2),  &#39;I&#39;, 2);</span>
<span class="c">	printk_xampr(__get_IAMPR(3),  __get_IAMLR(3),  &#39;I&#39;, 3);</span>
<span class="c">	printk_xampr(__get_IAMPR(4),  __get_IAMLR(4),  &#39;I&#39;, 4);</span>
<span class="c">	printk_xampr(__get_IAMPR(5),  __get_IAMLR(5),  &#39;I&#39;, 5);</span>
<span class="c">	printk_xampr(__get_IAMPR(6),  __get_IAMLR(6),  &#39;I&#39;, 6);</span>
<span class="c">	printk_xampr(__get_IAMPR(7),  __get_IAMLR(7),  &#39;I&#39;, 7);</span>
<span class="c">	printk_xampr(__get_IAMPR(8),  __get_IAMLR(8),  &#39;I&#39;, 8);</span>
<span class="c">	printk_xampr(__get_IAMPR(9),  __get_IAMLR(9),  &#39;i&#39;, 9);</span>
<span class="c">	printk_xampr(__get_IAMPR(10), __get_IAMLR(10), &#39;I&#39;, 10);</span>
<span class="c">	printk_xampr(__get_IAMPR(11), __get_IAMLR(11), &#39;I&#39;, 11);</span>
<span class="c">	printk_xampr(__get_IAMPR(12), __get_IAMLR(12), &#39;I&#39;, 12);</span>
<span class="c">	printk_xampr(__get_IAMPR(13), __get_IAMLR(13), &#39;I&#39;, 13);</span>
<span class="c">	printk_xampr(__get_IAMPR(14), __get_IAMLR(14), &#39;I&#39;, 14);</span>
<span class="c">	printk_xampr(__get_IAMPR(15), __get_IAMLR(15), &#39;I&#39;, 15);</span>

<span class="c">	printk_xampr(__get_DAMPR(0),  __get_DAMLR(0),  &#39;D&#39;, 0);</span>
<span class="c">	printk_xampr(__get_DAMPR(1),  __get_DAMLR(1),  &#39;D&#39;, 1);</span>
<span class="c">	printk_xampr(__get_DAMPR(2),  __get_DAMLR(2),  &#39;D&#39;, 2);</span>
<span class="c">	printk_xampr(__get_DAMPR(3),  __get_DAMLR(3),  &#39;D&#39;, 3);</span>
<span class="c">	printk_xampr(__get_DAMPR(4),  __get_DAMLR(4),  &#39;D&#39;, 4);</span>
<span class="c">	printk_xampr(__get_DAMPR(5),  __get_DAMLR(5),  &#39;D&#39;, 5);</span>
<span class="c">	printk_xampr(__get_DAMPR(6),  __get_DAMLR(6),  &#39;D&#39;, 6);</span>
<span class="c">	printk_xampr(__get_DAMPR(7),  __get_DAMLR(7),  &#39;D&#39;, 7);</span>
<span class="c">	printk_xampr(__get_DAMPR(8),  __get_DAMLR(8),  &#39;D&#39;, 8);</span>
<span class="c">	printk_xampr(__get_DAMPR(9),  __get_DAMLR(9),  &#39;D&#39;, 9);</span>
<span class="c">	printk_xampr(__get_DAMPR(10), __get_DAMLR(10), &#39;D&#39;, 10);</span>
<span class="c">	printk_xampr(__get_DAMPR(11), __get_DAMLR(11), &#39;D&#39;, 11);</span>
<span class="c">	printk_xampr(__get_DAMPR(12), __get_DAMLR(12), &#39;D&#39;, 12);</span>
<span class="c">	printk_xampr(__get_DAMPR(13), __get_DAMLR(13), &#39;D&#39;, 13);</span>
<span class="c">	printk_xampr(__get_DAMPR(14), __get_DAMLR(14), &#39;D&#39;, 14);</span>
<span class="c">	printk_xampr(__get_DAMPR(15), __get_DAMLR(15), &#39;D&#39;, 15);</span>
<span class="cp">#endif</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* dump the bus controller registers */</span>
<span class="c">	printk(&quot;LGCR: %08lx\n&quot;, __get_LGCR());</span>
<span class="c">	printk(&quot;Master: %08lx-%08lx CR=%08lx\n&quot;,</span>
<span class="c">	       __get_LEMBR(), __get_LEMBR() + __get_LEMAM(),</span>
<span class="c">	       __get_LMAICR());</span>

<span class="c">	int loop;</span>
<span class="c">	for (loop = 1; loop &lt;= 7; loop++) {</span>
<span class="c">		unsigned long lcr = __get_LCR(loop), lsbr = __get_LSBR(loop);</span>
<span class="c">		printk(&quot;CS#%d: %08lx-%08lx %c%c%c%c%c%c%c%c%c\n&quot;,</span>
<span class="c">		       loop,</span>
<span class="c">		       lsbr, lsbr + __get_LSAM(loop),</span>
<span class="c">		       lcr &amp; 0x80000000 ? &#39;r&#39; : &#39;-&#39;,</span>
<span class="c">		       lcr &amp; 0x40000000 ? &#39;w&#39; : &#39;-&#39;,</span>
<span class="c">		       lcr &amp; 0x08000000 ? &#39;b&#39; : &#39;-&#39;,</span>
<span class="c">		       lcr &amp; 0x04000000 ? &#39;B&#39; : &#39;-&#39;,</span>
<span class="c">		       lcr &amp; 0x02000000 ? &#39;C&#39; : &#39;-&#39;,</span>
<span class="c">		       lcr &amp; 0x01000000 ? &#39;D&#39; : &#39;-&#39;,</span>
<span class="c">		       lcr &amp; 0x00800000 ? &#39;W&#39; : &#39;-&#39;,</span>
<span class="c">		       lcr &amp; 0x00400000 ? &#39;R&#39; : &#39;-&#39;,</span>
<span class="c">		       (lcr &amp; 0x00030000) == 0x00000000 ? &#39;4&#39; :</span>
<span class="c">		       (lcr &amp; 0x00030000) == 0x00010000 ? &#39;2&#39; :</span>
<span class="c">		       (lcr &amp; 0x00030000) == 0x00020000 ? &#39;1&#39; :</span>
<span class="c">		       &#39;-&#39;</span>
<span class="c">		       );</span>
<span class="c">	}</span>
<span class="cp">#endif</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	printk(&quot;\n&quot;);</span>
<span class="cp">#endif</span>
<span class="p">}</span> <span class="cm">/* end dump_memory_map() */</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * attempt to detect a VDK motherboard and DAV daughter board on an MB93091 system</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_MB93091_VDK</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="n">detect_mb93091</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_MB93090_MB00</span>
	<span class="cm">/* Detect CB70 without motherboard */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cpu_system</span> <span class="o">==</span> <span class="n">__frv_mb93091_cb70</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="mh">0xffc00030</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">cpu_board1</span> <span class="o">=</span> <span class="n">__frv_mb93090_mb00</span><span class="p">;</span>
		<span class="n">mb93090_mb00_detected</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_FUJITSU_MB93493</span>
	<span class="n">cpu_board2</span> <span class="o">=</span> <span class="n">__frv_mb93493</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="p">}</span> <span class="cm">/* end detect_mb93091() */</span>
<span class="cp">#endif</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * determine the CPU type and set appropriate parameters</span>
<span class="cm"> *</span>
<span class="cm"> * Family     Series      CPU Core    Silicon    Imple  Vers</span>
<span class="cm"> * ----------------------------------------------------------</span>
<span class="cm"> * FR-V --+-&gt; FR400 --+-&gt; FR401 --+-&gt; MB93401     02     00 [1]</span>
<span class="cm"> *        |           |           |</span>
<span class="cm"> *        |           |           +-&gt; MB93401/A   02     01</span>
<span class="cm"> *        |           |           |</span>
<span class="cm"> *        |           |           +-&gt; MB93403     02     02</span>
<span class="cm"> *        |           |</span>
<span class="cm"> *        |           +-&gt; FR405 ----&gt; MB93405     04     00</span>
<span class="cm"> *        |</span>
<span class="cm"> *        +-&gt; FR450 ----&gt; FR451 ----&gt; MB93451     05     00</span>
<span class="cm"> *        |</span>
<span class="cm"> *        +-&gt; FR500 ----&gt; FR501 --+-&gt; MB93501     01     01 [2]</span>
<span class="cm"> *        |                       |</span>
<span class="cm"> *        |                       +-&gt; MB93501/A   01     02</span>
<span class="cm"> *        |</span>
<span class="cm"> *        +-&gt; FR550 --+-&gt; FR551 ----&gt; MB93555     03     01</span>
<span class="cm"> *</span>
<span class="cm"> *  [1] The MB93401 is an obsolete CPU replaced by the MB93401A</span>
<span class="cm"> *  [2] The MB93501 is an obsolete CPU replaced by the MB93501A</span>
<span class="cm"> *</span>
<span class="cm"> * Imple is PSR(Processor Status Register)[31:28].</span>
<span class="cm"> * Vers is PSR(Processor Status Register)[27:24].</span>
<span class="cm"> *</span>
<span class="cm"> * A &quot;Silicon&quot; consists of CPU core and some on-chip peripherals.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="n">determine_cpu</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hsr0</span> <span class="o">=</span> <span class="n">__get_HSR</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">psr</span> <span class="o">=</span> <span class="n">__get_PSR</span><span class="p">();</span>

	<span class="cm">/* work out what selectable services the CPU supports */</span>
	<span class="n">__set_PSR</span><span class="p">(</span><span class="n">psr</span> <span class="o">|</span> <span class="n">PSR_EM</span> <span class="o">|</span> <span class="n">PSR_EF</span> <span class="o">|</span> <span class="n">PSR_CM</span> <span class="o">|</span> <span class="n">PSR_NEM</span><span class="p">);</span>
	<span class="n">cpu_psr_all</span> <span class="o">=</span> <span class="n">__get_PSR</span><span class="p">();</span>
	<span class="n">__set_PSR</span><span class="p">(</span><span class="n">psr</span><span class="p">);</span>

	<span class="n">__set_HSR</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">hsr0</span> <span class="o">|</span> <span class="n">HSR0_GRLE</span> <span class="o">|</span> <span class="n">HSR0_GRHE</span> <span class="o">|</span> <span class="n">HSR0_FRLE</span> <span class="o">|</span> <span class="n">HSR0_FRHE</span><span class="p">);</span>
	<span class="n">cpu_hsr0_all</span> <span class="o">=</span> <span class="n">__get_HSR</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">__set_HSR</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">hsr0</span><span class="p">);</span>

	<span class="cm">/* derive other service specs from the CPU type */</span>
	<span class="n">cpu_series</span>		<span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
	<span class="n">cpu_core</span>		<span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
	<span class="n">cpu_silicon</span>		<span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
	<span class="n">cpu_mmu</span>			<span class="o">=</span> <span class="s">&quot;Prot&quot;</span><span class="p">;</span>
	<span class="n">cpu_system</span>		<span class="o">=</span> <span class="n">__frv_unknown_system</span><span class="p">;</span>
	<span class="n">clock_cmodes</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">clock_doubled</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="n">clock_bits_settable</span>	<span class="o">=</span> <span class="n">CLOCK_BIT_CM_H</span> <span class="o">|</span> <span class="n">CLOCK_BIT_CM_M</span> <span class="o">|</span> <span class="n">CLOCK_BIT_P0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">PSR_IMPLE</span><span class="p">(</span><span class="n">psr</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PSR_IMPLE_FR401</span>:
		<span class="n">cpu_series</span>	<span class="o">=</span> <span class="s">&quot;fr400&quot;</span><span class="p">;</span>
		<span class="n">cpu_core</span>	<span class="o">=</span> <span class="s">&quot;fr401&quot;</span><span class="p">;</span>
		<span class="n">pdm_suspend_mode</span> <span class="o">=</span> <span class="n">HSR0_PDM_PLL_RUN</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">PSR_VERSION</span><span class="p">(</span><span class="n">psr</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PSR_VERSION_FR401_MB93401</span>:
			<span class="n">cpu_silicon</span>	<span class="o">=</span> <span class="s">&quot;mb93401&quot;</span><span class="p">;</span>
			<span class="n">cpu_system</span>	<span class="o">=</span> <span class="n">__frv_mb93091_cb10</span><span class="p">;</span>
			<span class="n">clock_cmodes</span>	<span class="o">=</span> <span class="n">clock_cmodes_fr401_fr403</span><span class="p">;</span>
			<span class="n">clock_doubled</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PSR_VERSION_FR401_MB93401A</span>:
			<span class="n">cpu_silicon</span>	<span class="o">=</span> <span class="s">&quot;mb93401/A&quot;</span><span class="p">;</span>
			<span class="n">cpu_system</span>	<span class="o">=</span> <span class="n">__frv_mb93091_cb11</span><span class="p">;</span>
			<span class="n">clock_cmodes</span>	<span class="o">=</span> <span class="n">clock_cmodes_fr401_fr403</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PSR_VERSION_FR401_MB93403</span>:
			<span class="n">cpu_silicon</span>	<span class="o">=</span> <span class="s">&quot;mb93403&quot;</span><span class="p">;</span>
<span class="cp">#ifndef CONFIG_MB93093_PDK</span>
			<span class="n">cpu_system</span>	<span class="o">=</span> <span class="n">__frv_mb93091_cb30</span><span class="p">;</span>
<span class="cp">#else</span>
			<span class="n">cpu_system</span>	<span class="o">=</span> <span class="n">__frv_mb93093</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="n">clock_cmodes</span>	<span class="o">=</span> <span class="n">clock_cmodes_fr401_fr403</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PSR_IMPLE_FR405</span>:
		<span class="n">cpu_series</span>	<span class="o">=</span> <span class="s">&quot;fr400&quot;</span><span class="p">;</span>
		<span class="n">cpu_core</span>	<span class="o">=</span> <span class="s">&quot;fr405&quot;</span><span class="p">;</span>
		<span class="n">pdm_suspend_mode</span> <span class="o">=</span> <span class="n">HSR0_PDM_PLL_STOP</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">PSR_VERSION</span><span class="p">(</span><span class="n">psr</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PSR_VERSION_FR405_MB93405</span>:
			<span class="n">cpu_silicon</span>	<span class="o">=</span> <span class="s">&quot;mb93405&quot;</span><span class="p">;</span>
			<span class="n">cpu_system</span>	<span class="o">=</span> <span class="n">__frv_mb93091_cb60</span><span class="p">;</span>
			<span class="n">clock_cmodes</span>	<span class="o">=</span> <span class="n">clock_cmodes_fr405</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PM</span>
			<span class="n">clock_bits_settable</span> <span class="o">|=</span> <span class="n">CLOCK_BIT_CMODE</span><span class="p">;</span>
			<span class="n">clock_cmodes_permitted</span> <span class="o">=</span> <span class="n">CLOCK_CMODES_PERMITTED_FR405</span><span class="p">;</span>
<span class="cp">#endif</span>

			<span class="cm">/* the FPGA on the CB70 has extra registers</span>
<span class="cm">			 * - it has 0x0046 in the VDK_ID FPGA register at 0x1a0, which is</span>
<span class="cm">			 *   how we tell the difference between it and a CB60</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="mh">0xffc001a0</span> <span class="o">==</span> <span class="mh">0x0046</span><span class="p">)</span>
				<span class="n">cpu_system</span> <span class="o">=</span> <span class="n">__frv_mb93091_cb70</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PSR_IMPLE_FR451</span>:
		<span class="n">cpu_series</span>	<span class="o">=</span> <span class="s">&quot;fr450&quot;</span><span class="p">;</span>
		<span class="n">cpu_core</span>	<span class="o">=</span> <span class="s">&quot;fr451&quot;</span><span class="p">;</span>
		<span class="n">pdm_suspend_mode</span> <span class="o">=</span> <span class="n">HSR0_PDM_PLL_STOP</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PM</span>
		<span class="n">clock_bits_settable</span> <span class="o">|=</span> <span class="n">CLOCK_BIT_CMODE</span><span class="p">;</span>
		<span class="n">clock_cmodes_permitted</span> <span class="o">=</span> <span class="n">CLOCK_CMODES_PERMITTED_FR405</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">PSR_VERSION</span><span class="p">(</span><span class="n">psr</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PSR_VERSION_FR451_MB93451</span>:
			<span class="n">cpu_silicon</span>	<span class="o">=</span> <span class="s">&quot;mb93451&quot;</span><span class="p">;</span>
			<span class="n">cpu_mmu</span>		<span class="o">=</span> <span class="s">&quot;Prot, SAT, xSAT, DAT&quot;</span><span class="p">;</span>
			<span class="n">cpu_system</span>	<span class="o">=</span> <span class="n">__frv_mb93091_cb451</span><span class="p">;</span>
			<span class="n">clock_cmodes</span>	<span class="o">=</span> <span class="n">clock_cmodes_fr405</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PSR_IMPLE_FR501</span>:
		<span class="n">cpu_series</span>	<span class="o">=</span> <span class="s">&quot;fr500&quot;</span><span class="p">;</span>
		<span class="n">cpu_core</span>	<span class="o">=</span> <span class="s">&quot;fr501&quot;</span><span class="p">;</span>
		<span class="n">pdm_suspend_mode</span> <span class="o">=</span> <span class="n">HSR0_PDM_PLL_STOP</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">PSR_VERSION</span><span class="p">(</span><span class="n">psr</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PSR_VERSION_FR501_MB93501</span>:  <span class="n">cpu_silicon</span> <span class="o">=</span> <span class="s">&quot;mb93501&quot;</span><span class="p">;</span>   <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PSR_VERSION_FR501_MB93501A</span>: <span class="n">cpu_silicon</span> <span class="o">=</span> <span class="s">&quot;mb93501/A&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PSR_IMPLE_FR551</span>:
		<span class="n">cpu_series</span>	<span class="o">=</span> <span class="s">&quot;fr550&quot;</span><span class="p">;</span>
		<span class="n">cpu_core</span>	<span class="o">=</span> <span class="s">&quot;fr551&quot;</span><span class="p">;</span>
		<span class="n">pdm_suspend_mode</span> <span class="o">=</span> <span class="n">HSR0_PDM_PLL_RUN</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">PSR_VERSION</span><span class="p">(</span><span class="n">psr</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PSR_VERSION_FR551_MB93555</span>:
			<span class="n">cpu_silicon</span>	<span class="o">=</span> <span class="s">&quot;mb93555&quot;</span><span class="p">;</span>
			<span class="n">cpu_mmu</span>		<span class="o">=</span> <span class="s">&quot;Prot, SAT&quot;</span><span class="p">;</span>
			<span class="n">cpu_system</span>	<span class="o">=</span> <span class="n">__frv_mb93091_cb41</span><span class="p">;</span>
			<span class="n">clock_cmodes</span>	<span class="o">=</span> <span class="n">clock_cmodes_fr555</span><span class="p">;</span>
			<span class="n">clock_doubled</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;- Series:%s CPU:%s Silicon:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cpu_series</span><span class="p">,</span> <span class="n">cpu_core</span><span class="p">,</span> <span class="n">cpu_silicon</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_MB93091_VDK</span>
	<span class="n">detect_mb93091</span><span class="p">();</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_MB93093_PDK) &amp;&amp; defined(CONFIG_FUJITSU_MB93493)</span>
	<span class="n">cpu_board2</span> <span class="o">=</span> <span class="n">__frv_mb93493</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="p">}</span> <span class="cm">/* end determine_cpu() */</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * calculate the bus clock speed</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">__pminit</span> <span class="n">determine_clocks</span><span class="p">(</span><span class="kt">int</span> <span class="n">verbose</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">clock_cmode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span> <span class="o">*</span><span class="n">tmode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">clkc</span><span class="p">,</span> <span class="n">psr</span><span class="p">,</span> <span class="n">quot</span><span class="p">;</span>

	<span class="n">clkc</span> <span class="o">=</span> <span class="n">__get_CLKC</span><span class="p">();</span>
	<span class="n">psr</span> <span class="o">=</span> <span class="n">__get_PSR</span><span class="p">();</span>

	<span class="n">clock_p0_current</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">clkc</span> <span class="o">&amp;</span> <span class="n">CLKC_P0</span><span class="p">);</span>
	<span class="n">clock_cm_current</span> <span class="o">=</span> <span class="n">clkc</span> <span class="o">&amp;</span> <span class="n">CLKC_CM</span><span class="p">;</span>
	<span class="n">clock_cmode_current</span> <span class="o">=</span> <span class="p">(</span><span class="n">clkc</span> <span class="o">&amp;</span> <span class="n">CLKC_CMODE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">CLKC_CMODE_s</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;psr=%08lx hsr0=%08lx clkc=%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">psr</span><span class="p">,</span> <span class="n">__get_HSR</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">clkc</span><span class="p">);</span>

	<span class="cm">/* the CB70 has some alternative ways of setting the clock speed through switches accessed</span>
<span class="cm">	 * through the FPGA.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_system</span> <span class="o">==</span> <span class="n">__frv_mb93091_cb70</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">clkswr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="mh">0xffc00104UL</span> <span class="o">&amp;</span> <span class="mh">0x1fffUL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">clkswr</span> <span class="o">&amp;</span> <span class="mh">0x1000</span><span class="p">)</span>
			<span class="n">__clkin_clock_speed_HZ</span> <span class="o">=</span> <span class="mi">60000000UL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">__clkin_clock_speed_HZ</span> <span class="o">=</span>
				<span class="p">((</span><span class="n">clkswr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10000000</span> <span class="o">+</span>
				<span class="p">((</span><span class="n">clkswr</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000000</span> <span class="o">+</span>
				<span class="p">((</span><span class="n">clkswr</span>     <span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* the FR451 is currently fixed at 24MHz */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_system</span> <span class="o">==</span> <span class="n">__frv_mb93091_cb451</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p><em>_clkin</em>clock<em>speed</em>HZ = 24000000UL; // CB451-FPGA</p></td><td class="code"><div class="highlight"><pre>		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">clkswr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="mh">0xffc00104UL</span> <span class="o">&amp;</span> <span class="mh">0x1fffUL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">clkswr</span> <span class="o">&amp;</span> <span class="mh">0x1000</span><span class="p">)</span>
			<span class="n">__clkin_clock_speed_HZ</span> <span class="o">=</span> <span class="mi">60000000UL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">__clkin_clock_speed_HZ</span> <span class="o">=</span>
				<span class="p">((</span><span class="n">clkswr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10000000</span> <span class="o">+</span>
				<span class="p">((</span><span class="n">clkswr</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000000</span> <span class="o">+</span>
				<span class="p">((</span><span class="n">clkswr</span>     <span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* otherwise determine the clockspeed from VDK or other registers */</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">__clkin_clock_speed_HZ</span> <span class="o">=</span> <span class="n">__get_CLKIN</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/* look up the appropriate clock relationships table entry */</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">undef_clock_cmode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clock_cmodes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">clock_cmodes</span><span class="p">[(</span><span class="n">clkc</span> <span class="o">&amp;</span> <span class="n">CLKC_CMODE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">CLKC_CMODE_s</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmode</span><span class="o">-&gt;</span><span class="n">xbus</span><span class="p">)</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">tmode</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#define CLOCK(SRC,RATIO) ((SRC) * (((RATIO) &gt;&gt; 4) &amp; 0x0f) / ((RATIO) &amp; 0x0f))</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clock_doubled</span><span class="p">)</span>
		<span class="n">__clkin_clock_speed_HZ</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">__ext_bus_clock_speed_HZ</span>	<span class="o">=</span> <span class="n">CLOCK</span><span class="p">(</span><span class="n">__clkin_clock_speed_HZ</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">xbus</span><span class="p">);</span>
	<span class="n">__sdram_clock_speed_HZ</span>		<span class="o">=</span> <span class="n">CLOCK</span><span class="p">(</span><span class="n">__clkin_clock_speed_HZ</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">sdram</span><span class="p">);</span>
	<span class="n">__dsu_clock_speed_HZ</span>		<span class="o">=</span> <span class="n">CLOCK</span><span class="p">(</span><span class="n">__clkin_clock_speed_HZ</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">dsu</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">clkc</span> <span class="o">&amp;</span> <span class="n">CLKC_CM</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* High */</span>
		<span class="n">__core_bus_clock_speed_HZ</span>	<span class="o">=</span> <span class="n">CLOCK</span><span class="p">(</span><span class="n">__clkin_clock_speed_HZ</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">corebus</span><span class="p">);</span>
		<span class="n">__core_clock_speed_HZ</span>		<span class="o">=</span> <span class="n">CLOCK</span><span class="p">(</span><span class="n">__clkin_clock_speed_HZ</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* Medium */</span>
		<span class="n">__core_bus_clock_speed_HZ</span>	<span class="o">=</span> <span class="n">CLOCK</span><span class="p">(</span><span class="n">__clkin_clock_speed_HZ</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">sdram</span><span class="p">);</span>
		<span class="n">__core_clock_speed_HZ</span>		<span class="o">=</span> <span class="n">CLOCK</span><span class="p">(</span><span class="n">__clkin_clock_speed_HZ</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">sdram</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* Low; not supported */</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* UNDEF */</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Unsupported CLKC CM %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">clkc</span> <span class="o">&amp;</span> <span class="n">CLKC_CM</span><span class="p">);</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Bye&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">__res_bus_clock_speed_HZ</span> <span class="o">=</span> <span class="n">__ext_bus_clock_speed_HZ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clkc</span> <span class="o">&amp;</span> <span class="n">CLKC_P0</span><span class="p">)</span>
		<span class="n">__res_bus_clock_speed_HZ</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;CLKIN: %lu.%3.3luMHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__clkin_clock_speed_HZ</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">__clkin_clock_speed_HZ</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">);</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;CLKS:&quot;</span>
		       <span class="s">&quot; ext=%luMHz res=%luMHz sdram=%luMHz cbus=%luMHz core=%luMHz dsu=%luMHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__ext_bus_clock_speed_HZ</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">,</span>
		       <span class="n">__res_bus_clock_speed_HZ</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">,</span>
		       <span class="n">__sdram_clock_speed_HZ</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">,</span>
		       <span class="n">__core_bus_clock_speed_HZ</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">,</span>
		       <span class="n">__core_clock_speed_HZ</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">,</span>
		       <span class="n">__dsu_clock_speed_HZ</span> <span class="o">/</span> <span class="mi">1000000</span>
		       <span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* calculate the number of __delay() loop iterations per sec (2 insn loop) */</span>
	<span class="n">__delay_loops_MHz</span> <span class="o">=</span> <span class="n">__core_clock_speed_HZ</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1000000</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* set the serial prescaler */</span>
	<span class="n">__serial_clock_speed_HZ</span> <span class="o">=</span> <span class="n">__res_bus_clock_speed_HZ</span><span class="p">;</span>
	<span class="n">quot</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">__serial_clock_speed_HZ</span> <span class="o">/</span> <span class="n">quot</span> <span class="o">/</span> <span class="mi">16</span> <span class="o">/</span> <span class="mi">65536</span> <span class="o">&gt;</span> <span class="mi">3000</span><span class="p">)</span>
		<span class="n">quot</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* double the divisor if P0 is clear, so that if/when P0 is set, it&#39;s still achievable</span>
<span class="cm">	 * - we have to be careful - dividing too much can mean we can&#39;t get 115200 baud</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__serial_clock_speed_HZ</span> <span class="o">&gt;</span> <span class="mi">32000000</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">clkc</span> <span class="o">&amp;</span> <span class="n">CLKC_P0</span><span class="p">))</span>
		<span class="n">quot</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">__serial_clock_speed_HZ</span> <span class="o">/=</span> <span class="n">quot</span><span class="p">;</span>
	<span class="n">__frv_uart0</span><span class="p">.</span><span class="n">uartclk</span> <span class="o">=</span> <span class="n">__serial_clock_speed_HZ</span><span class="p">;</span>
	<span class="n">__frv_uart1</span><span class="p">.</span><span class="n">uartclk</span> <span class="o">=</span> <span class="n">__serial_clock_speed_HZ</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;      uart=%luMHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__serial_clock_speed_HZ</span> <span class="o">/</span> <span class="mi">1000000</span> <span class="o">*</span> <span class="n">quot</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">__get_UART0_LSR</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">UART_LSR_TEMT</span><span class="p">))</span>
		<span class="k">continue</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">__get_UART1_LSR</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">UART_LSR_TEMT</span><span class="p">))</span>
		<span class="k">continue</span><span class="p">;</span>

	<span class="n">__set_UCPVR</span><span class="p">(</span><span class="n">quot</span><span class="p">);</span>
	<span class="n">__set_UCPSR</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* end determine_clocks() */</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * reserve some DMA consistent memory</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_RESERVE_DMA_COHERENT</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="n">reserve_dma_coherent</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ampr</span><span class="p">;</span>

	<span class="cm">/* find the first non-kernel memory tile and steal it */</span>
<span class="cp">#define __steal_AMPR(r)						\</span>
<span class="cp">	if (__get_DAMPR(r) &amp; xAMPRx_V) {			\</span>
<span class="cp">		ampr = __get_DAMPR(r);				\</span>
<span class="cp">		__set_DAMPR(r, ampr | xAMPRx_S | xAMPRx_C);	\</span>
<span class="cp">		__set_IAMPR(r, 0);				\</span>
<span class="cp">		goto found;					\</span>
<span class="cp">	}</span>

	<span class="n">__steal_AMPR</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">__steal_AMPR</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">__steal_AMPR</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
	<span class="n">__steal_AMPR</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">__steal_AMPR</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="n">__steal_AMPR</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PSR_IMPLE</span><span class="p">(</span><span class="n">__get_PSR</span><span class="p">())</span> <span class="o">==</span> <span class="n">PSR_IMPLE_FR551</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__steal_AMPR</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
		<span class="n">__steal_AMPR</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
		<span class="n">__steal_AMPR</span><span class="p">(</span><span class="mi">9</span><span class="p">);</span>
		<span class="n">__steal_AMPR</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">__steal_AMPR</span><span class="p">(</span><span class="mi">11</span><span class="p">);</span>
		<span class="n">__steal_AMPR</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
		<span class="n">__steal_AMPR</span><span class="p">(</span><span class="mi">13</span><span class="p">);</span>
		<span class="n">__steal_AMPR</span><span class="p">(</span><span class="mi">14</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* unable to grant any DMA consistent memory */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;No DMA consistent memory reserved</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

 <span class="nl">found:</span>
	<span class="n">dma_coherent_mem_start</span> <span class="o">=</span> <span class="n">ampr</span> <span class="o">&amp;</span> <span class="n">xAMPRx_PPFN</span><span class="p">;</span>
	<span class="n">ampr</span> <span class="o">&amp;=</span> <span class="n">xAMPRx_SS</span><span class="p">;</span>
	<span class="n">ampr</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">ampr</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ampr</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
	<span class="n">dma_coherent_mem_end</span> <span class="o">=</span> <span class="n">dma_coherent_mem_start</span> <span class="o">+</span> <span class="n">ampr</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;DMA consistent memory reserved %lx-%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dma_coherent_mem_start</span><span class="p">,</span> <span class="n">dma_coherent_mem_end</span><span class="p">);</span>

<span class="p">}</span> <span class="cm">/* end reserve_dma_coherent() */</span>
<span class="cp">#endif</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * calibrate the delay loop</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">__cpuinit</span> <span class="n">calibrate_delay</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">loops_per_jiffy</span> <span class="o">=</span> <span class="n">__delay_loops_MHz</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1000000</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Calibrating delay loop... %lu.%02lu BogoMIPS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">loops_per_jiffy</span> <span class="o">/</span> <span class="p">(</span><span class="mi">500000</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">),</span>
	       <span class="p">(</span><span class="n">loops_per_jiffy</span> <span class="o">/</span> <span class="p">(</span><span class="mi">5000</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">))</span> <span class="o">%</span> <span class="mi">100</span><span class="p">);</span>

<span class="p">}</span> <span class="cm">/* end calibrate_delay() */</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * look through the command line for some things we need to know immediately</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="n">parse_cmdline_early</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">cmdline</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmdline</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">cmdline</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cmdline</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">)</span>
			<span class="n">cmdline</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* &quot;mem=XXX[kKmM]&quot; sets SDRAM size to &lt;mem&gt;, overriding the value we worked</span>
<span class="cm">		 * out from the SDRAM controller mask register</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">cmdline</span><span class="p">,</span> <span class="s">&quot;mem=&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">mem_size</span><span class="p">;</span>

			<span class="n">mem_size</span> <span class="o">=</span> <span class="n">memparse</span><span class="p">(</span><span class="n">cmdline</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmdline</span><span class="p">);</span>
			<span class="n">memory_end</span> <span class="o">=</span> <span class="n">memory_start</span> <span class="o">+</span> <span class="n">mem_size</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">cmdline</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">cmdline</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span><span class="p">)</span>
			<span class="n">cmdline</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span> <span class="cm">/* end parse_cmdline_early() */</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="n">setup_arch</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">cmdline_p</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_MMU</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Linux FR-V port done by Red Hat Inc &lt;dhowells@redhat.com&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;uClinux FR-V port done by Red Hat Inc &lt;dhowells@redhat.com&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">boot_command_line</span><span class="p">,</span> <span class="n">redboot_command_line</span><span class="p">,</span> <span class="n">COMMAND_LINE_SIZE</span><span class="p">);</span>

	<span class="n">determine_cpu</span><span class="p">();</span>
	<span class="n">determine_clocks</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* For printk-directly-beats-on-serial-hardware hack */</span>
	<span class="n">console_set_baud</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_GDBSTUB</span>
	<span class="n">gdbstub_set_baud</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_RESERVE_DMA_COHERENT</span>
	<span class="n">reserve_dma_coherent</span><span class="p">();</span>
<span class="cp">#endif</span>
	<span class="n">dump_memory_map</span><span class="p">();</span>

<span class="cp">#ifdef CONFIG_MB93090_MB00</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mb93090_mb00_detected</span><span class="p">)</span>
		<span class="n">mb93090_display</span><span class="p">();</span>
<span class="cp">#endif</span>

	<span class="cm">/* register those serial ports that are available */</span>
<span class="cp">#ifdef CONFIG_FRV_ONCPU_SERIAL</span>
<span class="cp">#ifndef CONFIG_GDBSTUB_UART0</span>
	<span class="n">__reg</span><span class="p">(</span><span class="n">UART0_BASE</span> <span class="o">+</span> <span class="n">UART_IER</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">early_serial_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__frv_uart0</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef CONFIG_GDBSTUB_UART1</span>
	<span class="n">__reg</span><span class="p">(</span><span class="n">UART1_BASE</span> <span class="o">+</span> <span class="n">UART_IER</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">early_serial_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__frv_uart1</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

	<span class="cm">/* deal with the command line - RedBoot may have passed one to the kernel */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">command_line</span><span class="p">,</span> <span class="n">boot_command_line</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">command_line</span><span class="p">));</span>
	<span class="o">*</span><span class="n">cmdline_p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">command_line</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">parse_cmdline_early</span><span class="p">(</span><span class="n">command_line</span><span class="p">);</span>

	<span class="cm">/* set up the memory description</span>
<span class="cm">	 * - by now the stack is part of the init task */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Memory %08lx-%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">memory_start</span><span class="p">,</span> <span class="n">memory_end</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">memory_start</span> <span class="o">==</span> <span class="n">memory_end</span><span class="p">);</span>

	<span class="n">init_mm</span><span class="p">.</span><span class="n">start_code</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">_stext</span><span class="p">;</span>
	<span class="n">init_mm</span><span class="p">.</span><span class="n">end_code</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">_etext</span><span class="p">;</span>
	<span class="n">init_mm</span><span class="p">.</span><span class="n">end_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">_edata</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"> /* DAVIDM - don&#39;t set brk just incase someone decides to use it */</span>
<span class="c">	init_mm.brk = (unsigned long) &amp;_end;</span>
<span class="cp">#else</span>
	<span class="n">init_mm</span><span class="p">.</span><span class="n">brk</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;KERNEL -&gt; TEXT=0x%06x-0x%06x DATA=0x%06x-0x%06x BSS=0x%06x-0x%06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">_stext</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">_etext</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">_sdata</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">_edata</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">_sbss</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">_ebss</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_VT</span>
<span class="cp">#if defined(CONFIG_VGA_CONSOLE)</span>
        <span class="n">conswitchp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vga_con</span><span class="p">;</span>
<span class="cp">#elif defined(CONFIG_DUMMY_CONSOLE)</span>
        <span class="n">conswitchp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dummy_con</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_MMU</span>
	<span class="n">setup_linux_memory</span><span class="p">();</span>
<span class="cp">#else</span>
	<span class="n">setup_uclinux_memory</span><span class="p">();</span>
<span class="cp">#endif</span>

	<span class="cm">/* get kmalloc into gear */</span>
	<span class="n">paging_init</span><span class="p">();</span>

	<span class="cm">/* init DMA */</span>
	<span class="n">frv_dma_init</span><span class="p">();</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Done setup_arch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* start the decrement timer running */</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>asm volatile("movgs %0,timerd" :: "r"(10000000));
<em>_set</em>HSR(0, <em>_get</em>HSR(0) | HSR0_ETMD);</p></td><td class="code"><div class="highlight"><pre><span class="p">}</span> <span class="cm">/* end setup_arch() */</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">/*****************************************************************************/</span>
<span class="c">/*</span>
<span class="c"> *</span>
<span class="c"> */</span>
<span class="c">static int __devinit setup_arch_serial(void)</span>
<span class="c">{</span>
<span class="c">	/* register those serial ports that are available */</span>
<span class="cp">#ifndef CONFIG_GDBSTUB_UART0</span>
<span class="c">	early_serial_setup(&amp;__frv_uart0);</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef CONFIG_GDBSTUB_UART1</span>
<span class="c">	early_serial_setup(&amp;__frv_uart1);</span>
<span class="cp">#endif</span>

<span class="c">	return 0;</span>
<span class="c">} /* end setup_arch_serial() */</span>

<span class="c">late_initcall(setup_arch_serial);</span>
<span class="cp">#endif</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * set up the memory map for normal MMU linux</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_MMU</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="n">setup_linux_memory</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bootmap_size</span><span class="p">,</span> <span class="n">low_top_pfn</span><span class="p">,</span> <span class="n">kstart</span><span class="p">,</span> <span class="n">kend</span><span class="p">,</span> <span class="n">high_mem</span><span class="p">;</span>

	<span class="n">kstart</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">__kernel_image_start</span> <span class="o">-</span> <span class="n">PAGE_OFFSET</span><span class="p">;</span>
	<span class="n">kend</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">__kernel_image_end</span> <span class="o">-</span> <span class="n">PAGE_OFFSET</span><span class="p">;</span>

	<span class="n">kstart</span> <span class="o">=</span> <span class="n">kstart</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
	<span class="n">kend</span> <span class="o">=</span> <span class="p">(</span><span class="n">kend</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>

	<span class="cm">/* give all the memory to the bootmap allocator,  tell it to put the</span>
<span class="cm">	 * boot mem_map immediately following the kernel image</span>
<span class="cm">	 */</span>
	<span class="n">bootmap_size</span> <span class="o">=</span> <span class="n">init_bootmem_node</span><span class="p">(</span><span class="n">NODE_DATA</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
					 <span class="n">kend</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span>		<span class="cm">/* map addr */</span>
					 <span class="n">memory_start</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span>	<span class="cm">/* start of RAM */</span>
					 <span class="n">memory_end</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span>	<span class="cm">/* end of RAM */</span>
					 <span class="p">);</span>

	<span class="cm">/* pass the memory that the kernel can immediately use over to the bootmem allocator */</span>
	<span class="n">max_mapnr</span> <span class="o">=</span> <span class="n">num_physpages</span> <span class="o">=</span> <span class="p">(</span><span class="n">memory_end</span> <span class="o">-</span> <span class="n">memory_start</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">low_top_pfn</span> <span class="o">=</span> <span class="p">(</span><span class="n">KERNEL_LOWMEM_END</span> <span class="o">-</span> <span class="n">KERNEL_LOWMEM_START</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">high_mem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_physpages</span> <span class="o">&gt;</span> <span class="n">low_top_pfn</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_HIGHMEM</span>
		<span class="n">high_mem</span> <span class="o">=</span> <span class="n">num_physpages</span> <span class="o">-</span> <span class="n">low_top_pfn</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">max_mapnr</span> <span class="o">=</span> <span class="n">num_physpages</span> <span class="o">=</span> <span class="n">low_top_pfn</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">low_top_pfn</span> <span class="o">=</span> <span class="n">num_physpages</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">min_low_pfn</span> <span class="o">=</span> <span class="n">memory_start</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">max_low_pfn</span> <span class="o">=</span> <span class="n">low_top_pfn</span><span class="p">;</span>
	<span class="n">max_pfn</span> <span class="o">=</span> <span class="n">memory_end</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>

	<span class="n">num_mappedpages</span> <span class="o">=</span> <span class="n">low_top_pfn</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;%ldMB LOWMEM available.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">low_top_pfn</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">20</span> <span class="o">-</span> <span class="n">PAGE_SHIFT</span><span class="p">));</span>

	<span class="n">free_bootmem</span><span class="p">(</span><span class="n">memory_start</span><span class="p">,</span> <span class="n">low_top_pfn</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_HIGHMEM</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">high_mem</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;%ldMB HIGHMEM available.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">high_mem</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">20</span> <span class="o">-</span> <span class="n">PAGE_SHIFT</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="cm">/* take back the memory occupied by the kernel image and the bootmem alloc map */</span>
	<span class="n">reserve_bootmem</span><span class="p">(</span><span class="n">kstart</span><span class="p">,</span> <span class="n">kend</span> <span class="o">-</span> <span class="n">kstart</span> <span class="o">+</span> <span class="n">bootmap_size</span><span class="p">,</span>
			<span class="n">BOOTMEM_DEFAULT</span><span class="p">);</span>

	<span class="cm">/* reserve the memory occupied by the initial ramdisk */</span>
<span class="cp">#ifdef CONFIG_BLK_DEV_INITRD</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">LOADER_TYPE</span> <span class="o">&amp;&amp;</span> <span class="n">INITRD_START</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">INITRD_START</span> <span class="o">+</span> <span class="n">INITRD_SIZE</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">low_top_pfn</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">reserve_bootmem</span><span class="p">(</span><span class="n">INITRD_START</span><span class="p">,</span> <span class="n">INITRD_SIZE</span><span class="p">,</span>
					<span class="n">BOOTMEM_DEFAULT</span><span class="p">);</span>
			<span class="n">initrd_start</span> <span class="o">=</span> <span class="n">INITRD_START</span> <span class="o">+</span> <span class="n">PAGE_OFFSET</span><span class="p">;</span>
			<span class="n">initrd_end</span> <span class="o">=</span> <span class="n">initrd_start</span> <span class="o">+</span> <span class="n">INITRD_SIZE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;initrd extends beyond end of memory (0x%08lx &gt; 0x%08lx)</span><span class="se">\n</span><span class="s">&quot;</span>
			       <span class="s">&quot;disabling initrd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">INITRD_START</span> <span class="o">+</span> <span class="n">INITRD_SIZE</span><span class="p">,</span>
			       <span class="n">low_top_pfn</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>
			<span class="n">initrd_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

<span class="p">}</span> <span class="cm">/* end setup_linux_memory() */</span>
<span class="cp">#endif</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * set up the memory map for uClinux</span>
<span class="cm"> */</span>
<span class="cp">#ifndef CONFIG_MMU</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="n">setup_uclinux_memory</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_PROTECT_KERNEL</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dampr</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">kend</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bootmap_size</span><span class="p">;</span>

	<span class="n">kend</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">__kernel_image_end</span><span class="p">;</span>
	<span class="n">kend</span> <span class="o">=</span> <span class="p">(</span><span class="n">kend</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>

	<span class="cm">/* give all the memory to the bootmap allocator,  tell it to put the</span>
<span class="cm">	 * boot mem_map immediately following the kernel image</span>
<span class="cm">	 */</span>
	<span class="n">bootmap_size</span> <span class="o">=</span> <span class="n">init_bootmem_node</span><span class="p">(</span><span class="n">NODE_DATA</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
					 <span class="n">kend</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span>		<span class="cm">/* map addr */</span>
					 <span class="n">memory_start</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span>	<span class="cm">/* start of RAM */</span>
					 <span class="n">memory_end</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span>	<span class="cm">/* end of RAM */</span>
					 <span class="p">);</span>

	<span class="cm">/* free all the usable memory */</span>
	<span class="n">free_bootmem</span><span class="p">(</span><span class="n">memory_start</span><span class="p">,</span> <span class="n">memory_end</span> <span class="o">-</span> <span class="n">memory_start</span><span class="p">);</span>

	<span class="n">high_memory</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">memory_end</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">);</span>
	<span class="n">max_mapnr</span> <span class="o">=</span> <span class="n">num_physpages</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">high_memory</span> <span class="o">-</span> <span class="n">PAGE_OFFSET</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>

	<span class="n">min_low_pfn</span> <span class="o">=</span> <span class="n">memory_start</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">max_low_pfn</span> <span class="o">=</span> <span class="n">memory_end</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">max_pfn</span> <span class="o">=</span> <span class="n">max_low_pfn</span><span class="p">;</span>

	<span class="cm">/* now take back the bits the core kernel is occupying */</span>
<span class="cp">#ifndef CONFIG_PROTECT_KERNEL</span>
	<span class="n">reserve_bootmem</span><span class="p">(</span><span class="n">kend</span><span class="p">,</span> <span class="n">bootmap_size</span><span class="p">,</span> <span class="n">BOOTMEM_DEFAULT</span><span class="p">);</span>
	<span class="n">reserve_bootmem</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">__kernel_image_start</span><span class="p">,</span>
			<span class="n">kend</span> <span class="o">-</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">__kernel_image_start</span><span class="p">,</span>
			<span class="n">BOOTMEM_DEFAULT</span><span class="p">);</span>

<span class="cp">#else</span>
	<span class="n">dampr</span> <span class="o">=</span> <span class="n">__get_DAMPR</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">dampr</span> <span class="o">&amp;=</span> <span class="n">xAMPRx_SS</span><span class="p">;</span>
	<span class="n">dampr</span> <span class="o">=</span> <span class="p">(</span><span class="n">dampr</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">17</span><span class="p">;</span>
	<span class="n">dampr</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dampr</span><span class="p">;</span>

	<span class="n">reserve_bootmem</span><span class="p">(</span><span class="n">__get_DAMPR</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">xAMPRx_PPFN</span><span class="p">,</span> <span class="n">dampr</span><span class="p">,</span> <span class="n">BOOTMEM_DEFAULT</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* reserve some memory to do uncached DMA through if requested */</span>
<span class="cp">#ifdef CONFIG_RESERVE_DMA_COHERENT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_coherent_mem_start</span><span class="p">)</span>
		<span class="n">reserve_bootmem</span><span class="p">(</span><span class="n">dma_coherent_mem_start</span><span class="p">,</span>
				<span class="n">dma_coherent_mem_end</span> <span class="o">-</span> <span class="n">dma_coherent_mem_start</span><span class="p">,</span>
				<span class="n">BOOTMEM_DEFAULT</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="p">}</span> <span class="cm">/* end setup_uclinux_memory() */</span>
<span class="cp">#endif</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * get CPU information for use by procfs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">show_cpuinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">gr</span><span class="p">,</span> <span class="o">*</span><span class="n">fr</span><span class="p">,</span> <span class="o">*</span><span class="n">fm</span><span class="p">,</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="o">*</span><span class="n">cm</span><span class="p">,</span> <span class="o">*</span><span class="n">nem</span><span class="p">,</span> <span class="o">*</span><span class="n">ble</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sep</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">gr</span>  <span class="o">=</span> <span class="n">cpu_hsr0_all</span> <span class="o">&amp;</span> <span class="n">HSR0_GRHE</span>	<span class="o">?</span> <span class="s">&quot;gr0-63&quot;</span>	<span class="o">:</span> <span class="s">&quot;gr0-31&quot;</span><span class="p">;</span>
	<span class="n">fr</span>  <span class="o">=</span> <span class="n">cpu_hsr0_all</span> <span class="o">&amp;</span> <span class="n">HSR0_FRHE</span>	<span class="o">?</span> <span class="s">&quot;fr0-63&quot;</span>	<span class="o">:</span> <span class="s">&quot;fr0-31&quot;</span><span class="p">;</span>
	<span class="n">fm</span>  <span class="o">=</span> <span class="n">cpu_psr_all</span>  <span class="o">&amp;</span> <span class="n">PSR_EM</span>	<span class="o">?</span> <span class="s">&quot;, Media&quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="n">fp</span>  <span class="o">=</span> <span class="n">cpu_psr_all</span>  <span class="o">&amp;</span> <span class="n">PSR_EF</span>	<span class="o">?</span> <span class="s">&quot;, FPU&quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="n">cm</span>  <span class="o">=</span> <span class="n">cpu_psr_all</span>  <span class="o">&amp;</span> <span class="n">PSR_CM</span>	<span class="o">?</span> <span class="s">&quot;, CCCR&quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="n">nem</span> <span class="o">=</span> <span class="n">cpu_psr_all</span>  <span class="o">&amp;</span> <span class="n">PSR_NEM</span>	<span class="o">?</span> <span class="s">&quot;, NE&quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="n">ble</span> <span class="o">=</span> <span class="n">cpu_psr_all</span>  <span class="o">&amp;</span> <span class="n">PSR_BE</span>	<span class="o">?</span> <span class="s">&quot;BE&quot;</span>		<span class="o">:</span> <span class="s">&quot;LE&quot;</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span>
		   <span class="s">&quot;CPU-Series:</span><span class="se">\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;CPU-Core:</span><span class="se">\t</span><span class="s">%s, %s, %s%s%s</span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;CPU:</span><span class="se">\t\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;MMU:</span><span class="se">\t\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;FP-Media:</span><span class="se">\t</span><span class="s">%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;System:</span><span class="se">\t\t</span><span class="s">%s&quot;</span><span class="p">,</span>
		   <span class="n">cpu_series</span><span class="p">,</span>
		   <span class="n">cpu_core</span><span class="p">,</span> <span class="n">gr</span><span class="p">,</span> <span class="n">ble</span><span class="p">,</span> <span class="n">cm</span><span class="p">,</span> <span class="n">nem</span><span class="p">,</span>
		   <span class="n">cpu_silicon</span><span class="p">,</span>
		   <span class="n">cpu_mmu</span><span class="p">,</span>
		   <span class="n">fr</span><span class="p">,</span> <span class="n">fm</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span>
		   <span class="n">cpu_system</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_board1</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;, %s&quot;</span><span class="p">,</span> <span class="n">cpu_board1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_board2</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;, %s&quot;</span><span class="p">,</span> <span class="n">cpu_board2</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PM</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;PM-Controls:&quot;</span><span class="p">);</span>
	<span class="n">sep</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clock_bits_settable</span> <span class="o">&amp;</span> <span class="n">CLOCK_BIT_CMODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%scmode=0x%04hx&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">clock_cmodes_permitted</span><span class="p">);</span>
		<span class="n">sep</span> <span class="o">=</span> <span class="s">&quot;, &quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clock_bits_settable</span> <span class="o">&amp;</span> <span class="n">CLOCK_BIT_CM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%scm=0x%lx&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">clock_bits_settable</span> <span class="o">&amp;</span> <span class="n">CLOCK_BIT_CM</span><span class="p">);</span>
		<span class="n">sep</span> <span class="o">=</span> <span class="s">&quot;, &quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clock_bits_settable</span> <span class="o">&amp;</span> <span class="n">CLOCK_BIT_P0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%sp0=0x3&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="p">);</span>
		<span class="n">sep</span> <span class="o">=</span> <span class="s">&quot;, &quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%ssuspend=0x22</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span>
		   <span class="s">&quot;PM-Status:</span><span class="se">\t</span><span class="s">cmode=%d, cm=%d, p0=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">clock_cmode_current</span><span class="p">,</span> <span class="n">clock_cm_current</span><span class="p">,</span> <span class="n">clock_p0_current</span><span class="p">);</span>

<span class="cp">#define print_clk(TAG, VAR) \</span>
<span class="cp">	seq_printf(m, &quot;Clock-&quot; TAG &quot;:\t%lu.%2.2lu MHz\n&quot;, VAR / 1000000, (VAR / 10000) % 100)</span>

	<span class="n">print_clk</span><span class="p">(</span><span class="s">&quot;In&quot;</span><span class="p">,</span>    <span class="n">__clkin_clock_speed_HZ</span><span class="p">);</span>
	<span class="n">print_clk</span><span class="p">(</span><span class="s">&quot;Core&quot;</span><span class="p">,</span>  <span class="n">__core_clock_speed_HZ</span><span class="p">);</span>
	<span class="n">print_clk</span><span class="p">(</span><span class="s">&quot;SDRAM&quot;</span><span class="p">,</span> <span class="n">__sdram_clock_speed_HZ</span><span class="p">);</span>
	<span class="n">print_clk</span><span class="p">(</span><span class="s">&quot;CBus&quot;</span><span class="p">,</span>  <span class="n">__core_bus_clock_speed_HZ</span><span class="p">);</span>
	<span class="n">print_clk</span><span class="p">(</span><span class="s">&quot;Res&quot;</span><span class="p">,</span>   <span class="n">__res_bus_clock_speed_HZ</span><span class="p">);</span>
	<span class="n">print_clk</span><span class="p">(</span><span class="s">&quot;Ext&quot;</span><span class="p">,</span>   <span class="n">__ext_bus_clock_speed_HZ</span><span class="p">);</span>
	<span class="n">print_clk</span><span class="p">(</span><span class="s">&quot;DSU&quot;</span><span class="p">,</span>   <span class="n">__dsu_clock_speed_HZ</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span>
		   <span class="s">&quot;BogoMips:</span><span class="se">\t</span><span class="s">%lu.%02lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">loops_per_jiffy</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">/</span> <span class="mi">500000</span><span class="p">,</span> <span class="p">((</span><span class="n">loops_per_jiffy</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5000</span><span class="p">)</span> <span class="o">%</span> <span class="mi">100</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end show_cpuinfo() */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">c_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">*</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">NR_CPUS</span> <span class="o">?</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="mh">0x12345678</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">c_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">++*</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">c_start</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">c_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">cpuinfo_op</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">c_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>	<span class="o">=</span> <span class="n">c_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>	<span class="o">=</span> <span class="n">c_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>	<span class="o">=</span> <span class="n">show_cpuinfo</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">arch_gettod</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">year</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">mon</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">day</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">hour</span><span class="p">,</span>
		 <span class="kt">int</span> <span class="o">*</span><span class="n">min</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">sec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">year</span> <span class="o">=</span> <span class="o">*</span><span class="n">mon</span> <span class="o">=</span> <span class="o">*</span><span class="n">day</span> <span class="o">=</span> <span class="o">*</span><span class="n">hour</span> <span class="o">=</span> <span class="o">*</span><span class="n">min</span> <span class="o">=</span> <span class="o">*</span><span class="n">sec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_MB93090_MB00</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">mb93090_sendlcdcmd</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span> <span class="o">=</span> <span class="n">__addr_LCD</span><span class="p">();</span>
	<span class="kt">int</span> <span class="n">loop</span><span class="p">;</span>

	<span class="cm">/* request reading of the busy flag */</span>
	<span class="n">__set_LCD</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">LCD_CMD_READ_BUSY</span><span class="p">);</span>
	<span class="n">__set_LCD</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">LCD_CMD_READ_BUSY</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LCD_E</span><span class="p">);</span>

	<span class="cm">/* wait for the busy flag to become clear */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span><span class="o">--</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">__get_LCD</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* send the command */</span>
	<span class="n">__set_LCD</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">__set_LCD</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">cmd</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LCD_E</span><span class="p">);</span>

<span class="p">}</span> <span class="cm">/* end mb93090_sendlcdcmd() */</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * write to the MB93090 LEDs and LCD</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">mb93090_display</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">__set_LEDS</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* set up the LCD */</span>
	<span class="n">mb93090_sendlcdcmd</span><span class="p">(</span><span class="n">LCD_CMD_CLEAR</span><span class="p">);</span>
	<span class="n">mb93090_sendlcdcmd</span><span class="p">(</span><span class="n">LCD_CMD_FUNCSET</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">mb93090_sendlcdcmd</span><span class="p">(</span><span class="n">LCD_CMD_ON</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">mb93090_sendlcdcmd</span><span class="p">(</span><span class="n">LCD_CMD_HOME</span><span class="p">);</span>

	<span class="n">mb93090_sendlcdcmd</span><span class="p">(</span><span class="n">LCD_CMD_SET_DD_ADDR</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">mb93090_banner</span><span class="p">;</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mb93090_sendlcdcmd</span><span class="p">(</span><span class="n">LCD_DATA_WRITE</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">));</span>

	<span class="n">mb93090_sendlcdcmd</span><span class="p">(</span><span class="n">LCD_CMD_SET_DD_ADDR</span><span class="p">(</span><span class="mi">64</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">mb93090_version</span><span class="p">;</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mb93090_sendlcdcmd</span><span class="p">(</span><span class="n">LCD_DATA_WRITE</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">));</span>

<span class="p">}</span> <span class="cm">/* end mb93090_display() */</span>

<span class="cp">#endif </span><span class="c1">// CONFIG_MB93090_MB00</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
