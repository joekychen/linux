<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › mach-ixp4xx › ixp4xx_npe.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ixp4xx_npe.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Intel IXP4xx Network Processor Engine driver for Linux</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007 Krzysztof Halasa &lt;khc@pm.waw.pl&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of version 2 of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * The code is based on publicly available information:</span>
<span class="cm"> * - Intel IXP4xx Developer&#39;s Manual and other e-papers</span>
<span class="cm"> * - Intel IXP400 Access Library Software (BSD license)</span>
<span class="cm"> * - previous works by Christian Hohnstaedt &lt;chohnstaedt@innominate.com&gt;</span>
<span class="cm"> *   Thanks, Christian.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;mach/npe.h&gt;</span>

<span class="cp">#define DEBUG_MSG			0</span>
<span class="cp">#define DEBUG_FW			0</span>

<span class="cp">#define NPE_COUNT			3</span>
<span class="cp">#define MAX_RETRIES			1000	</span><span class="cm">/* microseconds */</span><span class="cp"></span>
<span class="cp">#define NPE_42X_DATA_SIZE		0x800	</span><span class="cm">/* in dwords */</span><span class="cp"></span>
<span class="cp">#define NPE_46X_DATA_SIZE		0x1000</span>
<span class="cp">#define NPE_A_42X_INSTR_SIZE		0x1000</span>
<span class="cp">#define NPE_B_AND_C_42X_INSTR_SIZE	0x800</span>
<span class="cp">#define NPE_46X_INSTR_SIZE		0x1000</span>
<span class="cp">#define REGS_SIZE			0x1000</span>

<span class="cp">#define NPE_PHYS_REG			32</span>

<span class="cp">#define FW_MAGIC			0xFEEDF00D</span>
<span class="cp">#define FW_BLOCK_TYPE_INSTR		0x0</span>
<span class="cp">#define FW_BLOCK_TYPE_DATA		0x1</span>
<span class="cp">#define FW_BLOCK_TYPE_EOF		0xF</span>

<span class="cm">/* NPE exec status (read) and command (write) */</span>
<span class="cp">#define CMD_NPE_STEP			0x01</span>
<span class="cp">#define CMD_NPE_START			0x02</span>
<span class="cp">#define CMD_NPE_STOP			0x03</span>
<span class="cp">#define CMD_NPE_CLR_PIPE		0x04</span>
<span class="cp">#define CMD_CLR_PROFILE_CNT		0x0C</span>
<span class="cp">#define CMD_RD_INS_MEM			0x10 </span><span class="cm">/* instruction memory */</span><span class="cp"></span>
<span class="cp">#define CMD_WR_INS_MEM			0x11</span>
<span class="cp">#define CMD_RD_DATA_MEM			0x12 </span><span class="cm">/* data memory */</span><span class="cp"></span>
<span class="cp">#define CMD_WR_DATA_MEM			0x13</span>
<span class="cp">#define CMD_RD_ECS_REG			0x14 </span><span class="cm">/* exec access register */</span><span class="cp"></span>
<span class="cp">#define CMD_WR_ECS_REG			0x15</span>

<span class="cp">#define STAT_RUN			0x80000000</span>
<span class="cp">#define STAT_STOP			0x40000000</span>
<span class="cp">#define STAT_CLEAR			0x20000000</span>
<span class="cp">#define STAT_ECS_K			0x00800000 </span><span class="cm">/* pipeline clean */</span><span class="cp"></span>

<span class="cp">#define NPE_STEVT			0x1B</span>
<span class="cp">#define NPE_STARTPC			0x1C</span>
<span class="cp">#define NPE_REGMAP			0x1E</span>
<span class="cp">#define NPE_CINDEX			0x1F</span>

<span class="cp">#define INSTR_WR_REG_SHORT		0x0000C000</span>
<span class="cp">#define INSTR_WR_REG_BYTE		0x00004000</span>
<span class="cp">#define INSTR_RD_FIFO			0x0F888220</span>
<span class="cp">#define INSTR_RESET_MBOX		0x0FAC8210</span>

<span class="cp">#define ECS_BG_CTXT_REG_0		0x00 </span><span class="cm">/* Background Executing Context */</span><span class="cp"></span>
<span class="cp">#define ECS_BG_CTXT_REG_1		0x01 </span><span class="cm">/*		Stack level */</span><span class="cp"></span>
<span class="cp">#define ECS_BG_CTXT_REG_2		0x02</span>
<span class="cp">#define ECS_PRI_1_CTXT_REG_0		0x04 </span><span class="cm">/* Priority 1 Executing Context */</span><span class="cp"></span>
<span class="cp">#define ECS_PRI_1_CTXT_REG_1		0x05 </span><span class="cm">/*		Stack level */</span><span class="cp"></span>
<span class="cp">#define ECS_PRI_1_CTXT_REG_2		0x06</span>
<span class="cp">#define ECS_PRI_2_CTXT_REG_0		0x08 </span><span class="cm">/* Priority 2 Executing Context */</span><span class="cp"></span>
<span class="cp">#define ECS_PRI_2_CTXT_REG_1		0x09 </span><span class="cm">/*		Stack level */</span><span class="cp"></span>
<span class="cp">#define ECS_PRI_2_CTXT_REG_2		0x0A</span>
<span class="cp">#define ECS_DBG_CTXT_REG_0		0x0C </span><span class="cm">/* Debug Executing Context */</span><span class="cp"></span>
<span class="cp">#define ECS_DBG_CTXT_REG_1		0x0D </span><span class="cm">/*		Stack level */</span><span class="cp"></span>
<span class="cp">#define ECS_DBG_CTXT_REG_2		0x0E</span>
<span class="cp">#define ECS_INSTRUCT_REG		0x11 </span><span class="cm">/* NPE Instruction Register */</span><span class="cp"></span>

<span class="cp">#define ECS_REG_0_ACTIVE		0x80000000 </span><span class="cm">/* all levels */</span><span class="cp"></span>
<span class="cp">#define ECS_REG_0_NEXTPC_MASK		0x1FFF0000 </span><span class="cm">/* BG/PRI1/PRI2 levels */</span><span class="cp"></span>
<span class="cp">#define ECS_REG_0_LDUR_BITS		8</span>
<span class="cp">#define ECS_REG_0_LDUR_MASK		0x00000700 </span><span class="cm">/* all levels */</span><span class="cp"></span>
<span class="cp">#define ECS_REG_1_CCTXT_BITS		16</span>
<span class="cp">#define ECS_REG_1_CCTXT_MASK		0x000F0000 </span><span class="cm">/* all levels */</span><span class="cp"></span>
<span class="cp">#define ECS_REG_1_SELCTXT_BITS		0</span>
<span class="cp">#define ECS_REG_1_SELCTXT_MASK		0x0000000F </span><span class="cm">/* all levels */</span><span class="cp"></span>
<span class="cp">#define ECS_DBG_REG_2_IF		0x00100000 </span><span class="cm">/* debug level */</span><span class="cp"></span>
<span class="cp">#define ECS_DBG_REG_2_IE		0x00080000 </span><span class="cm">/* debug level */</span><span class="cp"></span>

<span class="cm">/* NPE watchpoint_fifo register bit */</span>
<span class="cp">#define WFIFO_VALID			0x80000000</span>

<span class="cm">/* NPE messaging_status register bit definitions */</span>
<span class="cp">#define MSGSTAT_OFNE	0x00010000 </span><span class="cm">/* OutFifoNotEmpty */</span><span class="cp"></span>
<span class="cp">#define MSGSTAT_IFNF	0x00020000 </span><span class="cm">/* InFifoNotFull */</span><span class="cp"></span>
<span class="cp">#define MSGSTAT_OFNF	0x00040000 </span><span class="cm">/* OutFifoNotFull */</span><span class="cp"></span>
<span class="cp">#define MSGSTAT_IFNE	0x00080000 </span><span class="cm">/* InFifoNotEmpty */</span><span class="cp"></span>
<span class="cp">#define MSGSTAT_MBINT	0x00100000 </span><span class="cm">/* Mailbox interrupt */</span><span class="cp"></span>
<span class="cp">#define MSGSTAT_IFINT	0x00200000 </span><span class="cm">/* InFifo interrupt */</span><span class="cp"></span>
<span class="cp">#define MSGSTAT_OFINT	0x00400000 </span><span class="cm">/* OutFifo interrupt */</span><span class="cp"></span>
<span class="cp">#define MSGSTAT_WFINT	0x00800000 </span><span class="cm">/* WatchFifo interrupt */</span><span class="cp"></span>

<span class="cm">/* NPE messaging_control register bit definitions */</span>
<span class="cp">#define MSGCTL_OUT_FIFO			0x00010000 </span><span class="cm">/* enable output FIFO */</span><span class="cp"></span>
<span class="cp">#define MSGCTL_IN_FIFO			0x00020000 </span><span class="cm">/* enable input FIFO */</span><span class="cp"></span>
<span class="cp">#define MSGCTL_OUT_FIFO_WRITE		0x01000000 </span><span class="cm">/* enable FIFO + WRITE */</span><span class="cp"></span>
<span class="cp">#define MSGCTL_IN_FIFO_WRITE		0x02000000</span>

<span class="cm">/* NPE mailbox_status value for reset */</span>
<span class="cp">#define RESET_MBOX_STAT			0x0000F0F0</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">npe_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;NPE-A&quot;</span><span class="p">,</span> <span class="s">&quot;NPE-B&quot;</span><span class="p">,</span> <span class="s">&quot;NPE-C&quot;</span> <span class="p">};</span>

<span class="cp">#define print_npe(pri, npe, fmt, ...)					\</span>
<span class="cp">	printk(pri &quot;%s: &quot; fmt, npe_name(npe), ## __VA_ARGS__)</span>

<span class="cp">#if DEBUG_MSG</span>
<span class="cp">#define debug_msg(npe, fmt, ...)					\</span>
<span class="cp">	print_npe(KERN_DEBUG, npe, fmt, ## __VA_ARGS__)</span>
<span class="cp">#else</span>
<span class="cp">#define debug_msg(npe, fmt, ...)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ecs_reset</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">ECS_BG_CTXT_REG_0</span><span class="p">,</span>	<span class="mh">0xA0000000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ECS_BG_CTXT_REG_1</span><span class="p">,</span>	<span class="mh">0x01000000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ECS_BG_CTXT_REG_2</span><span class="p">,</span>	<span class="mh">0x00008000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ECS_PRI_1_CTXT_REG_0</span><span class="p">,</span>	<span class="mh">0x20000080</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ECS_PRI_1_CTXT_REG_1</span><span class="p">,</span>	<span class="mh">0x01000000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ECS_PRI_1_CTXT_REG_2</span><span class="p">,</span>	<span class="mh">0x00008000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ECS_PRI_2_CTXT_REG_0</span><span class="p">,</span>	<span class="mh">0x20000080</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ECS_PRI_2_CTXT_REG_1</span><span class="p">,</span>	<span class="mh">0x01000000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ECS_PRI_2_CTXT_REG_2</span><span class="p">,</span>	<span class="mh">0x00008000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ECS_DBG_CTXT_REG_0</span><span class="p">,</span>	<span class="mh">0x20000000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ECS_DBG_CTXT_REG_1</span><span class="p">,</span>	<span class="mh">0x00000000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ECS_DBG_CTXT_REG_2</span><span class="p">,</span>	<span class="mh">0x001E0000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ECS_INSTRUCT_REG</span><span class="p">,</span>	<span class="mh">0x1003C00F</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">npe</span> <span class="n">npe_tab</span><span class="p">[</span><span class="n">NPE_COUNT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">regs</span>	<span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">npe_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">IXP4XX_NPEA_BASE_VIRT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">regs_phys</span> <span class="o">=</span> <span class="n">IXP4XX_NPEA_BASE_PHYS</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">regs</span>	<span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">npe_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">IXP4XX_NPEB_BASE_VIRT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">regs_phys</span> <span class="o">=</span> <span class="n">IXP4XX_NPEB_BASE_PHYS</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">regs</span>	<span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">npe_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">IXP4XX_NPEC_BASE_VIRT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">regs_phys</span> <span class="o">=</span> <span class="n">IXP4XX_NPEC_BASE_PHYS</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">npe_running</span><span class="p">(</span><span class="k">struct</span> <span class="n">npe</span> <span class="o">*</span><span class="n">npe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">exec_status_cmd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">STAT_RUN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">npe_cmd_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">npe</span> <span class="o">*</span><span class="n">npe</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">exec_data</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">exec_addr</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">exec_status_cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">npe_cmd_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">npe</span> <span class="o">*</span><span class="n">npe</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">exec_addr</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">exec_status_cmd</span><span class="p">);</span>
	<span class="cm">/* Iintroduce extra read cycles after issuing read command to NPE</span>
<span class="cm">	   so that we read the register after the NPE has updated it.</span>
<span class="cm">	   This is to overcome race condition between XScale and NPE */</span>
	<span class="n">__raw_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">exec_data</span><span class="p">);</span>
	<span class="n">__raw_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">exec_data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">exec_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">npe_clear_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">npe</span> <span class="o">*</span><span class="n">npe</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">npe_cmd_read</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">CMD_RD_ECS_REG</span><span class="p">);</span>
	<span class="n">npe_cmd_write</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">CMD_WR_ECS_REG</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ECS_REG_0_ACTIVE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">npe_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">npe</span> <span class="o">*</span><span class="n">npe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* ensure only Background Context Stack Level is active */</span>
	<span class="n">npe_clear_active</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="n">ECS_PRI_1_CTXT_REG_0</span><span class="p">);</span>
	<span class="n">npe_clear_active</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="n">ECS_PRI_2_CTXT_REG_0</span><span class="p">);</span>
	<span class="n">npe_clear_active</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="n">ECS_DBG_CTXT_REG_0</span><span class="p">);</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">CMD_NPE_CLR_PIPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">exec_status_cmd</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">CMD_NPE_START</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">exec_status_cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">npe_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">npe</span> <span class="o">*</span><span class="n">npe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">CMD_NPE_STOP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">exec_status_cmd</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">CMD_NPE_CLR_PIPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">exec_status_cmd</span><span class="p">);</span> <span class="cm">/*FIXME?*/</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__must_check</span> <span class="nf">npe_debug_instr</span><span class="p">(</span><span class="k">struct</span> <span class="n">npe</span> <span class="o">*</span><span class="n">npe</span><span class="p">,</span> <span class="n">u32</span> <span class="n">instr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ctx</span><span class="p">,</span>
					<span class="n">u32</span> <span class="n">ldur</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">wc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* set the Active bit, and the LDUR, in the debug level */</span>
	<span class="n">npe_cmd_write</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="n">ECS_DBG_CTXT_REG_0</span><span class="p">,</span> <span class="n">CMD_WR_ECS_REG</span><span class="p">,</span>
		      <span class="n">ECS_REG_0_ACTIVE</span> <span class="o">|</span> <span class="p">(</span><span class="n">ldur</span> <span class="o">&lt;&lt;</span> <span class="n">ECS_REG_0_LDUR_BITS</span><span class="p">));</span>

	<span class="cm">/* set CCTXT at ECS DEBUG L3 to specify in which context to execute</span>
<span class="cm">	   the instruction, and set SELCTXT at ECS DEBUG Level to specify</span>
<span class="cm">	   which context store to access.</span>
<span class="cm">	   Debug ECS Level Reg 1 has form 0x000n000n, where n = context number</span>
<span class="cm">	*/</span>
	<span class="n">npe_cmd_write</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="n">ECS_DBG_CTXT_REG_1</span><span class="p">,</span> <span class="n">CMD_WR_ECS_REG</span><span class="p">,</span>
		      <span class="p">(</span><span class="n">ctx</span> <span class="o">&lt;&lt;</span> <span class="n">ECS_REG_1_CCTXT_BITS</span><span class="p">)</span> <span class="o">|</span>
		      <span class="p">(</span><span class="n">ctx</span> <span class="o">&lt;&lt;</span> <span class="n">ECS_REG_1_SELCTXT_BITS</span><span class="p">));</span>

	<span class="cm">/* clear the pipeline */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">CMD_NPE_CLR_PIPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">exec_status_cmd</span><span class="p">);</span>

	<span class="cm">/* load NPE instruction into the instruction register */</span>
	<span class="n">npe_cmd_write</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="n">ECS_INSTRUCT_REG</span><span class="p">,</span> <span class="n">CMD_WR_ECS_REG</span><span class="p">,</span> <span class="n">instr</span><span class="p">);</span>

	<span class="cm">/* we need this value later to wait for completion of NPE execution</span>
<span class="cm">	   step */</span>
	<span class="n">wc</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">watch_count</span><span class="p">);</span>

	<span class="cm">/* issue a Step One command via the Execution Control register */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">CMD_NPE_STEP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">exec_status_cmd</span><span class="p">);</span>

	<span class="cm">/* Watch Count register increments when NPE completes an instruction */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_RETRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wc</span> <span class="o">!=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">watch_count</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">print_npe</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">npe</span><span class="p">,</span> <span class="s">&quot;reset: npe_debug_instr(): timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__must_check</span> <span class="nf">npe_logical_reg_write8</span><span class="p">(</span><span class="k">struct</span> <span class="n">npe</span> <span class="o">*</span><span class="n">npe</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span>
					       <span class="n">u8</span> <span class="n">val</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* here we build the NPE assembler instruction: mov8 d0, #0 */</span>
	<span class="n">u32</span> <span class="n">instr</span> <span class="o">=</span> <span class="n">INSTR_WR_REG_BYTE</span> <span class="o">|</span>	<span class="cm">/* OpCode */</span>
		<span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span> <span class="o">|</span>		<span class="cm">/* base Operand */</span>
		<span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">|</span>	<span class="cm">/* lower 5 bits to immediate data */</span>
		<span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">18</span> <span class="o">-</span> <span class="mi">5</span><span class="p">);</span><span class="cm">/* higher 3 bits to CoProc instr. */</span>
	<span class="k">return</span> <span class="n">npe_debug_instr</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="n">instr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* execute it */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__must_check</span> <span class="nf">npe_logical_reg_write16</span><span class="p">(</span><span class="k">struct</span> <span class="n">npe</span> <span class="o">*</span><span class="n">npe</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span>
						<span class="n">u16</span> <span class="n">val</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* here we build the NPE assembler instruction: mov16 d0, #0 */</span>
	<span class="n">u32</span> <span class="n">instr</span> <span class="o">=</span> <span class="n">INSTR_WR_REG_SHORT</span> <span class="o">|</span> <span class="cm">/* OpCode */</span>
		<span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span> <span class="o">|</span>		<span class="cm">/* base Operand */</span>
		<span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">|</span>	<span class="cm">/* lower 5 bits to immediate data */</span>
		<span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">18</span> <span class="o">-</span> <span class="mi">5</span><span class="p">);</span><span class="cm">/* higher 11 bits to CoProc instr. */</span>
	<span class="k">return</span> <span class="n">npe_debug_instr</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="n">instr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* execute it */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__must_check</span> <span class="nf">npe_logical_reg_write32</span><span class="p">(</span><span class="k">struct</span> <span class="n">npe</span> <span class="o">*</span><span class="n">npe</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span>
						<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* write in 16 bit steps first the high and then the low value */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">npe_logical_reg_write16</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">ctx</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">npe_logical_reg_write16</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">npe_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">npe</span> <span class="o">*</span><span class="n">npe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">ctl</span><span class="p">,</span> <span class="n">exec_count</span><span class="p">,</span> <span class="n">ctx_reg2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ctl</span> <span class="o">=</span> <span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">messaging_control</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x3F000000</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="mh">0x3F3FFFFF</span><span class="p">;</span>

	<span class="cm">/* disable parity interrupt */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="mh">0x3F00FFFF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">messaging_control</span><span class="p">);</span>

	<span class="cm">/* pre exec - debug instruction */</span>
	<span class="cm">/* turn off the halt bit by clearing Execution Count register. */</span>
	<span class="n">exec_count</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">exec_count</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">exec_count</span><span class="p">);</span>
	<span class="cm">/* ensure that IF and IE are on (temporarily), so that we don&#39;t end up</span>
<span class="cm">	   stepping forever */</span>
	<span class="n">ctx_reg2</span> <span class="o">=</span> <span class="n">npe_cmd_read</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="n">ECS_DBG_CTXT_REG_2</span><span class="p">,</span> <span class="n">CMD_RD_ECS_REG</span><span class="p">);</span>
	<span class="n">npe_cmd_write</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="n">ECS_DBG_CTXT_REG_2</span><span class="p">,</span> <span class="n">CMD_WR_ECS_REG</span><span class="p">,</span> <span class="n">ctx_reg2</span> <span class="o">|</span>
		      <span class="n">ECS_DBG_REG_2_IF</span> <span class="o">|</span> <span class="n">ECS_DBG_REG_2_IE</span><span class="p">);</span>

	<span class="cm">/* clear the FIFOs */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">watchpoint_fifo</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">WFIFO_VALID</span><span class="p">)</span>
		<span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">messaging_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MSGSTAT_OFNE</span><span class="p">)</span>
		<span class="cm">/* read from the outFIFO until empty */</span>
		<span class="n">print_npe</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">npe</span><span class="p">,</span> <span class="s">&quot;npe_reset: read FIFO = 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">__raw_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">in_out_fifo</span><span class="p">));</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">messaging_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MSGSTAT_IFNE</span><span class="p">)</span>
		<span class="cm">/* step execution of the NPE intruction to read inFIFO using</span>
<span class="cm">		   the Debug Executing Context stack */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">npe_debug_instr</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="n">INSTR_RD_FIFO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

	<span class="cm">/* reset the mailbox reg from the XScale side */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">RESET_MBOX_STAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">mailbox_status</span><span class="p">);</span>
	<span class="cm">/* from NPE side */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">npe_debug_instr</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="n">INSTR_RESET_MBOX</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

	<span class="cm">/* Reset the physical registers in the NPE register file */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">NPE_PHYS_REG</span><span class="p">;</span> <span class="n">val</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">npe_logical_reg_write16</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="n">NPE_REGMAP</span><span class="p">,</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="cm">/* address is either 0 or 4 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">npe_logical_reg_write32</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Reset the context store = each context&#39;s Context Store registers */</span>

	<span class="cm">/* Context 0 has no STARTPC. Instead, this value is used to set NextPC</span>
<span class="cm">	   for Background ECS, to set where NPE starts executing code */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">npe_cmd_read</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="n">ECS_BG_CTXT_REG_0</span><span class="p">,</span> <span class="n">CMD_RD_ECS_REG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ECS_REG_0_NEXTPC_MASK</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">0</span> <span class="cm">/* NextPC */</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ECS_REG_0_NEXTPC_MASK</span><span class="p">;</span>
	<span class="n">npe_cmd_write</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="n">ECS_BG_CTXT_REG_0</span><span class="p">,</span> <span class="n">CMD_WR_ECS_REG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Context 0 has no STEVT nor STARTPC */</span>
			<span class="cm">/* STEVT = off, 0x80 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">npe_logical_reg_write8</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="n">NPE_STEVT</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">npe_logical_reg_write16</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="n">NPE_STARTPC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* REGMAP = d0-&gt;p0, d8-&gt;p2, d16-&gt;p4 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">npe_logical_reg_write16</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="n">NPE_REGMAP</span><span class="p">,</span> <span class="mh">0x820</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">npe_logical_reg_write8</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="n">NPE_CINDEX</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* post exec */</span>
	<span class="cm">/* clear active bit in debug level */</span>
	<span class="n">npe_cmd_write</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="n">ECS_DBG_CTXT_REG_0</span><span class="p">,</span> <span class="n">CMD_WR_ECS_REG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* clear the pipeline */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">CMD_NPE_CLR_PIPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">exec_status_cmd</span><span class="p">);</span>
	<span class="cm">/* restore previous values */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">exec_count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">exec_count</span><span class="p">);</span>
	<span class="n">npe_cmd_write</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="n">ECS_DBG_CTXT_REG_2</span><span class="p">,</span> <span class="n">CMD_WR_ECS_REG</span><span class="p">,</span> <span class="n">ctx_reg2</span><span class="p">);</span>

	<span class="cm">/* write reset values to Execution Context Stack registers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ecs_reset</span><span class="p">);</span> <span class="n">val</span><span class="o">++</span><span class="p">)</span>
		<span class="n">npe_cmd_write</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="n">ecs_reset</span><span class="p">[</span><span class="n">val</span><span class="p">].</span><span class="n">reg</span><span class="p">,</span> <span class="n">CMD_WR_ECS_REG</span><span class="p">,</span>
			      <span class="n">ecs_reset</span><span class="p">[</span><span class="n">val</span><span class="p">].</span><span class="n">val</span><span class="p">);</span>

	<span class="cm">/* clear the profile counter */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">CMD_CLR_PROFILE_CNT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">exec_status_cmd</span><span class="p">);</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">exec_count</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">action_points</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">action_points</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">action_points</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">action_points</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">watch_count</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">ixp4xx_read_feature_bits</span><span class="p">();</span>
	<span class="cm">/* reset the NPE */</span>
	<span class="n">ixp4xx_write_feature_bits</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span>
				  <span class="o">~</span><span class="p">(</span><span class="n">IXP4XX_FEATURE_RESET_NPEA</span> <span class="o">&lt;&lt;</span> <span class="n">npe</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">));</span>
	<span class="cm">/* deassert reset */</span>
	<span class="n">ixp4xx_write_feature_bits</span><span class="p">(</span><span class="n">val</span> <span class="o">|</span>
				  <span class="p">(</span><span class="n">IXP4XX_FEATURE_RESET_NPEA</span> <span class="o">&lt;&lt;</span> <span class="n">npe</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_RETRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ixp4xx_read_feature_bits</span><span class="p">()</span> <span class="o">&amp;</span>
		    <span class="p">(</span><span class="n">IXP4XX_FEATURE_RESET_NPEA</span> <span class="o">&lt;&lt;</span> <span class="n">npe</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>	<span class="cm">/* NPE is back alive */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">MAX_RETRIES</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

	<span class="n">npe_stop</span><span class="p">(</span><span class="n">npe</span><span class="p">);</span>

	<span class="cm">/* restore NPE configuration bus Control Register - parity settings */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">ctl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">messaging_control</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">npe_send_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">npe</span> <span class="o">*</span><span class="n">npe</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">what</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">send</span> <span class="o">=</span> <span class="n">msg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cycles</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">debug_msg</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="s">&quot;Trying to send message %s [%08X:%08X]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">what</span><span class="p">,</span> <span class="n">send</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">send</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">messaging_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MSGSTAT_IFNE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">debug_msg</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="s">&quot;NPE input FIFO not empty</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">send</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">in_out_fifo</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">messaging_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MSGSTAT_IFNF</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">debug_msg</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="s">&quot;NPE input FIFO full</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">send</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">in_out_fifo</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">cycles</span> <span class="o">&lt;</span> <span class="n">MAX_RETRIES</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">messaging_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MSGSTAT_IFNE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">cycles</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cycles</span> <span class="o">==</span> <span class="n">MAX_RETRIES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">debug_msg</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="s">&quot;Timeout sending message</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if DEBUG_MSG &gt; 1</span>
	<span class="n">debug_msg</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="s">&quot;Sending a message took %i cycles</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cycles</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">npe_recv_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">npe</span> <span class="o">*</span><span class="n">npe</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">what</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">recv</span> <span class="o">=</span> <span class="n">msg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cycles</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">debug_msg</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="s">&quot;Trying to receive message %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">what</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">cycles</span> <span class="o">&lt;</span> <span class="n">MAX_RETRIES</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">messaging_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MSGSTAT_OFNE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">recv</span><span class="p">[</span><span class="n">cnt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">in_out_fifo</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">cycles</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">debug_msg</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="s">&quot;Received [%08X]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">recv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">debug_msg</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="s">&quot;Received [%08X:%08X]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">recv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">recv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cycles</span> <span class="o">==</span> <span class="n">MAX_RETRIES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">debug_msg</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="s">&quot;Timeout waiting for message</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if DEBUG_MSG &gt; 1</span>
	<span class="n">debug_msg</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="s">&quot;Receiving a message took %i cycles</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cycles</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">npe_send_recv_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">npe</span> <span class="o">*</span><span class="n">npe</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">what</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">send</span> <span class="o">=</span> <span class="n">msg</span><span class="p">,</span> <span class="n">recv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">result</span> <span class="o">=</span> <span class="n">npe_send_message</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">what</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">result</span> <span class="o">=</span> <span class="n">npe_recv_message</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="n">recv</span><span class="p">,</span> <span class="n">what</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">recv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">send</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">||</span> <span class="p">(</span><span class="n">recv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">send</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">debug_msg</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="s">&quot;Message %s: unexpected message received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">what</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">npe_load_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">npe</span> <span class="o">*</span><span class="n">npe</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw_entry</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">dl_block</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">type</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>
	<span class="p">}</span> <span class="o">*</span><span class="n">blk</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">dl_image</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">magic</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">id</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">size</span><span class="p">;</span>
		<span class="k">union</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="k">struct</span> <span class="n">dl_block</span> <span class="n">blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="p">};</span>
	<span class="p">}</span> <span class="o">*</span><span class="n">image</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">dl_codeblock</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">npe_addr</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span> <span class="o">*</span><span class="n">cb</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">data_size</span><span class="p">,</span> <span class="n">instr_size</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="n">table_end</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_entry</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw_entry</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dl_image</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">print_npe</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">npe</span><span class="p">,</span> <span class="s">&quot;incomplete firmware file</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">image</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dl_image</span><span class="o">*</span><span class="p">)</span><span class="n">fw_entry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

<span class="cp">#if DEBUG_FW</span>
	<span class="n">print_npe</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">npe</span><span class="p">,</span> <span class="s">&quot;firmware: %08X %08X %08X (0x%X bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">image</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">,</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">swab32</span><span class="p">(</span><span class="n">FW_MAGIC</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* swapped file */</span>
		<span class="n">image</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">image</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">FW_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">print_npe</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">npe</span><span class="p">,</span> <span class="s">&quot;bad firmware file magic: 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">image</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dl_image</span><span class="p">))</span> <span class="o">!=</span> <span class="n">fw_entry</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">print_npe</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">npe</span><span class="p">,</span>
			  <span class="s">&quot;inconsistent size of firmware file</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span> <span class="cm">/* NPE ID */</span><span class="p">)</span> <span class="o">!=</span> <span class="n">npe</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">print_npe</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">npe</span><span class="p">,</span> <span class="s">&quot;firmware file NPE ID mismatch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">swab32</span><span class="p">(</span><span class="n">FW_MAGIC</span><span class="p">))</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">image</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_ixp42x</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span> <span class="cm">/* device ID */</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">print_npe</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">npe</span><span class="p">,</span> <span class="s">&quot;IXP43x/IXP46x firmware ignored on &quot;</span>
			  <span class="s">&quot;IXP42x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">npe_running</span><span class="p">(</span><span class="n">npe</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">print_npe</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">npe</span><span class="p">,</span> <span class="s">&quot;unable to load firmware, NPE is &quot;</span>
			  <span class="s">&quot;already running</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	npe_stop(npe);</span>
<span class="c">	npe_reset(npe);</span>
<span class="cp">#endif</span>

	<span class="n">print_npe</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">npe</span><span class="p">,</span> <span class="s">&quot;firmware functionality 0x%X, &quot;</span>
		  <span class="s">&quot;revision 0x%X:%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span>
		  <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_ixp42x</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span>
			<span class="n">instr_size</span> <span class="o">=</span> <span class="n">NPE_A_42X_INSTR_SIZE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">instr_size</span> <span class="o">=</span> <span class="n">NPE_B_AND_C_42X_INSTR_SIZE</span><span class="p">;</span>
		<span class="n">data_size</span> <span class="o">=</span> <span class="n">NPE_42X_DATA_SIZE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">instr_size</span> <span class="o">=</span> <span class="n">NPE_46X_INSTR_SIZE</span><span class="p">;</span>
		<span class="n">data_size</span> <span class="o">=</span> <span class="n">NPE_46X_DATA_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">blocks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">blocks</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dl_block</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">&lt;</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	     <span class="n">blocks</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">[</span><span class="n">blocks</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">FW_BLOCK_TYPE_EOF</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blocks</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dl_block</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">&gt;=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">print_npe</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">npe</span><span class="p">,</span> <span class="s">&quot;firmware EOF block marker not &quot;</span>
			  <span class="s">&quot;found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if DEBUG_FW</span>
	<span class="n">print_npe</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">npe</span><span class="p">,</span> <span class="s">&quot;%i firmware blocks found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">blocks</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">table_end</span> <span class="o">=</span> <span class="n">blocks</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dl_block</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span> <span class="cm">/* EOF marker */</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">blk</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">blocks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">blk</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">blk</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dl_codeblock</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span>
		    <span class="o">||</span> <span class="n">blk</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">table_end</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">print_npe</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">npe</span><span class="p">,</span> <span class="s">&quot;invalid offset 0x%X of &quot;</span>
				  <span class="s">&quot;firmware block #%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">blk</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dl_codeblock</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">blk</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">blk</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">FW_BLOCK_TYPE_INSTR</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">npe_addr</span> <span class="o">+</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">instr_size</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">too_big</span><span class="p">;</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">CMD_WR_INS_MEM</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">blk</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">FW_BLOCK_TYPE_DATA</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">npe_addr</span> <span class="o">+</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">data_size</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">too_big</span><span class="p">;</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">CMD_WR_DATA_MEM</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">print_npe</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">npe</span><span class="p">,</span> <span class="s">&quot;invalid firmware block #%i &quot;</span>
				  <span class="s">&quot;type 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">blk</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">blk</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cb</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">print_npe</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">npe</span><span class="p">,</span> <span class="s">&quot;firmware block #%i doesn&#39;t &quot;</span>
				  <span class="s">&quot;fit in firmware image: type %c, start 0x%X,&quot;</span>
				  <span class="s">&quot; length 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				  <span class="n">blk</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">FW_BLOCK_TYPE_INSTR</span> <span class="o">?</span> <span class="sc">&#39;I&#39;</span> <span class="o">:</span> <span class="sc">&#39;D&#39;</span><span class="p">,</span>
				  <span class="n">cb</span><span class="o">-&gt;</span><span class="n">npe_addr</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">npe_cmd_write</span><span class="p">(</span><span class="n">npe</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">npe_addr</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">npe_start</span><span class="p">(</span><span class="n">npe</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">npe_running</span><span class="p">(</span><span class="n">npe</span><span class="p">))</span>
		<span class="n">print_npe</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">npe</span><span class="p">,</span> <span class="s">&quot;unable to start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw_entry</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">too_big:</span>
	<span class="n">print_npe</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">npe</span><span class="p">,</span> <span class="s">&quot;firmware block #%i doesn&#39;t fit in NPE &quot;</span>
		  <span class="s">&quot;memory: type %c, start 0x%X, length 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
		  <span class="n">blk</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">FW_BLOCK_TYPE_INSTR</span> <span class="o">?</span> <span class="sc">&#39;I&#39;</span> <span class="o">:</span> <span class="sc">&#39;D&#39;</span><span class="p">,</span>
		  <span class="n">cb</span><span class="o">-&gt;</span><span class="n">npe_addr</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw_entry</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">struct</span> <span class="n">npe</span> <span class="o">*</span><span class="nf">npe_request</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="n">NPE_COUNT</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">npe_tab</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">valid</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">&amp;</span><span class="n">npe_tab</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">npe_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">npe</span> <span class="o">*</span><span class="n">npe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">npe_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NPE_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">npe</span> <span class="o">*</span><span class="n">npe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">npe_tab</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ixp4xx_read_feature_bits</span><span class="p">()</span> <span class="o">&amp;</span>
		      <span class="p">(</span><span class="n">IXP4XX_FEATURE_RESET_NPEA</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span> <span class="cm">/* NPE already disabled or not present */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">mem_res</span> <span class="o">=</span> <span class="n">request_mem_region</span><span class="p">(</span><span class="n">npe</span><span class="o">-&gt;</span><span class="n">regs_phys</span><span class="p">,</span>
							<span class="n">REGS_SIZE</span><span class="p">,</span>
							<span class="n">npe_name</span><span class="p">(</span><span class="n">npe</span><span class="p">))))</span> <span class="p">{</span>
			<span class="n">print_npe</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">npe</span><span class="p">,</span>
				  <span class="s">&quot;failed to request memory region</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">npe_reset</span><span class="p">(</span><span class="n">npe</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">npe</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">found</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">npe_cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NPE_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">npe_tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mem_res</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">npe_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">npe_tab</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">release_resource</span><span class="p">(</span><span class="n">npe_tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mem_res</span><span class="p">);</span>
		<span class="p">}</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">npe_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">npe_cleanup_module</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Krzysztof Halasa&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">npe_names</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">npe_running</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">npe_request</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">npe_release</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">npe_load_firmware</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">npe_send_message</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">npe_recv_message</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">npe_send_recv_message</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
