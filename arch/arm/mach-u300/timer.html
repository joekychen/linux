<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › mach-u300 › timer.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>timer.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * arch/arm/mach-u300/timer.c</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007-2009 ST-Ericsson AB</span>
<span class="cm"> * License terms: GNU General Public License (GPL) version 2</span>
<span class="cm"> * Timer COH 901 328, runs the OS timer interrupt.</span>
<span class="cm"> * Author: Linus Walleij &lt;linus.walleij@stericsson.com&gt;</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/timex.h&gt;</span>
<span class="cp">#include &lt;linux/clockchips.h&gt;</span>
<span class="cp">#include &lt;linux/clocksource.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>

<span class="cp">#include &lt;mach/hardware.h&gt;</span>

<span class="cm">/* Generic stuff */</span>
<span class="cp">#include &lt;asm/sched_clock.h&gt;</span>
<span class="cp">#include &lt;asm/mach/map.h&gt;</span>
<span class="cp">#include &lt;asm/mach/time.h&gt;</span>
<span class="cp">#include &lt;asm/mach/irq.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * APP side special timer registers</span>
<span class="cm"> * This timer contains four timers which can fire an interrupt each.</span>
<span class="cm"> * OS (operating system) timer @ 32768 Hz</span>
<span class="cm"> * DD (device driver) timer @ 1 kHz</span>
<span class="cm"> * GP1 (general purpose 1) timer @ 1MHz</span>
<span class="cm"> * GP2 (general purpose 2) timer @ 1MHz</span>
<span class="cm"> */</span>

<span class="cm">/* Reset OS Timer 32bit (-/W) */</span>
<span class="cp">#define U300_TIMER_APP_ROST					(0x0000)</span>
<span class="cp">#define U300_TIMER_APP_ROST_TIMER_RESET				(0x00000000)</span>
<span class="cm">/* Enable OS Timer 32bit (-/W) */</span>
<span class="cp">#define U300_TIMER_APP_EOST					(0x0004)</span>
<span class="cp">#define U300_TIMER_APP_EOST_TIMER_ENABLE			(0x00000000)</span>
<span class="cm">/* Disable OS Timer 32bit (-/W) */</span>
<span class="cp">#define U300_TIMER_APP_DOST					(0x0008)</span>
<span class="cp">#define U300_TIMER_APP_DOST_TIMER_DISABLE			(0x00000000)</span>
<span class="cm">/* OS Timer Mode Register 32bit (-/W) */</span>
<span class="cp">#define U300_TIMER_APP_SOSTM					(0x000c)</span>
<span class="cp">#define U300_TIMER_APP_SOSTM_MODE_CONTINUOUS			(0x00000000)</span>
<span class="cp">#define U300_TIMER_APP_SOSTM_MODE_ONE_SHOT			(0x00000001)</span>
<span class="cm">/* OS Timer Status Register 32bit (R/-) */</span>
<span class="cp">#define U300_TIMER_APP_OSTS					(0x0010)</span>
<span class="cp">#define U300_TIMER_APP_OSTS_TIMER_STATE_MASK			(0x0000000F)</span>
<span class="cp">#define U300_TIMER_APP_OSTS_TIMER_STATE_IDLE			(0x00000001)</span>
<span class="cp">#define U300_TIMER_APP_OSTS_TIMER_STATE_ACTIVE			(0x00000002)</span>
<span class="cp">#define U300_TIMER_APP_OSTS_ENABLE_IND				(0x00000010)</span>
<span class="cp">#define U300_TIMER_APP_OSTS_MODE_MASK				(0x00000020)</span>
<span class="cp">#define U300_TIMER_APP_OSTS_MODE_CONTINUOUS			(0x00000000)</span>
<span class="cp">#define U300_TIMER_APP_OSTS_MODE_ONE_SHOT			(0x00000020)</span>
<span class="cp">#define U300_TIMER_APP_OSTS_IRQ_ENABLED_IND			(0x00000040)</span>
<span class="cp">#define U300_TIMER_APP_OSTS_IRQ_PENDING_IND			(0x00000080)</span>
<span class="cm">/* OS Timer Current Count Register 32bit (R/-) */</span>
<span class="cp">#define U300_TIMER_APP_OSTCC					(0x0014)</span>
<span class="cm">/* OS Timer Terminal Count Register 32bit (R/W) */</span>
<span class="cp">#define U300_TIMER_APP_OSTTC					(0x0018)</span>
<span class="cm">/* OS Timer Interrupt Enable Register 32bit (-/W) */</span>
<span class="cp">#define U300_TIMER_APP_OSTIE					(0x001c)</span>
<span class="cp">#define U300_TIMER_APP_OSTIE_IRQ_DISABLE			(0x00000000)</span>
<span class="cp">#define U300_TIMER_APP_OSTIE_IRQ_ENABLE				(0x00000001)</span>
<span class="cm">/* OS Timer Interrupt Acknowledge Register 32bit (-/W) */</span>
<span class="cp">#define U300_TIMER_APP_OSTIA					(0x0020)</span>
<span class="cp">#define U300_TIMER_APP_OSTIA_IRQ_ACK				(0x00000080)</span>

<span class="cm">/* Reset DD Timer 32bit (-/W) */</span>
<span class="cp">#define U300_TIMER_APP_RDDT					(0x0040)</span>
<span class="cp">#define U300_TIMER_APP_RDDT_TIMER_RESET				(0x00000000)</span>
<span class="cm">/* Enable DD Timer 32bit (-/W) */</span>
<span class="cp">#define U300_TIMER_APP_EDDT					(0x0044)</span>
<span class="cp">#define U300_TIMER_APP_EDDT_TIMER_ENABLE			(0x00000000)</span>
<span class="cm">/* Disable DD Timer 32bit (-/W) */</span>
<span class="cp">#define U300_TIMER_APP_DDDT					(0x0048)</span>
<span class="cp">#define U300_TIMER_APP_DDDT_TIMER_DISABLE			(0x00000000)</span>
<span class="cm">/* DD Timer Mode Register 32bit (-/W) */</span>
<span class="cp">#define U300_TIMER_APP_SDDTM					(0x004c)</span>
<span class="cp">#define U300_TIMER_APP_SDDTM_MODE_CONTINUOUS			(0x00000000)</span>
<span class="cp">#define U300_TIMER_APP_SDDTM_MODE_ONE_SHOT			(0x00000001)</span>
<span class="cm">/* DD Timer Status Register 32bit (R/-) */</span>
<span class="cp">#define U300_TIMER_APP_DDTS					(0x0050)</span>
<span class="cp">#define U300_TIMER_APP_DDTS_TIMER_STATE_MASK			(0x0000000F)</span>
<span class="cp">#define U300_TIMER_APP_DDTS_TIMER_STATE_IDLE			(0x00000001)</span>
<span class="cp">#define U300_TIMER_APP_DDTS_TIMER_STATE_ACTIVE			(0x00000002)</span>
<span class="cp">#define U300_TIMER_APP_DDTS_ENABLE_IND				(0x00000010)</span>
<span class="cp">#define U300_TIMER_APP_DDTS_MODE_MASK				(0x00000020)</span>
<span class="cp">#define U300_TIMER_APP_DDTS_MODE_CONTINUOUS			(0x00000000)</span>
<span class="cp">#define U300_TIMER_APP_DDTS_MODE_ONE_SHOT			(0x00000020)</span>
<span class="cp">#define U300_TIMER_APP_DDTS_IRQ_ENABLED_IND			(0x00000040)</span>
<span class="cp">#define U300_TIMER_APP_DDTS_IRQ_PENDING_IND			(0x00000080)</span>
<span class="cm">/* DD Timer Current Count Register 32bit (R/-) */</span>
<span class="cp">#define U300_TIMER_APP_DDTCC					(0x0054)</span>
<span class="cm">/* DD Timer Terminal Count Register 32bit (R/W) */</span>
<span class="cp">#define U300_TIMER_APP_DDTTC					(0x0058)</span>
<span class="cm">/* DD Timer Interrupt Enable Register 32bit (-/W) */</span>
<span class="cp">#define U300_TIMER_APP_DDTIE					(0x005c)</span>
<span class="cp">#define U300_TIMER_APP_DDTIE_IRQ_DISABLE			(0x00000000)</span>
<span class="cp">#define U300_TIMER_APP_DDTIE_IRQ_ENABLE				(0x00000001)</span>
<span class="cm">/* DD Timer Interrupt Acknowledge Register 32bit (-/W) */</span>
<span class="cp">#define U300_TIMER_APP_DDTIA					(0x0060)</span>
<span class="cp">#define U300_TIMER_APP_DDTIA_IRQ_ACK				(0x00000080)</span>

<span class="cm">/* Reset GP1 Timer 32bit (-/W) */</span>
<span class="cp">#define U300_TIMER_APP_RGPT1					(0x0080)</span>
<span class="cp">#define U300_TIMER_APP_RGPT1_TIMER_RESET			(0x00000000)</span>
<span class="cm">/* Enable GP1 Timer 32bit (-/W) */</span>
<span class="cp">#define U300_TIMER_APP_EGPT1					(0x0084)</span>
<span class="cp">#define U300_TIMER_APP_EGPT1_TIMER_ENABLE			(0x00000000)</span>
<span class="cm">/* Disable GP1 Timer 32bit (-/W) */</span>
<span class="cp">#define U300_TIMER_APP_DGPT1					(0x0088)</span>
<span class="cp">#define U300_TIMER_APP_DGPT1_TIMER_DISABLE			(0x00000000)</span>
<span class="cm">/* GP1 Timer Mode Register 32bit (-/W) */</span>
<span class="cp">#define U300_TIMER_APP_SGPT1M					(0x008c)</span>
<span class="cp">#define U300_TIMER_APP_SGPT1M_MODE_CONTINUOUS			(0x00000000)</span>
<span class="cp">#define U300_TIMER_APP_SGPT1M_MODE_ONE_SHOT			(0x00000001)</span>
<span class="cm">/* GP1 Timer Status Register 32bit (R/-) */</span>
<span class="cp">#define U300_TIMER_APP_GPT1S					(0x0090)</span>
<span class="cp">#define U300_TIMER_APP_GPT1S_TIMER_STATE_MASK			(0x0000000F)</span>
<span class="cp">#define U300_TIMER_APP_GPT1S_TIMER_STATE_IDLE			(0x00000001)</span>
<span class="cp">#define U300_TIMER_APP_GPT1S_TIMER_STATE_ACTIVE			(0x00000002)</span>
<span class="cp">#define U300_TIMER_APP_GPT1S_ENABLE_IND				(0x00000010)</span>
<span class="cp">#define U300_TIMER_APP_GPT1S_MODE_MASK				(0x00000020)</span>
<span class="cp">#define U300_TIMER_APP_GPT1S_MODE_CONTINUOUS			(0x00000000)</span>
<span class="cp">#define U300_TIMER_APP_GPT1S_MODE_ONE_SHOT			(0x00000020)</span>
<span class="cp">#define U300_TIMER_APP_GPT1S_IRQ_ENABLED_IND			(0x00000040)</span>
<span class="cp">#define U300_TIMER_APP_GPT1S_IRQ_PENDING_IND			(0x00000080)</span>
<span class="cm">/* GP1 Timer Current Count Register 32bit (R/-) */</span>
<span class="cp">#define U300_TIMER_APP_GPT1CC					(0x0094)</span>
<span class="cm">/* GP1 Timer Terminal Count Register 32bit (R/W) */</span>
<span class="cp">#define U300_TIMER_APP_GPT1TC					(0x0098)</span>
<span class="cm">/* GP1 Timer Interrupt Enable Register 32bit (-/W) */</span>
<span class="cp">#define U300_TIMER_APP_GPT1IE					(0x009c)</span>
<span class="cp">#define U300_TIMER_APP_GPT1IE_IRQ_DISABLE			(0x00000000)</span>
<span class="cp">#define U300_TIMER_APP_GPT1IE_IRQ_ENABLE			(0x00000001)</span>
<span class="cm">/* GP1 Timer Interrupt Acknowledge Register 32bit (-/W) */</span>
<span class="cp">#define U300_TIMER_APP_GPT1IA					(0x00a0)</span>
<span class="cp">#define U300_TIMER_APP_GPT1IA_IRQ_ACK				(0x00000080)</span>

<span class="cm">/* Reset GP2 Timer 32bit (-/W) */</span>
<span class="cp">#define U300_TIMER_APP_RGPT2					(0x00c0)</span>
<span class="cp">#define U300_TIMER_APP_RGPT2_TIMER_RESET			(0x00000000)</span>
<span class="cm">/* Enable GP2 Timer 32bit (-/W) */</span>
<span class="cp">#define U300_TIMER_APP_EGPT2					(0x00c4)</span>
<span class="cp">#define U300_TIMER_APP_EGPT2_TIMER_ENABLE			(0x00000000)</span>
<span class="cm">/* Disable GP2 Timer 32bit (-/W) */</span>
<span class="cp">#define U300_TIMER_APP_DGPT2					(0x00c8)</span>
<span class="cp">#define U300_TIMER_APP_DGPT2_TIMER_DISABLE			(0x00000000)</span>
<span class="cm">/* GP2 Timer Mode Register 32bit (-/W) */</span>
<span class="cp">#define U300_TIMER_APP_SGPT2M					(0x00cc)</span>
<span class="cp">#define U300_TIMER_APP_SGPT2M_MODE_CONTINUOUS			(0x00000000)</span>
<span class="cp">#define U300_TIMER_APP_SGPT2M_MODE_ONE_SHOT			(0x00000001)</span>
<span class="cm">/* GP2 Timer Status Register 32bit (R/-) */</span>
<span class="cp">#define U300_TIMER_APP_GPT2S					(0x00d0)</span>
<span class="cp">#define U300_TIMER_APP_GPT2S_TIMER_STATE_MASK			(0x0000000F)</span>
<span class="cp">#define U300_TIMER_APP_GPT2S_TIMER_STATE_IDLE			(0x00000001)</span>
<span class="cp">#define U300_TIMER_APP_GPT2S_TIMER_STATE_ACTIVE			(0x00000002)</span>
<span class="cp">#define U300_TIMER_APP_GPT2S_ENABLE_IND				(0x00000010)</span>
<span class="cp">#define U300_TIMER_APP_GPT2S_MODE_MASK				(0x00000020)</span>
<span class="cp">#define U300_TIMER_APP_GPT2S_MODE_CONTINUOUS			(0x00000000)</span>
<span class="cp">#define U300_TIMER_APP_GPT2S_MODE_ONE_SHOT			(0x00000020)</span>
<span class="cp">#define U300_TIMER_APP_GPT2S_IRQ_ENABLED_IND			(0x00000040)</span>
<span class="cp">#define U300_TIMER_APP_GPT2S_IRQ_PENDING_IND			(0x00000080)</span>
<span class="cm">/* GP2 Timer Current Count Register 32bit (R/-) */</span>
<span class="cp">#define U300_TIMER_APP_GPT2CC					(0x00d4)</span>
<span class="cm">/* GP2 Timer Terminal Count Register 32bit (R/W) */</span>
<span class="cp">#define U300_TIMER_APP_GPT2TC					(0x00d8)</span>
<span class="cm">/* GP2 Timer Interrupt Enable Register 32bit (-/W) */</span>
<span class="cp">#define U300_TIMER_APP_GPT2IE					(0x00dc)</span>
<span class="cp">#define U300_TIMER_APP_GPT2IE_IRQ_DISABLE			(0x00000000)</span>
<span class="cp">#define U300_TIMER_APP_GPT2IE_IRQ_ENABLE			(0x00000001)</span>
<span class="cm">/* GP2 Timer Interrupt Acknowledge Register 32bit (-/W) */</span>
<span class="cp">#define U300_TIMER_APP_GPT2IA					(0x00e0)</span>
<span class="cp">#define U300_TIMER_APP_GPT2IA_IRQ_ACK				(0x00000080)</span>

<span class="cm">/* Clock request control register - all four timers */</span>
<span class="cp">#define U300_TIMER_APP_CRC					(0x100)</span>
<span class="cp">#define U300_TIMER_APP_CRC_CLOCK_REQUEST_ENABLE			(0x00000001)</span>

<span class="cp">#define TICKS_PER_JIFFY ((CLOCK_TICK_RATE + (HZ/2)) / HZ)</span>
<span class="cp">#define US_PER_TICK ((1000000 + (HZ/2)) / HZ)</span>

<span class="cm">/*</span>
<span class="cm"> * The u300_set_mode() function is always called first, if we</span>
<span class="cm"> * have oneshot timer active, the oneshot scheduling function</span>
<span class="cm"> * u300_set_next_event() is called immediately after.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">u300_set_mode</span><span class="p">(</span><span class="k">enum</span> <span class="n">clock_event_mode</span> <span class="n">mode</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">clock_event_device</span> <span class="o">*</span><span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CLOCK_EVT_MODE_PERIODIC</span>:
		<span class="cm">/* Disable interrupts on GPT1 */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">U300_TIMER_APP_GPT1IE_IRQ_DISABLE</span><span class="p">,</span>
		       <span class="n">U300_TIMER_APP_VBASE</span> <span class="o">+</span> <span class="n">U300_TIMER_APP_GPT1IE</span><span class="p">);</span>
		<span class="cm">/* Disable GP1 while we&#39;re reprogramming it. */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">U300_TIMER_APP_DGPT1_TIMER_DISABLE</span><span class="p">,</span>
		       <span class="n">U300_TIMER_APP_VBASE</span> <span class="o">+</span> <span class="n">U300_TIMER_APP_DGPT1</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Set the periodic mode to a certain number of ticks per</span>
<span class="cm">		 * jiffy.</span>
<span class="cm">		 */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">TICKS_PER_JIFFY</span><span class="p">,</span>
		       <span class="n">U300_TIMER_APP_VBASE</span> <span class="o">+</span> <span class="n">U300_TIMER_APP_GPT1TC</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Set continuous mode, so the timer keeps triggering</span>
<span class="cm">		 * interrupts.</span>
<span class="cm">		 */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">U300_TIMER_APP_SGPT1M_MODE_CONTINUOUS</span><span class="p">,</span>
		       <span class="n">U300_TIMER_APP_VBASE</span> <span class="o">+</span> <span class="n">U300_TIMER_APP_SGPT1M</span><span class="p">);</span>
		<span class="cm">/* Enable timer interrupts */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">U300_TIMER_APP_GPT1IE_IRQ_ENABLE</span><span class="p">,</span>
		       <span class="n">U300_TIMER_APP_VBASE</span> <span class="o">+</span> <span class="n">U300_TIMER_APP_GPT1IE</span><span class="p">);</span>
		<span class="cm">/* Then enable the OS timer again */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">U300_TIMER_APP_EGPT1_TIMER_ENABLE</span><span class="p">,</span>
		       <span class="n">U300_TIMER_APP_VBASE</span> <span class="o">+</span> <span class="n">U300_TIMER_APP_EGPT1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLOCK_EVT_MODE_ONESHOT</span>:
		<span class="cm">/* Just break; here? */</span>
		<span class="cm">/*</span>
<span class="cm">		 * The actual event will be programmed by the next event hook,</span>
<span class="cm">		 * so we just set a dummy value somewhere at the end of the</span>
<span class="cm">		 * universe here.</span>
<span class="cm">		 */</span>
		<span class="cm">/* Disable interrupts on GPT1 */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">U300_TIMER_APP_GPT1IE_IRQ_DISABLE</span><span class="p">,</span>
		       <span class="n">U300_TIMER_APP_VBASE</span> <span class="o">+</span> <span class="n">U300_TIMER_APP_GPT1IE</span><span class="p">);</span>
		<span class="cm">/* Disable GP1 while we&#39;re reprogramming it. */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">U300_TIMER_APP_DGPT1_TIMER_DISABLE</span><span class="p">,</span>
		       <span class="n">U300_TIMER_APP_VBASE</span> <span class="o">+</span> <span class="n">U300_TIMER_APP_DGPT1</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Expire far in the future, u300_set_next_event() will be</span>
<span class="cm">		 * called soon...</span>
<span class="cm">		 */</span>
		<span class="n">writel</span><span class="p">(</span><span class="mh">0xFFFFFFFF</span><span class="p">,</span> <span class="n">U300_TIMER_APP_VBASE</span> <span class="o">+</span> <span class="n">U300_TIMER_APP_GPT1TC</span><span class="p">);</span>
		<span class="cm">/* We run one shot per tick here! */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">U300_TIMER_APP_SGPT1M_MODE_ONE_SHOT</span><span class="p">,</span>
		       <span class="n">U300_TIMER_APP_VBASE</span> <span class="o">+</span> <span class="n">U300_TIMER_APP_SGPT1M</span><span class="p">);</span>
		<span class="cm">/* Enable interrupts for this timer */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">U300_TIMER_APP_GPT1IE_IRQ_ENABLE</span><span class="p">,</span>
		       <span class="n">U300_TIMER_APP_VBASE</span> <span class="o">+</span> <span class="n">U300_TIMER_APP_GPT1IE</span><span class="p">);</span>
		<span class="cm">/* Enable timer */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">U300_TIMER_APP_EGPT1_TIMER_ENABLE</span><span class="p">,</span>
		       <span class="n">U300_TIMER_APP_VBASE</span> <span class="o">+</span> <span class="n">U300_TIMER_APP_EGPT1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLOCK_EVT_MODE_UNUSED</span>:
	<span class="k">case</span> <span class="n">CLOCK_EVT_MODE_SHUTDOWN</span>:
		<span class="cm">/* Disable interrupts on GP1 */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">U300_TIMER_APP_GPT1IE_IRQ_DISABLE</span><span class="p">,</span>
		       <span class="n">U300_TIMER_APP_VBASE</span> <span class="o">+</span> <span class="n">U300_TIMER_APP_GPT1IE</span><span class="p">);</span>
		<span class="cm">/* Disable GP1 */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">U300_TIMER_APP_DGPT1_TIMER_DISABLE</span><span class="p">,</span>
		       <span class="n">U300_TIMER_APP_VBASE</span> <span class="o">+</span> <span class="n">U300_TIMER_APP_DGPT1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLOCK_EVT_MODE_RESUME</span>:
		<span class="cm">/* Ignore this call */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The app timer in one shot mode obviously has to be reprogrammed</span>
<span class="cm"> * in EXACTLY this sequence to work properly. Do NOT try to e.g. replace</span>
<span class="cm"> * the interrupt disable + timer disable commands with a reset command,</span>
<span class="cm"> * it will fail miserably. Apparently (and I found this the hard way)</span>
<span class="cm"> * the timer is very sensitive to the instruction order, though you don&#39;t</span>
<span class="cm"> * get that impression from the data sheet.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">u300_set_next_event</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cycles</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">clock_event_device</span> <span class="o">*</span><span class="n">evt</span><span class="p">)</span>

<span class="p">{</span>
	<span class="cm">/* Disable interrupts on GPT1 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">U300_TIMER_APP_GPT1IE_IRQ_DISABLE</span><span class="p">,</span>
	       <span class="n">U300_TIMER_APP_VBASE</span> <span class="o">+</span> <span class="n">U300_TIMER_APP_GPT1IE</span><span class="p">);</span>
	<span class="cm">/* Disable GP1 while we&#39;re reprogramming it. */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">U300_TIMER_APP_DGPT1_TIMER_DISABLE</span><span class="p">,</span>
	       <span class="n">U300_TIMER_APP_VBASE</span> <span class="o">+</span> <span class="n">U300_TIMER_APP_DGPT1</span><span class="p">);</span>
	<span class="cm">/* Reset the General Purpose timer 1. */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">U300_TIMER_APP_RGPT1_TIMER_RESET</span><span class="p">,</span>
	       <span class="n">U300_TIMER_APP_VBASE</span> <span class="o">+</span> <span class="n">U300_TIMER_APP_RGPT1</span><span class="p">);</span>
	<span class="cm">/* IRQ in n * cycles */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cycles</span><span class="p">,</span> <span class="n">U300_TIMER_APP_VBASE</span> <span class="o">+</span> <span class="n">U300_TIMER_APP_GPT1TC</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * We run one shot per tick here! (This is necessary to reconfigure,</span>
<span class="cm">	 * the timer will tilt if you don&#39;t!)</span>
<span class="cm">	 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">U300_TIMER_APP_SGPT1M_MODE_ONE_SHOT</span><span class="p">,</span>
	       <span class="n">U300_TIMER_APP_VBASE</span> <span class="o">+</span> <span class="n">U300_TIMER_APP_SGPT1M</span><span class="p">);</span>
	<span class="cm">/* Enable timer interrupts */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">U300_TIMER_APP_GPT1IE_IRQ_ENABLE</span><span class="p">,</span>
	       <span class="n">U300_TIMER_APP_VBASE</span> <span class="o">+</span> <span class="n">U300_TIMER_APP_GPT1IE</span><span class="p">);</span>
	<span class="cm">/* Then enable the OS timer again */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">U300_TIMER_APP_EGPT1_TIMER_ENABLE</span><span class="p">,</span>
	       <span class="n">U300_TIMER_APP_VBASE</span> <span class="o">+</span> <span class="n">U300_TIMER_APP_EGPT1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Use general purpose timer 1 as clock event */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clock_event_device</span> <span class="n">clockevent_u300_1mhz</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;GPT1&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rating</span>		<span class="o">=</span> <span class="mi">300</span><span class="p">,</span> <span class="cm">/* Reasonably fast and accurate clock event */</span>
	<span class="p">.</span><span class="n">features</span>	<span class="o">=</span> <span class="n">CLOCK_EVT_FEAT_PERIODIC</span> <span class="o">|</span> <span class="n">CLOCK_EVT_FEAT_ONESHOT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_next_event</span>	<span class="o">=</span> <span class="n">u300_set_next_event</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_mode</span>	<span class="o">=</span> <span class="n">u300_set_mode</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Clock event timer interrupt handler */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">u300_timer_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">clock_event_device</span> <span class="o">*</span><span class="n">evt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">clockevent_u300_1mhz</span><span class="p">;</span>
	<span class="cm">/* ACK/Clear timer IRQ for the APP GPT1 Timer */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">U300_TIMER_APP_GPT1IA_IRQ_ACK</span><span class="p">,</span>
		<span class="n">U300_TIMER_APP_VBASE</span> <span class="o">+</span> <span class="n">U300_TIMER_APP_GPT1IA</span><span class="p">);</span>
	<span class="n">evt</span><span class="o">-&gt;</span><span class="n">event_handler</span><span class="p">(</span><span class="n">evt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irqaction</span> <span class="n">u300_timer_irq</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;U300 Timer Tick&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IRQF_DISABLED</span> <span class="o">|</span> <span class="n">IRQF_TIMER</span> <span class="o">|</span> <span class="n">IRQF_IRQPOLL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">handler</span>	<span class="o">=</span> <span class="n">u300_timer_interrupt</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Override the global weak sched_clock symbol with this</span>
<span class="cm"> * local implementation which uses the clocksource to get some</span>
<span class="cm"> * better resolution when scheduling the kernel. We accept that</span>
<span class="cm"> * this wraps around for now, since it is just a relative time</span>
<span class="cm"> * stamp. (Inspired by OMAP implementation.)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">notrace</span> <span class="nf">u300_read_sched_clock</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">U300_TIMER_APP_VBASE</span> <span class="o">+</span> <span class="n">U300_TIMER_APP_GPT2CC</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * This sets up the system timers, clock source and clock event.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">u300_timer_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate</span><span class="p">;</span>

	<span class="cm">/* Clock the interrupt controller */</span>
	<span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get_sys</span><span class="p">(</span><span class="s">&quot;apptimer&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">clk</span><span class="p">));</span>
	<span class="n">clk_enable</span><span class="p">(</span><span class="n">clk</span><span class="p">);</span>
	<span class="n">rate</span> <span class="o">=</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="n">clk</span><span class="p">);</span>

	<span class="n">setup_sched_clock</span><span class="p">(</span><span class="n">u300_read_sched_clock</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable the &quot;OS&quot; and &quot;DD&quot; timers - these are designed for Symbian!</span>
<span class="cm">	 * Example usage in cnh1601578 cpu subsystem pd_timer_app.c</span>
<span class="cm">	 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">U300_TIMER_APP_CRC_CLOCK_REQUEST_ENABLE</span><span class="p">,</span>
		<span class="n">U300_TIMER_APP_VBASE</span> <span class="o">+</span> <span class="n">U300_TIMER_APP_CRC</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">U300_TIMER_APP_ROST_TIMER_RESET</span><span class="p">,</span>
		<span class="n">U300_TIMER_APP_VBASE</span> <span class="o">+</span> <span class="n">U300_TIMER_APP_ROST</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">U300_TIMER_APP_DOST_TIMER_DISABLE</span><span class="p">,</span>
		<span class="n">U300_TIMER_APP_VBASE</span> <span class="o">+</span> <span class="n">U300_TIMER_APP_DOST</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">U300_TIMER_APP_RDDT_TIMER_RESET</span><span class="p">,</span>
		<span class="n">U300_TIMER_APP_VBASE</span> <span class="o">+</span> <span class="n">U300_TIMER_APP_RDDT</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">U300_TIMER_APP_DDDT_TIMER_DISABLE</span><span class="p">,</span>
		<span class="n">U300_TIMER_APP_VBASE</span> <span class="o">+</span> <span class="n">U300_TIMER_APP_DDDT</span><span class="p">);</span>

	<span class="cm">/* Reset the General Purpose timer 1. */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">U300_TIMER_APP_RGPT1_TIMER_RESET</span><span class="p">,</span>
		<span class="n">U300_TIMER_APP_VBASE</span> <span class="o">+</span> <span class="n">U300_TIMER_APP_RGPT1</span><span class="p">);</span>

	<span class="cm">/* Set up the IRQ handler */</span>
	<span class="n">setup_irq</span><span class="p">(</span><span class="n">IRQ_U300_TIMER_APP_GP1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u300_timer_irq</span><span class="p">);</span>

	<span class="cm">/* Reset the General Purpose timer 2 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">U300_TIMER_APP_RGPT2_TIMER_RESET</span><span class="p">,</span>
		<span class="n">U300_TIMER_APP_VBASE</span> <span class="o">+</span> <span class="n">U300_TIMER_APP_RGPT2</span><span class="p">);</span>
	<span class="cm">/* Set this timer to run around forever */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0xFFFFFFFFU</span><span class="p">,</span> <span class="n">U300_TIMER_APP_VBASE</span> <span class="o">+</span> <span class="n">U300_TIMER_APP_GPT2TC</span><span class="p">);</span>
	<span class="cm">/* Set continuous mode so it wraps around */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">U300_TIMER_APP_SGPT2M_MODE_CONTINUOUS</span><span class="p">,</span>
	       <span class="n">U300_TIMER_APP_VBASE</span> <span class="o">+</span> <span class="n">U300_TIMER_APP_SGPT2M</span><span class="p">);</span>
	<span class="cm">/* Disable timer interrupts */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">U300_TIMER_APP_GPT2IE_IRQ_DISABLE</span><span class="p">,</span>
		<span class="n">U300_TIMER_APP_VBASE</span> <span class="o">+</span> <span class="n">U300_TIMER_APP_GPT2IE</span><span class="p">);</span>
	<span class="cm">/* Then enable the GP2 timer to use as a free running us counter */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">U300_TIMER_APP_EGPT2_TIMER_ENABLE</span><span class="p">,</span>
		<span class="n">U300_TIMER_APP_VBASE</span> <span class="o">+</span> <span class="n">U300_TIMER_APP_EGPT2</span><span class="p">);</span>

	<span class="cm">/* Use general purpose timer 2 as clock source */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clocksource_mmio_init</span><span class="p">(</span><span class="n">U300_TIMER_APP_VBASE</span> <span class="o">+</span> <span class="n">U300_TIMER_APP_GPT2CC</span><span class="p">,</span>
			<span class="s">&quot;GPT2&quot;</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">clocksource_mmio_readl_up</span><span class="p">))</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;timer: failed to initialize U300 clock source</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Configure and register the clockevent */</span>
	<span class="n">clockevents_config_and_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clockevent_u300_1mhz</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span>
					<span class="mi">1</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * TODO: init and register the rest of the timers too, they can be</span>
<span class="cm">	 * used by hrtimers!</span>
<span class="cm">	 */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Very simple system timer that only register the clock event and</span>
<span class="cm"> * clock source.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">sys_timer</span> <span class="n">u300_timer</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">u300_timer_init</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
