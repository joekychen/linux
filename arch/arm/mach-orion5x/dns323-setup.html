<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › mach-orion5x › dns323-setup.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>dns323-setup.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * arch/arm/mach-orion5x/dns323-setup.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007 Herbert Valerio Riedel &lt;hvr@gnu.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Support for HW Rev C1:</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2010 Benjamin Herrenschmidt &lt;benh@kernel.crashing.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU Lesser General Public License as</span>
<span class="cm"> * published by the Free Software Foundation; either version 2 of the</span>
<span class="cm"> * License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/physmap.h&gt;</span>
<span class="cp">#include &lt;linux/mv643xx_eth.h&gt;</span>
<span class="cp">#include &lt;linux/leds.h&gt;</span>
<span class="cp">#include &lt;linux/gpio_keys.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/ata_platform.h&gt;</span>
<span class="cp">#include &lt;linux/phy.h&gt;</span>
<span class="cp">#include &lt;linux/marvell_phy.h&gt;</span>
<span class="cp">#include &lt;asm/mach-types.h&gt;</span>
<span class="cp">#include &lt;asm/mach/arch.h&gt;</span>
<span class="cp">#include &lt;asm/mach/pci.h&gt;</span>
<span class="cp">#include &lt;asm/system_info.h&gt;</span>
<span class="cp">#include &lt;mach/orion5x.h&gt;</span>
<span class="cp">#include &quot;common.h&quot;</span>
<span class="cp">#include &quot;mpp.h&quot;</span>

<span class="cm">/* Rev A1 and B1 */</span>
<span class="cp">#define DNS323_GPIO_LED_RIGHT_AMBER	1</span>
<span class="cp">#define DNS323_GPIO_LED_LEFT_AMBER	2</span>
<span class="cp">#define DNS323_GPIO_SYSTEM_UP		3</span>
<span class="cp">#define DNS323_GPIO_LED_POWER1		4</span>
<span class="cp">#define DNS323_GPIO_LED_POWER2		5</span>
<span class="cp">#define DNS323_GPIO_OVERTEMP		6</span>
<span class="cp">#define DNS323_GPIO_RTC			7</span>
<span class="cp">#define DNS323_GPIO_POWER_OFF		8</span>
<span class="cp">#define DNS323_GPIO_KEY_POWER		9</span>
<span class="cp">#define DNS323_GPIO_KEY_RESET		10</span>

<span class="cm">/* Rev C1 */</span>
<span class="cp">#define DNS323C_GPIO_KEY_POWER		1</span>
<span class="cp">#define DNS323C_GPIO_POWER_OFF		2</span>
<span class="cp">#define DNS323C_GPIO_LED_RIGHT_AMBER	8</span>
<span class="cp">#define DNS323C_GPIO_LED_LEFT_AMBER	9</span>
<span class="cp">#define DNS323C_GPIO_LED_POWER		17</span>
<span class="cp">#define DNS323C_GPIO_FAN_BIT1		18</span>
<span class="cp">#define DNS323C_GPIO_FAN_BIT0		19</span>

<span class="cm">/* Exposed to userspace, do not change */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">DNS323_REV_A1</span><span class="p">,</span>	<span class="cm">/* 0 */</span>
	<span class="n">DNS323_REV_B1</span><span class="p">,</span>	<span class="cm">/* 1 */</span>
	<span class="n">DNS323_REV_C1</span><span class="p">,</span>	<span class="cm">/* 2 */</span>
<span class="p">};</span>


<span class="cm">/****************************************************************************</span>
<span class="cm"> * PCI setup</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">dns323_pci_map_irq</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">slot</span><span class="p">,</span> <span class="n">u8</span> <span class="n">pin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check for devices with hard-wired IRQs.</span>
<span class="cm">	 */</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">orion5x_pci_map_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">pin</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">irq</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hw_pci</span> <span class="n">dns323_pci</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">nr_controllers</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup</span>		<span class="o">=</span> <span class="n">orion5x_pci_sys_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">scan</span>		<span class="o">=</span> <span class="n">orion5x_pci_sys_scan_bus</span><span class="p">,</span>
	<span class="p">.</span><span class="n">map_irq</span>	<span class="o">=</span> <span class="n">dns323_pci_map_irq</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">dns323_pci_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Rev B1 and C1 doesn&#39;t really use its PCI bus, and initialising PCI</span>
<span class="cm">	 * gets in the way of initialising the SATA controller.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">machine_is_dns323</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">system_rev</span> <span class="o">==</span> <span class="n">DNS323_REV_A1</span><span class="p">)</span>
		<span class="n">pci_common_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dns323_pci</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">dns323_pci_init</span><span class="p">);</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> * 8MiB NOR flash (Spansion S29GL064M90TFIR4)</span>
<span class="cm"> *</span>
<span class="cm"> * Layout as used by D-Link:</span>
<span class="cm"> *  0x00000000-0x00010000 : &quot;MTD1&quot;</span>
<span class="cm"> *  0x00010000-0x00020000 : &quot;MTD2&quot;</span>
<span class="cm"> *  0x00020000-0x001a0000 : &quot;Linux Kernel&quot;</span>
<span class="cm"> *  0x001a0000-0x007d0000 : &quot;File System&quot;</span>
<span class="cm"> *  0x007d0000-0x00800000 : &quot;u-boot&quot;</span>
<span class="cm"> */</span>

<span class="cp">#define DNS323_NOR_BOOT_BASE 0xf4000000</span>
<span class="cp">#define DNS323_NOR_BOOT_SIZE SZ_8M</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mtd_partition</span> <span class="n">dns323_partitions</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;MTD1&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="mh">0x00010000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;MTD2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="mh">0x00010000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mh">0x00010000</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;Linux Kernel&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="mh">0x00180000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mh">0x00020000</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;File System&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="mh">0x00630000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mh">0x001A0000</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;u-boot&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="mh">0x00030000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mh">0x007d0000</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">physmap_flash_data</span> <span class="n">dns323_nor_flash_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">width</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">parts</span>		<span class="o">=</span> <span class="n">dns323_partitions</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nr_parts</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dns323_partitions</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">dns323_nor_flash_resource</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span>		<span class="o">=</span> <span class="n">DNS323_NOR_BOOT_BASE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">end</span>		<span class="o">=</span> <span class="n">DNS323_NOR_BOOT_BASE</span> <span class="o">+</span> <span class="n">DNS323_NOR_BOOT_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">dns323_nor_flash</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;physmap-flash&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">dns323_nor_flash_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">dns323_nor_flash_resource</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> * Ethernet</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mv643xx_eth_platform_data</span> <span class="n">dns323_eth_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">phy_addr</span> <span class="o">=</span> <span class="n">MV643XX_ETH_PHY_ADDR</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* dns323_parse_hex_*() taken from tsx09-common.c; should a common copy of these</span>
<span class="cm"> * functions be kept somewhere?</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">dns323_parse_hex_nibble</span><span class="p">(</span><span class="kt">char</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">n</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="sc">&#39;A&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="sc">&#39;F&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">n</span> <span class="o">-</span> <span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="sc">&#39;a&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="sc">&#39;f&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">n</span> <span class="o">-</span> <span class="sc">&#39;a&#39;</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">dns323_parse_hex_byte</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">hi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lo</span><span class="p">;</span>

	<span class="n">hi</span> <span class="o">=</span> <span class="n">dns323_parse_hex_nibble</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">lo</span> <span class="o">=</span> <span class="n">dns323_parse_hex_nibble</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hi</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">lo</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">hi</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">lo</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">dns323_read_mac_addr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int8_t</span> <span class="n">addr</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">mac_page</span><span class="p">;</span>

	<span class="cm">/* MAC address is stored as a regular ol&#39; string in /dev/mtdblock4</span>
<span class="cm">	 * (0x007d0000-0x00800000) starting at offset 196480 (0x2ff80).</span>
<span class="cm">	 */</span>
	<span class="n">mac_page</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">DNS323_NOR_BOOT_BASE</span> <span class="o">+</span> <span class="mh">0x7d0000</span> <span class="o">+</span> <span class="mi">196480</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mac_page</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Sanity check the string we&#39;re looking at */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">mac_page</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">goto</span> <span class="n">error_fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">byte</span><span class="p">;</span>

		<span class="n">byte</span> <span class="o">=</span> <span class="n">dns323_parse_hex_byte</span><span class="p">(</span><span class="n">mac_page</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">byte</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">goto</span> <span class="n">error_fail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">byte</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">mac_page</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;DNS-323: Found ethernet MAC address: &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%.2x%s&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;:&quot;</span> <span class="o">:</span> <span class="s">&quot;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dns323_eth_data</span><span class="p">.</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error_fail:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">mac_page</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> * GPIO LEDs (simple - doesn&#39;t use hardware blinking support)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio_led</span> <span class="n">dns323ab_leds</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;power:blue&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span> <span class="o">=</span> <span class="n">DNS323_GPIO_LED_POWER2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_trigger</span> <span class="o">=</span> <span class="s">&quot;default-on&quot;</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;right:amber&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span> <span class="o">=</span> <span class="n">DNS323_GPIO_LED_RIGHT_AMBER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">active_low</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;left:amber&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span> <span class="o">=</span> <span class="n">DNS323_GPIO_LED_LEFT_AMBER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">active_low</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio_led</span> <span class="n">dns323c_leds</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;power:blue&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span> <span class="o">=</span> <span class="n">DNS323C_GPIO_LED_POWER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_trigger</span> <span class="o">=</span> <span class="s">&quot;timer&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">active_low</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;right:amber&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span> <span class="o">=</span> <span class="n">DNS323C_GPIO_LED_RIGHT_AMBER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">active_low</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;left:amber&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span> <span class="o">=</span> <span class="n">DNS323C_GPIO_LED_LEFT_AMBER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">active_low</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio_led_platform_data</span> <span class="n">dns323ab_led_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">num_leds</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dns323ab_leds</span><span class="p">),</span>
	<span class="p">.</span><span class="n">leds</span>		<span class="o">=</span> <span class="n">dns323ab_leds</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gpio_blink_set</span> <span class="o">=</span> <span class="n">orion_gpio_led_blink_set</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio_led_platform_data</span> <span class="n">dns323c_led_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">num_leds</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dns323c_leds</span><span class="p">),</span>
	<span class="p">.</span><span class="n">leds</span>		<span class="o">=</span> <span class="n">dns323c_leds</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gpio_blink_set</span> <span class="o">=</span> <span class="n">orion_gpio_led_blink_set</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">dns323_gpio_leds</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;leds-gpio&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">dns323ab_led_data</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> * GPIO Attached Keys</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio_keys_button</span> <span class="n">dns323ab_buttons</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">code</span>		<span class="o">=</span> <span class="n">KEY_RESTART</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span>		<span class="o">=</span> <span class="n">DNS323_GPIO_KEY_RESET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">desc</span>		<span class="o">=</span> <span class="s">&quot;Reset Button&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">active_low</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">code</span>		<span class="o">=</span> <span class="n">KEY_POWER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span>		<span class="o">=</span> <span class="n">DNS323_GPIO_KEY_POWER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">desc</span>		<span class="o">=</span> <span class="s">&quot;Power Button&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">active_low</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio_keys_platform_data</span> <span class="n">dns323ab_button_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">buttons</span>	<span class="o">=</span> <span class="n">dns323ab_buttons</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nbuttons</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dns323ab_buttons</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio_keys_button</span> <span class="n">dns323c_buttons</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">code</span>		<span class="o">=</span> <span class="n">KEY_POWER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span>		<span class="o">=</span> <span class="n">DNS323C_GPIO_KEY_POWER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">desc</span>		<span class="o">=</span> <span class="s">&quot;Power Button&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">active_low</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio_keys_platform_data</span> <span class="n">dns323c_button_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">buttons</span>	<span class="o">=</span> <span class="n">dns323c_buttons</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nbuttons</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dns323c_buttons</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">dns323_button_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;gpio-keys&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">dns323ab_button_data</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * SATA</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mv_sata_platform_data</span> <span class="n">dns323_sata_data</span> <span class="o">=</span> <span class="p">{</span>
       <span class="p">.</span><span class="n">n_ports</span>        <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> * General Setup</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dns323a_mpp_modes</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">MPP0_PCIE_RST_OUTn</span><span class="p">,</span>
	<span class="n">MPP1_GPIO</span><span class="p">,</span>		<span class="cm">/* right amber LED (sata ch0) */</span>
	<span class="n">MPP2_GPIO</span><span class="p">,</span>		<span class="cm">/* left amber LED (sata ch1) */</span>
	<span class="n">MPP3_UNUSED</span><span class="p">,</span>
	<span class="n">MPP4_GPIO</span><span class="p">,</span>		<span class="cm">/* power button LED */</span>
	<span class="n">MPP5_GPIO</span><span class="p">,</span>		<span class="cm">/* power button LED */</span>
	<span class="n">MPP6_GPIO</span><span class="p">,</span>		<span class="cm">/* GMT G751-2f overtemp */</span>
	<span class="n">MPP7_GPIO</span><span class="p">,</span>		<span class="cm">/* M41T80 nIRQ/OUT/SQW */</span>
	<span class="n">MPP8_GPIO</span><span class="p">,</span>		<span class="cm">/* triggers power off */</span>
	<span class="n">MPP9_GPIO</span><span class="p">,</span>		<span class="cm">/* power button switch */</span>
	<span class="n">MPP10_GPIO</span><span class="p">,</span>		<span class="cm">/* reset button switch */</span>
	<span class="n">MPP11_UNUSED</span><span class="p">,</span>
	<span class="n">MPP12_UNUSED</span><span class="p">,</span>
	<span class="n">MPP13_UNUSED</span><span class="p">,</span>
	<span class="n">MPP14_UNUSED</span><span class="p">,</span>
	<span class="n">MPP15_UNUSED</span><span class="p">,</span>
	<span class="n">MPP16_UNUSED</span><span class="p">,</span>
	<span class="n">MPP17_UNUSED</span><span class="p">,</span>
	<span class="n">MPP18_UNUSED</span><span class="p">,</span>
	<span class="n">MPP19_UNUSED</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dns323b_mpp_modes</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">MPP0_UNUSED</span><span class="p">,</span>
	<span class="n">MPP1_GPIO</span><span class="p">,</span>		<span class="cm">/* right amber LED (sata ch0) */</span>
	<span class="n">MPP2_GPIO</span><span class="p">,</span>		<span class="cm">/* left amber LED (sata ch1) */</span>
	<span class="n">MPP3_GPIO</span><span class="p">,</span>		<span class="cm">/* system up flag */</span>
	<span class="n">MPP4_GPIO</span><span class="p">,</span>		<span class="cm">/* power button LED */</span>
	<span class="n">MPP5_GPIO</span><span class="p">,</span>		<span class="cm">/* power button LED */</span>
	<span class="n">MPP6_GPIO</span><span class="p">,</span>		<span class="cm">/* GMT G751-2f overtemp */</span>
	<span class="n">MPP7_GPIO</span><span class="p">,</span>		<span class="cm">/* M41T80 nIRQ/OUT/SQW */</span>
	<span class="n">MPP8_GPIO</span><span class="p">,</span>		<span class="cm">/* triggers power off */</span>
	<span class="n">MPP9_GPIO</span><span class="p">,</span>		<span class="cm">/* power button switch */</span>
	<span class="n">MPP10_GPIO</span><span class="p">,</span>		<span class="cm">/* reset button switch */</span>
	<span class="n">MPP11_UNUSED</span><span class="p">,</span>
	<span class="n">MPP12_SATA_LED</span><span class="p">,</span>
	<span class="n">MPP13_SATA_LED</span><span class="p">,</span>
	<span class="n">MPP14_SATA_LED</span><span class="p">,</span>
	<span class="n">MPP15_SATA_LED</span><span class="p">,</span>
	<span class="n">MPP16_UNUSED</span><span class="p">,</span>
	<span class="n">MPP17_UNUSED</span><span class="p">,</span>
	<span class="n">MPP18_UNUSED</span><span class="p">,</span>
	<span class="n">MPP19_UNUSED</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dns323c_mpp_modes</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">MPP0_GPIO</span><span class="p">,</span>		<span class="cm">/* ? input */</span>
	<span class="n">MPP1_GPIO</span><span class="p">,</span>		<span class="cm">/* input power switch (0 = pressed) */</span>
	<span class="n">MPP2_GPIO</span><span class="p">,</span>		<span class="cm">/* output power off */</span>
	<span class="n">MPP3_UNUSED</span><span class="p">,</span>		<span class="cm">/* ? output */</span>
	<span class="n">MPP4_UNUSED</span><span class="p">,</span>		<span class="cm">/* ? output */</span>
	<span class="n">MPP5_UNUSED</span><span class="p">,</span>		<span class="cm">/* ? output */</span>
	<span class="n">MPP6_UNUSED</span><span class="p">,</span>		<span class="cm">/* ? output */</span>
	<span class="n">MPP7_UNUSED</span><span class="p">,</span>		<span class="cm">/* ? output */</span>
	<span class="n">MPP8_GPIO</span><span class="p">,</span>		<span class="cm">/* i/o right amber LED */</span>
	<span class="n">MPP9_GPIO</span><span class="p">,</span>		<span class="cm">/* i/o left amber LED */</span>
	<span class="n">MPP10_GPIO</span><span class="p">,</span>		<span class="cm">/* input */</span>
	<span class="n">MPP11_UNUSED</span><span class="p">,</span>
	<span class="n">MPP12_SATA_LED</span><span class="p">,</span>
	<span class="n">MPP13_SATA_LED</span><span class="p">,</span>
	<span class="n">MPP14_SATA_LED</span><span class="p">,</span>
	<span class="n">MPP15_SATA_LED</span><span class="p">,</span>
	<span class="n">MPP16_UNUSED</span><span class="p">,</span>
	<span class="n">MPP17_GPIO</span><span class="p">,</span>		<span class="cm">/* power button LED */</span>
	<span class="n">MPP18_GPIO</span><span class="p">,</span>		<span class="cm">/* fan speed bit 0 */</span>
	<span class="n">MPP19_GPIO</span><span class="p">,</span>		<span class="cm">/* fan speed bit 1 */</span>
	<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Rev C1 Fan speed notes:</span>
<span class="cm"> *</span>
<span class="cm"> * The fan is controlled by 2 GPIOs on this board. The settings</span>
<span class="cm"> * of the bits is as follow:</span>
<span class="cm"> *</span>
<span class="cm"> *  GPIO 18    GPIO 19    Fan</span>
<span class="cm"> *</span>
<span class="cm"> *    0          0        stopped</span>
<span class="cm"> *    0          1        low speed</span>
<span class="cm"> *    1          0        high speed</span>
<span class="cm"> *    1          1        don&#39;t do that (*)</span>
<span class="cm"> *</span>
<span class="cm"> * (*) I think the two bits control two feed-in resistors into a fixed</span>
<span class="cm"> *     PWN circuit, setting both bits will basically go a &#39;bit&#39; faster</span>
<span class="cm"> *     than high speed, but d-link doesn&#39;t do it and you may get out of</span>
<span class="cm"> *     HW spec so don&#39;t do it.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * On the DNS-323 A1 and B1 the following devices are attached via I2C:</span>
<span class="cm"> *</span>
<span class="cm"> *  i2c addr | chip        | description</span>
<span class="cm"> *  0x3e     | GMT G760Af  | fan speed PWM controller</span>
<span class="cm"> *  0x48     | GMT G751-2f | temp. sensor and therm. watchdog (LM75 compatible)</span>
<span class="cm"> *  0x68     | ST M41T80   | RTC w/ alarm</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">__initdata</span> <span class="n">dns323ab_i2c_devices</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;g760a&quot;</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">),</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;lm75&quot;</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">),</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;m41t80&quot;</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">),</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * On the DNS-323 C1 the following devices are attached via I2C:</span>
<span class="cm"> *</span>
<span class="cm"> *  i2c addr | chip        | description</span>
<span class="cm"> *  0x48     | GMT G751-2f | temp. sensor and therm. watchdog (LM75 compatible)</span>
<span class="cm"> *  0x68     | ST M41T80   | RTC w/ alarm</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">__initdata</span> <span class="n">dns323c_i2c_devices</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;lm75&quot;</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">),</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;m41t80&quot;</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">),</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* DNS-323 rev. A specific power off method */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dns323a_power_off</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;DNS-323: Triggering power-off...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">DNS323_GPIO_POWER_OFF</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* DNS-323 rev B specific power off method */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dns323b_power_off</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;DNS-323: Triggering power-off...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Pin has to be changed to 1 and back to 0 to do actual power off. */</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">DNS323_GPIO_POWER_OFF</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">DNS323_GPIO_POWER_OFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* DNS-323 rev. C specific power off method */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dns323c_power_off</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;DNS-323: Triggering power-off...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">DNS323C_GPIO_POWER_OFF</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dns323c_phy_fixup</span><span class="p">(</span><span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">MARVELL_PHY_M1118_DNS323_LEDS</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">dns323_identify_rev</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">dev</span><span class="p">,</span> <span class="n">rev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;DNS-323: Identifying board ... </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Rev A1 has a 5181 */</span>
	<span class="n">orion5x_pcie_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="n">MV88F5181_DEV_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;DNS-323: 5181 found, board is A1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">DNS323_REV_A1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;DNS-323: 5182 found, board is B1 or C1, checking PHY...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Rev B1 and C1 both have 5182, let&#39;s poke at the eth PHY. This is</span>
<span class="cm">	 * a bit gross but we want to do that without links into the eth</span>
<span class="cm">	 * driver so let&#39;s poke at it directly. We default to rev B1 in</span>
<span class="cm">	 * case the accesses fail</span>
<span class="cm">	 */</span>

<span class="cp">#define ETH_SMI_REG		(ORION5X_ETH_VIRT_BASE + 0x2000 + 0x004)</span>
<span class="cp">#define  SMI_BUSY		0x10000000</span>
<span class="cp">#define  SMI_READ_VALID		0x08000000</span>
<span class="cp">#define  SMI_OPCODE_READ	0x04000000</span>
<span class="cp">#define  SMI_OPCODE_WRITE	0x00000000</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ETH_SMI_REG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">SMI_BUSY</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;DNS-323: Timeout accessing PHY, assuming rev B1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">DNS323_REV_B1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">((</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">)</span>	<span class="cm">/* phy ID reg */</span> <span class="o">|</span>
	       <span class="p">(</span><span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>	<span class="cm">/* phy addr */</span> <span class="o">|</span>
	       <span class="n">SMI_OPCODE_READ</span><span class="p">,</span> <span class="n">ETH_SMI_REG</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ETH_SMI_REG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">SMI_READ_VALID</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;DNS-323: Timeout reading PHY, assuming rev B1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">DNS323_REV_B1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;DNS-323: Ethernet PHY ID 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>

	<span class="cm">/* Note: the Marvell tools mask the ID with 0x3f0 before comparison</span>
<span class="cm">	 * but I don&#39;t see that making a difference here, at least with</span>
<span class="cm">	 * any known Marvell PHY ID</span>
<span class="cm">	 */</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xfff0</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x0cc0</span>: <span class="cm">/* MV88E1111 */</span>
		<span class="k">return</span> <span class="n">DNS323_REV_B1</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x0e10</span>: <span class="cm">/* MV88E1118 */</span>
		<span class="k">return</span> <span class="n">DNS323_REV_C1</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;DNS-323: Unknown PHY ID 0x%04x, assuming rev B1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">DNS323_REV_B1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">dns323_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Setup basic Orion functions. Need to be called early. */</span>
	<span class="n">orion5x_init</span><span class="p">();</span>

	<span class="cm">/* Identify revision */</span>
	<span class="n">system_rev</span> <span class="o">=</span> <span class="n">dns323_identify_rev</span><span class="p">();</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;DNS-323: Identified HW revision %c1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="n">system_rev</span><span class="p">);</span>

	<span class="cm">/* Just to be tricky, the 5182 has a completely different</span>
<span class="cm">	 * set of MPP modes to the 5181.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">system_rev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DNS323_REV_A1</span>:
		<span class="n">orion5x_mpp_conf</span><span class="p">(</span><span class="n">dns323a_mpp_modes</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">MPP_DEV_CTRL</span><span class="p">);</span>		<span class="cm">/* DEV_D[31:16] */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DNS323_REV_B1</span>:
		<span class="n">orion5x_mpp_conf</span><span class="p">(</span><span class="n">dns323b_mpp_modes</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DNS323_REV_C1</span>:
		<span class="n">orion5x_mpp_conf</span><span class="p">(</span><span class="n">dns323c_mpp_modes</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* setup flash mapping</span>
<span class="cm">	 * CS3 holds a 8 MB Spansion S29GL064M90TFIR4</span>
<span class="cm">	 */</span>
	<span class="n">orion5x_setup_dev_boot_win</span><span class="p">(</span><span class="n">DNS323_NOR_BOOT_BASE</span><span class="p">,</span> <span class="n">DNS323_NOR_BOOT_SIZE</span><span class="p">);</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dns323_nor_flash</span><span class="p">);</span>

	<span class="cm">/* Sort out LEDs, Buttons and i2c devices */</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">system_rev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DNS323_REV_A1</span>:
		<span class="cm">/* The 5181 power LED is active low and requires</span>
<span class="cm">		 * DNS323_GPIO_LED_POWER1 to also be low.</span>
<span class="cm">		 */</span>
		 <span class="n">dns323ab_leds</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">active_low</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		 <span class="n">gpio_request</span><span class="p">(</span><span class="n">DNS323_GPIO_LED_POWER1</span><span class="p">,</span> <span class="s">&quot;Power Led Enable&quot;</span><span class="p">);</span>
		 <span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">DNS323_GPIO_LED_POWER1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* Fall through */</span>
	<span class="k">case</span> <span class="n">DNS323_REV_B1</span>:
		<span class="n">i2c_register_board_info</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dns323ab_i2c_devices</span><span class="p">,</span>
				<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dns323ab_i2c_devices</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DNS323_REV_C1</span>:
		<span class="cm">/* Hookup LEDs &amp; Buttons */</span>
		<span class="n">dns323_gpio_leds</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dns323c_led_data</span><span class="p">;</span>
		<span class="n">dns323_button_device</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dns323c_button_data</span><span class="p">;</span>

		<span class="cm">/* Hookup i2c devices and fan driver */</span>
		<span class="n">i2c_register_board_info</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dns323c_i2c_devices</span><span class="p">,</span>
				<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dns323c_i2c_devices</span><span class="p">));</span>
		<span class="n">platform_device_register_simple</span><span class="p">(</span><span class="s">&quot;dns323c-fan&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Register fixup for the PHY LEDs */</span>
		<span class="n">phy_register_fixup_for_uid</span><span class="p">(</span><span class="n">MARVELL_PHY_ID_88E1118</span><span class="p">,</span>
					   <span class="n">MARVELL_PHY_ID_MASK</span><span class="p">,</span>
					   <span class="n">dns323c_phy_fixup</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dns323_gpio_leds</span><span class="p">);</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dns323_button_device</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Configure peripherals.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dns323_read_mac_addr</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;DNS-323: Failed to read MAC address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">orion5x_ehci0_init</span><span class="p">();</span>
	<span class="n">orion5x_eth_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dns323_eth_data</span><span class="p">);</span>
	<span class="n">orion5x_i2c_init</span><span class="p">();</span>
	<span class="n">orion5x_uart0_init</span><span class="p">();</span>

	<span class="cm">/* Remaining GPIOs */</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">system_rev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DNS323_REV_A1</span>:
		<span class="cm">/* Poweroff GPIO */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpio_request</span><span class="p">(</span><span class="n">DNS323_GPIO_POWER_OFF</span><span class="p">,</span> <span class="s">&quot;POWEROFF&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">DNS323_GPIO_POWER_OFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;DNS-323: failed to setup power-off GPIO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pm_power_off</span> <span class="o">=</span> <span class="n">dns323a_power_off</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DNS323_REV_B1</span>:
		<span class="cm">/* 5182 built-in SATA init */</span>
		<span class="n">orion5x_sata_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dns323_sata_data</span><span class="p">);</span>

		<span class="cm">/* The DNS323 rev B1 has flag to indicate the system is up.</span>
<span class="cm">		 * Without this flag set, power LED will flash and cannot be</span>
<span class="cm">		 * controlled via leds-gpio.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpio_request</span><span class="p">(</span><span class="n">DNS323_GPIO_SYSTEM_UP</span><span class="p">,</span> <span class="s">&quot;SYS_READY&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">DNS323_GPIO_SYSTEM_UP</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* Poweroff GPIO */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpio_request</span><span class="p">(</span><span class="n">DNS323_GPIO_POWER_OFF</span><span class="p">,</span> <span class="s">&quot;POWEROFF&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">DNS323_GPIO_POWER_OFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;DNS-323: failed to setup power-off GPIO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pm_power_off</span> <span class="o">=</span> <span class="n">dns323b_power_off</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DNS323_REV_C1</span>:
		<span class="cm">/* 5182 built-in SATA init */</span>
		<span class="n">orion5x_sata_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dns323_sata_data</span><span class="p">);</span>

		<span class="cm">/* Poweroff GPIO */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpio_request</span><span class="p">(</span><span class="n">DNS323C_GPIO_POWER_OFF</span><span class="p">,</span> <span class="s">&quot;POWEROFF&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">DNS323C_GPIO_POWER_OFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;DNS-323: failed to setup power-off GPIO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pm_power_off</span> <span class="o">=</span> <span class="n">dns323c_power_off</span><span class="p">;</span>

		<span class="cm">/* Now, -this- should theorically be done by the sata_mv driver</span>
<span class="cm">		 * once I figure out what&#39;s going on there. Maybe the behaviour</span>
<span class="cm">		 * of the LEDs should be somewhat passed via the platform_data.</span>
<span class="cm">		 * for now, just whack the register and make the LEDs happy</span>
<span class="cm">		 *</span>
<span class="cm">		 * Note: AFAIK, rev B1 needs the same treatement but I&#39;ll let</span>
<span class="cm">		 * somebody else test it.</span>
<span class="cm">		 */</span>
		<span class="n">writel</span><span class="p">(</span><span class="mh">0x5</span><span class="p">,</span> <span class="n">ORION5X_SATA_VIRT_BASE</span> <span class="o">|</span> <span class="mh">0x2c</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Warning: D-Link uses a wrong mach-type (=526) in their bootloader */</span>
<span class="n">MACHINE_START</span><span class="p">(</span><span class="n">DNS323</span><span class="p">,</span> <span class="s">&quot;D-Link DNS-323&quot;</span><span class="p">)</span>
	<span class="cm">/* Maintainer: Herbert Valerio Riedel &lt;hvr@gnu.org&gt; */</span>
	<span class="p">.</span><span class="n">atag_offset</span>	<span class="o">=</span> <span class="mh">0x100</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_machine</span>	<span class="o">=</span> <span class="n">dns323_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">map_io</span>		<span class="o">=</span> <span class="n">orion5x_map_io</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_early</span>	<span class="o">=</span> <span class="n">orion5x_init_early</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_irq</span>	<span class="o">=</span> <span class="n">orion5x_init_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">timer</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">orion5x_timer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fixup</span>		<span class="o">=</span> <span class="n">tag_fixup_mem32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">restart</span>	<span class="o">=</span> <span class="n">orion5x_restart</span><span class="p">,</span>
<span class="n">MACHINE_END</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
