<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › mach-orion5x › ts78xx-setup.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ts78xx-setup.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * arch/arm/mach-orion5x/ts78xx-setup.c</span>
<span class="cm"> *</span>
<span class="cm"> * Maintainer: Alexander Clouter &lt;alex@digriz.org.uk&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This file is licensed under the terms of the GNU General Public</span>
<span class="cm"> * License version 2.  This program is licensed &quot;as is&quot; without any</span>
<span class="cm"> * warranty of any kind, whether express or implied.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/sysfs.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/mv643xx_eth.h&gt;</span>
<span class="cp">#include &lt;linux/ata_platform.h&gt;</span>
<span class="cp">#include &lt;linux/m48t86.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/nand.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/partitions.h&gt;</span>
<span class="cp">#include &lt;linux/timeriomem-rng.h&gt;</span>
<span class="cp">#include &lt;asm/mach-types.h&gt;</span>
<span class="cp">#include &lt;asm/mach/arch.h&gt;</span>
<span class="cp">#include &lt;asm/mach/map.h&gt;</span>
<span class="cp">#include &lt;mach/orion5x.h&gt;</span>
<span class="cp">#include &quot;common.h&quot;</span>
<span class="cp">#include &quot;mpp.h&quot;</span>
<span class="cp">#include &quot;ts78xx-fpga.h&quot;</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * TS-78xx Info</span>
<span class="cm"> ****************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * FPGA - lives where the PCI bus would be at ORION5X_PCI_MEM_PHYS_BASE</span>
<span class="cm"> */</span>
<span class="cp">#define TS78XX_FPGA_REGS_PHYS_BASE	0xe8000000</span>
<span class="cp">#define TS78XX_FPGA_REGS_VIRT_BASE	0xff900000</span>
<span class="cp">#define TS78XX_FPGA_REGS_SIZE		SZ_1M</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ts78xx_fpga_data</span> <span class="n">ts78xx_fpga</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">state</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="cm">/*	.supports	= ... - populated by ts78xx_fpga_supports() */</span>
<span class="p">};</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * I/O Address Mapping</span>
<span class="cm"> ****************************************************************************/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">map_desc</span> <span class="n">ts78xx_io_desc</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="k">virtual</span>	<span class="o">=</span> <span class="n">TS78XX_FPGA_REGS_VIRT_BASE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pfn</span>		<span class="o">=</span> <span class="n">__phys_to_pfn</span><span class="p">(</span><span class="n">TS78XX_FPGA_REGS_PHYS_BASE</span><span class="p">),</span>
		<span class="p">.</span><span class="n">length</span>		<span class="o">=</span> <span class="n">TS78XX_FPGA_REGS_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">MT_DEVICE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">ts78xx_map_io</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">orion5x_map_io</span><span class="p">();</span>
	<span class="n">iotable_init</span><span class="p">(</span><span class="n">ts78xx_io_desc</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ts78xx_io_desc</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * Ethernet</span>
<span class="cm"> ****************************************************************************/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mv643xx_eth_platform_data</span> <span class="n">ts78xx_eth_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">phy_addr</span>	<span class="o">=</span> <span class="n">MV643XX_ETH_PHY_ADDR</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * SATA</span>
<span class="cm"> ****************************************************************************/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mv_sata_platform_data</span> <span class="n">ts78xx_sata_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">n_ports</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * RTC M48T86 - nicked^Wborrowed from arch/arm/mach-ep93xx/ts72xx.c</span>
<span class="cm"> ****************************************************************************/</span>
<span class="cp">#define TS_RTC_CTRL	(TS78XX_FPGA_REGS_VIRT_BASE | 0x808)</span>
<span class="cp">#define TS_RTC_DATA	(TS78XX_FPGA_REGS_VIRT_BASE | 0x80c)</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">ts78xx_ts_rtc_readbyte</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">TS_RTC_CTRL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">readb</span><span class="p">(</span><span class="n">TS_RTC_DATA</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ts78xx_ts_rtc_writebyte</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">TS_RTC_CTRL</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">TS_RTC_DATA</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">m48t86_ops</span> <span class="n">ts78xx_ts_rtc_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">readbyte</span>	<span class="o">=</span> <span class="n">ts78xx_ts_rtc_readbyte</span><span class="p">,</span>
	<span class="p">.</span><span class="n">writebyte</span>	<span class="o">=</span> <span class="n">ts78xx_ts_rtc_writebyte</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">ts78xx_ts_rtc_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;rtc-m48t86&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ts78xx_ts_rtc_ops</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * TS uses some of the user storage space on the RTC chip so see if it is</span>
<span class="cm"> * present; as it&#39;s an optional feature at purchase time and not all boards</span>
<span class="cm"> * will have it present</span>
<span class="cm"> *</span>
<span class="cm"> * I&#39;ve used the method TS use in their rtc7800.c example for the detection</span>
<span class="cm"> *</span>
<span class="cm"> * TODO: track down a guinea pig without an RTC to see if we can work out a</span>
<span class="cm"> *		better RTC detection routine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ts78xx_ts_rtc_load</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tmp_rtc0</span><span class="p">,</span> <span class="n">tmp_rtc1</span><span class="p">;</span>

	<span class="n">tmp_rtc0</span> <span class="o">=</span> <span class="n">ts78xx_ts_rtc_readbyte</span><span class="p">(</span><span class="mi">126</span><span class="p">);</span>
	<span class="n">tmp_rtc1</span> <span class="o">=</span> <span class="n">ts78xx_ts_rtc_readbyte</span><span class="p">(</span><span class="mi">127</span><span class="p">);</span>

	<span class="n">ts78xx_ts_rtc_writebyte</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="mi">126</span><span class="p">);</span>
	<span class="n">ts78xx_ts_rtc_writebyte</span><span class="p">(</span><span class="mh">0x55</span><span class="p">,</span> <span class="mi">127</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ts78xx_ts_rtc_readbyte</span><span class="p">(</span><span class="mi">127</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x55</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ts78xx_ts_rtc_writebyte</span><span class="p">(</span><span class="mh">0xaa</span><span class="p">,</span> <span class="mi">127</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ts78xx_ts_rtc_readbyte</span><span class="p">(</span><span class="mi">127</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xaa</span>
				<span class="o">&amp;&amp;</span> <span class="n">ts78xx_ts_rtc_readbyte</span><span class="p">(</span><span class="mi">126</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ts78xx_ts_rtc_writebyte</span><span class="p">(</span><span class="n">tmp_rtc0</span><span class="p">,</span> <span class="mi">126</span><span class="p">);</span>
			<span class="n">ts78xx_ts_rtc_writebyte</span><span class="p">(</span><span class="n">tmp_rtc1</span><span class="p">,</span> <span class="mi">127</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">supports</span><span class="p">.</span><span class="n">ts_rtc</span><span class="p">.</span><span class="n">init</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts78xx_ts_rtc_device</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
					<span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">supports</span><span class="p">.</span><span class="n">ts_rtc</span><span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">platform_device_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts78xx_ts_rtc_device</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;RTC could not be registered: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">rc</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;RTC not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ts78xx_ts_rtc_unload</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_device_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts78xx_ts_rtc_device</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * NAND Flash</span>
<span class="cm"> ****************************************************************************/</span>
<span class="cp">#define TS_NAND_CTRL	(TS78XX_FPGA_REGS_VIRT_BASE | 0x800)	</span><span class="cm">/* VIRT */</span><span class="cp"></span>
<span class="cp">#define TS_NAND_DATA	(TS78XX_FPGA_REGS_PHYS_BASE | 0x804)	</span><span class="cm">/* PHYS */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * hardware specific access to control-lines</span>
<span class="cm"> *</span>
<span class="cm"> * ctrl:</span>
<span class="cm"> * NAND_NCE: bit 0 -&gt; bit 2</span>
<span class="cm"> * NAND_CLE: bit 1 -&gt; bit 1</span>
<span class="cm"> * NAND_ALE: bit 2 -&gt; bit 0</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ts78xx_ts_nand_cmd_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">NAND_CTRL_CHANGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bits</span><span class="p">;</span>

		<span class="n">bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">NAND_NCE</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">bits</span> <span class="o">|=</span> <span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">NAND_CLE</span><span class="p">;</span>
		<span class="n">bits</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">NAND_ALE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">writeb</span><span class="p">((</span><span class="n">readb</span><span class="p">(</span><span class="n">TS_NAND_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x7</span><span class="p">)</span> <span class="o">|</span> <span class="n">bits</span><span class="p">,</span> <span class="n">TS_NAND_CTRL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">NAND_CMD_NONE</span><span class="p">)</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">IO_ADDR_W</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ts78xx_ts_nand_dev_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readb</span><span class="p">(</span><span class="n">TS_NAND_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ts78xx_ts_nand_write_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">io_base</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">IO_ADDR_W</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">off</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">buf</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">sz</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">off</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sz</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">off</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">writesb</span><span class="p">(</span><span class="n">io_base</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">sz</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sz</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sz</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="o">*</span><span class="n">buf32</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
		<span class="n">writesl</span><span class="p">(</span><span class="n">io_base</span><span class="p">,</span> <span class="n">buf32</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">sz</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">sz</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span>
		<span class="n">writesb</span><span class="p">(</span><span class="n">io_base</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ts78xx_ts_nand_read_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span>
			<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">io_base</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">IO_ADDR_R</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">off</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">buf</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">sz</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">off</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sz</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">off</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">readsb</span><span class="p">(</span><span class="n">io_base</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">sz</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sz</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sz</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="o">*</span><span class="n">buf32</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
		<span class="n">readsl</span><span class="p">(</span><span class="n">io_base</span><span class="p">,</span> <span class="n">buf32</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">sz</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">sz</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span>
		<span class="n">readsb</span><span class="p">(</span><span class="n">io_base</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mtd_partition</span> <span class="n">ts78xx_ts_nand_parts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;mbr&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="n">SZ_128K</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask_flags</span>	<span class="o">=</span> <span class="n">MTD_WRITEABLE</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;kernel&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="n">MTDPART_OFS_APPEND</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="n">SZ_4M</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;initrd&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="n">MTDPART_OFS_APPEND</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="n">SZ_4M</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;rootfs&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="n">MTDPART_OFS_APPEND</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="n">MTDPART_SIZ_FULL</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_nand_data</span> <span class="n">ts78xx_ts_nand_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">chip</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">nr_chips</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">partitions</span>		<span class="o">=</span> <span class="n">ts78xx_ts_nand_parts</span><span class="p">,</span>
		<span class="p">.</span><span class="n">nr_partitions</span>		<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ts78xx_ts_nand_parts</span><span class="p">),</span>
		<span class="p">.</span><span class="n">chip_delay</span>		<span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bbt_options</span>		<span class="o">=</span> <span class="n">NAND_BBT_USE_FLASH</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">ctrl</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The HW ECC offloading functions, used to give about a 9%</span>
<span class="cm">		 * performance increase for &#39;dd if=/dev/mtdblockX&#39; and 5% for</span>
<span class="cm">		 * nanddump.  This all however was changed by git commit</span>
<span class="cm">		 * e6cf5df1838c28bb060ac45b5585e48e71bbc740 so now there is</span>
<span class="cm">		 * no performance advantage to be had so we no longer bother</span>
<span class="cm">		 */</span>
		<span class="p">.</span><span class="n">cmd_ctrl</span>		<span class="o">=</span> <span class="n">ts78xx_ts_nand_cmd_ctrl</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dev_ready</span>		<span class="o">=</span> <span class="n">ts78xx_ts_nand_dev_ready</span><span class="p">,</span>
		<span class="p">.</span><span class="n">write_buf</span>		<span class="o">=</span> <span class="n">ts78xx_ts_nand_write_buf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">read_buf</span>		<span class="o">=</span> <span class="n">ts78xx_ts_nand_read_buf</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">ts78xx_ts_nand_resources</span>
			<span class="o">=</span> <span class="n">DEFINE_RES_MEM</span><span class="p">(</span><span class="n">TS_NAND_DATA</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">ts78xx_ts_nand_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;gen_nand&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ts78xx_ts_nand_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ts78xx_ts_nand_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ts78xx_ts_nand_load</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">supports</span><span class="p">.</span><span class="n">ts_nand</span><span class="p">.</span><span class="n">init</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts78xx_ts_nand_device</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">supports</span><span class="p">.</span><span class="n">ts_nand</span><span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">platform_device_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts78xx_ts_nand_device</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;NAND could not be registered: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ts78xx_ts_nand_unload</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_device_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts78xx_ts_nand_device</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * HW RNG</span>
<span class="cm"> ****************************************************************************/</span>
<span class="cp">#define TS_RNG_DATA	(TS78XX_FPGA_REGS_PHYS_BASE | 0x044)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">ts78xx_ts_rng_resource</span>
			<span class="o">=</span> <span class="n">DEFINE_RES_MEM</span><span class="p">(</span><span class="n">TS_RNG_DATA</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">timeriomem_rng_data</span> <span class="n">ts78xx_ts_rng_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">period</span>		<span class="o">=</span> <span class="mi">1000000</span><span class="p">,</span> <span class="cm">/* one second */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">ts78xx_ts_rng_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;timeriomem_rng&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ts78xx_ts_rng_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ts78xx_ts_rng_resource</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ts78xx_ts_rng_load</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">supports</span><span class="p">.</span><span class="n">ts_rng</span><span class="p">.</span><span class="n">init</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts78xx_ts_rng_device</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">supports</span><span class="p">.</span><span class="n">ts_rng</span><span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">platform_device_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts78xx_ts_rng_device</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;RNG could not be registered: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ts78xx_ts_rng_unload</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_device_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts78xx_ts_rng_device</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * FPGA &#39;hotplug&#39; support code</span>
<span class="cm"> ****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ts78xx_fpga_devices_zero_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">supports</span><span class="p">.</span><span class="n">ts_rtc</span><span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">supports</span><span class="p">.</span><span class="n">ts_nand</span><span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">supports</span><span class="p">.</span><span class="n">ts_rng</span><span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ts78xx_fpga_supports</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* TODO: put this &#39;table&#39; into ts78xx-fpga.h */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TS7800_REV_1</span>:
	<span class="k">case</span> <span class="n">TS7800_REV_2</span>:
	<span class="k">case</span> <span class="n">TS7800_REV_3</span>:
	<span class="k">case</span> <span class="n">TS7800_REV_4</span>:
	<span class="k">case</span> <span class="n">TS7800_REV_5</span>:
	<span class="k">case</span> <span class="n">TS7800_REV_6</span>:
	<span class="k">case</span> <span class="n">TS7800_REV_7</span>:
	<span class="k">case</span> <span class="n">TS7800_REV_8</span>:
	<span class="k">case</span> <span class="n">TS7800_REV_9</span>:
		<span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">supports</span><span class="p">.</span><span class="n">ts_rtc</span><span class="p">.</span><span class="n">present</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">supports</span><span class="p">.</span><span class="n">ts_nand</span><span class="p">.</span><span class="n">present</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">supports</span><span class="p">.</span><span class="n">ts_rng</span><span class="p">.</span><span class="n">present</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* enable devices if magic matches */</span>
		<span class="k">switch</span> <span class="p">((</span><span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">id</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TS7800_FPGA_MAGIC</span>:
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;unrecognised FPGA revision 0x%.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">id</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">supports</span><span class="p">.</span><span class="n">ts_rtc</span><span class="p">.</span><span class="n">present</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">supports</span><span class="p">.</span><span class="n">ts_nand</span><span class="p">.</span><span class="n">present</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">supports</span><span class="p">.</span><span class="n">ts_rng</span><span class="p">.</span><span class="n">present</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">supports</span><span class="p">.</span><span class="n">ts_rtc</span><span class="p">.</span><span class="n">present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">supports</span><span class="p">.</span><span class="n">ts_nand</span><span class="p">.</span><span class="n">present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">supports</span><span class="p">.</span><span class="n">ts_rng</span><span class="p">.</span><span class="n">present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ts78xx_fpga_load_devices</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">supports</span><span class="p">.</span><span class="n">ts_rtc</span><span class="p">.</span><span class="n">present</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">ts78xx_ts_rtc_load</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
			<span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">supports</span><span class="p">.</span><span class="n">ts_rtc</span><span class="p">.</span><span class="n">present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">supports</span><span class="p">.</span><span class="n">ts_nand</span><span class="p">.</span><span class="n">present</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">ts78xx_ts_nand_load</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
			<span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">supports</span><span class="p">.</span><span class="n">ts_nand</span><span class="p">.</span><span class="n">present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">supports</span><span class="p">.</span><span class="n">ts_rng</span><span class="p">.</span><span class="n">present</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">ts78xx_ts_rng_load</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
			<span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">supports</span><span class="p">.</span><span class="n">ts_rng</span><span class="p">.</span><span class="n">present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ts78xx_fpga_unload_devices</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">supports</span><span class="p">.</span><span class="n">ts_rtc</span><span class="p">.</span><span class="n">present</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">ts78xx_ts_rtc_unload</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">supports</span><span class="p">.</span><span class="n">ts_nand</span><span class="p">.</span><span class="n">present</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">ts78xx_ts_nand_unload</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">supports</span><span class="p">.</span><span class="n">ts_rng</span><span class="p">.</span><span class="n">present</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">ts78xx_ts_rng_unload</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ts78xx_fpga_load</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">TS78XX_FPGA_REGS_VIRT_BASE</span><span class="p">);</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;FPGA magic=0x%.6x, rev=0x%.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">id</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span><span class="p">,</span>
			<span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">id</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">ts78xx_fpga_supports</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ts78xx_fpga_load_devices</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ts78xx_fpga_unload</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fpga_id</span><span class="p">;</span>

	<span class="n">fpga_id</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">TS78XX_FPGA_REGS_VIRT_BASE</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * There does not seem to be a feasible way to block access to the GPIO</span>
<span class="cm">	 * pins from userspace (/dev/mem).  This if clause should hopefully warn</span>
<span class="cm">	 * those foolish enough not to follow &#39;policy&#39; :)</span>
<span class="cm">	 *</span>
<span class="cm">	 * UrJTAG SVN since r1381 can be used to reprogram the FPGA</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">fpga_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;FPGA magic/rev mismatch</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;TS-78xx FPGA: was 0x%.6x/%.2x but now 0x%.6x/%.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">id</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span><span class="p">,</span> <span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">id</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
			<span class="p">(</span><span class="n">fpga_id</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span><span class="p">,</span> <span class="n">fpga_id</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ts78xx_fpga_unload_devices</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ts78xx_fpga_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">kobj_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">state</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;borked</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;online&quot;</span> <span class="o">:</span> <span class="s">&quot;offline&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ts78xx_fpga_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">kobj_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">value</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">state</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;FPGA borked, you must powercycle ASAP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;online&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="s">&quot;online&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;offline&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="s">&quot;offline&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">?</span> <span class="n">ts78xx_fpga_load</span><span class="p">()</span>
		<span class="o">:</span> <span class="n">ts78xx_fpga_unload</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">ts78xx_fpga</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kobj_attribute</span> <span class="n">ts78xx_fpga_attr</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">ts78xx_fpga</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">ts78xx_fpga_show</span><span class="p">,</span> <span class="n">ts78xx_fpga_store</span><span class="p">);</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * General Setup</span>
<span class="cm"> ****************************************************************************/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ts78xx_mpp_modes</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">MPP0_UNUSED</span><span class="p">,</span>
	<span class="n">MPP1_GPIO</span><span class="p">,</span>		<span class="cm">/* JTAG Clock */</span>
	<span class="n">MPP2_GPIO</span><span class="p">,</span>		<span class="cm">/* JTAG Data In */</span>
	<span class="n">MPP3_GPIO</span><span class="p">,</span>		<span class="cm">/* Lat ECP2 256 FPGA - PB2B */</span>
	<span class="n">MPP4_GPIO</span><span class="p">,</span>		<span class="cm">/* JTAG Data Out */</span>
	<span class="n">MPP5_GPIO</span><span class="p">,</span>		<span class="cm">/* JTAG TMS */</span>
	<span class="n">MPP6_GPIO</span><span class="p">,</span>		<span class="cm">/* Lat ECP2 256 FPGA - PB31A_CLK4+ */</span>
	<span class="n">MPP7_GPIO</span><span class="p">,</span>		<span class="cm">/* Lat ECP2 256 FPGA - PB22B */</span>
	<span class="n">MPP8_UNUSED</span><span class="p">,</span>
	<span class="n">MPP9_UNUSED</span><span class="p">,</span>
	<span class="n">MPP10_UNUSED</span><span class="p">,</span>
	<span class="n">MPP11_UNUSED</span><span class="p">,</span>
	<span class="n">MPP12_UNUSED</span><span class="p">,</span>
	<span class="n">MPP13_UNUSED</span><span class="p">,</span>
	<span class="n">MPP14_UNUSED</span><span class="p">,</span>
	<span class="n">MPP15_UNUSED</span><span class="p">,</span>
	<span class="n">MPP16_UART</span><span class="p">,</span>
	<span class="n">MPP17_UART</span><span class="p">,</span>
	<span class="n">MPP18_UART</span><span class="p">,</span>
	<span class="n">MPP19_UART</span><span class="p">,</span>
	<span class="cm">/*</span>
<span class="cm">	 * MPP[20] PCI Clock Out 1</span>
<span class="cm">	 * MPP[21] PCI Clock Out 0</span>
<span class="cm">	 * MPP[22] Unused</span>
<span class="cm">	 * MPP[23] Unused</span>
<span class="cm">	 * MPP[24] Unused</span>
<span class="cm">	 * MPP[25] Unused</span>
<span class="cm">	 */</span>
	<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">ts78xx_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup basic Orion functions. Need to be called early.</span>
<span class="cm">	 */</span>
	<span class="n">orion5x_init</span><span class="p">();</span>

	<span class="n">orion5x_mpp_conf</span><span class="p">(</span><span class="n">ts78xx_mpp_modes</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Configure peripherals.</span>
<span class="cm">	 */</span>
	<span class="n">orion5x_ehci0_init</span><span class="p">();</span>
	<span class="n">orion5x_ehci1_init</span><span class="p">();</span>
	<span class="n">orion5x_eth_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts78xx_eth_data</span><span class="p">);</span>
	<span class="n">orion5x_sata_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts78xx_sata_data</span><span class="p">);</span>
	<span class="n">orion5x_uart0_init</span><span class="p">();</span>
	<span class="n">orion5x_uart1_init</span><span class="p">();</span>
	<span class="n">orion5x_xor_init</span><span class="p">();</span>

	<span class="cm">/* FPGA init */</span>
	<span class="n">ts78xx_fpga_devices_zero_init</span><span class="p">();</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ts78xx_fpga_load</span><span class="p">();</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sysfs_create_file</span><span class="p">(</span><span class="n">firmware_kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts78xx_fpga_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;sysfs_create_file failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MACHINE_START</span><span class="p">(</span><span class="n">TS78XX</span><span class="p">,</span> <span class="s">&quot;Technologic Systems TS-78xx SBC&quot;</span><span class="p">)</span>
	<span class="cm">/* Maintainer: Alexander Clouter &lt;alex@digriz.org.uk&gt; */</span>
	<span class="p">.</span><span class="n">atag_offset</span>	<span class="o">=</span> <span class="mh">0x100</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_machine</span>	<span class="o">=</span> <span class="n">ts78xx_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">map_io</span>		<span class="o">=</span> <span class="n">ts78xx_map_io</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_early</span>	<span class="o">=</span> <span class="n">orion5x_init_early</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_irq</span>	<span class="o">=</span> <span class="n">orion5x_init_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">timer</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">orion5x_timer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">restart</span>	<span class="o">=</span> <span class="n">orion5x_restart</span><span class="p">,</span>
<span class="n">MACHINE_END</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
