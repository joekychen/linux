<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › mach-shmobile › pm-sh7372.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>pm-sh7372.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * sh7372 Power management support</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2011 Magnus Damm</span>
<span class="cm"> *</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License.  See the file &quot;COPYING&quot; in the main directory of this archive</span>
<span class="cm"> * for more details.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/pm.h&gt;</span>
<span class="cp">#include &lt;linux/suspend.h&gt;</span>
<span class="cp">#include &lt;linux/cpuidle.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/pm_clock.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/bitrev.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/tlbflush.h&gt;</span>
<span class="cp">#include &lt;asm/suspend.h&gt;</span>
<span class="cp">#include &lt;mach/common.h&gt;</span>
<span class="cp">#include &lt;mach/sh7372.h&gt;</span>

<span class="cm">/* DBG */</span>
<span class="cp">#define DBGREG1 0xe6100020</span>
<span class="cp">#define DBGREG9 0xe6100040</span>

<span class="cm">/* CPGA */</span>
<span class="cp">#define SYSTBCR 0xe6150024</span>
<span class="cp">#define MSTPSR0 0xe6150030</span>
<span class="cp">#define MSTPSR1 0xe6150038</span>
<span class="cp">#define MSTPSR2 0xe6150040</span>
<span class="cp">#define MSTPSR3 0xe6150048</span>
<span class="cp">#define MSTPSR4 0xe615004c</span>
<span class="cp">#define PLLC01STPCR 0xe61500c8</span>

<span class="cm">/* SYSC */</span>
<span class="cp">#define SPDCR 0xe6180008</span>
<span class="cp">#define SWUCR 0xe6180014</span>
<span class="cp">#define SBAR 0xe6180020</span>
<span class="cp">#define WUPRMSK 0xe6180028</span>
<span class="cp">#define WUPSMSK 0xe618002c</span>
<span class="cp">#define WUPSMSK2 0xe6180048</span>
<span class="cp">#define PSTR 0xe6180080</span>
<span class="cp">#define WUPSFAC 0xe6180098</span>
<span class="cp">#define IRQCR 0xe618022c</span>
<span class="cp">#define IRQCR2 0xe6180238</span>
<span class="cp">#define IRQCR3 0xe6180244</span>
<span class="cp">#define IRQCR4 0xe6180248</span>
<span class="cp">#define PDNSEL 0xe6180254</span>

<span class="cm">/* INTC */</span>
<span class="cp">#define ICR1A 0xe6900000</span>
<span class="cp">#define ICR2A 0xe6900004</span>
<span class="cp">#define ICR3A 0xe6900008</span>
<span class="cp">#define ICR4A 0xe690000c</span>
<span class="cp">#define INTMSK00A 0xe6900040</span>
<span class="cp">#define INTMSK10A 0xe6900044</span>
<span class="cp">#define INTMSK20A 0xe6900048</span>
<span class="cp">#define INTMSK30A 0xe690004c</span>

<span class="cm">/* MFIS */</span>
<span class="cp">#define SMFRAM 0xe6a70000</span>

<span class="cm">/* AP-System Core */</span>
<span class="cp">#define APARMBAREA 0xe6f10020</span>

<span class="cp">#define PSTR_RETRIES 100</span>
<span class="cp">#define PSTR_DELAY_US 10</span>

<span class="cp">#ifdef CONFIG_PM</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pd_power_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh7372_pm_domain</span> <span class="o">*</span><span class="n">sh7372_pd</span> <span class="o">=</span> <span class="n">to_sh7372_pd</span><span class="p">(</span><span class="n">genpd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">sh7372_pd</span><span class="o">-&gt;</span><span class="n">bit_shift</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sh7372_pd</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">sh7372_pd</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">PSTR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">retry_count</span><span class="p">;</span>

		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">SPDCR</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">retry_count</span> <span class="o">=</span> <span class="n">PSTR_RETRIES</span><span class="p">;</span> <span class="n">retry_count</span><span class="p">;</span> <span class="n">retry_count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">SPDCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">cpu_relax</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sh7372_pd</span><span class="o">-&gt;</span><span class="n">no_debug</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Power off, 0x%08x -&gt; PSTR = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">genpd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">PSTR</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__pd_power_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh7372_pm_domain</span> <span class="o">*</span><span class="n">sh7372_pd</span><span class="p">,</span> <span class="n">bool</span> <span class="n">do_resume</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">sh7372_pd</span><span class="o">-&gt;</span><span class="n">bit_shift</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">retry_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">PSTR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">SWUCR</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">retry_count</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">PSTR_RETRIES</span><span class="p">;</span> <span class="n">retry_count</span><span class="p">;</span> <span class="n">retry_count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">SWUCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retry_count</span> <span class="o">&gt;</span> <span class="n">PSTR_RETRIES</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="n">PSTR_DELAY_US</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">cpu_relax</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retry_count</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sh7372_pd</span><span class="o">-&gt;</span><span class="n">no_debug</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Power on, 0x%08x -&gt; PSTR = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">sh7372_pd</span><span class="o">-&gt;</span><span class="n">genpd</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">PSTR</span><span class="p">));</span>

 <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">sh7372_pd</span><span class="o">-&gt;</span><span class="n">resume</span> <span class="o">&amp;&amp;</span> <span class="n">do_resume</span><span class="p">)</span>
		<span class="n">sh7372_pd</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pd_power_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span><span class="p">)</span>
<span class="p">{</span>
	 <span class="k">return</span> <span class="n">__pd_power_up</span><span class="p">(</span><span class="n">to_sh7372_pd</span><span class="p">(</span><span class="n">genpd</span><span class="p">),</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh7372_a4r_suspend</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sh7372_intcs_suspend</span><span class="p">();</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x300fffff</span><span class="p">,</span> <span class="n">WUPRMSK</span><span class="p">);</span> <span class="cm">/* avoid wakeup */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">pd_active_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="p">(</span><span class="o">*</span><span class="n">active_wakeup</span><span class="p">)(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">active_wakeup</span> <span class="o">=</span> <span class="n">dev_gpd_data</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">active_wakeup</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">active_wakeup</span> <span class="o">?</span> <span class="n">active_wakeup</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">:</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh7372_stop_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">stop</span><span class="p">)(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">stop</span> <span class="o">=</span> <span class="n">dev_gpd_data</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">stop</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">pm_clk_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh7372_start_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">start</span><span class="p">)(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pm_clk_resume</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">start</span> <span class="o">=</span> <span class="n">dev_gpd_data</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">start</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">sh7372_init_pm_domain</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh7372_pm_domain</span> <span class="o">*</span><span class="n">sh7372_pd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">genpd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh7372_pd</span><span class="o">-&gt;</span><span class="n">genpd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dev_power_governor</span> <span class="o">*</span><span class="n">gov</span> <span class="o">=</span> <span class="n">sh7372_pd</span><span class="o">-&gt;</span><span class="n">gov</span><span class="p">;</span>

	<span class="n">pm_genpd_init</span><span class="p">(</span><span class="n">genpd</span><span class="p">,</span> <span class="n">gov</span> <span class="o">?</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">simple_qos_governor</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">dev_ops</span><span class="p">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">sh7372_stop_dev</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">dev_ops</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">sh7372_start_dev</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">dev_ops</span><span class="p">.</span><span class="n">active_wakeup</span> <span class="o">=</span> <span class="n">pd_active_wakeup</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">dev_irq_safe</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">power_off</span> <span class="o">=</span> <span class="n">pd_power_down</span><span class="p">;</span>
	<span class="n">genpd</span><span class="o">-&gt;</span><span class="n">power_on</span> <span class="o">=</span> <span class="n">pd_power_up</span><span class="p">;</span>
	<span class="n">__pd_power_up</span><span class="p">(</span><span class="n">sh7372_pd</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">sh7372_add_device_to_domain</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh7372_pm_domain</span> <span class="o">*</span><span class="n">sh7372_pd</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">pm_genpd_add_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh7372_pd</span><span class="o">-&gt;</span><span class="n">genpd</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pm_clk_no_clocks</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">pm_clk_add</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">sh7372_pm_add_subdomain</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh7372_pm_domain</span> <span class="o">*</span><span class="n">sh7372_pd</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">sh7372_pm_domain</span> <span class="o">*</span><span class="n">sh7372_sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pm_genpd_add_subdomain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh7372_pd</span><span class="o">-&gt;</span><span class="n">genpd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh7372_sd</span><span class="o">-&gt;</span><span class="n">genpd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">sh7372_pm_domain</span> <span class="n">sh7372_a4lc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">genpd</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;A4LC&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bit_shift</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sh7372_pm_domain</span> <span class="n">sh7372_a4mp</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">genpd</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;A4MP&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bit_shift</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sh7372_pm_domain</span> <span class="n">sh7372_d4</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">genpd</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;D4&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bit_shift</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sh7372_pm_domain</span> <span class="n">sh7372_a4r</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">genpd</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;A4R&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bit_shift</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">sh7372_a4r_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">sh7372_intcs_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sh7372_pm_domain</span> <span class="n">sh7372_a3rv</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">genpd</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;A3RV&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bit_shift</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sh7372_pm_domain</span> <span class="n">sh7372_a3ri</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">genpd</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;A3RI&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bit_shift</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh7372_a4s_suspend</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * The A4S domain contains the CPU core and therefore it should</span>
<span class="cm">	 * only be turned off if the CPU is in use.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">sh7372_pm_domain</span> <span class="n">sh7372_a4s</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">genpd</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;A4S&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bit_shift</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gov</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm_domain_always_on_gov</span><span class="p">,</span>
	<span class="p">.</span><span class="n">no_debug</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">sh7372_a4s_suspend</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh7372_a3sp_suspend</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Serial consoles make use of SCIF hardware located in A3SP,</span>
<span class="cm">	 * keep such power domain on if &quot;no_console_suspend&quot; is set.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">console_suspend_enabled</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">sh7372_pm_domain</span> <span class="n">sh7372_a3sp</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">genpd</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;A3SP&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bit_shift</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gov</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm_domain_always_on_gov</span><span class="p">,</span>
	<span class="p">.</span><span class="n">no_debug</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">sh7372_a3sp_suspend</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sh7372_pm_domain</span> <span class="n">sh7372_a3sg</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">genpd</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;A3SG&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bit_shift</span> <span class="o">=</span> <span class="mi">13</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#else </span><span class="cm">/* !CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sh7372_a3sp_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{}</span>

<span class="cp">#endif </span><span class="cm">/* !CONFIG_PM */</span><span class="cp"></span>

<span class="cp">#if defined(CONFIG_SUSPEND) || defined(CONFIG_CPU_IDLE)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh7372_do_idle_core_standby</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cpu_do_idle</span><span class="p">();</span> <span class="cm">/* WFI when SYSTBCR == 0x10 -&gt; Core Standby */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh7372_set_reset_vector</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* set reset vector, translate 4k */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">SBAR</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">APARMBAREA</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh7372_enter_core_standby</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sh7372_set_reset_vector</span><span class="p">(</span><span class="n">__pa</span><span class="p">(</span><span class="n">sh7372_resume_core_standby_sysc</span><span class="p">));</span>

	<span class="cm">/* enter sleep mode with SYSTBCR to 0x10 */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="n">SYSTBCR</span><span class="p">);</span>
	<span class="n">cpu_suspend</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sh7372_do_idle_core_standby</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">SYSTBCR</span><span class="p">);</span>

	 <span class="cm">/* disable reset vector translation */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">SBAR</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_SUSPEND</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh7372_enter_sysc</span><span class="p">(</span><span class="kt">int</span> <span class="n">pllc0_on</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sleep_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pllc0_on</span><span class="p">)</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">PLLC01STPCR</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">,</span> <span class="n">PLLC01STPCR</span><span class="p">);</span>

	<span class="n">__raw_readl</span><span class="p">(</span><span class="n">WUPSFAC</span><span class="p">);</span> <span class="cm">/* read wakeup int. factor before sleep */</span>
	<span class="n">cpu_suspend</span><span class="p">(</span><span class="n">sleep_mode</span><span class="p">,</span> <span class="n">sh7372_do_idle_sysc</span><span class="p">);</span>
	<span class="n">__raw_readl</span><span class="p">(</span><span class="n">WUPSFAC</span><span class="p">);</span> <span class="cm">/* read wakeup int. factor after wakeup */</span>

	 <span class="cm">/* disable reset vector translation */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">SBAR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh7372_sysc_valid</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">mskp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">msk2p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mstpsr0</span><span class="p">,</span> <span class="n">mstpsr1</span><span class="p">,</span> <span class="n">mstpsr2</span><span class="p">,</span> <span class="n">mstpsr3</span><span class="p">,</span> <span class="n">mstpsr4</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">msk</span><span class="p">,</span> <span class="n">msk2</span><span class="p">;</span>

	<span class="cm">/* check active clocks to determine potential wakeup sources */</span>

	<span class="n">mstpsr0</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">MSTPSR0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mstpsr0</span> <span class="o">&amp;</span> <span class="mh">0x00000003</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00000003</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;sh7372 mstpsr0 0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mstpsr0</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mstpsr1</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">MSTPSR1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mstpsr1</span> <span class="o">&amp;</span> <span class="mh">0xff079b7f</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xff079b7f</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;sh7372 mstpsr1 0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mstpsr1</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mstpsr2</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">MSTPSR2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mstpsr2</span> <span class="o">&amp;</span> <span class="mh">0x000741ff</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x000741ff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;sh7372 mstpsr2 0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mstpsr2</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mstpsr3</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">MSTPSR3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mstpsr3</span> <span class="o">&amp;</span> <span class="mh">0x1a60f010</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x1a60f010</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;sh7372 mstpsr3 0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mstpsr3</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mstpsr4</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">MSTPSR4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mstpsr4</span> <span class="o">&amp;</span> <span class="mh">0x00008cf0</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00008cf0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;sh7372 mstpsr4 0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mstpsr4</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">msk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msk2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* make bitmaps of limited number of wakeup sources */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mstpsr2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* SPU2 */</span>
		<span class="n">msk</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mstpsr2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* MFI_MFIM */</span>
		<span class="n">msk</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mstpsr4</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* KEYSC */</span>
		<span class="n">msk</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mstpsr1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* CMT0 */</span>
		<span class="n">msk</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mstpsr3</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* CMT1 */</span>
		<span class="n">msk</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mstpsr4</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* CMT2 */</span>
		<span class="n">msk</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mstpsr2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* MFI_MFIS */</span>
		<span class="n">msk2</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">;</span>

	<span class="o">*</span><span class="n">mskp</span> <span class="o">=</span> <span class="n">msk</span><span class="p">;</span>
	<span class="o">*</span><span class="n">msk2p</span> <span class="o">=</span> <span class="n">msk2</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh7372_icr_to_irqcr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">icr</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">irqcr1p</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">irqcr2p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">irqcr1</span><span class="p">,</span> <span class="n">irqcr2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>

	<span class="n">irqcr1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">irqcr2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* convert INTCA ICR register layout to SYSC IRQCR+IRQCR2 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">icr</span> <span class="o">&gt;&gt;</span> <span class="p">((</span><span class="mi">7</span> <span class="o">-</span> <span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="n">irqcr1</span> <span class="o">|=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">irqcr2</span> <span class="o">|=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">irqcr1p</span> <span class="o">=</span> <span class="n">irqcr1</span><span class="p">;</span>
	<span class="o">*</span><span class="n">irqcr2p</span> <span class="o">=</span> <span class="n">irqcr2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh7372_setup_sysc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">msk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">msk2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">irqcrx_low</span><span class="p">,</span> <span class="n">irqcrx_high</span><span class="p">,</span> <span class="n">irqcry_low</span><span class="p">,</span> <span class="n">irqcry_high</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* read IRQ0A -&gt; IRQ15A mask */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">bitrev8</span><span class="p">(</span><span class="n">__raw_readb</span><span class="p">(</span><span class="n">INTMSK00A</span><span class="p">));</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">bitrev8</span><span class="p">(</span><span class="n">__raw_readb</span><span class="p">(</span><span class="n">INTMSK10A</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="cm">/* setup WUPSMSK from clocks and external IRQ mask */</span>
	<span class="n">msk</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">msk</span> <span class="o">&amp;</span> <span class="mh">0xc030000f</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">msk</span><span class="p">,</span> <span class="n">WUPSMSK</span><span class="p">);</span>

	<span class="cm">/* propage level/edge trigger for external IRQ 0-&gt;15 */</span>
	<span class="n">sh7372_icr_to_irqcr</span><span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">ICR1A</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">irqcrx_low</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irqcry_low</span><span class="p">);</span>
	<span class="n">sh7372_icr_to_irqcr</span><span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">ICR2A</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">irqcrx_high</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irqcry_high</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">((</span><span class="n">irqcrx_high</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">irqcrx_low</span><span class="p">,</span> <span class="n">IRQCR</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">((</span><span class="n">irqcry_high</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">irqcry_low</span><span class="p">,</span> <span class="n">IRQCR2</span><span class="p">);</span>

	<span class="cm">/* read IRQ16A -&gt; IRQ31A mask */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">bitrev8</span><span class="p">(</span><span class="n">__raw_readb</span><span class="p">(</span><span class="n">INTMSK20A</span><span class="p">));</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">bitrev8</span><span class="p">(</span><span class="n">__raw_readb</span><span class="p">(</span><span class="n">INTMSK30A</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="cm">/* setup WUPSMSK2 from clocks and external IRQ mask */</span>
	<span class="n">msk2</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">msk2</span> <span class="o">&amp;</span> <span class="mh">0x00030000</span><span class="p">)</span> <span class="o">|</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">msk2</span><span class="p">,</span> <span class="n">WUPSMSK2</span><span class="p">);</span>

	<span class="cm">/* propage level/edge trigger for external IRQ 16-&gt;31 */</span>
	<span class="n">sh7372_icr_to_irqcr</span><span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">ICR3A</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">irqcrx_low</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irqcry_low</span><span class="p">);</span>
	<span class="n">sh7372_icr_to_irqcr</span><span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">ICR4A</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">irqcrx_high</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irqcry_high</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">((</span><span class="n">irqcrx_high</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">irqcrx_low</span><span class="p">,</span> <span class="n">IRQCR3</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">((</span><span class="n">irqcry_high</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">irqcry_low</span><span class="p">,</span> <span class="n">IRQCR4</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh7372_enter_a3sm_common</span><span class="p">(</span><span class="kt">int</span> <span class="n">pllc0_on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sh7372_set_reset_vector</span><span class="p">(</span><span class="n">__pa</span><span class="p">(</span><span class="n">sh7372_resume_core_standby_sysc</span><span class="p">));</span>
	<span class="n">sh7372_enter_sysc</span><span class="p">(</span><span class="n">pllc0_on</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh7372_enter_a4s_common</span><span class="p">(</span><span class="kt">int</span> <span class="n">pllc0_on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sh7372_intca_suspend</span><span class="p">();</span>
	<span class="n">memcpy</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">SMFRAM</span><span class="p">,</span> <span class="n">sh7372_resume_core_standby_sysc</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
	<span class="n">sh7372_set_reset_vector</span><span class="p">(</span><span class="n">SMFRAM</span><span class="p">);</span>
	<span class="n">sh7372_enter_sysc</span><span class="p">(</span><span class="n">pllc0_on</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">sh7372_intca_resume</span><span class="p">();</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_CPU_IDLE</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh7372_cpuidle_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuidle_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpuidle_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">states</span><span class="p">[</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">state_count</span><span class="p">];</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">CPUIDLE_NAME_LEN</span><span class="p">,</span> <span class="s">&quot;C2&quot;</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="s">&quot;Core Standby Mode&quot;</span><span class="p">,</span> <span class="n">CPUIDLE_DESC_LEN</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">exit_latency</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">target_residency</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CPUIDLE_FLAG_TIME_VALID</span><span class="p">;</span>
	<span class="n">shmobile_cpuidle_modes</span><span class="p">[</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">state_count</span><span class="p">]</span> <span class="o">=</span> <span class="n">sh7372_enter_core_standby</span><span class="p">;</span>

	<span class="n">drv</span><span class="o">-&gt;</span><span class="n">state_count</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh7372_cpuidle_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">shmobile_cpuidle_setup</span> <span class="o">=</span> <span class="n">sh7372_cpuidle_setup</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh7372_cpuidle_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_SUSPEND</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh7372_enter_suspend</span><span class="p">(</span><span class="n">suspend_state_t</span> <span class="n">suspend_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">msk</span><span class="p">,</span> <span class="n">msk2</span><span class="p">;</span>

	<span class="cm">/* check active clocks to determine potential wakeup sources */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sh7372_sysc_valid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msk2</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* convert INTC mask and sense to SYSC mask and sense */</span>
		<span class="n">sh7372_setup_sysc</span><span class="p">(</span><span class="n">msk</span><span class="p">,</span> <span class="n">msk2</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">console_suspend_enabled</span> <span class="o">&amp;&amp;</span>
		    <span class="n">sh7372_a4s</span><span class="p">.</span><span class="n">genpd</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">GPD_STATE_POWER_OFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* enter A4S sleep with PLLC0 off */</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;entering A4S</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">sh7372_enter_a4s_common</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* enter A3SM sleep with PLLC0 off */</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;entering A3SM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">sh7372_enter_a3sm_common</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* default to Core Standby that supports all wakeup sources */</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;entering Core Standby</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">sh7372_enter_core_standby</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sh7372_pm_notifier_fn - SH7372 PM notifier routine.</span>
<span class="cm"> * @notifier: Unused.</span>
<span class="cm"> * @pm_event: Event being handled.</span>
<span class="cm"> * @unused: Unused.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh7372_pm_notifier_fn</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">notifier</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pm_event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pm_event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PM_SUSPEND_PREPARE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * This is necessary, because the A4R domain has to be &quot;on&quot;</span>
<span class="cm">		 * when suspend_device_irqs() and resume_device_irqs() are</span>
<span class="cm">		 * executed during system suspend and resume, respectively, so</span>
<span class="cm">		 * that those functions don&#39;t crash while accessing the INTCS.</span>
<span class="cm">		 */</span>
		<span class="n">pm_genpd_poweron</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh7372_a4r</span><span class="p">.</span><span class="n">genpd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM_POST_SUSPEND</span>:
		<span class="n">pm_genpd_poweroff_unused</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh7372_suspend_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">shmobile_suspend_ops</span><span class="p">.</span><span class="n">enter</span> <span class="o">=</span> <span class="n">sh7372_enter_suspend</span><span class="p">;</span>
	<span class="n">pm_notifier</span><span class="p">(</span><span class="n">sh7372_pm_notifier_fn</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh7372_suspend_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">sh7372_pm_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* enable DBG hardware block to kick SYSC */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0000a500</span><span class="p">,</span> <span class="n">DBGREG9</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0000a501</span><span class="p">,</span> <span class="n">DBGREG9</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">DBGREG1</span><span class="p">);</span>

	<span class="cm">/* do not convert A3SM, A3SP, A3SG, A4R power down into A4S */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">PDNSEL</span><span class="p">);</span>

	<span class="n">sh7372_suspend_init</span><span class="p">();</span>
	<span class="n">sh7372_cpuidle_init</span><span class="p">();</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
