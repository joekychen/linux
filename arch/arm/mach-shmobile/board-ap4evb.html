<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › mach-shmobile › board-ap4evb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>board-ap4evb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * AP4EVB board support</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2010  Magnus Damm</span>
<span class="cm"> * Copyright (C) 2008  Yoshihiro Shimoda</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; version 2 of the License.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/tmio.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/host.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/sh_mobile_sdhi.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/mtd.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/partitions.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/physmap.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/sh_mmcif.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/i2c/tsc2007.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/smsc911x.h&gt;</span>
<span class="cp">#include &lt;linux/sh_intc.h&gt;</span>
<span class="cp">#include &lt;linux/sh_clk.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/leds.h&gt;</span>
<span class="cp">#include &lt;linux/input/sh_keysc.h&gt;</span>
<span class="cp">#include &lt;linux/usb/r8a66597.h&gt;</span>
<span class="cp">#include &lt;linux/pm_clock.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>

<span class="cp">#include &lt;media/sh_mobile_ceu.h&gt;</span>
<span class="cp">#include &lt;media/sh_mobile_csi2.h&gt;</span>
<span class="cp">#include &lt;media/soc_camera.h&gt;</span>

<span class="cp">#include &lt;sound/sh_fsi.h&gt;</span>
<span class="cp">#include &lt;sound/simple_card.h&gt;</span>

<span class="cp">#include &lt;video/sh_mobile_hdmi.h&gt;</span>
<span class="cp">#include &lt;video/sh_mobile_lcdc.h&gt;</span>
<span class="cp">#include &lt;video/sh_mipi_dsi.h&gt;</span>

<span class="cp">#include &lt;mach/common.h&gt;</span>
<span class="cp">#include &lt;mach/irqs.h&gt;</span>
<span class="cp">#include &lt;mach/sh7372.h&gt;</span>

<span class="cp">#include &lt;asm/mach-types.h&gt;</span>
<span class="cp">#include &lt;asm/mach/arch.h&gt;</span>
<span class="cp">#include &lt;asm/setup.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * Address	Interface		BusWidth	note</span>
<span class="cm"> * ------------------------------------------------------------------</span>
<span class="cm"> * 0x0000_0000	NOR Flash ROM (MCP)	16bit		SW7 : bit1 = ON</span>
<span class="cm"> * 0x0800_0000	user area		-</span>
<span class="cm"> * 0x1000_0000	NOR Flash ROM (MCP)	16bit		SW7 : bit1 = OFF</span>
<span class="cm"> * 0x1400_0000	Ether (LAN9220)		16bit</span>
<span class="cm"> * 0x1600_0000	user area		-		cannot use with NAND</span>
<span class="cm"> * 0x1800_0000	user area		-</span>
<span class="cm"> * 0x1A00_0000	-</span>
<span class="cm"> * 0x4000_0000	LPDDR2-SDRAM (POP)	32bit</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * NOR Flash ROM</span>
<span class="cm"> *</span>
<span class="cm"> *  SW1  |     SW2    | SW7  | NOR Flash ROM</span>
<span class="cm"> *  bit1 | bit1  bit2 | bit1 | Memory allocation</span>
<span class="cm"> * ------+------------+------+------------------</span>
<span class="cm"> *  OFF  | ON     OFF | ON   |    Area 0</span>
<span class="cm"> *  OFF  | ON     OFF | OFF  |    Area 4</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * NAND Flash ROM</span>
<span class="cm"> *</span>
<span class="cm"> *  SW1  |     SW2    | SW7  | NAND Flash ROM</span>
<span class="cm"> *  bit1 | bit1  bit2 | bit2 | Memory allocation</span>
<span class="cm"> * ------+------------+------+------------------</span>
<span class="cm"> *  OFF  | ON     OFF | ON   |    FCE 0</span>
<span class="cm"> *  OFF  | ON     OFF | OFF  |    FCE 1</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * SMSC 9220</span>
<span class="cm"> *</span>
<span class="cm"> *  SW1		SMSC 9220</span>
<span class="cm"> * -----------------------</span>
<span class="cm"> *  ON		access disable</span>
<span class="cm"> *  OFF		access enable</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * LCD / IRQ / KEYSC / IrDA</span>
<span class="cm"> *</span>
<span class="cm"> * IRQ = IRQ26 (TS), IRQ27 (VIO), IRQ28 (QHD-TouchScreen)</span>
<span class="cm"> * LCD = 2nd LCDC (WVGA)</span>
<span class="cm"> *</span>
<span class="cm"> * 		|		SW43			|</span>
<span class="cm"> * SW3		|	ON		|	OFF	|</span>
<span class="cm"> * -------------+-----------------------+---------------+</span>
<span class="cm"> * ON		| KEY / IrDA		| LCD		|</span>
<span class="cm"> * OFF		| KEY / IrDA / IRQ	| IRQ		|</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * QHD / WVGA display</span>
<span class="cm"> *</span>
<span class="cm"> * You can choice display type on menuconfig.</span>
<span class="cm"> * Then, check above dip-switch.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * USB</span>
<span class="cm"> *</span>
<span class="cm"> * J7 : 1-2  MAX3355E VBUS</span>
<span class="cm"> *      2-3  DC 5.0V</span>
<span class="cm"> *</span>
<span class="cm"> * S39: bit2: off</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * FSI/FSMI</span>
<span class="cm"> *</span>
<span class="cm"> * SW41	:  ON : SH-Mobile AP4 Audio Mode</span>
<span class="cm"> *	: OFF : Bluetooth Audio Mode</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * MMC0/SDHI1 (CN7)</span>
<span class="cm"> *</span>
<span class="cm"> * J22 : select card voltage</span>
<span class="cm"> *       1-2 pin : 1.8v</span>
<span class="cm"> *       2-3 pin : 3.3v</span>
<span class="cm"> *</span>
<span class="cm"> *        SW1  |             SW33</span>
<span class="cm"> *             | bit1 | bit2 | bit3 | bit4</span>
<span class="cm"> * ------------+------+------+------+-------</span>
<span class="cm"> * MMC0   OFF  |  OFF |  ON  |  ON  |  X</span>
<span class="cm"> * SDHI1  OFF  |  ON  |   X  |  OFF | ON</span>
<span class="cm"> *</span>
<span class="cm"> * voltage lebel</span>
<span class="cm"> * CN7 : 1.8v</span>
<span class="cm"> * CN12: 3.3v</span>
<span class="cm"> */</span>

<span class="cm">/* MTD */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mtd_partition</span> <span class="n">nor_flash_partitions</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;loader&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mh">0x00000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">512</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask_flags</span>	<span class="o">=</span> <span class="n">MTD_WRITEABLE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;bootenv&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="n">MTDPART_OFS_APPEND</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">512</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask_flags</span>	<span class="o">=</span> <span class="n">MTD_WRITEABLE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;kernel_ro&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="n">MTDPART_OFS_APPEND</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask_flags</span>	<span class="o">=</span> <span class="n">MTD_WRITEABLE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;kernel&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="n">MTDPART_OFS_APPEND</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;data&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="n">MTDPART_OFS_APPEND</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="n">MTDPART_SIZ_FULL</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">physmap_flash_data</span> <span class="n">nor_flash_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">width</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">parts</span>		<span class="o">=</span> <span class="n">nor_flash_partitions</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nr_parts</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">nor_flash_partitions</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">nor_flash_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="mh">0x20000000</span><span class="p">,</span> <span class="cm">/* CS0 shadow instead of regular CS0 */</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="mh">0x28000000</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="cm">/* needed by USB MASK ROM boot */</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">nor_flash_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;physmap-flash&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">nor_flash_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">nor_flash_resources</span><span class="p">),</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">nor_flash_resources</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* SMSC 9220 */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">smc911x_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="mh">0x14000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="mh">0x16000000</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">evt2irq</span><span class="p">(</span><span class="mh">0x02c0</span><span class="p">)</span> <span class="cm">/* IRQ6A */</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span> <span class="o">|</span> <span class="n">IORESOURCE_IRQ_LOWLEVEL</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">smsc911x_platform_config</span> <span class="n">smsc911x_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">SMSC911X_USE_16BIT</span> <span class="o">|</span> <span class="n">SMSC911X_SAVE_MAC_ADDRESS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_polarity</span>   <span class="o">=</span> <span class="n">SMSC911X_IRQ_POLARITY_ACTIVE_LOW</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_type</span>       <span class="o">=</span> <span class="n">SMSC911X_IRQ_TYPE_PUSH_PULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">smc911x_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>           <span class="o">=</span> <span class="s">&quot;smsc911x&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>             <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>  <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">smc911x_resources</span><span class="p">),</span>
	<span class="p">.</span><span class="n">resource</span>       <span class="o">=</span> <span class="n">smc911x_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>            <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">smsc911x_info</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * The card detect pin of the top SD/MMC slot (CN7) is active low and is</span>
<span class="cm"> * connected to GPIO A22 of SH7372 (GPIO_PORT41).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">slot_cn7_get_cd</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">gpio_get_value</span><span class="p">(</span><span class="n">GPIO_PORT41</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/* MERAM */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sh_mobile_meram_info</span> <span class="n">meram_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">addr_mode</span>      <span class="o">=</span> <span class="n">SH_MOBILE_MERAM_MODE1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">meram_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;regs&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="mh">0xe8000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="mh">0xe807ffff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;meram&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="mh">0xe8080000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="mh">0xe81fffff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">meram_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>           <span class="o">=</span> <span class="s">&quot;sh_mobile_meram&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>             <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>  <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">meram_resources</span><span class="p">),</span>
	<span class="p">.</span><span class="n">resource</span>       <span class="o">=</span> <span class="n">meram_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>            <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">meram_info</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* SH_MMCIF */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">sh_mmcif_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;MMCIF&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="mh">0xE6BD0000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="mh">0xE6BD00FF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* MMC ERR */</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">evt2irq</span><span class="p">(</span><span class="mh">0x1ac0</span><span class="p">),</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* MMC NOR */</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">evt2irq</span><span class="p">(</span><span class="mh">0x1ae0</span><span class="p">),</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sh_mmcif_plat_data</span> <span class="n">sh_mmcif_plat</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">sup_pclk</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ocr</span>		<span class="o">=</span> <span class="n">MMC_VDD_165_195</span> <span class="o">|</span> <span class="n">MMC_VDD_32_33</span> <span class="o">|</span> <span class="n">MMC_VDD_33_34</span><span class="p">,</span>
	<span class="p">.</span><span class="n">caps</span>		<span class="o">=</span> <span class="n">MMC_CAP_4_BIT_DATA</span> <span class="o">|</span>
			  <span class="n">MMC_CAP_8_BIT_DATA</span> <span class="o">|</span>
			  <span class="n">MMC_CAP_NEEDS_POLL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_cd</span>		<span class="o">=</span> <span class="n">slot_cn7_get_cd</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_id_tx</span>	<span class="o">=</span> <span class="n">SHDMA_SLAVE_MMCIF_TX</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_id_rx</span>	<span class="o">=</span> <span class="n">SHDMA_SLAVE_MMCIF_RX</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">sh_mmcif_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;sh_mmcif&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dma_mask</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">coherent_dma_mask</span>	<span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">platform_data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">sh_mmcif_plat</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sh_mmcif_resources</span><span class="p">),</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">sh_mmcif_resources</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* SDHI0 */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sh_mobile_sdhi_info</span> <span class="n">sdhi0_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dma_slave_tx</span>	<span class="o">=</span> <span class="n">SHDMA_SLAVE_SDHI0_TX</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_slave_rx</span>	<span class="o">=</span> <span class="n">SHDMA_SLAVE_SDHI0_RX</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tmio_caps</span>	<span class="o">=</span> <span class="n">MMC_CAP_SDIO_IRQ</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">sdhi0_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;SDHI0&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span>  <span class="o">=</span> <span class="mh">0xe6850000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>    <span class="o">=</span> <span class="mh">0xe68500ff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>  <span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">evt2irq</span><span class="p">(</span><span class="mh">0x0e00</span><span class="p">)</span> <span class="cm">/* SDHI0_SDHI0I0 */</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">evt2irq</span><span class="p">(</span><span class="mh">0x0e20</span><span class="p">)</span> <span class="cm">/* SDHI0_SDHI0I1 */</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">evt2irq</span><span class="p">(</span><span class="mh">0x0e40</span><span class="p">)</span> <span class="cm">/* SDHI0_SDHI0I2 */</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">sdhi0_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>           <span class="o">=</span> <span class="s">&quot;sh_mobile_sdhi&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>  <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sdhi0_resources</span><span class="p">),</span>
	<span class="p">.</span><span class="n">resource</span>       <span class="o">=</span> <span class="n">sdhi0_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>             <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">sdhi0_info</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* SDHI1 */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sh_mobile_sdhi_info</span> <span class="n">sdhi1_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dma_slave_tx</span>	<span class="o">=</span> <span class="n">SHDMA_SLAVE_SDHI1_TX</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_slave_rx</span>	<span class="o">=</span> <span class="n">SHDMA_SLAVE_SDHI1_RX</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tmio_ocr_mask</span>	<span class="o">=</span> <span class="n">MMC_VDD_165_195</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tmio_flags</span>	<span class="o">=</span> <span class="n">TMIO_MMC_WRPROTECT_DISABLE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tmio_caps</span>	<span class="o">=</span> <span class="n">MMC_CAP_NEEDS_POLL</span> <span class="o">|</span> <span class="n">MMC_CAP_SDIO_IRQ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_cd</span>		<span class="o">=</span> <span class="n">slot_cn7_get_cd</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">sdhi1_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;SDHI1&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span>  <span class="o">=</span> <span class="mh">0xe6860000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>    <span class="o">=</span> <span class="mh">0xe68600ff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>  <span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">evt2irq</span><span class="p">(</span><span class="mh">0x0e80</span><span class="p">),</span> <span class="cm">/* SDHI1_SDHI1I0 */</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">evt2irq</span><span class="p">(</span><span class="mh">0x0ea0</span><span class="p">),</span> <span class="cm">/* SDHI1_SDHI1I1 */</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">evt2irq</span><span class="p">(</span><span class="mh">0x0ec0</span><span class="p">),</span> <span class="cm">/* SDHI1_SDHI1I2 */</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">sdhi1_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>           <span class="o">=</span> <span class="s">&quot;sh_mobile_sdhi&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>  <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sdhi1_resources</span><span class="p">),</span>
	<span class="p">.</span><span class="n">resource</span>       <span class="o">=</span> <span class="n">sdhi1_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>             <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">sdhi1_info</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* USB1 */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">usb1_host_port_power</span><span class="p">(</span><span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">power</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">power</span><span class="p">)</span> <span class="cm">/* only power-on supported for now */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* set VBOUT/PWEN and EXTLP1 in DVSTCTR */</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="n">__raw_readw</span><span class="p">(</span><span class="mh">0xE68B0008</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x600</span><span class="p">,</span> <span class="mh">0xE68B0008</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">r8a66597_platdata</span> <span class="n">usb1_host_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">on_chip</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">port_power</span>	<span class="o">=</span> <span class="n">usb1_host_port_power</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">usb1_host_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;USBHS&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="mh">0xE68B0000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="mh">0xE68B00E6</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">evt2irq</span><span class="p">(</span><span class="mh">0x1ce0</span><span class="p">)</span> <span class="cm">/* USB1_USB1I0 */</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">usb1_host_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;r8a66597_hcd&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dma_mask</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>         <span class="cm">/*  not use dma */</span>
		<span class="p">.</span><span class="n">coherent_dma_mask</span>	<span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">platform_data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">usb1_host_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">usb1_host_resources</span><span class="p">),</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">usb1_host_resources</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * QHD display</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_AP4EVB_QHD</span>

<span class="cm">/* KEYSC (Needs SW43 set to ON) */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sh_keysc_info</span> <span class="n">keysc_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="n">SH_KEYSC_MODE_1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">scan_timing</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">delay</span>		<span class="o">=</span> <span class="mi">2500</span><span class="p">,</span>
	<span class="p">.</span><span class="n">keycodes</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">KEY_0</span><span class="p">,</span> <span class="n">KEY_1</span><span class="p">,</span> <span class="n">KEY_2</span><span class="p">,</span> <span class="n">KEY_3</span><span class="p">,</span> <span class="n">KEY_4</span><span class="p">,</span>
		<span class="n">KEY_5</span><span class="p">,</span> <span class="n">KEY_6</span><span class="p">,</span> <span class="n">KEY_7</span><span class="p">,</span> <span class="n">KEY_8</span><span class="p">,</span> <span class="n">KEY_9</span><span class="p">,</span>
		<span class="n">KEY_A</span><span class="p">,</span> <span class="n">KEY_B</span><span class="p">,</span> <span class="n">KEY_C</span><span class="p">,</span> <span class="n">KEY_D</span><span class="p">,</span> <span class="n">KEY_E</span><span class="p">,</span>
		<span class="n">KEY_F</span><span class="p">,</span> <span class="n">KEY_G</span><span class="p">,</span> <span class="n">KEY_H</span><span class="p">,</span> <span class="n">KEY_I</span><span class="p">,</span> <span class="n">KEY_J</span><span class="p">,</span>
		<span class="n">KEY_K</span><span class="p">,</span> <span class="n">KEY_L</span><span class="p">,</span> <span class="n">KEY_M</span><span class="p">,</span> <span class="n">KEY_N</span><span class="p">,</span> <span class="n">KEY_O</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">keysc_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;KEYSC&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span>  <span class="o">=</span> <span class="mh">0xe61b0000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>    <span class="o">=</span> <span class="mh">0xe61b0063</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>  <span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>  <span class="o">=</span> <span class="n">evt2irq</span><span class="p">(</span><span class="mh">0x0be0</span><span class="p">),</span> <span class="cm">/* KEYSC_KEY */</span>
		<span class="p">.</span><span class="n">flags</span>  <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">keysc_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>           <span class="o">=</span> <span class="s">&quot;sh_keysc&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>             <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="cm">/* &quot;keysc0&quot; clock */</span>
	<span class="p">.</span><span class="n">num_resources</span>  <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">keysc_resources</span><span class="p">),</span>
	<span class="p">.</span><span class="n">resource</span>       <span class="o">=</span> <span class="n">keysc_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">keysc_info</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* MIPI-DSI */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_mipi_set_dot_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				 <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">pck</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dsip_clk&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pck</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">pck</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * DSIPCLK	= 24MHz</span>
<span class="cm">		 * D-PHY	= DSIPCLK * ((0x6*2)+1) = 312MHz (see .phyctrl)</span>
<span class="cm">		 * HsByteCLK	= D-PHY/8 = 39MHz</span>
<span class="cm">		 *</span>
<span class="cm">		 *  X * Y * FPS =</span>
<span class="cm">		 * (544+72+600+16) * (961+8+8+2) * 30 = 36.1MHz</span>
<span class="cm">		 */</span>
		<span class="n">clk_set_rate</span><span class="p">(</span><span class="n">pck</span><span class="p">,</span> <span class="n">clk_round_rate</span><span class="p">(</span><span class="n">pck</span><span class="p">,</span> <span class="mi">24000000</span><span class="p">));</span>
		<span class="n">clk_enable</span><span class="p">(</span><span class="n">pck</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">clk_disable</span><span class="p">(</span><span class="n">pck</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">clk_put</span><span class="p">(</span><span class="n">pck</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">mipidsi0_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>  <span class="o">=</span> <span class="mh">0xffc60000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>    <span class="o">=</span> <span class="mh">0xffc63073</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>  <span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>  <span class="o">=</span> <span class="mh">0xffc68000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>    <span class="o">=</span> <span class="mh">0xffc680ef</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>  <span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sh_mobile_lcdc_info</span> <span class="n">lcdc_info</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sh_mipi_dsi_info</span> <span class="n">mipidsi0_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">data_format</span>	<span class="o">=</span> <span class="n">MIPI_RGB888</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lcd_chan</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">lcdc_info</span><span class="p">.</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	<span class="p">.</span><span class="n">lane</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vsynw_offset</span>	<span class="o">=</span> <span class="mi">17</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phyctrl</span>	<span class="o">=</span> <span class="mh">0x6</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">SH_MIPI_DSI_SYNC_PULSES_MODE</span> <span class="o">|</span>
			  <span class="n">SH_MIPI_DSI_HSbyteCLK</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_dot_clock</span>	<span class="o">=</span> <span class="n">sh_mipi_set_dot_clock</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">mipidsi0_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>           <span class="o">=</span> <span class="s">&quot;sh-mipi-dsi&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>  <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mipidsi0_resources</span><span class="p">),</span>
	<span class="p">.</span><span class="n">resource</span>       <span class="o">=</span> <span class="n">mipidsi0_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>             <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">mipidsi0_info</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">qhd_devices</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">mipidsi0_device</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">keysc_device</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_AP4EVB_QHD */</span><span class="cp"></span>

<span class="cm">/* LCDC0 */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_videomode</span> <span class="n">ap4evb_lcdc_modes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
<span class="cp">#ifdef CONFIG_AP4EVB_QHD</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;R63302(QHD)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xres</span>		<span class="o">=</span> <span class="mi">544</span><span class="p">,</span>
		<span class="p">.</span><span class="n">yres</span>		<span class="o">=</span> <span class="mi">961</span><span class="p">,</span>
		<span class="p">.</span><span class="n">left_margin</span>	<span class="o">=</span> <span class="mi">72</span><span class="p">,</span>
		<span class="p">.</span><span class="n">right_margin</span>	<span class="o">=</span> <span class="mi">600</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hsync_len</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">upper_margin</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">lower_margin</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sync</span>		<span class="o">=</span> <span class="n">FB_SYNC_VERT_HIGH_ACT</span> <span class="o">|</span> <span class="n">FB_SYNC_HOR_HIGH_ACT</span><span class="p">,</span>
<span class="cp">#else</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;WVGA Panel&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xres</span>		<span class="o">=</span> <span class="mi">800</span><span class="p">,</span>
		<span class="p">.</span><span class="n">yres</span>		<span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
		<span class="p">.</span><span class="n">left_margin</span>	<span class="o">=</span> <span class="mi">220</span><span class="p">,</span>
		<span class="p">.</span><span class="n">right_margin</span>	<span class="o">=</span> <span class="mi">110</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hsync_len</span>	<span class="o">=</span> <span class="mi">70</span><span class="p">,</span>
		<span class="p">.</span><span class="n">upper_margin</span>	<span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
		<span class="p">.</span><span class="n">lower_margin</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sync</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sh_mobile_meram_cfg</span> <span class="n">lcd_meram_cfg</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">icb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">meram_size</span>     <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">icb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">meram_size</span>     <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sh_mobile_lcdc_info</span> <span class="n">lcdc_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">meram_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">meram_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">chan</span> <span class="o">=</span> <span class="n">LCDC_CHAN_MAINLCD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_RGB565</span><span class="p">,</span>
		<span class="p">.</span><span class="n">lcd_modes</span> <span class="o">=</span> <span class="n">ap4evb_lcdc_modes</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_modes</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ap4evb_lcdc_modes</span><span class="p">),</span>
		<span class="p">.</span><span class="n">meram_cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lcd_meram_cfg</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_AP4EVB_QHD</span>
		<span class="p">.</span><span class="n">tx_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mipidsi0_device</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">lcdc_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;LCDC&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="mh">0xfe940000</span><span class="p">,</span> <span class="cm">/* P4-only space */</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="mh">0xfe943fff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">intcs_evt2irq</span><span class="p">(</span><span class="mh">0x580</span><span class="p">),</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">lcdc_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;sh_mobile_lcdc_fb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">lcdc_resources</span><span class="p">),</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">lcdc_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">lcdc_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">coherent_dma_mask</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* FSI */</span>
<span class="cp">#define IRQ_FSI		evt2irq(0x1840)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__fsi_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">,</span> <span class="kt">long</span> <span class="n">rate</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">clk_set_rate</span><span class="p">(</span><span class="n">clk</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">clk_enable</span><span class="p">(</span><span class="n">clk</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">clk_disable</span><span class="p">(</span><span class="n">clk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__fsi_set_round_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">,</span> <span class="kt">long</span> <span class="n">rate</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__fsi_set_rate</span><span class="p">(</span><span class="n">clk</span><span class="p">,</span> <span class="n">clk_round_rate</span><span class="p">(</span><span class="n">clk</span><span class="p">,</span> <span class="n">rate</span><span class="p">),</span> <span class="n">enable</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_ak4642_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">fsia_ick</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">fsiack</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">fsia_ick</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;icka&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fsia_ick</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">fsia_ick</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * FSIACK is connected to AK4642,</span>
<span class="cm">	 * and use external clock pin from it.</span>
<span class="cm">	 * it is parent of fsia_ick now.</span>
<span class="cm">	 */</span>
	<span class="n">fsiack</span> <span class="o">=</span> <span class="n">clk_get_parent</span><span class="p">(</span><span class="n">fsia_ick</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fsiack</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fsia_ick_out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * we get 1/1 divided clock by setting same rate to fsiack and fsia_ick</span>
<span class="cm">	 *</span>
<span class="cm">	 ** FIXME **</span>
<span class="cm">	 * Because the freq_table of external clk (fsiack) are all 0,</span>
<span class="cm">	 * the return value of clk_round_rate became 0.</span>
<span class="cm">	 * So, it use __fsi_set_rate here.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__fsi_set_rate</span><span class="p">(</span><span class="n">fsiack</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fsiack_out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__fsi_set_round_rate</span><span class="p">(</span><span class="n">fsia_ick</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">enable</span><span class="p">)</span>
		<span class="n">__fsi_set_round_rate</span><span class="p">(</span><span class="n">fsiack</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* disable FSI ACK */</span>

<span class="nl">fsiack_out:</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">fsiack</span><span class="p">);</span>

<span class="nl">fsia_ick_out:</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">fsia_ick</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsi_hdmi_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">fsib_clk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">fdiv_clk</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh7372_fsidivb_clk</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">fsib_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">fdiv_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ackmd_bpfmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">44100</span>:
		<span class="n">fsib_rate</span>	<span class="o">=</span> <span class="n">rate</span> <span class="o">*</span> <span class="mi">256</span><span class="p">;</span>
		<span class="n">ackmd_bpfmd</span>	<span class="o">=</span> <span class="n">SH_FSI_ACKMD_256</span> <span class="o">|</span> <span class="n">SH_FSI_BPFMD_64</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">48000</span>:
		<span class="n">fsib_rate</span>	<span class="o">=</span> <span class="mi">85428000</span><span class="p">;</span> <span class="cm">/* around 48kHz x 256 x 7 */</span>
		<span class="n">fdiv_rate</span>	<span class="o">=</span> <span class="n">rate</span> <span class="o">*</span> <span class="mi">256</span><span class="p">;</span>
		<span class="n">ackmd_bpfmd</span>	<span class="o">=</span> <span class="n">SH_FSI_ACKMD_256</span> <span class="o">|</span> <span class="n">SH_FSI_BPFMD_64</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;unsupported rate in FSI2 port B</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* FSI B setting */</span>
	<span class="n">fsib_clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ickb&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fsib_clk</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__fsi_set_round_rate</span><span class="p">(</span><span class="n">fsib_clk</span><span class="p">,</span> <span class="n">fsib_rate</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fsi_set_rate_end</span><span class="p">;</span>

	<span class="cm">/* FSI DIV setting */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__fsi_set_round_rate</span><span class="p">(</span><span class="n">fdiv_clk</span><span class="p">,</span> <span class="n">fdiv_rate</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* disable FSI B */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
			<span class="n">__fsi_set_round_rate</span><span class="p">(</span><span class="n">fsib_clk</span><span class="p">,</span> <span class="n">fsib_rate</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fsi_set_rate_end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ackmd_bpfmd</span><span class="p">;</span>

<span class="nl">fsi_set_rate_end:</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">fsib_clk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sh_fsi_platform_info</span> <span class="n">fsi_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">port_a</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">SH_FSI_BRS_INV</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_rate</span>	<span class="o">=</span> <span class="n">fsi_ak4642_set_rate</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">port_b</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">SH_FSI_BRS_INV</span> <span class="o">|</span>
				  <span class="n">SH_FSI_BRM_INV</span> <span class="o">|</span>
				  <span class="n">SH_FSI_LRS_INV</span> <span class="o">|</span>
				  <span class="n">SH_FSI_FMT_SPDIF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_rate</span>	<span class="o">=</span> <span class="n">fsi_hdmi_set_rate</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">fsi_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;FSI&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="mh">0xFE3C0000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="mh">0xFE3C0400</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>  <span class="o">=</span> <span class="n">IRQ_FSI</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>  <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">fsi_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;sh_fsi2&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">fsi_resources</span><span class="p">),</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">fsi_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">fsi_info</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">asoc_simple_dai_init_info</span> <span class="n">fsi2_ak4643_init_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">fmt</span>		<span class="o">=</span> <span class="n">SND_SOC_DAIFMT_LEFT_J</span><span class="p">,</span>
	<span class="p">.</span><span class="n">codec_daifmt</span>	<span class="o">=</span> <span class="n">SND_SOC_DAIFMT_CBM_CFM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cpu_daifmt</span>	<span class="o">=</span> <span class="n">SND_SOC_DAIFMT_CBS_CFS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sysclk</span>		<span class="o">=</span> <span class="mi">11289600</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">asoc_simple_card_info</span> <span class="n">fsi2_ak4643_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;AK4643&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">card</span>		<span class="o">=</span> <span class="s">&quot;FSI2A-AK4643&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cpu_dai</span>	<span class="o">=</span> <span class="s">&quot;fsia-dai&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">codec</span>		<span class="o">=</span> <span class="s">&quot;ak4642-codec.0-0013&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">platform</span>	<span class="o">=</span> <span class="s">&quot;sh_fsi2&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">codec_dai</span>	<span class="o">=</span> <span class="s">&quot;ak4642-hifi&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">fsi2_ak4643_init_info</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">fsi_ak4643_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;asoc-simple-card&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">fsi2_ak4643_info</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* LCDC1 */</span>
<span class="k">static</span> <span class="kt">long</span> <span class="n">ap4evb_clk_optimize</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">target</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">best_freq</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">parent_freq</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sh_mobile_hdmi_info</span> <span class="n">hdmi_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">HDMI_SND_SRC_SPDIF</span><span class="p">,</span>
	<span class="p">.</span><span class="n">clk_optimize_parent</span> <span class="o">=</span> <span class="n">ap4evb_clk_optimize</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">hdmi_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;HDMI&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="mh">0xe6be0000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="mh">0xe6be00ff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* There&#39;s also an HDMI interrupt on INTCS @ 0x18e0 */</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">evt2irq</span><span class="p">(</span><span class="mh">0x17e0</span><span class="p">),</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">hdmi_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;sh-mobile-hdmi&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hdmi_resources</span><span class="p">),</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">hdmi_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>             <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">hdmi_info</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">ap4evb_clk_optimize</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">target</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">best_freq</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">parent_freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">hdmi_ick</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi_device</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ick&quot;</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">hdmi_ick</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">hdmi_ick</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Cannot get HDMI ICK: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">clk_round_parent</span><span class="p">(</span><span class="n">hdmi_ick</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">best_freq</span><span class="p">,</span> <span class="n">parent_freq</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>

	<span class="n">clk_put</span><span class="p">(</span><span class="n">hdmi_ick</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sh_mobile_meram_cfg</span> <span class="n">hdmi_meram_cfg</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">icb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">meram_size</span>     <span class="o">=</span> <span class="mh">0x100</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">icb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">meram_size</span>     <span class="o">=</span> <span class="mh">0x100</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sh_mobile_lcdc_info</span> <span class="n">sh_mobile_lcdc1_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">clock_source</span> <span class="o">=</span> <span class="n">LCDC_CLK_EXTERNAL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">meram_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">meram_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">chan</span> <span class="o">=</span> <span class="n">LCDC_CHAN_MAINLCD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_RGB565</span><span class="p">,</span>
		<span class="p">.</span><span class="n">interface_type</span> <span class="o">=</span> <span class="n">RGB24</span><span class="p">,</span>
		<span class="p">.</span><span class="n">clock_divider</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">LCDC_FLAGS_DWPOL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">meram_cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdmi_meram_cfg</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tx_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdmi_device</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">lcdc1_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;LCDC1&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="mh">0xfe944000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="mh">0xfe947fff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">intcs_evt2irq</span><span class="p">(</span><span class="mh">0x1780</span><span class="p">),</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">lcdc1_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;sh_mobile_lcdc_fb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">lcdc1_resources</span><span class="p">),</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">lcdc1_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>             <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">sh_mobile_lcdc1_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">coherent_dma_mask</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">asoc_simple_dai_init_info</span> <span class="n">fsi2_hdmi_init_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">cpu_daifmt</span>	<span class="o">=</span> <span class="n">SND_SOC_DAIFMT_CBM_CFM</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">asoc_simple_card_info</span> <span class="n">fsi2_hdmi_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;HDMI&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">card</span>		<span class="o">=</span> <span class="s">&quot;FSI2B-HDMI&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cpu_dai</span>	<span class="o">=</span> <span class="s">&quot;fsib-dai&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">codec</span>		<span class="o">=</span> <span class="s">&quot;sh-mobile-hdmi&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">platform</span>	<span class="o">=</span> <span class="s">&quot;sh_fsi2&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">codec_dai</span>	<span class="o">=</span> <span class="s">&quot;sh_mobile_hdmi-hifi&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">fsi2_hdmi_init_info</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">fsi_hdmi_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;asoc-simple-card&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">fsi2_hdmi_info</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio_led</span> <span class="n">ap4evb_leds</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;led4&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span>			<span class="o">=</span> <span class="n">GPIO_PORT185</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_state</span>	<span class="o">=</span> <span class="n">LEDS_GPIO_DEFSTATE_ON</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;led2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span>			<span class="o">=</span> <span class="n">GPIO_PORT186</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_state</span>	<span class="o">=</span> <span class="n">LEDS_GPIO_DEFSTATE_ON</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;led3&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span>			<span class="o">=</span> <span class="n">GPIO_PORT187</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_state</span>	<span class="o">=</span> <span class="n">LEDS_GPIO_DEFSTATE_ON</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;led1&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span>			<span class="o">=</span> <span class="n">GPIO_PORT188</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_state</span>	<span class="o">=</span> <span class="n">LEDS_GPIO_DEFSTATE_ON</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio_led_platform_data</span> <span class="n">ap4evb_leds_pdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">num_leds</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ap4evb_leds</span><span class="p">),</span>
	<span class="p">.</span><span class="n">leds</span> <span class="o">=</span> <span class="n">ap4evb_leds</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">leds_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;leds-gpio&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap4evb_leds_pdata</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">imx074_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;imx074&quot;</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">soc_camera_link</span> <span class="n">imx074_link</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bus_id</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">board_info</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">imx074_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">i2c_adapter_id</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">module_name</span>	<span class="o">=</span> <span class="s">&quot;imx074&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">ap4evb_camera</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>   <span class="o">=</span> <span class="s">&quot;soc-camera-pdrv&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>    <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">imx074_link</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sh_csi2_client_config</span> <span class="n">csi2_clients</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">phy</span>		<span class="o">=</span> <span class="n">SH_CSI2_PHY_MAIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">lanes</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>		<span class="cm">/* default: 2 lanes */</span>
		<span class="p">.</span><span class="n">channel</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pdev</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ap4evb_camera</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sh_csi2_pdata</span> <span class="n">csi2_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">SH_CSI2C</span><span class="p">,</span>
	<span class="p">.</span><span class="n">clients</span>	<span class="o">=</span> <span class="n">csi2_clients</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_clients</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">csi2_clients</span><span class="p">),</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">SH_CSI2_ECC</span> <span class="o">|</span> <span class="n">SH_CSI2_CRC</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">csi2_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;CSI2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="mh">0xffc90000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="mh">0xffc90fff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">intcs_evt2irq</span><span class="p">(</span><span class="mh">0x17a0</span><span class="p">),</span>
		<span class="p">.</span><span class="n">flags</span>  <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sh_mobile_ceu_companion</span> <span class="n">csi2</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">csi2_resources</span><span class="p">),</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">csi2_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">csi2_info</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sh_mobile_ceu_info</span> <span class="n">sh_mobile_ceu_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SH_CEU_FLAG_USE_8BIT_BUS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_width</span> <span class="o">=</span> <span class="mi">8188</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_height</span> <span class="o">=</span> <span class="mi">8188</span><span class="p">,</span>
	<span class="p">.</span><span class="n">csi2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">csi2</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">ceu_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;CEU&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="mh">0xfe910000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="mh">0xfe91009f</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">intcs_evt2irq</span><span class="p">(</span><span class="mh">0x880</span><span class="p">),</span>
		<span class="p">.</span><span class="n">flags</span>  <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* place holder for contiguous memory */</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">ceu_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;sh_mobile_ceu&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>             <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="cm">/* &quot;ceu0&quot; clock */</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ceu_resources</span><span class="p">),</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">ceu_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">sh_mobile_ceu_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">coherent_dma_mask</span>	<span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">ap4evb_devices</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">leds_device</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">nor_flash_device</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">smc911x_device</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sdhi0_device</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sdhi1_device</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">usb1_host_device</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">fsi_device</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">fsi_ak4643_device</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">fsi_hdmi_device</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sh_mmcif_device</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">hdmi_device</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">lcdc_device</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">lcdc1_device</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">ceu_device</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">ap4evb_camera</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">meram_device</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">hdmi_init_pm_clock</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">hdmi_ick</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdmi_device</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ick&quot;</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">rate</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">hdmi_ick</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">hdmi_ick</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Cannot get HDMI ICK: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">clk_set_parent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh7372_pllc2_clk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh7372_dv_clki_div2_clk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Cannot set PLLC2 parent: %d, %d users</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">sh7372_pllc2_clk</span><span class="p">.</span><span class="n">usecount</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;PLLC2 initial frequency %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh7372_pllc2_clk</span><span class="p">));</span>

	<span class="n">rate</span> <span class="o">=</span> <span class="n">clk_round_rate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh7372_pllc2_clk</span><span class="p">,</span> <span class="mi">594000000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Cannot get suitable rate: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">clk_set_rate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh7372_pllc2_clk</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Cannot set rate %ld: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;PLLC2 set frequency %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">clk_set_parent</span><span class="p">(</span><span class="n">hdmi_ick</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh7372_pllc2_clk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Cannot set HDMI parent: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">hdmi_ick</span><span class="p">))</span>
		<span class="n">clk_put</span><span class="p">(</span><span class="n">hdmi_ick</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">fsi_init_pm_clock</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">fsia_ick</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">fsia_ick</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fsi_device</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;icka&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fsia_ick</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">fsia_ick</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Cannot get FSI ICK: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">clk_set_parent</span><span class="p">(</span><span class="n">fsia_ick</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh7372_fsiack_clk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Cannot set FSI-A parent: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">clk_put</span><span class="p">(</span><span class="n">fsia_ick</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FIXME !!</span>
<span class="cm"> *</span>
<span class="cm"> * gpio_no_direction</span>
<span class="cm"> * are quick_hack.</span>
<span class="cm"> *</span>
<span class="cm"> * current gpio frame work doesn&#39;t have</span>
<span class="cm"> * the method to control only pull up/down/free.</span>
<span class="cm"> * this function should be replaced by correct gpio function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">gpio_no_direction</span><span class="p">(</span><span class="n">u32</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__raw_writeb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* TouchScreen */</span>
<span class="cp">#ifdef CONFIG_AP4EVB_QHD</span>
<span class="cp"># define GPIO_TSC_IRQ	GPIO_FN_IRQ28_123</span>
<span class="cp"># define GPIO_TSC_PORT	GPIO_PORT123</span>
<span class="cp">#else </span><span class="cm">/* WVGA */</span><span class="cp"></span>
<span class="cp"># define GPIO_TSC_IRQ	GPIO_FN_IRQ7_40</span>
<span class="cp"># define GPIO_TSC_PORT	GPIO_PORT40</span>
<span class="cp">#endif</span>

<span class="cp">#define IRQ28	evt2irq(0x3380) </span><span class="cm">/* IRQ28A */</span><span class="cp"></span>
<span class="cp">#define IRQ7	evt2irq(0x02e0) </span><span class="cm">/* IRQ7A */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ts_get_pendown_state</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">gpio_free</span><span class="p">(</span><span class="n">GPIO_TSC_IRQ</span><span class="p">);</span>

	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_TSC_PORT</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">gpio_direction_input</span><span class="p">(</span><span class="n">GPIO_TSC_PORT</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">gpio_get_value</span><span class="p">(</span><span class="n">GPIO_TSC_PORT</span><span class="p">);</span>

	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_TSC_IRQ</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">!</span><span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ts_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_TSC_IRQ</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tsc2007_platform_data</span> <span class="n">tsc2007_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">model</span>			<span class="o">=</span> <span class="mi">2007</span><span class="p">,</span>
	<span class="p">.</span><span class="n">x_plate_ohms</span>		<span class="o">=</span> <span class="mi">180</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_pendown_state</span>	<span class="o">=</span> <span class="n">ts_get_pendown_state</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_platform_hw</span>	<span class="o">=</span> <span class="n">ts_init</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">tsc_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;tsc2007&quot;</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">),</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="s">&quot;tsc2007&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">tsc2007_info</span><span class="p">,</span>
	<span class="cm">/*.irq is selected on ap4evb_init */</span>
<span class="p">};</span>

<span class="cm">/* I2C */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">i2c0_devices</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;ak4643&quot;</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">),</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">i2c1_devices</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;r2025sd&quot;</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">),</span>
	<span class="p">},</span>
<span class="p">};</span>


<span class="cp">#define GPIO_PORT9CR	0xE6051009</span>
<span class="cp">#define GPIO_PORT10CR	0xE605100A</span>
<span class="cp">#define USCCR1		0xE6058144</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">ap4evb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">srcr4</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">;</span>

	<span class="cm">/* External clock source */</span>
	<span class="n">clk_set_rate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh7372_dv_clki_clk</span><span class="p">,</span> <span class="mi">27000000</span><span class="p">);</span>

	<span class="n">sh7372_pinmux_init</span><span class="p">();</span>

	<span class="cm">/* enable SCIFA0 */</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_SCIFA0_TXD</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_SCIFA0_RXD</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* enable SMSC911X */</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_CS5A</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_IRQ6_39</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* enable Debug switch (S6) */</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_PORT32</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_PORT33</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_PORT34</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_PORT35</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_direction_input</span><span class="p">(</span><span class="n">GPIO_PORT32</span><span class="p">);</span>
	<span class="n">gpio_direction_input</span><span class="p">(</span><span class="n">GPIO_PORT33</span><span class="p">);</span>
	<span class="n">gpio_direction_input</span><span class="p">(</span><span class="n">GPIO_PORT34</span><span class="p">);</span>
	<span class="n">gpio_direction_input</span><span class="p">(</span><span class="n">GPIO_PORT35</span><span class="p">);</span>
	<span class="n">gpio_export</span><span class="p">(</span><span class="n">GPIO_PORT32</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gpio_export</span><span class="p">(</span><span class="n">GPIO_PORT33</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gpio_export</span><span class="p">(</span><span class="n">GPIO_PORT34</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gpio_export</span><span class="p">(</span><span class="n">GPIO_PORT35</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* SDHI0 */</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_SDHICD0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_SDHIWP0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_SDHICMD0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_SDHICLK0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_SDHID0_3</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_SDHID0_2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_SDHID0_1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_SDHID0_0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* SDHI1 */</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_SDHICMD1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_SDHICLK1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_SDHID1_3</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_SDHID1_2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_SDHID1_1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_SDHID1_0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* MMCIF */</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_MMCD0_0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_MMCD0_1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_MMCD0_2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_MMCD0_3</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_MMCD0_4</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_MMCD0_5</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_MMCD0_6</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_MMCD0_7</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_MMCCMD0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_MMCCLK0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* USB enable */</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_VBUS0_1</span><span class="p">,</span>    <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_IDIN_1_18</span><span class="p">,</span>  <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_PWEN_1_115</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_OVCN_1_114</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_EXTLP_1</span><span class="p">,</span>    <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_OVCN2_1</span><span class="p">,</span>    <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* setup USB phy */</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="mh">0x8a0a</span><span class="p">,</span> <span class="mh">0xE6058130</span><span class="p">);</span>	<span class="cm">/* USBCR4 */</span>

	<span class="cm">/* enable FSI2 port A (ak4643) */</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_FSIAIBT</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_FSIAILR</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_FSIAISLD</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_FSIAOSLD</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_PORT161</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">GPIO_PORT161</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* slave */</span>

	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_PORT9</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_PORT10</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_no_direction</span><span class="p">(</span><span class="n">GPIO_PORT9CR</span><span class="p">);</span>  <span class="cm">/* FSIAOBT needs no direction */</span>
	<span class="n">gpio_no_direction</span><span class="p">(</span><span class="n">GPIO_PORT10CR</span><span class="p">);</span> <span class="cm">/* FSIAOLR needs no direction */</span>

	<span class="cm">/* card detect pin for MMC slot (CN7) */</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_PORT41</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_direction_input</span><span class="p">(</span><span class="n">GPIO_PORT41</span><span class="p">);</span>

	<span class="cm">/* setup FSI2 port B (HDMI) */</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_FSIBCK</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="n">__raw_readw</span><span class="p">(</span><span class="n">USCCR1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">),</span> <span class="n">USCCR1</span><span class="p">);</span> <span class="cm">/* use SPDIF */</span>

	<span class="cm">/* set SPU2 clock to 119.6 MHz */</span>
	<span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;spu_clk&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">clk_set_rate</span><span class="p">(</span><span class="n">clk</span><span class="p">,</span> <span class="n">clk_round_rate</span><span class="p">(</span><span class="n">clk</span><span class="p">,</span> <span class="mi">119600000</span><span class="p">));</span>
		<span class="n">clk_put</span><span class="p">(</span><span class="n">clk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * set irq priority, to avoid sound chopping</span>
<span class="cm">	 * when NFS rootfs is used</span>
<span class="cm">	 *  FSI(3) &gt; SMSC911X(2)</span>
<span class="cm">	 */</span>
	<span class="n">intc_set_priority</span><span class="p">(</span><span class="n">IRQ_FSI</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">i2c_register_board_info</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i2c0_devices</span><span class="p">,</span>
				<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">i2c0_devices</span><span class="p">));</span>

	<span class="n">i2c_register_board_info</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">i2c1_devices</span><span class="p">,</span>
				<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">i2c1_devices</span><span class="p">));</span>

<span class="cp">#ifdef CONFIG_AP4EVB_QHD</span>

	<span class="cm">/*</span>
<span class="cm">	 * For QHD Panel (MIPI-DSI, CONFIG_AP4EVB_QHD=y) and</span>
<span class="cm">	 * IRQ28 for Touch Panel, set dip switches S3, S43 as OFF, ON.</span>
<span class="cm">	 */</span>

	<span class="cm">/* enable KEYSC */</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_KEYOUT0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_KEYOUT1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_KEYOUT2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_KEYOUT3</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_KEYOUT4</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_KEYIN0_136</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_KEYIN1_135</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_KEYIN2_134</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_KEYIN3_133</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_KEYIN4</span><span class="p">,</span>     <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* enable TouchScreen */</span>
	<span class="n">irq_set_irq_type</span><span class="p">(</span><span class="n">IRQ28</span><span class="p">,</span> <span class="n">IRQ_TYPE_LEVEL_LOW</span><span class="p">);</span>

	<span class="n">tsc_device</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">IRQ28</span><span class="p">;</span>
	<span class="n">i2c_register_board_info</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsc_device</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* LCDC0 */</span>
	<span class="n">lcdc_info</span><span class="p">.</span><span class="n">clock_source</span>			<span class="o">=</span> <span class="n">LCDC_CLK_PERIPHERAL</span><span class="p">;</span>
	<span class="n">lcdc_info</span><span class="p">.</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">interface_type</span>		<span class="o">=</span> <span class="n">RGB24</span><span class="p">;</span>
	<span class="n">lcdc_info</span><span class="p">.</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">clock_divider</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">lcdc_info</span><span class="p">.</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span>			<span class="o">=</span> <span class="n">LCDC_FLAGS_DWPOL</span><span class="p">;</span>
	<span class="n">lcdc_info</span><span class="p">.</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">panel_cfg</span><span class="p">.</span><span class="n">width</span>		<span class="o">=</span> <span class="mi">44</span><span class="p">;</span>
	<span class="n">lcdc_info</span><span class="p">.</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">panel_cfg</span><span class="p">.</span><span class="n">height</span>	<span class="o">=</span> <span class="mi">79</span><span class="p">;</span>

	<span class="n">platform_add_devices</span><span class="p">(</span><span class="n">qhd_devices</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">qhd_devices</span><span class="p">));</span>

<span class="cp">#else</span>
	<span class="cm">/*</span>
<span class="cm">	 * For WVGA Panel (18-bit RGB, CONFIG_AP4EVB_WVGA=y) and</span>
<span class="cm">	 * IRQ7 for Touch Panel, set dip switches S3, S43 to ON, OFF.</span>
<span class="cm">	 */</span>

	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_LCDD17</span><span class="p">,</span>   <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_LCDD16</span><span class="p">,</span>   <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_LCDD15</span><span class="p">,</span>   <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_LCDD14</span><span class="p">,</span>   <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_LCDD13</span><span class="p">,</span>   <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_LCDD12</span><span class="p">,</span>   <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_LCDD11</span><span class="p">,</span>   <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_LCDD10</span><span class="p">,</span>   <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_LCDD9</span><span class="p">,</span>    <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_LCDD8</span><span class="p">,</span>    <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_LCDD7</span><span class="p">,</span>    <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_LCDD6</span><span class="p">,</span>    <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_LCDD5</span><span class="p">,</span>    <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_LCDD4</span><span class="p">,</span>    <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_LCDD3</span><span class="p">,</span>    <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_LCDD2</span><span class="p">,</span>    <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_LCDD1</span><span class="p">,</span>    <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_LCDD0</span><span class="p">,</span>    <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_LCDDISP</span><span class="p">,</span>  <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_LCDDCK</span><span class="p">,</span>   <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_PORT189</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span> <span class="cm">/* backlight */</span>
	<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">GPIO_PORT189</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_PORT151</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span> <span class="cm">/* LCDDON */</span>
	<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">GPIO_PORT151</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">lcdc_info</span><span class="p">.</span><span class="n">clock_source</span>			<span class="o">=</span> <span class="n">LCDC_CLK_BUS</span><span class="p">;</span>
	<span class="n">lcdc_info</span><span class="p">.</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">interface_type</span>		<span class="o">=</span> <span class="n">RGB18</span><span class="p">;</span>
	<span class="n">lcdc_info</span><span class="p">.</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">clock_divider</span>		<span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">lcdc_info</span><span class="p">.</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lcdc_info</span><span class="p">.</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">panel_cfg</span><span class="p">.</span><span class="n">width</span>		<span class="o">=</span> <span class="mi">152</span><span class="p">;</span>
	<span class="n">lcdc_info</span><span class="p">.</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">panel_cfg</span><span class="p">.</span><span class="n">height</span>	<span class="o">=</span> <span class="mi">91</span><span class="p">;</span>

	<span class="cm">/* enable TouchScreen */</span>
	<span class="n">irq_set_irq_type</span><span class="p">(</span><span class="n">IRQ7</span><span class="p">,</span> <span class="n">IRQ_TYPE_LEVEL_LOW</span><span class="p">);</span>

	<span class="n">tsc_device</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">IRQ7</span><span class="p">;</span>
	<span class="n">i2c_register_board_info</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsc_device</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_AP4EVB_QHD */</span><span class="cp"></span>

	<span class="cm">/* CEU */</span>

	<span class="cm">/*</span>
<span class="cm">	 * TODO: reserve memory for V4L2 DMA buffers, when a suitable API</span>
<span class="cm">	 * becomes available</span>
<span class="cm">	 */</span>

	<span class="cm">/* MIPI-CSI stuff */</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_VIO_CKO</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;vck1_clk&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">clk_set_rate</span><span class="p">(</span><span class="n">clk</span><span class="p">,</span> <span class="n">clk_round_rate</span><span class="p">(</span><span class="n">clk</span><span class="p">,</span> <span class="mi">13000000</span><span class="p">));</span>
		<span class="n">clk_enable</span><span class="p">(</span><span class="n">clk</span><span class="p">);</span>
		<span class="n">clk_put</span><span class="p">(</span><span class="n">clk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sh7372_add_standard_devices</span><span class="p">();</span>

	<span class="cm">/* HDMI */</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_HDMI_HPD</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_FN_HDMI_CEC</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Reset HDMI, must be held at least one EXTALR (32768Hz) period */</span>
<span class="cp">#define SRCR4 0xe61580bc</span>
	<span class="n">srcr4</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">SRCR4</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">srcr4</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">),</span> <span class="n">SRCR4</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">srcr4</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">),</span> <span class="n">SRCR4</span><span class="p">);</span>

	<span class="n">platform_add_devices</span><span class="p">(</span><span class="n">ap4evb_devices</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ap4evb_devices</span><span class="p">));</span>

	<span class="n">sh7372_add_device_to_domain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh7372_a4lc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lcdc1_device</span><span class="p">);</span>
	<span class="n">sh7372_add_device_to_domain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh7372_a4lc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lcdc_device</span><span class="p">);</span>
	<span class="n">sh7372_add_device_to_domain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh7372_a4mp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fsi_device</span><span class="p">);</span>

	<span class="n">sh7372_add_device_to_domain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh7372_a3sp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh_mmcif_device</span><span class="p">);</span>
	<span class="n">sh7372_add_device_to_domain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh7372_a3sp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdhi0_device</span><span class="p">);</span>
	<span class="n">sh7372_add_device_to_domain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh7372_a3sp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdhi1_device</span><span class="p">);</span>
	<span class="n">sh7372_add_device_to_domain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh7372_a4r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ceu_device</span><span class="p">);</span>

	<span class="n">hdmi_init_pm_clock</span><span class="p">();</span>
	<span class="n">fsi_init_pm_clock</span><span class="p">();</span>
	<span class="n">sh7372_pm_init</span><span class="p">();</span>
	<span class="n">pm_clk_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fsi_device</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;spu2&quot;</span><span class="p">);</span>
	<span class="n">pm_clk_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lcdc1_device</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;hdmi&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MACHINE_START</span><span class="p">(</span><span class="n">AP4EVB</span><span class="p">,</span> <span class="s">&quot;ap4evb&quot;</span><span class="p">)</span>
	<span class="p">.</span><span class="n">map_io</span>		<span class="o">=</span> <span class="n">sh7372_map_io</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_early</span>	<span class="o">=</span> <span class="n">sh7372_add_early_devices</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_irq</span>	<span class="o">=</span> <span class="n">sh7372_init_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">handle_irq</span>	<span class="o">=</span> <span class="n">shmobile_handle_irq_intc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_machine</span>	<span class="o">=</span> <span class="n">ap4evb_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_late</span>	<span class="o">=</span> <span class="n">shmobile_init_late</span><span class="p">,</span>
	<span class="p">.</span><span class="n">timer</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">shmobile_timer</span><span class="p">,</span>
<span class="n">MACHINE_END</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
