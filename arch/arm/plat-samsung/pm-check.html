<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › plat-samsung › pm-check.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>pm-check.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* linux/arch/arm/plat-s3c/pm-check.c</span>
<span class="cm"> *  originally in linux/arch/arm/plat-s3c24xx/pm.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2004-2008 Simtec Electronics</span>
<span class="cm"> *	http://armlinux.simtec.co.uk</span>
<span class="cm"> *	Ben Dooks &lt;ben@simtec.co.uk&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * S3C Power Mangament - suspend/resume memory corruptiuon check.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm">*/</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/suspend.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;plat/pm.h&gt;</span>

<span class="cp">#if CONFIG_SAMSUNG_PM_CHECK_CHUNKSIZE &lt; 1</span>
<span class="cp">#error CONFIG_SAMSUNG_PM_CHECK_CHUNKSIZE must be a positive non-zero value</span>
<span class="cp">#endif</span>

<span class="cm">/* suspend checking code...</span>
<span class="cm"> *</span>
<span class="cm"> * this next area does a set of crc checks over all the installed</span>
<span class="cm"> * memory, so the system can verify if the resume was ok.</span>
<span class="cm"> *</span>
<span class="cm"> * CONFIG_SAMSUNG_PM_CHECK_CHUNKSIZE defines the block-size for the CRC,</span>
<span class="cm"> * increasing it will mean that the area corrupted will be less easy to spot,</span>
<span class="cm"> * and reducing the size will cause the CRC save area to grow</span>
<span class="cm">*/</span>

<span class="cp">#define CHECK_CHUNKSIZE (CONFIG_SAMSUNG_PM_CHECK_CHUNKSIZE * 1024)</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">crc_size</span><span class="p">;</span>	<span class="cm">/* size needed for the crc block */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="o">*</span><span class="n">crcs</span><span class="p">;</span>	<span class="cm">/* allocated over suspend/resume */</span>

<span class="k">typedef</span> <span class="n">u32</span> <span class="o">*</span><span class="p">(</span><span class="n">run_fn_t</span><span class="p">)(</span><span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>

<span class="cm">/* s3c_pm_run_res</span>
<span class="cm"> *</span>
<span class="cm"> * go through the given resource list, and look for system ram</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_pm_run_res</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">run_fn_t</span> <span class="n">fn</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">child</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">s3c_pm_run_res</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">strcmp</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;System RAM&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">S3C_PMDBG</span><span class="p">(</span><span class="s">&quot;Found system RAM at %08lx..%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
				  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">);</span>
			<span class="n">arg</span> <span class="o">=</span> <span class="p">(</span><span class="n">fn</span><span class="p">)(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ptr</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c_pm_run_sysram</span><span class="p">(</span><span class="n">run_fn_t</span> <span class="n">fn</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s3c_pm_run_res</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iomem_resource</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="o">*</span><span class="nf">s3c_pm_countram</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">+=</span> <span class="n">CHECK_CHUNKSIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">/=</span> <span class="n">CHECK_CHUNKSIZE</span><span class="p">;</span>

	<span class="n">S3C_PMDBG</span><span class="p">(</span><span class="s">&quot;Area %08lx..%08lx, %d blocks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="o">*</span><span class="n">val</span> <span class="o">+=</span> <span class="n">size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* s3c_pm_prepare_check</span>
<span class="cm"> *</span>
<span class="cm"> * prepare the necessary information for creating the CRCs. This</span>
<span class="cm"> * must be done before the final save, as it will require memory</span>
<span class="cm"> * allocating, and thus touching bits of the kernel we do not</span>
<span class="cm"> * know about.</span>
<span class="cm">*/</span>

<span class="kt">void</span> <span class="nf">s3c_pm_check_prepare</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">crc_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">s3c_pm_run_sysram</span><span class="p">(</span><span class="n">s3c_pm_countram</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crc_size</span><span class="p">);</span>

	<span class="n">S3C_PMDBG</span><span class="p">(</span><span class="s">&quot;s3c_pm_prepare_check: %u checks needed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">crc_size</span><span class="p">);</span>

	<span class="n">crcs</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">crc_size</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crcs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Cannot allocated CRC save area</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="o">*</span><span class="nf">s3c_pm_makecheck</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="n">left</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">addr</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">;</span>
	     <span class="n">addr</span> <span class="o">+=</span> <span class="n">CHECK_CHUNKSIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">left</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="n">addr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">&gt;</span> <span class="n">CHECK_CHUNKSIZE</span><span class="p">)</span>
			<span class="n">left</span> <span class="o">=</span> <span class="n">CHECK_CHUNKSIZE</span><span class="p">;</span>

		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">crc32_le</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span> <span class="n">left</span><span class="p">);</span>
		<span class="n">val</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* s3c_pm_check_store</span>
<span class="cm"> *</span>
<span class="cm"> * compute the CRC values for the memory blocks before the final</span>
<span class="cm"> * sleep.</span>
<span class="cm">*/</span>

<span class="kt">void</span> <span class="nf">s3c_pm_check_store</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crcs</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">s3c_pm_run_sysram</span><span class="p">(</span><span class="n">s3c_pm_makecheck</span><span class="p">,</span> <span class="n">crcs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* in_region</span>
<span class="cm"> *</span>
<span class="cm"> * return TRUE if the area defined by ptr..ptr+size contains the</span>
<span class="cm"> * what..what+whatsz</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">in_region</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">what</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">whatsz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">what</span><span class="o">+</span><span class="n">whatsz</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">what</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="n">size</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_pm_runcheck() - helper to check a resource on restore.</span>
<span class="cm"> * @res: The resource to check</span>
<span class="cm"> * @vak: Pointer to list of CRC32 values to check.</span>
<span class="cm"> *</span>
<span class="cm"> * Called from the s3c_pm_check_restore() via s3c_pm_run_sysram(), this</span>
<span class="cm"> * function runs the given memory resource checking it against the stored</span>
<span class="cm"> * CRC to ensure that memory is restored. The function tries to skip as</span>
<span class="cm"> * many of the areas used during the suspend process.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="o">*</span><span class="nf">s3c_pm_runcheck</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">left</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">stkpage</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">calc</span><span class="p">;</span>

	<span class="n">stkpage</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)((</span><span class="n">u32</span><span class="p">)</span><span class="o">&amp;</span><span class="n">calc</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">addr</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">;</span>
	     <span class="n">addr</span> <span class="o">+=</span> <span class="n">CHECK_CHUNKSIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">left</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="n">addr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">&gt;</span> <span class="n">CHECK_CHUNKSIZE</span><span class="p">)</span>
			<span class="n">left</span> <span class="o">=</span> <span class="n">CHECK_CHUNKSIZE</span><span class="p">;</span>

		<span class="n">ptr</span> <span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">in_region</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">stkpage</span><span class="p">,</span> <span class="mi">4096</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">S3C_PMDBG</span><span class="p">(</span><span class="s">&quot;skipping %08lx, has stack in</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">skip_check</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">in_region</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">crcs</span><span class="p">,</span> <span class="n">crc_size</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">S3C_PMDBG</span><span class="p">(</span><span class="s">&quot;skipping %08lx, has crc block in</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">skip_check</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* calculate and check the checksum */</span>

		<span class="n">calc</span> <span class="o">=</span> <span class="n">crc32_le</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">left</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">calc</span> <span class="o">!=</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Restore CRC error at &quot;</span>
			       <span class="s">&quot;%08lx (%08x vs %08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">calc</span><span class="p">,</span> <span class="o">*</span><span class="n">val</span><span class="p">);</span>

			<span class="n">S3C_PMDBG</span><span class="p">(</span><span class="s">&quot;Restore CRC error at %08lx (%08x vs %08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">addr</span><span class="p">,</span> <span class="n">calc</span><span class="p">,</span> <span class="o">*</span><span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="nl">skip_check:</span>
		<span class="n">val</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_pm_check_restore() - memory check called on resume</span>
<span class="cm"> *</span>
<span class="cm"> * check the CRCs after the restore event and free the memory used</span>
<span class="cm"> * to hold them</span>
<span class="cm">*/</span>
<span class="kt">void</span> <span class="nf">s3c_pm_check_restore</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crcs</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">s3c_pm_run_sysram</span><span class="p">(</span><span class="n">s3c_pm_runcheck</span><span class="p">,</span> <span class="n">crcs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c_pm_check_cleanup() - free memory resources</span>
<span class="cm"> *</span>
<span class="cm"> * Free the resources that where allocated by the suspend</span>
<span class="cm"> * memory check code. We do this separately from the</span>
<span class="cm"> * s3c_pm_check_restore() function as we cannot call any</span>
<span class="cm"> * functions that might sleep during that resume.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">s3c_pm_check_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">crcs</span><span class="p">);</span>
	<span class="n">crcs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
