<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › mach-davinci › board-dm355-evm.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>board-dm355-evm.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * TI DaVinci EVM board support</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Kevin Hilman, Deep Root Systems, LLC</span>
<span class="cm"> *</span>
<span class="cm"> * 2007 (c) MontaVista Software, Inc. This file is licensed under</span>
<span class="cm"> * the terms of the GNU General Public License version 2. This program</span>
<span class="cm"> * is licensed &quot;as is&quot; without any warranty of any kind, whether express</span>
<span class="cm"> * or implied.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/mtd.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/partitions.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/nand.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;media/tvp514x.h&gt;</span>
<span class="cp">#include &lt;linux/spi/spi.h&gt;</span>
<span class="cp">#include &lt;linux/spi/eeprom.h&gt;</span>

<span class="cp">#include &lt;asm/mach-types.h&gt;</span>
<span class="cp">#include &lt;asm/mach/arch.h&gt;</span>

<span class="cp">#include &lt;mach/i2c.h&gt;</span>
<span class="cp">#include &lt;mach/serial.h&gt;</span>
<span class="cp">#include &lt;mach/nand.h&gt;</span>
<span class="cp">#include &lt;mach/mmc.h&gt;</span>
<span class="cp">#include &lt;mach/usb.h&gt;</span>

<span class="cp">#include &quot;davinci.h&quot;</span>

<span class="cm">/* NOTE:  this is geared for the standard config, with a socketed</span>
<span class="cm"> * 2 GByte Micron NAND (MT29F16G08FAA) using 128KB sectors.  If you</span>
<span class="cm"> * swap chips, maybe with a different block size, partitioning may</span>
<span class="cm"> * need to be changed.</span>
<span class="cm"> */</span>
<span class="cp">#define NAND_BLOCK_SIZE		SZ_128K</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mtd_partition</span> <span class="n">davinci_nand_partitions</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="cm">/* UBL (a few copies) plus U-Boot */</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;bootloader&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">15</span> <span class="o">*</span> <span class="n">NAND_BLOCK_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask_flags</span>	<span class="o">=</span> <span class="n">MTD_WRITEABLE</span><span class="p">,</span> <span class="cm">/* force read-only */</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="cm">/* U-Boot environment */</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;params&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="n">MTDPART_OFS_APPEND</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">NAND_BLOCK_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask_flags</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;kernel&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="n">MTDPART_OFS_APPEND</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="n">SZ_4M</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask_flags</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;filesystem1&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="n">MTDPART_OFS_APPEND</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="n">SZ_512M</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask_flags</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;filesystem2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="n">MTDPART_OFS_APPEND</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="n">MTDPART_SIZ_FULL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask_flags</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="cm">/* two blocks with bad block table (and mirror) at the end */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">davinci_nand_pdata</span> <span class="n">davinci_nand_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">mask_chipsel</span>		<span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">14</span><span class="p">),</span>
	<span class="p">.</span><span class="n">parts</span>			<span class="o">=</span> <span class="n">davinci_nand_partitions</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nr_parts</span>		<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">davinci_nand_partitions</span><span class="p">),</span>
	<span class="p">.</span><span class="n">ecc_mode</span>		<span class="o">=</span> <span class="n">NAND_ECC_HW</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bbt_options</span>		<span class="o">=</span> <span class="n">NAND_BBT_USE_FLASH</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ecc_bits</span>		<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">davinci_nand_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>		<span class="o">=</span> <span class="n">DM355_ASYNC_EMIF_DATA_CE0_BASE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>		<span class="o">=</span> <span class="n">DM355_ASYNC_EMIF_DATA_CE0_BASE</span> <span class="o">+</span> <span class="n">SZ_32M</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>		<span class="o">=</span> <span class="n">DM355_ASYNC_EMIF_CONTROL_BASE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>		<span class="o">=</span> <span class="n">DM355_ASYNC_EMIF_CONTROL_BASE</span> <span class="o">+</span> <span class="n">SZ_4K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">davinci_nand_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;davinci_nand&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>

	<span class="p">.</span><span class="n">num_resources</span>		<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">davinci_nand_resources</span><span class="p">),</span>
	<span class="p">.</span><span class="n">resource</span>		<span class="o">=</span> <span class="n">davinci_nand_resources</span><span class="p">,</span>

	<span class="p">.</span><span class="n">dev</span>			<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">davinci_nand_data</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">davinci_i2c_platform_data</span> <span class="n">i2c_pdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bus_freq</span>	<span class="o">=</span> <span class="mi">400</span>	<span class="cm">/* kHz */</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bus_delay</span>	<span class="o">=</span> <span class="mi">0</span>	<span class="cm">/* usec */</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sda_pin</span>        <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
	<span class="p">.</span><span class="n">scl_pin</span>        <span class="o">=</span> <span class="mi">14</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_platform_data</span> <span class="n">dm355_evm_snd_data</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">dm355evm_mmc_gpios</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dm355evm_mmcsd_gpios</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">gpio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">gpio</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;mmc0_ro&quot;</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">gpio</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;mmc0_cd&quot;</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">gpio</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;mmc1_ro&quot;</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">gpio</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;mmc1_cd&quot;</span><span class="p">);</span>

	<span class="cm">/* we &quot;know&quot; these are input-only so we don&#39;t</span>
<span class="cm">	 * need to call gpio_direction_input()</span>
<span class="cm">	 */</span>

	<span class="n">dm355evm_mmc_gpios</span> <span class="o">=</span> <span class="n">gpio</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">dm355evm_i2c_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>	<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;dm355evm_msp&quot;</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">),</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="n">dm355evm_mmcsd_gpios</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* { plus irq  }, */</span>
	<span class="p">{</span> <span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;tlv320aic33&quot;</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">),</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">evm_init_i2c</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">davinci_init_i2c</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c_pdata</span><span class="p">);</span>

	<span class="n">gpio_request</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;dm355evm_msp&quot;</span><span class="p">);</span>
	<span class="n">gpio_direction_input</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="n">dm355evm_i2c_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">irq</span> <span class="o">=</span> <span class="n">gpio_to_irq</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="n">i2c_register_board_info</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dm355evm_i2c_info</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dm355evm_i2c_info</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">dm355evm_dm9000_rsrc</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="cm">/* addr */</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="mh">0x04014000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="mh">0x04014001</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="cm">/* data */</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="mh">0x04014002</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="mh">0x04014003</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span>
			<span class="o">|</span> <span class="n">IORESOURCE_IRQ_HIGHEDGE</span> <span class="cm">/* rising (active high) */</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">dm355evm_dm9000</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;dm9000&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">dm355evm_dm9000_rsrc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dm355evm_dm9000_rsrc</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tvp514x_platform_data</span> <span class="n">tvp5146_pdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">clk_polarity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hs_polarity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vs_polarity</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">};</span>

<span class="cp">#define TVP514X_STD_ALL	(V4L2_STD_NTSC | V4L2_STD_PAL)</span>
<span class="cm">/* Inputs available at the TVP5146 */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_input</span> <span class="n">tvp5146_inputs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Composite&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_INPUT_TYPE_CAMERA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">std</span> <span class="o">=</span> <span class="n">TVP514X_STD_ALL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;S-Video&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_INPUT_TYPE_CAMERA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">std</span> <span class="o">=</span> <span class="n">TVP514X_STD_ALL</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * this is the route info for connecting each input to decoder</span>
<span class="cm"> * ouput that goes to vpfe. There is a one to one correspondence</span>
<span class="cm"> * with tvp5146_inputs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">vpfe_route</span> <span class="n">tvp5146_routes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">INPUT_CVBS_VI2B</span><span class="p">,</span>
		<span class="p">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">OUTPUT_10BIT_422_EMBEDDED_SYNC</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">INPUT_SVIDEO_VI2C_VI1C</span><span class="p">,</span>
		<span class="p">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">OUTPUT_10BIT_422_EMBEDDED_SYNC</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vpfe_subdev_info</span> <span class="n">vpfe_sub_devs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;tvp5146&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">grp_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_inputs</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tvp5146_inputs</span><span class="p">),</span>
		<span class="p">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="n">tvp5146_inputs</span><span class="p">,</span>
		<span class="p">.</span><span class="n">routes</span> <span class="o">=</span> <span class="n">tvp5146_routes</span><span class="p">,</span>
		<span class="p">.</span><span class="n">can_route</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ccdc_if_params</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">if_type</span> <span class="o">=</span> <span class="n">VPFE_BT656</span><span class="p">,</span>
			<span class="p">.</span><span class="n">hdpol</span> <span class="o">=</span> <span class="n">VPFE_PINPOL_POSITIVE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">vdpol</span> <span class="o">=</span> <span class="n">VPFE_PINPOL_POSITIVE</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">board_info</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;tvp5146&quot;</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">),</span>
			<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tvp5146_pdata</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vpfe_config</span> <span class="n">vpfe_cfg</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">num_subdevs</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">vpfe_sub_devs</span><span class="p">),</span>
	<span class="p">.</span><span class="n">i2c_adapter_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sub_devs</span> <span class="o">=</span> <span class="n">vpfe_sub_devs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">card_name</span> <span class="o">=</span> <span class="s">&quot;DM355 EVM&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ccdc</span> <span class="o">=</span> <span class="s">&quot;DM355 CCDC&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">davinci_evm_devices</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dm355evm_dm9000</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">davinci_nand_device</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">davinci_uart_config</span> <span class="n">uart_config</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">enabled_uarts</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">dm355_evm_map_io</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* setup input configuration for VPFE input devices */</span>
	<span class="n">dm355_set_vpfe_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpfe_cfg</span><span class="p">);</span>
	<span class="n">dm355_init</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dm355evm_mmc_get_cd</span><span class="p">(</span><span class="kt">int</span> <span class="n">module</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">dm355evm_mmc_gpios</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="cm">/* low == card present */</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">gpio_get_value_cansleep</span><span class="p">(</span><span class="n">dm355evm_mmc_gpios</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">module</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dm355evm_mmc_get_ro</span><span class="p">(</span><span class="kt">int</span> <span class="n">module</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">dm355evm_mmc_gpios</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="cm">/* high == card&#39;s write protect switch active */</span>
	<span class="k">return</span> <span class="n">gpio_get_value_cansleep</span><span class="p">(</span><span class="n">dm355evm_mmc_gpios</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">module</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">davinci_mmc_config</span> <span class="n">dm355evm_mmc_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_cd</span>		<span class="o">=</span> <span class="n">dm355evm_mmc_get_cd</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ro</span>		<span class="o">=</span> <span class="n">dm355evm_mmc_get_ro</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wires</span>		<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_freq</span>       <span class="o">=</span> <span class="mi">50000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">caps</span>           <span class="o">=</span> <span class="n">MMC_CAP_MMC_HIGHSPEED</span> <span class="o">|</span> <span class="n">MMC_CAP_SD_HIGHSPEED</span><span class="p">,</span>
	<span class="p">.</span><span class="n">version</span>	<span class="o">=</span> <span class="n">MMC_CTLR_VERSION_1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Don&#39;t connect anything to J10 unless you&#39;re only using USB host</span>
<span class="cm"> * mode *and* have to do so with some kind of gender-bender.  If</span>
<span class="cm"> * you have proper Mini-B or Mini-A cables (or Mini-A adapters)</span>
<span class="cm"> * the ID pin won&#39;t need any help.</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_USB_MUSB_PERIPHERAL</span>
<span class="cp">#define USB_ID_VALUE	0	</span><span class="cm">/* ID pulled high; *should* float */</span><span class="cp"></span>
<span class="cp">#else</span>
<span class="cp">#define USB_ID_VALUE	1	</span><span class="cm">/* ID pulled low */</span><span class="cp"></span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">spi_eeprom</span> <span class="n">at25640a</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">byte_len</span>	<span class="o">=</span> <span class="n">SZ_64K</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;at25640a&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">page_size</span>	<span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">EE_ADDR2</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">spi_board_info</span> <span class="n">dm355_evm_spi_info</span><span class="p">[]</span> <span class="n">__initconst</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">modalias</span>	<span class="o">=</span> <span class="s">&quot;at25&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">at25640a</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_speed_hz</span>	<span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span>	<span class="cm">/* at 3v3 */</span>
		<span class="p">.</span><span class="n">bus_num</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chip_select</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="n">SPI_MODE_0</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">void</span> <span class="nf">dm355_evm_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">aemif</span><span class="p">;</span>

	<span class="n">gpio_request</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;dm9000&quot;</span><span class="p">);</span>
	<span class="n">gpio_direction_input</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">dm355evm_dm9000_rsrc</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">start</span> <span class="o">=</span> <span class="n">gpio_to_irq</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">aemif</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dm355evm_dm9000</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;aemif&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">aemif</span><span class="p">))</span>
		<span class="n">WARN</span><span class="p">(</span><span class="s">&quot;%s: unable to get AEMIF clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clk_enable</span><span class="p">(</span><span class="n">aemif</span><span class="p">);</span>

	<span class="n">platform_add_devices</span><span class="p">(</span><span class="n">davinci_evm_devices</span><span class="p">,</span>
			     <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">davinci_evm_devices</span><span class="p">));</span>
	<span class="n">evm_init_i2c</span><span class="p">();</span>
	<span class="n">davinci_serial_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uart_config</span><span class="p">);</span>

	<span class="cm">/* NOTE:  NAND flash timings set by the UBL are slower than</span>
<span class="cm">	 * needed by MT29F16G08FAA chips ... EMIF.A1CR is 0x40400204</span>
<span class="cm">	 * but could be 0x0400008c for about 25% faster page reads.</span>
<span class="cm">	 */</span>

	<span class="n">gpio_request</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;usb_id_toggle&quot;</span><span class="p">);</span>
	<span class="n">gpio_direction_output</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">USB_ID_VALUE</span><span class="p">);</span>
	<span class="cm">/* irlml6401 switches over 1A in under 8 msec */</span>
	<span class="n">davinci_setup_usb</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">davinci_setup_mmc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dm355evm_mmc_config</span><span class="p">);</span>
	<span class="n">davinci_setup_mmc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dm355evm_mmc_config</span><span class="p">);</span>

	<span class="n">dm355_init_spi0</span><span class="p">(</span><span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">dm355_evm_spi_info</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dm355_evm_spi_info</span><span class="p">));</span>

	<span class="cm">/* DM335 EVM uses ASP1; line-out is a stereo mini-jack */</span>
	<span class="n">dm355_init_asp1</span><span class="p">(</span><span class="n">ASP1_TX_EVT_EN</span> <span class="o">|</span> <span class="n">ASP1_RX_EVT_EN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dm355_evm_snd_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MACHINE_START</span><span class="p">(</span><span class="n">DAVINCI_DM355_EVM</span><span class="p">,</span> <span class="s">&quot;DaVinci DM355 EVM&quot;</span><span class="p">)</span>
	<span class="p">.</span><span class="n">atag_offset</span>  <span class="o">=</span> <span class="mh">0x100</span><span class="p">,</span>
	<span class="p">.</span><span class="n">map_io</span>	      <span class="o">=</span> <span class="n">dm355_evm_map_io</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_irq</span>     <span class="o">=</span> <span class="n">davinci_irq_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">timer</span>	      <span class="o">=</span> <span class="o">&amp;</span><span class="n">davinci_timer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_machine</span> <span class="o">=</span> <span class="n">dm355_evm_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_late</span>	<span class="o">=</span> <span class="n">davinci_init_late</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_zone_size</span>	<span class="o">=</span> <span class="n">SZ_128M</span><span class="p">,</span>
	<span class="p">.</span><span class="n">restart</span>	<span class="o">=</span> <span class="n">davinci_restart</span><span class="p">,</span>
<span class="n">MACHINE_END</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
