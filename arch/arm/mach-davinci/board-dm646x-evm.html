<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › mach-davinci › board-dm646x-evm.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>board-dm646x-evm.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * TI DaVinci DM646X EVM board</span>
<span class="cm"> *</span>
<span class="cm"> * Derived from: arch/arm/mach-davinci/board-evm.c</span>
<span class="cm"> * Copyright (C) 2006 Texas Instruments.</span>
<span class="cm"> *</span>
<span class="cm"> * (C) 2007-2008, MontaVista Software, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * This file is licensed under the terms of the GNU General Public License</span>
<span class="cm"> * version 2. This program is licensed &quot;as is&quot; without any warranty of any</span>
<span class="cm"> * kind, whether express or implied.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> * Included Files</span>
<span class="cm"> **************************************************************************/</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/leds.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/i2c/at24.h&gt;</span>
<span class="cp">#include &lt;linux/i2c/pcf857x.h&gt;</span>

<span class="cp">#include &lt;media/tvp514x.h&gt;</span>

<span class="cp">#include &lt;linux/mtd/mtd.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/nand.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/partitions.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>

<span class="cp">#include &lt;asm/mach-types.h&gt;</span>
<span class="cp">#include &lt;asm/mach/arch.h&gt;</span>

<span class="cp">#include &lt;mach/common.h&gt;</span>
<span class="cp">#include &lt;mach/serial.h&gt;</span>
<span class="cp">#include &lt;mach/i2c.h&gt;</span>
<span class="cp">#include &lt;mach/nand.h&gt;</span>
<span class="cp">#include &lt;mach/clock.h&gt;</span>
<span class="cp">#include &lt;mach/cdce949.h&gt;</span>
<span class="cp">#include &lt;mach/aemif.h&gt;</span>

<span class="cp">#include &quot;davinci.h&quot;</span>
<span class="cp">#include &quot;clock.h&quot;</span>

<span class="cp">#define NAND_BLOCK_SIZE		SZ_128K</span>

<span class="cm">/* Note: We are setting first partition as &#39;bootloader&#39; constituting UBL, U-Boot</span>
<span class="cm"> * and U-Boot environment this avoids dependency on any particular combination</span>
<span class="cm"> * of UBL, U-Boot or flashing tools etc.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mtd_partition</span> <span class="n">davinci_nand_partitions</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="cm">/* UBL, U-Boot with environment */</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;bootloader&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="n">MTDPART_OFS_APPEND</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">NAND_BLOCK_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask_flags</span>	<span class="o">=</span> <span class="n">MTD_WRITEABLE</span><span class="p">,</span>	<span class="cm">/* force read-only */</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;kernel&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="n">MTDPART_OFS_APPEND</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="n">SZ_4M</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask_flags</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;filesystem&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="n">MTDPART_OFS_APPEND</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="n">MTDPART_SIZ_FULL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask_flags</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">davinci_aemif_timing</span> <span class="n">dm6467tevm_nandflash_timing</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">wsetup</span>		<span class="o">=</span> <span class="mi">29</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wstrobe</span>	<span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
	<span class="p">.</span><span class="n">whold</span>		<span class="o">=</span> <span class="mi">14</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rsetup</span>		<span class="o">=</span> <span class="mi">19</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rstrobe</span>	<span class="o">=</span> <span class="mi">33</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rhold</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ta</span>		<span class="o">=</span> <span class="mi">29</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">davinci_nand_pdata</span> <span class="n">davinci_nand_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">mask_cle</span> 		<span class="o">=</span> <span class="mh">0x80000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mask_ale</span> 		<span class="o">=</span> <span class="mh">0x40000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">parts</span>			<span class="o">=</span> <span class="n">davinci_nand_partitions</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nr_parts</span>		<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">davinci_nand_partitions</span><span class="p">),</span>
	<span class="p">.</span><span class="n">ecc_mode</span>		<span class="o">=</span> <span class="n">NAND_ECC_HW</span><span class="p">,</span>
	<span class="p">.</span><span class="n">options</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">davinci_nand_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>		<span class="o">=</span> <span class="n">DM646X_ASYNC_EMIF_CS2_SPACE_BASE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>		<span class="o">=</span> <span class="n">DM646X_ASYNC_EMIF_CS2_SPACE_BASE</span> <span class="o">+</span> <span class="n">SZ_32M</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>		<span class="o">=</span> <span class="n">DM646X_ASYNC_EMIF_CONTROL_BASE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>		<span class="o">=</span> <span class="n">DM646X_ASYNC_EMIF_CONTROL_BASE</span> <span class="o">+</span> <span class="n">SZ_4K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">davinci_nand_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;davinci_nand&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>

	<span class="p">.</span><span class="n">num_resources</span>		<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">davinci_nand_resources</span><span class="p">),</span>
	<span class="p">.</span><span class="n">resource</span>		<span class="o">=</span> <span class="n">davinci_nand_resources</span><span class="p">,</span>

	<span class="p">.</span><span class="n">dev</span>			<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">davinci_nand_data</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cp">#if defined(CONFIG_BLK_DEV_PALMCHIP_BK3710) || \</span>
<span class="cp">    defined(CONFIG_BLK_DEV_PALMCHIP_BK3710_MODULE)</span>
<span class="cp">#define HAS_ATA 1</span>
<span class="cp">#else</span>
<span class="cp">#define HAS_ATA 0</span>
<span class="cp">#endif</span>

<span class="cm">/* CPLD Register 0 bits to control ATA */</span>
<span class="cp">#define DM646X_EVM_ATA_RST		BIT(0)</span>
<span class="cp">#define DM646X_EVM_ATA_PWD		BIT(1)</span>

<span class="cm">/* CPLD Register 0 Client: used for I/O Control */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cpld_reg0_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			   <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_ATA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">data</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">{</span>
				<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
				<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">,</span>
				<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
				<span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span>
			<span class="p">},</span>
			<span class="p">{</span>
				<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
				<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
				<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
				<span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span>
			<span class="p">},</span>
		<span class="p">};</span>

		<span class="cm">/* Clear ATA_RSTn and ATA_PWD bits to enable ATA operation. */</span>
		<span class="n">i2c_transfer</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">DM646X_EVM_ATA_RST</span> <span class="o">|</span> <span class="n">DM646X_EVM_ATA_PWD</span><span class="p">);</span>
		<span class="n">i2c_transfer</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">msg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">cpld_reg_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;cpld_reg0&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">dm6467evm_cpld_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;cpld_reg0&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">cpld_reg_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">cpld_reg0_probe</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* LEDS */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio_led</span> <span class="n">evm_leds</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;DS1&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">active_low</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;DS2&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">active_low</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;DS3&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">active_low</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;DS4&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">active_low</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">gpio_led_platform_data</span> <span class="n">evm_led_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">num_leds</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">evm_leds</span><span class="p">),</span>
	<span class="p">.</span><span class="n">leds</span>     <span class="o">=</span> <span class="n">evm_leds</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">evm_led_dev</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">evm_led_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gpio</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ngpio</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gpio_led</span> <span class="o">*</span><span class="n">leds</span> <span class="o">=</span> <span class="n">evm_leds</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">ngpio</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">leds</span><span class="o">-&gt;</span><span class="n">gpio</span> <span class="o">=</span> <span class="n">gpio</span><span class="o">++</span><span class="p">;</span>
		<span class="n">leds</span><span class="o">++</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="n">evm_led_dev</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="s">&quot;leds-gpio&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">platform_device_add_data</span><span class="p">(</span><span class="n">evm_led_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">evm_led_data</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">evm_led_data</span><span class="p">));</span>

	<span class="n">evm_led_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">platform_device_add</span><span class="p">(</span><span class="n">evm_led_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">platform_device_put</span><span class="p">(</span><span class="n">evm_led_dev</span><span class="p">);</span>
		<span class="n">evm_led_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">evm_led_teardown</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gpio</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="n">ngpio</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">evm_led_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">platform_device_unregister</span><span class="p">(</span><span class="n">evm_led_dev</span><span class="p">);</span>
		<span class="n">evm_led_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">evm_sw_gpio</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">,</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">,</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">,</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">evm_sw_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gpio</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="n">ngpio</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">label</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s">&quot;user_sw%d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">gpio</span><span class="p">,</span> <span class="n">label</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="n">evm_sw_gpio</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gpio</span><span class="o">++</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">gpio_direction_input</span><span class="p">(</span><span class="n">evm_sw_gpio</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gpio_free</span><span class="p">(</span><span class="n">evm_sw_gpio</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">evm_sw_gpio</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">gpio_export</span><span class="p">(</span><span class="n">evm_sw_gpio</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gpio_free</span><span class="p">(</span><span class="n">evm_sw_gpio</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">evm_sw_gpio</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="nl">out_free:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">evm_sw_gpio</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gpio_free</span><span class="p">(</span><span class="n">evm_sw_gpio</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">evm_sw_gpio</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">evm_sw_teardown</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gpio</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="n">ngpio</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">evm_sw_gpio</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gpio_unexport</span><span class="p">(</span><span class="n">evm_sw_gpio</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">gpio_free</span><span class="p">(</span><span class="n">evm_sw_gpio</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">evm_sw_gpio</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">evm_pcf_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gpio</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ngpio</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ngpio</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">evm_sw_setup</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">gpio</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">evm_led_setup</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">gpio</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">evm_pcf_teardown</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gpio</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ngpio</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ngpio</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">evm_sw_teardown</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">gpio</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="n">evm_led_teardown</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">gpio</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pcf857x_platform_data</span> <span class="n">pcf_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">gpio_base</span>	<span class="o">=</span> <span class="n">DAVINCI_N_GPIO</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup</span>		<span class="o">=</span> <span class="n">evm_pcf_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">teardown</span>	<span class="o">=</span> <span class="n">evm_pcf_teardown</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Most of this EEPROM is unused, but U-Boot uses some data:</span>
<span class="cm"> *  - 0x7f00, 6 bytes Ethernet Address</span>
<span class="cm"> *  - ... newer boards may have more</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">at24_platform_data</span> <span class="n">eeprom_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">byte_len</span>       <span class="o">=</span> <span class="p">(</span><span class="mi">256</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">page_size</span>      <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>          <span class="o">=</span> <span class="n">AT24_FLAG_ADDR16</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup</span>          <span class="o">=</span> <span class="n">davinci_get_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">context</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x7f00</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">dm646x_iis_serializer_direction</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
       <span class="n">TX_MODE</span><span class="p">,</span> <span class="n">RX_MODE</span><span class="p">,</span> <span class="n">INACTIVE_MODE</span><span class="p">,</span> <span class="n">INACTIVE_MODE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">dm646x_dit_serializer_direction</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
       <span class="n">TX_MODE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_platform_data</span> <span class="n">dm646x_evm_snd_data</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">tx_dma_offset</span>  <span class="o">=</span> <span class="mh">0x400</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rx_dma_offset</span>  <span class="o">=</span> <span class="mh">0x400</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_mode</span>        <span class="o">=</span> <span class="n">DAVINCI_MCASP_IIS_MODE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_serializer</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dm646x_iis_serializer_direction</span><span class="p">),</span>
		<span class="p">.</span><span class="n">tdm_slots</span>      <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">serial_dir</span>     <span class="o">=</span> <span class="n">dm646x_iis_serializer_direction</span><span class="p">,</span>
		<span class="p">.</span><span class="n">asp_chan_q</span>     <span class="o">=</span> <span class="n">EVENTQ_0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">tx_dma_offset</span>  <span class="o">=</span> <span class="mh">0x400</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rx_dma_offset</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">op_mode</span>        <span class="o">=</span> <span class="n">DAVINCI_MCASP_DIT_MODE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_serializer</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dm646x_dit_serializer_direction</span><span class="p">),</span>
		<span class="p">.</span><span class="n">tdm_slots</span>      <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">serial_dir</span>     <span class="o">=</span> <span class="n">dm646x_dit_serializer_direction</span><span class="p">,</span>
		<span class="p">.</span><span class="n">asp_chan_q</span>     <span class="o">=</span> <span class="n">EVENTQ_0</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">cpld_client</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cpld_video_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cpld_client</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">cpld_video_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cpld_client</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">cpld_video_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;cpld_video&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">cpld_video_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;cpld_video&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">cpld_video_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">cpld_video_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">cpld_video_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">evm_init_cpld</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">i2c_add_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpld_video_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">__initdata</span> <span class="n">i2c_info</span><span class="p">[]</span> <span class="o">=</span>  <span class="p">{</span>
	<span class="p">{</span>
		<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;24c256&quot;</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">),</span>
		<span class="p">.</span><span class="n">platform_data</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">eeprom_info</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;pcf8574a&quot;</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">),</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">pcf_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;cpld_reg0&quot;</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;tlv320aic33&quot;</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;cpld_video&quot;</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;cdce949&quot;</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">),</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">davinci_i2c_platform_data</span> <span class="n">i2c_pdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bus_freq</span>       <span class="o">=</span> <span class="mi">100</span> <span class="cm">/* kHz */</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bus_delay</span>      <span class="o">=</span> <span class="mi">0</span> <span class="cm">/* usec */</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define VCH2CLK_MASK		(BIT_MASK(10) | BIT_MASK(9) | BIT_MASK(8))</span>
<span class="cp">#define VCH2CLK_SYSCLK8		(BIT(9))</span>
<span class="cp">#define VCH2CLK_AUXCLK		(BIT(9) | BIT(8))</span>
<span class="cp">#define VCH3CLK_MASK		(BIT_MASK(14) | BIT_MASK(13) | BIT_MASK(12))</span>
<span class="cp">#define VCH3CLK_SYSCLK8		(BIT(13))</span>
<span class="cp">#define VCH3CLK_AUXCLK		(BIT(14) | BIT(13))</span>

<span class="cp">#define VIDCH2CLK		(BIT(10))</span>
<span class="cp">#define VIDCH3CLK		(BIT(11))</span>
<span class="cp">#define VIDCH1CLK		(BIT(4))</span>
<span class="cp">#define TVP7002_INPUT		(BIT(4))</span>
<span class="cp">#define TVP5147_INPUT		(~BIT(4))</span>
<span class="cp">#define VPIF_INPUT_ONE_CHANNEL	(BIT(5))</span>
<span class="cp">#define VPIF_INPUT_TWO_CHANNEL	(~BIT(5))</span>
<span class="cp">#define TVP5147_CH0		&quot;tvp514x-0&quot;</span>
<span class="cp">#define TVP5147_CH1		&quot;tvp514x-1&quot;</span>

<span class="cm">/* spin lock for updating above registers */</span>
<span class="k">static</span> <span class="n">spinlock_t</span> <span class="n">vpif_reg_lock</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_vpif_clock</span><span class="p">(</span><span class="kt">int</span> <span class="n">mux_mode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpld_client</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="cm">/* disable the clock */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpif_reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">DAVINCI_SYSMOD_VIRT</span><span class="p">(</span><span class="n">SYSMOD_VSCLKDIS</span><span class="p">));</span>
	<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">VIDCH3CLK</span> <span class="o">|</span> <span class="n">VIDCH2CLK</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">DAVINCI_SYSMOD_VIRT</span><span class="p">(</span><span class="n">SYSMOD_VSCLKDIS</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpif_reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte</span><span class="p">(</span><span class="n">cpld_client</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mux_mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x40</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte</span><span class="p">(</span><span class="n">cpld_client</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">DAVINCI_SYSMOD_VIRT</span><span class="p">(</span><span class="n">SYSMOD_VIDCLKCTL</span><span class="p">));</span>
	<span class="n">value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">VCH2CLK_MASK</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">VCH3CLK_MASK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hd</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">VCH2CLK_SYSCLK8</span> <span class="o">|</span> <span class="n">VCH3CLK_SYSCLK8</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">VCH2CLK_AUXCLK</span> <span class="o">|</span> <span class="n">VCH3CLK_AUXCLK</span><span class="p">);</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">DAVINCI_SYSMOD_VIRT</span><span class="p">(</span><span class="n">SYSMOD_VIDCLKCTL</span><span class="p">));</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpif_reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">DAVINCI_SYSMOD_VIRT</span><span class="p">(</span><span class="n">SYSMOD_VSCLKDIS</span><span class="p">));</span>
	<span class="cm">/* enable the clock */</span>
	<span class="n">value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">VIDCH3CLK</span> <span class="o">|</span> <span class="n">VIDCH2CLK</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">DAVINCI_SYSMOD_VIRT</span><span class="p">(</span><span class="n">SYSMOD_VSCLKDIS</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpif_reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vpif_subdev_info</span> <span class="n">dm646x_vpif_subdev</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;adv7343&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">board_info</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;adv7343&quot;</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;ths7303&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">board_info</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;ths7303&quot;</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">output</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Composite&quot;</span><span class="p">,</span>
	<span class="s">&quot;Component&quot;</span><span class="p">,</span>
	<span class="s">&quot;S-Video&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vpif_display_config</span> <span class="n">dm646x_vpif_display_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set_clock</span>	<span class="o">=</span> <span class="n">set_vpif_clock</span><span class="p">,</span>
	<span class="p">.</span><span class="n">subdevinfo</span>	<span class="o">=</span> <span class="n">dm646x_vpif_subdev</span><span class="p">,</span>
	<span class="p">.</span><span class="n">subdev_count</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dm646x_vpif_subdev</span><span class="p">),</span>
	<span class="p">.</span><span class="n">output</span>		<span class="o">=</span> <span class="n">output</span><span class="p">,</span>
	<span class="p">.</span><span class="n">output_count</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">output</span><span class="p">),</span>
	<span class="p">.</span><span class="n">card_name</span>	<span class="o">=</span> <span class="s">&quot;DM646x EVM&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * setup_vpif_input_path()</span>
<span class="cm"> * @channel: channel id (0 - CH0, 1 - CH1)</span>
<span class="cm"> * @sub_dev_name: ptr sub device name</span>
<span class="cm"> *</span>
<span class="cm"> * This will set vpif input to capture data from tvp514x or</span>
<span class="cm"> * tvp7002.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">setup_vpif_input_path</span><span class="p">(</span><span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sub_dev_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* for channel 1, we don&#39;t do anything */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpld_client</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte</span><span class="p">(</span><span class="n">cpld_client</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">sub_dev_name</span><span class="p">,</span> <span class="n">TVP5147_CH0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">sub_dev_name</span><span class="p">,</span> <span class="n">TVP5147_CH1</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="n">TVP5147_INPUT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TVP7002_INPUT</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte</span><span class="p">(</span><span class="n">cpld_client</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * setup_vpif_input_channel_mode()</span>
<span class="cm"> * @mux_mode:  mux mode. 0 - 1 channel or (1) - 2 channel</span>
<span class="cm"> *</span>
<span class="cm"> * This will setup input mode to one channel (TVP7002) or 2 channel (TVP5147)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">setup_vpif_input_channel_mode</span><span class="p">(</span><span class="kt">int</span> <span class="n">mux_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpld_client</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte</span><span class="p">(</span><span class="n">cpld_client</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpif_reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">DAVINCI_SYSMOD_VIRT</span><span class="p">(</span><span class="n">SYSMOD_VIDCLKCTL</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mux_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="n">VPIF_INPUT_TWO_CHANNEL</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="n">VIDCH1CLK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">VPIF_INPUT_ONE_CHANNEL</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VIDCH1CLK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">DAVINCI_SYSMOD_VIRT</span><span class="p">(</span><span class="n">SYSMOD_VIDCLKCTL</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpif_reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte</span><span class="p">(</span><span class="n">cpld_client</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tvp514x_platform_data</span> <span class="n">tvp5146_pdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">clk_polarity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hs_polarity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vs_polarity</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">};</span>

<span class="cp">#define TVP514X_STD_ALL (V4L2_STD_NTSC | V4L2_STD_PAL)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vpif_subdev_info</span> <span class="n">vpif_capture_sdev_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">TVP5147_CH0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">board_info</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;tvp5146&quot;</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">),</span>
			<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tvp5146_pdata</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">INPUT_CVBS_VI2B</span><span class="p">,</span>
		<span class="p">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">OUTPUT_10BIT_422_EMBEDDED_SYNC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">can_route</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vpif_if</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">if_type</span> <span class="o">=</span> <span class="n">VPIF_IF_BT656</span><span class="p">,</span>
			<span class="p">.</span><span class="n">hd_pol</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">vd_pol</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">fid_pol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">TVP5147_CH1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">board_info</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;tvp5146&quot;</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">),</span>
			<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tvp5146_pdata</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">INPUT_SVIDEO_VI2C_VI1C</span><span class="p">,</span>
		<span class="p">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">OUTPUT_10BIT_422_EMBEDDED_SYNC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">can_route</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vpif_if</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">if_type</span> <span class="o">=</span> <span class="n">VPIF_IF_BT656</span><span class="p">,</span>
			<span class="p">.</span><span class="n">hd_pol</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">vd_pol</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">fid_pol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">vpif_input</span> <span class="n">dm6467_ch0_inputs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">input</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Composite&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_INPUT_TYPE_CAMERA</span><span class="p">,</span>
			<span class="p">.</span><span class="n">std</span> <span class="o">=</span> <span class="n">TVP514X_STD_ALL</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">subdev_name</span> <span class="o">=</span> <span class="n">TVP5147_CH0</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">vpif_input</span> <span class="n">dm6467_ch1_inputs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
       <span class="p">{</span>
		<span class="p">.</span><span class="n">input</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;S-Video&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_INPUT_TYPE_CAMERA</span><span class="p">,</span>
			<span class="p">.</span><span class="n">std</span> <span class="o">=</span> <span class="n">TVP514X_STD_ALL</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">subdev_name</span> <span class="o">=</span> <span class="n">TVP5147_CH1</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vpif_capture_config</span> <span class="n">dm646x_vpif_capture_cfg</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">setup_input_path</span> <span class="o">=</span> <span class="n">setup_vpif_input_path</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup_input_channel_mode</span> <span class="o">=</span> <span class="n">setup_vpif_input_channel_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">subdev_info</span> <span class="o">=</span> <span class="n">vpif_capture_sdev_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">subdev_count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">vpif_capture_sdev_info</span><span class="p">),</span>
	<span class="p">.</span><span class="n">chan_config</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="n">dm6467_ch0_inputs</span><span class="p">,</span>
		<span class="p">.</span><span class="n">input_count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dm6467_ch0_inputs</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">chan_config</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="n">dm6467_ch1_inputs</span><span class="p">,</span>
		<span class="p">.</span><span class="n">input_count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dm6467_ch1_inputs</span><span class="p">),</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">evm_init_video</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpif_reg_lock</span><span class="p">);</span>

	<span class="n">dm646x_setup_vpif</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dm646x_vpif_display_config</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">dm646x_vpif_capture_cfg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">evm_init_i2c</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">davinci_init_i2c</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c_pdata</span><span class="p">);</span>
	<span class="n">i2c_add_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dm6467evm_cpld_driver</span><span class="p">);</span>
	<span class="n">i2c_register_board_info</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">i2c_info</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">i2c_info</span><span class="p">));</span>
	<span class="n">evm_init_cpld</span><span class="p">();</span>
	<span class="n">evm_init_video</span><span class="p">();</span>
<span class="p">}</span>

<span class="cp">#define CDCE949_XIN_RATE	27000000</span>

<span class="cm">/* CDCE949 support - &quot;lpsc&quot; field is overridden to work as clock number */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">cdce_clk_in</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;cdce_xin&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate</span>	<span class="o">=</span> <span class="n">CDCE949_XIN_RATE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk_lookup</span> <span class="n">cdce_clks</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">CLK</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;xin&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cdce_clk_in</span><span class="p">),</span>
	<span class="n">CLK</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">cdce_clk_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">clk_lookup</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">cdce_clks</span><span class="p">;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">;</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clk</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">;</span>
		<span class="n">clkdev_add</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="n">clk_register</span><span class="p">(</span><span class="n">clk</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define DM6467T_EVM_REF_FREQ		33000000</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">davinci_map_io</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dm646x_init</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">machine_is_davinci_dm6467tevm</span><span class="p">())</span>
		<span class="n">davinci_set_refclk_rate</span><span class="p">(</span><span class="n">DM6467T_EVM_REF_FREQ</span><span class="p">);</span>

	<span class="n">cdce_clk_init</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">davinci_uart_config</span> <span class="n">uart_config</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">enabled_uarts</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="cp">#define DM646X_EVM_PHY_ID		&quot;davinci_mdio-0:01&quot;</span>
<span class="cm">/*</span>
<span class="cm"> * The following EDMA channels/slots are not being used by drivers (for</span>
<span class="cm"> * example: Timer, GPIO, UART events etc) on dm646x, hence they are being</span>
<span class="cm"> * reserved for codecs on the DSP side.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">s16</span> <span class="n">dm646x_dma_rsv_chans</span><span class="p">[][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* (offset, number) */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">4</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">13</span><span class="p">,</span>  <span class="mi">3</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">24</span><span class="p">,</span>  <span class="mi">4</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">30</span><span class="p">,</span>  <span class="mi">2</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">54</span><span class="p">,</span>  <span class="mi">3</span><span class="p">},</span>
	<span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">s16</span> <span class="n">dm646x_dma_rsv_slots</span><span class="p">[][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* (offset, number) */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">4</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">13</span><span class="p">,</span>  <span class="mi">3</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">24</span><span class="p">,</span>  <span class="mi">4</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">30</span><span class="p">,</span>  <span class="mi">2</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">54</span><span class="p">,</span>  <span class="mi">3</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">128</span><span class="p">,</span> <span class="mi">384</span><span class="p">},</span>
	<span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">edma_rsv_info</span> <span class="n">dm646x_edma_rsv</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">rsv_chans</span>	<span class="o">=</span> <span class="n">dm646x_dma_rsv_chans</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rsv_slots</span>	<span class="o">=</span> <span class="n">dm646x_dma_rsv_slots</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">void</span> <span class="nf">evm_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">davinci_soc_info</span> <span class="o">*</span><span class="n">soc_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">davinci_soc_info</span><span class="p">;</span>

	<span class="n">evm_init_i2c</span><span class="p">();</span>
	<span class="n">davinci_serial_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uart_config</span><span class="p">);</span>
	<span class="n">dm646x_init_mcasp0</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dm646x_evm_snd_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">dm646x_init_mcasp1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dm646x_evm_snd_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">machine_is_davinci_dm6467tevm</span><span class="p">())</span>
		<span class="n">davinci_nand_data</span><span class="p">.</span><span class="n">timing</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dm6467tevm_nandflash_timing</span><span class="p">;</span>

	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">davinci_nand_device</span><span class="p">);</span>

	<span class="n">dm646x_init_edma</span><span class="p">(</span><span class="n">dm646x_edma_rsv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_ATA</span><span class="p">)</span>
		<span class="n">davinci_init_ide</span><span class="p">();</span>

	<span class="n">soc_info</span><span class="o">-&gt;</span><span class="n">emac_pdata</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">DM646X_EVM_PHY_ID</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">MACHINE_START</span><span class="p">(</span><span class="n">DAVINCI_DM6467_EVM</span><span class="p">,</span> <span class="s">&quot;DaVinci DM646x EVM&quot;</span><span class="p">)</span>
	<span class="p">.</span><span class="n">atag_offset</span>  <span class="o">=</span> <span class="mh">0x100</span><span class="p">,</span>
	<span class="p">.</span><span class="n">map_io</span>       <span class="o">=</span> <span class="n">davinci_map_io</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_irq</span>     <span class="o">=</span> <span class="n">davinci_irq_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">timer</span>        <span class="o">=</span> <span class="o">&amp;</span><span class="n">davinci_timer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_machine</span> <span class="o">=</span> <span class="n">evm_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_late</span>	<span class="o">=</span> <span class="n">davinci_init_late</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_zone_size</span>	<span class="o">=</span> <span class="n">SZ_128M</span><span class="p">,</span>
	<span class="p">.</span><span class="n">restart</span>	<span class="o">=</span> <span class="n">davinci_restart</span><span class="p">,</span>
<span class="n">MACHINE_END</span>

<span class="n">MACHINE_START</span><span class="p">(</span><span class="n">DAVINCI_DM6467TEVM</span><span class="p">,</span> <span class="s">&quot;DaVinci DM6467T EVM&quot;</span><span class="p">)</span>
	<span class="p">.</span><span class="n">atag_offset</span>  <span class="o">=</span> <span class="mh">0x100</span><span class="p">,</span>
	<span class="p">.</span><span class="n">map_io</span>       <span class="o">=</span> <span class="n">davinci_map_io</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_irq</span>     <span class="o">=</span> <span class="n">davinci_irq_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">timer</span>        <span class="o">=</span> <span class="o">&amp;</span><span class="n">davinci_timer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_machine</span> <span class="o">=</span> <span class="n">evm_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_late</span>	<span class="o">=</span> <span class="n">davinci_init_late</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_zone_size</span>	<span class="o">=</span> <span class="n">SZ_128M</span><span class="p">,</span>
	<span class="p">.</span><span class="n">restart</span>	<span class="o">=</span> <span class="n">davinci_restart</span><span class="p">,</span>
<span class="n">MACHINE_END</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
