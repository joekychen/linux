<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › mach-davinci › board-da850-evm.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>board-da850-evm.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * TI DA850/OMAP-L138 EVM board</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2009 Texas Instruments Incorporated - http://www.ti.com/</span>
<span class="cm"> *</span>
<span class="cm"> * Derived from: arch/arm/mach-davinci/board-da830-evm.c</span>
<span class="cm"> * Original Copyrights follow:</span>
<span class="cm"> *</span>
<span class="cm"> * 2007, 2009 (c) MontaVista Software, Inc. This file is licensed under</span>
<span class="cm"> * the terms of the GNU General Public License version 2. This program</span>
<span class="cm"> * is licensed &quot;as is&quot; without any warranty of any kind, whether express</span>
<span class="cm"> * or implied.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/i2c/at24.h&gt;</span>
<span class="cp">#include &lt;linux/i2c/pca953x.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/tps6507x.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/gpio_keys.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/mtd.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/nand.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/partitions.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/physmap.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/machine.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/tps6507x.h&gt;</span>
<span class="cp">#include &lt;linux/input/tps6507x-ts.h&gt;</span>
<span class="cp">#include &lt;linux/spi/spi.h&gt;</span>
<span class="cp">#include &lt;linux/spi/flash.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/wl12xx.h&gt;</span>

<span class="cp">#include &lt;asm/mach-types.h&gt;</span>
<span class="cp">#include &lt;asm/mach/arch.h&gt;</span>
<span class="cp">#include &lt;asm/system_info.h&gt;</span>

<span class="cp">#include &lt;mach/cp_intc.h&gt;</span>
<span class="cp">#include &lt;mach/da8xx.h&gt;</span>
<span class="cp">#include &lt;mach/nand.h&gt;</span>
<span class="cp">#include &lt;mach/mux.h&gt;</span>
<span class="cp">#include &lt;mach/aemif.h&gt;</span>
<span class="cp">#include &lt;mach/spi.h&gt;</span>

<span class="cp">#define DA850_EVM_PHY_ID		&quot;davinci_mdio-0:00&quot;</span>
<span class="cp">#define DA850_LCD_PWR_PIN		GPIO_TO_PIN(2, 8)</span>
<span class="cp">#define DA850_LCD_BL_PIN		GPIO_TO_PIN(2, 15)</span>

<span class="cp">#define DA850_MMCSD_CD_PIN		GPIO_TO_PIN(4, 0)</span>
<span class="cp">#define DA850_MMCSD_WP_PIN		GPIO_TO_PIN(4, 1)</span>

<span class="cp">#define DA850_WLAN_EN			GPIO_TO_PIN(6, 9)</span>
<span class="cp">#define DA850_WLAN_IRQ			GPIO_TO_PIN(6, 10)</span>

<span class="cp">#define DA850_MII_MDIO_CLKEN_PIN	GPIO_TO_PIN(2, 6)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mtd_partition</span> <span class="n">da850evm_spiflash_part</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;UBL&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">SZ_64K</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask_flags</span> <span class="o">=</span> <span class="n">MTD_WRITEABLE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;U-Boot&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">MTDPART_OFS_APPEND</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">SZ_512K</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask_flags</span> <span class="o">=</span> <span class="n">MTD_WRITEABLE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;U-Boot-Env&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">MTDPART_OFS_APPEND</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">SZ_64K</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask_flags</span> <span class="o">=</span> <span class="n">MTD_WRITEABLE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Kernel&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">MTDPART_OFS_APPEND</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">SZ_2M</span> <span class="o">+</span> <span class="n">SZ_512K</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Filesystem&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">MTDPART_OFS_APPEND</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">SZ_4M</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MAC-Address&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">SZ_8M</span> <span class="o">-</span> <span class="n">SZ_64K</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">SZ_64K</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask_flags</span> <span class="o">=</span> <span class="n">MTD_WRITEABLE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">flash_platform_data</span> <span class="n">da850evm_spiflash_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;m25p80&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">parts</span>		<span class="o">=</span> <span class="n">da850evm_spiflash_part</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nr_parts</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">da850evm_spiflash_part</span><span class="p">),</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="s">&quot;m25p64&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">davinci_spi_config</span> <span class="n">da850evm_spiflash_cfg</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">io_type</span>	<span class="o">=</span> <span class="n">SPI_IO_TYPE_DMA</span><span class="p">,</span>
	<span class="p">.</span><span class="n">c2tdelay</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">t2cdelay</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">spi_board_info</span> <span class="n">da850evm_spi_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">modalias</span>		<span class="o">=</span> <span class="s">&quot;m25p80&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">platform_data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">da850evm_spiflash_data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">controller_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">da850evm_spiflash_cfg</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span>			<span class="o">=</span> <span class="n">SPI_MODE_0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_speed_hz</span>		<span class="o">=</span> <span class="mi">30000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bus_num</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chip_select</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_MTD</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">da850_evm_m25p80_notify_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">mac_addr</span> <span class="o">=</span> <span class="n">davinci_soc_info</span><span class="p">.</span><span class="n">emac_pdata</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">retlen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">mtd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;MAC-Address&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mtd_read</span><span class="p">(</span><span class="n">mtd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retlen</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retlen</span> <span class="o">==</span> <span class="n">ETH_ALEN</span><span class="p">)</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Read MAC addr from SPI Flash: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mac_addr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mtd_notifier</span> <span class="n">da850evm_spi_notifier</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">add</span>	<span class="o">=</span> <span class="n">da850_evm_m25p80_notify_add</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">da850_evm_setup_mac_addr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">register_mtd_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">da850evm_spi_notifier</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">da850_evm_setup_mac_addr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mtd_partition</span> <span class="n">da850_evm_norflash_partition</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>           <span class="o">=</span> <span class="s">&quot;bootloaders + env&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>         <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>           <span class="o">=</span> <span class="n">SZ_512K</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask_flags</span>     <span class="o">=</span> <span class="n">MTD_WRITEABLE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>           <span class="o">=</span> <span class="s">&quot;kernel&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>         <span class="o">=</span> <span class="n">MTDPART_OFS_APPEND</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>           <span class="o">=</span> <span class="n">SZ_2M</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask_flags</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>           <span class="o">=</span> <span class="s">&quot;filesystem&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>         <span class="o">=</span> <span class="n">MTDPART_OFS_APPEND</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>           <span class="o">=</span> <span class="n">MTDPART_SIZ_FULL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask_flags</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">physmap_flash_data</span> <span class="n">da850_evm_norflash_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">width</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">parts</span>		<span class="o">=</span> <span class="n">da850_evm_norflash_partition</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nr_parts</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">da850_evm_norflash_partition</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">da850_evm_norflash_resource</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">DA8XX_AEMIF_CS2_BASE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">DA8XX_AEMIF_CS2_BASE</span> <span class="o">+</span> <span class="n">SZ_32M</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">da850_evm_norflash_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;physmap-flash&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">da850_evm_norflash_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">da850_evm_norflash_resource</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">davinci_pm_config</span> <span class="n">da850_pm_pdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">sleepcount</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">da850_pm_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>           <span class="o">=</span> <span class="s">&quot;pm-davinci&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">da850_pm_pdata</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">id</span>             <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* DA850/OMAP-L138 EVM includes a 512 MByte large-page NAND flash</span>
<span class="cm"> * (128K blocks). It may be used instead of the (default) SPI flash</span>
<span class="cm"> * to boot, using TI&#39;s tools to install the secondary boot loader</span>
<span class="cm"> * (UBL) and U-Boot.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mtd_partition</span> <span class="n">da850_evm_nandflash_partition</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;u-boot env&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="n">SZ_128K</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask_flags</span>	<span class="o">=</span> <span class="n">MTD_WRITEABLE</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;UBL&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="n">MTDPART_OFS_APPEND</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="n">SZ_128K</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask_flags</span>	<span class="o">=</span> <span class="n">MTD_WRITEABLE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;u-boot&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="n">MTDPART_OFS_APPEND</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">SZ_128K</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask_flags</span>	<span class="o">=</span> <span class="n">MTD_WRITEABLE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;kernel&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mh">0x200000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="n">SZ_2M</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask_flags</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;filesystem&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="n">MTDPART_OFS_APPEND</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="n">MTDPART_SIZ_FULL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask_flags</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">davinci_aemif_timing</span> <span class="n">da850_evm_nandflash_timing</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">wsetup</span>		<span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wstrobe</span>	<span class="o">=</span> <span class="mi">21</span><span class="p">,</span>
	<span class="p">.</span><span class="n">whold</span>		<span class="o">=</span> <span class="mi">14</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rsetup</span>		<span class="o">=</span> <span class="mi">19</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rstrobe</span>	<span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rhold</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ta</span>		<span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">davinci_nand_pdata</span> <span class="n">da850_evm_nandflash_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parts</span>		<span class="o">=</span> <span class="n">da850_evm_nandflash_partition</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nr_parts</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">da850_evm_nandflash_partition</span><span class="p">),</span>
	<span class="p">.</span><span class="n">ecc_mode</span>	<span class="o">=</span> <span class="n">NAND_ECC_HW</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ecc_bits</span>	<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bbt_options</span>	<span class="o">=</span> <span class="n">NAND_BBT_USE_FLASH</span><span class="p">,</span>
	<span class="p">.</span><span class="n">timing</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">da850_evm_nandflash_timing</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">da850_evm_nandflash_resource</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">DA8XX_AEMIF_CS3_BASE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">DA8XX_AEMIF_CS3_BASE</span> <span class="o">+</span> <span class="n">SZ_512K</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">SZ_1K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">DA8XX_AEMIF_CTL_BASE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">DA8XX_AEMIF_CTL_BASE</span> <span class="o">+</span> <span class="n">SZ_32K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">da850_evm_nandflash_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;davinci_nand&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">da850_evm_nandflash_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">da850_evm_nandflash_resource</span><span class="p">),</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">da850_evm_nandflash_resource</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">da850_evm_devices</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">da850_evm_nandflash_device</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">da850_evm_norflash_device</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define DA8XX_AEMIF_CE2CFG_OFFSET	0x10</span>
<span class="cp">#define DA8XX_AEMIF_ASIZE_16BIT		0x1</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">da850_evm_init_nor</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">aemif_addr</span><span class="p">;</span>

	<span class="n">aemif_addr</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">DA8XX_AEMIF_CTL_BASE</span><span class="p">,</span> <span class="n">SZ_32K</span><span class="p">);</span>

	<span class="cm">/* Configure data bus width of CS2 to 16 bit */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">aemif_addr</span> <span class="o">+</span> <span class="n">DA8XX_AEMIF_CE2CFG_OFFSET</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">DA8XX_AEMIF_ASIZE_16BIT</span><span class="p">,</span>
		<span class="n">aemif_addr</span> <span class="o">+</span> <span class="n">DA8XX_AEMIF_CE2CFG_OFFSET</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">aemif_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">short</span> <span class="n">da850_evm_nand_pins</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">DA850_EMA_D_0</span><span class="p">,</span> <span class="n">DA850_EMA_D_1</span><span class="p">,</span> <span class="n">DA850_EMA_D_2</span><span class="p">,</span> <span class="n">DA850_EMA_D_3</span><span class="p">,</span>
	<span class="n">DA850_EMA_D_4</span><span class="p">,</span> <span class="n">DA850_EMA_D_5</span><span class="p">,</span> <span class="n">DA850_EMA_D_6</span><span class="p">,</span> <span class="n">DA850_EMA_D_7</span><span class="p">,</span>
	<span class="n">DA850_EMA_A_1</span><span class="p">,</span> <span class="n">DA850_EMA_A_2</span><span class="p">,</span> <span class="n">DA850_NEMA_CS_3</span><span class="p">,</span> <span class="n">DA850_NEMA_CS_4</span><span class="p">,</span>
	<span class="n">DA850_NEMA_WE</span><span class="p">,</span> <span class="n">DA850_NEMA_OE</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">short</span> <span class="n">da850_evm_nor_pins</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">DA850_EMA_BA_1</span><span class="p">,</span> <span class="n">DA850_EMA_CLK</span><span class="p">,</span> <span class="n">DA850_EMA_WAIT_1</span><span class="p">,</span> <span class="n">DA850_NEMA_CS_2</span><span class="p">,</span>
	<span class="n">DA850_NEMA_WE</span><span class="p">,</span> <span class="n">DA850_NEMA_OE</span><span class="p">,</span> <span class="n">DA850_EMA_D_0</span><span class="p">,</span> <span class="n">DA850_EMA_D_1</span><span class="p">,</span>
	<span class="n">DA850_EMA_D_2</span><span class="p">,</span> <span class="n">DA850_EMA_D_3</span><span class="p">,</span> <span class="n">DA850_EMA_D_4</span><span class="p">,</span> <span class="n">DA850_EMA_D_5</span><span class="p">,</span>
	<span class="n">DA850_EMA_D_6</span><span class="p">,</span> <span class="n">DA850_EMA_D_7</span><span class="p">,</span> <span class="n">DA850_EMA_D_8</span><span class="p">,</span> <span class="n">DA850_EMA_D_9</span><span class="p">,</span>
	<span class="n">DA850_EMA_D_10</span><span class="p">,</span> <span class="n">DA850_EMA_D_11</span><span class="p">,</span> <span class="n">DA850_EMA_D_12</span><span class="p">,</span> <span class="n">DA850_EMA_D_13</span><span class="p">,</span>
	<span class="n">DA850_EMA_D_14</span><span class="p">,</span> <span class="n">DA850_EMA_D_15</span><span class="p">,</span> <span class="n">DA850_EMA_A_0</span><span class="p">,</span> <span class="n">DA850_EMA_A_1</span><span class="p">,</span>
	<span class="n">DA850_EMA_A_2</span><span class="p">,</span> <span class="n">DA850_EMA_A_3</span><span class="p">,</span> <span class="n">DA850_EMA_A_4</span><span class="p">,</span> <span class="n">DA850_EMA_A_5</span><span class="p">,</span>
	<span class="n">DA850_EMA_A_6</span><span class="p">,</span> <span class="n">DA850_EMA_A_7</span><span class="p">,</span> <span class="n">DA850_EMA_A_8</span><span class="p">,</span> <span class="n">DA850_EMA_A_9</span><span class="p">,</span>
	<span class="n">DA850_EMA_A_10</span><span class="p">,</span> <span class="n">DA850_EMA_A_11</span><span class="p">,</span> <span class="n">DA850_EMA_A_12</span><span class="p">,</span> <span class="n">DA850_EMA_A_13</span><span class="p">,</span>
	<span class="n">DA850_EMA_A_14</span><span class="p">,</span> <span class="n">DA850_EMA_A_15</span><span class="p">,</span> <span class="n">DA850_EMA_A_16</span><span class="p">,</span> <span class="n">DA850_EMA_A_17</span><span class="p">,</span>
	<span class="n">DA850_EMA_A_18</span><span class="p">,</span> <span class="n">DA850_EMA_A_19</span><span class="p">,</span> <span class="n">DA850_EMA_A_20</span><span class="p">,</span> <span class="n">DA850_EMA_A_21</span><span class="p">,</span>
	<span class="n">DA850_EMA_A_22</span><span class="p">,</span> <span class="n">DA850_EMA_A_23</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span>
<span class="p">};</span>

<span class="cp">#if defined(CONFIG_MMC_DAVINCI) || \</span>
<span class="cp">    defined(CONFIG_MMC_DAVINCI_MODULE)</span>
<span class="cp">#define HAS_MMC 1</span>
<span class="cp">#else</span>
<span class="cp">#define HAS_MMC 0</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">da850_evm_setup_nor_nand</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HAS_MMC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">davinci_cfg_reg_list</span><span class="p">(</span><span class="n">da850_evm_nand_pins</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;da850_evm_init: nand mux setup failed: &quot;</span>
					<span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">davinci_cfg_reg_list</span><span class="p">(</span><span class="n">da850_evm_nor_pins</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;da850_evm_init: nor mux setup failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ret</span><span class="p">);</span>

		<span class="n">da850_evm_init_nor</span><span class="p">();</span>

		<span class="n">platform_add_devices</span><span class="p">(</span><span class="n">da850_evm_devices</span><span class="p">,</span>
					<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">da850_evm_devices</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_DA850_UI_RMII</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">da850_evm_setup_emac_rmii</span><span class="p">(</span><span class="kt">int</span> <span class="n">rmii_sel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">davinci_soc_info</span> <span class="o">*</span><span class="n">soc_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">davinci_soc_info</span><span class="p">;</span>

	<span class="n">soc_info</span><span class="o">-&gt;</span><span class="n">emac_pdata</span><span class="o">-&gt;</span><span class="n">rmii_en</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">gpio_set_value_cansleep</span><span class="p">(</span><span class="n">rmii_sel</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">da850_evm_setup_emac_rmii</span><span class="p">(</span><span class="kt">int</span> <span class="n">rmii_sel</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="cp">#endif</span>


<span class="cp">#define DA850_KEYS_DEBOUNCE_MS	10</span>
<span class="cm">/*</span>
<span class="cm"> * At 200ms polling interval it is possible to miss an</span>
<span class="cm"> * event by tapping very lightly on the push button but most</span>
<span class="cm"> * pushes do result in an event; longer intervals require the</span>
<span class="cm"> * user to hold the button whereas shorter intervals require</span>
<span class="cm"> * more CPU time for polling.</span>
<span class="cm"> */</span>
<span class="cp">#define DA850_GPIO_KEYS_POLL_MS	200</span>

<span class="k">enum</span> <span class="n">da850_evm_ui_exp_pins</span> <span class="p">{</span>
	<span class="n">DA850_EVM_UI_EXP_SEL_C</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="n">DA850_EVM_UI_EXP_SEL_B</span><span class="p">,</span>
	<span class="n">DA850_EVM_UI_EXP_SEL_A</span><span class="p">,</span>
	<span class="n">DA850_EVM_UI_EXP_PB8</span><span class="p">,</span>
	<span class="n">DA850_EVM_UI_EXP_PB7</span><span class="p">,</span>
	<span class="n">DA850_EVM_UI_EXP_PB6</span><span class="p">,</span>
	<span class="n">DA850_EVM_UI_EXP_PB5</span><span class="p">,</span>
	<span class="n">DA850_EVM_UI_EXP_PB4</span><span class="p">,</span>
	<span class="n">DA850_EVM_UI_EXP_PB3</span><span class="p">,</span>
	<span class="n">DA850_EVM_UI_EXP_PB2</span><span class="p">,</span>
	<span class="n">DA850_EVM_UI_EXP_PB1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">da850_evm_ui_exp</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">DA850_EVM_UI_EXP_SEL_C</span><span class="p">]</span>        <span class="o">=</span> <span class="s">&quot;sel_c&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DA850_EVM_UI_EXP_SEL_B</span><span class="p">]</span>        <span class="o">=</span> <span class="s">&quot;sel_b&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DA850_EVM_UI_EXP_SEL_A</span><span class="p">]</span>        <span class="o">=</span> <span class="s">&quot;sel_a&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DA850_EVM_UI_EXP_PB8</span><span class="p">]</span>          <span class="o">=</span> <span class="s">&quot;pb8&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DA850_EVM_UI_EXP_PB7</span><span class="p">]</span>          <span class="o">=</span> <span class="s">&quot;pb7&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DA850_EVM_UI_EXP_PB6</span><span class="p">]</span>          <span class="o">=</span> <span class="s">&quot;pb6&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DA850_EVM_UI_EXP_PB5</span><span class="p">]</span>          <span class="o">=</span> <span class="s">&quot;pb5&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DA850_EVM_UI_EXP_PB4</span><span class="p">]</span>          <span class="o">=</span> <span class="s">&quot;pb4&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DA850_EVM_UI_EXP_PB3</span><span class="p">]</span>          <span class="o">=</span> <span class="s">&quot;pb3&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DA850_EVM_UI_EXP_PB2</span><span class="p">]</span>          <span class="o">=</span> <span class="s">&quot;pb2&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DA850_EVM_UI_EXP_PB1</span><span class="p">]</span>          <span class="o">=</span> <span class="s">&quot;pb1&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define DA850_N_UI_PB		8</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio_keys_button</span> <span class="n">da850_evm_ui_keys</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="n">DA850_N_UI_PB</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">type</span>			<span class="o">=</span> <span class="n">EV_KEY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">active_low</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">wakeup</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">debounce_interval</span>	<span class="o">=</span> <span class="n">DA850_KEYS_DEBOUNCE_MS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">code</span>			<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="cm">/* assigned at runtime */</span>
		<span class="p">.</span><span class="n">gpio</span>			<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="cm">/* assigned at runtime */</span>
		<span class="p">.</span><span class="n">desc</span>			<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="cm">/* assigned at runtime */</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio_keys_platform_data</span> <span class="n">da850_evm_ui_keys_pdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">buttons</span> <span class="o">=</span> <span class="n">da850_evm_ui_keys</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nbuttons</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">da850_evm_ui_keys</span><span class="p">),</span>
	<span class="p">.</span><span class="n">poll_interval</span> <span class="o">=</span> <span class="n">DA850_GPIO_KEYS_POLL_MS</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">da850_evm_ui_keys_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;gpio-keys-polled&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">da850_evm_ui_keys_pdata</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">da850_evm_ui_keys_init</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">gpio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gpio_keys_button</span> <span class="o">*</span><span class="n">button</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DA850_N_UI_PB</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">button</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">da850_evm_ui_keys</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">button</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">KEY_F8</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">button</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span>
				<span class="n">da850_evm_ui_exp</span><span class="p">[</span><span class="n">DA850_EVM_UI_EXP_PB8</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
		<span class="n">button</span><span class="o">-&gt;</span><span class="n">gpio</span> <span class="o">=</span> <span class="n">gpio</span> <span class="o">+</span> <span class="n">DA850_EVM_UI_EXP_PB8</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">da850_evm_ui_expander_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">gpio</span><span class="p">,</span>
						<span class="kt">unsigned</span> <span class="n">ngpio</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sel_a</span><span class="p">,</span> <span class="n">sel_b</span><span class="p">,</span> <span class="n">sel_c</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">sel_a</span> <span class="o">=</span> <span class="n">gpio</span> <span class="o">+</span> <span class="n">DA850_EVM_UI_EXP_SEL_A</span><span class="p">;</span>
	<span class="n">sel_b</span> <span class="o">=</span> <span class="n">gpio</span> <span class="o">+</span> <span class="n">DA850_EVM_UI_EXP_SEL_B</span><span class="p">;</span>
	<span class="n">sel_c</span> <span class="o">=</span> <span class="n">gpio</span> <span class="o">+</span> <span class="n">DA850_EVM_UI_EXP_SEL_C</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">sel_a</span><span class="p">,</span> <span class="n">da850_evm_ui_exp</span><span class="p">[</span><span class="n">DA850_EVM_UI_EXP_SEL_A</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Cannot open UI expander pin %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sel_a</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exp_setup_sela_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">sel_b</span><span class="p">,</span> <span class="n">da850_evm_ui_exp</span><span class="p">[</span><span class="n">DA850_EVM_UI_EXP_SEL_B</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Cannot open UI expander pin %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sel_b</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exp_setup_selb_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">sel_c</span><span class="p">,</span> <span class="n">da850_evm_ui_exp</span><span class="p">[</span><span class="n">DA850_EVM_UI_EXP_SEL_C</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Cannot open UI expander pin %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sel_c</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exp_setup_selc_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* deselect all functionalities */</span>
	<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">sel_a</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">sel_b</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">sel_c</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">da850_evm_ui_keys_init</span><span class="p">(</span><span class="n">gpio</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">da850_evm_ui_keys_device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Could not register UI GPIO expander push-buttons&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exp_setup_keys_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;DA850/OMAP-L138 EVM UI card detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">da850_evm_setup_nor_nand</span><span class="p">();</span>

	<span class="n">da850_evm_setup_emac_rmii</span><span class="p">(</span><span class="n">sel_a</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">exp_setup_keys_fail:</span>
	<span class="n">gpio_free</span><span class="p">(</span><span class="n">sel_c</span><span class="p">);</span>
<span class="nl">exp_setup_selc_fail:</span>
	<span class="n">gpio_free</span><span class="p">(</span><span class="n">sel_b</span><span class="p">);</span>
<span class="nl">exp_setup_selb_fail:</span>
	<span class="n">gpio_free</span><span class="p">(</span><span class="n">sel_a</span><span class="p">);</span>
<span class="nl">exp_setup_sela_fail:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">da850_evm_ui_expander_teardown</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="n">gpio</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">ngpio</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">da850_evm_ui_keys_device</span><span class="p">);</span>

	<span class="cm">/* deselect all functionalities */</span>
	<span class="n">gpio_set_value_cansleep</span><span class="p">(</span><span class="n">gpio</span> <span class="o">+</span> <span class="n">DA850_EVM_UI_EXP_SEL_C</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">gpio_set_value_cansleep</span><span class="p">(</span><span class="n">gpio</span> <span class="o">+</span> <span class="n">DA850_EVM_UI_EXP_SEL_B</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">gpio_set_value_cansleep</span><span class="p">(</span><span class="n">gpio</span> <span class="o">+</span> <span class="n">DA850_EVM_UI_EXP_SEL_A</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">gpio_free</span><span class="p">(</span><span class="n">gpio</span> <span class="o">+</span> <span class="n">DA850_EVM_UI_EXP_SEL_C</span><span class="p">);</span>
	<span class="n">gpio_free</span><span class="p">(</span><span class="n">gpio</span> <span class="o">+</span> <span class="n">DA850_EVM_UI_EXP_SEL_B</span><span class="p">);</span>
	<span class="n">gpio_free</span><span class="p">(</span><span class="n">gpio</span> <span class="o">+</span> <span class="n">DA850_EVM_UI_EXP_SEL_A</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* assign the baseboard expander&#39;s GPIOs after the UI board&#39;s */</span>
<span class="cp">#define DA850_UI_EXPANDER_N_GPIOS ARRAY_SIZE(da850_evm_ui_exp)</span>
<span class="cp">#define DA850_BB_EXPANDER_GPIO_BASE (DAVINCI_N_GPIO + DA850_UI_EXPANDER_N_GPIOS)</span>

<span class="k">enum</span> <span class="n">da850_evm_bb_exp_pins</span> <span class="p">{</span>
	<span class="n">DA850_EVM_BB_EXP_DEEP_SLEEP_EN</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">DA850_EVM_BB_EXP_SW_RST</span><span class="p">,</span>
	<span class="n">DA850_EVM_BB_EXP_TP_23</span><span class="p">,</span>
	<span class="n">DA850_EVM_BB_EXP_TP_22</span><span class="p">,</span>
	<span class="n">DA850_EVM_BB_EXP_TP_21</span><span class="p">,</span>
	<span class="n">DA850_EVM_BB_EXP_USER_PB1</span><span class="p">,</span>
	<span class="n">DA850_EVM_BB_EXP_USER_LED2</span><span class="p">,</span>
	<span class="n">DA850_EVM_BB_EXP_USER_LED1</span><span class="p">,</span>
	<span class="n">DA850_EVM_BB_EXP_USER_SW1</span><span class="p">,</span>
	<span class="n">DA850_EVM_BB_EXP_USER_SW2</span><span class="p">,</span>
	<span class="n">DA850_EVM_BB_EXP_USER_SW3</span><span class="p">,</span>
	<span class="n">DA850_EVM_BB_EXP_USER_SW4</span><span class="p">,</span>
	<span class="n">DA850_EVM_BB_EXP_USER_SW5</span><span class="p">,</span>
	<span class="n">DA850_EVM_BB_EXP_USER_SW6</span><span class="p">,</span>
	<span class="n">DA850_EVM_BB_EXP_USER_SW7</span><span class="p">,</span>
	<span class="n">DA850_EVM_BB_EXP_USER_SW8</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">da850_evm_bb_exp</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">DA850_EVM_BB_EXP_DEEP_SLEEP_EN</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;deep_sleep_en&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DA850_EVM_BB_EXP_SW_RST</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;sw_rst&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DA850_EVM_BB_EXP_TP_23</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;tp_23&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DA850_EVM_BB_EXP_TP_22</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;tp_22&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DA850_EVM_BB_EXP_TP_21</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;tp_21&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DA850_EVM_BB_EXP_USER_PB1</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;user_pb1&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DA850_EVM_BB_EXP_USER_LED2</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;user_led2&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DA850_EVM_BB_EXP_USER_LED1</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;user_led1&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DA850_EVM_BB_EXP_USER_SW1</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;user_sw1&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DA850_EVM_BB_EXP_USER_SW2</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;user_sw2&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DA850_EVM_BB_EXP_USER_SW3</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;user_sw3&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DA850_EVM_BB_EXP_USER_SW4</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;user_sw4&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DA850_EVM_BB_EXP_USER_SW5</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;user_sw5&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DA850_EVM_BB_EXP_USER_SW6</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;user_sw6&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DA850_EVM_BB_EXP_USER_SW7</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;user_sw7&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">DA850_EVM_BB_EXP_USER_SW8</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;user_sw8&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define DA850_N_BB_USER_SW	8</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio_keys_button</span> <span class="n">da850_evm_bb_keys</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">type</span>			<span class="o">=</span> <span class="n">EV_KEY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">active_low</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">wakeup</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">debounce_interval</span>	<span class="o">=</span> <span class="n">DA850_KEYS_DEBOUNCE_MS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">code</span>			<span class="o">=</span> <span class="n">KEY_PROG1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">desc</span>			<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="cm">/* assigned at runtime */</span>
		<span class="p">.</span><span class="n">gpio</span>			<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="cm">/* assigned at runtime */</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span> <span class="p">...</span> <span class="n">DA850_N_BB_USER_SW</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">type</span>			<span class="o">=</span> <span class="n">EV_SW</span><span class="p">,</span>
		<span class="p">.</span><span class="n">active_low</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">wakeup</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">debounce_interval</span>	<span class="o">=</span> <span class="n">DA850_KEYS_DEBOUNCE_MS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">code</span>			<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="cm">/* assigned at runtime */</span>
		<span class="p">.</span><span class="n">desc</span>			<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="cm">/* assigned at runtime */</span>
		<span class="p">.</span><span class="n">gpio</span>			<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="cm">/* assigned at runtime */</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio_keys_platform_data</span> <span class="n">da850_evm_bb_keys_pdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">buttons</span> <span class="o">=</span> <span class="n">da850_evm_bb_keys</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nbuttons</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">da850_evm_bb_keys</span><span class="p">),</span>
	<span class="p">.</span><span class="n">poll_interval</span> <span class="o">=</span> <span class="n">DA850_GPIO_KEYS_POLL_MS</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">da850_evm_bb_keys_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;gpio-keys-polled&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">da850_evm_bb_keys_pdata</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">da850_evm_bb_keys_init</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">gpio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gpio_keys_button</span> <span class="o">*</span><span class="n">button</span><span class="p">;</span>

	<span class="n">button</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">da850_evm_bb_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">button</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">da850_evm_bb_exp</span><span class="p">[</span><span class="n">DA850_EVM_BB_EXP_USER_PB1</span><span class="p">];</span>
	<span class="n">button</span><span class="o">-&gt;</span><span class="n">gpio</span> <span class="o">=</span> <span class="n">gpio</span> <span class="o">+</span> <span class="n">DA850_EVM_BB_EXP_USER_PB1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DA850_N_BB_USER_SW</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">button</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">da850_evm_bb_keys</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">button</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">SW_LID</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">button</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span>
				<span class="n">da850_evm_bb_exp</span><span class="p">[</span><span class="n">DA850_EVM_BB_EXP_USER_SW1</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
		<span class="n">button</span><span class="o">-&gt;</span><span class="n">gpio</span> <span class="o">=</span> <span class="n">gpio</span> <span class="o">+</span> <span class="n">DA850_EVM_BB_EXP_USER_SW1</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define DA850_N_BB_USER_LED	2</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio_led</span> <span class="n">da850_evm_bb_leds</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="n">DA850_N_BB_USER_LED</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">active_low</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="cm">/* assigned at runtime */</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="cm">/* assigned at runtime */</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio_led_platform_data</span> <span class="n">da850_evm_bb_leds_pdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">leds</span> <span class="o">=</span> <span class="n">da850_evm_bb_leds</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_leds</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">da850_evm_bb_leds</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">da850_evm_bb_leds_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;leds-gpio&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">da850_evm_bb_leds_pdata</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">da850_evm_bb_leds_init</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">gpio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gpio_led</span> <span class="o">*</span><span class="n">led</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DA850_N_BB_USER_LED</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">led</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">da850_evm_bb_leds</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">led</span><span class="o">-&gt;</span><span class="n">gpio</span> <span class="o">=</span> <span class="n">gpio</span> <span class="o">+</span> <span class="n">DA850_EVM_BB_EXP_USER_LED2</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">led</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span>
			<span class="n">da850_evm_bb_exp</span><span class="p">[</span><span class="n">DA850_EVM_BB_EXP_USER_LED2</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">da850_evm_bb_expander_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
						<span class="kt">unsigned</span> <span class="n">gpio</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">ngpio</span><span class="p">,</span>
						<span class="kt">void</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Register the switches and pushbutton on the baseboard as a gpio-keys</span>
<span class="cm">	 * device.</span>
<span class="cm">	 */</span>
	<span class="n">da850_evm_bb_keys_init</span><span class="p">(</span><span class="n">gpio</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">da850_evm_bb_keys_device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Could not register baseboard GPIO expander keys&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">io_exp_setup_sw_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">da850_evm_bb_leds_init</span><span class="p">(</span><span class="n">gpio</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">da850_evm_bb_leds_device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Could not register baseboard GPIO expander LEDS&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">io_exp_setup_leds_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">io_exp_setup_leds_fail:</span>
	<span class="n">platform_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">da850_evm_bb_keys_device</span><span class="p">);</span>
<span class="nl">io_exp_setup_sw_fail:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">da850_evm_bb_expander_teardown</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="n">gpio</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">ngpio</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">da850_evm_bb_leds_device</span><span class="p">);</span>
	<span class="n">platform_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">da850_evm_bb_keys_device</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pca953x_platform_data</span> <span class="n">da850_evm_ui_expander_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">gpio_base</span>	<span class="o">=</span> <span class="n">DAVINCI_N_GPIO</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup</span>		<span class="o">=</span> <span class="n">da850_evm_ui_expander_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">teardown</span>	<span class="o">=</span> <span class="n">da850_evm_ui_expander_teardown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">names</span>		<span class="o">=</span> <span class="n">da850_evm_ui_exp</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pca953x_platform_data</span> <span class="n">da850_evm_bb_expander_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">gpio_base</span>	<span class="o">=</span> <span class="n">DA850_BB_EXPANDER_GPIO_BASE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup</span>		<span class="o">=</span> <span class="n">da850_evm_bb_expander_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">teardown</span>	<span class="o">=</span> <span class="n">da850_evm_bb_expander_teardown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">names</span>		<span class="o">=</span> <span class="n">da850_evm_bb_exp</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">__initdata</span> <span class="n">da850_evm_i2c_devices</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;tlv320aic3x&quot;</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;tca6416&quot;</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">),</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">da850_evm_ui_expander_info</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;tca6416&quot;</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">),</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">da850_evm_bb_expander_info</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">davinci_i2c_platform_data</span> <span class="n">da850_evm_i2c_0_pdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bus_freq</span>	<span class="o">=</span> <span class="mi">100</span><span class="p">,</span>	<span class="cm">/* kHz */</span>
	<span class="p">.</span><span class="n">bus_delay</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* usec */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">davinci_uart_config</span> <span class="n">da850_evm_uart_config</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">enabled_uarts</span> <span class="o">=</span> <span class="mh">0x7</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* davinci da850 evm audio machine driver */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">da850_iis_serializer_direction</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">INACTIVE_MODE</span><span class="p">,</span>	<span class="n">INACTIVE_MODE</span><span class="p">,</span>	<span class="n">INACTIVE_MODE</span><span class="p">,</span>	<span class="n">INACTIVE_MODE</span><span class="p">,</span>
	<span class="n">INACTIVE_MODE</span><span class="p">,</span>	<span class="n">INACTIVE_MODE</span><span class="p">,</span>	<span class="n">INACTIVE_MODE</span><span class="p">,</span>	<span class="n">INACTIVE_MODE</span><span class="p">,</span>
	<span class="n">INACTIVE_MODE</span><span class="p">,</span>	<span class="n">INACTIVE_MODE</span><span class="p">,</span>	<span class="n">INACTIVE_MODE</span><span class="p">,</span>	<span class="n">TX_MODE</span><span class="p">,</span>
	<span class="n">RX_MODE</span><span class="p">,</span>	<span class="n">INACTIVE_MODE</span><span class="p">,</span>	<span class="n">INACTIVE_MODE</span><span class="p">,</span>	<span class="n">INACTIVE_MODE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_platform_data</span> <span class="n">da850_evm_snd_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">tx_dma_offset</span>	<span class="o">=</span> <span class="mh">0x2000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rx_dma_offset</span>	<span class="o">=</span> <span class="mh">0x2000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">op_mode</span>	<span class="o">=</span> <span class="n">DAVINCI_MCASP_IIS_MODE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_serializer</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">da850_iis_serializer_direction</span><span class="p">),</span>
	<span class="p">.</span><span class="n">tdm_slots</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">serial_dir</span>	<span class="o">=</span> <span class="n">da850_iis_serializer_direction</span><span class="p">,</span>
	<span class="p">.</span><span class="n">asp_chan_q</span>	<span class="o">=</span> <span class="n">EVENTQ_0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">version</span>	<span class="o">=</span> <span class="n">MCASP_VERSION_2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">txnumevt</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rxnumevt</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">short</span> <span class="n">da850_evm_mcasp_pins</span><span class="p">[]</span> <span class="n">__initconst</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">DA850_AHCLKX</span><span class="p">,</span> <span class="n">DA850_ACLKX</span><span class="p">,</span> <span class="n">DA850_AFSX</span><span class="p">,</span>
	<span class="n">DA850_AHCLKR</span><span class="p">,</span> <span class="n">DA850_ACLKR</span><span class="p">,</span> <span class="n">DA850_AFSR</span><span class="p">,</span> <span class="n">DA850_AMUTE</span><span class="p">,</span>
	<span class="n">DA850_AXR_11</span><span class="p">,</span> <span class="n">DA850_AXR_12</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">da850_evm_mmc_get_ro</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">gpio_get_value</span><span class="p">(</span><span class="n">DA850_MMCSD_WP_PIN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">da850_evm_mmc_get_cd</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">gpio_get_value</span><span class="p">(</span><span class="n">DA850_MMCSD_CD_PIN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">davinci_mmc_config</span> <span class="n">da850_mmc_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_ro</span>		<span class="o">=</span> <span class="n">da850_evm_mmc_get_ro</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_cd</span>		<span class="o">=</span> <span class="n">da850_evm_mmc_get_cd</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wires</span>		<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_freq</span>	<span class="o">=</span> <span class="mi">50000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">caps</span>		<span class="o">=</span> <span class="n">MMC_CAP_MMC_HIGHSPEED</span> <span class="o">|</span> <span class="n">MMC_CAP_SD_HIGHSPEED</span><span class="p">,</span>
	<span class="p">.</span><span class="n">version</span>	<span class="o">=</span> <span class="n">MMC_CTLR_VERSION_2</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">short</span> <span class="n">da850_evm_mmcsd0_pins</span><span class="p">[]</span> <span class="n">__initconst</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">DA850_MMCSD0_DAT_0</span><span class="p">,</span> <span class="n">DA850_MMCSD0_DAT_1</span><span class="p">,</span> <span class="n">DA850_MMCSD0_DAT_2</span><span class="p">,</span>
	<span class="n">DA850_MMCSD0_DAT_3</span><span class="p">,</span> <span class="n">DA850_MMCSD0_CLK</span><span class="p">,</span> <span class="n">DA850_MMCSD0_CMD</span><span class="p">,</span>
	<span class="n">DA850_GPIO4_0</span><span class="p">,</span> <span class="n">DA850_GPIO4_1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">da850_panel_power_ctrl</span><span class="p">(</span><span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* lcd backlight */</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">DA850_LCD_BL_PIN</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* lcd power */</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">DA850_LCD_PWR_PIN</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">da850_lcd_hw_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">DA850_LCD_BL_PIN</span><span class="p">,</span> <span class="s">&quot;lcd bl</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">DA850_LCD_PWR_PIN</span><span class="p">,</span> <span class="s">&quot;lcd pwr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gpio_free</span><span class="p">(</span><span class="n">DA850_LCD_BL_PIN</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">DA850_LCD_BL_PIN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">DA850_LCD_PWR_PIN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Switch off panel power and backlight */</span>
	<span class="n">da850_panel_power_ctrl</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Switch on panel power and backlight */</span>
	<span class="n">da850_panel_power_ctrl</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* TPS65070 voltage regulator support */</span>

<span class="cm">/* 3.3V */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">regulator_consumer_supply</span> <span class="n">tps65070_dcdc1_consumers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">supply</span> <span class="o">=</span> <span class="s">&quot;usb0_vdda33&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">supply</span> <span class="o">=</span> <span class="s">&quot;usb1_vdda33&quot;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* 3.3V or 1.8V */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">regulator_consumer_supply</span> <span class="n">tps65070_dcdc2_consumers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">supply</span> <span class="o">=</span> <span class="s">&quot;dvdd3318_a&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">supply</span> <span class="o">=</span> <span class="s">&quot;dvdd3318_b&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">supply</span> <span class="o">=</span> <span class="s">&quot;dvdd3318_c&quot;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* 1.2V */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">regulator_consumer_supply</span> <span class="n">tps65070_dcdc3_consumers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">supply</span> <span class="o">=</span> <span class="s">&quot;cvdd&quot;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* 1.8V LDO */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">regulator_consumer_supply</span> <span class="n">tps65070_ldo1_consumers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">supply</span> <span class="o">=</span> <span class="s">&quot;sata_vddr&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">supply</span> <span class="o">=</span> <span class="s">&quot;usb0_vdda18&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">supply</span> <span class="o">=</span> <span class="s">&quot;usb1_vdda18&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">supply</span> <span class="o">=</span> <span class="s">&quot;ddr_dvdd18&quot;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* 1.2V LDO */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">regulator_consumer_supply</span> <span class="n">tps65070_ldo2_consumers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">supply</span> <span class="o">=</span> <span class="s">&quot;sata_vdd&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">supply</span> <span class="o">=</span> <span class="s">&quot;pll0_vdda&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">supply</span> <span class="o">=</span> <span class="s">&quot;pll1_vdda&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">supply</span> <span class="o">=</span> <span class="s">&quot;usbs_cvdd&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">supply</span> <span class="o">=</span> <span class="s">&quot;vddarnwa1&quot;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* We take advantage of the fact that both defdcdc{2,3} are tied high */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">tps6507x_reg_platform_data</span> <span class="n">tps6507x_platform_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">defdcdc_default</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">regulator_init_data</span> <span class="n">tps65070_regulator_data</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* dcdc1 */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min_uV</span> <span class="o">=</span> <span class="mi">3150000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max_uV</span> <span class="o">=</span> <span class="mi">3450000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">valid_ops_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">REGULATOR_CHANGE_VOLTAGE</span> <span class="o">|</span>
				<span class="n">REGULATOR_CHANGE_STATUS</span><span class="p">),</span>
			<span class="p">.</span><span class="n">boot_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">num_consumer_supplies</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tps65070_dcdc1_consumers</span><span class="p">),</span>
		<span class="p">.</span><span class="n">consumer_supplies</span> <span class="o">=</span> <span class="n">tps65070_dcdc1_consumers</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="cm">/* dcdc2 */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min_uV</span> <span class="o">=</span> <span class="mi">1710000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max_uV</span> <span class="o">=</span> <span class="mi">3450000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">valid_ops_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">REGULATOR_CHANGE_VOLTAGE</span> <span class="o">|</span>
				<span class="n">REGULATOR_CHANGE_STATUS</span><span class="p">),</span>
			<span class="p">.</span><span class="n">boot_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">num_consumer_supplies</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tps65070_dcdc2_consumers</span><span class="p">),</span>
		<span class="p">.</span><span class="n">consumer_supplies</span> <span class="o">=</span> <span class="n">tps65070_dcdc2_consumers</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tps6507x_platform_data</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="cm">/* dcdc3 */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min_uV</span> <span class="o">=</span> <span class="mi">950000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max_uV</span> <span class="o">=</span> <span class="mi">1350000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">valid_ops_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">REGULATOR_CHANGE_VOLTAGE</span> <span class="o">|</span>
				<span class="n">REGULATOR_CHANGE_STATUS</span><span class="p">),</span>
			<span class="p">.</span><span class="n">boot_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">num_consumer_supplies</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tps65070_dcdc3_consumers</span><span class="p">),</span>
		<span class="p">.</span><span class="n">consumer_supplies</span> <span class="o">=</span> <span class="n">tps65070_dcdc3_consumers</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tps6507x_platform_data</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="cm">/* ldo1 */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min_uV</span> <span class="o">=</span> <span class="mi">1710000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max_uV</span> <span class="o">=</span> <span class="mi">1890000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">valid_ops_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">REGULATOR_CHANGE_VOLTAGE</span> <span class="o">|</span>
				<span class="n">REGULATOR_CHANGE_STATUS</span><span class="p">),</span>
			<span class="p">.</span><span class="n">boot_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">num_consumer_supplies</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tps65070_ldo1_consumers</span><span class="p">),</span>
		<span class="p">.</span><span class="n">consumer_supplies</span> <span class="o">=</span> <span class="n">tps65070_ldo1_consumers</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="cm">/* ldo2 */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min_uV</span> <span class="o">=</span> <span class="mi">1140000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max_uV</span> <span class="o">=</span> <span class="mi">1320000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">valid_ops_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">REGULATOR_CHANGE_VOLTAGE</span> <span class="o">|</span>
				<span class="n">REGULATOR_CHANGE_STATUS</span><span class="p">),</span>
			<span class="p">.</span><span class="n">boot_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">num_consumer_supplies</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tps65070_ldo2_consumers</span><span class="p">),</span>
		<span class="p">.</span><span class="n">consumer_supplies</span> <span class="o">=</span> <span class="n">tps65070_ldo2_consumers</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">touchscreen_init_data</span> <span class="n">tps6507x_touchscreen_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">poll_period</span> <span class="o">=</span>  <span class="mi">30</span><span class="p">,</span>	<span class="cm">/* ms between touch samples */</span>
	<span class="p">.</span><span class="n">min_pressure</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">,</span>	<span class="cm">/* minimum pressure to trigger touch */</span>
	<span class="p">.</span><span class="n">vref</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>		<span class="cm">/* turn off vref when not using A/D */</span>
	<span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>		<span class="cm">/* /sys/class/input/input?/id/vendor */</span>
	<span class="p">.</span><span class="n">product</span> <span class="o">=</span> <span class="mi">65070</span><span class="p">,</span>	<span class="cm">/* /sys/class/input/input?/id/product */</span>
	<span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">,</span>	<span class="cm">/* /sys/class/input/input?/id/version */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tps6507x_board</span> <span class="n">tps_board</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">tps6507x_pmic_init_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tps65070_regulator_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	<span class="p">.</span><span class="n">tps6507x_ts_init_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tps6507x_touchscreen_data</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">__initdata</span> <span class="n">da850_evm_tps65070_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;tps6507x&quot;</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">),</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tps_board</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pmic_tps65070_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">i2c_register_board_info</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">da850_evm_tps65070_info</span><span class="p">,</span>
					<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">da850_evm_tps65070_info</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">short</span> <span class="n">da850_evm_lcdc_pins</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">DA850_GPIO2_8</span><span class="p">,</span> <span class="n">DA850_GPIO2_15</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">short</span> <span class="n">da850_evm_mii_pins</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">DA850_MII_TXEN</span><span class="p">,</span> <span class="n">DA850_MII_TXCLK</span><span class="p">,</span> <span class="n">DA850_MII_COL</span><span class="p">,</span> <span class="n">DA850_MII_TXD_3</span><span class="p">,</span>
	<span class="n">DA850_MII_TXD_2</span><span class="p">,</span> <span class="n">DA850_MII_TXD_1</span><span class="p">,</span> <span class="n">DA850_MII_TXD_0</span><span class="p">,</span> <span class="n">DA850_MII_RXER</span><span class="p">,</span>
	<span class="n">DA850_MII_CRS</span><span class="p">,</span> <span class="n">DA850_MII_RXCLK</span><span class="p">,</span> <span class="n">DA850_MII_RXDV</span><span class="p">,</span> <span class="n">DA850_MII_RXD_3</span><span class="p">,</span>
	<span class="n">DA850_MII_RXD_2</span><span class="p">,</span> <span class="n">DA850_MII_RXD_1</span><span class="p">,</span> <span class="n">DA850_MII_RXD_0</span><span class="p">,</span> <span class="n">DA850_MDIO_CLK</span><span class="p">,</span>
	<span class="n">DA850_MDIO_D</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">short</span> <span class="n">da850_evm_rmii_pins</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">DA850_RMII_TXD_0</span><span class="p">,</span> <span class="n">DA850_RMII_TXD_1</span><span class="p">,</span> <span class="n">DA850_RMII_TXEN</span><span class="p">,</span>
	<span class="n">DA850_RMII_CRS_DV</span><span class="p">,</span> <span class="n">DA850_RMII_RXD_0</span><span class="p">,</span> <span class="n">DA850_RMII_RXD_1</span><span class="p">,</span>
	<span class="n">DA850_RMII_RXER</span><span class="p">,</span> <span class="n">DA850_RMII_MHZ_50_CLK</span><span class="p">,</span> <span class="n">DA850_MDIO_CLK</span><span class="p">,</span>
	<span class="n">DA850_MDIO_D</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">da850_evm_config_emac</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">cfg_chip3_base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">davinci_soc_info</span> <span class="o">*</span><span class="n">soc_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">davinci_soc_info</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rmii_en</span> <span class="o">=</span> <span class="n">soc_info</span><span class="o">-&gt;</span><span class="n">emac_pdata</span><span class="o">-&gt;</span><span class="n">rmii_en</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">machine_is_davinci_da850_evm</span><span class="p">())</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cfg_chip3_base</span> <span class="o">=</span> <span class="n">DA8XX_SYSCFG0_VIRT</span><span class="p">(</span><span class="n">DA8XX_CFGCHIP3_REG</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">cfg_chip3_base</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rmii_en</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">davinci_cfg_reg_list</span><span class="p">(</span><span class="n">da850_evm_rmii_pins</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;EMAC: RMII PHY configured, MII PHY will not be&quot;</span>
							<span class="s">&quot; functional</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">davinci_cfg_reg_list</span><span class="p">(</span><span class="n">da850_evm_mii_pins</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;EMAC: MII PHY configured, RMII PHY will not be&quot;</span>
							<span class="s">&quot; functional</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;da850_evm_init: cpgmac/rmii mux setup failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ret</span><span class="p">);</span>

	<span class="cm">/* configure the CFGCHIP3 register for RMII or MII */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">cfg_chip3_base</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">davinci_cfg_reg</span><span class="p">(</span><span class="n">DA850_GPIO2_6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;da850_evm_init:GPIO(2,6) mux setup &quot;</span>
							<span class="s">&quot;failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">DA850_MII_MDIO_CLKEN_PIN</span><span class="p">,</span> <span class="s">&quot;mdio_clk_en&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Cannot open GPIO %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">DA850_MII_MDIO_CLKEN_PIN</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enable/Disable MII MDIO clock */</span>
	<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">DA850_MII_MDIO_CLKEN_PIN</span><span class="p">,</span> <span class="n">rmii_en</span><span class="p">);</span>

	<span class="n">soc_info</span><span class="o">-&gt;</span><span class="n">emac_pdata</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">DA850_EVM_PHY_ID</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">da8xx_register_emac</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;da850_evm_init: emac registration failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">device_initcall</span><span class="p">(</span><span class="n">da850_evm_config_emac</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * The following EDMA channels/slots are not being used by drivers (for</span>
<span class="cm"> * example: Timer, GPIO, UART events etc) on da850/omap-l138 EVM, hence</span>
<span class="cm"> * they are being reserved for codecs on the DSP side.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">s16</span> <span class="n">da850_dma0_rsv_chans</span><span class="p">[][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* (offset, number) */</span>
	<span class="p">{</span> <span class="mi">8</span><span class="p">,</span>  <span class="mi">6</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">24</span><span class="p">,</span>  <span class="mi">4</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">30</span><span class="p">,</span>  <span class="mi">2</span><span class="p">},</span>
	<span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">s16</span> <span class="n">da850_dma0_rsv_slots</span><span class="p">[][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* (offset, number) */</span>
	<span class="p">{</span> <span class="mi">8</span><span class="p">,</span>  <span class="mi">6</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">24</span><span class="p">,</span>  <span class="mi">4</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">30</span><span class="p">,</span> <span class="mi">50</span><span class="p">},</span>
	<span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">s16</span> <span class="n">da850_dma1_rsv_chans</span><span class="p">[][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* (offset, number) */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">28</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">30</span><span class="p">,</span>  <span class="mi">2</span><span class="p">},</span>
	<span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">s16</span> <span class="n">da850_dma1_rsv_slots</span><span class="p">[][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* (offset, number) */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">28</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">30</span><span class="p">,</span> <span class="mi">90</span><span class="p">},</span>
	<span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">edma_rsv_info</span> <span class="n">da850_edma_cc0_rsv</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">rsv_chans</span>	<span class="o">=</span> <span class="n">da850_dma0_rsv_chans</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rsv_slots</span>	<span class="o">=</span> <span class="n">da850_dma0_rsv_slots</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">edma_rsv_info</span> <span class="n">da850_edma_cc1_rsv</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">rsv_chans</span>	<span class="o">=</span> <span class="n">da850_dma1_rsv_chans</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rsv_slots</span>	<span class="o">=</span> <span class="n">da850_dma1_rsv_slots</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">edma_rsv_info</span> <span class="o">*</span><span class="n">da850_edma_rsv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">da850_edma_cc0_rsv</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">da850_edma_cc1_rsv</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_CPU_FREQ</span>
<span class="k">static</span> <span class="n">__init</span> <span class="kt">int</span> <span class="nf">da850_evm_init_cpufreq</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">system_rev</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">da850_max_speed</span> <span class="o">=</span> <span class="mi">456000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">da850_max_speed</span> <span class="o">=</span> <span class="mi">408000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">da850_max_speed</span> <span class="o">=</span> <span class="mi">372000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">da850_register_cpufreq</span><span class="p">(</span><span class="s">&quot;pll0_sysclk3&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="n">__init</span> <span class="kt">int</span> <span class="nf">da850_evm_init_cpufreq</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_DA850_WL12XX</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl12xx_set_power</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">bool</span> <span class="n">power_on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">bool</span> <span class="n">power_state</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Powering %s wl12xx&quot;</span><span class="p">,</span> <span class="n">power_on</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">power_on</span> <span class="o">==</span> <span class="n">power_state</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">power_state</span> <span class="o">=</span> <span class="n">power_on</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">power_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Power up sequence required for wl127x devices */</span>
		<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">DA850_WLAN_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">15000</span><span class="p">,</span> <span class="mi">15000</span><span class="p">);</span>
		<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">DA850_WLAN_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">DA850_WLAN_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">70</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">DA850_WLAN_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">davinci_mmc_config</span> <span class="n">da850_wl12xx_mmc_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set_power</span>	<span class="o">=</span> <span class="n">wl12xx_set_power</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wires</span>		<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_freq</span>	<span class="o">=</span> <span class="mi">25000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">caps</span>		<span class="o">=</span> <span class="n">MMC_CAP_4_BIT_DATA</span> <span class="o">|</span> <span class="n">MMC_CAP_NONREMOVABLE</span> <span class="o">|</span>
			  <span class="n">MMC_CAP_POWER_OFF_CARD</span><span class="p">,</span>
	<span class="p">.</span><span class="n">version</span>	<span class="o">=</span> <span class="n">MMC_CTLR_VERSION_2</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">short</span> <span class="n">da850_wl12xx_pins</span><span class="p">[]</span> <span class="n">__initconst</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">DA850_MMCSD1_DAT_0</span><span class="p">,</span> <span class="n">DA850_MMCSD1_DAT_1</span><span class="p">,</span> <span class="n">DA850_MMCSD1_DAT_2</span><span class="p">,</span>
	<span class="n">DA850_MMCSD1_DAT_3</span><span class="p">,</span> <span class="n">DA850_MMCSD1_CLK</span><span class="p">,</span> <span class="n">DA850_MMCSD1_CMD</span><span class="p">,</span>
	<span class="n">DA850_GPIO6_9</span><span class="p">,</span> <span class="n">DA850_GPIO6_10</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">wl12xx_platform_data</span> <span class="n">da850_wl12xx_wlan_data</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">irq</span>			<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">board_ref_clock</span>	<span class="o">=</span> <span class="n">WL12XX_REFCLOCK_38</span><span class="p">,</span>
	<span class="p">.</span><span class="n">platform_quirks</span>	<span class="o">=</span> <span class="n">WL12XX_PLATFORM_QUIRK_EDGE_IRQ</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">int</span> <span class="nf">da850_wl12xx_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">davinci_cfg_reg_list</span><span class="p">(</span><span class="n">da850_wl12xx_pins</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;wl12xx/mmc mux setup failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">da850_register_mmcsd1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">da850_wl12xx_mmc_config</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;wl12xx/mmc registration failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_request_one</span><span class="p">(</span><span class="n">DA850_WLAN_EN</span><span class="p">,</span> <span class="n">GPIOF_OUT_INIT_LOW</span><span class="p">,</span> <span class="s">&quot;wl12xx_en&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Could not request wl12xx enable gpio: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_request_one</span><span class="p">(</span><span class="n">DA850_WLAN_IRQ</span><span class="p">,</span> <span class="n">GPIOF_IN</span><span class="p">,</span> <span class="s">&quot;wl12xx_irq&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Could not request wl12xx irq gpio: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_wlan_en</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">da850_wl12xx_wlan_data</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">gpio_to_irq</span><span class="p">(</span><span class="n">DA850_WLAN_IRQ</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_set_platform_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">da850_wl12xx_wlan_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Could not set wl12xx data: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_wlan_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">free_wlan_irq:</span>
	<span class="n">gpio_free</span><span class="p">(</span><span class="n">DA850_WLAN_IRQ</span><span class="p">);</span>

<span class="nl">free_wlan_en:</span>
	<span class="n">gpio_free</span><span class="p">(</span><span class="n">DA850_WLAN_EN</span><span class="p">);</span>

<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else </span><span class="cm">/* CONFIG_DA850_WL12XX */</span><span class="cp"></span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">int</span> <span class="nf">da850_wl12xx_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_DA850_WL12XX */</span><span class="cp"></span>

<span class="cp">#define DA850EVM_SATA_REFCLKPN_RATE	(100 * 1000 * 1000)</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">void</span> <span class="nf">da850_evm_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pmic_tps65070_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;da850_evm_init: TPS65070 PMIC init failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ret</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">da850_register_edma</span><span class="p">(</span><span class="n">da850_edma_rsv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;da850_evm_init: edma registration failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ret</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">davinci_cfg_reg_list</span><span class="p">(</span><span class="n">da850_i2c0_pins</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;da850_evm_init: i2c0 mux setup failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ret</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">da8xx_register_i2c</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">da850_evm_i2c_0_pdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;da850_evm_init: i2c0 registration failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ret</span><span class="p">);</span>


	<span class="n">ret</span> <span class="o">=</span> <span class="n">da8xx_register_watchdog</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;da830_evm_init: watchdog registration failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ret</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_MMC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">davinci_cfg_reg_list</span><span class="p">(</span><span class="n">da850_evm_mmcsd0_pins</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;da850_evm_init: mmcsd0 mux setup failed:&quot;</span>
					<span class="s">&quot; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">DA850_MMCSD_CD_PIN</span><span class="p">,</span> <span class="s">&quot;MMC CD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;da850_evm_init: can not open GPIO %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">DA850_MMCSD_CD_PIN</span><span class="p">);</span>
		<span class="n">gpio_direction_input</span><span class="p">(</span><span class="n">DA850_MMCSD_CD_PIN</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">DA850_MMCSD_WP_PIN</span><span class="p">,</span> <span class="s">&quot;MMC WP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;da850_evm_init: can not open GPIO %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">DA850_MMCSD_WP_PIN</span><span class="p">);</span>
		<span class="n">gpio_direction_input</span><span class="p">(</span><span class="n">DA850_MMCSD_WP_PIN</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">da8xx_register_mmcsd0</span><span class="p">(</span><span class="o">&amp;</span><span class="n">da850_mmc_config</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;da850_evm_init: mmcsd0 registration failed:&quot;</span>
					<span class="s">&quot; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">da850_wl12xx_init</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;da850_evm_init: wl12xx initialization&quot;</span>
				   <span class="s">&quot; failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">davinci_serial_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">da850_evm_uart_config</span><span class="p">);</span>

	<span class="n">i2c_register_board_info</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">da850_evm_i2c_devices</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">da850_evm_i2c_devices</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * shut down uart 0 and 1; they are not used on the board and</span>
<span class="cm">	 * accessing them causes endless &quot;too much work in irq53&quot; messages</span>
<span class="cm">	 * with arago fs</span>
<span class="cm">	 */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">IO_ADDRESS</span><span class="p">(</span><span class="n">DA8XX_UART1_BASE</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">IO_ADDRESS</span><span class="p">(</span><span class="n">DA8XX_UART0_BASE</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">davinci_cfg_reg_list</span><span class="p">(</span><span class="n">da850_evm_mcasp_pins</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;da850_evm_init: mcasp mux setup failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ret</span><span class="p">);</span>

	<span class="n">da8xx_register_mcasp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">da850_evm_snd_data</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">davinci_cfg_reg_list</span><span class="p">(</span><span class="n">da850_lcdcntl_pins</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;da850_evm_init: lcdcntl mux setup failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ret</span><span class="p">);</span>

	<span class="cm">/* Handle board specific muxing for LCD here */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">davinci_cfg_reg_list</span><span class="p">(</span><span class="n">da850_evm_lcdc_pins</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;da850_evm_init: evm specific lcd mux setup &quot;</span>
				<span class="s">&quot;failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>	<span class="n">ret</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">da850_lcd_hw_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;da850_evm_init: lcd initialization failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ret</span><span class="p">);</span>

	<span class="n">sharp_lk043t1dg01_pdata</span><span class="p">.</span><span class="n">panel_power_ctrl</span> <span class="o">=</span> <span class="n">da850_panel_power_ctrl</span><span class="p">,</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">da8xx_register_lcdc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sharp_lk043t1dg01_pdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;da850_evm_init: lcdc registration failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ret</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">da8xx_register_rtc</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;da850_evm_init: rtc setup failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">da850_evm_init_cpufreq</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;da850_evm_init: cpufreq registration failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ret</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">da8xx_register_cpuidle</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;da850_evm_init: cpuidle registration failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ret</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">da850_register_pm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">da850_pm_device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;da850_evm_init: suspend registration failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ret</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">da8xx_register_spi</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">da850evm_spi_info</span><span class="p">,</span>
				 <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">da850evm_spi_info</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;da850_evm_init: spi 1 registration failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ret</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">da850_register_sata</span><span class="p">(</span><span class="n">DA850EVM_SATA_REFCLKPN_RATE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;da850_evm_init: sata registration failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ret</span><span class="p">);</span>

	<span class="n">da850_evm_setup_mac_addr</span><span class="p">();</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SERIAL_8250_CONSOLE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">da850_evm_console_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">machine_is_davinci_da850_evm</span><span class="p">())</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">add_preferred_console</span><span class="p">(</span><span class="s">&quot;ttyS&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;115200&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">console_initcall</span><span class="p">(</span><span class="n">da850_evm_console_init</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">da850_evm_map_io</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">da850_init</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">MACHINE_START</span><span class="p">(</span><span class="n">DAVINCI_DA850_EVM</span><span class="p">,</span> <span class="s">&quot;DaVinci DA850/OMAP-L138/AM18x EVM&quot;</span><span class="p">)</span>
	<span class="p">.</span><span class="n">atag_offset</span>	<span class="o">=</span> <span class="mh">0x100</span><span class="p">,</span>
	<span class="p">.</span><span class="n">map_io</span>		<span class="o">=</span> <span class="n">da850_evm_map_io</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_irq</span>	<span class="o">=</span> <span class="n">cp_intc_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">timer</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">davinci_timer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_machine</span>	<span class="o">=</span> <span class="n">da850_evm_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_late</span>	<span class="o">=</span> <span class="n">davinci_init_late</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_zone_size</span>	<span class="o">=</span> <span class="n">SZ_128M</span><span class="p">,</span>
	<span class="p">.</span><span class="n">restart</span>	<span class="o">=</span> <span class="n">da8xx_restart</span><span class="p">,</span>
<span class="n">MACHINE_END</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
