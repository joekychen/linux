<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › mach-iop13xx › pci.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>pci.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * iop13xx PCI support</span>
<span class="cm"> * Copyright (c) 2005-2006, Intel Corporation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms and conditions of the GNU General Public License,</span>
<span class="cm"> * version 2, as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc., 59 Temple</span>
<span class="cm"> * Place - Suite 330, Boston, MA 02111-1307 USA.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;mach/hardware.h&gt;</span>
<span class="cp">#include &lt;asm/sizes.h&gt;</span>
<span class="cp">#include &lt;asm/signal.h&gt;</span>
<span class="cp">#include &lt;asm/mach/pci.h&gt;</span>
<span class="cp">#include &lt;mach/pci.h&gt;</span>

<span class="cp">#define IOP13XX_PCI_DEBUG 0</span>
<span class="cp">#define PRINTK(x...) ((void)(IOP13XX_PCI_DEBUG &amp;&amp; printk(x)))</span>

<span class="n">u32</span> <span class="n">iop13xx_atux_pmmr_offset</span><span class="p">;</span> <span class="cm">/* This offset can change based on strapping */</span>
<span class="n">u32</span> <span class="n">iop13xx_atue_pmmr_offset</span><span class="p">;</span> <span class="cm">/* This offset can change based on strapping */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">pci_bus_atux</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">pci_bus_atue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">u32</span> <span class="n">iop13xx_atue_mem_base</span><span class="p">;</span>
<span class="n">u32</span> <span class="n">iop13xx_atux_mem_base</span><span class="p">;</span>
<span class="kt">size_t</span> <span class="n">iop13xx_atue_mem_size</span><span class="p">;</span>
<span class="kt">size_t</span> <span class="n">iop13xx_atux_mem_size</span><span class="p">;</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">iop13xx_atue_mem_base</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">iop13xx_atux_mem_base</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">iop13xx_atue_mem_size</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">iop13xx_atux_mem_size</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">init_atu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Flag to select which ATU(s) to initialize / disable */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">atux_trhfa_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Trhfa = RST# high to first</span>
<span class="cm">						 access */</span>

<span class="cm">/* Scan the initialized busses and ioremap the requested memory range</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">iop13xx_map_pci_memory</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">atu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">atu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">atu</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">atu</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bus</span> <span class="o">=</span> <span class="n">atu</span> <span class="o">?</span> <span class="n">pci_bus_atue</span> <span class="o">:</span> <span class="n">pci_bus_atux</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span> <span class="n">bus_list</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">)</span>
					<span class="n">max</span> <span class="o">=</span> <span class="n">DEVICE_COUNT_RESOURCE</span><span class="p">;</span>

				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">)</span>
						<span class="n">end</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">switch</span><span class="p">(</span><span class="n">atu</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">iop13xx_atux_mem_size</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">IOP13XX_PCIX_LOWER_MEM_RA</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

				<span class="cm">/* 16MB align the request */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">iop13xx_atux_mem_size</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SZ_16M</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">iop13xx_atux_mem_size</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SZ_16M</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
					<span class="n">iop13xx_atux_mem_size</span> <span class="o">+=</span> <span class="n">SZ_16M</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">iop13xx_atux_mem_base</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">__arm_ioremap_pfn</span><span class="p">(</span>
					<span class="n">__phys_to_pfn</span><span class="p">(</span><span class="n">IOP13XX_PCIX_LOWER_MEM_PA</span><span class="p">)</span>
					<span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">iop13xx_atux_mem_size</span><span class="p">,</span> <span class="n">MT_DEVICE</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iop13xx_atux_mem_base</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: atux allocation &quot;</span>
						       <span class="s">&quot;failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
						<span class="n">BUG</span><span class="p">();</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">iop13xx_atux_mem_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;%s: atu: %d bus_size: %d mem_base: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">atu</span><span class="p">,</span> <span class="n">iop13xx_atux_mem_size</span><span class="p">,</span>
				<span class="n">iop13xx_atux_mem_base</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">iop13xx_atue_mem_size</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">IOP13XX_PCIE_LOWER_MEM_RA</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

				<span class="cm">/* 16MB align the request */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">iop13xx_atue_mem_size</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SZ_16M</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">iop13xx_atue_mem_size</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SZ_16M</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
					<span class="n">iop13xx_atue_mem_size</span> <span class="o">+=</span> <span class="n">SZ_16M</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">iop13xx_atue_mem_base</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">__arm_ioremap_pfn</span><span class="p">(</span>
					<span class="n">__phys_to_pfn</span><span class="p">(</span><span class="n">IOP13XX_PCIE_LOWER_MEM_PA</span><span class="p">)</span>
					<span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">iop13xx_atue_mem_size</span><span class="p">,</span> <span class="n">MT_DEVICE</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iop13xx_atue_mem_base</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: atue allocation &quot;</span>
						       <span class="s">&quot;failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
						<span class="n">BUG</span><span class="p">();</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">iop13xx_atue_mem_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;%s: atu: %d bus_size: %d mem_base: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">atu</span><span class="p">,</span> <span class="n">iop13xx_atue_mem_size</span><span class="p">,</span>
				<span class="n">iop13xx_atue_mem_base</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Initialized (%uM @ resource/virtual: %08lx/%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">atu</span> <span class="o">?</span> <span class="s">&quot;ATUE&quot;</span> <span class="o">:</span> <span class="s">&quot;ATUX&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">atu</span> <span class="o">?</span> <span class="n">iop13xx_atue_mem_size</span> <span class="o">:</span> <span class="n">iop13xx_atux_mem_size</span><span class="p">)</span> <span class="o">/</span>
			<span class="n">SZ_1M</span><span class="p">,</span>
			<span class="n">atu</span> <span class="o">?</span> <span class="n">IOP13XX_PCIE_LOWER_MEM_RA</span> <span class="o">:</span>
			<span class="n">IOP13XX_PCIX_LOWER_MEM_RA</span><span class="p">,</span>
			<span class="n">atu</span> <span class="o">?</span> <span class="n">iop13xx_atue_mem_base</span> <span class="o">:</span>
			<span class="n">iop13xx_atux_mem_base</span><span class="p">);</span>
			<span class="n">end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">iop13xx_atu_function</span><span class="p">(</span><span class="kt">int</span> <span class="n">atu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">func</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* the function number depends on the value of the</span>
<span class="cm">	 * IOP13XX_INTERFACE_SEL_PCIX reset strap</span>
<span class="cm">	 * see C-Spec section 3.17</span>
<span class="cm">	 */</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">atu</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOP13XX_INIT_ATU_ATUX</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ESSR0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IOP13XX_INTERFACE_SEL_PCIX</span><span class="p">)</span>
			<span class="n">func</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">func</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IOP13XX_INIT_ATU_ATUE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ESSR0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IOP13XX_INTERFACE_SEL_PCIX</span><span class="p">)</span>
			<span class="n">func</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">func</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">func</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* iop13xx_atux_cfg_address - format a configuration address for atux</span>
<span class="cm"> * @bus: Target bus to access</span>
<span class="cm"> * @devfn: Combined device number and function number</span>
<span class="cm"> * @where: Desired register&#39;s address offset</span>
<span class="cm"> *</span>
<span class="cm"> * Convert the parameters to a configuration address formatted</span>
<span class="cm"> * according the PCI-X 2.0 specification</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">iop13xx_atux_cfg_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">where</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_sys_data</span> <span class="o">*</span><span class="n">sys</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">sysdata</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sys</span><span class="o">-&gt;</span><span class="n">busnr</span> <span class="o">==</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">)</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">devfn</span><span class="p">)</span> <span class="o">+</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">devfn</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">devfn</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">|=</span>	<span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">devfn</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="p">((</span><span class="n">where</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">);</span>
	<span class="n">addr</span> <span class="o">|=</span> <span class="p">((</span><span class="n">where</span> <span class="o">&amp;</span> <span class="mh">0xf00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span> <span class="cm">/* upper register number */</span>

	<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* iop13xx_atue_cfg_address - format a configuration address for atue</span>
<span class="cm"> * @bus: Target bus to access</span>
<span class="cm"> * @devfn: Combined device number and function number</span>
<span class="cm"> * @where: Desired register&#39;s address offset</span>
<span class="cm"> *</span>
<span class="cm"> * Convert the parameters to an address usable by the ATUE_OCCAR</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">iop13xx_atue_cfg_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">where</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_sys_data</span> <span class="o">*</span><span class="n">sys</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">sysdata</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;iop13xx_atue_cfg_address: bus: %d dev: %d func: %d&quot;</span><span class="p">,</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">devfn</span><span class="p">),</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">devfn</span><span class="p">));</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">)</span>     <span class="o">&lt;&lt;</span> <span class="n">IOP13XX_ATUE_OCCAR_BUS_NUM</span> <span class="o">|</span>
		   <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">devfn</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">IOP13XX_ATUE_OCCAR_DEV_NUM</span> <span class="o">|</span>
		   <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">devfn</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">IOP13XX_ATUE_OCCAR_FUNC_NUM</span> <span class="o">|</span>
		   <span class="p">(</span><span class="n">where</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sys</span><span class="o">-&gt;</span><span class="n">busnr</span> <span class="o">!=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">)</span>
		<span class="n">addr</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* type 1 access */</span>

	<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This routine checks the status of the last configuration cycle.  If an error</span>
<span class="cm"> * was detected it returns &gt;0, else it returns a 0.  The errors being checked</span>
<span class="cm"> * are parity, master abort, target abort (master and target).  These types of</span>
<span class="cm"> * errors occur during a config cycle where there is no device, like during</span>
<span class="cm"> * the discovery stage.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">iop13xx_atux_pci_status</span><span class="p">(</span><span class="kt">int</span> <span class="n">clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check the status registers.</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">__raw_readw</span><span class="p">(</span><span class="n">IOP13XX_ATUX_ATUSR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IOP_PCI_STATUS_ERROR</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t\t</span><span class="s">PCI error: ATUSR %#08x&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">clear</span><span class="p">)</span>
			<span class="n">__raw_writew</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IOP_PCI_STATUS_ERROR</span><span class="p">,</span>
				<span class="n">IOP13XX_ATUX_ATUSR</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ATUX_ATUISR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IOP13XX_ATUX_ATUISR_ERROR</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t\t</span><span class="s">PCI error interrupt:  ATUISR %#08x&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">clear</span><span class="p">)</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IOP13XX_ATUX_ATUISR_ERROR</span><span class="p">,</span>
				<span class="n">IOP13XX_ATUX_ATUISR</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Simply write the address register and read the configuration</span>
<span class="cm"> * data.  Note that the data dependency on %0 encourages an abort</span>
<span class="cm"> * to be detected before we return.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">iop13xx_atux_read</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span>
		<span class="s">&quot;str	%1, [%2]</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;ldr	%0, [%3]</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;mov	%0, %0</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">addr</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">IOP13XX_ATUX_OCCAR</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">IOP13XX_ATUX_OCCDR</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The read routines must check the error status of the last configuration</span>
<span class="cm"> * cycle.  If there was an error, the routine returns all hex f&#39;s.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">iop13xx_atux_read_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">where</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">iop13xx_atux_cfg_address</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">where</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">iop13xx_atux_read</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">((</span><span class="n">where</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iop13xx_atux_pci_status</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="n">is_atux_occdr_error</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_XBG_BECSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">,</span>
			<span class="n">IOP13XX_XBG_BECSR</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">PCIBIOS_SUCCESSFUL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">iop13xx_atux_write_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">where</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">iop13xx_atux_cfg_address</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">where</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">iop13xx_atux_read</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iop13xx_atux_pci_status</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">PCIBIOS_SUCCESSFUL</span><span class="p">;</span>

		<span class="n">where</span> <span class="o">=</span> <span class="p">(</span><span class="n">where</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xff</span> <span class="o">&lt;&lt;</span> <span class="n">where</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xffff</span> <span class="o">&lt;&lt;</span> <span class="n">where</span><span class="p">);</span>

		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="n">where</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_OCCDR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_OCCAR</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_OCCDR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">PCIBIOS_SUCCESSFUL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_ops</span> <span class="n">iop13xx_atux_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span>	<span class="o">=</span> <span class="n">iop13xx_atux_read_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>	<span class="o">=</span> <span class="n">iop13xx_atux_write_config</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* This routine checks the status of the last configuration cycle.  If an error</span>
<span class="cm"> * was detected it returns &gt;0, else it returns a 0.  The errors being checked</span>
<span class="cm"> * are parity, master abort, target abort (master and target).  These types of</span>
<span class="cm"> * errors occur during a config cycle where there is no device, like during</span>
<span class="cm"> * the discovery stage.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">iop13xx_atue_pci_status</span><span class="p">(</span><span class="kt">int</span> <span class="n">clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check the status registers.</span>
<span class="cm">	 */</span>

	<span class="cm">/* standard pci status register */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">__raw_readw</span><span class="p">(</span><span class="n">IOP13XX_ATUE_ATUSR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IOP_PCI_STATUS_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t\t</span><span class="s">PCI error: ATUSR %#08x&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">clear</span><span class="p">)</span>
			<span class="n">__raw_writew</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IOP_PCI_STATUS_ERROR</span><span class="p">,</span>
				<span class="n">IOP13XX_ATUE_ATUSR</span><span class="p">);</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check the normal status bits in the ATUISR */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ATUE_ATUISR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IOP13XX_ATUE_ATUISR_ERROR</span><span class="p">)</span>	<span class="p">{</span>
		<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t\t</span><span class="s">PCI error: ATUISR %#08x&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clear</span><span class="p">)</span>
			<span class="n">__raw_writew</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IOP13XX_ATUE_ATUISR_ERROR</span><span class="p">,</span>
				<span class="n">IOP13XX_ATUE_ATUISR</span><span class="p">);</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* check the PCI-E status if the ATUISR reports an interface error */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IOP13XX_ATUE_STAT_PCI_IFACE_ERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* get the unmasked errors */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ATUE_PIE_STS</span><span class="p">)</span> <span class="o">&amp;</span>
					<span class="o">~</span><span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ATUE_PIE_MSK</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t\t</span><span class="s">PCI-E error: ATUE_PIE_STS %#08x&quot;</span><span class="p">,</span>
					<span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ATUE_PIE_STS</span><span class="p">));</span>
				<span class="n">err</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t\t</span><span class="s">PCI-E error: ATUE_PIE_STS %#08x&quot;</span><span class="p">,</span>
					<span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ATUE_PIE_STS</span><span class="p">));</span>
				<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t\t</span><span class="s">PCI-E error: ATUE_PIE_MSK %#08x&quot;</span><span class="p">,</span>
					<span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ATUE_PIE_MSK</span><span class="p">));</span>
				<span class="n">BUG</span><span class="p">();</span>
			<span class="p">}</span>

			<span class="k">if</span><span class="p">(</span><span class="n">clear</span><span class="p">)</span>
				<span class="n">__raw_writel</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_PIE_STS</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">iop13xx_pcie_map_irq</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">idsel</span><span class="p">,</span> <span class="n">u8</span> <span class="n">pin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">idsel</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pin</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="k">return</span> <span class="n">ATUE_INTA</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="k">return</span> <span class="n">ATUE_INTB</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="k">return</span> <span class="n">ATUE_INTC</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>: <span class="k">return</span> <span class="n">ATUE_INTD</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">iop13xx_atue_read</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_OCCAR</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ATUE_OCCDR</span><span class="p">);</span>

	<span class="n">rmb</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The read routines must check the error status of the last configuration</span>
<span class="cm"> * cycle.  If there was an error, the routine returns all hex f&#39;s.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">iop13xx_atue_read_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">where</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">iop13xx_atue_cfg_address</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">where</span><span class="p">);</span>

	<span class="cm">/* Hide device numbers &gt; 0 on the local PCI-E bus (Type 0 access) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">devfn</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">iop13xx_atue_read</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">((</span><span class="n">where</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">iop13xx_atue_pci_status</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="n">is_atue_occdr_error</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_XBG_BECSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">,</span>
				<span class="n">IOP13XX_XBG_BECSR</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;addr=%#0lx, val=%#010x&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>

	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">PCIBIOS_SUCCESSFUL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">iop13xx_atue_write_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">where</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">iop13xx_atue_cfg_address</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">where</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">iop13xx_atue_read</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iop13xx_atue_pci_status</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">PCIBIOS_SUCCESSFUL</span><span class="p">;</span>

		<span class="n">where</span> <span class="o">=</span> <span class="p">(</span><span class="n">where</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xff</span> <span class="o">&lt;&lt;</span> <span class="n">where</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xffff</span> <span class="o">&lt;&lt;</span> <span class="n">where</span><span class="p">);</span>

		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="n">where</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_OCCDR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_OCCAR</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_OCCDR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">PCIBIOS_SUCCESSFUL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_ops</span> <span class="n">iop13xx_atue_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span>	<span class="o">=</span> <span class="n">iop13xx_atue_read_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>	<span class="o">=</span> <span class="n">iop13xx_atue_write_config</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* When a PCI device does not exist during config cycles, the XScale gets a</span>
<span class="cm"> * bus error instead of returning 0xffffffff.  We can&#39;t rely on the ATU status</span>
<span class="cm"> * bits to tell us that it was indeed a configuration cycle that caused this</span>
<span class="cm"> * error especially in the case when the ATUE link is down.  Instead we rely</span>
<span class="cm"> * on data from the south XSI bridge to validate the abort</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">iop13xx_pci_abort</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fsr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;Data abort: address = 0x%08lx &quot;</span>
		    <span class="s">&quot;fsr = 0x%03x PC = 0x%08lx LR = 0x%08lx&quot;</span><span class="p">,</span>
		<span class="n">addr</span><span class="p">,</span> <span class="n">fsr</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ARM_pc</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ARM_lr</span><span class="p">);</span>

	<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;IOP13XX_XBG_BECSR: %#10x&quot;</span><span class="p">,</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_XBG_BECSR</span><span class="p">));</span>
	<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;IOP13XX_XBG_BERAR: %#10x&quot;</span><span class="p">,</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_XBG_BERAR</span><span class="p">));</span>
	<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;IOP13XX_XBG_BERUAR: %#10x&quot;</span><span class="p">,</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_XBG_BERUAR</span><span class="p">));</span>

	<span class="cm">/*  If it was an imprecise abort, then we need to correct the</span>
<span class="cm">	 *  return address to be _after_ the instruction.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fsr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">))</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">ARM_pc</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_atue_occdr_error</span><span class="p">()</span> <span class="o">||</span> <span class="n">is_atux_occdr_error</span><span class="p">())</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Scan an IOP13XX PCI bus.  nr selects which ATU we use.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="nf">iop13xx_scan_bus</span><span class="p">(</span><span class="kt">int</span> <span class="n">nr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_sys_data</span> <span class="o">*</span><span class="n">sys</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">which_atu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">init_atu</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOP13XX_INIT_ATU_ATUX</span>:
		<span class="n">which_atu</span> <span class="o">=</span> <span class="n">nr</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">IOP13XX_INIT_ATU_ATUX</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IOP13XX_INIT_ATU_ATUE</span>:
		<span class="n">which_atu</span> <span class="o">=</span> <span class="n">nr</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">IOP13XX_INIT_ATU_ATUE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">IOP13XX_INIT_ATU_ATUX</span> <span class="o">|</span> <span class="n">IOP13XX_INIT_ATU_ATUE</span><span class="p">)</span>:
		<span class="n">which_atu</span> <span class="o">=</span> <span class="n">nr</span> <span class="o">?</span> <span class="n">IOP13XX_INIT_ATU_ATUE</span> <span class="o">:</span> <span class="n">IOP13XX_INIT_ATU_ATUX</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">which_atu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">which_atu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">which_atu</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOP13XX_INIT_ATU_ATUX</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span>
				  <span class="n">atux_trhfa_timeout</span><span class="p">))</span>  <span class="cm">/* ensure not wrap */</span>
			<span class="k">while</span><span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">atux_trhfa_timeout</span><span class="p">))</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

		<span class="n">bus</span> <span class="o">=</span> <span class="n">pci_bus_atux</span> <span class="o">=</span> <span class="n">pci_scan_root_bus</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">sys</span><span class="o">-&gt;</span><span class="n">busnr</span><span class="p">,</span>
						       <span class="o">&amp;</span><span class="n">iop13xx_atux_ops</span><span class="p">,</span>
						       <span class="n">sys</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sys</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IOP13XX_INIT_ATU_ATUE</span>:
		<span class="n">bus</span> <span class="o">=</span> <span class="n">pci_bus_atue</span> <span class="o">=</span> <span class="n">pci_scan_root_bus</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">sys</span><span class="o">-&gt;</span><span class="n">busnr</span><span class="p">,</span>
						       <span class="o">&amp;</span><span class="n">iop13xx_atue_ops</span><span class="p">,</span>
						       <span class="n">sys</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sys</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">bus</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This function is called from iop13xx_pci_init() after assigning valid</span>
<span class="cm"> * values to iop13xx_atue_pmmr_offset.  This is the location for common</span>
<span class="cm"> * setup of ATUE for all IOP13XX implementations.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">iop13xx_atue_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">func</span> <span class="o">=</span> <span class="n">iop13xx_atu_function</span><span class="p">(</span><span class="n">IOP13XX_INIT_ATU_ATUE</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">reg_val</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PCI_MSI</span>
	<span class="cm">/* BAR 0 (inbound msi window) */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">IOP13XX_MU_BASE_PHYS</span><span class="p">,</span> <span class="n">IOP13XX_MU_MUBAR</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">IOP13XX_MU_WINDOW_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">IOP13XX_ATUE_IALR0</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">IOP13XX_MU_BASE_PHYS</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_IATVR0</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">IOP13XX_MU_BASE_PCI</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_IABAR0</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* BAR 1 (1:1 mapping with Physical RAM) */</span>
	<span class="cm">/* Set limit and enable */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">IOP13XX_MAX_RAM_SIZE</span> <span class="o">-</span> <span class="n">PHYS_OFFSET</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1</span><span class="p">,</span>
			<span class="n">IOP13XX_ATUE_IALR1</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_IAUBAR1</span><span class="p">);</span>

	<span class="cm">/* Set base at the top of the reserved address space */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">PHYS_OFFSET</span> <span class="o">|</span> <span class="n">PCI_BASE_ADDRESS_MEM_TYPE_64</span> <span class="o">|</span>
			<span class="n">PCI_BASE_ADDRESS_MEM_PREFETCH</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_IABAR1</span><span class="p">);</span>

	<span class="cm">/* 1:1 mapping with physical ram</span>
<span class="cm">	 * (leave big endian byte swap disabled)</span>
<span class="cm">	 */</span>
	 <span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_IAUTVR1</span><span class="p">);</span>
	 <span class="n">__raw_writel</span><span class="p">(</span><span class="n">PHYS_OFFSET</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_IATVR1</span><span class="p">);</span>

	<span class="cm">/* Outbound window 1 (PCIX/PCIE memory window) */</span>
	<span class="cm">/* 32 bit Address Space */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_OUMWTVR1</span><span class="p">);</span>
	<span class="cm">/* PA[35:32] */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">IOP13XX_ATUE_OUMBAR_ENABLE</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">IOP13XX_PCIE_MEM_PHYS_OFFSET</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">),</span>
			<span class="n">IOP13XX_ATUE_OUMBAR1</span><span class="p">);</span>

	<span class="cm">/* Setup the I/O Bar</span>
<span class="cm">	 * A[35-16] in 31-12</span>
<span class="cm">	 */</span>
	<span class="n">__raw_writel</span><span class="p">(((</span><span class="n">IOP13XX_PCIE_LOWER_IO_PA</span> <span class="o">&gt;&gt;</span> <span class="mh">0x4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffff000</span><span class="p">),</span>
		<span class="n">IOP13XX_ATUE_OIOBAR</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">IOP13XX_PCIE_LOWER_IO_BA</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_OIOWTVR</span><span class="p">);</span>

	<span class="cm">/* clear startup errors */</span>
	<span class="n">iop13xx_atue_pci_status</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* OIOBAR function number</span>
<span class="cm">	 */</span>
	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ATUE_OIOBAR</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x7</span><span class="p">;</span>
	<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">func</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_OIOBAR</span><span class="p">);</span>

	<span class="cm">/* OUMBAR function numbers</span>
<span class="cm">	 */</span>
	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ATUE_OUMBAR0</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IOP13XX_ATU_OUMBAR_FUNC_NUM_MASK</span> <span class="o">&lt;&lt;</span>
			<span class="n">IOP13XX_ATU_OUMBAR_FUNC_NUM</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">func</span> <span class="o">&lt;&lt;</span> <span class="n">IOP13XX_ATU_OUMBAR_FUNC_NUM</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_OUMBAR0</span><span class="p">);</span>

	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ATUE_OUMBAR1</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IOP13XX_ATU_OUMBAR_FUNC_NUM_MASK</span> <span class="o">&lt;&lt;</span>
			<span class="n">IOP13XX_ATU_OUMBAR_FUNC_NUM</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">func</span> <span class="o">&lt;&lt;</span> <span class="n">IOP13XX_ATU_OUMBAR_FUNC_NUM</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_OUMBAR1</span><span class="p">);</span>

	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ATUE_OUMBAR2</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IOP13XX_ATU_OUMBAR_FUNC_NUM_MASK</span> <span class="o">&lt;&lt;</span>
			<span class="n">IOP13XX_ATU_OUMBAR_FUNC_NUM</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">func</span> <span class="o">&lt;&lt;</span> <span class="n">IOP13XX_ATU_OUMBAR_FUNC_NUM</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_OUMBAR2</span><span class="p">);</span>

	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ATUE_OUMBAR3</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IOP13XX_ATU_OUMBAR_FUNC_NUM_MASK</span> <span class="o">&lt;&lt;</span>
			<span class="n">IOP13XX_ATU_OUMBAR_FUNC_NUM</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">func</span> <span class="o">&lt;&lt;</span> <span class="n">IOP13XX_ATU_OUMBAR_FUNC_NUM</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_OUMBAR3</span><span class="p">);</span>

	<span class="cm">/* Enable inbound and outbound cycles</span>
<span class="cm">	 */</span>
	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">__raw_readw</span><span class="p">(</span><span class="n">IOP13XX_ATUE_ATUCMD</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">PCI_COMMAND_MEMORY</span> <span class="o">|</span> <span class="n">PCI_COMMAND_MASTER</span> <span class="o">|</span>
			<span class="n">PCI_COMMAND_PARITY</span> <span class="o">|</span> <span class="n">PCI_COMMAND_SERR</span><span class="p">;</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_ATUCMD</span><span class="p">);</span>

	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ATUE_ATUCR</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">IOP13XX_ATUE_ATUCR_OUT_EN</span> <span class="o">|</span>
			<span class="n">IOP13XX_ATUE_ATUCR_IVM</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_ATUCR</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">iop13xx_atue_disable</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg_val</span><span class="p">;</span>

	<span class="n">__raw_writew</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_ATUCMD</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">IOP13XX_ATUE_ATUCR_IVM</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_ATUCR</span><span class="p">);</span>

	<span class="cm">/* wait for cycles to quiesce */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ATUE_PCSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IOP13XX_ATUE_PCSR_OUT_Q_BUSY</span> <span class="o">|</span>
					     <span class="n">IOP13XX_ATUE_PCSR_IN_Q_BUSY</span> <span class="o">|</span>
					     <span class="n">IOP13XX_ATUE_PCSR_LLRB_BUSY</span><span class="p">))</span>
		<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="cm">/* BAR 0 ( Disabled ) */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_IAUBAR0</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_IABAR0</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_IAUTVR0</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_IATVR0</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_IALR0</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ATUE_OUMBAR0</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IOP13XX_ATUE_OUMBAR_ENABLE</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_OUMBAR0</span><span class="p">);</span>

	<span class="cm">/* BAR 1 ( Disabled ) */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_IAUBAR1</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_IABAR1</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_IAUTVR1</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_IATVR1</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_IALR1</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ATUE_OUMBAR1</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IOP13XX_ATUE_OUMBAR_ENABLE</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_OUMBAR1</span><span class="p">);</span>

	<span class="cm">/* BAR 2 ( Disabled ) */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_IAUBAR2</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_IABAR2</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_IAUTVR2</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_IATVR2</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_IALR2</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ATUE_OUMBAR2</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IOP13XX_ATUE_OUMBAR_ENABLE</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_OUMBAR2</span><span class="p">);</span>

	<span class="cm">/* BAR 3 ( Disabled ) */</span>
	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ATUE_OUMBAR3</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IOP13XX_ATUE_OUMBAR_ENABLE</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_OUMBAR3</span><span class="p">);</span>

	<span class="cm">/* Setup the I/O Bar</span>
<span class="cm">	 * A[35-16] in 31-12</span>
<span class="cm">	 */</span>
	<span class="n">__raw_writel</span><span class="p">((</span><span class="n">IOP13XX_PCIE_LOWER_IO_PA</span> <span class="o">&gt;&gt;</span> <span class="mh">0x4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffff000</span><span class="p">,</span>
			<span class="n">IOP13XX_ATUE_OIOBAR</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">IOP13XX_PCIE_LOWER_IO_BA</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_OIOWTVR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* This function is called from iop13xx_pci_init() after assigning valid</span>
<span class="cm"> * values to iop13xx_atux_pmmr_offset.  This is the location for common</span>
<span class="cm"> * setup of ATUX for all IOP13XX implementations.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">iop13xx_atux_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg_val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">func</span> <span class="o">=</span> <span class="n">iop13xx_atu_function</span><span class="p">(</span><span class="n">IOP13XX_INIT_ATU_ATUX</span><span class="p">);</span>

	<span class="cm">/* Take PCI-X bus out of reset if bootloader hasn&#39;t already.</span>
<span class="cm">	 * According to spec, we should wait for 2^25 PCI clocks to meet</span>
<span class="cm">	 * the PCI timing parameter Trhfa (RST# high to first access).</span>
<span class="cm">	 * This is rarely necessary and often ignored.</span>
<span class="cm">	 */</span>
	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ATUX_PCSR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg_val</span> <span class="o">&amp;</span> <span class="n">IOP13XX_ATUX_PCSR_P_RSTOUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">msec</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg_val</span> <span class="o">&gt;&gt;</span> <span class="n">IOP13XX_ATUX_PCSR_FREQ_OFFSET</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
		<span class="n">msec</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span><span class="o">-</span><span class="n">msec</span><span class="p">);</span> <span class="cm">/* bits 100=133MHz, 111=&gt;33MHz */</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">reg_val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IOP13XX_ATUX_PCSR_P_RSTOUT</span><span class="p">,</span>
				<span class="n">IOP13XX_ATUX_PCSR</span><span class="p">);</span>
		<span class="n">atux_trhfa_timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">msec</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">atux_trhfa_timeout</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PCI_MSI</span>
	<span class="cm">/* BAR 0 (inbound msi window) */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">IOP13XX_MU_BASE_PHYS</span><span class="p">,</span> <span class="n">IOP13XX_MU_MUBAR</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">IOP13XX_MU_WINDOW_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">IOP13XX_ATUX_IALR0</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">IOP13XX_MU_BASE_PHYS</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_IATVR0</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">IOP13XX_MU_BASE_PCI</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_IABAR0</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* BAR 1 (1:1 mapping with Physical RAM) */</span>
	<span class="cm">/* Set limit and enable */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">IOP13XX_MAX_RAM_SIZE</span> <span class="o">-</span> <span class="n">PHYS_OFFSET</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1</span><span class="p">,</span>
			<span class="n">IOP13XX_ATUX_IALR1</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_IAUBAR1</span><span class="p">);</span>

	<span class="cm">/* Set base at the top of the reserved address space */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">PHYS_OFFSET</span> <span class="o">|</span> <span class="n">PCI_BASE_ADDRESS_MEM_TYPE_64</span> <span class="o">|</span>
			<span class="n">PCI_BASE_ADDRESS_MEM_PREFETCH</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_IABAR1</span><span class="p">);</span>

	<span class="cm">/* 1:1 mapping with physical ram</span>
<span class="cm">	 * (leave big endian byte swap disabled)</span>
<span class="cm">	 */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_IAUTVR1</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">PHYS_OFFSET</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_IATVR1</span><span class="p">);</span>

	<span class="cm">/* Outbound window 1 (PCIX/PCIE memory window) */</span>
	<span class="cm">/* 32 bit Address Space */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_OUMWTVR1</span><span class="p">);</span>
	<span class="cm">/* PA[35:32] */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">IOP13XX_ATUX_OUMBAR_ENABLE</span> <span class="o">|</span>
			<span class="n">IOP13XX_PCIX_MEM_PHYS_OFFSET</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">,</span>
			<span class="n">IOP13XX_ATUX_OUMBAR1</span><span class="p">);</span>

	<span class="cm">/* Setup the I/O Bar</span>
<span class="cm">	 * A[35-16] in 31-12</span>
<span class="cm">	 */</span>
	<span class="n">__raw_writel</span><span class="p">((</span><span class="n">IOP13XX_PCIX_LOWER_IO_PA</span> <span class="o">&gt;&gt;</span> <span class="mh">0x4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffff000</span><span class="p">,</span>
		<span class="n">IOP13XX_ATUX_OIOBAR</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">IOP13XX_PCIX_LOWER_IO_BA</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_OIOWTVR</span><span class="p">);</span>

	<span class="cm">/* clear startup errors */</span>
	<span class="n">iop13xx_atux_pci_status</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* OIOBAR function number</span>
<span class="cm">	 */</span>
	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ATUX_OIOBAR</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x7</span><span class="p">;</span>
	<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">func</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_OIOBAR</span><span class="p">);</span>

	<span class="cm">/* OUMBAR function numbers</span>
<span class="cm">	 */</span>
	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ATUX_OUMBAR0</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IOP13XX_ATU_OUMBAR_FUNC_NUM_MASK</span> <span class="o">&lt;&lt;</span>
			<span class="n">IOP13XX_ATU_OUMBAR_FUNC_NUM</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">func</span> <span class="o">&lt;&lt;</span> <span class="n">IOP13XX_ATU_OUMBAR_FUNC_NUM</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_OUMBAR0</span><span class="p">);</span>

	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ATUX_OUMBAR1</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IOP13XX_ATU_OUMBAR_FUNC_NUM_MASK</span> <span class="o">&lt;&lt;</span>
			<span class="n">IOP13XX_ATU_OUMBAR_FUNC_NUM</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">func</span> <span class="o">&lt;&lt;</span> <span class="n">IOP13XX_ATU_OUMBAR_FUNC_NUM</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_OUMBAR1</span><span class="p">);</span>

	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ATUX_OUMBAR2</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IOP13XX_ATU_OUMBAR_FUNC_NUM_MASK</span> <span class="o">&lt;&lt;</span>
			<span class="n">IOP13XX_ATU_OUMBAR_FUNC_NUM</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">func</span> <span class="o">&lt;&lt;</span> <span class="n">IOP13XX_ATU_OUMBAR_FUNC_NUM</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_OUMBAR2</span><span class="p">);</span>

	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ATUX_OUMBAR3</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IOP13XX_ATU_OUMBAR_FUNC_NUM_MASK</span> <span class="o">&lt;&lt;</span>
			<span class="n">IOP13XX_ATU_OUMBAR_FUNC_NUM</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">func</span> <span class="o">&lt;&lt;</span> <span class="n">IOP13XX_ATU_OUMBAR_FUNC_NUM</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_OUMBAR3</span><span class="p">);</span>

	<span class="cm">/* Enable inbound and outbound cycles</span>
<span class="cm">	 */</span>
	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">__raw_readw</span><span class="p">(</span><span class="n">IOP13XX_ATUX_ATUCMD</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">PCI_COMMAND_MEMORY</span> <span class="o">|</span> <span class="n">PCI_COMMAND_MASTER</span> <span class="o">|</span>
		        <span class="n">PCI_COMMAND_PARITY</span> <span class="o">|</span> <span class="n">PCI_COMMAND_SERR</span><span class="p">;</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_ATUCMD</span><span class="p">);</span>

	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ATUX_ATUCR</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">IOP13XX_ATUX_ATUCR_OUT_EN</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_ATUCR</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">iop13xx_atux_disable</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg_val</span><span class="p">;</span>

	<span class="n">__raw_writew</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_ATUCMD</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_ATUCR</span><span class="p">);</span>

	<span class="cm">/* wait for cycles to quiesce */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ATUX_PCSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IOP13XX_ATUX_PCSR_OUT_Q_BUSY</span> <span class="o">|</span>
				     <span class="n">IOP13XX_ATUX_PCSR_IN_Q_BUSY</span><span class="p">))</span>
		<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="cm">/* BAR 0 ( Disabled ) */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_IAUBAR0</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_IABAR0</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_IAUTVR0</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_IATVR0</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_IALR0</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ATUX_OUMBAR0</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IOP13XX_ATUX_OUMBAR_ENABLE</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_OUMBAR0</span><span class="p">);</span>

	<span class="cm">/* BAR 1 ( Disabled ) */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_IAUBAR1</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_IABAR1</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_IAUTVR1</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_IATVR1</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_IALR1</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ATUX_OUMBAR1</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IOP13XX_ATUX_OUMBAR_ENABLE</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_OUMBAR1</span><span class="p">);</span>

	<span class="cm">/* BAR 2 ( Disabled ) */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_IAUBAR2</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_IABAR2</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_IAUTVR2</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_IATVR2</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_IALR2</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ATUX_OUMBAR2</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IOP13XX_ATUX_OUMBAR_ENABLE</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_OUMBAR2</span><span class="p">);</span>

	<span class="cm">/* BAR 3 ( Disabled ) */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_IAUBAR3</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_IABAR3</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_IAUTVR3</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_IATVR3</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_IALR3</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ATUX_OUMBAR3</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IOP13XX_ATUX_OUMBAR_ENABLE</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_OUMBAR3</span><span class="p">);</span>

	<span class="cm">/* Setup the I/O Bar</span>
<span class="cm">	* A[35-16] in 31-12</span>
<span class="cm">	*/</span>
	<span class="n">__raw_writel</span><span class="p">((</span><span class="n">IOP13XX_PCIX_LOWER_IO_PA</span> <span class="o">&gt;&gt;</span> <span class="mh">0x4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffff000</span><span class="p">,</span>
			<span class="n">IOP13XX_ATUX_OIOBAR</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">IOP13XX_PCIX_LOWER_IO_BA</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_OIOWTVR</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">iop13xx_set_atu_mmr_bases</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Based on ESSR0, determine the ATU X/E offsets */</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ESSR0</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">IOP13XX_CONTROLLER_ONLY</span> <span class="o">|</span> <span class="n">IOP13XX_INTERFACE_SEL_PCIX</span><span class="p">))</span> <span class="p">{</span>
	<span class="cm">/* both asserted */</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">iop13xx_atux_pmmr_offset</span> <span class="o">=</span> <span class="n">IOP13XX_ATU1_PMMR_OFFSET</span><span class="p">;</span>
		<span class="n">iop13xx_atue_pmmr_offset</span> <span class="o">=</span> <span class="n">IOP13XX_ATU2_PMMR_OFFSET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* IOP13XX_CONTROLLER_ONLY = deasserted</span>
<span class="cm">	 * IOP13XX_INTERFACE_SEL_PCIX = asserted</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">IOP13XX_CONTROLLER_ONLY</span>:
		<span class="n">iop13xx_atux_pmmr_offset</span> <span class="o">=</span> <span class="n">IOP13XX_ATU0_PMMR_OFFSET</span><span class="p">;</span>
		<span class="n">iop13xx_atue_pmmr_offset</span> <span class="o">=</span> <span class="n">IOP13XX_ATU2_PMMR_OFFSET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* IOP13XX_CONTROLLER_ONLY = asserted</span>
<span class="cm">	 * IOP13XX_INTERFACE_SEL_PCIX = deasserted</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">IOP13XX_INTERFACE_SEL_PCIX</span>:
		<span class="n">iop13xx_atux_pmmr_offset</span> <span class="o">=</span> <span class="n">IOP13XX_ATU1_PMMR_OFFSET</span><span class="p">;</span>
		<span class="n">iop13xx_atue_pmmr_offset</span> <span class="o">=</span> <span class="n">IOP13XX_ATU2_PMMR_OFFSET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* both deasserted */</span>
	<span class="k">case</span> <span class="n">IOP13XX_CONTROLLER_ONLY</span> <span class="o">|</span> <span class="n">IOP13XX_INTERFACE_SEL_PCIX</span>:
		<span class="n">iop13xx_atux_pmmr_offset</span> <span class="o">=</span> <span class="n">IOP13XX_ATU2_PMMR_OFFSET</span><span class="p">;</span>
		<span class="n">iop13xx_atue_pmmr_offset</span> <span class="o">=</span> <span class="n">IOP13XX_ATU0_PMMR_OFFSET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">iop13xx_atu_select</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_pci</span> <span class="o">*</span><span class="n">plat_pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* set system defaults</span>
<span class="cm">	 * note: if &quot;iop13xx_init_atu=&quot; is specified this autodetect</span>
<span class="cm">	 * sequence will be bypassed</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">init_atu</span> <span class="o">==</span> <span class="n">IOP13XX_INIT_ATU_DEFAULT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* check for single/dual interface */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ESSR0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IOP13XX_INTERFACE_SEL_PCIX</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* ATUE must be present check the device id</span>
<span class="cm">			 * to see if ATUX is present.</span>
<span class="cm">			 */</span>
			<span class="n">init_atu</span> <span class="o">|=</span> <span class="n">IOP13XX_INIT_ATU_ATUE</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">__raw_readw</span><span class="p">(</span><span class="n">IOP13XX_ATUE_DID</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x70</span>:
			<span class="k">case</span> <span class="mh">0x80</span>:
			<span class="k">case</span> <span class="mh">0xc0</span>:
				<span class="n">init_atu</span> <span class="o">|=</span> <span class="n">IOP13XX_INIT_ATU_ATUX</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* ATUX must be present check the device id</span>
<span class="cm">			 * to see if ATUE is present.</span>
<span class="cm">			 */</span>
			<span class="n">init_atu</span> <span class="o">|=</span> <span class="n">IOP13XX_INIT_ATU_ATUX</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">__raw_readw</span><span class="p">(</span><span class="n">IOP13XX_ATUX_DID</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x70</span>:
			<span class="k">case</span> <span class="mh">0x80</span>:
			<span class="k">case</span> <span class="mh">0xc0</span>:
				<span class="n">init_atu</span> <span class="o">|=</span> <span class="n">IOP13XX_INIT_ATU_ATUE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* check central resource and root complex capability */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">init_atu</span> <span class="o">&amp;</span> <span class="n">IOP13XX_INIT_ATU_ATUX</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ATUX_PCSR</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="n">IOP13XX_ATUX_PCSR_CENTRAL_RES</span><span class="p">))</span>
				<span class="n">init_atu</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IOP13XX_INIT_ATU_ATUX</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">init_atu</span> <span class="o">&amp;</span> <span class="n">IOP13XX_INIT_ATU_ATUE</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ATUE_PCSR</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="n">IOP13XX_ATUE_PCSR_END_POINT</span><span class="p">)</span>
				<span class="n">init_atu</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IOP13XX_INIT_ATU_ATUE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">((</span><span class="n">init_atu</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
			<span class="n">plat_pci</span><span class="o">-&gt;</span><span class="n">nr_controllers</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">iop13xx_pci_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* clear pre-existing south bridge errors */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_XBG_BECSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">,</span> <span class="n">IOP13XX_XBG_BECSR</span><span class="p">);</span>

	<span class="cm">/* Setup the Min Address for PCI memory... */</span>
	<span class="n">pcibios_min_io</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pcibios_min_mem</span> <span class="o">=</span> <span class="n">IOP13XX_PCIX_LOWER_MEM_BA</span><span class="p">;</span>

	<span class="cm">/* if Linux is given control of an ATU</span>
<span class="cm">	 * clear out its prior configuration,</span>
<span class="cm">	 * otherwise do not touch the registers</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">init_atu</span> <span class="o">&amp;</span> <span class="n">IOP13XX_INIT_ATU_ATUE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iop13xx_atue_disable</span><span class="p">();</span>
		<span class="n">iop13xx_atue_setup</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">init_atu</span> <span class="o">&amp;</span> <span class="n">IOP13XX_INIT_ATU_ATUX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iop13xx_atux_disable</span><span class="p">();</span>
		<span class="n">iop13xx_atux_setup</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">hook_fault_code</span><span class="p">(</span><span class="mi">16</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="n">iop13xx_pci_abort</span><span class="p">,</span> <span class="n">SIGBUS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="s">&quot;imprecise external abort&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* initialize the pci memory space.  handle any combination of</span>
<span class="cm"> * atue and atux enabled/disabled</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">iop13xx_pci_setup</span><span class="p">(</span><span class="kt">int</span> <span class="n">nr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_sys_data</span> <span class="o">*</span><span class="n">sys</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">which_atu</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pcixsr</span><span class="p">,</span> <span class="n">pcsr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;PCI: unable to alloc resources&quot;</span><span class="p">);</span>


	<span class="cm">/* &#39;nr&#39; assumptions:</span>
<span class="cm">	 * ATUX is always 0</span>
<span class="cm">	 * ATUE is 1 when ATUX is also enabled</span>
<span class="cm">	 * ATUE is 0 when ATUX is disabled</span>
<span class="cm">	 */</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">init_atu</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOP13XX_INIT_ATU_ATUX</span>:
		<span class="n">which_atu</span> <span class="o">=</span> <span class="n">nr</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">IOP13XX_INIT_ATU_ATUX</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IOP13XX_INIT_ATU_ATUE</span>:
		<span class="n">which_atu</span> <span class="o">=</span> <span class="n">nr</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">IOP13XX_INIT_ATU_ATUE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">IOP13XX_INIT_ATU_ATUX</span> <span class="o">|</span> <span class="n">IOP13XX_INIT_ATU_ATUE</span><span class="p">)</span>:
		<span class="n">which_atu</span> <span class="o">=</span> <span class="n">nr</span> <span class="o">?</span> <span class="n">IOP13XX_INIT_ATU_ATUE</span> <span class="o">:</span> <span class="n">IOP13XX_INIT_ATU_ATUX</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">which_atu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">which_atu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">which_atu</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOP13XX_INIT_ATU_ATUX</span>:
		<span class="n">pcixsr</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ATUX_PCIXSR</span><span class="p">);</span>
		<span class="n">pcixsr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">pcixsr</span> <span class="o">|=</span> <span class="n">sys</span><span class="o">-&gt;</span><span class="n">busnr</span> <span class="o">&lt;&lt;</span> <span class="n">IOP13XX_ATUX_PCIXSR_BUS_NUM</span> <span class="o">|</span>
			  <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">IOP13XX_ATUX_PCIXSR_DEV_NUM</span> <span class="o">|</span>
			  <span class="n">iop13xx_atu_function</span><span class="p">(</span><span class="n">IOP13XX_INIT_ATU_ATUX</span><span class="p">)</span>
				  <span class="o">&lt;&lt;</span> <span class="n">IOP13XX_ATUX_PCIXSR_FUNC_NUM</span><span class="p">;</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">pcixsr</span><span class="p">,</span> <span class="n">IOP13XX_ATUX_PCIXSR</span><span class="p">);</span>

		<span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span> <span class="o">=</span> <span class="n">IOP13XX_PCIX_LOWER_IO_PA</span> <span class="o">+</span> <span class="n">IOP13XX_PCIX_IO_BUS_OFFSET</span><span class="p">;</span>
		<span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">end</span>   <span class="o">=</span> <span class="n">IOP13XX_PCIX_UPPER_IO_PA</span><span class="p">;</span>
		<span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;IQ81340 ATUX PCI I/O Space&quot;</span><span class="p">;</span>
		<span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IO</span><span class="p">;</span>

		<span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span> <span class="o">=</span> <span class="n">IOP13XX_PCIX_LOWER_MEM_RA</span><span class="p">;</span>
		<span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">end</span>   <span class="o">=</span> <span class="n">IOP13XX_PCIX_UPPER_MEM_RA</span><span class="p">;</span>
		<span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;IQ81340 ATUX PCI Memory Space&quot;</span><span class="p">;</span>
		<span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">;</span>
		<span class="n">sys</span><span class="o">-&gt;</span><span class="n">mem_offset</span> <span class="o">=</span> <span class="n">IOP13XX_PCIX_MEM_OFFSET</span><span class="p">;</span>
		<span class="n">sys</span><span class="o">-&gt;</span><span class="n">io_offset</span> <span class="o">=</span> <span class="n">IOP13XX_PCIX_LOWER_IO_PA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IOP13XX_INIT_ATU_ATUE</span>:
		<span class="cm">/* Note: the function number field in the PCSR is ro */</span>
		<span class="n">pcsr</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ATUE_PCSR</span><span class="p">);</span>
		<span class="n">pcsr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xfff8</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">pcsr</span> <span class="o">|=</span> <span class="n">sys</span><span class="o">-&gt;</span><span class="n">busnr</span> <span class="o">&lt;&lt;</span> <span class="n">IOP13XX_ATUE_PCSR_BUS_NUM</span> <span class="o">|</span>
				<span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">IOP13XX_ATUE_PCSR_DEV_NUM</span><span class="p">;</span>

		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">pcsr</span><span class="p">,</span> <span class="n">IOP13XX_ATUE_PCSR</span><span class="p">);</span>

		<span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span> <span class="o">=</span> <span class="n">IOP13XX_PCIE_LOWER_IO_PA</span> <span class="o">+</span> <span class="n">IOP13XX_PCIE_IO_BUS_OFFSET</span><span class="p">;</span>
		<span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">end</span>   <span class="o">=</span> <span class="n">IOP13XX_PCIE_UPPER_IO_PA</span><span class="p">;</span>
		<span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;IQ81340 ATUE PCI I/O Space&quot;</span><span class="p">;</span>
		<span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IO</span><span class="p">;</span>

		<span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span> <span class="o">=</span> <span class="n">IOP13XX_PCIE_LOWER_MEM_RA</span><span class="p">;</span>
		<span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">end</span>   <span class="o">=</span> <span class="n">IOP13XX_PCIE_UPPER_MEM_RA</span><span class="p">;</span>
		<span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;IQ81340 ATUE PCI Memory Space&quot;</span><span class="p">;</span>
		<span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">;</span>
		<span class="n">sys</span><span class="o">-&gt;</span><span class="n">mem_offset</span> <span class="o">=</span> <span class="n">IOP13XX_PCIE_MEM_OFFSET</span><span class="p">;</span>
		<span class="n">sys</span><span class="o">-&gt;</span><span class="n">io_offset</span> <span class="o">=</span> <span class="n">IOP13XX_PCIE_LOWER_IO_PA</span><span class="p">;</span>
		<span class="n">sys</span><span class="o">-&gt;</span><span class="n">map_irq</span> <span class="o">=</span> <span class="n">iop13xx_pcie_map_irq</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">request_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioport_resource</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">request_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iomem_resource</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="n">pci_add_resource_offset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sys</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sys</span><span class="o">-&gt;</span><span class="n">io_offset</span><span class="p">);</span>
	<span class="n">pci_add_resource_offset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sys</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sys</span><span class="o">-&gt;</span><span class="n">mem_offset</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u16</span> <span class="nf">iop13xx_dev_id</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">IOP13XX_ESSR0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IOP13XX_INTERFACE_SEL_PCIX</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">__raw_readw</span><span class="p">(</span><span class="n">IOP13XX_ATUE_DID</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">__raw_readw</span><span class="p">(</span><span class="n">IOP13XX_ATUX_DID</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">iop13xx_init_atu_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">init_atu</span> <span class="o">=</span> <span class="n">IOP13XX_INIT_ATU_NONE</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">case</span> <span class="sc">&#39;x&#39;</span>:
                        <span class="k">case</span> <span class="sc">&#39;X&#39;</span>:
                                <span class="n">init_atu</span> <span class="o">|=</span> <span class="n">IOP13XX_INIT_ATU_ATUX</span><span class="p">;</span>
                                <span class="n">init_atu</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IOP13XX_INIT_ATU_NONE</span><span class="p">;</span>
                                <span class="k">break</span><span class="p">;</span>
                        <span class="k">case</span> <span class="sc">&#39;e&#39;</span>:
                        <span class="k">case</span> <span class="sc">&#39;E&#39;</span>:
                                <span class="n">init_atu</span> <span class="o">|=</span> <span class="n">IOP13XX_INIT_ATU_ATUE</span><span class="p">;</span>
                                <span class="n">init_atu</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IOP13XX_INIT_ATU_NONE</span><span class="p">;</span>
                                <span class="k">break</span><span class="p">;</span>
                        <span class="k">case</span> <span class="sc">&#39;,&#39;</span>:
                        <span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
                                <span class="k">break</span><span class="p">;</span>
                        <span class="nl">default:</span>
                                <span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">iop13xx_init_atu</span><span class="se">\&quot;</span><span class="s"> malformed at &quot;</span>
                                            <span class="s">&quot;character: </span><span class="se">\&#39;</span><span class="s">%c</span><span class="se">\&#39;</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">str</span><span class="p">);</span>
                                <span class="o">*</span><span class="p">(</span><span class="n">str</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
                                <span class="n">init_atu</span> <span class="o">=</span> <span class="n">IOP13XX_INIT_ATU_DEFAULT</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="n">str</span><span class="o">++</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;iop13xx_init_atu&quot;</span><span class="p">,</span> <span class="n">iop13xx_init_atu_setup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
