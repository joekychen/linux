<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › mach-pxa › mioa701.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>mioa701.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Handles the Mitac Mio A701 Board</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2008 Robert Jarzmik</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/syscore_ops.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/gpio_keys.h&gt;</span>
<span class="cp">#include &lt;linux/pwm_backlight.h&gt;</span>
<span class="cp">#include &lt;linux/rtc.h&gt;</span>
<span class="cp">#include &lt;linux/leds.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/pda_power.h&gt;</span>
<span class="cp">#include &lt;linux/power_supply.h&gt;</span>
<span class="cp">#include &lt;linux/wm97xx.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/physmap.h&gt;</span>
<span class="cp">#include &lt;linux/usb/gpio_vbus.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/max1586.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/i2c/pxa-i2c.h&gt;</span>

<span class="cp">#include &lt;asm/mach-types.h&gt;</span>
<span class="cp">#include &lt;asm/mach/arch.h&gt;</span>

<span class="cp">#include &lt;mach/pxa27x.h&gt;</span>
<span class="cp">#include &lt;mach/regs-rtc.h&gt;</span>
<span class="cp">#include &lt;plat/pxa27x_keypad.h&gt;</span>
<span class="cp">#include &lt;mach/pxafb.h&gt;</span>
<span class="cp">#include &lt;mach/mmc.h&gt;</span>
<span class="cp">#include &lt;mach/udc.h&gt;</span>
<span class="cp">#include &lt;mach/pxa27x-udc.h&gt;</span>
<span class="cp">#include &lt;mach/camera.h&gt;</span>
<span class="cp">#include &lt;mach/audio.h&gt;</span>
<span class="cp">#include &lt;mach/smemc.h&gt;</span>
<span class="cp">#include &lt;media/soc_camera.h&gt;</span>

<span class="cp">#include &lt;mach/mioa701.h&gt;</span>

<span class="cp">#include &quot;generic.h&quot;</span>
<span class="cp">#include &quot;devices.h&quot;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mioa701_pin_config</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Mio global */</span>
	<span class="n">MIO_CFG_OUT</span><span class="p">(</span><span class="n">GPIO9_CHARGE_EN</span><span class="p">,</span> <span class="n">AF0</span><span class="p">,</span> <span class="n">DRIVE_LOW</span><span class="p">),</span>
	<span class="n">MIO_CFG_OUT</span><span class="p">(</span><span class="n">GPIO18_POWEROFF</span><span class="p">,</span> <span class="n">AF0</span><span class="p">,</span> <span class="n">DRIVE_LOW</span><span class="p">),</span>
	<span class="n">MFP_CFG_OUT</span><span class="p">(</span><span class="n">GPIO3</span><span class="p">,</span> <span class="n">AF0</span><span class="p">,</span> <span class="n">DRIVE_HIGH</span><span class="p">),</span>
	<span class="n">MFP_CFG_OUT</span><span class="p">(</span><span class="n">GPIO4</span><span class="p">,</span> <span class="n">AF0</span><span class="p">,</span> <span class="n">DRIVE_HIGH</span><span class="p">),</span>
	<span class="n">MIO_CFG_IN</span><span class="p">(</span><span class="n">GPIO80_MAYBE_CHARGE_VDROP</span><span class="p">,</span> <span class="n">AF0</span><span class="p">),</span>

	<span class="cm">/* Backlight PWM 0 */</span>
	<span class="n">GPIO16_PWM0_OUT</span><span class="p">,</span>

	<span class="cm">/* MMC */</span>
	<span class="n">GPIO32_MMC_CLK</span><span class="p">,</span>
	<span class="n">GPIO92_MMC_DAT_0</span><span class="p">,</span>
	<span class="n">GPIO109_MMC_DAT_1</span><span class="p">,</span>
	<span class="n">GPIO110_MMC_DAT_2</span><span class="p">,</span>
	<span class="n">GPIO111_MMC_DAT_3</span><span class="p">,</span>
	<span class="n">GPIO112_MMC_CMD</span><span class="p">,</span>
	<span class="n">MIO_CFG_IN</span><span class="p">(</span><span class="n">GPIO78_SDIO_RO</span><span class="p">,</span> <span class="n">AF0</span><span class="p">),</span>
	<span class="n">MIO_CFG_IN</span><span class="p">(</span><span class="n">GPIO15_SDIO_INSERT</span><span class="p">,</span> <span class="n">AF0</span><span class="p">),</span>
	<span class="n">MIO_CFG_OUT</span><span class="p">(</span><span class="n">GPIO91_SDIO_EN</span><span class="p">,</span> <span class="n">AF0</span><span class="p">,</span> <span class="n">DRIVE_LOW</span><span class="p">),</span>

	<span class="cm">/* USB */</span>
	<span class="n">MIO_CFG_IN</span><span class="p">(</span><span class="n">GPIO13_nUSB_DETECT</span><span class="p">,</span> <span class="n">AF0</span><span class="p">),</span>
	<span class="n">MIO_CFG_OUT</span><span class="p">(</span><span class="n">GPIO22_USB_ENABLE</span><span class="p">,</span> <span class="n">AF0</span><span class="p">,</span> <span class="n">DRIVE_LOW</span><span class="p">),</span>

	<span class="cm">/* LCD */</span>
	<span class="n">GPIOxx_LCD_TFT_16BPP</span><span class="p">,</span>

	<span class="cm">/* QCI */</span>
	<span class="n">GPIO12_CIF_DD_7</span><span class="p">,</span>
	<span class="n">GPIO17_CIF_DD_6</span><span class="p">,</span>
	<span class="n">GPIO50_CIF_DD_3</span><span class="p">,</span>
	<span class="n">GPIO51_CIF_DD_2</span><span class="p">,</span>
	<span class="n">GPIO52_CIF_DD_4</span><span class="p">,</span>
	<span class="n">GPIO53_CIF_MCLK</span><span class="p">,</span>
	<span class="n">GPIO54_CIF_PCLK</span><span class="p">,</span>
	<span class="n">GPIO55_CIF_DD_1</span><span class="p">,</span>
	<span class="n">GPIO81_CIF_DD_0</span><span class="p">,</span>
	<span class="n">GPIO82_CIF_DD_5</span><span class="p">,</span>
	<span class="n">GPIO84_CIF_FV</span><span class="p">,</span>
	<span class="n">GPIO85_CIF_LV</span><span class="p">,</span>
	<span class="n">MIO_CFG_OUT</span><span class="p">(</span><span class="n">GPIO56_MT9M111_nOE</span><span class="p">,</span> <span class="n">AF0</span><span class="p">,</span> <span class="n">DRIVE_LOW</span><span class="p">),</span>

	<span class="cm">/* Bluetooth */</span>
	<span class="n">MIO_CFG_IN</span><span class="p">(</span><span class="n">GPIO14_BT_nACTIVITY</span><span class="p">,</span> <span class="n">AF0</span><span class="p">),</span>
	<span class="n">GPIO44_BTUART_CTS</span><span class="p">,</span>
	<span class="n">GPIO42_BTUART_RXD</span><span class="p">,</span>
	<span class="n">GPIO45_BTUART_RTS</span><span class="p">,</span>
	<span class="n">GPIO43_BTUART_TXD</span><span class="p">,</span>
	<span class="n">MIO_CFG_OUT</span><span class="p">(</span><span class="n">GPIO83_BT_ON</span><span class="p">,</span> <span class="n">AF0</span><span class="p">,</span> <span class="n">DRIVE_LOW</span><span class="p">),</span>
	<span class="n">MIO_CFG_OUT</span><span class="p">(</span><span class="n">GPIO77_BT_UNKNOWN1</span><span class="p">,</span> <span class="n">AF0</span><span class="p">,</span> <span class="n">DRIVE_HIGH</span><span class="p">),</span>
	<span class="n">MIO_CFG_OUT</span><span class="p">(</span><span class="n">GPIO86_BT_MAYBE_nRESET</span><span class="p">,</span> <span class="n">AF0</span><span class="p">,</span> <span class="n">DRIVE_HIGH</span><span class="p">),</span>

	<span class="cm">/* GPS */</span>
	<span class="n">MIO_CFG_OUT</span><span class="p">(</span><span class="n">GPIO23_GPS_UNKNOWN1</span><span class="p">,</span> <span class="n">AF0</span><span class="p">,</span> <span class="n">DRIVE_LOW</span><span class="p">),</span>
	<span class="n">MIO_CFG_OUT</span><span class="p">(</span><span class="n">GPIO26_GPS_ON</span><span class="p">,</span> <span class="n">AF0</span><span class="p">,</span> <span class="n">DRIVE_LOW</span><span class="p">),</span>
	<span class="n">MIO_CFG_OUT</span><span class="p">(</span><span class="n">GPIO27_GPS_RESET</span><span class="p">,</span> <span class="n">AF0</span><span class="p">,</span> <span class="n">DRIVE_LOW</span><span class="p">),</span>
	<span class="n">MIO_CFG_OUT</span><span class="p">(</span><span class="n">GPIO106_GPS_UNKNOWN2</span><span class="p">,</span> <span class="n">AF0</span><span class="p">,</span> <span class="n">DRIVE_LOW</span><span class="p">),</span>
	<span class="n">MIO_CFG_OUT</span><span class="p">(</span><span class="n">GPIO107_GPS_UNKNOWN3</span><span class="p">,</span> <span class="n">AF0</span><span class="p">,</span> <span class="n">DRIVE_LOW</span><span class="p">),</span>
	<span class="n">GPIO46_STUART_RXD</span><span class="p">,</span>
	<span class="n">GPIO47_STUART_TXD</span><span class="p">,</span>

	<span class="cm">/* GSM */</span>
	<span class="n">MIO_CFG_OUT</span><span class="p">(</span><span class="n">GPIO24_GSM_MOD_RESET_CMD</span><span class="p">,</span> <span class="n">AF0</span><span class="p">,</span> <span class="n">DRIVE_LOW</span><span class="p">),</span>
	<span class="n">MIO_CFG_OUT</span><span class="p">(</span><span class="n">GPIO88_GSM_nMOD_ON_CMD</span><span class="p">,</span> <span class="n">AF0</span><span class="p">,</span> <span class="n">DRIVE_HIGH</span><span class="p">),</span>
	<span class="n">MIO_CFG_OUT</span><span class="p">(</span><span class="n">GPIO90_GSM_nMOD_OFF_CMD</span><span class="p">,</span> <span class="n">AF0</span><span class="p">,</span> <span class="n">DRIVE_HIGH</span><span class="p">),</span>
	<span class="n">MIO_CFG_OUT</span><span class="p">(</span><span class="n">GPIO114_GSM_nMOD_DTE_UART_STATE</span><span class="p">,</span> <span class="n">AF0</span><span class="p">,</span> <span class="n">DRIVE_HIGH</span><span class="p">),</span>
	<span class="n">MIO_CFG_IN</span><span class="p">(</span><span class="n">GPIO25_GSM_MOD_ON_STATE</span><span class="p">,</span> <span class="n">AF0</span><span class="p">),</span>
	<span class="n">MIO_CFG_IN</span><span class="p">(</span><span class="n">GPIO113_GSM_EVENT</span><span class="p">,</span> <span class="n">AF0</span><span class="p">)</span> <span class="o">|</span> <span class="n">WAKEUP_ON_EDGE_BOTH</span><span class="p">,</span>
	<span class="n">GPIO34_FFUART_RXD</span><span class="p">,</span>
	<span class="n">GPIO35_FFUART_CTS</span><span class="p">,</span>
	<span class="n">GPIO36_FFUART_DCD</span><span class="p">,</span>
	<span class="n">GPIO37_FFUART_DSR</span><span class="p">,</span>
	<span class="n">GPIO39_FFUART_TXD</span><span class="p">,</span>
	<span class="n">GPIO40_FFUART_DTR</span><span class="p">,</span>
	<span class="n">GPIO41_FFUART_RTS</span><span class="p">,</span>

	<span class="cm">/* Sound */</span>
	<span class="n">GPIO28_AC97_BITCLK</span><span class="p">,</span>
	<span class="n">GPIO29_AC97_SDATA_IN_0</span><span class="p">,</span>
	<span class="n">GPIO30_AC97_SDATA_OUT</span><span class="p">,</span>
	<span class="n">GPIO31_AC97_SYNC</span><span class="p">,</span>
	<span class="n">GPIO89_AC97_SYSCLK</span><span class="p">,</span>
	<span class="n">MIO_CFG_IN</span><span class="p">(</span><span class="n">GPIO12_HPJACK_INSERT</span><span class="p">,</span> <span class="n">AF0</span><span class="p">),</span>

	<span class="cm">/* Leds */</span>
	<span class="n">MIO_CFG_OUT</span><span class="p">(</span><span class="n">GPIO10_LED_nCharging</span><span class="p">,</span> <span class="n">AF0</span><span class="p">,</span> <span class="n">DRIVE_HIGH</span><span class="p">),</span>
	<span class="n">MIO_CFG_OUT</span><span class="p">(</span><span class="n">GPIO97_LED_nBlue</span><span class="p">,</span> <span class="n">AF0</span><span class="p">,</span> <span class="n">DRIVE_HIGH</span><span class="p">),</span>
	<span class="n">MIO_CFG_OUT</span><span class="p">(</span><span class="n">GPIO98_LED_nOrange</span><span class="p">,</span> <span class="n">AF0</span><span class="p">,</span> <span class="n">DRIVE_HIGH</span><span class="p">),</span>
	<span class="n">MIO_CFG_OUT</span><span class="p">(</span><span class="n">GPIO82_LED_nVibra</span><span class="p">,</span> <span class="n">AF0</span><span class="p">,</span> <span class="n">DRIVE_HIGH</span><span class="p">),</span>
	<span class="n">MIO_CFG_OUT</span><span class="p">(</span><span class="n">GPIO115_LED_nKeyboard</span><span class="p">,</span> <span class="n">AF0</span><span class="p">,</span> <span class="n">DRIVE_HIGH</span><span class="p">),</span>

	<span class="cm">/* Keyboard */</span>
	<span class="n">MIO_CFG_IN</span><span class="p">(</span><span class="n">GPIO0_KEY_POWER</span><span class="p">,</span> <span class="n">AF0</span><span class="p">)</span> <span class="o">|</span> <span class="n">WAKEUP_ON_EDGE_BOTH</span><span class="p">,</span>
	<span class="n">MIO_CFG_IN</span><span class="p">(</span><span class="n">GPIO93_KEY_VOLUME_UP</span><span class="p">,</span> <span class="n">AF0</span><span class="p">),</span>
	<span class="n">MIO_CFG_IN</span><span class="p">(</span><span class="n">GPIO94_KEY_VOLUME_DOWN</span><span class="p">,</span> <span class="n">AF0</span><span class="p">),</span>
	<span class="n">GPIO100_KP_MKIN_0</span><span class="p">,</span>
	<span class="n">GPIO101_KP_MKIN_1</span><span class="p">,</span>
	<span class="n">GPIO102_KP_MKIN_2</span><span class="p">,</span>
	<span class="n">GPIO103_KP_MKOUT_0</span><span class="p">,</span>
	<span class="n">GPIO104_KP_MKOUT_1</span><span class="p">,</span>
	<span class="n">GPIO105_KP_MKOUT_2</span><span class="p">,</span>

	<span class="cm">/* I2C */</span>
	<span class="n">GPIO117_I2C_SCL</span><span class="p">,</span>
	<span class="n">GPIO118_I2C_SDA</span><span class="p">,</span>

	<span class="cm">/* Unknown */</span>
	<span class="n">MFP_CFG_IN</span><span class="p">(</span><span class="n">GPIO20</span><span class="p">,</span> <span class="n">AF0</span><span class="p">),</span>
	<span class="n">MFP_CFG_IN</span><span class="p">(</span><span class="n">GPIO21</span><span class="p">,</span> <span class="n">AF0</span><span class="p">),</span>
	<span class="n">MFP_CFG_IN</span><span class="p">(</span><span class="n">GPIO33</span><span class="p">,</span> <span class="n">AF0</span><span class="p">),</span>
	<span class="n">MFP_CFG_OUT</span><span class="p">(</span><span class="n">GPIO49</span><span class="p">,</span> <span class="n">AF0</span><span class="p">,</span> <span class="n">DRIVE_HIGH</span><span class="p">),</span>
	<span class="n">MFP_CFG_OUT</span><span class="p">(</span><span class="n">GPIO57</span><span class="p">,</span> <span class="n">AF0</span><span class="p">,</span> <span class="n">DRIVE_HIGH</span><span class="p">),</span>
	<span class="n">MFP_CFG_IN</span><span class="p">(</span><span class="n">GPIO96</span><span class="p">,</span> <span class="n">AF0</span><span class="p">),</span>
	<span class="n">MFP_CFG_OUT</span><span class="p">(</span><span class="n">GPIO116</span><span class="p">,</span> <span class="n">AF0</span><span class="p">,</span> <span class="n">DRIVE_HIGH</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* LCD Screen and Backlight */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_pwm_backlight_data</span> <span class="n">mioa701_backlight_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">pwm_id</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_brightness</span>	<span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dft_brightness</span>	<span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pwm_period_ns</span>	<span class="o">=</span> <span class="mi">4000</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>	<span class="cm">/* Fl = 250kHz */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * LTM0305A776C LCD panel timings</span>
<span class="cm"> *</span>
<span class="cm"> * see:</span>
<span class="cm"> *  - the LTM0305A776C datasheet,</span>
<span class="cm"> *  - and the PXA27x Programmers&#39; manual</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pxafb_mode_info</span> <span class="n">mioa701_ltm0305a776c</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">pixclock</span>		<span class="o">=</span> <span class="mi">220000</span><span class="p">,</span>	<span class="cm">/* CLK=4.545 MHz */</span>
	<span class="p">.</span><span class="n">xres</span>			<span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
	<span class="p">.</span><span class="n">yres</span>			<span class="o">=</span> <span class="mi">320</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bpp</span>			<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hsync_len</span>		<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vsync_len</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">left_margin</span>		<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
	<span class="p">.</span><span class="n">right_margin</span>		<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">upper_margin</span>		<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lower_margin</span>		<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mioa701_lcd_power</span><span class="p">(</span><span class="kt">int</span> <span class="n">on</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">si</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">GPIO87_LCD_POWER</span><span class="p">,</span> <span class="n">on</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pxafb_mach_info</span> <span class="n">mioa701_pxafb_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">modes</span>			<span class="o">=</span> <span class="o">&amp;</span><span class="n">mioa701_ltm0305a776c</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_modes</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lcd_conn</span>		<span class="o">=</span> <span class="n">LCD_COLOR_TFT_16BPP</span> <span class="o">|</span> <span class="n">LCD_PCLK_EDGE_FALL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pxafb_lcd_power</span>	<span class="o">=</span> <span class="n">mioa701_lcd_power</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Keyboard configuration</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mioa701_matrix_keys</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">KEY</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KEY_UP</span><span class="p">),</span>
	<span class="n">KEY</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">KEY_RIGHT</span><span class="p">),</span>
	<span class="n">KEY</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">KEY_MEDIA</span><span class="p">),</span>
	<span class="n">KEY</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KEY_DOWN</span><span class="p">),</span>
	<span class="n">KEY</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">KEY_ENTER</span><span class="p">),</span>
	<span class="n">KEY</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">KEY_CONNECT</span><span class="p">),</span>	<span class="cm">/* GPS key */</span>
	<span class="n">KEY</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KEY_LEFT</span><span class="p">),</span>
	<span class="n">KEY</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">KEY_PHONE</span><span class="p">),</span>	<span class="cm">/* Phone Green key */</span>
	<span class="n">KEY</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">KEY_CAMERA</span><span class="p">)</span>	<span class="cm">/* Camera key */</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pxa27x_keypad_platform_data</span> <span class="n">mioa701_keypad_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">matrix_key_rows</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">matrix_key_cols</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">matrix_key_map</span> <span class="o">=</span> <span class="n">mioa701_matrix_keys</span><span class="p">,</span>
	<span class="p">.</span><span class="n">matrix_key_map_size</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mioa701_matrix_keys</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * GPIO Key Configuration</span>
<span class="cm"> */</span>
<span class="cp">#define MIO_KEY(key, _gpio, _desc, _wakeup) \</span>
<span class="cp">	{ .code = (key), .gpio = (_gpio), .active_low = 0, \</span>
<span class="cp">	.desc = (_desc), .type = EV_KEY, .wakeup = (_wakeup) }</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio_keys_button</span> <span class="n">mioa701_button_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">MIO_KEY</span><span class="p">(</span><span class="n">KEY_EXIT</span><span class="p">,</span> <span class="n">GPIO0_KEY_POWER</span><span class="p">,</span> <span class="s">&quot;Power button&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">MIO_KEY</span><span class="p">(</span><span class="n">KEY_VOLUMEUP</span><span class="p">,</span> <span class="n">GPIO93_KEY_VOLUME_UP</span><span class="p">,</span> <span class="s">&quot;Volume up&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">MIO_KEY</span><span class="p">(</span><span class="n">KEY_VOLUMEDOWN</span><span class="p">,</span> <span class="n">GPIO94_KEY_VOLUME_DOWN</span><span class="p">,</span> <span class="s">&quot;Volume down&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">MIO_KEY</span><span class="p">(</span><span class="n">KEY_HP</span><span class="p">,</span> <span class="n">GPIO12_HPJACK_INSERT</span><span class="p">,</span> <span class="s">&quot;HP jack detect&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio_keys_platform_data</span> <span class="n">mioa701_gpio_keys_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">buttons</span>  <span class="o">=</span> <span class="n">mioa701_button_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nbuttons</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mioa701_button_table</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Leds and vibrator</span>
<span class="cm"> */</span>
<span class="cp">#define ONE_LED(_gpio, _name) \</span>
<span class="cp">{ .gpio = (_gpio), .name = (_name), .active_low = true }</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio_led</span> <span class="n">gpio_leds</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ONE_LED</span><span class="p">(</span><span class="n">GPIO10_LED_nCharging</span><span class="p">,</span> <span class="s">&quot;mioa701:charging&quot;</span><span class="p">),</span>
	<span class="n">ONE_LED</span><span class="p">(</span><span class="n">GPIO97_LED_nBlue</span><span class="p">,</span> <span class="s">&quot;mioa701:blue&quot;</span><span class="p">),</span>
	<span class="n">ONE_LED</span><span class="p">(</span><span class="n">GPIO98_LED_nOrange</span><span class="p">,</span> <span class="s">&quot;mioa701:orange&quot;</span><span class="p">),</span>
	<span class="n">ONE_LED</span><span class="p">(</span><span class="n">GPIO82_LED_nVibra</span><span class="p">,</span> <span class="s">&quot;mioa701:vibra&quot;</span><span class="p">),</span>
	<span class="n">ONE_LED</span><span class="p">(</span><span class="n">GPIO115_LED_nKeyboard</span><span class="p">,</span> <span class="s">&quot;mioa701:keyboard&quot;</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio_led_platform_data</span> <span class="n">gpio_led_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">leds</span> <span class="o">=</span> <span class="n">gpio_leds</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_leds</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">gpio_leds</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * GSM Sagem XS200 chip</span>
<span class="cm"> *</span>
<span class="cm"> * GSM handling was purged from kernel. For history, this is the way to go :</span>
<span class="cm"> *   - init : GPIO24_GSM_MOD_RESET_CMD = 0, GPIO114_GSM_nMOD_DTE_UART_STATE = 1</span>
<span class="cm"> *            GPIO88_GSM_nMOD_ON_CMD = 1, GPIO90_GSM_nMOD_OFF_CMD = 1</span>
<span class="cm"> *   - reset : GPIO24_GSM_MOD_RESET_CMD = 1, msleep(100),</span>
<span class="cm"> *             GPIO24_GSM_MOD_RESET_CMD = 0</span>
<span class="cm"> *   - turn on  : GPIO88_GSM_nMOD_ON_CMD = 0, msleep(1000),</span>
<span class="cm"> *                GPIO88_GSM_nMOD_ON_CMD = 1</span>
<span class="cm"> *   - turn off : GPIO90_GSM_nMOD_OFF_CMD = 0, msleep(1000),</span>
<span class="cm"> *                GPIO90_GSM_nMOD_OFF_CMD = 1</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_gsm_on</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">is_on</span><span class="p">;</span>

	<span class="n">is_on</span> <span class="o">=</span> <span class="o">!!</span><span class="n">gpio_get_value</span><span class="p">(</span><span class="n">GPIO25_GSM_MOD_ON_STATE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">is_on</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">irqreturn_t</span> <span class="nf">gsm_on_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Mioa701: GSM status changed to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">is_gsm_on</span><span class="p">()</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio</span> <span class="n">gsm_gpios</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">GPIO25_GSM_MOD_ON_STATE</span><span class="p">,</span> <span class="n">GPIOF_IN</span><span class="p">,</span> <span class="s">&quot;GSM state&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPIO113_GSM_EVENT</span><span class="p">,</span> <span class="n">GPIOF_IN</span><span class="p">,</span> <span class="s">&quot;GSM event&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">gsm_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">gpio_request_array</span><span class="p">(</span><span class="n">ARRAY_AND_SIZE</span><span class="p">(</span><span class="n">gsm_gpios</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_gpio</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">gpio_to_irq</span><span class="p">(</span><span class="n">GPIO25_GSM_MOD_ON_STATE</span><span class="p">),</span> <span class="n">gsm_on_irq</span><span class="p">,</span>
			 <span class="n">IRQF_TRIGGER_RISING</span> <span class="o">|</span> <span class="n">IRQF_TRIGGER_FALLING</span><span class="p">,</span>
			 <span class="s">&quot;GSM XS200 Power Irq&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_irq</span><span class="p">;</span>

	<span class="n">gpio_set_wake</span><span class="p">(</span><span class="n">GPIO113_GSM_EVENT</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_irq:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Mioa701: Can&#39;t request GSM_ON irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">gpio_free_array</span><span class="p">(</span><span class="n">ARRAY_AND_SIZE</span><span class="p">(</span><span class="n">gsm_gpios</span><span class="p">));</span>
<span class="nl">err_gpio:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Mioa701: gsm not available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gsm_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">gpio_to_irq</span><span class="p">(</span><span class="n">GPIO25_GSM_MOD_ON_STATE</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gpio_free_array</span><span class="p">(</span><span class="n">ARRAY_AND_SIZE</span><span class="p">(</span><span class="n">gsm_gpios</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Bluetooth BRF6150 chip</span>
<span class="cm"> *</span>
<span class="cm"> * BT handling was purged from kernel. For history, this is the way to go :</span>
<span class="cm"> * - turn on  : GPIO83_BT_ON = 1</span>
<span class="cm"> * - turn off : GPIO83_BT_ON = 0</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * GPS Sirf Star III chip</span>
<span class="cm"> *</span>
<span class="cm"> * GPS handling was purged from kernel. For history, this is the way to go :</span>
<span class="cm"> * - init : GPIO23_GPS_UNKNOWN1 = 1, GPIO26_GPS_ON = 0, GPIO27_GPS_RESET = 0</span>
<span class="cm"> *          GPIO106_GPS_UNKNOWN2 = 0, GPIO107_GPS_UNKNOWN3 = 0</span>
<span class="cm"> * - turn on  : GPIO27_GPS_RESET = 1, GPIO26_GPS_ON = 1</span>
<span class="cm"> * - turn off : GPIO26_GPS_ON = 0, GPIO27_GPS_RESET = 0</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * USB UDC</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_usb_connected</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">gpio_get_value</span><span class="p">(</span><span class="n">GPIO13_nUSB_DETECT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pxa2xx_udc_mach_info</span> <span class="n">mioa701_udc_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">udc_is_connected</span> <span class="o">=</span> <span class="n">is_usb_connected</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gpio_pullup</span>	  <span class="o">=</span> <span class="n">GPIO22_USB_ENABLE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">gpio_vbus_mach_info</span> <span class="n">gpio_vbus_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">gpio_vbus</span> <span class="o">=</span> <span class="n">GPIO13_nUSB_DETECT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gpio_vbus_inverted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gpio_pullup</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * SDIO/MMC Card controller</span>
<span class="cm"> */</span>
<span class="cm">/**</span>
<span class="cm"> * The card detect interrupt isn&#39;t debounced so we delay it by 250ms</span>
<span class="cm"> * to give the card a chance to fully insert/eject.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pxamci_platform_data</span> <span class="n">mioa701_mci_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">detect_delay_ms</span>	<span class="o">=</span> <span class="mi">250</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ocr_mask</span> 		<span class="o">=</span> <span class="n">MMC_VDD_32_33</span> <span class="o">|</span> <span class="n">MMC_VDD_33_34</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gpio_card_detect</span>	<span class="o">=</span> <span class="n">GPIO15_SDIO_INSERT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gpio_card_ro</span>		<span class="o">=</span> <span class="n">GPIO78_SDIO_RO</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gpio_power</span>		<span class="o">=</span> <span class="n">GPIO91_SDIO_EN</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* FlashRAM */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">docg3_resource</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">PXA_CS0_PHYS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">end</span>   <span class="o">=</span> <span class="n">PXA_CS0_PHYS</span> <span class="o">+</span> <span class="n">SZ_8K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">docg3</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	       <span class="o">=</span> <span class="s">&quot;docg3&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>	       <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resource</span>      <span class="o">=</span> <span class="o">&amp;</span><span class="n">docg3_resource</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Suspend/Resume bootstrap management</span>
<span class="cm"> *</span>
<span class="cm"> * MIO A701 reboot sequence is highly ROM dependent. From the one dissassembled,</span>
<span class="cm"> * this sequence is as follows :</span>
<span class="cm"> *   - disables interrupts</span>
<span class="cm"> *   - initialize SDRAM (self refresh RAM into active RAM)</span>
<span class="cm"> *   - initialize GPIOs (depends on value at 0xa020b020)</span>
<span class="cm"> *   - initialize coprossessors</span>
<span class="cm"> *   - if edge detect on PWR_SCL(GPIO3), then proceed to cold start</span>
<span class="cm"> *   - or if value at 0xa020b000 not equal to 0x0f0f0f0f, proceed to cold start</span>
<span class="cm"> *   - else do a resume, ie. jump to addr 0xa0100000</span>
<span class="cm"> */</span>
<span class="cp">#define RESUME_ENABLE_ADDR	0xa020b000</span>
<span class="cp">#define RESUME_ENABLE_VAL	0x0f0f0f0f</span>
<span class="cp">#define RESUME_BT_ADDR		0xa020b020</span>
<span class="cp">#define RESUME_UNKNOWN_ADDR	0xa020b024</span>
<span class="cp">#define RESUME_VECTOR_ADDR	0xa0100000</span>
<span class="cp">#define BOOTSTRAP_WORDS		mioa701_bootstrap_lg/4</span>

<span class="k">static</span> <span class="n">u32</span> <span class="o">*</span><span class="n">save_buffer</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">install_bootstrap</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">rom_bootstrap</span>  <span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">RESUME_VECTOR_ADDR</span><span class="p">);</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">src</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mioa701_bootstrap</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BOOTSTRAP_WORDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rom_bootstrap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">mioa701_sys_suspend</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">is_bt_on</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">mem_resume_vector</span>	<span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">RESUME_VECTOR_ADDR</span><span class="p">);</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">mem_resume_enabler</span> <span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">RESUME_ENABLE_ADDR</span><span class="p">);</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">mem_resume_bt</span>	<span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">RESUME_BT_ADDR</span><span class="p">);</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">mem_resume_unknown</span>	<span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">RESUME_UNKNOWN_ADDR</span><span class="p">);</span>

	<span class="cm">/* Devices prepare suspend */</span>
	<span class="n">is_bt_on</span> <span class="o">=</span> <span class="o">!!</span><span class="n">gpio_get_value</span><span class="p">(</span><span class="n">GPIO83_BT_ON</span><span class="p">);</span>
	<span class="n">pxa2xx_mfp_set_lpm</span><span class="p">(</span><span class="n">GPIO83_BT_ON</span><span class="p">,</span>
			   <span class="n">is_bt_on</span> <span class="o">?</span> <span class="n">MFP_LPM_DRIVE_HIGH</span> <span class="o">:</span> <span class="n">MFP_LPM_DRIVE_LOW</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BOOTSTRAP_WORDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">save_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mem_resume_vector</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">save_buffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">mem_resume_enabler</span><span class="p">;</span>
	<span class="n">save_buffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">mem_resume_bt</span><span class="p">;</span>
	<span class="n">save_buffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">mem_resume_unknown</span><span class="p">;</span>

	<span class="o">*</span><span class="n">mem_resume_enabler</span> <span class="o">=</span> <span class="n">RESUME_ENABLE_VAL</span><span class="p">;</span>
	<span class="o">*</span><span class="n">mem_resume_bt</span>	    <span class="o">=</span> <span class="n">is_bt_on</span><span class="p">;</span>

	<span class="n">install_bootstrap</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mioa701_sys_resume</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">mem_resume_vector</span>	<span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">RESUME_VECTOR_ADDR</span><span class="p">);</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">mem_resume_enabler</span> <span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">RESUME_ENABLE_ADDR</span><span class="p">);</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">mem_resume_bt</span>	<span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">RESUME_BT_ADDR</span><span class="p">);</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">mem_resume_unknown</span>	<span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">RESUME_UNKNOWN_ADDR</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BOOTSTRAP_WORDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mem_resume_vector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="o">*</span><span class="n">mem_resume_enabler</span> <span class="o">=</span> <span class="n">save_buffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">];</span>
	<span class="o">*</span><span class="n">mem_resume_bt</span>	    <span class="o">=</span> <span class="n">save_buffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">];</span>
	<span class="o">*</span><span class="n">mem_resume_unknown</span> <span class="o">=</span> <span class="n">save_buffer</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">syscore_ops</span> <span class="n">mioa701_syscore_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">mioa701_sys_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">mioa701_sys_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">bootstrap_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">save_size</span> <span class="o">=</span> <span class="n">mioa701_bootstrap_lg</span> <span class="o">+</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">register_syscore_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mioa701_syscore_ops</span><span class="p">);</span>

	<span class="n">save_buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">save_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">save_buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;MioA701: allocated %d bytes for bootstrap</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">save_size</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bootstrap_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">save_buffer</span><span class="p">);</span>
	<span class="n">unregister_syscore_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mioa701_syscore_ops</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;Unregistering mioa701 suspend will hang next&quot;</span>
	       <span class="s">&quot;resume !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Power Supply</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">supplicants</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;mioa701_battery&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_ac_connected</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">gpio_get_value</span><span class="p">(</span><span class="n">GPIO96_AC_DETECT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mioa701_set_charge</span><span class="p">(</span><span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">GPIO9_CHARGE_EN</span><span class="p">,</span> <span class="p">(</span><span class="n">flags</span> <span class="o">==</span> <span class="n">PDA_POWER_CHARGE_USB</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pda_power_pdata</span> <span class="n">power_pdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">is_ac_online</span>	<span class="o">=</span> <span class="n">is_ac_connected</span><span class="p">,</span>
	<span class="p">.</span><span class="n">is_usb_online</span>	<span class="o">=</span> <span class="n">is_usb_connected</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_charge</span> <span class="o">=</span> <span class="n">mioa701_set_charge</span><span class="p">,</span>
	<span class="p">.</span><span class="n">supplied_to</span> <span class="o">=</span> <span class="n">supplicants</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_supplicants</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">supplicants</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">power_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;ac&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">PXA_GPIO_TO_IRQ</span><span class="p">(</span><span class="n">GPIO96_AC_DETECT</span><span class="p">),</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">PXA_GPIO_TO_IRQ</span><span class="p">(</span><span class="n">GPIO96_AC_DETECT</span><span class="p">),</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span> <span class="o">|</span> <span class="n">IORESOURCE_IRQ_HIGHEDGE</span> <span class="o">|</span>
		<span class="n">IORESOURCE_IRQ_LOWEDGE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;usb&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">PXA_GPIO_TO_IRQ</span><span class="p">(</span><span class="n">GPIO13_nUSB_DETECT</span><span class="p">),</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">PXA_GPIO_TO_IRQ</span><span class="p">(</span><span class="n">GPIO13_nUSB_DETECT</span><span class="p">),</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span> <span class="o">|</span> <span class="n">IORESOURCE_IRQ_HIGHEDGE</span> <span class="o">|</span>
		<span class="n">IORESOURCE_IRQ_LOWEDGE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">power_dev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;pda-power&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">power_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">power_resources</span><span class="p">),</span>
	<span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">power_pdata</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">wm97xx_batt_pdata</span> <span class="n">mioa701_battery_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">batt_aux</span>	<span class="o">=</span> <span class="n">WM97XX_AUX_ID1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">temp_aux</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">charge_gpio</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">min_voltage</span>	<span class="o">=</span> <span class="mh">0xc00</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_voltage</span>	<span class="o">=</span> <span class="mh">0xfc0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">batt_tech</span>	<span class="o">=</span> <span class="n">POWER_SUPPLY_TECHNOLOGY_LION</span><span class="p">,</span>
	<span class="p">.</span><span class="n">batt_div</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">batt_mult</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">batt_name</span>	<span class="o">=</span> <span class="s">&quot;mioa701_battery&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">wm97xx_pdata</span> <span class="n">mioa701_wm97xx_pdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">batt_pdata</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">mioa701_battery_data</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Voltage regulation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">regulator_consumer_supply</span> <span class="n">max1586_consumers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">REGULATOR_SUPPLY</span><span class="p">(</span><span class="s">&quot;vcc_core&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">regulator_init_data</span> <span class="n">max1586_v3_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;vcc_core range&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">min_uV</span> <span class="o">=</span> <span class="mi">1000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_uV</span> <span class="o">=</span> <span class="mi">1705000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">always_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">valid_ops_mask</span> <span class="o">=</span> <span class="n">REGULATOR_CHANGE_VOLTAGE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">num_consumer_supplies</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">max1586_consumers</span><span class="p">),</span>
	<span class="p">.</span><span class="n">consumer_supplies</span> <span class="o">=</span> <span class="n">max1586_consumers</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">max1586_subdev_data</span> <span class="n">max1586_subdevs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;vcc_core&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">MAX1586_V3</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">max1586_v3_info</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">max1586_platform_data</span> <span class="n">max1586_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">subdevs</span> <span class="o">=</span> <span class="n">max1586_subdevs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_subdevs</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">max1586_subdevs</span><span class="p">),</span>
	<span class="p">.</span><span class="n">v3_gain</span> <span class="o">=</span> <span class="n">MAX1586_GAIN_NO_R24</span><span class="p">,</span> <span class="cm">/* 700..1475 mV */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Camera interface</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">pxacamera_platform_data</span> <span class="n">mioa701_pxacamera_platform_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">flags</span>  <span class="o">=</span> <span class="n">PXA_CAMERA_MASTER</span> <span class="o">|</span> <span class="n">PXA_CAMERA_DATAWIDTH_8</span> <span class="o">|</span>
		<span class="n">PXA_CAMERA_PCLK_EN</span> <span class="o">|</span> <span class="n">PXA_CAMERA_MCLK_EN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mclk_10khz</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">__initdata</span> <span class="n">mioa701_pi2c_devices</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;max1586&quot;</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">),</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">max1586_info</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* Board I2C devices. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">mioa701_i2c_devices</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;mt9m111&quot;</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">),</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">soc_camera_link</span> <span class="n">iclink</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bus_id</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="cm">/* Match id in pxa27x_device_camera in device.c */</span>
	<span class="p">.</span><span class="n">board_info</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">mioa701_i2c_devices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	<span class="p">.</span><span class="n">i2c_adapter_id</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">i2c_pxa_platform_data</span> <span class="n">i2c_pdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">fast_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">pxa2xx_audio_ops_t</span> <span class="n">mioa701_ac97_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">reset_gpio</span> <span class="o">=</span> <span class="mi">95</span><span class="p">,</span>
	<span class="p">.</span><span class="n">codec_pdata</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">mioa701_wm97xx_pdata</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Mio global</span>
<span class="cm"> */</span>

<span class="cm">/* Devices */</span>
<span class="cp">#define MIO_PARENT_DEV(var, strname, tparent, pdata)	\</span>
<span class="cp">static struct platform_device var = {			\</span>
<span class="cp">	.name		= strname,			\</span>
<span class="cp">	.id		= -1,				\</span>
<span class="cp">	.dev		= {				\</span>
<span class="cp">		.platform_data = pdata,			\</span>
<span class="cp">		.parent	= tparent,			\</span>
<span class="cp">	},						\</span>
<span class="cp">};</span>
<span class="cp">#define MIO_SIMPLE_DEV(var, strname, pdata)	\</span>
<span class="cp">	MIO_PARENT_DEV(var, strname, NULL, pdata)</span>

<span class="n">MIO_SIMPLE_DEV</span><span class="p">(</span><span class="n">mioa701_gpio_keys</span><span class="p">,</span> <span class="s">&quot;gpio-keys&quot;</span><span class="p">,</span>	    <span class="o">&amp;</span><span class="n">mioa701_gpio_keys_data</span><span class="p">)</span>
<span class="n">MIO_PARENT_DEV</span><span class="p">(</span><span class="n">mioa701_backlight</span><span class="p">,</span> <span class="s">&quot;pwm-backlight&quot;</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">pxa27x_device_pwm0</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">mioa701_backlight_data</span><span class="p">);</span>
<span class="n">MIO_SIMPLE_DEV</span><span class="p">(</span><span class="n">mioa701_led</span><span class="p">,</span>	  <span class="s">&quot;leds-gpio&quot;</span><span class="p">,</span>	    <span class="o">&amp;</span><span class="n">gpio_led_info</span><span class="p">)</span>
<span class="n">MIO_SIMPLE_DEV</span><span class="p">(</span><span class="n">pxa2xx_pcm</span><span class="p">,</span>	  <span class="s">&quot;pxa2xx-pcm&quot;</span><span class="p">,</span>	    <span class="nb">NULL</span><span class="p">)</span>
<span class="n">MIO_SIMPLE_DEV</span><span class="p">(</span><span class="n">mioa701_sound</span><span class="p">,</span>	  <span class="s">&quot;mioa701-wm9713&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span>
<span class="n">MIO_SIMPLE_DEV</span><span class="p">(</span><span class="n">mioa701_board</span><span class="p">,</span>	  <span class="s">&quot;mioa701-board&quot;</span><span class="p">,</span>  <span class="nb">NULL</span><span class="p">)</span>
<span class="n">MIO_SIMPLE_DEV</span><span class="p">(</span><span class="n">gpio_vbus</span><span class="p">,</span>	  <span class="s">&quot;gpio-vbus&quot;</span><span class="p">,</span>      <span class="o">&amp;</span><span class="n">gpio_vbus_data</span><span class="p">);</span>
<span class="n">MIO_SIMPLE_DEV</span><span class="p">(</span><span class="n">mioa701_camera</span><span class="p">,</span>	  <span class="s">&quot;soc-camera-pdrv&quot;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">iclink</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">devices</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">mioa701_gpio_keys</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">mioa701_backlight</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">mioa701_led</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">pxa2xx_pcm</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">mioa701_sound</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">power_dev</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">docg3</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">gpio_vbus</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">mioa701_camera</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">mioa701_board</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">mioa701_machine_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mioa701_poweroff</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mioa701_machine_exit</span><span class="p">();</span>
	<span class="n">pxa_restart</span><span class="p">(</span><span class="sc">&#39;s&#39;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mioa701_restart</span><span class="p">(</span><span class="kt">char</span> <span class="n">c</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mioa701_machine_exit</span><span class="p">();</span>
	<span class="n">pxa_restart</span><span class="p">(</span><span class="sc">&#39;s&#39;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio</span> <span class="n">global_gpios</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">GPIO9_CHARGE_EN</span><span class="p">,</span> <span class="n">GPIOF_OUT_INIT_HIGH</span><span class="p">,</span> <span class="s">&quot;Charger enable&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPIO18_POWEROFF</span><span class="p">,</span> <span class="n">GPIOF_OUT_INIT_LOW</span><span class="p">,</span> <span class="s">&quot;Power Off&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPIO87_LCD_POWER</span><span class="p">,</span> <span class="n">GPIOF_OUT_INIT_LOW</span><span class="p">,</span> <span class="s">&quot;LCD Power&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPIO56_MT9M111_nOE</span><span class="p">,</span> <span class="n">GPIOF_OUT_INIT_LOW</span><span class="p">,</span> <span class="s">&quot;Camera nOE&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">mioa701_machine_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">PSLR</span>  <span class="o">=</span> <span class="mh">0xff100000</span><span class="p">;</span> <span class="cm">/* SYSDEL=125ms, PWRDEL=125ms, PSLR_SL_ROD=1 */</span>
	<span class="n">PCFR</span> <span class="o">=</span> <span class="n">PCFR_DC_EN</span> <span class="o">|</span> <span class="n">PCFR_GPR_EN</span> <span class="o">|</span> <span class="n">PCFR_OPDE</span><span class="p">;</span>
	<span class="n">RTTR</span> <span class="o">=</span> <span class="mi">32768</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Reset crazy WinCE value */</span>
	<span class="n">UP2OCR</span> <span class="o">=</span> <span class="n">UP2OCR_HXOE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up the flash memory : DiskOnChip G3 on first static memory bank</span>
<span class="cm">	 */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x7ff02dd8</span><span class="p">,</span> <span class="n">MSC0</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0001c391</span><span class="p">,</span> <span class="n">MCMEM0</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0001c391</span><span class="p">,</span> <span class="n">MCATT0</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0001c391</span><span class="p">,</span> <span class="n">MCIO0</span><span class="p">);</span>


	<span class="n">pxa2xx_mfp_config</span><span class="p">(</span><span class="n">ARRAY_AND_SIZE</span><span class="p">(</span><span class="n">mioa701_pin_config</span><span class="p">));</span>
	<span class="n">pxa_set_ffuart_info</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="n">pxa_set_btuart_info</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="n">pxa_set_stuart_info</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">gpio_request_array</span><span class="p">(</span><span class="n">ARRAY_AND_SIZE</span><span class="p">(</span><span class="n">global_gpios</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;MioA701: Failed to request GPIOs: %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="n">bootstrap_init</span><span class="p">();</span>
	<span class="n">pxa_set_fb_info</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mioa701_pxafb_info</span><span class="p">);</span>
	<span class="n">pxa_set_mci_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mioa701_mci_info</span><span class="p">);</span>
	<span class="n">pxa_set_keypad_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mioa701_keypad_info</span><span class="p">);</span>
	<span class="n">pxa_set_udc_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mioa701_udc_info</span><span class="p">);</span>
	<span class="n">pxa_set_ac97_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mioa701_ac97_info</span><span class="p">);</span>
	<span class="n">pm_power_off</span> <span class="o">=</span> <span class="n">mioa701_poweroff</span><span class="p">;</span>
	<span class="n">platform_add_devices</span><span class="p">(</span><span class="n">devices</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">devices</span><span class="p">));</span>
	<span class="n">gsm_init</span><span class="p">();</span>

	<span class="n">i2c_register_board_info</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ARRAY_AND_SIZE</span><span class="p">(</span><span class="n">mioa701_pi2c_devices</span><span class="p">));</span>
	<span class="n">pxa_set_i2c_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c_pdata</span><span class="p">);</span>
	<span class="n">pxa27x_set_i2c_power_info</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="n">pxa_set_camera_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mioa701_pxacamera_platform_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mioa701_machine_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bootstrap_exit</span><span class="p">();</span>
	<span class="n">gsm_exit</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">MACHINE_START</span><span class="p">(</span><span class="n">MIOA701</span><span class="p">,</span> <span class="s">&quot;MIO A701&quot;</span><span class="p">)</span>
	<span class="p">.</span><span class="n">atag_offset</span>	<span class="o">=</span> <span class="mh">0x100</span><span class="p">,</span>
	<span class="p">.</span><span class="n">restart_mode</span>	<span class="o">=</span> <span class="sc">&#39;s&#39;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">map_io</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pxa27x_map_io</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nr_irqs</span>	<span class="o">=</span> <span class="n">PXA_NR_IRQS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_irq</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">pxa27x_init_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">handle_irq</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">pxa27x_handle_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_machine</span>	<span class="o">=</span> <span class="n">mioa701_machine_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">timer</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pxa_timer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">restart</span>	<span class="o">=</span> <span class="n">mioa701_restart</span><span class="p">,</span>
<span class="n">MACHINE_END</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
