<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › mach-pxa › raumfeld.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>raumfeld.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * arch/arm/mach-pxa/raumfeld.c</span>
<span class="cm"> *</span>
<span class="cm"> * Support for the following Raumfeld devices:</span>
<span class="cm"> *</span>
<span class="cm"> * 	* Controller</span>
<span class="cm"> *  	* Connector</span>
<span class="cm"> *  	* Speaker S/M</span>
<span class="cm"> *</span>
<span class="cm"> * See http://www.raumfeld.com for details.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2009 Daniel Mack &lt;daniel@caiaq.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/smsc911x.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/rotary_encoder.h&gt;</span>
<span class="cp">#include &lt;linux/gpio_keys.h&gt;</span>
<span class="cp">#include &lt;linux/input/eeti_ts.h&gt;</span>
<span class="cp">#include &lt;linux/leds.h&gt;</span>
<span class="cp">#include &lt;linux/w1-gpio.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/pwm_backlight.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/i2c/pxa-i2c.h&gt;</span>
<span class="cp">#include &lt;linux/spi/spi.h&gt;</span>
<span class="cp">#include &lt;linux/spi/spi_gpio.h&gt;</span>
<span class="cp">#include &lt;linux/lis3lv02d.h&gt;</span>
<span class="cp">#include &lt;linux/pda_power.h&gt;</span>
<span class="cp">#include &lt;linux/power_supply.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/max8660.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/machine.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/fixed.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/consumer.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>

<span class="cp">#include &lt;asm/system_info.h&gt;</span>

<span class="cp">#include &lt;asm/mach-types.h&gt;</span>
<span class="cp">#include &lt;asm/mach/arch.h&gt;</span>

<span class="cp">#include &lt;mach/pxa300.h&gt;</span>
<span class="cp">#include &lt;mach/ohci.h&gt;</span>
<span class="cp">#include &lt;mach/pxafb.h&gt;</span>
<span class="cp">#include &lt;mach/mmc.h&gt;</span>
<span class="cp">#include &lt;plat/pxa3xx_nand.h&gt;</span>

<span class="cp">#include &quot;generic.h&quot;</span>
<span class="cp">#include &quot;devices.h&quot;</span>
<span class="cp">#include &quot;clock.h&quot;</span>

<span class="cm">/* common GPIO	definitions */</span>

<span class="cm">/* inputs */</span>
<span class="cp">#define GPIO_ON_OFF		(14)</span>
<span class="cp">#define GPIO_VOLENC_A		(19)</span>
<span class="cp">#define GPIO_VOLENC_B		(20)</span>
<span class="cp">#define GPIO_CHARGE_DONE	(23)</span>
<span class="cp">#define GPIO_CHARGE_IND		(27)</span>
<span class="cp">#define GPIO_TOUCH_IRQ		(32)</span>
<span class="cp">#define GPIO_ETH_IRQ		(40)</span>
<span class="cp">#define GPIO_SPI_MISO		(98)</span>
<span class="cp">#define GPIO_ACCEL_IRQ		(104)</span>
<span class="cp">#define GPIO_RESCUE_BOOT	(115)</span>
<span class="cp">#define GPIO_DOCK_DETECT	(116)</span>
<span class="cp">#define GPIO_KEY1		(117)</span>
<span class="cp">#define GPIO_KEY2		(118)</span>
<span class="cp">#define GPIO_KEY3		(119)</span>
<span class="cp">#define GPIO_CHARGE_USB_OK	(112)</span>
<span class="cp">#define GPIO_CHARGE_DC_OK	(101)</span>
<span class="cp">#define GPIO_CHARGE_USB_SUSP	(102)</span>

<span class="cm">/* outputs */</span>
<span class="cp">#define GPIO_SHUTDOWN_SUPPLY	(16)</span>
<span class="cp">#define GPIO_SHUTDOWN_BATT	(18)</span>
<span class="cp">#define GPIO_CHRG_PEN2		(31)</span>
<span class="cp">#define GPIO_TFT_VA_EN		(33)</span>
<span class="cp">#define GPIO_SPDIF_CS		(34)</span>
<span class="cp">#define GPIO_LED2		(35)</span>
<span class="cp">#define GPIO_LED1		(36)</span>
<span class="cp">#define GPIO_SPDIF_RESET	(38)</span>
<span class="cp">#define GPIO_SPI_CLK		(95)</span>
<span class="cp">#define GPIO_MCLK_DAC_CS	(96)</span>
<span class="cp">#define GPIO_SPI_MOSI		(97)</span>
<span class="cp">#define GPIO_W1_PULLUP_ENABLE	(105)</span>
<span class="cp">#define GPIO_DISPLAY_ENABLE	(106)</span>
<span class="cp">#define GPIO_MCLK_RESET		(111)</span>
<span class="cp">#define GPIO_W2W_RESET		(113)</span>
<span class="cp">#define GPIO_W2W_PDN		(114)</span>
<span class="cp">#define GPIO_CODEC_RESET	(120)</span>
<span class="cp">#define GPIO_AUDIO_VA_ENABLE	(124)</span>
<span class="cp">#define GPIO_ACCEL_CS		(125)</span>
<span class="cp">#define GPIO_ONE_WIRE		(126)</span>

<span class="cm">/*</span>
<span class="cm"> * GPIO configurations</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">mfp_cfg_t</span> <span class="n">raumfeld_controller_pin_config</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* UART1 */</span>
	<span class="n">GPIO77_UART1_RXD</span><span class="p">,</span>
	<span class="n">GPIO78_UART1_TXD</span><span class="p">,</span>
	<span class="n">GPIO79_UART1_CTS</span><span class="p">,</span>
	<span class="n">GPIO81_UART1_DSR</span><span class="p">,</span>
	<span class="n">GPIO83_UART1_DTR</span><span class="p">,</span>
	<span class="n">GPIO84_UART1_RTS</span><span class="p">,</span>

	<span class="cm">/* UART3 */</span>
	<span class="n">GPIO110_UART3_RXD</span><span class="p">,</span>

	<span class="cm">/* USB Host */</span>
	<span class="n">GPIO0_2_USBH_PEN</span><span class="p">,</span>
	<span class="n">GPIO1_2_USBH_PWR</span><span class="p">,</span>

	<span class="cm">/* I2C */</span>
	<span class="n">GPIO21_I2C_SCL</span> <span class="o">|</span> <span class="n">MFP_LPM_FLOAT</span> <span class="o">|</span> <span class="n">MFP_PULL_FLOAT</span><span class="p">,</span>
	<span class="n">GPIO22_I2C_SDA</span> <span class="o">|</span> <span class="n">MFP_LPM_FLOAT</span> <span class="o">|</span> <span class="n">MFP_PULL_FLOAT</span><span class="p">,</span>

	<span class="cm">/* SPI */</span>
	<span class="n">GPIO34_GPIO</span><span class="p">,</span>	<span class="cm">/* SPDIF_CS */</span>
	<span class="n">GPIO96_GPIO</span><span class="p">,</span>	<span class="cm">/* MCLK_CS */</span>
	<span class="n">GPIO125_GPIO</span><span class="p">,</span>	<span class="cm">/* ACCEL_CS */</span>

	<span class="cm">/* MMC */</span>
	<span class="n">GPIO3_MMC1_DAT0</span><span class="p">,</span>
	<span class="n">GPIO4_MMC1_DAT1</span><span class="p">,</span>
	<span class="n">GPIO5_MMC1_DAT2</span><span class="p">,</span>
	<span class="n">GPIO6_MMC1_DAT3</span><span class="p">,</span>
	<span class="n">GPIO7_MMC1_CLK</span><span class="p">,</span>
	<span class="n">GPIO8_MMC1_CMD</span><span class="p">,</span>

	<span class="cm">/* One-wire */</span>
	<span class="n">GPIO126_GPIO</span> <span class="o">|</span> <span class="n">MFP_LPM_FLOAT</span><span class="p">,</span>
	<span class="n">GPIO105_GPIO</span> <span class="o">|</span> <span class="n">MFP_PULL_LOW</span> <span class="o">|</span> <span class="n">MFP_LPM_PULL_LOW</span><span class="p">,</span>

	<span class="cm">/* CHRG_USB_OK */</span>
	<span class="n">GPIO101_GPIO</span> <span class="o">|</span> <span class="n">MFP_PULL_HIGH</span><span class="p">,</span>
	<span class="cm">/* CHRG_USB_OK */</span>
	<span class="n">GPIO112_GPIO</span> <span class="o">|</span> <span class="n">MFP_PULL_HIGH</span><span class="p">,</span>
	<span class="cm">/* CHRG_USB_SUSP */</span>
	<span class="n">GPIO102_GPIO</span><span class="p">,</span>
	<span class="cm">/* DISPLAY_ENABLE */</span>
	<span class="n">GPIO106_GPIO</span><span class="p">,</span>
	<span class="cm">/* DOCK_DETECT */</span>
	<span class="n">GPIO116_GPIO</span> <span class="o">|</span> <span class="n">MFP_LPM_FLOAT</span> <span class="o">|</span> <span class="n">MFP_PULL_FLOAT</span><span class="p">,</span>

	<span class="cm">/* LCD */</span>
	<span class="n">GPIO54_LCD_LDD_0</span><span class="p">,</span>
	<span class="n">GPIO55_LCD_LDD_1</span><span class="p">,</span>
	<span class="n">GPIO56_LCD_LDD_2</span><span class="p">,</span>
	<span class="n">GPIO57_LCD_LDD_3</span><span class="p">,</span>
	<span class="n">GPIO58_LCD_LDD_4</span><span class="p">,</span>
	<span class="n">GPIO59_LCD_LDD_5</span><span class="p">,</span>
	<span class="n">GPIO60_LCD_LDD_6</span><span class="p">,</span>
	<span class="n">GPIO61_LCD_LDD_7</span><span class="p">,</span>
	<span class="n">GPIO62_LCD_LDD_8</span><span class="p">,</span>
	<span class="n">GPIO63_LCD_LDD_9</span><span class="p">,</span>
	<span class="n">GPIO64_LCD_LDD_10</span><span class="p">,</span>
	<span class="n">GPIO65_LCD_LDD_11</span><span class="p">,</span>
	<span class="n">GPIO66_LCD_LDD_12</span><span class="p">,</span>
	<span class="n">GPIO67_LCD_LDD_13</span><span class="p">,</span>
	<span class="n">GPIO68_LCD_LDD_14</span><span class="p">,</span>
	<span class="n">GPIO69_LCD_LDD_15</span><span class="p">,</span>
	<span class="n">GPIO70_LCD_LDD_16</span><span class="p">,</span>
	<span class="n">GPIO71_LCD_LDD_17</span><span class="p">,</span>
	<span class="n">GPIO72_LCD_FCLK</span><span class="p">,</span>
	<span class="n">GPIO73_LCD_LCLK</span><span class="p">,</span>
	<span class="n">GPIO74_LCD_PCLK</span><span class="p">,</span>
	<span class="n">GPIO75_LCD_BIAS</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">mfp_cfg_t</span> <span class="n">raumfeld_connector_pin_config</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* UART1 */</span>
	<span class="n">GPIO77_UART1_RXD</span><span class="p">,</span>
	<span class="n">GPIO78_UART1_TXD</span><span class="p">,</span>
	<span class="n">GPIO79_UART1_CTS</span><span class="p">,</span>
	<span class="n">GPIO81_UART1_DSR</span><span class="p">,</span>
	<span class="n">GPIO83_UART1_DTR</span><span class="p">,</span>
	<span class="n">GPIO84_UART1_RTS</span><span class="p">,</span>

	<span class="cm">/* UART3 */</span>
	<span class="n">GPIO110_UART3_RXD</span><span class="p">,</span>

	<span class="cm">/* USB Host */</span>
	<span class="n">GPIO0_2_USBH_PEN</span><span class="p">,</span>
	<span class="n">GPIO1_2_USBH_PWR</span><span class="p">,</span>

	<span class="cm">/* I2C */</span>
	<span class="n">GPIO21_I2C_SCL</span> <span class="o">|</span> <span class="n">MFP_LPM_FLOAT</span> <span class="o">|</span> <span class="n">MFP_PULL_FLOAT</span><span class="p">,</span>
	<span class="n">GPIO22_I2C_SDA</span> <span class="o">|</span> <span class="n">MFP_LPM_FLOAT</span> <span class="o">|</span> <span class="n">MFP_PULL_FLOAT</span><span class="p">,</span>

	<span class="cm">/* SPI */</span>
	<span class="n">GPIO34_GPIO</span><span class="p">,</span>	<span class="cm">/* SPDIF_CS */</span>
	<span class="n">GPIO96_GPIO</span><span class="p">,</span>	<span class="cm">/* MCLK_CS */</span>
	<span class="n">GPIO125_GPIO</span><span class="p">,</span>	<span class="cm">/* ACCEL_CS */</span>

	<span class="cm">/* MMC */</span>
	<span class="n">GPIO3_MMC1_DAT0</span><span class="p">,</span>
	<span class="n">GPIO4_MMC1_DAT1</span><span class="p">,</span>
	<span class="n">GPIO5_MMC1_DAT2</span><span class="p">,</span>
	<span class="n">GPIO6_MMC1_DAT3</span><span class="p">,</span>
	<span class="n">GPIO7_MMC1_CLK</span><span class="p">,</span>
	<span class="n">GPIO8_MMC1_CMD</span><span class="p">,</span>

	<span class="cm">/* Ethernet */</span>
	<span class="n">GPIO1_nCS2</span><span class="p">,</span>			<span class="cm">/* CS */</span>
	<span class="n">GPIO40_GPIO</span> <span class="o">|</span> <span class="n">MFP_PULL_HIGH</span><span class="p">,</span>	<span class="cm">/* IRQ */</span>

	<span class="cm">/* SSP for I2S */</span>
	<span class="n">GPIO85_SSP1_SCLK</span><span class="p">,</span>
	<span class="n">GPIO89_SSP1_EXTCLK</span><span class="p">,</span>
	<span class="n">GPIO86_SSP1_FRM</span><span class="p">,</span>
	<span class="n">GPIO87_SSP1_TXD</span><span class="p">,</span>
	<span class="n">GPIO88_SSP1_RXD</span><span class="p">,</span>
	<span class="n">GPIO90_SSP1_SYSCLK</span><span class="p">,</span>

	<span class="cm">/* SSP2 for S/PDIF */</span>
	<span class="n">GPIO25_SSP2_SCLK</span><span class="p">,</span>
	<span class="n">GPIO26_SSP2_FRM</span><span class="p">,</span>
	<span class="n">GPIO27_SSP2_TXD</span><span class="p">,</span>
	<span class="n">GPIO29_SSP2_EXTCLK</span><span class="p">,</span>

	<span class="cm">/* LEDs */</span>
	<span class="n">GPIO35_GPIO</span> <span class="o">|</span> <span class="n">MFP_LPM_PULL_LOW</span><span class="p">,</span>
	<span class="n">GPIO36_GPIO</span> <span class="o">|</span> <span class="n">MFP_LPM_DRIVE_HIGH</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">mfp_cfg_t</span> <span class="n">raumfeld_speaker_pin_config</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* UART1 */</span>
	<span class="n">GPIO77_UART1_RXD</span><span class="p">,</span>
	<span class="n">GPIO78_UART1_TXD</span><span class="p">,</span>
	<span class="n">GPIO79_UART1_CTS</span><span class="p">,</span>
	<span class="n">GPIO81_UART1_DSR</span><span class="p">,</span>
	<span class="n">GPIO83_UART1_DTR</span><span class="p">,</span>
	<span class="n">GPIO84_UART1_RTS</span><span class="p">,</span>

	<span class="cm">/* UART3 */</span>
	<span class="n">GPIO110_UART3_RXD</span><span class="p">,</span>

	<span class="cm">/* USB Host */</span>
	<span class="n">GPIO0_2_USBH_PEN</span><span class="p">,</span>
	<span class="n">GPIO1_2_USBH_PWR</span><span class="p">,</span>

	<span class="cm">/* I2C */</span>
	<span class="n">GPIO21_I2C_SCL</span> <span class="o">|</span> <span class="n">MFP_LPM_FLOAT</span> <span class="o">|</span> <span class="n">MFP_PULL_FLOAT</span><span class="p">,</span>
	<span class="n">GPIO22_I2C_SDA</span> <span class="o">|</span> <span class="n">MFP_LPM_FLOAT</span> <span class="o">|</span> <span class="n">MFP_PULL_FLOAT</span><span class="p">,</span>

	<span class="cm">/* SPI */</span>
	<span class="n">GPIO34_GPIO</span><span class="p">,</span>	<span class="cm">/* SPDIF_CS */</span>
	<span class="n">GPIO96_GPIO</span><span class="p">,</span>	<span class="cm">/* MCLK_CS */</span>
	<span class="n">GPIO125_GPIO</span><span class="p">,</span>	<span class="cm">/* ACCEL_CS */</span>

	<span class="cm">/* MMC */</span>
	<span class="n">GPIO3_MMC1_DAT0</span><span class="p">,</span>
	<span class="n">GPIO4_MMC1_DAT1</span><span class="p">,</span>
	<span class="n">GPIO5_MMC1_DAT2</span><span class="p">,</span>
	<span class="n">GPIO6_MMC1_DAT3</span><span class="p">,</span>
	<span class="n">GPIO7_MMC1_CLK</span><span class="p">,</span>
	<span class="n">GPIO8_MMC1_CMD</span><span class="p">,</span>

	<span class="cm">/* Ethernet */</span>
	<span class="n">GPIO1_nCS2</span><span class="p">,</span>			<span class="cm">/* CS */</span>
	<span class="n">GPIO40_GPIO</span> <span class="o">|</span> <span class="n">MFP_PULL_HIGH</span><span class="p">,</span>	<span class="cm">/* IRQ */</span>

	<span class="cm">/* SSP for I2S */</span>
	<span class="n">GPIO85_SSP1_SCLK</span><span class="p">,</span>
	<span class="n">GPIO89_SSP1_EXTCLK</span><span class="p">,</span>
	<span class="n">GPIO86_SSP1_FRM</span><span class="p">,</span>
	<span class="n">GPIO87_SSP1_TXD</span><span class="p">,</span>
	<span class="n">GPIO88_SSP1_RXD</span><span class="p">,</span>
	<span class="n">GPIO90_SSP1_SYSCLK</span><span class="p">,</span>

	<span class="cm">/* LEDs */</span>
	<span class="n">GPIO35_GPIO</span> <span class="o">|</span> <span class="n">MFP_LPM_PULL_LOW</span><span class="p">,</span>
	<span class="n">GPIO36_GPIO</span> <span class="o">|</span> <span class="n">MFP_LPM_DRIVE_HIGH</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * SMSC LAN9220 Ethernet</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">smc91x_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">PXA3xx_CS2_PHYS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">PXA3xx_CS2_PHYS</span> <span class="o">+</span> <span class="mh">0xfffff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">PXA_GPIO_TO_IRQ</span><span class="p">(</span><span class="n">GPIO_ETH_IRQ</span><span class="p">),</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">PXA_GPIO_TO_IRQ</span><span class="p">(</span><span class="n">GPIO_ETH_IRQ</span><span class="p">),</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span> <span class="o">|</span> <span class="n">IRQF_TRIGGER_FALLING</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">smsc911x_platform_config</span> <span class="n">raumfeld_smsc911x_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">phy_interface</span>	<span class="o">=</span> <span class="n">PHY_INTERFACE_MODE_MII</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_polarity</span>	<span class="o">=</span> <span class="n">SMSC911X_IRQ_POLARITY_ACTIVE_LOW</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_type</span>	<span class="o">=</span> <span class="n">SMSC911X_IRQ_TYPE_OPEN_DRAIN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">SMSC911X_USE_32BIT</span> <span class="o">|</span> <span class="n">SMSC911X_SAVE_MAC_ADDRESS</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">smc91x_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;smsc911x&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">smc91x_resources</span><span class="p">),</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">smc91x_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">raumfeld_smsc911x_config</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * NAND</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mtd_partition</span> <span class="n">raumfeld_nand_partitions</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;Bootloader&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mh">0xa0000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask_flags</span>	<span class="o">=</span> <span class="n">MTD_WRITEABLE</span><span class="p">,</span> <span class="cm">/* force read-only */</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;BootloaderEnvironment&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mh">0xa0000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mh">0x20000</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;BootloaderSplashScreen&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mh">0xc0000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mh">0x60000</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;UBI&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mh">0x120000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="n">MTDPART_SIZ_FULL</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pxa3xx_nand_platform_data</span> <span class="n">raumfeld_nand_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">enable_arbiter</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">keep_config</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_cs</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>	<span class="o">=</span> <span class="n">raumfeld_nand_partitions</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nr_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">raumfeld_nand_partitions</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * USB (OHCI) support</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pxaohci_platform_data</span> <span class="n">raumfeld_ohci_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">port_mode</span>      <span class="o">=</span> <span class="n">PMM_GLOBAL_MODE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">ENABLE_PORT1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Rotary encoder input device</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rotary_encoder_platform_data</span> <span class="n">raumfeld_rotary_encoder_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">steps</span>		<span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
	<span class="p">.</span><span class="n">axis</span>		<span class="o">=</span> <span class="n">REL_X</span><span class="p">,</span>
	<span class="p">.</span><span class="n">relative_axis</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gpio_a</span>		<span class="o">=</span> <span class="n">GPIO_VOLENC_A</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gpio_b</span>		<span class="o">=</span> <span class="n">GPIO_VOLENC_B</span><span class="p">,</span>
	<span class="p">.</span><span class="n">inverted_a</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">inverted_b</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">rotary_encoder_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;rotary-encoder&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">raumfeld_rotary_encoder_info</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * GPIO buttons</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio_keys_button</span> <span class="n">gpio_keys_button</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">code</span>			<span class="o">=</span> <span class="n">KEY_F1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>			<span class="o">=</span> <span class="n">EV_KEY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span>			<span class="o">=</span> <span class="n">GPIO_KEY1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">active_low</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">wakeup</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">debounce_interval</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="cm">/* ms */</span>
		<span class="p">.</span><span class="n">desc</span>			<span class="o">=</span> <span class="s">&quot;Button 1&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">code</span>			<span class="o">=</span> <span class="n">KEY_F2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>			<span class="o">=</span> <span class="n">EV_KEY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span>			<span class="o">=</span> <span class="n">GPIO_KEY2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">active_low</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">wakeup</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">debounce_interval</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="cm">/* ms */</span>
		<span class="p">.</span><span class="n">desc</span>			<span class="o">=</span> <span class="s">&quot;Button 2&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">code</span>			<span class="o">=</span> <span class="n">KEY_F3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>			<span class="o">=</span> <span class="n">EV_KEY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span>			<span class="o">=</span> <span class="n">GPIO_KEY3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">active_low</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">wakeup</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">debounce_interval</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="cm">/* ms */</span>
		<span class="p">.</span><span class="n">desc</span>			<span class="o">=</span> <span class="s">&quot;Button 3&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">code</span>			<span class="o">=</span> <span class="n">KEY_F4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>			<span class="o">=</span> <span class="n">EV_KEY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span>			<span class="o">=</span> <span class="n">GPIO_RESCUE_BOOT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">active_low</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">wakeup</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">debounce_interval</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="cm">/* ms */</span>
		<span class="p">.</span><span class="n">desc</span>			<span class="o">=</span> <span class="s">&quot;rescue boot button&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">code</span>			<span class="o">=</span> <span class="n">KEY_F5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>			<span class="o">=</span> <span class="n">EV_KEY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span>			<span class="o">=</span> <span class="n">GPIO_DOCK_DETECT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">active_low</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">wakeup</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">debounce_interval</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="cm">/* ms */</span>
		<span class="p">.</span><span class="n">desc</span>			<span class="o">=</span> <span class="s">&quot;dock detect&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">code</span>			<span class="o">=</span> <span class="n">KEY_F6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>			<span class="o">=</span> <span class="n">EV_KEY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span>			<span class="o">=</span> <span class="n">GPIO_ON_OFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">active_low</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">wakeup</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">debounce_interval</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="cm">/* ms */</span>
		<span class="p">.</span><span class="n">desc</span>			<span class="o">=</span> <span class="s">&quot;on_off button&quot;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio_keys_platform_data</span> <span class="n">gpio_keys_platform_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">buttons</span>	<span class="o">=</span> <span class="n">gpio_keys_button</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nbuttons</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">gpio_keys_button</span><span class="p">),</span>
	<span class="p">.</span><span class="n">rep</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">raumfeld_gpio_keys_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;gpio-keys&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span> 	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">gpio_keys_platform_data</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * GPIO LEDs</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio_led</span> <span class="n">raumfeld_leds</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;raumfeld:1&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span>		<span class="o">=</span> <span class="n">GPIO_LED1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">active_low</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_state</span>	<span class="o">=</span> <span class="n">LEDS_GPIO_DEFSTATE_ON</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;raumfeld:2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span>		<span class="o">=</span> <span class="n">GPIO_LED2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">active_low</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_state</span>	<span class="o">=</span> <span class="n">LEDS_GPIO_DEFSTATE_OFF</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio_led_platform_data</span> <span class="n">raumfeld_led_platform_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">leds</span>		<span class="o">=</span> <span class="n">raumfeld_leds</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_leds</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">raumfeld_leds</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">raumfeld_led_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;leds-gpio&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">raumfeld_led_platform_data</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * One-wire (W1 bus) support</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">w1_enable_external_pullup</span><span class="p">(</span><span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">GPIO_W1_PULLUP_ENABLE</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">w1_gpio_platform_data</span> <span class="n">w1_gpio_platform_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">pin</span>			<span class="o">=</span> <span class="n">GPIO_ONE_WIRE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">is_open_drain</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_external_pullup</span>	<span class="o">=</span> <span class="n">w1_enable_external_pullup</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">platform_device</span> <span class="n">raumfeld_w1_gpio_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;w1-gpio&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">w1_gpio_platform_data</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">raumfeld_w1_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_W1_PULLUP_ENABLE</span><span class="p">,</span>
				<span class="s">&quot;W1 external pullup enable&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Unable to request GPIO_W1_PULLUP_ENABLE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">GPIO_W1_PULLUP_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">raumfeld_w1_gpio_device</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Framebuffer device</span>
<span class="cm"> */</span>

<span class="cm">/* PWM controlled backlight */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_pwm_backlight_data</span> <span class="n">raumfeld_pwm_backlight_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">pwm_id</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_brightness</span>	<span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dft_brightness</span>	<span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
	<span class="cm">/* 10000 ns = 10 ms ^= 100 kHz */</span>
	<span class="p">.</span><span class="n">pwm_period_ns</span>	<span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">raumfeld_pwm_backlight_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;pwm-backlight&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pxa27x_device_pwm0</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">raumfeld_pwm_backlight_data</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* LT3593 controlled backlight */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio_led</span> <span class="n">raumfeld_lt3593_led</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;backlight&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gpio</span>		<span class="o">=</span> <span class="n">mfp_to_gpio</span><span class="p">(</span><span class="n">MFP_PIN_GPIO17</span><span class="p">),</span>
	<span class="p">.</span><span class="n">default_state</span>	<span class="o">=</span> <span class="n">LEDS_GPIO_DEFSTATE_ON</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio_led_platform_data</span> <span class="n">raumfeld_lt3593_platform_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">leds</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">raumfeld_lt3593_led</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_leds</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">raumfeld_lt3593_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;leds-lt3593&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">raumfeld_lt3593_platform_data</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pxafb_mode_info</span> <span class="n">sharp_lq043t3dx02_mode</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">pixclock</span>	<span class="o">=</span> <span class="mi">111000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xres</span>		<span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
	<span class="p">.</span><span class="n">yres</span>		<span class="o">=</span> <span class="mi">272</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bpp</span>		<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hsync_len</span>	<span class="o">=</span> <span class="mi">41</span><span class="p">,</span>
	<span class="p">.</span><span class="n">left_margin</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">right_margin</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vsync_len</span>	<span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
	<span class="p">.</span><span class="n">upper_margin</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lower_margin</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sync</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pxafb_mach_info</span> <span class="n">raumfeld_sharp_lcd_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">modes</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">sharp_lq043t3dx02_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_modes</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">video_mem_size</span> <span class="o">=</span> <span class="mh">0x400000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lcd_conn</span>	<span class="o">=</span> <span class="n">LCD_COLOR_TFT_16BPP</span> <span class="o">|</span> <span class="n">LCD_PCLK_EDGE_FALL</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PXA3XX_GCU</span>
	<span class="p">.</span><span class="n">acceleration_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">raumfeld_lcd_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_TFT_VA_EN</span><span class="p">,</span> <span class="s">&quot;display VA enable&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Unable to request GPIO_TFT_VA_EN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">GPIO_TFT_VA_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_DISPLAY_ENABLE</span><span class="p">,</span> <span class="s">&quot;display enable&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Unable to request GPIO_DISPLAY_ENABLE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">GPIO_DISPLAY_ENABLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Hardware revision 2 has the backlight regulator controlled</span>
<span class="cm">	 * by an LT3593, earlier and later devices use PWM for that. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">system_rev</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">raumfeld_lt3593_device</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mfp_cfg_t</span> <span class="n">raumfeld_pwm_pin_config</span> <span class="o">=</span> <span class="n">GPIO17_PWM0_OUT</span><span class="p">;</span>
		<span class="n">pxa3xx_mfp_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">raumfeld_pwm_pin_config</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">raumfeld_pwm_backlight_device</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pxa_set_fb_info</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">raumfeld_sharp_lcd_info</span><span class="p">);</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pxa3xx_device_gcu</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * SPI devices</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">spi_gpio_platform_data</span> <span class="n">raumfeld_spi_platform_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">sck</span>		<span class="o">=</span> <span class="n">GPIO_SPI_CLK</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mosi</span>		<span class="o">=</span> <span class="n">GPIO_SPI_MOSI</span><span class="p">,</span>
	<span class="p">.</span><span class="n">miso</span>		<span class="o">=</span> <span class="n">GPIO_SPI_MISO</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_chipselect</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">raumfeld_spi_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;spi_gpio&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span> 	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">raumfeld_spi_platform_data</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">lis3lv02d_platform_data</span> <span class="n">lis3_pdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">click_flags</span> 	<span class="o">=</span> <span class="n">LIS3_CLICK_SINGLE_X</span> <span class="o">|</span>
			  <span class="n">LIS3_CLICK_SINGLE_Y</span> <span class="o">|</span>
			  <span class="n">LIS3_CLICK_SINGLE_Z</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_cfg</span>	<span class="o">=</span> <span class="n">LIS3_IRQ1_CLICK</span> <span class="o">|</span> <span class="n">LIS3_IRQ2_CLICK</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wakeup_flags</span>	<span class="o">=</span> <span class="n">LIS3_WAKEUP_X_LO</span> <span class="o">|</span> <span class="n">LIS3_WAKEUP_X_HI</span> <span class="o">|</span>
			  <span class="n">LIS3_WAKEUP_Y_LO</span> <span class="o">|</span> <span class="n">LIS3_WAKEUP_Y_HI</span> <span class="o">|</span>
			  <span class="n">LIS3_WAKEUP_Z_LO</span> <span class="o">|</span> <span class="n">LIS3_WAKEUP_Z_HI</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wakeup_thresh</span>	<span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
	<span class="p">.</span><span class="n">click_thresh_x</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
	<span class="p">.</span><span class="n">click_thresh_y</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
	<span class="p">.</span><span class="n">click_thresh_z</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define SPI_AK4104	\</span>
<span class="cp">{			\</span>
<span class="cp">	.modalias	= &quot;ak4104-codec&quot;,	\</span>
<span class="cp">	.max_speed_hz	= 10000,		\</span>
<span class="cp">	.bus_num	= 0,			\</span>
<span class="cp">	.chip_select	= 0,			\</span>
<span class="cp">	.controller_data = (void *) GPIO_SPDIF_CS,	\</span>
<span class="cp">}</span>

<span class="cp">#define SPI_LIS3	\</span>
<span class="cp">{			\</span>
<span class="cp">	.modalias	= &quot;lis3lv02d_spi&quot;,	\</span>
<span class="cp">	.max_speed_hz	= 1000000,		\</span>
<span class="cp">	.bus_num	= 0,			\</span>
<span class="cp">	.chip_select	= 1,			\</span>
<span class="cp">	.controller_data = (void *) GPIO_ACCEL_CS,	\</span>
<span class="cp">	.platform_data	= &amp;lis3_pdata,		\</span>
<span class="cp">	.irq		= PXA_GPIO_TO_IRQ(GPIO_ACCEL_IRQ),	\</span>
<span class="cp">}</span>

<span class="cp">#define SPI_DAC7512	\</span>
<span class="cp">{	\</span>
<span class="cp">	.modalias	= &quot;dac7512&quot;,		\</span>
<span class="cp">	.max_speed_hz	= 1000000,		\</span>
<span class="cp">	.bus_num	= 0,			\</span>
<span class="cp">	.chip_select	= 2,			\</span>
<span class="cp">	.controller_data = (void *) GPIO_MCLK_DAC_CS,	\</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">spi_board_info</span> <span class="n">connector_spi_devices</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SPI_AK4104</span><span class="p">,</span>
	<span class="n">SPI_DAC7512</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">spi_board_info</span> <span class="n">speaker_spi_devices</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SPI_DAC7512</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">spi_board_info</span> <span class="n">controller_spi_devices</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SPI_LIS3</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * MMC for Marvell Libertas 8688 via SDIO</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raumfeld_mci_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">irq_handler_t</span> <span class="n">isr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">GPIO_W2W_RESET</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">GPIO_W2W_PDN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">raumfeld_mci_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">GPIO_W2W_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">GPIO_W2W_PDN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pxamci_platform_data</span> <span class="n">raumfeld_mci_platform_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init</span>			<span class="o">=</span> <span class="n">raumfeld_mci_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span>			<span class="o">=</span> <span class="n">raumfeld_mci_exit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detect_delay_ms</span>	<span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gpio_card_detect</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gpio_card_ro</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gpio_power</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * External power / charge logic</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">power_supply_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">power_supply_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raumfeld_is_ac_online</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">gpio_get_value</span><span class="p">(</span><span class="n">GPIO_CHARGE_DC_OK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raumfeld_is_usb_online</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">raumfeld_power_supplicants</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;ds2760-battery.0&quot;</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">raumfeld_power_signal_charged</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">power_supply</span> <span class="o">*</span><span class="n">psy</span> <span class="o">=</span>
		<span class="n">power_supply_get_by_name</span><span class="p">(</span><span class="n">raumfeld_power_supplicants</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psy</span><span class="p">)</span>
		<span class="n">power_supply_set_battery_charged</span><span class="p">(</span><span class="n">psy</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">raumfeld_power_resume</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* check if GPIO_CHARGE_DONE went low while we were sleeping */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gpio_get_value</span><span class="p">(</span><span class="n">GPIO_CHARGE_DONE</span><span class="p">))</span>
		<span class="n">raumfeld_power_signal_charged</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pda_power_pdata</span> <span class="n">power_supply_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init</span>			<span class="o">=</span> <span class="n">power_supply_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">is_ac_online</span>		<span class="o">=</span> <span class="n">raumfeld_is_ac_online</span><span class="p">,</span>
	<span class="p">.</span><span class="n">is_usb_online</span>		<span class="o">=</span> <span class="n">raumfeld_is_usb_online</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span>			<span class="o">=</span> <span class="n">power_supply_exit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">supplied_to</span>		<span class="o">=</span> <span class="n">raumfeld_power_supplicants</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_supplicants</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">raumfeld_power_supplicants</span><span class="p">),</span>
	<span class="p">.</span><span class="n">resume</span>			<span class="o">=</span> <span class="n">raumfeld_power_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">power_supply_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;ac&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span> <span class="o">|</span>
			 <span class="n">IORESOURCE_IRQ_HIGHEDGE</span> <span class="o">|</span> <span class="n">IORESOURCE_IRQ_LOWEDGE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">GPIO_CHARGE_DC_OK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>   <span class="o">=</span> <span class="n">GPIO_CHARGE_DC_OK</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">charge_done_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">raumfeld_power_signal_charged</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">raumfeld_power_supply</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pda-power&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>   <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>  <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">power_supply_info</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>      <span class="o">=</span> <span class="n">power_supply_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">power_supply_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">raumfeld_power_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Set PEN2 high to enable maximum charge current */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_CHRG_PEN2</span><span class="p">,</span> <span class="s">&quot;CHRG_PEN2&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Unable to request GPIO_CHRG_PEN2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">GPIO_CHRG_PEN2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_CHARGE_DC_OK</span><span class="p">,</span> <span class="s">&quot;CABLE_DC_OK&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Unable to request GPIO_CHARGE_DC_OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_CHARGE_USB_SUSP</span><span class="p">,</span> <span class="s">&quot;CHARGE_USB_SUSP&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Unable to request GPIO_CHARGE_USB_SUSP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">GPIO_CHARGE_USB_SUSP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">power_supply_resources</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span> <span class="o">=</span> <span class="n">gpio_to_irq</span><span class="p">(</span><span class="n">GPIO_CHARGE_DC_OK</span><span class="p">);</span>
	<span class="n">power_supply_resources</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">end</span> <span class="o">=</span> <span class="n">gpio_to_irq</span><span class="p">(</span><span class="n">GPIO_CHARGE_DC_OK</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">gpio_to_irq</span><span class="p">(</span><span class="n">GPIO_CHARGE_DONE</span><span class="p">),</span>
			<span class="o">&amp;</span><span class="n">charge_done_irq</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ_LOWEDGE</span><span class="p">,</span>
			<span class="s">&quot;charge_done&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: unable to register irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">GPIO_CHARGE_DONE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">raumfeld_power_supply</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Fixed regulator for AUDIO_VA, 0-0048 maps to the cs4270 codec device */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">regulator_consumer_supply</span> <span class="n">audio_va_consumer_supply</span> <span class="o">=</span>
	<span class="n">REGULATOR_SUPPLY</span><span class="p">(</span><span class="s">&quot;va&quot;</span><span class="p">,</span> <span class="s">&quot;0-0048&quot;</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">regulator_init_data</span> <span class="n">audio_va_initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">consumer_supplies</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">audio_va_consumer_supply</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_consumer_supplies</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">valid_ops_mask</span> <span class="o">=</span> <span class="n">REGULATOR_CHANGE_STATUS</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fixed_voltage_config</span> <span class="n">audio_va_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">supply_name</span>		<span class="o">=</span> <span class="s">&quot;audio_va&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">microvolts</span>		<span class="o">=</span> <span class="mi">5000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gpio</span>			<span class="o">=</span> <span class="n">GPIO_AUDIO_VA_ENABLE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_high</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enabled_at_boot</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">audio_va_initdata</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">audio_va_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;reg-fixed-voltage&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">audio_va_config</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* Dummy supplies for Codec&#39;s VD/VLC */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">regulator_consumer_supply</span> <span class="n">audio_dummy_supplies</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">REGULATOR_SUPPLY</span><span class="p">(</span><span class="s">&quot;vd&quot;</span><span class="p">,</span> <span class="s">&quot;0-0048&quot;</span><span class="p">),</span>
	<span class="n">REGULATOR_SUPPLY</span><span class="p">(</span><span class="s">&quot;vlc&quot;</span><span class="p">,</span> <span class="s">&quot;0-0048&quot;</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">regulator_init_data</span> <span class="n">audio_dummy_initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">consumer_supplies</span> <span class="o">=</span> <span class="n">audio_dummy_supplies</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_consumer_supplies</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">audio_dummy_supplies</span><span class="p">),</span>
	<span class="p">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">valid_ops_mask</span> <span class="o">=</span> <span class="n">REGULATOR_CHANGE_STATUS</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fixed_voltage_config</span> <span class="n">audio_dummy_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">supply_name</span>		<span class="o">=</span> <span class="s">&quot;audio_vd&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">microvolts</span>		<span class="o">=</span> <span class="mi">3300000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gpio</span>			<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">audio_dummy_initdata</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">audio_supply_dummy_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;reg-fixed-voltage&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">audio_dummy_config</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">audio_regulator_devices</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">audio_va_device</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">audio_supply_dummy_device</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Regulator support via MAX8660</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">regulator_consumer_supply</span> <span class="n">vcc_mmc_supply</span> <span class="o">=</span>
	<span class="n">REGULATOR_SUPPLY</span><span class="p">(</span><span class="s">&quot;vmmc&quot;</span><span class="p">,</span> <span class="s">&quot;pxa2xx-mci.0&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">regulator_init_data</span> <span class="n">vcc_mmc_init_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">min_uV</span>			<span class="o">=</span> <span class="mi">3300000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_uV</span>			<span class="o">=</span> <span class="mi">3300000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">valid_modes_mask</span>	<span class="o">=</span> <span class="n">REGULATOR_MODE_NORMAL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">valid_ops_mask</span>		<span class="o">=</span> <span class="n">REGULATOR_CHANGE_STATUS</span> <span class="o">|</span>
					  <span class="n">REGULATOR_CHANGE_VOLTAGE</span> <span class="o">|</span>
					  <span class="n">REGULATOR_CHANGE_MODE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">consumer_supplies</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vcc_mmc_supply</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_consumer_supplies</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">max8660_subdev_data</span> <span class="n">max8660_v6_subdev_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">MAX8660_V6</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;vmmc&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">vcc_mmc_init_data</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">max8660_platform_data</span> <span class="n">max8660_pdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">subdevs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">max8660_v6_subdev_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_subdevs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * I2C devices</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">raumfeld_pwri2c_board_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="s">&quot;max8660&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">addr</span>		<span class="o">=</span> <span class="mh">0x34</span><span class="p">,</span>
	<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">max8660_pdata</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">raumfeld_connector_i2c_board_info</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span>	<span class="o">=</span> <span class="s">&quot;cs4270&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">addr</span>	<span class="o">=</span> <span class="mh">0x48</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">eeti_ts_platform_data</span> <span class="n">eeti_ts_pdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">irq_active_high</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">raumfeld_controller_i2c_board_info</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span>	<span class="o">=</span> <span class="s">&quot;eeti_ts&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">addr</span>	<span class="o">=</span> <span class="mh">0x0a</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq</span>	<span class="o">=</span> <span class="n">PXA_GPIO_TO_IRQ</span><span class="p">(</span><span class="n">GPIO_TOUCH_IRQ</span><span class="p">),</span>
	<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">eeti_ts_pdata</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">raumfeld_common_devices</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">raumfeld_gpio_keys_device</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">raumfeld_led_device</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">raumfeld_spi_device</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">raumfeld_audio_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_CODEC_RESET</span><span class="p">,</span> <span class="s">&quot;cs4270 reset&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;unable to request GPIO_CODEC_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">GPIO_CODEC_RESET</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_SPDIF_RESET</span><span class="p">,</span> <span class="s">&quot;ak4104 s/pdif reset&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;unable to request GPIO_SPDIF_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">GPIO_SPDIF_RESET</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_MCLK_RESET</span><span class="p">,</span> <span class="s">&quot;MCLK reset&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;unable to request GPIO_MCLK_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">GPIO_MCLK_RESET</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">platform_add_devices</span><span class="p">(</span><span class="n">ARRAY_AND_SIZE</span><span class="p">(</span><span class="n">audio_regulator_devices</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">raumfeld_common_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* The on/off button polarity has changed after revision 1 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">system_rev</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">gpio_keys_button</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">gpio_keys_button</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span> <span class="s">&quot;on_off button&quot;</span><span class="p">))</span>
				<span class="n">gpio_keys_button</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">active_low</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">enable_irq_wake</span><span class="p">(</span><span class="n">IRQ_WAKEUP0</span><span class="p">);</span>

	<span class="n">pxa3xx_set_nand_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">raumfeld_nand_info</span><span class="p">);</span>
	<span class="n">pxa3xx_set_i2c_power_info</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="n">pxa_set_ohci_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">raumfeld_ohci_info</span><span class="p">);</span>
	<span class="n">pxa_set_mci_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">raumfeld_mci_platform_data</span><span class="p">);</span>
	<span class="n">pxa_set_i2c_info</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="n">pxa_set_ffuart_info</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_W2W_RESET</span><span class="p">,</span> <span class="s">&quot;Wi2Wi reset&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Unable to request GPIO_W2W_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">GPIO_W2W_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_W2W_PDN</span><span class="p">,</span> <span class="s">&quot;Wi2Wi powerup&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Unable to request GPIO_W2W_PDN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">GPIO_W2W_PDN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* this can be used to switch off the device */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_SHUTDOWN_SUPPLY</span><span class="p">,</span> <span class="s">&quot;supply shutdown&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Unable to request GPIO_SHUTDOWN_SUPPLY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">GPIO_SHUTDOWN_SUPPLY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">platform_add_devices</span><span class="p">(</span><span class="n">ARRAY_AND_SIZE</span><span class="p">(</span><span class="n">raumfeld_common_devices</span><span class="p">));</span>
	<span class="n">i2c_register_board_info</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">raumfeld_pwri2c_board_info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">raumfeld_controller_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pxa3xx_mfp_config</span><span class="p">(</span><span class="n">ARRAY_AND_SIZE</span><span class="p">(</span><span class="n">raumfeld_controller_pin_config</span><span class="p">));</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rotary_encoder_device</span><span class="p">);</span>
	<span class="n">spi_register_board_info</span><span class="p">(</span><span class="n">ARRAY_AND_SIZE</span><span class="p">(</span><span class="n">controller_spi_devices</span><span class="p">));</span>
	<span class="n">i2c_register_board_info</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">raumfeld_controller_i2c_board_info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">GPIO_SHUTDOWN_BATT</span><span class="p">,</span> <span class="s">&quot;battery shutdown&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Unable to request GPIO_SHUTDOWN_BATT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">GPIO_SHUTDOWN_BATT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">raumfeld_common_init</span><span class="p">();</span>
	<span class="n">raumfeld_power_init</span><span class="p">();</span>
	<span class="n">raumfeld_lcd_init</span><span class="p">();</span>
	<span class="n">raumfeld_w1_init</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">raumfeld_connector_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pxa3xx_mfp_config</span><span class="p">(</span><span class="n">ARRAY_AND_SIZE</span><span class="p">(</span><span class="n">raumfeld_connector_pin_config</span><span class="p">));</span>
	<span class="n">spi_register_board_info</span><span class="p">(</span><span class="n">ARRAY_AND_SIZE</span><span class="p">(</span><span class="n">connector_spi_devices</span><span class="p">));</span>
	<span class="n">i2c_register_board_info</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">raumfeld_connector_i2c_board_info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">smc91x_device</span><span class="p">);</span>

	<span class="n">raumfeld_audio_init</span><span class="p">();</span>
	<span class="n">raumfeld_common_init</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">raumfeld_speaker_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pxa3xx_mfp_config</span><span class="p">(</span><span class="n">ARRAY_AND_SIZE</span><span class="p">(</span><span class="n">raumfeld_speaker_pin_config</span><span class="p">));</span>
	<span class="n">spi_register_board_info</span><span class="p">(</span><span class="n">ARRAY_AND_SIZE</span><span class="p">(</span><span class="n">speaker_spi_devices</span><span class="p">));</span>
	<span class="n">i2c_register_board_info</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">raumfeld_connector_i2c_board_info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">smc91x_device</span><span class="p">);</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rotary_encoder_device</span><span class="p">);</span>

	<span class="n">raumfeld_audio_init</span><span class="p">();</span>
	<span class="n">raumfeld_common_init</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* physical memory regions */</span>
<span class="cp">#define	RAUMFELD_SDRAM_BASE	0xa0000000	</span><span class="cm">/* SDRAM region */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_MACH_RAUMFELD_RC</span>
<span class="n">MACHINE_START</span><span class="p">(</span><span class="n">RAUMFELD_RC</span><span class="p">,</span> <span class="s">&quot;Raumfeld Controller&quot;</span><span class="p">)</span>
	<span class="p">.</span><span class="n">atag_offset</span>	<span class="o">=</span> <span class="mh">0x100</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_machine</span>	<span class="o">=</span> <span class="n">raumfeld_controller_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">map_io</span>		<span class="o">=</span> <span class="n">pxa3xx_map_io</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nr_irqs</span>	<span class="o">=</span> <span class="n">PXA_NR_IRQS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_irq</span>	<span class="o">=</span> <span class="n">pxa3xx_init_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">handle_irq</span>	<span class="o">=</span> <span class="n">pxa3xx_handle_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">timer</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pxa_timer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">restart</span>	<span class="o">=</span> <span class="n">pxa_restart</span><span class="p">,</span>
<span class="n">MACHINE_END</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_MACH_RAUMFELD_CONNECTOR</span>
<span class="n">MACHINE_START</span><span class="p">(</span><span class="n">RAUMFELD_CONNECTOR</span><span class="p">,</span> <span class="s">&quot;Raumfeld Connector&quot;</span><span class="p">)</span>
	<span class="p">.</span><span class="n">atag_offset</span>	<span class="o">=</span> <span class="mh">0x100</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_machine</span>	<span class="o">=</span> <span class="n">raumfeld_connector_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">map_io</span>		<span class="o">=</span> <span class="n">pxa3xx_map_io</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nr_irqs</span>	<span class="o">=</span> <span class="n">PXA_NR_IRQS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_irq</span>	<span class="o">=</span> <span class="n">pxa3xx_init_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">handle_irq</span>	<span class="o">=</span> <span class="n">pxa3xx_handle_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">timer</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pxa_timer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">restart</span>	<span class="o">=</span> <span class="n">pxa_restart</span><span class="p">,</span>
<span class="n">MACHINE_END</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_MACH_RAUMFELD_SPEAKER</span>
<span class="n">MACHINE_START</span><span class="p">(</span><span class="n">RAUMFELD_SPEAKER</span><span class="p">,</span> <span class="s">&quot;Raumfeld Speaker&quot;</span><span class="p">)</span>
	<span class="p">.</span><span class="n">atag_offset</span>	<span class="o">=</span> <span class="mh">0x100</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_machine</span>	<span class="o">=</span> <span class="n">raumfeld_speaker_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">map_io</span>		<span class="o">=</span> <span class="n">pxa3xx_map_io</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nr_irqs</span>	<span class="o">=</span> <span class="n">PXA_NR_IRQS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_irq</span>	<span class="o">=</span> <span class="n">pxa3xx_init_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">handle_irq</span>	<span class="o">=</span> <span class="n">pxa3xx_handle_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">timer</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pxa_timer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">restart</span>	<span class="o">=</span> <span class="n">pxa_restart</span><span class="p">,</span>
<span class="n">MACHINE_END</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
