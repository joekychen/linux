<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › mach-pxa › pcm990-baseboard.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>pcm990-baseboard.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  arch/arm/mach-pxa/pcm990-baseboard.c</span>
<span class="cm"> *  Support for the Phytec phyCORE-PXA270 Development Platform (PCM-990).</span>
<span class="cm"> *</span>
<span class="cm"> *  Refer</span>
<span class="cm"> *   http://www.phytec.com/products/rdk/ARM-XScale/phyCORE-XScale-PXA270.html</span>
<span class="cm"> *  for additional hardware info</span>
<span class="cm"> *</span>
<span class="cm"> *  Author:	Juergen Kilb</span>
<span class="cm"> *  Created:	April 05, 2005</span>
<span class="cm"> *  Copyright:	Phytec Messtechnik GmbH</span>
<span class="cm"> *  e-Mail:	armlinux@phytec.de</span>
<span class="cm"> *</span>
<span class="cm"> *  based on Intel Mainstone Board</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright 2007 Juergen Beisert @ Pengutronix (j.beisert@pengutronix.de)</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> *  published by the Free Software Foundation.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/i2c/pxa-i2c.h&gt;</span>
<span class="cp">#include &lt;linux/pwm_backlight.h&gt;</span>

<span class="cp">#include &lt;media/soc_camera.h&gt;</span>

<span class="cp">#include &lt;mach/camera.h&gt;</span>
<span class="cp">#include &lt;asm/mach/map.h&gt;</span>
<span class="cp">#include &lt;mach/pxa27x.h&gt;</span>
<span class="cp">#include &lt;mach/audio.h&gt;</span>
<span class="cp">#include &lt;mach/mmc.h&gt;</span>
<span class="cp">#include &lt;mach/ohci.h&gt;</span>
<span class="cp">#include &lt;mach/pcm990_baseboard.h&gt;</span>
<span class="cp">#include &lt;mach/pxafb.h&gt;</span>

<span class="cp">#include &quot;devices.h&quot;</span>
<span class="cp">#include &quot;generic.h&quot;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pcm990_pin_config</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* MMC */</span>
	<span class="n">GPIO32_MMC_CLK</span><span class="p">,</span>
	<span class="n">GPIO112_MMC_CMD</span><span class="p">,</span>
	<span class="n">GPIO92_MMC_DAT_0</span><span class="p">,</span>
	<span class="n">GPIO109_MMC_DAT_1</span><span class="p">,</span>
	<span class="n">GPIO110_MMC_DAT_2</span><span class="p">,</span>
	<span class="n">GPIO111_MMC_DAT_3</span><span class="p">,</span>
	<span class="cm">/* USB */</span>
	<span class="n">GPIO88_USBH1_PWR</span><span class="p">,</span>
	<span class="n">GPIO89_USBH1_PEN</span><span class="p">,</span>
	<span class="cm">/* PWM0 */</span>
	<span class="n">GPIO16_PWM0_OUT</span><span class="p">,</span>

	<span class="cm">/* I2C */</span>
	<span class="n">GPIO117_I2C_SCL</span><span class="p">,</span>
	<span class="n">GPIO118_I2C_SDA</span><span class="p">,</span>

	<span class="cm">/* AC97 */</span>
	<span class="n">GPIO28_AC97_BITCLK</span><span class="p">,</span>
	<span class="n">GPIO29_AC97_SDATA_IN_0</span><span class="p">,</span>
	<span class="n">GPIO30_AC97_SDATA_OUT</span><span class="p">,</span>
	<span class="n">GPIO31_AC97_SYNC</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pcm990_cpld_base</span><span class="p">;</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">pcm990_cpld_readb</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readb</span><span class="p">(</span><span class="n">pcm990_cpld_base</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcm990_cpld_writeb</span><span class="p">(</span><span class="n">u8</span> <span class="n">value</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">pcm990_cpld_base</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * pcm990_lcd_power - control power supply to the LCD</span>
<span class="cm"> * @on: 0 = switch off, 1 = switch on</span>
<span class="cm"> *</span>
<span class="cm"> * Called by the pxafb driver</span>
<span class="cm"> */</span>
<span class="cp">#ifndef CONFIG_PCM990_DISPLAY_NONE</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcm990_lcd_power</span><span class="p">(</span><span class="kt">int</span> <span class="n">on</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* enable LCD-Latches</span>
<span class="cm">		 * power on LCD</span>
<span class="cm">		 */</span>
		<span class="n">pcm990_cpld_writeb</span><span class="p">(</span><span class="n">PCM990_CTRL_LCDPWR</span> <span class="o">+</span> <span class="n">PCM990_CTRL_LCDON</span><span class="p">,</span>
				<span class="n">PCM990_CTRL_REG3</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* disable LCD-Latches</span>
<span class="cm">		 * power off LCD</span>
<span class="cm">		 */</span>
		<span class="n">pcm990_cpld_writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">PCM990_CTRL_REG3</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_PCM990_DISPLAY_SHARP)</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pxafb_mode_info</span> <span class="n">fb_info_sharp_lq084v1dg21</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">pixclock</span>		<span class="o">=</span> <span class="mi">28000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xres</span>			<span class="o">=</span> <span class="mi">640</span><span class="p">,</span>
	<span class="p">.</span><span class="n">yres</span>			<span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bpp</span>			<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hsync_len</span>		<span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
	<span class="p">.</span><span class="n">left_margin</span>		<span class="o">=</span> <span class="mi">103</span><span class="p">,</span>
	<span class="p">.</span><span class="n">right_margin</span>		<span class="o">=</span> <span class="mi">47</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vsync_len</span>		<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
	<span class="p">.</span><span class="n">upper_margin</span>		<span class="o">=</span> <span class="mi">28</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lower_margin</span>		<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sync</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmap_greyscale</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pxafb_mach_info</span> <span class="n">pcm990_fbinfo</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">modes</span>			<span class="o">=</span> <span class="o">&amp;</span><span class="n">fb_info_sharp_lq084v1dg21</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_modes</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lcd_conn</span>		<span class="o">=</span> <span class="n">LCD_COLOR_TFT_16BPP</span> <span class="o">|</span> <span class="n">LCD_PCLK_EDGE_FALL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pxafb_lcd_power</span>	<span class="o">=</span> <span class="n">pcm990_lcd_power</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#elif defined(CONFIG_PCM990_DISPLAY_NEC)</span>
<span class="k">struct</span> <span class="n">pxafb_mode_info</span> <span class="n">fb_info_nec_nl6448bc20_18d</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">pixclock</span>		<span class="o">=</span> <span class="mi">39720</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xres</span>			<span class="o">=</span> <span class="mi">640</span><span class="p">,</span>
	<span class="p">.</span><span class="n">yres</span>			<span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bpp</span>			<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hsync_len</span>		<span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">left_margin</span>		<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	<span class="p">.</span><span class="n">right_margin</span>		<span class="o">=</span> <span class="mi">48</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vsync_len</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">upper_margin</span>		<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lower_margin</span>		<span class="o">=</span> <span class="mi">17</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sync</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmap_greyscale</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pxafb_mach_info</span> <span class="n">pcm990_fbinfo</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">modes</span>			<span class="o">=</span> <span class="o">&amp;</span><span class="n">fb_info_nec_nl6448bc20_18d</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_modes</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lcd_conn</span>		<span class="o">=</span> <span class="n">LCD_COLOR_TFT_16BPP</span> <span class="o">|</span> <span class="n">LCD_PCLK_EDGE_FALL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pxafb_lcd_power</span>	<span class="o">=</span> <span class="n">pcm990_lcd_power</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_pwm_backlight_data</span> <span class="n">pcm990_backlight_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">pwm_id</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_brightness</span>	<span class="o">=</span> <span class="mi">1023</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dft_brightness</span>	<span class="o">=</span> <span class="mi">1023</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pwm_period_ns</span>	<span class="o">=</span> <span class="mi">78770</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">pcm990_backlight_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;pwm-backlight&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pxa27x_device_pwm0</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pcm990_backlight_data</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * The PCM-990 development baseboard uses PCM-027&#39;s hardware in the</span>
<span class="cm"> * following way:</span>
<span class="cm"> *</span>
<span class="cm"> * - LCD support is in use</span>
<span class="cm"> *  - GPIO16 is output for back light on/off with PWM</span>
<span class="cm"> *  - GPIO58 ... GPIO73 are outputs for display data</span>
<span class="cm"> *  - GPIO74 is output output for LCDFCLK</span>
<span class="cm"> *  - GPIO75 is output for LCDLCLK</span>
<span class="cm"> *  - GPIO76 is output for LCDPCLK</span>
<span class="cm"> *  - GPIO77 is output for LCDBIAS</span>
<span class="cm"> * - MMC support is in use</span>
<span class="cm"> *  - GPIO32 is output for MMCCLK</span>
<span class="cm"> *  - GPIO92 is MMDAT0</span>
<span class="cm"> *  - GPIO109 is MMDAT1</span>
<span class="cm"> *  - GPIO110 is MMCS0</span>
<span class="cm"> *  - GPIO111 is MMCS1</span>
<span class="cm"> *  - GPIO112 is MMCMD</span>
<span class="cm"> * - IDE/CF card is in use</span>
<span class="cm"> *  - GPIO48 is output /POE</span>
<span class="cm"> *  - GPIO49 is output /PWE</span>
<span class="cm"> *  - GPIO50 is output /PIOR</span>
<span class="cm"> *  - GPIO51 is output /PIOW</span>
<span class="cm"> *  - GPIO54 is output /PCE2</span>
<span class="cm"> *  - GPIO55 is output /PREG</span>
<span class="cm"> *  - GPIO56 is input /PWAIT</span>
<span class="cm"> *  - GPIO57 is output /PIOS16</span>
<span class="cm"> *  - GPIO79 is output PSKTSEL</span>
<span class="cm"> *  - GPIO85 is output /PCE1</span>
<span class="cm"> * - FFUART is in use</span>
<span class="cm"> *  - GPIO34 is input FFRXD</span>
<span class="cm"> *  - GPIO35 is input FFCTS</span>
<span class="cm"> *  - GPIO36 is input FFDCD</span>
<span class="cm"> *  - GPIO37 is input FFDSR</span>
<span class="cm"> *  - GPIO38 is input FFRI</span>
<span class="cm"> *  - GPIO39 is output FFTXD</span>
<span class="cm"> *  - GPIO40 is output FFDTR</span>
<span class="cm"> *  - GPIO41 is output FFRTS</span>
<span class="cm"> * - BTUART is in use</span>
<span class="cm"> *  - GPIO42 is input BTRXD</span>
<span class="cm"> *  - GPIO43 is output BTTXD</span>
<span class="cm"> *  - GPIO44 is input BTCTS</span>
<span class="cm"> *  - GPIO45 is output BTRTS</span>
<span class="cm"> * - IRUART is in use</span>
<span class="cm"> *  - GPIO46 is input STDRXD</span>
<span class="cm"> *  - GPIO47 is output STDTXD</span>
<span class="cm"> * - AC97 is in use*)</span>
<span class="cm"> *  - GPIO28 is input AC97CLK</span>
<span class="cm"> *  - GPIO29 is input AC97DatIn</span>
<span class="cm"> *  - GPIO30 is output AC97DatO</span>
<span class="cm"> *  - GPIO31 is output AC97SYNC</span>
<span class="cm"> *  - GPIO113 is output AC97_RESET</span>
<span class="cm"> * - SSP is in use</span>
<span class="cm"> *  - GPIO23 is output SSPSCLK</span>
<span class="cm"> *  - GPIO24 is output chip select to Max7301</span>
<span class="cm"> *  - GPIO25 is output SSPTXD</span>
<span class="cm"> *  - GPIO26 is input SSPRXD</span>
<span class="cm"> *  - GPIO27 is input for Max7301 IRQ</span>
<span class="cm"> *  - GPIO53 is input SSPSYSCLK</span>
<span class="cm"> * - SSP3 is in use</span>
<span class="cm"> *  - GPIO81 is output SSPTXD3</span>
<span class="cm"> *  - GPIO82 is input SSPRXD3</span>
<span class="cm"> *  - GPIO83 is output SSPSFRM</span>
<span class="cm"> *  - GPIO84 is output SSPCLK3</span>
<span class="cm"> *</span>
<span class="cm"> * Otherwise claimed GPIOs:</span>
<span class="cm"> * GPIO1 -&gt; IRQ from user switch</span>
<span class="cm"> * GPIO9 -&gt; IRQ from power management</span>
<span class="cm"> * GPIO10 -&gt; IRQ from WML9712 AC97 controller</span>
<span class="cm"> * GPIO11 -&gt; IRQ from IDE controller</span>
<span class="cm"> * GPIO12 -&gt; IRQ from CF controller</span>
<span class="cm"> * GPIO13 -&gt; IRQ from CF controller</span>
<span class="cm"> * GPIO14 -&gt; GPIO free</span>
<span class="cm"> * GPIO15 -&gt; /CS1 selects baseboard&#39;s Control CPLD (U7, 16 bit wide data path)</span>
<span class="cm"> * GPIO19 -&gt; GPIO free</span>
<span class="cm"> * GPIO20 -&gt; /SDCS2</span>
<span class="cm"> * GPIO21 -&gt; /CS3 PC card socket select</span>
<span class="cm"> * GPIO33 -&gt; /CS5  network controller select</span>
<span class="cm"> * GPIO78 -&gt; /CS2  (16 bit wide data path)</span>
<span class="cm"> * GPIO80 -&gt; /CS4  (16 bit wide data path)</span>
<span class="cm"> * GPIO86 -&gt; GPIO free</span>
<span class="cm"> * GPIO87 -&gt; GPIO free</span>
<span class="cm"> * GPIO90 -&gt; LED0 on CPU module</span>
<span class="cm"> * GPIO91 -&gt; LED1 on CPI module</span>
<span class="cm"> * GPIO117 -&gt; SCL</span>
<span class="cm"> * GPIO118 -&gt; SDA</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pcm990_irq_enabled</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcm990_mask_ack_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pcm990_irq</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">PCM027_IRQ</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>

	<span class="n">pcm990_irq_enabled</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pcm990_irq</span><span class="p">);</span>

	<span class="n">pcm990_cpld_writeb</span><span class="p">(</span><span class="n">pcm990_irq_enabled</span><span class="p">,</span> <span class="n">PCM990_CTRL_INTMSKENA</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcm990_unmask_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pcm990_irq</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">PCM027_IRQ</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* the irq can be acknowledged only if deasserted, so it&#39;s done here */</span>

	<span class="n">pcm990_irq_enabled</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pcm990_irq</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">pcm990_cpld_readb</span><span class="p">(</span><span class="n">PCM990_CTRL_INTSETCLR</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pcm990_irq</span><span class="p">;</span>
	<span class="n">pcm990_cpld_writeb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">PCM990_CTRL_INTSETCLR</span><span class="p">);</span>

	<span class="n">pcm990_cpld_writeb</span><span class="p">(</span><span class="n">pcm990_irq_enabled</span><span class="p">,</span> <span class="n">PCM990_CTRL_INTMSKENA</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">pcm990_irq_chip</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">irq_mask_ack</span>	<span class="o">=</span> <span class="n">pcm990_mask_ack_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span>	<span class="o">=</span> <span class="n">pcm990_unmask_irq</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcm990_irq_handler</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pending</span><span class="p">;</span>

	<span class="n">pending</span> <span class="o">=</span> <span class="o">~</span><span class="n">pcm990_cpld_readb</span><span class="p">(</span><span class="n">PCM990_CTRL_INTSETCLR</span><span class="p">);</span>
	<span class="n">pending</span> <span class="o">&amp;=</span> <span class="n">pcm990_irq_enabled</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* clear our parent IRQ */</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_ack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">pending</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">irq</span> <span class="o">=</span> <span class="n">PCM027_IRQ</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">__ffs</span><span class="p">(</span><span class="n">pending</span><span class="p">);</span>
			<span class="n">generic_handle_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">pending</span> <span class="o">=</span> <span class="o">~</span><span class="n">pcm990_cpld_readb</span><span class="p">(</span><span class="n">PCM990_CTRL_INTSETCLR</span><span class="p">);</span>
		<span class="n">pending</span> <span class="o">&amp;=</span> <span class="n">pcm990_irq_enabled</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">pending</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">pcm990_init_irq</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="cm">/* setup extra PCM990 irqs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">irq</span> <span class="o">=</span> <span class="n">PCM027_IRQ</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="n">irq</span> <span class="o">&lt;=</span> <span class="n">PCM027_IRQ</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span> <span class="n">irq</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq_set_chip_and_handler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm990_irq_chip</span><span class="p">,</span>
					 <span class="n">handle_level_irq</span><span class="p">);</span>
		<span class="n">set_irq_flags</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">IRQF_VALID</span> <span class="o">|</span> <span class="n">IRQF_PROBE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* disable all Interrupts */</span>
	<span class="n">pcm990_cpld_writeb</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">PCM990_CTRL_INTMSKENA</span><span class="p">);</span>
	<span class="n">pcm990_cpld_writeb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">PCM990_CTRL_INTSETCLR</span><span class="p">);</span>

	<span class="n">irq_set_chained_handler</span><span class="p">(</span><span class="n">PCM990_CTRL_INT_IRQ</span><span class="p">,</span> <span class="n">pcm990_irq_handler</span><span class="p">);</span>
	<span class="n">irq_set_irq_type</span><span class="p">(</span><span class="n">PCM990_CTRL_INT_IRQ</span><span class="p">,</span> <span class="n">PCM990_CTRL_INT_IRQ_EDGE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcm990_mci_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">irq_handler_t</span> <span class="n">mci_detect_int</span><span class="p">,</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">PCM027_MMCDET_IRQ</span><span class="p">,</span> <span class="n">mci_detect_int</span><span class="p">,</span> <span class="n">IRQF_DISABLED</span><span class="p">,</span>
			     <span class="s">&quot;MMC card detect&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;pcm990_mci_init: MMC/SD: can&#39;t request MMC &quot;</span>
				<span class="s">&quot;card detect IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcm990_mci_setpower</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vdd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxamci_platform_data</span> <span class="o">*</span><span class="n">p_d</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">pcm990_cpld_readb</span><span class="p">(</span><span class="n">PCM990_CTRL_REG5</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">vdd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">p_d</span><span class="o">-&gt;</span><span class="n">ocr_mask</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">PCM990_CTRL_MMC2PWR</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCM990_CTRL_MMC2PWR</span><span class="p">;</span>

	<span class="n">pcm990_cpld_writeb</span><span class="p">(</span><span class="n">PCM990_CTRL_MMC2PWR</span><span class="p">,</span> <span class="n">PCM990_CTRL_REG5</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcm990_mci_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">PCM027_MMCDET_IRQ</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define MSECS_PER_JIFFY (1000/HZ)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pxamci_platform_data</span> <span class="n">pcm990_mci_platform_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">detect_delay_ms</span>	<span class="o">=</span> <span class="mi">250</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ocr_mask</span>		<span class="o">=</span> <span class="n">MMC_VDD_32_33</span> <span class="o">|</span> <span class="n">MMC_VDD_33_34</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span> 			<span class="o">=</span> <span class="n">pcm990_mci_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setpower</span> 		<span class="o">=</span> <span class="n">pcm990_mci_setpower</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span>			<span class="o">=</span> <span class="n">pcm990_mci_exit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gpio_card_detect</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gpio_card_ro</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gpio_power</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pxaohci_platform_data</span> <span class="n">pcm990_ohci_platform_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">port_mode</span>	<span class="o">=</span> <span class="n">PMM_PERPORT_MODE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">ENABLE_PORT1</span> <span class="o">|</span> <span class="n">POWER_CONTROL_LOW</span> <span class="o">|</span> <span class="n">POWER_SENSE_LOW</span><span class="p">,</span>
	<span class="p">.</span><span class="n">power_on_delay</span>	<span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * PXA27x Camera specific stuff</span>
<span class="cm"> */</span>
<span class="cp">#if defined(CONFIG_VIDEO_PXA27x) || defined(CONFIG_VIDEO_PXA27x_MODULE)</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pcm990_camera_pin_config</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* CIF */</span>
	<span class="n">GPIO98_CIF_DD_0</span><span class="p">,</span>
	<span class="n">GPIO105_CIF_DD_1</span><span class="p">,</span>
	<span class="n">GPIO104_CIF_DD_2</span><span class="p">,</span>
	<span class="n">GPIO103_CIF_DD_3</span><span class="p">,</span>
	<span class="n">GPIO95_CIF_DD_4</span><span class="p">,</span>
	<span class="n">GPIO94_CIF_DD_5</span><span class="p">,</span>
	<span class="n">GPIO93_CIF_DD_6</span><span class="p">,</span>
	<span class="n">GPIO108_CIF_DD_7</span><span class="p">,</span>
	<span class="n">GPIO107_CIF_DD_8</span><span class="p">,</span>
	<span class="n">GPIO106_CIF_DD_9</span><span class="p">,</span>
	<span class="n">GPIO42_CIF_MCLK</span><span class="p">,</span>
	<span class="n">GPIO45_CIF_PCLK</span><span class="p">,</span>
	<span class="n">GPIO43_CIF_FV</span><span class="p">,</span>
	<span class="n">GPIO44_CIF_LV</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * CICR4: PCLK_EN:	Pixel clock is supplied by the sensor</span>
<span class="cm"> *	MCLK_EN:	Master clock is generated by PXA</span>
<span class="cm"> *	PCP:		Data sampled on the falling edge of pixel clock</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">pxacamera_platform_data</span> <span class="n">pcm990_pxacamera_platform_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">flags</span>  <span class="o">=</span> <span class="n">PXA_CAMERA_MASTER</span> <span class="o">|</span> <span class="n">PXA_CAMERA_DATAWIDTH_8</span> <span class="o">|</span> <span class="n">PXA_CAMERA_DATAWIDTH_10</span> <span class="o">|</span>
		<span class="n">PXA_CAMERA_PCLK_EN</span> <span class="o">|</span> <span class="n">PXA_CAMERA_MCLK_EN</span><span class="cm">/* | PXA_CAMERA_PCP*/</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mclk_10khz</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#include &lt;linux/i2c/pca953x.h&gt;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pca953x_platform_data</span> <span class="n">pca9536_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">gpio_base</span>	<span class="o">=</span> <span class="n">PXA_NR_BUILTIN_GPIO</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">gpio_bus_switch</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcm990_camera_set_bus_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_camera_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_bus_switch</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">==</span> <span class="n">SOCAM_DATAWIDTH_10</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SOCAM_DATAWIDTH_8</span><span class="p">)</span>
		<span class="n">gpio_set_value_cansleep</span><span class="p">(</span><span class="n">gpio_bus_switch</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">gpio_set_value_cansleep</span><span class="p">(</span><span class="n">gpio_bus_switch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">pcm990_camera_query_bus_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_camera_link</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_bus_switch</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">PXA_NR_BUILTIN_GPIO</span><span class="p">,</span> <span class="s">&quot;camera&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gpio_bus_switch</span> <span class="o">=</span> <span class="n">PXA_NR_BUILTIN_GPIO</span><span class="p">;</span>
			<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">gpio_bus_switch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_bus_switch</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SOCAM_DATAWIDTH_8</span> <span class="o">|</span> <span class="n">SOCAM_DATAWIDTH_10</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">SOCAM_DATAWIDTH_10</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcm990_camera_free_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_camera_link</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_bus_switch</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">gpio_free</span><span class="p">(</span><span class="n">gpio_bus_switch</span><span class="p">);</span>
	<span class="n">gpio_bus_switch</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Board I2C devices. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">__initdata</span> <span class="n">pcm990_i2c_devices</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="cm">/* Must initialize before the camera(s) */</span>
		<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;pca9536&quot;</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">),</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pca9536_data</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">pcm990_camera_i2c</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;mt9v022&quot;</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">),</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;mt9m001&quot;</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">),</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">soc_camera_link</span> <span class="n">iclink</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">bus_id</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="cm">/* Must match with the camera ID */</span>
		<span class="p">.</span><span class="n">board_info</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pcm990_camera_i2c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		<span class="p">.</span><span class="n">i2c_adapter_id</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">query_bus_param</span>	<span class="o">=</span> <span class="n">pcm990_camera_query_bus_param</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_bus_param</span>		<span class="o">=</span> <span class="n">pcm990_camera_set_bus_param</span><span class="p">,</span>
		<span class="p">.</span><span class="n">free_bus</span>		<span class="o">=</span> <span class="n">pcm990_camera_free_bus</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">bus_id</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="cm">/* Must match with the camera ID */</span>
		<span class="p">.</span><span class="n">board_info</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pcm990_camera_i2c</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		<span class="p">.</span><span class="n">i2c_adapter_id</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">query_bus_param</span>	<span class="o">=</span> <span class="n">pcm990_camera_query_bus_param</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_bus_param</span>		<span class="o">=</span> <span class="n">pcm990_camera_set_bus_param</span><span class="p">,</span>
		<span class="p">.</span><span class="n">free_bus</span>		<span class="o">=</span> <span class="n">pcm990_camera_free_bus</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">pcm990_camera</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;soc-camera-pdrv&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dev</span>	<span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iclink</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		<span class="p">},</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;soc-camera-pdrv&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dev</span>	<span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iclink</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		<span class="p">},</span>
	<span class="p">},</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_VIDEO_PXA27x ||CONFIG_VIDEO_PXA27x_MODULE */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * system init for baseboard usage. Will be called by pcm027 init.</span>
<span class="cm"> *</span>
<span class="cm"> * Add platform devices present on this baseboard and init</span>
<span class="cm"> * them from CPU side as far as required to use them later on</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">pcm990_baseboard_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pxa2xx_mfp_config</span><span class="p">(</span><span class="n">ARRAY_AND_SIZE</span><span class="p">(</span><span class="n">pcm990_pin_config</span><span class="p">));</span>

	<span class="n">pcm990_cpld_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">PCM990_CTRL_PHYS</span><span class="p">,</span> <span class="n">PCM990_CTRL_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcm990_cpld_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;pcm990: failed to ioremap cpld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* register CPLD&#39;s IRQ controller */</span>
	<span class="n">pcm990_init_irq</span><span class="p">();</span>

<span class="cp">#ifndef CONFIG_PCM990_DISPLAY_NONE</span>
	<span class="n">pxa_set_fb_info</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm990_fbinfo</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcm990_backlight_device</span><span class="p">);</span>

	<span class="cm">/* MMC */</span>
	<span class="n">pxa_set_mci_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcm990_mci_platform_data</span><span class="p">);</span>

	<span class="cm">/* USB host */</span>
	<span class="n">pxa_set_ohci_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcm990_ohci_platform_data</span><span class="p">);</span>

	<span class="n">pxa_set_i2c_info</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="n">pxa_set_ac97_info</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>

<span class="cp">#if defined(CONFIG_VIDEO_PXA27x) || defined(CONFIG_VIDEO_PXA27x_MODULE)</span>
	<span class="n">pxa2xx_mfp_config</span><span class="p">(</span><span class="n">ARRAY_AND_SIZE</span><span class="p">(</span><span class="n">pcm990_camera_pin_config</span><span class="p">));</span>
	<span class="n">pxa_set_camera_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcm990_pxacamera_platform_data</span><span class="p">);</span>

	<span class="n">i2c_register_board_info</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ARRAY_AND_SIZE</span><span class="p">(</span><span class="n">pcm990_i2c_devices</span><span class="p">));</span>

	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcm990_camera</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcm990_camera</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="cp">#endif</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PCM-990 Evaluation baseboard initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
