<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › mach-pxa › cpufreq-pxa2xx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>cpufreq-pxa2xx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/arch/arm/mach-pxa/cpufreq-pxa2xx.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2002,2003 Intrinsyc Software</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> *</span>
<span class="cm"> * History:</span>
<span class="cm"> *   31-Jul-2002 : Initial version [FB]</span>
<span class="cm"> *   29-Jan-2003 : added PXA255 support [FB]</span>
<span class="cm"> *   20-Apr-2003 : ported to v2.5 (Dustin McIntire, Sensoria Corp.)</span>
<span class="cm"> *</span>
<span class="cm"> * Note:</span>
<span class="cm"> *   This driver may change the memory bus clock rate, but will not do any</span>
<span class="cm"> *   platform specific access timing changes... for example if you have flash</span>
<span class="cm"> *   memory connected to CS0, you will need to register a platform specific</span>
<span class="cm"> *   notifier which will adjust the memory access strobes to maintain a</span>
<span class="cm"> *   minimum strobe width.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/cpufreq.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/consumer.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>

<span class="cp">#include &lt;mach/pxa2xx-regs.h&gt;</span>
<span class="cp">#include &lt;mach/smemc.h&gt;</span>

<span class="cp">#ifdef DEBUG</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq_debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">freq_debug</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">freq_debug</span><span class="p">,</span> <span class="s">&quot;Set the debug messages to on=1/off=0&quot;</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="cp">#define freq_debug  0</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">vcc_core</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pxa27x_maxfreq</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">pxa27x_maxfreq</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">pxa27x_maxfreq</span><span class="p">,</span> <span class="s">&quot;Set the pxa27x maxfreq in MHz&quot;</span>
		 <span class="s">&quot;(typically 624=&gt;pxa270, 416=&gt;pxa271, 520=&gt;pxa272)&quot;</span><span class="p">);</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">khz</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">membus</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cccr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">div2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cclkcfg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vmin</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vmax</span><span class="p">;</span>
<span class="p">}</span> <span class="n">pxa_freqs_t</span><span class="p">;</span>

<span class="cm">/* Define the refresh period in mSec for the SDRAM and the number of rows */</span>
<span class="cp">#define SDRAM_TREF	64	</span><span class="cm">/* standard 64ms SDRAM */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sdram_rows</span><span class="p">;</span>

<span class="cp">#define CCLKCFG_TURBO		0x1</span>
<span class="cp">#define CCLKCFG_FCS		0x2</span>
<span class="cp">#define CCLKCFG_HALFTURBO	0x4</span>
<span class="cp">#define CCLKCFG_FASTBUS		0x8</span>
<span class="cp">#define MDREFR_DB2_MASK		(MDREFR_K2DB2 | MDREFR_K1DB2)</span>
<span class="cp">#define MDREFR_DRI_MASK		0xFFF</span>

<span class="cp">#define MDCNFG_DRAC2(mdcnfg) (((mdcnfg) &gt;&gt; 21) &amp; 0x3)</span>
<span class="cp">#define MDCNFG_DRAC0(mdcnfg) (((mdcnfg) &gt;&gt; 5) &amp; 0x3)</span>

<span class="cm">/*</span>
<span class="cm"> * PXA255 definitions</span>
<span class="cm"> */</span>
<span class="cm">/* Use the run mode frequencies for the CPUFREQ_POLICY_PERFORMANCE policy */</span>
<span class="cp">#define CCLKCFG			CCLKCFG_TURBO | CCLKCFG_FCS</span>

<span class="k">static</span> <span class="n">pxa_freqs_t</span> <span class="n">pxa255_run_freqs</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="cm">/* CPU   MEMBUS  CCCR  DIV2 CCLKCFG	           run  turbo PXbus SDRAM */</span>
	<span class="p">{</span> <span class="mi">99500</span><span class="p">,</span>  <span class="mi">99500</span><span class="p">,</span> <span class="mh">0x121</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="n">CCLKCFG</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>	<span class="cm">/*  99,   99,   50,   50  */</span>
	<span class="p">{</span><span class="mi">132700</span><span class="p">,</span> <span class="mi">132700</span><span class="p">,</span> <span class="mh">0x123</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="n">CCLKCFG</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>	<span class="cm">/* 133,  133,   66,   66  */</span>
	<span class="p">{</span><span class="mi">199100</span><span class="p">,</span>  <span class="mi">99500</span><span class="p">,</span> <span class="mh">0x141</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="n">CCLKCFG</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>	<span class="cm">/* 199,  199,   99,   99  */</span>
	<span class="p">{</span><span class="mi">265400</span><span class="p">,</span> <span class="mi">132700</span><span class="p">,</span> <span class="mh">0x143</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="n">CCLKCFG</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>	<span class="cm">/* 265,  265,  133,   66  */</span>
	<span class="p">{</span><span class="mi">331800</span><span class="p">,</span> <span class="mi">165900</span><span class="p">,</span> <span class="mh">0x145</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="n">CCLKCFG</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>	<span class="cm">/* 331,  331,  166,   83  */</span>
	<span class="p">{</span><span class="mi">398100</span><span class="p">,</span>  <span class="mi">99500</span><span class="p">,</span> <span class="mh">0x161</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="n">CCLKCFG</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>	<span class="cm">/* 398,  398,  196,   99  */</span>
<span class="p">};</span>

<span class="cm">/* Use the turbo mode frequencies for the CPUFREQ_POLICY_POWERSAVE policy */</span>
<span class="k">static</span> <span class="n">pxa_freqs_t</span> <span class="n">pxa255_turbo_freqs</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="cm">/* CPU   MEMBUS  CCCR  DIV2 CCLKCFG	   run  turbo PXbus SDRAM */</span>
	<span class="p">{</span> <span class="mi">99500</span><span class="p">,</span> <span class="mi">99500</span><span class="p">,</span>  <span class="mh">0x121</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="n">CCLKCFG</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>	<span class="cm">/*  99,   99,   50,   50  */</span>
	<span class="p">{</span><span class="mi">199100</span><span class="p">,</span> <span class="mi">99500</span><span class="p">,</span>  <span class="mh">0x221</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="n">CCLKCFG</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>	<span class="cm">/*  99,  199,   50,   99  */</span>
	<span class="p">{</span><span class="mi">298500</span><span class="p">,</span> <span class="mi">99500</span><span class="p">,</span>  <span class="mh">0x321</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="n">CCLKCFG</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>	<span class="cm">/*  99,  287,   50,   99  */</span>
	<span class="p">{</span><span class="mi">298600</span><span class="p">,</span> <span class="mi">99500</span><span class="p">,</span>  <span class="mh">0x1c1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="n">CCLKCFG</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>	<span class="cm">/* 199,  287,   99,   99  */</span>
	<span class="p">{</span><span class="mi">398100</span><span class="p">,</span> <span class="mi">99500</span><span class="p">,</span>  <span class="mh">0x241</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="n">CCLKCFG</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>	<span class="cm">/* 199,  398,   99,   99  */</span>
<span class="p">};</span>

<span class="cp">#define NUM_PXA25x_RUN_FREQS ARRAY_SIZE(pxa255_run_freqs)</span>
<span class="cp">#define NUM_PXA25x_TURBO_FREQS ARRAY_SIZE(pxa255_turbo_freqs)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cpufreq_frequency_table</span>
	<span class="n">pxa255_run_freq_table</span><span class="p">[</span><span class="n">NUM_PXA25x_RUN_FREQS</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">cpufreq_frequency_table</span>
	<span class="n">pxa255_turbo_freq_table</span><span class="p">[</span><span class="n">NUM_PXA25x_TURBO_FREQS</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pxa255_turbo_table</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">pxa255_turbo_table</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">pxa255_turbo_table</span><span class="p">,</span> <span class="s">&quot;Selects the frequency table (0 = run table, !0 = turbo table)&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * PXA270 definitions</span>
<span class="cm"> *</span>
<span class="cm"> * For the PXA27x:</span>
<span class="cm"> * Control variables are A, L, 2N for CCCR; B, HT, T for CLKCFG.</span>
<span class="cm"> *</span>
<span class="cm"> * A = 0 =&gt; memory controller clock from table 3-7,</span>
<span class="cm"> * A = 1 =&gt; memory controller clock = system bus clock</span>
<span class="cm"> * Run mode frequency	= 13 MHz * L</span>
<span class="cm"> * Turbo mode frequency = 13 MHz * L * N</span>
<span class="cm"> * System bus frequency = 13 MHz * L / (B + 1)</span>
<span class="cm"> *</span>
<span class="cm"> * In CCCR:</span>
<span class="cm"> * A = 1</span>
<span class="cm"> * L = 16	  oscillator to run mode ratio</span>
<span class="cm"> * 2N = 6	  2 * (turbo mode to run mode ratio)</span>
<span class="cm"> *</span>
<span class="cm"> * In CCLKCFG:</span>
<span class="cm"> * B = 1	  Fast bus mode</span>
<span class="cm"> * HT = 0	  Half-Turbo mode</span>
<span class="cm"> * T = 1	  Turbo mode</span>
<span class="cm"> *</span>
<span class="cm"> * For now, just support some of the combinations in table 3-7 of</span>
<span class="cm"> * PXA27x Processor Family Developer&#39;s Manual to simplify frequency</span>
<span class="cm"> * change sequences.</span>
<span class="cm"> */</span>
<span class="cp">#define PXA27x_CCCR(A, L, N2) (A &lt;&lt; 25 | N2 &lt;&lt; 7 | L)</span>
<span class="cp">#define CCLKCFG2(B, HT, T) \</span>
<span class="cp">  (CCLKCFG_FCS | \</span>
<span class="cp">   ((B)  ? CCLKCFG_FASTBUS : 0) | \</span>
<span class="cp">   ((HT) ? CCLKCFG_HALFTURBO : 0) | \</span>
<span class="cp">   ((T)  ? CCLKCFG_TURBO : 0))</span>

<span class="k">static</span> <span class="n">pxa_freqs_t</span> <span class="n">pxa27x_freqs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mi">104000</span><span class="p">,</span> <span class="mi">104000</span><span class="p">,</span> <span class="n">PXA27x_CCCR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>	 <span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CCLKCFG2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>  <span class="mi">900000</span><span class="p">,</span> <span class="mi">1705000</span> <span class="p">},</span>
	<span class="p">{</span><span class="mi">156000</span><span class="p">,</span> <span class="mi">104000</span><span class="p">,</span> <span class="n">PXA27x_CCCR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>	 <span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CCLKCFG2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1000000</span><span class="p">,</span> <span class="mi">1705000</span> <span class="p">},</span>
	<span class="p">{</span><span class="mi">208000</span><span class="p">,</span> <span class="mi">208000</span><span class="p">,</span> <span class="n">PXA27x_CCCR</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">CCLKCFG2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1180000</span><span class="p">,</span> <span class="mi">1705000</span> <span class="p">},</span>
	<span class="p">{</span><span class="mi">312000</span><span class="p">,</span> <span class="mi">208000</span><span class="p">,</span> <span class="n">PXA27x_CCCR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">CCLKCFG2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1250000</span><span class="p">,</span> <span class="mi">1705000</span> <span class="p">},</span>
	<span class="p">{</span><span class="mi">416000</span><span class="p">,</span> <span class="mi">208000</span><span class="p">,</span> <span class="n">PXA27x_CCCR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">CCLKCFG2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1350000</span><span class="p">,</span> <span class="mi">1705000</span> <span class="p">},</span>
	<span class="p">{</span><span class="mi">520000</span><span class="p">,</span> <span class="mi">208000</span><span class="p">,</span> <span class="n">PXA27x_CCCR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">CCLKCFG2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1450000</span><span class="p">,</span> <span class="mi">1705000</span> <span class="p">},</span>
	<span class="p">{</span><span class="mi">624000</span><span class="p">,</span> <span class="mi">208000</span><span class="p">,</span> <span class="n">PXA27x_CCCR</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">CCLKCFG2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1550000</span><span class="p">,</span> <span class="mi">1705000</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cp">#define NUM_PXA27x_FREQS ARRAY_SIZE(pxa27x_freqs)</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">cpufreq_frequency_table</span>
	<span class="n">pxa27x_freq_table</span><span class="p">[</span><span class="n">NUM_PXA27x_FREQS</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>

<span class="k">extern</span> <span class="kt">unsigned</span> <span class="n">get_clk_frequency_khz</span><span class="p">(</span><span class="kt">int</span> <span class="n">info</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_REGULATOR</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxa_cpufreq_change_voltage</span><span class="p">(</span><span class="n">pxa_freqs_t</span> <span class="o">*</span><span class="n">pxa_freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_is_pxa27x</span><span class="p">())</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">vmin</span> <span class="o">=</span> <span class="n">pxa_freq</span><span class="o">-&gt;</span><span class="n">vmin</span><span class="p">;</span>
	<span class="n">vmax</span> <span class="o">=</span> <span class="n">pxa_freq</span><span class="o">-&gt;</span><span class="n">vmax</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">vmin</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">vmax</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_set_voltage</span><span class="p">(</span><span class="n">vcc_core</span><span class="p">,</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;cpufreq: Failed to set vcc_core in [%dmV..%dmV]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">void</span> <span class="nf">pxa_cpufreq_init_voltages</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vcc_core</span> <span class="o">=</span> <span class="n">regulator_get</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;vcc_core&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">vcc_core</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;cpufreq: Didn&#39;t find vcc_core regulator</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">vcc_core</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;cpufreq: Found vcc_core regulator</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxa_cpufreq_change_voltage</span><span class="p">(</span><span class="n">pxa_freqs_t</span> <span class="o">*</span><span class="n">pxa_freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">void</span> <span class="nf">pxa_cpufreq_init_voltages</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">find_freq_tables</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_frequency_table</span> <span class="o">**</span><span class="n">freq_table</span><span class="p">,</span>
			     <span class="n">pxa_freqs_t</span> <span class="o">**</span><span class="n">pxa_freqs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_pxa25x</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pxa255_turbo_table</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">pxa_freqs</span> <span class="o">=</span> <span class="n">pxa255_run_freqs</span><span class="p">;</span>
			<span class="o">*</span><span class="n">freq_table</span> <span class="o">=</span> <span class="n">pxa255_run_freq_table</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">pxa_freqs</span> <span class="o">=</span> <span class="n">pxa255_turbo_freqs</span><span class="p">;</span>
			<span class="o">*</span><span class="n">freq_table</span> <span class="o">=</span> <span class="n">pxa255_turbo_freq_table</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_pxa27x</span><span class="p">())</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">pxa_freqs</span> <span class="o">=</span> <span class="n">pxa27x_freqs</span><span class="p">;</span>
		<span class="o">*</span><span class="n">freq_table</span> <span class="o">=</span> <span class="n">pxa27x_freq_table</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pxa27x_guess_max_freq</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pxa27x_maxfreq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pxa27x_maxfreq</span> <span class="o">=</span> <span class="mi">416000</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PXA CPU 27x max frequency not defined &quot;</span>
		       <span class="s">&quot;(pxa27x_maxfreq), assuming pxa271 with %dkHz maxfreq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pxa27x_maxfreq</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pxa27x_maxfreq</span> <span class="o">*=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_sdram_rows</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">mdcnfg</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">MDCNFG</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">drac2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">drac0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdcnfg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MDCNFG_DE2</span> <span class="o">|</span> <span class="n">MDCNFG_DE3</span><span class="p">))</span>
		<span class="n">drac2</span> <span class="o">=</span> <span class="n">MDCNFG_DRAC2</span><span class="p">(</span><span class="n">mdcnfg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdcnfg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MDCNFG_DE0</span> <span class="o">|</span> <span class="n">MDCNFG_DE1</span><span class="p">))</span>
		<span class="n">drac0</span> <span class="o">=</span> <span class="n">MDCNFG_DRAC0</span><span class="p">(</span><span class="n">mdcnfg</span><span class="p">);</span>

	<span class="n">sdram_rows</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">11</span> <span class="o">+</span> <span class="n">max</span><span class="p">(</span><span class="n">drac0</span><span class="p">,</span> <span class="n">drac2</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">mdrefr_dri</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">interval</span> <span class="o">=</span> <span class="n">freq</span> <span class="o">*</span> <span class="n">SDRAM_TREF</span> <span class="o">/</span> <span class="n">sdram_rows</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">interval</span> <span class="o">-</span> <span class="p">(</span><span class="n">cpu_is_pxa27x</span><span class="p">()</span> <span class="o">?</span> <span class="mi">31</span> <span class="o">:</span> <span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="mi">32</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* find a valid frequency point */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxa_verify_policy</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpufreq_frequency_table</span> <span class="o">*</span><span class="n">pxa_freqs_table</span><span class="p">;</span>
	<span class="n">pxa_freqs_t</span> <span class="o">*</span><span class="n">pxa_freqs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">find_freq_tables</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pxa_freqs_table</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pxa_freqs</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cpufreq_frequency_table_verify</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="n">pxa_freqs_table</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">freq_debug</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Verified CPU policy: %dKhz min to %dKhz max</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">policy</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">,</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">pxa_cpufreq_get</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">get_clk_frequency_khz</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxa_set_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">target_freq</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">relation</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpufreq_frequency_table</span> <span class="o">*</span><span class="n">pxa_freqs_table</span><span class="p">;</span>
	<span class="n">pxa_freqs_t</span> <span class="o">*</span><span class="n">pxa_freq_settings</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpufreq_freqs</span> <span class="n">freqs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_freq_cpu</span><span class="p">,</span> <span class="n">new_freq_mem</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">unused</span><span class="p">,</span> <span class="n">preset_mdrefr</span><span class="p">,</span> <span class="n">postset_mdrefr</span><span class="p">,</span> <span class="n">cclkcfg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Get the current policy */</span>
	<span class="n">find_freq_tables</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pxa_freqs_table</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pxa_freq_settings</span><span class="p">);</span>

	<span class="cm">/* Lookup the next frequency */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpufreq_frequency_table_target</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="n">pxa_freqs_table</span><span class="p">,</span>
					   <span class="n">target_freq</span><span class="p">,</span> <span class="n">relation</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idx</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">new_freq_cpu</span> <span class="o">=</span> <span class="n">pxa_freq_settings</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">khz</span><span class="p">;</span>
	<span class="n">new_freq_mem</span> <span class="o">=</span> <span class="n">pxa_freq_settings</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">membus</span><span class="p">;</span>
	<span class="n">freqs</span><span class="p">.</span><span class="n">old</span> <span class="o">=</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">;</span>
	<span class="n">freqs</span><span class="p">.</span><span class="n">new</span> <span class="o">=</span> <span class="n">new_freq_cpu</span><span class="p">;</span>
	<span class="n">freqs</span><span class="p">.</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">freq_debug</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Changing CPU frequency to %d Mhz, (SDRAM %d Mhz)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">freqs</span><span class="p">.</span><span class="n">new</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="p">(</span><span class="n">pxa_freq_settings</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">div2</span><span class="p">)</span> <span class="o">?</span>
			 <span class="p">(</span><span class="n">new_freq_mem</span> <span class="o">/</span> <span class="mi">2000</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">new_freq_mem</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcc_core</span> <span class="o">&amp;&amp;</span> <span class="n">freqs</span><span class="p">.</span><span class="n">new</span> <span class="o">&gt;</span> <span class="n">freqs</span><span class="p">.</span><span class="n">old</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pxa_cpufreq_change_voltage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pxa_freq_settings</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Tell everyone what we&#39;re about to do...</span>
<span class="cm">	 * you should add a notify client with any platform specific</span>
<span class="cm">	 * Vcc changing capability</span>
<span class="cm">	 */</span>
	<span class="n">cpufreq_notify_transition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">freqs</span><span class="p">,</span> <span class="n">CPUFREQ_PRECHANGE</span><span class="p">);</span>

	<span class="cm">/* Calculate the next MDREFR.  If we&#39;re slowing down the SDRAM clock</span>
<span class="cm">	 * we need to preset the smaller DRI before the change.	 If we&#39;re</span>
<span class="cm">	 * speeding up we need to set the larger DRI value after the change.</span>
<span class="cm">	 */</span>
	<span class="n">preset_mdrefr</span> <span class="o">=</span> <span class="n">postset_mdrefr</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">MDREFR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">preset_mdrefr</span> <span class="o">&amp;</span> <span class="n">MDREFR_DRI_MASK</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">mdrefr_dri</span><span class="p">(</span><span class="n">new_freq_mem</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">preset_mdrefr</span> <span class="o">=</span> <span class="p">(</span><span class="n">preset_mdrefr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MDREFR_DRI_MASK</span><span class="p">);</span>
		<span class="n">preset_mdrefr</span> <span class="o">|=</span> <span class="n">mdrefr_dri</span><span class="p">(</span><span class="n">new_freq_mem</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">postset_mdrefr</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">postset_mdrefr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MDREFR_DRI_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">mdrefr_dri</span><span class="p">(</span><span class="n">new_freq_mem</span><span class="p">);</span>

	<span class="cm">/* If we&#39;re dividing the memory clock by two for the SDRAM clock, this</span>
<span class="cm">	 * must be set prior to the change.  Clearing the divide must be done</span>
<span class="cm">	 * after the change.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pxa_freq_settings</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">div2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">preset_mdrefr</span>  <span class="o">|=</span> <span class="n">MDREFR_DB2_MASK</span><span class="p">;</span>
		<span class="n">postset_mdrefr</span> <span class="o">|=</span> <span class="n">MDREFR_DB2_MASK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">postset_mdrefr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MDREFR_DB2_MASK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Set new the CCCR and prepare CCLKCFG */</span>
	<span class="n">CCCR</span> <span class="o">=</span> <span class="n">pxa_freq_settings</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">cccr</span><span class="p">;</span>
	<span class="n">cclkcfg</span> <span class="o">=</span> <span class="n">pxa_freq_settings</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">cclkcfg</span><span class="p">;</span>

	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;							</span><span class="se">\n</span><span class="s">\</span>
<span class="s">		ldr	r4, [%1]		/* load MDREFR */	</span><span class="se">\n</span><span class="s">\</span>
<span class="s">		b	2f						</span><span class="se">\n</span><span class="s">\</span>
<span class="s">		.align	5						</span><span class="se">\n</span><span class="s">\</span>
<span class="s">1:									</span><span class="se">\n</span><span class="s">\</span>
<span class="s">		str	%3, [%1]		/* preset the MDREFR */	</span><span class="se">\n</span><span class="s">\</span>
<span class="s">		mcr	p14, 0, %2, c6, c0, 0	/* set CCLKCFG[FCS] */	</span><span class="se">\n</span><span class="s">\</span>
<span class="s">		str	%4, [%1]		/* postset the MDREFR */ </span><span class="se">\n</span><span class="s">\</span>
<span class="s">									</span><span class="se">\n</span><span class="s">\</span>
<span class="s">		b	3f						</span><span class="se">\n</span><span class="s">\</span>
<span class="s">2:		b	1b						</span><span class="se">\n</span><span class="s">\</span>
<span class="s">3:		nop							</span><span class="se">\n</span><span class="s">\</span>
<span class="s">	  &quot;</span>
		     <span class="o">:</span> <span class="s">&quot;=&amp;r&quot;</span> <span class="p">(</span><span class="n">unused</span><span class="p">)</span>
		     <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">MDREFR</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">cclkcfg</span><span class="p">),</span>
		       <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">preset_mdrefr</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">postset_mdrefr</span><span class="p">)</span>
		     <span class="o">:</span> <span class="s">&quot;r4&quot;</span><span class="p">,</span> <span class="s">&quot;r5&quot;</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Tell everyone what we&#39;ve just done...</span>
<span class="cm">	 * you should add a notify client with any platform specific</span>
<span class="cm">	 * SDRAM refresh timer adjustments</span>
<span class="cm">	 */</span>
	<span class="n">cpufreq_notify_transition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">freqs</span><span class="p">,</span> <span class="n">CPUFREQ_POSTCHANGE</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Even if voltage setting fails, we don&#39;t report it, as the frequency</span>
<span class="cm">	 * change succeeded. The voltage reduction is not a critical failure,</span>
<span class="cm">	 * only power savings will suffer from this.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Note: if the voltage change fails, and a return value is returned, a</span>
<span class="cm">	 * bug is triggered (seems a deadlock). Should anybody find out where,</span>
<span class="cm">	 * the &quot;return 0&quot; should become a &quot;return ret&quot;.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcc_core</span> <span class="o">&amp;&amp;</span> <span class="n">freqs</span><span class="p">.</span><span class="n">new</span> <span class="o">&lt;</span> <span class="n">freqs</span><span class="p">.</span><span class="n">old</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pxa_cpufreq_change_voltage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pxa_freq_settings</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pxa_cpufreq_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpufreq_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpufreq_frequency_table</span> <span class="o">*</span><span class="n">pxa255_freq_table</span><span class="p">;</span>
	<span class="n">pxa_freqs_t</span> <span class="o">*</span><span class="n">pxa255_freqs</span><span class="p">;</span>

	<span class="cm">/* try to guess pxa27x cpu */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_pxa27x</span><span class="p">())</span>
		<span class="n">pxa27x_guess_max_freq</span><span class="p">();</span>

	<span class="n">pxa_cpufreq_init_voltages</span><span class="p">();</span>

	<span class="n">init_sdram_rows</span><span class="p">();</span>

	<span class="cm">/* set default policy and cpuinfo */</span>
	<span class="n">policy</span><span class="o">-&gt;</span><span class="n">cpuinfo</span><span class="p">.</span><span class="n">transition_latency</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span> <span class="cm">/* FIXME: 1 ms, assumed */</span>
	<span class="n">policy</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">=</span> <span class="n">get_clk_frequency_khz</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>	   <span class="cm">/* current freq */</span>
	<span class="n">policy</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">=</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">=</span> <span class="n">policy</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">;</span>

	<span class="cm">/* Generate pxa25x the run cpufreq_frequency_table struct */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_PXA25x_RUN_FREQS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pxa255_run_freq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">pxa255_run_freqs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">khz</span><span class="p">;</span>
		<span class="n">pxa255_run_freq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pxa255_run_freq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">CPUFREQ_TABLE_END</span><span class="p">;</span>

	<span class="cm">/* Generate pxa25x the turbo cpufreq_frequency_table struct */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_PXA25x_TURBO_FREQS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pxa255_turbo_freq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frequency</span> <span class="o">=</span>
			<span class="n">pxa255_turbo_freqs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">khz</span><span class="p">;</span>
		<span class="n">pxa255_turbo_freq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pxa255_turbo_freq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">CPUFREQ_TABLE_END</span><span class="p">;</span>

	<span class="n">pxa255_turbo_table</span> <span class="o">=</span> <span class="o">!!</span><span class="n">pxa255_turbo_table</span><span class="p">;</span>

	<span class="cm">/* Generate the pxa27x cpufreq_frequency_table struct */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_PXA27x_FREQS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="n">pxa27x_freqs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">khz</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&gt;</span> <span class="n">pxa27x_maxfreq</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">pxa27x_freq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>
		<span class="n">pxa27x_freq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pxa27x_freq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">pxa27x_freq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">CPUFREQ_TABLE_END</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set the policy&#39;s minimum and maximum frequencies from the tables</span>
<span class="cm">	 * just constructed.  This sets cpuinfo.mxx_freq, min and max.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_pxa25x</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">find_freq_tables</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pxa255_freq_table</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pxa255_freqs</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;PXA255 cpufreq using %s frequency table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pxa255_turbo_table</span> <span class="o">?</span> <span class="s">&quot;turbo&quot;</span> <span class="o">:</span> <span class="s">&quot;run&quot;</span><span class="p">);</span>
		<span class="n">cpufreq_frequency_table_cpuinfo</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="n">pxa255_freq_table</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_pxa27x</span><span class="p">())</span>
		<span class="n">cpufreq_frequency_table_cpuinfo</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="n">pxa27x_freq_table</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PXA CPU frequency change support initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cpufreq_driver</span> <span class="n">pxa_cpufreq_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">verify</span>	<span class="o">=</span> <span class="n">pxa_verify_policy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">target</span>	<span class="o">=</span> <span class="n">pxa_set_target</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span>	<span class="o">=</span> <span class="n">pxa_cpufreq_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span>	<span class="o">=</span> <span class="n">pxa_cpufreq_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;PXA2xx&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pxa_cpu_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_pxa25x</span><span class="p">()</span> <span class="o">||</span> <span class="n">cpu_is_pxa27x</span><span class="p">())</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cpufreq_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pxa_cpufreq_driver</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">pxa_cpu_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cpufreq_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pxa_cpufreq_driver</span><span class="p">);</span>
<span class="p">}</span>


<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Intrinsyc Software Inc.&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;CPU frequency changing driver for the PXA architecture&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">pxa_cpu_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">pxa_cpu_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
