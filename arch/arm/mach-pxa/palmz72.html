<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › mach-pxa › palmz72.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>palmz72.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Hardware definitions for Palm Zire72</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *	Vladimir &quot;Farcaller&quot; Pouzanov &lt;farcaller@gmail.com&gt;</span>
<span class="cm"> *	Sergey Lapin &lt;slapin@ossfans.org&gt;</span>
<span class="cm"> *	Alex Osborne &lt;bobofdoom@gmail.com&gt;</span>
<span class="cm"> *	Jan Herman &lt;2hp@seznam.cz&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Rewrite for mainline:</span>
<span class="cm"> *	Marek Vasut &lt;marek.vasut@gmail.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * (find more info at www.hackndev.com)</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/syscore_ops.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/gpio_keys.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/pda_power.h&gt;</span>
<span class="cp">#include &lt;linux/pwm_backlight.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/wm97xx.h&gt;</span>
<span class="cp">#include &lt;linux/power_supply.h&gt;</span>
<span class="cp">#include &lt;linux/usb/gpio_vbus.h&gt;</span>
<span class="cp">#include &lt;linux/i2c-gpio.h&gt;</span>

<span class="cp">#include &lt;asm/mach-types.h&gt;</span>
<span class="cp">#include &lt;asm/suspend.h&gt;</span>
<span class="cp">#include &lt;asm/mach/arch.h&gt;</span>
<span class="cp">#include &lt;asm/mach/map.h&gt;</span>

<span class="cp">#include &lt;mach/pxa27x.h&gt;</span>
<span class="cp">#include &lt;mach/audio.h&gt;</span>
<span class="cp">#include &lt;mach/palmz72.h&gt;</span>
<span class="cp">#include &lt;mach/mmc.h&gt;</span>
<span class="cp">#include &lt;mach/pxafb.h&gt;</span>
<span class="cp">#include &lt;mach/irda.h&gt;</span>
<span class="cp">#include &lt;plat/pxa27x_keypad.h&gt;</span>
<span class="cp">#include &lt;mach/udc.h&gt;</span>
<span class="cp">#include &lt;mach/palmasoc.h&gt;</span>
<span class="cp">#include &lt;mach/palm27x.h&gt;</span>

<span class="cp">#include &lt;mach/pm.h&gt;</span>
<span class="cp">#include &lt;mach/camera.h&gt;</span>

<span class="cp">#include &lt;media/soc_camera.h&gt;</span>

<span class="cp">#include &quot;generic.h&quot;</span>
<span class="cp">#include &quot;devices.h&quot;</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> * Pin configuration</span>
<span class="cm"> ******************************************************************************/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">palmz72_pin_config</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* MMC */</span>
	<span class="n">GPIO32_MMC_CLK</span><span class="p">,</span>
	<span class="n">GPIO92_MMC_DAT_0</span><span class="p">,</span>
	<span class="n">GPIO109_MMC_DAT_1</span><span class="p">,</span>
	<span class="n">GPIO110_MMC_DAT_2</span><span class="p">,</span>
	<span class="n">GPIO111_MMC_DAT_3</span><span class="p">,</span>
	<span class="n">GPIO112_MMC_CMD</span><span class="p">,</span>
	<span class="n">GPIO14_GPIO</span><span class="p">,</span>	<span class="cm">/* SD detect */</span>
	<span class="n">GPIO115_GPIO</span><span class="p">,</span>	<span class="cm">/* SD RO */</span>
	<span class="n">GPIO98_GPIO</span><span class="p">,</span>	<span class="cm">/* SD power */</span>

	<span class="cm">/* AC97 */</span>
	<span class="n">GPIO28_AC97_BITCLK</span><span class="p">,</span>
	<span class="n">GPIO29_AC97_SDATA_IN_0</span><span class="p">,</span>
	<span class="n">GPIO30_AC97_SDATA_OUT</span><span class="p">,</span>
	<span class="n">GPIO31_AC97_SYNC</span><span class="p">,</span>
	<span class="n">GPIO89_AC97_SYSCLK</span><span class="p">,</span>
	<span class="n">GPIO113_AC97_nRESET</span><span class="p">,</span>

	<span class="cm">/* IrDA */</span>
	<span class="n">GPIO49_GPIO</span><span class="p">,</span>	<span class="cm">/* ir disable */</span>
	<span class="n">GPIO46_FICP_RXD</span><span class="p">,</span>
	<span class="n">GPIO47_FICP_TXD</span><span class="p">,</span>

	<span class="cm">/* PWM */</span>
	<span class="n">GPIO16_PWM0_OUT</span><span class="p">,</span>

	<span class="cm">/* USB */</span>
	<span class="n">GPIO15_GPIO</span><span class="p">,</span>	<span class="cm">/* usb detect */</span>
	<span class="n">GPIO95_GPIO</span><span class="p">,</span>	<span class="cm">/* usb pullup */</span>

	<span class="cm">/* Matrix keypad */</span>
	<span class="n">GPIO100_KP_MKIN_0</span>	<span class="o">|</span> <span class="n">WAKEUP_ON_LEVEL_HIGH</span><span class="p">,</span>
	<span class="n">GPIO101_KP_MKIN_1</span>	<span class="o">|</span> <span class="n">WAKEUP_ON_LEVEL_HIGH</span><span class="p">,</span>
	<span class="n">GPIO102_KP_MKIN_2</span>	<span class="o">|</span> <span class="n">WAKEUP_ON_LEVEL_HIGH</span><span class="p">,</span>
	<span class="n">GPIO97_KP_MKIN_3</span>	<span class="o">|</span> <span class="n">WAKEUP_ON_LEVEL_HIGH</span><span class="p">,</span>
	<span class="n">GPIO103_KP_MKOUT_0</span><span class="p">,</span>
	<span class="n">GPIO104_KP_MKOUT_1</span><span class="p">,</span>
	<span class="n">GPIO105_KP_MKOUT_2</span><span class="p">,</span>

	<span class="cm">/* LCD */</span>
	<span class="n">GPIOxx_LCD_TFT_16BPP</span><span class="p">,</span>

	<span class="n">GPIO20_GPIO</span><span class="p">,</span>	<span class="cm">/* bl power */</span>
	<span class="n">GPIO21_GPIO</span><span class="p">,</span>	<span class="cm">/* LCD border switch */</span>
	<span class="n">GPIO22_GPIO</span><span class="p">,</span>	<span class="cm">/* LCD border color */</span>
	<span class="n">GPIO96_GPIO</span><span class="p">,</span>	<span class="cm">/* lcd power */</span>

	<span class="cm">/* PXA Camera */</span>
	<span class="n">GPIO81_CIF_DD_0</span><span class="p">,</span>
	<span class="n">GPIO48_CIF_DD_5</span><span class="p">,</span>
	<span class="n">GPIO50_CIF_DD_3</span><span class="p">,</span>
	<span class="n">GPIO51_CIF_DD_2</span><span class="p">,</span>
	<span class="n">GPIO52_CIF_DD_4</span><span class="p">,</span>
	<span class="n">GPIO53_CIF_MCLK</span><span class="p">,</span>
	<span class="n">GPIO54_CIF_PCLK</span><span class="p">,</span>
	<span class="n">GPIO55_CIF_DD_1</span><span class="p">,</span>
	<span class="n">GPIO84_CIF_FV</span><span class="p">,</span>
	<span class="n">GPIO85_CIF_LV</span><span class="p">,</span>
	<span class="n">GPIO93_CIF_DD_6</span><span class="p">,</span>
	<span class="n">GPIO108_CIF_DD_7</span><span class="p">,</span>

	<span class="n">GPIO56_GPIO</span><span class="p">,</span>	<span class="cm">/* OV9640 Powerdown */</span>
	<span class="n">GPIO57_GPIO</span><span class="p">,</span>	<span class="cm">/* OV9640 Reset */</span>
	<span class="n">GPIO91_GPIO</span><span class="p">,</span>	<span class="cm">/* OV9640 Power */</span>

	<span class="cm">/* I2C */</span>
	<span class="n">GPIO117_GPIO</span><span class="p">,</span>	<span class="cm">/* I2C_SCL */</span>
	<span class="n">GPIO118_GPIO</span><span class="p">,</span>	<span class="cm">/* I2C_SDA */</span>

	<span class="cm">/* Misc. */</span>
	<span class="n">GPIO0_GPIO</span>	<span class="o">|</span> <span class="n">WAKEUP_ON_LEVEL_HIGH</span><span class="p">,</span>	<span class="cm">/* power detect */</span>
	<span class="n">GPIO88_GPIO</span><span class="p">,</span>				<span class="cm">/* green led */</span>
	<span class="n">GPIO27_GPIO</span><span class="p">,</span>				<span class="cm">/* WM9712 IRQ */</span>
<span class="p">};</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> * GPIO keyboard</span>
<span class="cm"> ******************************************************************************/</span>
<span class="cp">#if defined(CONFIG_KEYBOARD_PXA27x) || defined(CONFIG_KEYBOARD_PXA27x_MODULE)</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">palmz72_matrix_keys</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">KEY</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KEY_POWER</span><span class="p">),</span>
	<span class="n">KEY</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">KEY_F1</span><span class="p">),</span>
	<span class="n">KEY</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">KEY_ENTER</span><span class="p">),</span>

	<span class="n">KEY</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KEY_F2</span><span class="p">),</span>
	<span class="n">KEY</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">KEY_F3</span><span class="p">),</span>
	<span class="n">KEY</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">KEY_F4</span><span class="p">),</span>

	<span class="n">KEY</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KEY_UP</span><span class="p">),</span>
	<span class="n">KEY</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">KEY_DOWN</span><span class="p">),</span>

	<span class="n">KEY</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">KEY_RIGHT</span><span class="p">),</span>
	<span class="n">KEY</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">KEY_LEFT</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pxa27x_keypad_platform_data</span> <span class="n">palmz72_keypad_platform_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">matrix_key_rows</span>	<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">matrix_key_cols</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">matrix_key_map</span>		<span class="o">=</span> <span class="n">palmz72_matrix_keys</span><span class="p">,</span>
	<span class="p">.</span><span class="n">matrix_key_map_size</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">palmz72_matrix_keys</span><span class="p">),</span>

	<span class="p">.</span><span class="n">debounce_interval</span>	<span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">palmz72_kpc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pxa_set_keypad_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">palmz72_keypad_platform_data</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">palmz72_kpc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> * LEDs</span>
<span class="cm"> ******************************************************************************/</span>
<span class="cp">#if defined(CONFIG_LEDS_GPIO) || defined(CONFIG_LEDS_GPIO_MODULE)</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio_led</span> <span class="n">gpio_leds</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;palmz72:green:led&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_trigger</span>	<span class="o">=</span> <span class="s">&quot;none&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span>			<span class="o">=</span> <span class="n">GPIO_NR_PALMZ72_LED_GREEN</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio_led_platform_data</span> <span class="n">gpio_led_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">leds</span>		<span class="o">=</span> <span class="n">gpio_leds</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_leds</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">gpio_leds</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">palmz72_leds</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;leds-gpio&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">gpio_led_info</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">palmz72_leds_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">palmz72_leds</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">palmz72_leds_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PM</span>

<span class="cm">/* We have some black magic here</span>
<span class="cm"> * PalmOS ROM on recover expects special struct physical address</span>
<span class="cm"> * to be transferred via PSPR. Using this struct PalmOS restores</span>
<span class="cm"> * its state after sleep. As for Linux, we need to setup it the</span>
<span class="cm"> * same way. More than that, PalmOS ROM changes some values in memory.</span>
<span class="cm"> * For now only one location is found, which needs special treatment.</span>
<span class="cm"> * Thanks to Alex Osborne, Andrzej Zaborowski, and lots of other people</span>
<span class="cm"> * for reading backtraces for me :)</span>
<span class="cm"> */</span>

<span class="cp">#define PALMZ72_SAVE_DWORD ((unsigned long *)0xc0000050)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">palmz72_resume_info</span> <span class="n">palmz72_resume_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">magic0</span> <span class="o">=</span> <span class="mh">0xb4e6</span><span class="p">,</span>
	<span class="p">.</span><span class="n">magic1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="cm">/* reset state, MMU off etc */</span>
	<span class="p">.</span><span class="n">arm_control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">aux_control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ttb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">domain_access</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">process_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">store_ptr</span><span class="p">;</span>

<span class="cm">/* syscore_ops for Palm Zire 72 PM */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">palmz72_pm_suspend</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* setup the resume_info struct for the original bootloader */</span>
	<span class="n">palmz72_resume_info</span><span class="p">.</span><span class="n">resume_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">cpu_resume</span><span class="p">;</span>

	<span class="cm">/* Storing memory touched by ROM */</span>
	<span class="n">store_ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">PALMZ72_SAVE_DWORD</span><span class="p">;</span>

	<span class="cm">/* Setting PSPR to a proper value */</span>
	<span class="n">PSPR</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">palmz72_resume_info</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">palmz72_pm_resume</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">PALMZ72_SAVE_DWORD</span> <span class="o">=</span> <span class="n">store_ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">syscore_ops</span> <span class="n">palmz72_pm_syscore_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">palmz72_pm_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">palmz72_pm_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">palmz72_pm_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">machine_is_palmz72</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">register_syscore_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">palmz72_pm_syscore_ops</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">device_initcall</span><span class="p">(</span><span class="n">palmz72_pm_init</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> * SoC Camera</span>
<span class="cm"> ******************************************************************************/</span>
<span class="cp">#if defined(CONFIG_SOC_CAMERA_OV9640) || \</span>
<span class="cp">	defined(CONFIG_SOC_CAMERA_OV9640_MODULE)</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pxacamera_platform_data</span> <span class="n">palmz72_pxacamera_platform_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">PXA_CAMERA_MASTER</span> <span class="o">|</span> <span class="n">PXA_CAMERA_DATAWIDTH_8</span> <span class="o">|</span>
			<span class="n">PXA_CAMERA_PCLK_EN</span> <span class="o">|</span> <span class="n">PXA_CAMERA_MCLK_EN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mclk_10khz</span>	<span class="o">=</span> <span class="mi">2600</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Board I2C devices. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">palmz72_i2c_device</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;ov9640&quot;</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">),</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">palmz72_camera_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">power</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">GPIO_NR_PALMZ72_CAM_PWDN</span><span class="p">,</span> <span class="o">!</span><span class="n">power</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">palmz72_camera_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">GPIO_NR_PALMZ72_CAM_RESET</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">GPIO_NR_PALMZ72_CAM_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">soc_camera_link</span> <span class="n">palmz72_iclink</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bus_id</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="cm">/* Match id in pxa27x_device_camera in device.c */</span>
	<span class="p">.</span><span class="n">board_info</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">palmz72_i2c_device</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	<span class="p">.</span><span class="n">i2c_adapter_id</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">module_name</span>	<span class="o">=</span> <span class="s">&quot;ov96xx&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">power</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">palmz72_camera_power</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">palmz72_camera_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">SOCAM_DATAWIDTH_8</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_gpio_platform_data</span> <span class="n">palmz72_i2c_bus_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">sda_pin</span>	<span class="o">=</span> <span class="mi">118</span><span class="p">,</span>
	<span class="p">.</span><span class="n">scl_pin</span>	<span class="o">=</span> <span class="mi">117</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udelay</span>		<span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
	<span class="p">.</span><span class="n">timeout</span>	<span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">palmz72_i2c_bus_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;i2c-gpio&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="cm">/* we use this as a replacement for i2c-pxa */</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">palmz72_i2c_bus_data</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">palmz72_camera</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;soc-camera-pdrv&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">palmz72_iclink</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* Here we request the camera GPIOs and configure them. We power up the camera</span>
<span class="cm"> * module, deassert the reset pin, but put it into powerdown (low to no power</span>
<span class="cm"> * consumption) mode. This allows us to later bring the module up fast. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio</span> <span class="n">palmz72_camera_gpios</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">GPIO_NR_PALMZ72_CAM_POWER</span><span class="p">,</span>	<span class="n">GPIOF_INIT_HIGH</span><span class="p">,</span><span class="s">&quot;Camera DVDD&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPIO_NR_PALMZ72_CAM_RESET</span><span class="p">,</span>	<span class="n">GPIOF_INIT_LOW</span><span class="p">,</span>	<span class="s">&quot;Camera RESET&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">GPIO_NR_PALMZ72_CAM_PWDN</span><span class="p">,</span>	<span class="n">GPIOF_INIT_LOW</span><span class="p">,</span>	<span class="s">&quot;Camera PWDN&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">palmz72_cam_gpio_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_request_array</span><span class="p">(</span><span class="n">ARRAY_AND_SIZE</span><span class="p">(</span><span class="n">palmz72_camera_gpios</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">gpio_free_array</span><span class="p">(</span><span class="n">ARRAY_AND_SIZE</span><span class="p">(</span><span class="n">palmz72_camera_gpios</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Camera GPIO init failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">palmz72_camera_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">palmz72_cam_gpio_init</span><span class="p">();</span>
	<span class="n">pxa_set_camera_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">palmz72_pxacamera_platform_data</span><span class="p">);</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">palmz72_i2c_bus_device</span><span class="p">);</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">palmz72_camera</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">palmz72_camera_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> * Machine init</span>
<span class="cm"> ******************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">palmz72_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pxa2xx_mfp_config</span><span class="p">(</span><span class="n">ARRAY_AND_SIZE</span><span class="p">(</span><span class="n">palmz72_pin_config</span><span class="p">));</span>
	<span class="n">pxa_set_ffuart_info</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="n">pxa_set_btuart_info</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="n">pxa_set_stuart_info</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>

	<span class="n">palm27x_mmc_init</span><span class="p">(</span><span class="n">GPIO_NR_PALMZ72_SD_DETECT_N</span><span class="p">,</span> <span class="n">GPIO_NR_PALMZ72_SD_RO</span><span class="p">,</span>
			<span class="n">GPIO_NR_PALMZ72_SD_POWER_N</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">palm27x_lcd_init</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">palm_320x320_lcd_mode</span><span class="p">);</span>
	<span class="n">palm27x_udc_init</span><span class="p">(</span><span class="n">GPIO_NR_PALMZ72_USB_DETECT_N</span><span class="p">,</span>
			<span class="n">GPIO_NR_PALMZ72_USB_PULLUP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">palm27x_irda_init</span><span class="p">(</span><span class="n">GPIO_NR_PALMZ72_IR_DISABLE</span><span class="p">);</span>
	<span class="n">palm27x_ac97_init</span><span class="p">(</span><span class="n">PALMZ72_BAT_MIN_VOLTAGE</span><span class="p">,</span> <span class="n">PALMZ72_BAT_MAX_VOLTAGE</span><span class="p">,</span>
			<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">113</span><span class="p">);</span>
	<span class="n">palm27x_pwm_init</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">palm27x_power_init</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">palm27x_pmic_init</span><span class="p">();</span>
	<span class="n">palmz72_kpc_init</span><span class="p">();</span>
	<span class="n">palmz72_leds_init</span><span class="p">();</span>
	<span class="n">palmz72_camera_init</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">MACHINE_START</span><span class="p">(</span><span class="n">PALMZ72</span><span class="p">,</span> <span class="s">&quot;Palm Zire72&quot;</span><span class="p">)</span>
	<span class="p">.</span><span class="n">atag_offset</span>	<span class="o">=</span> <span class="mh">0x100</span><span class="p">,</span>
	<span class="p">.</span><span class="n">map_io</span>		<span class="o">=</span> <span class="n">pxa27x_map_io</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nr_irqs</span>	<span class="o">=</span> <span class="n">PXA_NR_IRQS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_irq</span>	<span class="o">=</span> <span class="n">pxa27x_init_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">handle_irq</span>	<span class="o">=</span> <span class="n">pxa27x_handle_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">timer</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pxa_timer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_machine</span>	<span class="o">=</span> <span class="n">palmz72_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">restart</span>	<span class="o">=</span> <span class="n">pxa_restart</span><span class="p">,</span>
<span class="n">MACHINE_END</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
