<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › mach-ebsa110 › io.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>io.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/arch/arm/mach-ebsa110/isamem.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2001 Russell King</span>
<span class="cm"> *</span>
<span class="cm"> * Perform &quot;ISA&quot; memory and IO accesses.  The EBSA110 has some &quot;peculiarities&quot;</span>
<span class="cm"> * in the way it handles accesses to odd IO ports on 16-bit devices.  These</span>
<span class="cm"> * devices have their D0-D15 lines connected to the processors D0-D15 lines.</span>
<span class="cm"> * Since they expect all byte IO operations to be performed on D0-D7, and the</span>
<span class="cm"> * StrongARM expects to transfer the byte to these odd addresses on D8-D15,</span>
<span class="cm"> * we must use a trick to get the required behaviour.</span>
<span class="cm"> *</span>
<span class="cm"> * The trick employed here is to use long word stores to odd address -1.  The</span>
<span class="cm"> * glue logic picks this up as a &quot;trick&quot; access, and asserts the LSB of the</span>
<span class="cm"> * peripherals address bus, thereby accessing the odd IO port.  Meanwhile, the</span>
<span class="cm"> * StrongARM transfers its data on D0-D7 as expected.</span>
<span class="cm"> *</span>
<span class="cm"> * Things get more interesting on the pass-1 EBSA110 - the PCMCIA controller</span>
<span class="cm"> * wiring was screwed in such a way that it had limited memory space access.</span>
<span class="cm"> * Luckily, the work-around for this is not too horrible.  See</span>
<span class="cm"> * __isamem_convert_addr for the details.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>

<span class="cp">#include &lt;mach/hardware.h&gt;</span>
<span class="cp">#include &lt;asm/page.h&gt;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">__isamem_convert_addr</span><span class="p">(</span><span class="k">const</span> <span class="k">volatile</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__force</span><span class="p">)</span> <span class="n">addr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The PCMCIA controller is wired up as follows:</span>
<span class="cm">	 *        +---------+---------+---------+---------+---------+---------+</span>
<span class="cm">	 * PCMCIA | 2 2 2 2 | 1 1 1 1 | 1 1 1 1 | 1 1     |         |         |</span>
<span class="cm">	 *        | 3 2 1 0 | 9 8 7 6 | 5 4 3 2 | 1 0 9 8 | 7 6 5 4 | 3 2 1 0 |</span>
<span class="cm">	 *        +---------+---------+---------+---------+---------+---------+</span>
<span class="cm">	 *  CPU   | 2 2 2 2 | 2 1 1 1 | 1 1 1 1 | 1 1 1   |         |         |</span>
<span class="cm">	 *        | 4 3 2 1 | 0 9 9 8 | 7 6 5 4 | 3 2 0 9 | 8 7 6 5 | 4 3 2 x |</span>
<span class="cm">	 *        +---------+---------+---------+---------+---------+---------+</span>
<span class="cm">	 *</span>
<span class="cm">	 * This means that we can access PCMCIA regions as follows:</span>
<span class="cm">	 *	0x*10000 -&gt; 0x*1ffff</span>
<span class="cm">	 *	0x*70000 -&gt; 0x*7ffff</span>
<span class="cm">	 *	0x*90000 -&gt; 0x*9ffff</span>
<span class="cm">	 *	0x*f0000 -&gt; 0x*fffff</span>
<span class="cm">	 */</span>
	<span class="n">ret</span>  <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0xf803fe</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x03fc00</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">+=</span> <span class="mh">0xe8000000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x20000</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x40000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ret</span><span class="p">;</span>

	<span class="n">BUG</span><span class="p">();</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * read[bwl] and write[bwl]</span>
<span class="cm"> */</span>
<span class="n">u8</span> <span class="nf">__readb</span><span class="p">(</span><span class="k">const</span> <span class="k">volatile</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">__isamem_convert_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">__raw_readb</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u16</span> <span class="nf">__readw</span><span class="p">(</span><span class="k">const</span> <span class="k">volatile</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">__isamem_convert_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">__raw_readw</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">__readl</span><span class="p">(</span><span class="k">const</span> <span class="k">volatile</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">__isamem_convert_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__raw_readw</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">__raw_readw</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__readb</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__readw</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__readl</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">readsw</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">__isamem_convert_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">__raw_readsw</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">readsw</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">readsl</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">__isamem_convert_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">__raw_readsl</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">readsl</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">__writeb</span><span class="p">(</span><span class="n">u8</span> <span class="n">val</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">__isamem_convert_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">__raw_writeb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">__writew</span><span class="p">(</span><span class="n">u16</span> <span class="n">val</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">__isamem_convert_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="n">__raw_writew</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">__writel</span><span class="p">(</span><span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">__isamem_convert_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="n">__raw_writew</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__writeb</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__writew</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__writel</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">writesw</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">__isamem_convert_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">__raw_writesw</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">writesw</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">writesl</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">__isamem_convert_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">__raw_writesl</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">writesl</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * The EBSA110 has a weird &quot;ISA IO&quot; region:</span>
<span class="cm"> *</span>
<span class="cm"> * Region 0 (addr = 0xf0000000 + io &lt;&lt; 2)</span>
<span class="cm"> * --------------------------------------------------------</span>
<span class="cm"> * Physical region	IO region</span>
<span class="cm"> * f0000fe0 - f0000ffc	3f8 - 3ff  ttyS0</span>
<span class="cm"> * f0000e60 - f0000e64	398 - 399</span>
<span class="cm"> * f0000de0 - f0000dfc	378 - 37f  lp0</span>
<span class="cm"> * f0000be0 - f0000bfc	2f8 - 2ff  ttyS1</span>
<span class="cm"> *</span>
<span class="cm"> * Region 1 (addr = 0xf0000000 + (io &amp; ~1) &lt;&lt; 1 + (io &amp; 1))</span>
<span class="cm"> * --------------------------------------------------------</span>
<span class="cm"> * Physical region	IO region</span>
<span class="cm"> * f00014f1             a79        pnp write data</span>
<span class="cm"> * f00007c0 - f00007c1	3e0 - 3e1  pcmcia</span>
<span class="cm"> * f00004f1		279        pnp address</span>
<span class="cm"> * f0000440 - f000046c  220 - 236  eth0</span>
<span class="cm"> * f0000405		203        pnp read data</span>
<span class="cm"> */</span>
<span class="cp">#define SUPERIO_PORT(p) \</span>
<span class="cp">	(((p) &gt;&gt; 3) == (0x3f8 &gt;&gt; 3) || \</span>
<span class="cp">	 ((p) &gt;&gt; 3) == (0x2f8 &gt;&gt; 3) || \</span>
<span class="cp">	 ((p) &gt;&gt; 3) == (0x378 &gt;&gt; 3))</span>

<span class="cm">/*</span>
<span class="cm"> * We&#39;re addressing an 8 or 16-bit peripheral which tranfers</span>
<span class="cm"> * odd addresses on the low ISA byte lane.</span>
<span class="cm"> */</span>
<span class="n">u8</span> <span class="nf">__inb8</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The SuperIO registers use sane addressing techniques...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SUPERIO_PORT</span><span class="p">(</span><span class="n">port</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">__raw_readb</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ISAIO_BASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">port</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ISAIO_BASE</span> <span class="o">+</span> <span class="p">((</span><span class="n">port</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Shame nothing else does</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">__raw_readb</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We&#39;re addressing a 16-bit peripheral which transfers odd</span>
<span class="cm"> * addresses on the high ISA byte lane.</span>
<span class="cm"> */</span>
<span class="n">u8</span> <span class="nf">__inb16</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The SuperIO registers use sane addressing techniques...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SUPERIO_PORT</span><span class="p">(</span><span class="n">port</span><span class="p">))</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">port</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="o">|</span> <span class="p">(</span><span class="n">port</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">__raw_readb</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ISAIO_BASE</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u16</span> <span class="nf">__inw</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The SuperIO registers use sane addressing techniques...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SUPERIO_PORT</span><span class="p">(</span><span class="n">port</span><span class="p">))</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">port</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">port</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">port</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">__raw_readw</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ISAIO_BASE</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Fake a 32-bit read with two 16-bit reads.  Needed for 3c589.</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">__inl</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SUPERIO_PORT</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">||</span> <span class="n">port</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ISAIO_BASE</span> <span class="o">+</span> <span class="p">((</span><span class="n">port</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">__raw_readw</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">__raw_readw</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__inb8</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__inb16</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__inw</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__inl</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">__outb8</span><span class="p">(</span><span class="n">u8</span> <span class="n">val</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * The SuperIO registers use sane addressing techniques...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SUPERIO_PORT</span><span class="p">(</span><span class="n">port</span><span class="p">))</span>
		<span class="n">__raw_writeb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ISAIO_BASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">port</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ISAIO_BASE</span> <span class="o">+</span> <span class="p">((</span><span class="n">port</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Shame nothing else does</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">__raw_writeb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">__outb16</span><span class="p">(</span><span class="n">u8</span> <span class="n">val</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The SuperIO registers use sane addressing techniques...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SUPERIO_PORT</span><span class="p">(</span><span class="n">port</span><span class="p">))</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">port</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="o">|</span> <span class="p">(</span><span class="n">port</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">__raw_writeb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ISAIO_BASE</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">__outw</span><span class="p">(</span><span class="n">u16</span> <span class="n">val</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The SuperIO registers use sane addressing techniques...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SUPERIO_PORT</span><span class="p">(</span><span class="n">port</span><span class="p">))</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">port</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">port</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">port</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ISAIO_BASE</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">__outl</span><span class="p">(</span><span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__outb8</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__outb16</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__outw</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__outl</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">outsb</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">from</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">off</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SUPERIO_PORT</span><span class="p">(</span><span class="n">port</span><span class="p">))</span>
		<span class="n">off</span> <span class="o">=</span> <span class="n">port</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">off</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">__raw_writesb</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ISAIO_BASE</span> <span class="o">+</span> <span class="n">off</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">insb</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">from</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">off</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SUPERIO_PORT</span><span class="p">(</span><span class="n">port</span><span class="p">))</span>
		<span class="n">off</span> <span class="o">=</span> <span class="n">port</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">off</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">__raw_readsb</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ISAIO_BASE</span> <span class="o">+</span> <span class="n">off</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">outsb</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">insb</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">outsw</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">from</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">off</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SUPERIO_PORT</span><span class="p">(</span><span class="n">port</span><span class="p">))</span>
		<span class="n">off</span> <span class="o">=</span> <span class="n">port</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">off</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">__raw_writesw</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ISAIO_BASE</span> <span class="o">+</span> <span class="n">off</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">insw</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">from</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">off</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SUPERIO_PORT</span><span class="p">(</span><span class="n">port</span><span class="p">))</span>
		<span class="n">off</span> <span class="o">=</span> <span class="n">port</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">off</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">__raw_readsw</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ISAIO_BASE</span> <span class="o">+</span> <span class="n">off</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">outsw</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">insw</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * We implement these as 16-bit insw/outsw, mainly for</span>
<span class="cm"> * 3c589 cards.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">outsl</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">from</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">off</span> <span class="o">=</span> <span class="n">port</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SUPERIO_PORT</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">||</span> <span class="n">port</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="n">__raw_writesw</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ISAIO_BASE</span> <span class="o">+</span> <span class="n">off</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">len</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">insl</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">from</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">off</span> <span class="o">=</span> <span class="n">port</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SUPERIO_PORT</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">||</span> <span class="n">port</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="n">__raw_readsw</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ISAIO_BASE</span> <span class="o">+</span> <span class="n">off</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">len</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">outsl</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">insl</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
