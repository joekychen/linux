<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › mach-omap1 › pm.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>pm.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/arch/arm/mach-omap1/pm.c</span>
<span class="cm"> *</span>
<span class="cm"> * OMAP Power Management Routines</span>
<span class="cm"> *</span>
<span class="cm"> * Original code for the SA11x0:</span>
<span class="cm"> * Copyright (c) 2001 Cliff Brake &lt;cbrake@accelent.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Modified for the PXA250 by Nicolas Pitre:</span>
<span class="cm"> * Copyright (c) 2002 Monta Vista Software, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Modified for the OMAP1510 by David Singleton:</span>
<span class="cm"> * Copyright (c) 2002 Monta Vista Software, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Cleanup 2004 for OMAP1510/1610 by Dirk Behme &lt;dirk.behme@de.bosch.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License as published by the</span>
<span class="cm"> * Free Software Foundation; either version 2 of the License, or (at your</span>
<span class="cm"> * option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED ``AS IS&#39;&#39; AND ANY EXPRESS OR IMPLIED</span>
<span class="cm"> * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN</span>
<span class="cm"> * NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<span class="cm"> * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT</span>
<span class="cm"> * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF</span>
<span class="cm"> * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON</span>
<span class="cm"> * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="cm"> * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF</span>
<span class="cm"> * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along</span>
<span class="cm"> * with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/suspend.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/sysfs.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/atomic.h&gt;</span>

<span class="cp">#include &lt;asm/system_misc.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/mach/time.h&gt;</span>
<span class="cp">#include &lt;asm/mach/irq.h&gt;</span>

<span class="cp">#include &lt;plat/cpu.h&gt;</span>
<span class="cp">#include &lt;plat/clock.h&gt;</span>
<span class="cp">#include &lt;plat/sram.h&gt;</span>
<span class="cp">#include &lt;plat/tc.h&gt;</span>
<span class="cp">#include &lt;plat/mux.h&gt;</span>
<span class="cp">#include &lt;plat/dma.h&gt;</span>
<span class="cp">#include &lt;plat/dmtimer.h&gt;</span>

<span class="cp">#include &lt;mach/irqs.h&gt;</span>

<span class="cp">#include &quot;iomap.h&quot;</span>
<span class="cp">#include &quot;pm.h&quot;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">arm_sleep_save</span><span class="p">[</span><span class="n">ARM_SLEEP_SAVE_SIZE</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">dsp_sleep_save</span><span class="p">[</span><span class="n">DSP_SLEEP_SAVE_SIZE</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ulpd_sleep_save</span><span class="p">[</span><span class="n">ULPD_SLEEP_SAVE_SIZE</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mpui7xx_sleep_save</span><span class="p">[</span><span class="n">MPUI7XX_SLEEP_SAVE_SIZE</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mpui1510_sleep_save</span><span class="p">[</span><span class="n">MPUI1510_SLEEP_SAVE_SIZE</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mpui1610_sleep_save</span><span class="p">[</span><span class="n">MPUI1610_SLEEP_SAVE_SIZE</span><span class="p">];</span>

<span class="cp">#ifdef CONFIG_OMAP_32K_TIMER</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">enable_dyn_sleep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">idle_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobj_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%hu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">enable_dyn_sleep</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">idle_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobj_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%hu&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;idle_sleep_store: Invalid value</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">enable_dyn_sleep</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kobj_attribute</span> <span class="n">sleep_while_idle_attr</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">sleep_while_idle</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">idle_show</span><span class="p">,</span> <span class="n">idle_store</span><span class="p">);</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">omap_sram_suspend</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r1</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Let&#39;s power down on idle, but only if we are really</span>
<span class="cm"> * idle, because once we start down the path of</span>
<span class="cm"> * going idle we continue to do idle even if we get</span>
<span class="cm"> * a clock tick interrupt . .</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">omap1_pm_idle</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">extern</span> <span class="n">__u32</span> <span class="n">arm_idlect1_mask</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">use_idlect1</span> <span class="o">=</span> <span class="n">arm_idlect1_mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">do_sleep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">local_fiq_disable</span><span class="p">();</span>

<span class="cp">#if defined(CONFIG_OMAP_MPU_TIMER) &amp;&amp; !defined(CONFIG_OMAP_DM_TIMER)</span>
<span class="cp">#warning Enable 32kHz OS timer in order to allow sleep states in idle</span>
	<span class="n">use_idlect1</span> <span class="o">=</span> <span class="n">use_idlect1</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>
<span class="cp">#else</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">enable_dyn_sleep</span><span class="p">)</span> <span class="p">{</span>

<span class="cp">#ifdef CONFIG_CBUS_TAHVO_USB</span>
		<span class="k">extern</span> <span class="kt">int</span> <span class="n">vbus_active</span><span class="p">;</span>
		<span class="cm">/* Clock requirements? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vbus_active</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">do_sleep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_OMAP_DM_TIMER</span>
	<span class="n">use_idlect1</span> <span class="o">=</span> <span class="n">omap_dm_timer_modify_idlect_mask</span><span class="p">(</span><span class="n">use_idlect1</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">omap_dma_running</span><span class="p">())</span>
		<span class="n">use_idlect1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>

	<span class="cm">/* We should be able to remove the do_sleep variable and multiple</span>
<span class="cm">	 * tests above as soon as drivers, timer and DMA code have been fixed.</span>
<span class="cm">	 * Even the sleep block count should become obsolete. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">use_idlect1</span> <span class="o">!=</span> <span class="o">~</span><span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">do_sleep</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">__u32</span> <span class="n">saved_idlect1</span> <span class="o">=</span> <span class="n">omap_readl</span><span class="p">(</span><span class="n">ARM_IDLECT1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap15xx</span><span class="p">())</span>
			<span class="n">use_idlect1</span> <span class="o">&amp;=</span> <span class="n">OMAP1510_BIG_SLEEP_REQUEST</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">use_idlect1</span> <span class="o">&amp;=</span> <span class="n">OMAP1610_IDLECT1_SLEEP_VAL</span><span class="p">;</span>
		<span class="n">omap_writel</span><span class="p">(</span><span class="n">use_idlect1</span><span class="p">,</span> <span class="n">ARM_IDLECT1</span><span class="p">);</span>
		<span class="n">__asm__</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">&quot;mcr	p15, 0, r0, c7, c0, 4&quot;</span><span class="p">);</span>
		<span class="n">omap_writel</span><span class="p">(</span><span class="n">saved_idlect1</span><span class="p">,</span> <span class="n">ARM_IDLECT1</span><span class="p">);</span>

		<span class="n">local_fiq_enable</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">omap_sram_suspend</span><span class="p">(</span><span class="n">omap_readl</span><span class="p">(</span><span class="n">ARM_IDLECT1</span><span class="p">),</span>
			  <span class="n">omap_readl</span><span class="p">(</span><span class="n">ARM_IDLECT2</span><span class="p">));</span>

	<span class="n">local_fiq_enable</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Configuration of the wakeup event is board specific. For the</span>
<span class="cm"> * moment we put it into this helper function. Later it may move</span>
<span class="cm"> * to board specific files.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_pm_wakeup_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">level1_wake</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">level2_wake</span> <span class="o">=</span> <span class="n">OMAP_IRQ_BIT</span><span class="p">(</span><span class="n">INT_UART2</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Turn off all interrupts except GPIO bank 1, L1-2nd level cascade,</span>
<span class="cm">	 * and the L2 wakeup interrupts: keypad and UART2. Note that the</span>
<span class="cm">	 * drivers must still separately call omap_set_gpio_wakeup() to</span>
<span class="cm">	 * wake up to a GPIO interrupt.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap7xx</span><span class="p">())</span>
		<span class="n">level1_wake</span> <span class="o">=</span> <span class="n">OMAP_IRQ_BIT</span><span class="p">(</span><span class="n">INT_7XX_GPIO_BANK1</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">OMAP_IRQ_BIT</span><span class="p">(</span><span class="n">INT_7XX_IH2_IRQ</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap15xx</span><span class="p">())</span>
		<span class="n">level1_wake</span> <span class="o">=</span> <span class="n">OMAP_IRQ_BIT</span><span class="p">(</span><span class="n">INT_GPIO_BANK1</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">OMAP_IRQ_BIT</span><span class="p">(</span><span class="n">INT_1510_IH2_IRQ</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap16xx</span><span class="p">())</span>
		<span class="n">level1_wake</span> <span class="o">=</span> <span class="n">OMAP_IRQ_BIT</span><span class="p">(</span><span class="n">INT_GPIO_BANK1</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">OMAP_IRQ_BIT</span><span class="p">(</span><span class="n">INT_1610_IH2_IRQ</span><span class="p">);</span>

	<span class="n">omap_writel</span><span class="p">(</span><span class="o">~</span><span class="n">level1_wake</span><span class="p">,</span> <span class="n">OMAP_IH1_MIR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap7xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">omap_writel</span><span class="p">(</span><span class="o">~</span><span class="n">level2_wake</span><span class="p">,</span> <span class="n">OMAP_IH2_0_MIR</span><span class="p">);</span>
		<span class="n">omap_writel</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">OMAP_IRQ_BIT</span><span class="p">(</span><span class="n">INT_7XX_WAKE_UP_REQ</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">OMAP_IRQ_BIT</span><span class="p">(</span><span class="n">INT_7XX_MPUIO_KEYPAD</span><span class="p">)),</span>
				<span class="n">OMAP_IH2_1_MIR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap15xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">level2_wake</span> <span class="o">|=</span> <span class="n">OMAP_IRQ_BIT</span><span class="p">(</span><span class="n">INT_KEYBOARD</span><span class="p">);</span>
		<span class="n">omap_writel</span><span class="p">(</span><span class="o">~</span><span class="n">level2_wake</span><span class="p">,</span>  <span class="n">OMAP_IH2_MIR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap16xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">level2_wake</span> <span class="o">|=</span> <span class="n">OMAP_IRQ_BIT</span><span class="p">(</span><span class="n">INT_KEYBOARD</span><span class="p">);</span>
		<span class="n">omap_writel</span><span class="p">(</span><span class="o">~</span><span class="n">level2_wake</span><span class="p">,</span> <span class="n">OMAP_IH2_0_MIR</span><span class="p">);</span>

		<span class="cm">/* INT_1610_WAKE_UP_REQ is needed for GPIO wakeup... */</span>
		<span class="n">omap_writel</span><span class="p">(</span><span class="o">~</span><span class="n">OMAP_IRQ_BIT</span><span class="p">(</span><span class="n">INT_1610_WAKE_UP_REQ</span><span class="p">),</span>
			    <span class="n">OMAP_IH2_1_MIR</span><span class="p">);</span>
		<span class="n">omap_writel</span><span class="p">(</span><span class="o">~</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">OMAP_IH2_2_MIR</span><span class="p">);</span>
		<span class="n">omap_writel</span><span class="p">(</span><span class="o">~</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">OMAP_IH2_3_MIR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*  New IRQ agreement, recalculate in cascade order */</span>
	<span class="n">omap_writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">OMAP_IH2_CONTROL</span><span class="p">);</span>
	<span class="n">omap_writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">OMAP_IH1_CONTROL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define EN_DSPCK	13	</span><span class="cm">/* ARM_CKCTL */</span><span class="cp"></span>
<span class="cp">#define EN_APICK	6	</span><span class="cm">/* ARM_IDLECT2 */</span><span class="cp"></span>
<span class="cp">#define DSP_EN		1	</span><span class="cm">/* ARM_RSTCT1 */</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">omap1_pm_suspend</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">arg1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PM: OMAP%x is trying to enter deep sleep...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">omap_rev</span><span class="p">());</span>

	<span class="n">omap_serial_wake_trigger</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_is_omap15xx</span><span class="p">())</span>
		<span class="n">omap_writew</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">,</span> <span class="n">ULPD_SOFT_DISABLE_REQ_REG</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Step 1: turn off interrupts (FIXME: NOTE: already disabled)</span>
<span class="cm">	 */</span>

	<span class="n">local_irq_disable</span><span class="p">();</span>
	<span class="n">local_fiq_disable</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Step 2: save registers</span>
<span class="cm">	 *</span>
<span class="cm">	 * The omap is a strange/beautiful device. The caches, memory</span>
<span class="cm">	 * and register state are preserved across power saves.</span>
<span class="cm">	 * We have to save and restore very little register state to</span>
<span class="cm">	 * idle the omap.</span>
<span class="cm">         *</span>
<span class="cm">	 * Save interrupt, MPUI, ARM and UPLD control registers.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap7xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">MPUI7XX_SAVE</span><span class="p">(</span><span class="n">OMAP_IH1_MIR</span><span class="p">);</span>
		<span class="n">MPUI7XX_SAVE</span><span class="p">(</span><span class="n">OMAP_IH2_0_MIR</span><span class="p">);</span>
		<span class="n">MPUI7XX_SAVE</span><span class="p">(</span><span class="n">OMAP_IH2_1_MIR</span><span class="p">);</span>
		<span class="n">MPUI7XX_SAVE</span><span class="p">(</span><span class="n">MPUI_CTRL</span><span class="p">);</span>
		<span class="n">MPUI7XX_SAVE</span><span class="p">(</span><span class="n">MPUI_DSP_BOOT_CONFIG</span><span class="p">);</span>
		<span class="n">MPUI7XX_SAVE</span><span class="p">(</span><span class="n">MPUI_DSP_API_CONFIG</span><span class="p">);</span>
		<span class="n">MPUI7XX_SAVE</span><span class="p">(</span><span class="n">EMIFS_CONFIG</span><span class="p">);</span>
		<span class="n">MPUI7XX_SAVE</span><span class="p">(</span><span class="n">EMIFF_SDRAM_CONFIG</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap15xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">MPUI1510_SAVE</span><span class="p">(</span><span class="n">OMAP_IH1_MIR</span><span class="p">);</span>
		<span class="n">MPUI1510_SAVE</span><span class="p">(</span><span class="n">OMAP_IH2_MIR</span><span class="p">);</span>
		<span class="n">MPUI1510_SAVE</span><span class="p">(</span><span class="n">MPUI_CTRL</span><span class="p">);</span>
		<span class="n">MPUI1510_SAVE</span><span class="p">(</span><span class="n">MPUI_DSP_BOOT_CONFIG</span><span class="p">);</span>
		<span class="n">MPUI1510_SAVE</span><span class="p">(</span><span class="n">MPUI_DSP_API_CONFIG</span><span class="p">);</span>
		<span class="n">MPUI1510_SAVE</span><span class="p">(</span><span class="n">EMIFS_CONFIG</span><span class="p">);</span>
		<span class="n">MPUI1510_SAVE</span><span class="p">(</span><span class="n">EMIFF_SDRAM_CONFIG</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap16xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">MPUI1610_SAVE</span><span class="p">(</span><span class="n">OMAP_IH1_MIR</span><span class="p">);</span>
		<span class="n">MPUI1610_SAVE</span><span class="p">(</span><span class="n">OMAP_IH2_0_MIR</span><span class="p">);</span>
		<span class="n">MPUI1610_SAVE</span><span class="p">(</span><span class="n">OMAP_IH2_1_MIR</span><span class="p">);</span>
		<span class="n">MPUI1610_SAVE</span><span class="p">(</span><span class="n">OMAP_IH2_2_MIR</span><span class="p">);</span>
		<span class="n">MPUI1610_SAVE</span><span class="p">(</span><span class="n">OMAP_IH2_3_MIR</span><span class="p">);</span>
		<span class="n">MPUI1610_SAVE</span><span class="p">(</span><span class="n">MPUI_CTRL</span><span class="p">);</span>
		<span class="n">MPUI1610_SAVE</span><span class="p">(</span><span class="n">MPUI_DSP_BOOT_CONFIG</span><span class="p">);</span>
		<span class="n">MPUI1610_SAVE</span><span class="p">(</span><span class="n">MPUI_DSP_API_CONFIG</span><span class="p">);</span>
		<span class="n">MPUI1610_SAVE</span><span class="p">(</span><span class="n">EMIFS_CONFIG</span><span class="p">);</span>
		<span class="n">MPUI1610_SAVE</span><span class="p">(</span><span class="n">EMIFF_SDRAM_CONFIG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ARM_SAVE</span><span class="p">(</span><span class="n">ARM_CKCTL</span><span class="p">);</span>
	<span class="n">ARM_SAVE</span><span class="p">(</span><span class="n">ARM_IDLECT1</span><span class="p">);</span>
	<span class="n">ARM_SAVE</span><span class="p">(</span><span class="n">ARM_IDLECT2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cpu_is_omap15xx</span><span class="p">()))</span>
		<span class="n">ARM_SAVE</span><span class="p">(</span><span class="n">ARM_IDLECT3</span><span class="p">);</span>
	<span class="n">ARM_SAVE</span><span class="p">(</span><span class="n">ARM_EWUPCT</span><span class="p">);</span>
	<span class="n">ARM_SAVE</span><span class="p">(</span><span class="n">ARM_RSTCT1</span><span class="p">);</span>
	<span class="n">ARM_SAVE</span><span class="p">(</span><span class="n">ARM_RSTCT2</span><span class="p">);</span>
	<span class="n">ARM_SAVE</span><span class="p">(</span><span class="n">ARM_SYSST</span><span class="p">);</span>
	<span class="n">ULPD_SAVE</span><span class="p">(</span><span class="n">ULPD_CLOCK_CTRL</span><span class="p">);</span>
	<span class="n">ULPD_SAVE</span><span class="p">(</span><span class="n">ULPD_STATUS_REQ</span><span class="p">);</span>

	<span class="cm">/* (Step 3 removed - we now allow deep sleep by default) */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Step 4: OMAP DSP Shutdown</span>
<span class="cm">	 */</span>

	<span class="cm">/* stop DSP */</span>
	<span class="n">omap_writew</span><span class="p">(</span><span class="n">omap_readw</span><span class="p">(</span><span class="n">ARM_RSTCT1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DSP_EN</span><span class="p">),</span> <span class="n">ARM_RSTCT1</span><span class="p">);</span>

		<span class="cm">/* shut down dsp_ck */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_is_omap7xx</span><span class="p">())</span>
		<span class="n">omap_writew</span><span class="p">(</span><span class="n">omap_readw</span><span class="p">(</span><span class="n">ARM_CKCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">EN_DSPCK</span><span class="p">),</span> <span class="n">ARM_CKCTL</span><span class="p">);</span>

	<span class="cm">/* temporarily enabling api_ck to access DSP registers */</span>
	<span class="n">omap_writew</span><span class="p">(</span><span class="n">omap_readw</span><span class="p">(</span><span class="n">ARM_IDLECT2</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">EN_APICK</span><span class="p">,</span> <span class="n">ARM_IDLECT2</span><span class="p">);</span>

	<span class="cm">/* save DSP registers */</span>
	<span class="n">DSP_SAVE</span><span class="p">(</span><span class="n">DSP_IDLECT2</span><span class="p">);</span>

	<span class="cm">/* Stop all DSP domain clocks */</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DSP_IDLECT2</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Step 5: Wakeup Event Setup</span>
<span class="cm">	 */</span>

	<span class="n">omap_pm_wakeup_setup</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Step 6: ARM and Traffic controller shutdown</span>
<span class="cm">	 */</span>

	<span class="cm">/* disable ARM watchdog */</span>
	<span class="n">omap_writel</span><span class="p">(</span><span class="mh">0x00F5</span><span class="p">,</span> <span class="n">OMAP_WDT_TIMER_MODE</span><span class="p">);</span>
	<span class="n">omap_writel</span><span class="p">(</span><span class="mh">0x00A0</span><span class="p">,</span> <span class="n">OMAP_WDT_TIMER_MODE</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Step 6b: ARM and Traffic controller shutdown</span>
<span class="cm">	 *</span>
<span class="cm">	 * Step 6 continues here. Prepare jump to power management</span>
<span class="cm">	 * assembly code in internal SRAM.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Since the omap_cpu_suspend routine has been copied to</span>
<span class="cm">	 * SRAM, we&#39;ll do an indirect procedure call to it and pass the</span>
<span class="cm">	 * contents of arm_idlect1 and arm_idlect2 so it can restore</span>
<span class="cm">	 * them when it wakes up and it will return.</span>
<span class="cm">	 */</span>

	<span class="n">arg0</span> <span class="o">=</span> <span class="n">arm_sleep_save</span><span class="p">[</span><span class="n">ARM_SLEEP_SAVE_ARM_IDLECT1</span><span class="p">];</span>
	<span class="n">arg1</span> <span class="o">=</span> <span class="n">arm_sleep_save</span><span class="p">[</span><span class="n">ARM_SLEEP_SAVE_ARM_IDLECT2</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * Step 6c: ARM and Traffic controller shutdown</span>
<span class="cm">	 *</span>
<span class="cm">	 * Jump to assembly code. The processor will stay there</span>
<span class="cm">	 * until wake up.</span>
<span class="cm">	 */</span>
	<span class="n">omap_sram_suspend</span><span class="p">(</span><span class="n">arg0</span><span class="p">,</span> <span class="n">arg1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we are here, processor is woken up!</span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Restore DSP clocks</span>
<span class="cm">	 */</span>

	<span class="cm">/* again temporarily enabling api_ck to access DSP registers */</span>
	<span class="n">omap_writew</span><span class="p">(</span><span class="n">omap_readw</span><span class="p">(</span><span class="n">ARM_IDLECT2</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">EN_APICK</span><span class="p">,</span> <span class="n">ARM_IDLECT2</span><span class="p">);</span>

	<span class="cm">/* Restore DSP domain clocks */</span>
	<span class="n">DSP_RESTORE</span><span class="p">(</span><span class="n">DSP_IDLECT2</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Restore ARM state, except ARM_IDLECT1/2 which omap_cpu_suspend did</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cpu_is_omap15xx</span><span class="p">()))</span>
		<span class="n">ARM_RESTORE</span><span class="p">(</span><span class="n">ARM_IDLECT3</span><span class="p">);</span>
	<span class="n">ARM_RESTORE</span><span class="p">(</span><span class="n">ARM_CKCTL</span><span class="p">);</span>
	<span class="n">ARM_RESTORE</span><span class="p">(</span><span class="n">ARM_EWUPCT</span><span class="p">);</span>
	<span class="n">ARM_RESTORE</span><span class="p">(</span><span class="n">ARM_RSTCT1</span><span class="p">);</span>
	<span class="n">ARM_RESTORE</span><span class="p">(</span><span class="n">ARM_RSTCT2</span><span class="p">);</span>
	<span class="n">ARM_RESTORE</span><span class="p">(</span><span class="n">ARM_SYSST</span><span class="p">);</span>
	<span class="n">ULPD_RESTORE</span><span class="p">(</span><span class="n">ULPD_CLOCK_CTRL</span><span class="p">);</span>
	<span class="n">ULPD_RESTORE</span><span class="p">(</span><span class="n">ULPD_STATUS_REQ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap7xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">MPUI7XX_RESTORE</span><span class="p">(</span><span class="n">EMIFS_CONFIG</span><span class="p">);</span>
		<span class="n">MPUI7XX_RESTORE</span><span class="p">(</span><span class="n">EMIFF_SDRAM_CONFIG</span><span class="p">);</span>
		<span class="n">MPUI7XX_RESTORE</span><span class="p">(</span><span class="n">OMAP_IH1_MIR</span><span class="p">);</span>
		<span class="n">MPUI7XX_RESTORE</span><span class="p">(</span><span class="n">OMAP_IH2_0_MIR</span><span class="p">);</span>
		<span class="n">MPUI7XX_RESTORE</span><span class="p">(</span><span class="n">OMAP_IH2_1_MIR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap15xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">MPUI1510_RESTORE</span><span class="p">(</span><span class="n">MPUI_CTRL</span><span class="p">);</span>
		<span class="n">MPUI1510_RESTORE</span><span class="p">(</span><span class="n">MPUI_DSP_BOOT_CONFIG</span><span class="p">);</span>
		<span class="n">MPUI1510_RESTORE</span><span class="p">(</span><span class="n">MPUI_DSP_API_CONFIG</span><span class="p">);</span>
		<span class="n">MPUI1510_RESTORE</span><span class="p">(</span><span class="n">EMIFS_CONFIG</span><span class="p">);</span>
		<span class="n">MPUI1510_RESTORE</span><span class="p">(</span><span class="n">EMIFF_SDRAM_CONFIG</span><span class="p">);</span>
		<span class="n">MPUI1510_RESTORE</span><span class="p">(</span><span class="n">OMAP_IH1_MIR</span><span class="p">);</span>
		<span class="n">MPUI1510_RESTORE</span><span class="p">(</span><span class="n">OMAP_IH2_MIR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap16xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">MPUI1610_RESTORE</span><span class="p">(</span><span class="n">MPUI_CTRL</span><span class="p">);</span>
		<span class="n">MPUI1610_RESTORE</span><span class="p">(</span><span class="n">MPUI_DSP_BOOT_CONFIG</span><span class="p">);</span>
		<span class="n">MPUI1610_RESTORE</span><span class="p">(</span><span class="n">MPUI_DSP_API_CONFIG</span><span class="p">);</span>
		<span class="n">MPUI1610_RESTORE</span><span class="p">(</span><span class="n">EMIFS_CONFIG</span><span class="p">);</span>
		<span class="n">MPUI1610_RESTORE</span><span class="p">(</span><span class="n">EMIFF_SDRAM_CONFIG</span><span class="p">);</span>

		<span class="n">MPUI1610_RESTORE</span><span class="p">(</span><span class="n">OMAP_IH1_MIR</span><span class="p">);</span>
		<span class="n">MPUI1610_RESTORE</span><span class="p">(</span><span class="n">OMAP_IH2_0_MIR</span><span class="p">);</span>
		<span class="n">MPUI1610_RESTORE</span><span class="p">(</span><span class="n">OMAP_IH2_1_MIR</span><span class="p">);</span>
		<span class="n">MPUI1610_RESTORE</span><span class="p">(</span><span class="n">OMAP_IH2_2_MIR</span><span class="p">);</span>
		<span class="n">MPUI1610_RESTORE</span><span class="p">(</span><span class="n">OMAP_IH2_3_MIR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_is_omap15xx</span><span class="p">())</span>
		<span class="n">omap_writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ULPD_SOFT_DISABLE_REQ_REG</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Re-enable interrupts</span>
<span class="cm">	 */</span>

	<span class="n">local_irq_enable</span><span class="p">();</span>
	<span class="n">local_fiq_enable</span><span class="p">();</span>

	<span class="n">omap_serial_wake_trigger</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PM: OMAP%x is re-starting from deep sleep...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">omap_rev</span><span class="p">());</span>
<span class="p">}</span>

<span class="cp">#if defined(DEBUG) &amp;&amp; defined(CONFIG_PROC_FS)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">g_read_completed</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Read system PM registers for debugging</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_pm_read_proc</span><span class="p">(</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">page_buffer</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">**</span><span class="n">my_first_byte</span><span class="p">,</span>
	<span class="kt">off_t</span> <span class="n">virtual_start</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">length</span><span class="p">,</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">eof</span><span class="p">,</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">my_buffer_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">my_base</span> <span class="o">=</span> <span class="n">page_buffer</span><span class="p">;</span>

	<span class="n">ARM_SAVE</span><span class="p">(</span><span class="n">ARM_CKCTL</span><span class="p">);</span>
	<span class="n">ARM_SAVE</span><span class="p">(</span><span class="n">ARM_IDLECT1</span><span class="p">);</span>
	<span class="n">ARM_SAVE</span><span class="p">(</span><span class="n">ARM_IDLECT2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cpu_is_omap15xx</span><span class="p">()))</span>
		<span class="n">ARM_SAVE</span><span class="p">(</span><span class="n">ARM_IDLECT3</span><span class="p">);</span>
	<span class="n">ARM_SAVE</span><span class="p">(</span><span class="n">ARM_EWUPCT</span><span class="p">);</span>
	<span class="n">ARM_SAVE</span><span class="p">(</span><span class="n">ARM_RSTCT1</span><span class="p">);</span>
	<span class="n">ARM_SAVE</span><span class="p">(</span><span class="n">ARM_RSTCT2</span><span class="p">);</span>
	<span class="n">ARM_SAVE</span><span class="p">(</span><span class="n">ARM_SYSST</span><span class="p">);</span>

	<span class="n">ULPD_SAVE</span><span class="p">(</span><span class="n">ULPD_IT_STATUS</span><span class="p">);</span>
	<span class="n">ULPD_SAVE</span><span class="p">(</span><span class="n">ULPD_CLOCK_CTRL</span><span class="p">);</span>
	<span class="n">ULPD_SAVE</span><span class="p">(</span><span class="n">ULPD_SOFT_REQ</span><span class="p">);</span>
	<span class="n">ULPD_SAVE</span><span class="p">(</span><span class="n">ULPD_STATUS_REQ</span><span class="p">);</span>
	<span class="n">ULPD_SAVE</span><span class="p">(</span><span class="n">ULPD_DPLL_CTRL</span><span class="p">);</span>
	<span class="n">ULPD_SAVE</span><span class="p">(</span><span class="n">ULPD_POWER_CTRL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap7xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">MPUI7XX_SAVE</span><span class="p">(</span><span class="n">MPUI_CTRL</span><span class="p">);</span>
		<span class="n">MPUI7XX_SAVE</span><span class="p">(</span><span class="n">MPUI_DSP_STATUS</span><span class="p">);</span>
		<span class="n">MPUI7XX_SAVE</span><span class="p">(</span><span class="n">MPUI_DSP_BOOT_CONFIG</span><span class="p">);</span>
		<span class="n">MPUI7XX_SAVE</span><span class="p">(</span><span class="n">MPUI_DSP_API_CONFIG</span><span class="p">);</span>
		<span class="n">MPUI7XX_SAVE</span><span class="p">(</span><span class="n">EMIFF_SDRAM_CONFIG</span><span class="p">);</span>
		<span class="n">MPUI7XX_SAVE</span><span class="p">(</span><span class="n">EMIFS_CONFIG</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap15xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">MPUI1510_SAVE</span><span class="p">(</span><span class="n">MPUI_CTRL</span><span class="p">);</span>
		<span class="n">MPUI1510_SAVE</span><span class="p">(</span><span class="n">MPUI_DSP_STATUS</span><span class="p">);</span>
		<span class="n">MPUI1510_SAVE</span><span class="p">(</span><span class="n">MPUI_DSP_BOOT_CONFIG</span><span class="p">);</span>
		<span class="n">MPUI1510_SAVE</span><span class="p">(</span><span class="n">MPUI_DSP_API_CONFIG</span><span class="p">);</span>
		<span class="n">MPUI1510_SAVE</span><span class="p">(</span><span class="n">EMIFF_SDRAM_CONFIG</span><span class="p">);</span>
		<span class="n">MPUI1510_SAVE</span><span class="p">(</span><span class="n">EMIFS_CONFIG</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap16xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">MPUI1610_SAVE</span><span class="p">(</span><span class="n">MPUI_CTRL</span><span class="p">);</span>
		<span class="n">MPUI1610_SAVE</span><span class="p">(</span><span class="n">MPUI_DSP_STATUS</span><span class="p">);</span>
		<span class="n">MPUI1610_SAVE</span><span class="p">(</span><span class="n">MPUI_DSP_BOOT_CONFIG</span><span class="p">);</span>
		<span class="n">MPUI1610_SAVE</span><span class="p">(</span><span class="n">MPUI_DSP_API_CONFIG</span><span class="p">);</span>
		<span class="n">MPUI1610_SAVE</span><span class="p">(</span><span class="n">EMIFF_SDRAM_CONFIG</span><span class="p">);</span>
		<span class="n">MPUI1610_SAVE</span><span class="p">(</span><span class="n">EMIFS_CONFIG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">virtual_start</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">g_read_completed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">my_buffer_offset</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">my_base</span> <span class="o">+</span> <span class="n">my_buffer_offset</span><span class="p">,</span>
		   <span class="s">&quot;ARM_CKCTL_REG:            0x%-8x     </span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;ARM_IDLECT1_REG:          0x%-8x     </span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;ARM_IDLECT2_REG:          0x%-8x     </span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;ARM_IDLECT3_REG:	      0x%-8x     </span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;ARM_EWUPCT_REG:           0x%-8x     </span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;ARM_RSTCT1_REG:           0x%-8x     </span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;ARM_RSTCT2_REG:           0x%-8x     </span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;ARM_SYSST_REG:            0x%-8x     </span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;ULPD_IT_STATUS_REG:       0x%-4x     </span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;ULPD_CLOCK_CTRL_REG:      0x%-4x     </span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;ULPD_SOFT_REQ_REG:        0x%-4x     </span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;ULPD_DPLL_CTRL_REG:       0x%-4x     </span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;ULPD_STATUS_REQ_REG:      0x%-4x     </span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;ULPD_POWER_CTRL_REG:      0x%-4x     </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">ARM_SHOW</span><span class="p">(</span><span class="n">ARM_CKCTL</span><span class="p">),</span>
		   <span class="n">ARM_SHOW</span><span class="p">(</span><span class="n">ARM_IDLECT1</span><span class="p">),</span>
		   <span class="n">ARM_SHOW</span><span class="p">(</span><span class="n">ARM_IDLECT2</span><span class="p">),</span>
		   <span class="n">ARM_SHOW</span><span class="p">(</span><span class="n">ARM_IDLECT3</span><span class="p">),</span>
		   <span class="n">ARM_SHOW</span><span class="p">(</span><span class="n">ARM_EWUPCT</span><span class="p">),</span>
		   <span class="n">ARM_SHOW</span><span class="p">(</span><span class="n">ARM_RSTCT1</span><span class="p">),</span>
		   <span class="n">ARM_SHOW</span><span class="p">(</span><span class="n">ARM_RSTCT2</span><span class="p">),</span>
		   <span class="n">ARM_SHOW</span><span class="p">(</span><span class="n">ARM_SYSST</span><span class="p">),</span>
		   <span class="n">ULPD_SHOW</span><span class="p">(</span><span class="n">ULPD_IT_STATUS</span><span class="p">),</span>
		   <span class="n">ULPD_SHOW</span><span class="p">(</span><span class="n">ULPD_CLOCK_CTRL</span><span class="p">),</span>
		   <span class="n">ULPD_SHOW</span><span class="p">(</span><span class="n">ULPD_SOFT_REQ</span><span class="p">),</span>
		   <span class="n">ULPD_SHOW</span><span class="p">(</span><span class="n">ULPD_DPLL_CTRL</span><span class="p">),</span>
		   <span class="n">ULPD_SHOW</span><span class="p">(</span><span class="n">ULPD_STATUS_REQ</span><span class="p">),</span>
		   <span class="n">ULPD_SHOW</span><span class="p">(</span><span class="n">ULPD_POWER_CTRL</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap7xx</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">my_buffer_offset</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">my_base</span> <span class="o">+</span> <span class="n">my_buffer_offset</span><span class="p">,</span>
			   <span class="s">&quot;MPUI7XX_CTRL_REG	     0x%-8x </span><span class="se">\n</span><span class="s">&quot;</span>
			   <span class="s">&quot;MPUI7XX_DSP_STATUS_REG:      0x%-8x </span><span class="se">\n</span><span class="s">&quot;</span>
			   <span class="s">&quot;MPUI7XX_DSP_BOOT_CONFIG_REG: 0x%-8x </span><span class="se">\n</span><span class="s">&quot;</span>
			   <span class="s">&quot;MPUI7XX_DSP_API_CONFIG_REG:  0x%-8x </span><span class="se">\n</span><span class="s">&quot;</span>
			   <span class="s">&quot;MPUI7XX_SDRAM_CONFIG_REG:    0x%-8x </span><span class="se">\n</span><span class="s">&quot;</span>
			   <span class="s">&quot;MPUI7XX_EMIFS_CONFIG_REG:    0x%-8x </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">MPUI7XX_SHOW</span><span class="p">(</span><span class="n">MPUI_CTRL</span><span class="p">),</span>
			   <span class="n">MPUI7XX_SHOW</span><span class="p">(</span><span class="n">MPUI_DSP_STATUS</span><span class="p">),</span>
			   <span class="n">MPUI7XX_SHOW</span><span class="p">(</span><span class="n">MPUI_DSP_BOOT_CONFIG</span><span class="p">),</span>
			   <span class="n">MPUI7XX_SHOW</span><span class="p">(</span><span class="n">MPUI_DSP_API_CONFIG</span><span class="p">),</span>
			   <span class="n">MPUI7XX_SHOW</span><span class="p">(</span><span class="n">EMIFF_SDRAM_CONFIG</span><span class="p">),</span>
			   <span class="n">MPUI7XX_SHOW</span><span class="p">(</span><span class="n">EMIFS_CONFIG</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap15xx</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">my_buffer_offset</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">my_base</span> <span class="o">+</span> <span class="n">my_buffer_offset</span><span class="p">,</span>
			   <span class="s">&quot;MPUI1510_CTRL_REG             0x%-8x </span><span class="se">\n</span><span class="s">&quot;</span>
			   <span class="s">&quot;MPUI1510_DSP_STATUS_REG:      0x%-8x </span><span class="se">\n</span><span class="s">&quot;</span>
			   <span class="s">&quot;MPUI1510_DSP_BOOT_CONFIG_REG: 0x%-8x </span><span class="se">\n</span><span class="s">&quot;</span>
			   <span class="s">&quot;MPUI1510_DSP_API_CONFIG_REG:  0x%-8x </span><span class="se">\n</span><span class="s">&quot;</span>
			   <span class="s">&quot;MPUI1510_SDRAM_CONFIG_REG:    0x%-8x </span><span class="se">\n</span><span class="s">&quot;</span>
			   <span class="s">&quot;MPUI1510_EMIFS_CONFIG_REG:    0x%-8x </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">MPUI1510_SHOW</span><span class="p">(</span><span class="n">MPUI_CTRL</span><span class="p">),</span>
			   <span class="n">MPUI1510_SHOW</span><span class="p">(</span><span class="n">MPUI_DSP_STATUS</span><span class="p">),</span>
			   <span class="n">MPUI1510_SHOW</span><span class="p">(</span><span class="n">MPUI_DSP_BOOT_CONFIG</span><span class="p">),</span>
			   <span class="n">MPUI1510_SHOW</span><span class="p">(</span><span class="n">MPUI_DSP_API_CONFIG</span><span class="p">),</span>
			   <span class="n">MPUI1510_SHOW</span><span class="p">(</span><span class="n">EMIFF_SDRAM_CONFIG</span><span class="p">),</span>
			   <span class="n">MPUI1510_SHOW</span><span class="p">(</span><span class="n">EMIFS_CONFIG</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap16xx</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">my_buffer_offset</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">my_base</span> <span class="o">+</span> <span class="n">my_buffer_offset</span><span class="p">,</span>
			   <span class="s">&quot;MPUI1610_CTRL_REG             0x%-8x </span><span class="se">\n</span><span class="s">&quot;</span>
			   <span class="s">&quot;MPUI1610_DSP_STATUS_REG:      0x%-8x </span><span class="se">\n</span><span class="s">&quot;</span>
			   <span class="s">&quot;MPUI1610_DSP_BOOT_CONFIG_REG: 0x%-8x </span><span class="se">\n</span><span class="s">&quot;</span>
			   <span class="s">&quot;MPUI1610_DSP_API_CONFIG_REG:  0x%-8x </span><span class="se">\n</span><span class="s">&quot;</span>
			   <span class="s">&quot;MPUI1610_SDRAM_CONFIG_REG:    0x%-8x </span><span class="se">\n</span><span class="s">&quot;</span>
			   <span class="s">&quot;MPUI1610_EMIFS_CONFIG_REG:    0x%-8x </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">MPUI1610_SHOW</span><span class="p">(</span><span class="n">MPUI_CTRL</span><span class="p">),</span>
			   <span class="n">MPUI1610_SHOW</span><span class="p">(</span><span class="n">MPUI_DSP_STATUS</span><span class="p">),</span>
			   <span class="n">MPUI1610_SHOW</span><span class="p">(</span><span class="n">MPUI_DSP_BOOT_CONFIG</span><span class="p">),</span>
			   <span class="n">MPUI1610_SHOW</span><span class="p">(</span><span class="n">MPUI_DSP_API_CONFIG</span><span class="p">),</span>
			   <span class="n">MPUI1610_SHOW</span><span class="p">(</span><span class="n">EMIFF_SDRAM_CONFIG</span><span class="p">),</span>
			   <span class="n">MPUI1610_SHOW</span><span class="p">(</span><span class="n">EMIFS_CONFIG</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="n">g_read_completed</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">g_read_completed</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		 <span class="o">*</span><span class="n">eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		 <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">g_read_completed</span><span class="o">++</span><span class="p">;</span>

	<span class="o">*</span><span class="n">my_first_byte</span> <span class="o">=</span> <span class="n">page_buffer</span><span class="p">;</span>
	<span class="k">return</span>  <span class="n">my_buffer_offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_pm_init_proc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* XXX Appears to leak memory */</span>
	<span class="n">create_proc_read_entry</span><span class="p">(</span><span class="s">&quot;driver/omap_pm&quot;</span><span class="p">,</span>
			       <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			       <span class="n">omap_pm_read_proc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* DEBUG &amp;&amp; CONFIG_PROC_FS */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> *	omap_pm_prepare - Do preliminary suspend work.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_pm_prepare</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* We cannot sleep in idle until we have resumed */</span>
	<span class="n">disable_hlt</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	omap_pm_enter - Actually enter a sleep state.</span>
<span class="cm"> *	@state:		State we&#39;re entering.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_pm_enter</span><span class="p">(</span><span class="n">suspend_state_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">PM_SUSPEND_STANDBY</span>:
	<span class="k">case</span> <span class="n">PM_SUSPEND_MEM</span>:
		<span class="n">omap1_pm_suspend</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> *	omap_pm_finish - Finish up suspend sequence.</span>
<span class="cm"> *</span>
<span class="cm"> *	This is called after we wake back up (or if entering the sleep state</span>
<span class="cm"> *	failed).</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_pm_finish</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">enable_hlt</span><span class="p">();</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">omap_wakeup_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irqaction</span> <span class="n">omap_wakeup_irq</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;peripheral wakeup&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IRQF_DISABLED</span><span class="p">,</span>
	<span class="p">.</span><span class="n">handler</span>	<span class="o">=</span> <span class="n">omap_wakeup_interrupt</span>
<span class="p">};</span>



<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">platform_suspend_ops</span> <span class="n">omap_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">prepare</span>	<span class="o">=</span> <span class="n">omap_pm_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enter</span>		<span class="o">=</span> <span class="n">omap_pm_enter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">finish</span>		<span class="o">=</span> <span class="n">omap_pm_finish</span><span class="p">,</span>
	<span class="p">.</span><span class="n">valid</span>		<span class="o">=</span> <span class="n">suspend_valid_only_mem</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">omap_pm_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>

<span class="cp">#ifdef CONFIG_OMAP_32K_TIMER</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_class_is_omap1</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Power Management for TI OMAP.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We copy the assembler sleep/wakeup routines to SRAM.</span>
<span class="cm">	 * These routines need to be in SRAM as that&#39;s the only</span>
<span class="cm">	 * memory the MPU can see when it wakes up.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap7xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">omap_sram_suspend</span> <span class="o">=</span> <span class="n">omap_sram_push</span><span class="p">(</span><span class="n">omap7xx_cpu_suspend</span><span class="p">,</span>
						   <span class="n">omap7xx_cpu_suspend_sz</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap15xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">omap_sram_suspend</span> <span class="o">=</span> <span class="n">omap_sram_push</span><span class="p">(</span><span class="n">omap1510_cpu_suspend</span><span class="p">,</span>
						   <span class="n">omap1510_cpu_suspend_sz</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap16xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">omap_sram_suspend</span> <span class="o">=</span> <span class="n">omap_sram_push</span><span class="p">(</span><span class="n">omap1610_cpu_suspend</span><span class="p">,</span>
						   <span class="n">omap1610_cpu_suspend_sz</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">omap_sram_suspend</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;PM not initialized: Missing SRAM support</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">arm_pm_idle</span> <span class="o">=</span> <span class="n">omap1_pm_idle</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap7xx</span><span class="p">())</span>
		<span class="n">setup_irq</span><span class="p">(</span><span class="n">INT_7XX_WAKE_UP_REQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">omap_wakeup_irq</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap16xx</span><span class="p">())</span>
		<span class="n">setup_irq</span><span class="p">(</span><span class="n">INT_1610_WAKE_UP_REQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">omap_wakeup_irq</span><span class="p">);</span>

	<span class="cm">/* Program new power ramp-up time</span>
<span class="cm">	 * (0 for most boards since we don&#39;t lower voltage when in deep sleep)</span>
<span class="cm">	 */</span>
	<span class="n">omap_writew</span><span class="p">(</span><span class="n">ULPD_SETUP_ANALOG_CELL_3_VAL</span><span class="p">,</span> <span class="n">ULPD_SETUP_ANALOG_CELL_3</span><span class="p">);</span>

	<span class="cm">/* Setup ULPD POWER_CTRL_REG - enter deep sleep whenever possible */</span>
	<span class="n">omap_writew</span><span class="p">(</span><span class="n">ULPD_POWER_CTRL_REG_VAL</span><span class="p">,</span> <span class="n">ULPD_POWER_CTRL</span><span class="p">);</span>

	<span class="cm">/* Configure IDLECT3 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap7xx</span><span class="p">())</span>
		<span class="n">omap_writel</span><span class="p">(</span><span class="n">OMAP7XX_IDLECT3_VAL</span><span class="p">,</span> <span class="n">OMAP7XX_IDLECT3</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap16xx</span><span class="p">())</span>
		<span class="n">omap_writel</span><span class="p">(</span><span class="n">OMAP1610_IDLECT3_VAL</span><span class="p">,</span> <span class="n">OMAP1610_IDLECT3</span><span class="p">);</span>

	<span class="n">suspend_set_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_pm_ops</span><span class="p">);</span>

<span class="cp">#if defined(DEBUG) &amp;&amp; defined(CONFIG_PROC_FS)</span>
	<span class="n">omap_pm_init_proc</span><span class="p">();</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_OMAP_32K_TIMER</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">sysfs_create_file</span><span class="p">(</span><span class="n">power_kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sleep_while_idle_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sysfs_create_file failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap16xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="cm">/* configure LOW_PWR pin */</span>
		<span class="n">omap_cfg_reg</span><span class="p">(</span><span class="n">T20_1610_LOW_PWR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">__initcall</span><span class="p">(</span><span class="n">omap_pm_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
