<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › mach-tegra › usb_phy.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>usb_phy.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * arch/arm/mach-tegra/usb_phy.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2010 Google, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Author:</span>
<span class="cm"> *	Erik Gilling &lt;konkers@google.com&gt;</span>
<span class="cm"> *	Benoit Goby &lt;benoit@android.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This software is licensed under the terms of the GNU General Public</span>
<span class="cm"> * License version 2, as published by the Free Software Foundation, and</span>
<span class="cm"> * may be copied, distributed, and modified under those terms.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/resource.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/of_gpio.h&gt;</span>
<span class="cp">#include &lt;linux/usb/otg.h&gt;</span>
<span class="cp">#include &lt;linux/usb/ulpi.h&gt;</span>
<span class="cp">#include &lt;asm/mach-types.h&gt;</span>
<span class="cp">#include &lt;mach/gpio-tegra.h&gt;</span>
<span class="cp">#include &lt;mach/usb_phy.h&gt;</span>
<span class="cp">#include &lt;mach/iomap.h&gt;</span>

<span class="cp">#define ULPI_VIEWPORT		0x170</span>

<span class="cp">#define USB_PORTSC1		0x184</span>
<span class="cp">#define   USB_PORTSC1_PTS(x)	(((x) &amp; 0x3) &lt;&lt; 30)</span>
<span class="cp">#define   USB_PORTSC1_PSPD(x)	(((x) &amp; 0x3) &lt;&lt; 26)</span>
<span class="cp">#define   USB_PORTSC1_PHCD	(1 &lt;&lt; 23)</span>
<span class="cp">#define   USB_PORTSC1_WKOC	(1 &lt;&lt; 22)</span>
<span class="cp">#define   USB_PORTSC1_WKDS	(1 &lt;&lt; 21)</span>
<span class="cp">#define   USB_PORTSC1_WKCN	(1 &lt;&lt; 20)</span>
<span class="cp">#define   USB_PORTSC1_PTC(x)	(((x) &amp; 0xf) &lt;&lt; 16)</span>
<span class="cp">#define   USB_PORTSC1_PP	(1 &lt;&lt; 12)</span>
<span class="cp">#define   USB_PORTSC1_SUSP	(1 &lt;&lt; 7)</span>
<span class="cp">#define   USB_PORTSC1_PE	(1 &lt;&lt; 2)</span>
<span class="cp">#define   USB_PORTSC1_CCS	(1 &lt;&lt; 0)</span>

<span class="cp">#define USB_SUSP_CTRL		0x400</span>
<span class="cp">#define   USB_WAKE_ON_CNNT_EN_DEV	(1 &lt;&lt; 3)</span>
<span class="cp">#define   USB_WAKE_ON_DISCON_EN_DEV	(1 &lt;&lt; 4)</span>
<span class="cp">#define   USB_SUSP_CLR		(1 &lt;&lt; 5)</span>
<span class="cp">#define   USB_PHY_CLK_VALID	(1 &lt;&lt; 7)</span>
<span class="cp">#define   UTMIP_RESET			(1 &lt;&lt; 11)</span>
<span class="cp">#define   UHSIC_RESET			(1 &lt;&lt; 11)</span>
<span class="cp">#define   UTMIP_PHY_ENABLE		(1 &lt;&lt; 12)</span>
<span class="cp">#define   ULPI_PHY_ENABLE	(1 &lt;&lt; 13)</span>
<span class="cp">#define   USB_SUSP_SET		(1 &lt;&lt; 14)</span>
<span class="cp">#define   USB_WAKEUP_DEBOUNCE_COUNT(x)	(((x) &amp; 0x7) &lt;&lt; 16)</span>

<span class="cp">#define USB1_LEGACY_CTRL	0x410</span>
<span class="cp">#define   USB1_NO_LEGACY_MODE			(1 &lt;&lt; 0)</span>
<span class="cp">#define   USB1_VBUS_SENSE_CTL_MASK		(3 &lt;&lt; 1)</span>
<span class="cp">#define   USB1_VBUS_SENSE_CTL_VBUS_WAKEUP	(0 &lt;&lt; 1)</span>
<span class="cp">#define   USB1_VBUS_SENSE_CTL_AB_SESS_VLD_OR_VBUS_WAKEUP \</span>
<span class="cp">						(1 &lt;&lt; 1)</span>
<span class="cp">#define   USB1_VBUS_SENSE_CTL_AB_SESS_VLD	(2 &lt;&lt; 1)</span>
<span class="cp">#define   USB1_VBUS_SENSE_CTL_A_SESS_VLD	(3 &lt;&lt; 1)</span>

<span class="cp">#define ULPI_TIMING_CTRL_0	0x424</span>
<span class="cp">#define   ULPI_OUTPUT_PINMUX_BYP	(1 &lt;&lt; 10)</span>
<span class="cp">#define   ULPI_CLKOUT_PINMUX_BYP	(1 &lt;&lt; 11)</span>

<span class="cp">#define ULPI_TIMING_CTRL_1	0x428</span>
<span class="cp">#define   ULPI_DATA_TRIMMER_LOAD	(1 &lt;&lt; 0)</span>
<span class="cp">#define   ULPI_DATA_TRIMMER_SEL(x)	(((x) &amp; 0x7) &lt;&lt; 1)</span>
<span class="cp">#define   ULPI_STPDIRNXT_TRIMMER_LOAD	(1 &lt;&lt; 16)</span>
<span class="cp">#define   ULPI_STPDIRNXT_TRIMMER_SEL(x)	(((x) &amp; 0x7) &lt;&lt; 17)</span>
<span class="cp">#define   ULPI_DIR_TRIMMER_LOAD		(1 &lt;&lt; 24)</span>
<span class="cp">#define   ULPI_DIR_TRIMMER_SEL(x)	(((x) &amp; 0x7) &lt;&lt; 25)</span>

<span class="cp">#define UTMIP_PLL_CFG1		0x804</span>
<span class="cp">#define   UTMIP_XTAL_FREQ_COUNT(x)		(((x) &amp; 0xfff) &lt;&lt; 0)</span>
<span class="cp">#define   UTMIP_PLLU_ENABLE_DLY_COUNT(x)	(((x) &amp; 0x1f) &lt;&lt; 27)</span>

<span class="cp">#define UTMIP_XCVR_CFG0		0x808</span>
<span class="cp">#define   UTMIP_XCVR_SETUP(x)			(((x) &amp; 0xf) &lt;&lt; 0)</span>
<span class="cp">#define   UTMIP_XCVR_LSRSLEW(x)			(((x) &amp; 0x3) &lt;&lt; 8)</span>
<span class="cp">#define   UTMIP_XCVR_LSFSLEW(x)			(((x) &amp; 0x3) &lt;&lt; 10)</span>
<span class="cp">#define   UTMIP_FORCE_PD_POWERDOWN		(1 &lt;&lt; 14)</span>
<span class="cp">#define   UTMIP_FORCE_PD2_POWERDOWN		(1 &lt;&lt; 16)</span>
<span class="cp">#define   UTMIP_FORCE_PDZI_POWERDOWN		(1 &lt;&lt; 18)</span>
<span class="cp">#define   UTMIP_XCVR_HSSLEW_MSB(x)		(((x) &amp; 0x7f) &lt;&lt; 25)</span>

<span class="cp">#define UTMIP_BIAS_CFG0		0x80c</span>
<span class="cp">#define   UTMIP_OTGPD			(1 &lt;&lt; 11)</span>
<span class="cp">#define   UTMIP_BIASPD			(1 &lt;&lt; 10)</span>

<span class="cp">#define UTMIP_HSRX_CFG0		0x810</span>
<span class="cp">#define   UTMIP_ELASTIC_LIMIT(x)	(((x) &amp; 0x1f) &lt;&lt; 10)</span>
<span class="cp">#define   UTMIP_IDLE_WAIT(x)		(((x) &amp; 0x1f) &lt;&lt; 15)</span>

<span class="cp">#define UTMIP_HSRX_CFG1		0x814</span>
<span class="cp">#define   UTMIP_HS_SYNC_START_DLY(x)	(((x) &amp; 0x1f) &lt;&lt; 1)</span>

<span class="cp">#define UTMIP_TX_CFG0		0x820</span>
<span class="cp">#define   UTMIP_FS_PREABMLE_J		(1 &lt;&lt; 19)</span>
<span class="cp">#define   UTMIP_HS_DISCON_DISABLE	(1 &lt;&lt; 8)</span>

<span class="cp">#define UTMIP_MISC_CFG0		0x824</span>
<span class="cp">#define   UTMIP_DPDM_OBSERVE		(1 &lt;&lt; 26)</span>
<span class="cp">#define   UTMIP_DPDM_OBSERVE_SEL(x)	(((x) &amp; 0xf) &lt;&lt; 27)</span>
<span class="cp">#define   UTMIP_DPDM_OBSERVE_SEL_FS_J	UTMIP_DPDM_OBSERVE_SEL(0xf)</span>
<span class="cp">#define   UTMIP_DPDM_OBSERVE_SEL_FS_K	UTMIP_DPDM_OBSERVE_SEL(0xe)</span>
<span class="cp">#define   UTMIP_DPDM_OBSERVE_SEL_FS_SE1 UTMIP_DPDM_OBSERVE_SEL(0xd)</span>
<span class="cp">#define   UTMIP_DPDM_OBSERVE_SEL_FS_SE0 UTMIP_DPDM_OBSERVE_SEL(0xc)</span>
<span class="cp">#define   UTMIP_SUSPEND_EXIT_ON_EDGE	(1 &lt;&lt; 22)</span>

<span class="cp">#define UTMIP_MISC_CFG1		0x828</span>
<span class="cp">#define   UTMIP_PLL_ACTIVE_DLY_COUNT(x)	(((x) &amp; 0x1f) &lt;&lt; 18)</span>
<span class="cp">#define   UTMIP_PLLU_STABLE_COUNT(x)	(((x) &amp; 0xfff) &lt;&lt; 6)</span>

<span class="cp">#define UTMIP_DEBOUNCE_CFG0	0x82c</span>
<span class="cp">#define   UTMIP_BIAS_DEBOUNCE_A(x)	(((x) &amp; 0xffff) &lt;&lt; 0)</span>

<span class="cp">#define UTMIP_BAT_CHRG_CFG0	0x830</span>
<span class="cp">#define   UTMIP_PD_CHRG			(1 &lt;&lt; 0)</span>

<span class="cp">#define UTMIP_SPARE_CFG0	0x834</span>
<span class="cp">#define   FUSE_SETUP_SEL		(1 &lt;&lt; 3)</span>

<span class="cp">#define UTMIP_XCVR_CFG1		0x838</span>
<span class="cp">#define   UTMIP_FORCE_PDDISC_POWERDOWN	(1 &lt;&lt; 0)</span>
<span class="cp">#define   UTMIP_FORCE_PDCHRP_POWERDOWN	(1 &lt;&lt; 2)</span>
<span class="cp">#define   UTMIP_FORCE_PDDR_POWERDOWN	(1 &lt;&lt; 4)</span>
<span class="cp">#define   UTMIP_XCVR_TERM_RANGE_ADJ(x)	(((x) &amp; 0xf) &lt;&lt; 18)</span>

<span class="cp">#define UTMIP_BIAS_CFG1		0x83c</span>
<span class="cp">#define   UTMIP_BIAS_PDTRK_COUNT(x)	(((x) &amp; 0x1f) &lt;&lt; 3)</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">utmip_pad_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">utmip_pad_count</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">tegra_xtal_freq</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">freq</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">enable_delay</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">stable_count</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">active_delay</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">xtal_freq_count</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">debounce</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tegra_xtal_freq</span> <span class="n">tegra_freq_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">freq</span> <span class="o">=</span> <span class="mi">12000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">enable_delay</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
		<span class="p">.</span><span class="n">stable_count</span> <span class="o">=</span> <span class="mh">0x2F</span><span class="p">,</span>
		<span class="p">.</span><span class="n">active_delay</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xtal_freq_count</span> <span class="o">=</span> <span class="mh">0x76</span><span class="p">,</span>
		<span class="p">.</span><span class="n">debounce</span> <span class="o">=</span> <span class="mh">0x7530</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">freq</span> <span class="o">=</span> <span class="mi">13000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">enable_delay</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
		<span class="p">.</span><span class="n">stable_count</span> <span class="o">=</span> <span class="mh">0x33</span><span class="p">,</span>
		<span class="p">.</span><span class="n">active_delay</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xtal_freq_count</span> <span class="o">=</span> <span class="mh">0x7F</span><span class="p">,</span>
		<span class="p">.</span><span class="n">debounce</span> <span class="o">=</span> <span class="mh">0x7EF4</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">freq</span> <span class="o">=</span> <span class="mi">19200000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">enable_delay</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
		<span class="p">.</span><span class="n">stable_count</span> <span class="o">=</span> <span class="mh">0x4B</span><span class="p">,</span>
		<span class="p">.</span><span class="n">active_delay</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xtal_freq_count</span> <span class="o">=</span> <span class="mh">0xBB</span><span class="p">,</span>
		<span class="p">.</span><span class="n">debounce</span> <span class="o">=</span> <span class="mh">0xBB80</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">freq</span> <span class="o">=</span> <span class="mi">26000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">enable_delay</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
		<span class="p">.</span><span class="n">stable_count</span> <span class="o">=</span> <span class="mh">0x66</span><span class="p">,</span>
		<span class="p">.</span><span class="n">active_delay</span> <span class="o">=</span> <span class="mh">0x09</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xtal_freq_count</span> <span class="o">=</span> <span class="mh">0xFE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">debounce</span> <span class="o">=</span> <span class="mh">0xFDE8</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tegra_utmip_config</span> <span class="n">utmip_default</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">hssync_start_delay</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
		<span class="p">.</span><span class="n">idle_wait_delay</span> <span class="o">=</span> <span class="mi">17</span><span class="p">,</span>
		<span class="p">.</span><span class="n">elastic_limit</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">term_range_adj</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xcvr_setup</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xcvr_lsfslew</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xcvr_lsrslew</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">hssync_start_delay</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
		<span class="p">.</span><span class="n">idle_wait_delay</span> <span class="o">=</span> <span class="mi">17</span><span class="p">,</span>
		<span class="p">.</span><span class="n">elastic_limit</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">term_range_adj</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xcvr_setup</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xcvr_lsfslew</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xcvr_lsrslew</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">phy_is_ulpi</span><span class="p">(</span><span class="k">struct</span> <span class="n">tegra_usb_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">instance</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">utmip_pad_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tegra_usb_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">pad_clk</span> <span class="o">=</span> <span class="n">clk_get_sys</span><span class="p">(</span><span class="s">&quot;utmip-pad&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">pad_clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: can&#39;t get utmip pad clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">pad_clk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">instance</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">pad_regs</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">pad_regs</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">TEGRA_USB_BASE</span><span class="p">,</span> <span class="n">TEGRA_USB_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">pad_regs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: can&#39;t remap usb registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">clk_put</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">pad_clk</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">utmip_pad_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">tegra_usb_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">instance</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">pad_regs</span><span class="p">);</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">pad_clk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">utmip_pad_power_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">tegra_usb_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">,</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">pad_regs</span><span class="p">;</span>

	<span class="n">clk_enable</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">pad_clk</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">utmip_pad_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">utmip_pad_count</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_BIAS_CFG0</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">UTMIP_OTGPD</span> <span class="o">|</span> <span class="n">UTMIP_BIASPD</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_BIAS_CFG0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">utmip_pad_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">clk_disable</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">pad_clk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">utmip_pad_power_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">tegra_usb_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">,</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">pad_regs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">utmip_pad_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: utmip pad already powered off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">clk_enable</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">pad_clk</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">utmip_pad_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">utmip_pad_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_BIAS_CFG0</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">UTMIP_OTGPD</span> <span class="o">|</span> <span class="n">UTMIP_BIASPD</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_BIAS_CFG0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">utmip_pad_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">clk_disable</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">pad_clk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">utmi_wait_register</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">result</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">timeout</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">utmi_phy_clk_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">tegra_usb_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">instance</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_SUSP_CTRL</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">USB_SUSP_SET</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">USB_SUSP_CTRL</span><span class="p">);</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_SUSP_CTRL</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USB_SUSP_SET</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">USB_SUSP_CTRL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">instance</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_PORTSC1</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">USB_PORTSC1_PHCD</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">USB_PORTSC1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">utmi_wait_register</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_SUSP_CTRL</span><span class="p">,</span> <span class="n">USB_PHY_CLK_VALID</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: timeout waiting for phy to stabilize</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">utmi_phy_clk_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">tegra_usb_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">instance</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_SUSP_CTRL</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">USB_SUSP_CLR</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">USB_SUSP_CTRL</span><span class="p">);</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_SUSP_CTRL</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USB_SUSP_CLR</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">USB_SUSP_CTRL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">instance</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_PORTSC1</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USB_PORTSC1_PHCD</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">USB_PORTSC1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">utmi_wait_register</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_SUSP_CTRL</span><span class="p">,</span> <span class="n">USB_PHY_CLK_VALID</span><span class="p">,</span>
						     <span class="n">USB_PHY_CLK_VALID</span><span class="p">))</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: timeout waiting for phy to stabilize</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">utmi_phy_power_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">tegra_usb_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tegra_utmip_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_SUSP_CTRL</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">UTMIP_RESET</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">USB_SUSP_CTRL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">instance</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB1_LEGACY_CTRL</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">USB1_NO_LEGACY_MODE</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">USB1_LEGACY_CTRL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_TX_CFG0</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UTMIP_FS_PREABMLE_J</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_TX_CFG0</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_HSRX_CFG0</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">UTMIP_IDLE_WAIT</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">UTMIP_ELASTIC_LIMIT</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">UTMIP_IDLE_WAIT</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">idle_wait_delay</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">UTMIP_ELASTIC_LIMIT</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">elastic_limit</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_HSRX_CFG0</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_HSRX_CFG1</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UTMIP_HS_SYNC_START_DLY</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">UTMIP_HS_SYNC_START_DLY</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">hssync_start_delay</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_HSRX_CFG1</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_DEBOUNCE_CFG0</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UTMIP_BIAS_DEBOUNCE_A</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">UTMIP_BIAS_DEBOUNCE_A</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">freq</span><span class="o">-&gt;</span><span class="n">debounce</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_DEBOUNCE_CFG0</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_MISC_CFG0</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UTMIP_SUSPEND_EXIT_ON_EDGE</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_MISC_CFG0</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_MISC_CFG1</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">UTMIP_PLL_ACTIVE_DLY_COUNT</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">UTMIP_PLLU_STABLE_COUNT</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">UTMIP_PLL_ACTIVE_DLY_COUNT</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">freq</span><span class="o">-&gt;</span><span class="n">active_delay</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">UTMIP_PLLU_STABLE_COUNT</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">freq</span><span class="o">-&gt;</span><span class="n">stable_count</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_MISC_CFG1</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_PLL_CFG1</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">UTMIP_XTAL_FREQ_COUNT</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">UTMIP_PLLU_ENABLE_DLY_COUNT</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">UTMIP_XTAL_FREQ_COUNT</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">freq</span><span class="o">-&gt;</span><span class="n">xtal_freq_count</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">UTMIP_PLLU_ENABLE_DLY_COUNT</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">freq</span><span class="o">-&gt;</span><span class="n">enable_delay</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_PLL_CFG1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">TEGRA_USB_PHY_MODE_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_SUSP_CTRL</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">USB_WAKE_ON_CNNT_EN_DEV</span> <span class="o">|</span> <span class="n">USB_WAKE_ON_DISCON_EN_DEV</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">USB_SUSP_CTRL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">utmip_pad_power_on</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_XCVR_CFG0</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">UTMIP_FORCE_PD_POWERDOWN</span> <span class="o">|</span> <span class="n">UTMIP_FORCE_PD2_POWERDOWN</span> <span class="o">|</span>
		 <span class="n">UTMIP_FORCE_PDZI_POWERDOWN</span> <span class="o">|</span> <span class="n">UTMIP_XCVR_SETUP</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		 <span class="n">UTMIP_XCVR_LSFSLEW</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">UTMIP_XCVR_LSRSLEW</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		 <span class="n">UTMIP_XCVR_HSSLEW_MSB</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">UTMIP_XCVR_SETUP</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">xcvr_setup</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">UTMIP_XCVR_LSFSLEW</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">xcvr_lsfslew</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">UTMIP_XCVR_LSRSLEW</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">xcvr_lsrslew</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_XCVR_CFG0</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_XCVR_CFG1</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">UTMIP_FORCE_PDDISC_POWERDOWN</span> <span class="o">|</span> <span class="n">UTMIP_FORCE_PDCHRP_POWERDOWN</span> <span class="o">|</span>
		 <span class="n">UTMIP_FORCE_PDDR_POWERDOWN</span> <span class="o">|</span> <span class="n">UTMIP_XCVR_TERM_RANGE_ADJ</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">UTMIP_XCVR_TERM_RANGE_ADJ</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">term_range_adj</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_XCVR_CFG1</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_BAT_CHRG_CFG0</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UTMIP_PD_CHRG</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_BAT_CHRG_CFG0</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_BIAS_CFG1</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UTMIP_BIAS_PDTRK_COUNT</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">UTMIP_BIAS_PDTRK_COUNT</span><span class="p">(</span><span class="mh">0x5</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_BIAS_CFG1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">instance</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_SPARE_CFG0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">TEGRA_USB_PHY_MODE_DEVICE</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FUSE_SETUP_SEL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">FUSE_SETUP_SEL</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_SPARE_CFG0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">instance</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_SUSP_CTRL</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">UTMIP_PHY_ENABLE</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">USB_SUSP_CTRL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_SUSP_CTRL</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UTMIP_RESET</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">USB_SUSP_CTRL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">instance</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB1_LEGACY_CTRL</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USB1_VBUS_SENSE_CTL_MASK</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">USB1_VBUS_SENSE_CTL_A_SESS_VLD</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">USB1_LEGACY_CTRL</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_SUSP_CTRL</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USB_SUSP_SET</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">USB_SUSP_CTRL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">utmi_phy_clk_enable</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">instance</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_PORTSC1</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USB_PORTSC1_PTS</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">USB_PORTSC1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">utmi_phy_power_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">tegra_usb_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>

	<span class="n">utmi_phy_clk_disable</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">TEGRA_USB_PHY_MODE_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_SUSP_CTRL</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USB_WAKEUP_DEBOUNCE_COUNT</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">USB_WAKE_ON_CNNT_EN_DEV</span> <span class="o">|</span> <span class="n">USB_WAKEUP_DEBOUNCE_COUNT</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">USB_SUSP_CTRL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_SUSP_CTRL</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">UTMIP_RESET</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">USB_SUSP_CTRL</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_BAT_CHRG_CFG0</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">UTMIP_PD_CHRG</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_BAT_CHRG_CFG0</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_XCVR_CFG0</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">UTMIP_FORCE_PD_POWERDOWN</span> <span class="o">|</span> <span class="n">UTMIP_FORCE_PD2_POWERDOWN</span> <span class="o">|</span>
	       <span class="n">UTMIP_FORCE_PDZI_POWERDOWN</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_XCVR_CFG0</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_XCVR_CFG1</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">UTMIP_FORCE_PDDISC_POWERDOWN</span> <span class="o">|</span> <span class="n">UTMIP_FORCE_PDCHRP_POWERDOWN</span> <span class="o">|</span>
	       <span class="n">UTMIP_FORCE_PDDR_POWERDOWN</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_XCVR_CFG1</span><span class="p">);</span>

	<span class="n">utmip_pad_power_off</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">utmi_phy_preresume</span><span class="p">(</span><span class="k">struct</span> <span class="n">tegra_usb_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_TX_CFG0</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">UTMIP_HS_DISCON_DISABLE</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_TX_CFG0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">utmi_phy_postresume</span><span class="p">(</span><span class="k">struct</span> <span class="n">tegra_usb_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_TX_CFG0</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UTMIP_HS_DISCON_DISABLE</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_TX_CFG0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">utmi_phy_restore_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">tegra_usb_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				   <span class="k">enum</span> <span class="n">tegra_usb_phy_port_speed</span> <span class="n">port_speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_MISC_CFG0</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UTMIP_DPDM_OBSERVE_SEL</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port_speed</span> <span class="o">==</span> <span class="n">TEGRA_USB_PHY_PORT_SPEED_LOW</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">UTMIP_DPDM_OBSERVE_SEL_FS_K</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">UTMIP_DPDM_OBSERVE_SEL_FS_J</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_MISC_CFG0</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_MISC_CFG0</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">UTMIP_DPDM_OBSERVE</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_MISC_CFG0</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">utmi_phy_restore_end</span><span class="p">(</span><span class="k">struct</span> <span class="n">tegra_usb_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_MISC_CFG0</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UTMIP_DPDM_OBSERVE</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">UTMIP_MISC_CFG0</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ulpi_phy_power_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">tegra_usb_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tegra_ulpi_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>

	<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">reset_gpio</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">reset_gpio</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">clk_enable</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_SUSP_CTRL</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">UHSIC_RESET</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">USB_SUSP_CTRL</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">ULPI_TIMING_CTRL_0</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">ULPI_OUTPUT_PINMUX_BYP</span> <span class="o">|</span> <span class="n">ULPI_CLKOUT_PINMUX_BYP</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">ULPI_TIMING_CTRL_0</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_SUSP_CTRL</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">ULPI_PHY_ENABLE</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">USB_SUSP_CTRL</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">ULPI_TIMING_CTRL_1</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">|=</span> <span class="n">ULPI_DATA_TRIMMER_SEL</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">ULPI_STPDIRNXT_TRIMMER_SEL</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">ULPI_DIR_TRIMMER_SEL</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">ULPI_TIMING_CTRL_1</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">|=</span> <span class="n">ULPI_DATA_TRIMMER_LOAD</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">ULPI_STPDIRNXT_TRIMMER_LOAD</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">ULPI_DIR_TRIMMER_LOAD</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">ULPI_TIMING_CTRL_1</span><span class="p">);</span>

	<span class="cm">/* Fix VbusInvalid due to floating VBUS */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_phy_io_write</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">ulpi</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: ulpi write failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_phy_io_write</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">ulpi</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: ulpi write failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_PORTSC1</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">USB_PORTSC1_WKOC</span> <span class="o">|</span> <span class="n">USB_PORTSC1_WKDS</span> <span class="o">|</span> <span class="n">USB_PORTSC1_WKCN</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">USB_PORTSC1</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_SUSP_CTRL</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">USB_SUSP_CLR</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">USB_SUSP_CTRL</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_SUSP_CTRL</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USB_SUSP_CLR</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">USB_SUSP_CTRL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ulpi_phy_power_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">tegra_usb_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tegra_ulpi_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>

	<span class="cm">/* Clear WKCN/WKDS/WKOC wake-on events that can cause the USB</span>
<span class="cm">	 * Controller to immediately bring the ULPI PHY out of low power</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">USB_PORTSC1</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">USB_PORTSC1_WKOC</span> <span class="o">|</span> <span class="n">USB_PORTSC1_WKDS</span> <span class="o">|</span> <span class="n">USB_PORTSC1_WKCN</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">USB_PORTSC1</span><span class="p">);</span>

	<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">reset_gpio</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">tegra_usb_phy</span> <span class="o">*</span><span class="nf">tegra_usb_phy_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">instance</span><span class="p">,</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">config</span><span class="p">,</span> <span class="k">enum</span> <span class="n">tegra_usb_phy_mode</span> <span class="n">phy_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tegra_usb_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tegra_ulpi_config</span> <span class="o">*</span><span class="n">ulpi_config</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">parent_rate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">phy</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tegra_usb_phy</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">instance</span> <span class="o">=</span> <span class="n">instance</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">regs</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">phy_mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy_is_ulpi</span><span class="p">(</span><span class="n">phy</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: ulpi phy configuration missing&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">utmip_default</span><span class="p">[</span><span class="n">instance</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">pll_u</span> <span class="o">=</span> <span class="n">clk_get_sys</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;pll_u&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">pll_u</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Can&#39;t get pll_u clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">pll_u</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">clk_enable</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">pll_u</span><span class="p">);</span>

	<span class="n">parent_rate</span> <span class="o">=</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="n">clk_get_parent</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">pll_u</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tegra_freq_table</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tegra_freq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">freq</span> <span class="o">==</span> <span class="n">parent_rate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tegra_freq_table</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;invalid pll_u parent rate %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">parent_rate</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy_is_ulpi</span><span class="p">(</span><span class="n">phy</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ulpi_config</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get_sys</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">ulpi_config</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: can&#39;t get ulpi clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">ulpi_config</span><span class="o">-&gt;</span><span class="n">reset_gpio</span><span class="p">))</span>
			<span class="n">ulpi_config</span><span class="o">-&gt;</span><span class="n">reset_gpio</span> <span class="o">=</span>
				<span class="n">of_get_named_gpio</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">,</span>
						  <span class="s">&quot;nvidia,phy-reset-gpio&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">ulpi_config</span><span class="o">-&gt;</span><span class="n">reset_gpio</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: invalid reset gpio: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			       <span class="n">ulpi_config</span><span class="o">-&gt;</span><span class="n">reset_gpio</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">gpio_request</span><span class="p">(</span><span class="n">ulpi_config</span><span class="o">-&gt;</span><span class="n">reset_gpio</span><span class="p">,</span> <span class="s">&quot;ulpi_phy_reset_b&quot;</span><span class="p">);</span>
		<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">ulpi_config</span><span class="o">-&gt;</span><span class="n">reset_gpio</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ulpi</span> <span class="o">=</span> <span class="n">otg_ulpi_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ulpi_viewport_access_ops</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ulpi</span><span class="o">-&gt;</span><span class="n">io_priv</span> <span class="o">=</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">ULPI_VIEWPORT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">utmip_pad_open</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">phy</span><span class="p">;</span>

<span class="nl">err1:</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">pll_u</span><span class="p">);</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">pll_u</span><span class="p">);</span>
<span class="nl">err0:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">tegra_usb_phy_open</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">tegra_usb_phy_power_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">tegra_usb_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy_is_ulpi</span><span class="p">(</span><span class="n">phy</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ulpi_phy_power_on</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">utmi_phy_power_on</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">tegra_usb_phy_power_on</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">tegra_usb_phy_power_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">tegra_usb_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy_is_ulpi</span><span class="p">(</span><span class="n">phy</span><span class="p">))</span>
		<span class="n">ulpi_phy_power_off</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">utmi_phy_power_off</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">tegra_usb_phy_power_off</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">tegra_usb_phy_preresume</span><span class="p">(</span><span class="k">struct</span> <span class="n">tegra_usb_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy_is_ulpi</span><span class="p">(</span><span class="n">phy</span><span class="p">))</span>
		<span class="n">utmi_phy_preresume</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">tegra_usb_phy_preresume</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">tegra_usb_phy_postresume</span><span class="p">(</span><span class="k">struct</span> <span class="n">tegra_usb_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy_is_ulpi</span><span class="p">(</span><span class="n">phy</span><span class="p">))</span>
		<span class="n">utmi_phy_postresume</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">tegra_usb_phy_postresume</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">tegra_ehci_phy_restore_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">tegra_usb_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				 <span class="k">enum</span> <span class="n">tegra_usb_phy_port_speed</span> <span class="n">port_speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy_is_ulpi</span><span class="p">(</span><span class="n">phy</span><span class="p">))</span>
		<span class="n">utmi_phy_restore_start</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">port_speed</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">tegra_ehci_phy_restore_start</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">tegra_ehci_phy_restore_end</span><span class="p">(</span><span class="k">struct</span> <span class="n">tegra_usb_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy_is_ulpi</span><span class="p">(</span><span class="n">phy</span><span class="p">))</span>
		<span class="n">utmi_phy_restore_end</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">tegra_ehci_phy_restore_end</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">tegra_usb_phy_clk_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">tegra_usb_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy_is_ulpi</span><span class="p">(</span><span class="n">phy</span><span class="p">))</span>
		<span class="n">utmi_phy_clk_disable</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">tegra_usb_phy_clk_disable</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">tegra_usb_phy_clk_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">tegra_usb_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy_is_ulpi</span><span class="p">(</span><span class="n">phy</span><span class="p">))</span>
		<span class="n">utmi_phy_clk_enable</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">tegra_usb_phy_clk_enable</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">tegra_usb_phy_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">tegra_usb_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy_is_ulpi</span><span class="p">(</span><span class="n">phy</span><span class="p">))</span>
		<span class="n">clk_put</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">utmip_pad_close</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">pll_u</span><span class="p">);</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">pll_u</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">tegra_usb_phy_close</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
