<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › kernel › sys_oabi-compat.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>sys_oabi-compat.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  arch/arm/kernel/sys_oabi-compat.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Compatibility wrappers for syscalls that are used from</span>
<span class="cm"> *  old ABI user space binaries with an EABI kernel.</span>
<span class="cm"> *</span>
<span class="cm"> *  Author:	Nicolas Pitre</span>
<span class="cm"> *  Created:	Oct 7, 2005</span>
<span class="cm"> *  Copyright:	MontaVista Software, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> *  published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * The legacy ABI and the new ARM EABI have different rules making some</span>
<span class="cm"> * syscalls incompatible especially with structure arguments.</span>
<span class="cm"> * Most notably, Eabi says 64-bit members should be 64-bit aligned instead of</span>
<span class="cm"> * simply word aligned.  EABI also pads structures to the size of the largest</span>
<span class="cm"> * member it contains instead of the invariant 32-bit.</span>
<span class="cm"> *</span>
<span class="cm"> * The following syscalls are affected:</span>
<span class="cm"> *</span>
<span class="cm"> * sys_stat64:</span>
<span class="cm"> * sys_lstat64:</span>
<span class="cm"> * sys_fstat64:</span>
<span class="cm"> * sys_fstatat64:</span>
<span class="cm"> *</span>
<span class="cm"> *   struct stat64 has different sizes and some members are shifted</span>
<span class="cm"> *   Compatibility wrappers are needed for them and provided below.</span>
<span class="cm"> *</span>
<span class="cm"> * sys_fcntl64:</span>
<span class="cm"> *</span>
<span class="cm"> *   struct flock64 has different sizes and some members are shifted</span>
<span class="cm"> *   A compatibility wrapper is needed and provided below.</span>
<span class="cm"> *</span>
<span class="cm"> * sys_statfs64:</span>
<span class="cm"> * sys_fstatfs64:</span>
<span class="cm"> *</span>
<span class="cm"> *   struct statfs64 has extra padding with EABI growing its size from</span>
<span class="cm"> *   84 to 88.  This struct is now __attribute__((packed,aligned(4)))</span>
<span class="cm"> *   with a small assembly wrapper to force the sz argument to 84 if it is 88</span>
<span class="cm"> *   to avoid copying the extra padding over user space unexpecting it.</span>
<span class="cm"> *</span>
<span class="cm"> * sys_newuname:</span>
<span class="cm"> *</span>
<span class="cm"> *   struct new_utsname has no padding with EABI.  No problem there.</span>
<span class="cm"> *</span>
<span class="cm"> * sys_epoll_ctl:</span>
<span class="cm"> * sys_epoll_wait:</span>
<span class="cm"> *</span>
<span class="cm"> *   struct epoll_event has its second member shifted also affecting the</span>
<span class="cm"> *   structure size. Compatibility wrappers are needed and provided below.</span>
<span class="cm"> *</span>
<span class="cm"> * sys_ipc:</span>
<span class="cm"> * sys_semop:</span>
<span class="cm"> * sys_semtimedop:</span>
<span class="cm"> *</span>
<span class="cm"> *   struct sembuf loses its padding with EABI.  Since arrays of them are</span>
<span class="cm"> *   used they have to be copyed to remove the padding. Compatibility wrappers</span>
<span class="cm"> *   provided below.</span>
<span class="cm"> *</span>
<span class="cm"> * sys_bind:</span>
<span class="cm"> * sys_connect:</span>
<span class="cm"> * sys_sendmsg:</span>
<span class="cm"> * sys_sendto:</span>
<span class="cm"> * sys_socketcall:</span>
<span class="cm"> *</span>
<span class="cm"> *   struct sockaddr_un loses its padding with EABI.  Since the size of the</span>
<span class="cm"> *   structure is used as a validation test in unix_mkname(), we need to</span>
<span class="cm"> *   change the length argument to 110 whenever it is 112.  Compatibility</span>
<span class="cm"> *   wrappers provided below.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/syscalls.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/eventpoll.h&gt;</span>
<span class="cp">#include &lt;linux/sem.h&gt;</span>
<span class="cp">#include &lt;linux/socket.h&gt;</span>
<span class="cp">#include &lt;linux/net.h&gt;</span>
<span class="cp">#include &lt;linux/ipc.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="k">struct</span> <span class="n">oldabi_stat64</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">st_dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">__pad1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">__st_ino</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">st_mode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">st_nlink</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">st_uid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">st_gid</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">st_rdev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">__pad2</span><span class="p">;</span>

	<span class="kt">long</span> <span class="kt">long</span>	<span class="n">st_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">st_blksize</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">st_blocks</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">st_atime</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">st_atime_nsec</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">st_mtime</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">st_mtime_nsec</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">st_ctime</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">st_ctime_nsec</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">st_ino</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">,</span><span class="n">aligned</span><span class="p">(</span><span class="mi">4</span><span class="p">)));</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">cp_oldabi_stat64</span><span class="p">(</span><span class="k">struct</span> <span class="n">kstat</span> <span class="o">*</span><span class="n">stat</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">oldabi_stat64</span> <span class="n">__user</span> <span class="o">*</span><span class="n">statbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">oldabi_stat64</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">tmp</span><span class="p">.</span><span class="n">st_dev</span> <span class="o">=</span> <span class="n">huge_encode_dev</span><span class="p">(</span><span class="n">stat</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">__pad1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">__st_ino</span> <span class="o">=</span> <span class="n">stat</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">st_mode</span> <span class="o">=</span> <span class="n">stat</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">st_nlink</span> <span class="o">=</span> <span class="n">stat</span><span class="o">-&gt;</span><span class="n">nlink</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">st_uid</span> <span class="o">=</span> <span class="n">from_kuid_munged</span><span class="p">(</span><span class="n">current_user_ns</span><span class="p">(),</span> <span class="n">stat</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">);</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">st_gid</span> <span class="o">=</span> <span class="n">from_kgid_munged</span><span class="p">(</span><span class="n">current_user_ns</span><span class="p">(),</span> <span class="n">stat</span><span class="o">-&gt;</span><span class="n">gid</span><span class="p">);</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">st_rdev</span> <span class="o">=</span> <span class="n">huge_encode_dev</span><span class="p">(</span><span class="n">stat</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">);</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">st_size</span> <span class="o">=</span> <span class="n">stat</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">st_blocks</span> <span class="o">=</span> <span class="n">stat</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">__pad2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">st_blksize</span> <span class="o">=</span> <span class="n">stat</span><span class="o">-&gt;</span><span class="n">blksize</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">st_atime</span> <span class="o">=</span> <span class="n">stat</span><span class="o">-&gt;</span><span class="n">atime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">st_atime_nsec</span> <span class="o">=</span> <span class="n">stat</span><span class="o">-&gt;</span><span class="n">atime</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">st_mtime</span> <span class="o">=</span> <span class="n">stat</span><span class="o">-&gt;</span><span class="n">mtime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">st_mtime_nsec</span> <span class="o">=</span> <span class="n">stat</span><span class="o">-&gt;</span><span class="n">mtime</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">st_ctime</span> <span class="o">=</span> <span class="n">stat</span><span class="o">-&gt;</span><span class="n">ctime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">st_ctime_nsec</span> <span class="o">=</span> <span class="n">stat</span><span class="o">-&gt;</span><span class="n">ctime</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">st_ino</span> <span class="o">=</span> <span class="n">stat</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">statbuf</span><span class="p">,</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">asmlinkage</span> <span class="kt">long</span> <span class="nf">sys_oabi_stat64</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">filename</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">oldabi_stat64</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">statbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kstat</span> <span class="n">stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">vfs_stat</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">cp_oldabi_stat64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stat</span><span class="p">,</span> <span class="n">statbuf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">asmlinkage</span> <span class="kt">long</span> <span class="nf">sys_oabi_lstat64</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">filename</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">oldabi_stat64</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">statbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kstat</span> <span class="n">stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">vfs_lstat</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">cp_oldabi_stat64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stat</span><span class="p">,</span> <span class="n">statbuf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">asmlinkage</span> <span class="kt">long</span> <span class="nf">sys_oabi_fstat64</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fd</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">oldabi_stat64</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">statbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kstat</span> <span class="n">stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">vfs_fstat</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">cp_oldabi_stat64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stat</span><span class="p">,</span> <span class="n">statbuf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">asmlinkage</span> <span class="kt">long</span> <span class="nf">sys_oabi_fstatat64</span><span class="p">(</span><span class="kt">int</span> <span class="n">dfd</span><span class="p">,</span>
				   <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">oldabi_stat64</span>  <span class="n">__user</span> <span class="o">*</span><span class="n">statbuf</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kstat</span> <span class="n">stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">vfs_fstatat</span><span class="p">(</span><span class="n">dfd</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cp_oldabi_stat64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stat</span><span class="p">,</span> <span class="n">statbuf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">oabi_flock64</span> <span class="p">{</span>
	<span class="kt">short</span>	<span class="n">l_type</span><span class="p">;</span>
	<span class="kt">short</span>	<span class="n">l_whence</span><span class="p">;</span>
	<span class="n">loff_t</span>	<span class="n">l_start</span><span class="p">;</span>
	<span class="n">loff_t</span>	<span class="n">l_len</span><span class="p">;</span>
	<span class="n">pid_t</span>	<span class="n">l_pid</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">,</span><span class="n">aligned</span><span class="p">(</span><span class="mi">4</span><span class="p">)));</span>

<span class="n">asmlinkage</span> <span class="kt">long</span> <span class="nf">sys_oabi_fcntl64</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">oabi_flock64</span> <span class="n">user</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">flock64</span> <span class="n">kernel</span><span class="p">;</span>
	<span class="n">mm_segment_t</span> <span class="n">fs</span> <span class="o">=</span> <span class="n">USER_DS</span><span class="p">;</span> <span class="cm">/* initialized to kill a warning */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">local_arg</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">F_GETLK64</span>:
	<span class="k">case</span> <span class="n">F_SETLK64</span>:
	<span class="k">case</span> <span class="n">F_SETLKW64</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">oabi_flock64</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">user</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">kernel</span><span class="p">.</span><span class="n">l_type</span>	<span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="n">l_type</span><span class="p">;</span>
		<span class="n">kernel</span><span class="p">.</span><span class="n">l_whence</span>	<span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="n">l_whence</span><span class="p">;</span>
		<span class="n">kernel</span><span class="p">.</span><span class="n">l_start</span>	<span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="n">l_start</span><span class="p">;</span>
		<span class="n">kernel</span><span class="p">.</span><span class="n">l_len</span>	<span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="n">l_len</span><span class="p">;</span>
		<span class="n">kernel</span><span class="p">.</span><span class="n">l_pid</span>	<span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="n">l_pid</span><span class="p">;</span>
		<span class="n">local_arg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">kernel</span><span class="p">;</span>
		<span class="n">fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
		<span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sys_fcntl64</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">local_arg</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">F_GETLK64</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">user</span><span class="p">.</span><span class="n">l_type</span>	<span class="o">=</span> <span class="n">kernel</span><span class="p">.</span><span class="n">l_type</span><span class="p">;</span>
			<span class="n">user</span><span class="p">.</span><span class="n">l_whence</span>	<span class="o">=</span> <span class="n">kernel</span><span class="p">.</span><span class="n">l_whence</span><span class="p">;</span>
			<span class="n">user</span><span class="p">.</span><span class="n">l_start</span>	<span class="o">=</span> <span class="n">kernel</span><span class="p">.</span><span class="n">l_start</span><span class="p">;</span>
			<span class="n">user</span><span class="p">.</span><span class="n">l_len</span>	<span class="o">=</span> <span class="n">kernel</span><span class="p">.</span><span class="n">l_len</span><span class="p">;</span>
			<span class="n">user</span><span class="p">.</span><span class="n">l_pid</span>	<span class="o">=</span> <span class="n">kernel</span><span class="p">.</span><span class="n">l_pid</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="k">struct</span> <span class="n">oabi_flock64</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">user</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">user</span><span class="p">)))</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">F_SETLK64</span>:
	<span class="k">case</span> <span class="n">F_SETLKW64</span>:
		<span class="n">set_fs</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">oabi_epoll_event</span> <span class="p">{</span>
	<span class="n">__u32</span> <span class="n">events</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">,</span><span class="n">aligned</span><span class="p">(</span><span class="mi">4</span><span class="p">)));</span>

<span class="n">asmlinkage</span> <span class="kt">long</span> <span class="nf">sys_oabi_epoll_ctl</span><span class="p">(</span><span class="kt">int</span> <span class="n">epfd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">op</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">oabi_epoll_event</span> <span class="n">__user</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">oabi_epoll_event</span> <span class="n">user</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">epoll_event</span> <span class="n">kernel</span><span class="p">;</span>
	<span class="n">mm_segment_t</span> <span class="n">fs</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">==</span> <span class="n">EPOLL_CTL_DEL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sys_epoll_ctl</span><span class="p">(</span><span class="n">epfd</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">user</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">kernel</span><span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="n">events</span><span class="p">;</span>
	<span class="n">kernel</span><span class="p">.</span><span class="n">data</span>   <span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
	<span class="n">fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sys_epoll_ctl</span><span class="p">(</span><span class="n">epfd</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kernel</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">asmlinkage</span> <span class="kt">long</span> <span class="nf">sys_oabi_epoll_wait</span><span class="p">(</span><span class="kt">int</span> <span class="n">epfd</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">oabi_epoll_event</span> <span class="n">__user</span> <span class="o">*</span><span class="n">events</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">maxevents</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">epoll_event</span> <span class="o">*</span><span class="n">kbuf</span><span class="p">;</span>
	<span class="n">mm_segment_t</span> <span class="n">fs</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">ret</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">maxevents</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">maxevents</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">INT_MAX</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">epoll_event</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">kbuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">kbuf</span><span class="p">)</span> <span class="o">*</span> <span class="n">maxevents</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kbuf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sys_epoll_wait</span><span class="p">(</span><span class="n">epfd</span><span class="p">,</span> <span class="n">kbuf</span><span class="p">,</span> <span class="n">maxevents</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ret</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__put_user_error</span><span class="p">(</span><span class="n">kbuf</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">events</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">events</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">__put_user_error</span><span class="p">(</span><span class="n">kbuf</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">,</span>   <span class="o">&amp;</span><span class="n">events</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>   <span class="n">err</span><span class="p">);</span>
		<span class="n">events</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">kbuf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">oabi_sembuf</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">sem_num</span><span class="p">;</span>
	<span class="kt">short</span>		<span class="n">sem_op</span><span class="p">;</span>
	<span class="kt">short</span>		<span class="n">sem_flg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">__pad</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">asmlinkage</span> <span class="kt">long</span> <span class="nf">sys_oabi_semtimedop</span><span class="p">(</span><span class="kt">int</span> <span class="n">semid</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">oabi_sembuf</span> <span class="n">__user</span> <span class="o">*</span><span class="n">tsops</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="n">nsops</span><span class="p">,</span>
				    <span class="k">const</span> <span class="k">struct</span> <span class="n">timespec</span> <span class="n">__user</span> <span class="o">*</span><span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sembuf</span> <span class="o">*</span><span class="n">sops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">local_timeout</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nsops</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">nsops</span> <span class="o">&gt;</span> <span class="n">SEMOPM</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">sops</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sops</span><span class="p">)</span> <span class="o">*</span> <span class="n">nsops</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sops</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nsops</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__get_user_error</span><span class="p">(</span><span class="n">sops</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sem_num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsops</span><span class="o">-&gt;</span><span class="n">sem_num</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">__get_user_error</span><span class="p">(</span><span class="n">sops</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sem_op</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">tsops</span><span class="o">-&gt;</span><span class="n">sem_op</span><span class="p">,</span>  <span class="n">err</span><span class="p">);</span>
		<span class="n">__get_user_error</span><span class="p">(</span><span class="n">sops</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sem_flg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsops</span><span class="o">-&gt;</span><span class="n">sem_flg</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">tsops</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* copy this as well before changing domain protection */</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local_timeout</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">timeout</span><span class="p">));</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">local_timeout</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mm_segment_t</span> <span class="n">fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
		<span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sys_semtimedop</span><span class="p">(</span><span class="n">semid</span><span class="p">,</span> <span class="n">sops</span><span class="p">,</span> <span class="n">nsops</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
		<span class="n">set_fs</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sops</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">asmlinkage</span> <span class="kt">long</span> <span class="nf">sys_oabi_semop</span><span class="p">(</span><span class="kt">int</span> <span class="n">semid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">oabi_sembuf</span> <span class="n">__user</span> <span class="o">*</span><span class="n">tsops</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="n">nsops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sys_oabi_semtimedop</span><span class="p">(</span><span class="n">semid</span><span class="p">,</span> <span class="n">tsops</span><span class="p">,</span> <span class="n">nsops</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">asmlinkage</span> <span class="kt">int</span> <span class="nf">sys_oabi_ipc</span><span class="p">(</span><span class="n">uint</span> <span class="n">call</span><span class="p">,</span> <span class="kt">int</span> <span class="n">first</span><span class="p">,</span> <span class="kt">int</span> <span class="n">second</span><span class="p">,</span> <span class="kt">int</span> <span class="n">third</span><span class="p">,</span>
			    <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">long</span> <span class="n">fifth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">call</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SEMOP</span>:
		<span class="k">return</span>  <span class="n">sys_oabi_semtimedop</span><span class="p">(</span><span class="n">first</span><span class="p">,</span>
					    <span class="p">(</span><span class="k">struct</span> <span class="n">oabi_sembuf</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">,</span>
					    <span class="n">second</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">SEMTIMEDOP</span>:
		<span class="k">return</span>  <span class="n">sys_oabi_semtimedop</span><span class="p">(</span><span class="n">first</span><span class="p">,</span>
					    <span class="p">(</span><span class="k">struct</span> <span class="n">oabi_sembuf</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">,</span>
					    <span class="n">second</span><span class="p">,</span>
					    <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">timespec</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">fifth</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">sys_ipc</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">third</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">fifth</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">asmlinkage</span> <span class="kt">long</span> <span class="nf">sys_oabi_bind</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="n">__user</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addrlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sa_family_t</span> <span class="n">sa_family</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addrlen</span> <span class="o">==</span> <span class="mi">112</span> <span class="o">&amp;&amp;</span>
	    <span class="n">get_user</span><span class="p">(</span><span class="n">sa_family</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_family</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sa_family</span> <span class="o">==</span> <span class="n">AF_UNIX</span><span class="p">)</span>
			<span class="n">addrlen</span> <span class="o">=</span> <span class="mi">110</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sys_bind</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">addrlen</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">asmlinkage</span> <span class="kt">long</span> <span class="nf">sys_oabi_connect</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="n">__user</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addrlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sa_family_t</span> <span class="n">sa_family</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addrlen</span> <span class="o">==</span> <span class="mi">112</span> <span class="o">&amp;&amp;</span>
	    <span class="n">get_user</span><span class="p">(</span><span class="n">sa_family</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_family</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sa_family</span> <span class="o">==</span> <span class="n">AF_UNIX</span><span class="p">)</span>
			<span class="n">addrlen</span> <span class="o">=</span> <span class="mi">110</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sys_connect</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">addrlen</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">asmlinkage</span> <span class="kt">long</span> <span class="nf">sys_oabi_sendto</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buff</span><span class="p">,</span>
				<span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">flags</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">sockaddr</span> <span class="n">__user</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">addrlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sa_family_t</span> <span class="n">sa_family</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addrlen</span> <span class="o">==</span> <span class="mi">112</span> <span class="o">&amp;&amp;</span>
	    <span class="n">get_user</span><span class="p">(</span><span class="n">sa_family</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_family</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sa_family</span> <span class="o">==</span> <span class="n">AF_UNIX</span><span class="p">)</span>
			<span class="n">addrlen</span> <span class="o">=</span> <span class="mi">110</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sys_sendto</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">addrlen</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">asmlinkage</span> <span class="kt">long</span> <span class="nf">sys_oabi_sendmsg</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msghdr</span> <span class="n">__user</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="n">__user</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">msg_namelen</span><span class="p">;</span>
	<span class="n">sa_family_t</span> <span class="n">sa_family</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span> <span class="o">&amp;&amp;</span>
	    <span class="n">get_user</span><span class="p">(</span><span class="n">msg_namelen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_namelen</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">msg_namelen</span> <span class="o">==</span> <span class="mi">112</span> <span class="o">&amp;&amp;</span>
	    <span class="n">get_user</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">get_user</span><span class="p">(</span><span class="n">sa_family</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_family</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sa_family</span> <span class="o">==</span> <span class="n">AF_UNIX</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * HACK ALERT: there is a limit to how much backward bending</span>
<span class="cm">		 * we should do for what is actually a transitional</span>
<span class="cm">		 * compatibility layer.  This already has known flaws with</span>
<span class="cm">		 * a few ioctls that we don&#39;t intend to fix.  Therefore</span>
<span class="cm">		 * consider this blatent hack as another one... and take care</span>
<span class="cm">		 * to run for cover.  In most cases it will &quot;just work fine&quot;.</span>
<span class="cm">		 * If it doesn&#39;t, well, tough.</span>
<span class="cm">		 */</span>
		<span class="n">put_user</span><span class="p">(</span><span class="mi">110</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_namelen</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">sys_sendmsg</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">asmlinkage</span> <span class="kt">long</span> <span class="nf">sys_oabi_socketcall</span><span class="p">(</span><span class="kt">int</span> <span class="n">call</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">call</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SYS_BIND</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">sys_oabi_bind</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_CONNECT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">sys_oabi_connect</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_SENDTO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="mi">6</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">sys_oabi_sendto</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
					    <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_SENDMSG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">sys_oabi_sendmsg</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="k">struct</span> <span class="n">msghdr</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">sys_socketcall</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
