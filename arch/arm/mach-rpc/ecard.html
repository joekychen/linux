<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › mach-rpc › ecard.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ecard.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/arch/arm/kernel/ecard.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright 1995-2001 Russell King</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> *  Find all installed expansion cards, and handle interrupts from them.</span>
<span class="cm"> *</span>
<span class="cm"> *  Created from information from Acorns RiscOS3 PRMs</span>
<span class="cm"> *</span>
<span class="cm"> *  08-Dec-1996	RMK	Added code for the 9&#39;th expansion card - the ether</span>
<span class="cm"> *			podule slot.</span>
<span class="cm"> *  06-May-1997	RMK	Added blacklist for cards whose loader doesn&#39;t work.</span>
<span class="cm"> *  12-Sep-1997	RMK	Created new handling of interrupt enables/disables</span>
<span class="cm"> *			- cards can now register their own routine to control</span>
<span class="cm"> *			interrupts (recommended).</span>
<span class="cm"> *  29-Sep-1997	RMK	Expansion card interrupt hardware not being re-enabled</span>
<span class="cm"> *			on reset from Linux. (Caused cards not to respond</span>
<span class="cm"> *			under RiscOS without hard reset).</span>
<span class="cm"> *  15-Feb-1998	RMK	Added DMA support</span>
<span class="cm"> *  12-Sep-1998	RMK	Added EASI support</span>
<span class="cm"> *  10-Jan-1999	RMK	Run loaders in a simulated RISC OS environment.</span>
<span class="cm"> *  17-Apr-1999	RMK	Support for EASI Type C cycles.</span>
<span class="cm"> */</span>
<span class="cp">#define ECARD_C</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/reboot.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>

<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/ecard.h&gt;</span>
<span class="cp">#include &lt;mach/hardware.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/mmu_context.h&gt;</span>
<span class="cp">#include &lt;asm/mach/irq.h&gt;</span>
<span class="cp">#include &lt;asm/tlbflush.h&gt;</span>

<span class="cp">#include &quot;ecard.h&quot;</span>

<span class="k">struct</span> <span class="n">ecard_request</span> <span class="p">{</span>
	<span class="kt">void</span>		<span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ecard_request</span> <span class="o">*</span><span class="p">);</span>
	<span class="n">ecard_t</span>		<span class="o">*</span><span class="n">ec</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">address</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">length</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">use_loader</span><span class="p">;</span>
	<span class="kt">void</span>		<span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="n">complete</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">expcard_blacklist</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	 <span class="n">manufacturer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	 <span class="n">product</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span>	<span class="o">*</span><span class="n">type</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">ecard_t</span> <span class="o">*</span><span class="n">cards</span><span class="p">;</span>
<span class="k">static</span> <span class="n">ecard_t</span> <span class="o">*</span><span class="n">slot_to_expcard</span><span class="p">[</span><span class="n">MAX_ECARDS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ectcr</span><span class="p">;</span>

<span class="cm">/* List of descriptions of cards which don&#39;t have an extended</span>
<span class="cm"> * identification, or chunk directories containing a description.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">expcard_blacklist</span> <span class="n">__initdata</span> <span class="n">blacklist</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">MANU_ACORN</span><span class="p">,</span> <span class="n">PROD_ACORN_ETHER1</span><span class="p">,</span> <span class="s">&quot;Acorn Ether1&quot;</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">asmlinkage</span> <span class="k">extern</span> <span class="kt">int</span>
<span class="n">ecard_loader_reset</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span><span class="p">,</span> <span class="n">loader_t</span> <span class="n">loader</span><span class="p">);</span>
<span class="n">asmlinkage</span> <span class="k">extern</span> <span class="kt">int</span>
<span class="n">ecard_loader_read</span><span class="p">(</span><span class="kt">int</span> <span class="n">off</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span><span class="p">,</span> <span class="n">loader_t</span> <span class="n">loader</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">ecard_getu16</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">signed</span> <span class="kt">long</span> <span class="nf">ecard_gets24</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="p">((</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0xff000000</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">ecard_t</span> <span class="o">*</span><span class="nf">slot_to_ecard</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">slot</span> <span class="o">&lt;</span> <span class="n">MAX_ECARDS</span> <span class="o">?</span> <span class="n">slot_to_expcard</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ===================== Expansion card daemon ======================== */</span>
<span class="cm">/*</span>
<span class="cm"> * Since the loader programs on the expansion cards need to be run</span>
<span class="cm"> * in a specific environment, create a separate task with this</span>
<span class="cm"> * environment up, and pass requests to this task as and when we</span>
<span class="cm"> * need to.</span>
<span class="cm"> *</span>
<span class="cm"> * This should allow 99% of loaders to be called from Linux.</span>
<span class="cm"> *</span>
<span class="cm"> * From a security standpoint, we trust the card vendors.  This</span>
<span class="cm"> * may be a misplaced trust.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ecard_task_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ecard_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">expansion_card</span> <span class="o">*</span><span class="n">ec</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">slot_no</span> <span class="o">==</span> <span class="mi">8</span>
		<span class="o">?</span> <span class="o">&amp;</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">ECARD_RES_MEMC</span><span class="p">]</span>
		<span class="o">:</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">easi</span>
		  <span class="o">?</span> <span class="o">&amp;</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">ECARD_RES_EASI</span><span class="p">]</span>
		  <span class="o">:</span> <span class="o">&amp;</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">ECARD_RES_IOCSYNC</span><span class="p">];</span>

	<span class="n">ecard_loader_reset</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">loader</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ecard_task_readbytes</span><span class="p">(</span><span class="k">struct</span> <span class="n">ecard_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">expansion_card</span> <span class="o">*</span><span class="n">ec</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ec</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">off</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">slot_no</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span>
				<span class="n">ec</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">ECARD_RES_MEMC</span><span class="p">].</span><span class="n">start</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * The card maintains an index which increments the address</span>
<span class="cm">		 * into a 4096-byte page on each access.  We need to keep</span>
<span class="cm">		 * track of the counter.</span>
<span class="cm">		 */</span>
		<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">page</span><span class="p">;</span>

		<span class="n">page</span> <span class="o">=</span> <span class="p">(</span><span class="n">off</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">&gt;</span> <span class="mi">256</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">off</span> <span class="o">&amp;=</span> <span class="mi">4095</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * If we are reading offset 0, or our current index is</span>
<span class="cm">		 * greater than the offset, reset the hardware index counter.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="n">off</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
			<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Increment the hardware index counter until we get to the</span>
<span class="cm">		 * required offset.  The read bytes are discarded.</span>
<span class="cm">		 */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">off</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">readb</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">page</span><span class="p">);</span>
			<span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">page</span><span class="p">);</span>
			<span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">easi</span>
			 <span class="o">?</span> <span class="o">&amp;</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">ECARD_RES_EASI</span><span class="p">]</span>
			 <span class="o">:</span> <span class="o">&amp;</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">ECARD_RES_IOCSYNC</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pbase</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">base</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">use_loader</span> <span class="o">||</span> <span class="o">!</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">loader</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">off</span> <span class="o">*=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">pbase</span> <span class="o">+</span> <span class="n">off</span><span class="p">);</span>
				<span class="n">off</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">while</span><span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * The following is required by some</span>
<span class="cm">				 * expansion card loader programs.</span>
<span class="cm">				 */</span>
				<span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x108</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="n">ecard_loader_read</span><span class="p">(</span><span class="n">off</span><span class="o">++</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span>
							   <span class="n">ec</span><span class="o">-&gt;</span><span class="n">loader</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">DECLARE_WAIT_QUEUE_HEAD</span><span class="p">(</span><span class="n">ecard_wait</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ecard_request</span> <span class="o">*</span><span class="n">ecard_req</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">ecard_mutex</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Set up the expansion card daemon&#39;s page tables.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ecard_init_pgtables</span><span class="p">(</span><span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="n">vma</span><span class="p">;</span>

	<span class="cm">/* We want to set up the page tables for the following mapping:</span>
<span class="cm">	 *  Virtual	Physical</span>
<span class="cm">	 *  0x03000000	0x03000000</span>
<span class="cm">	 *  0x03010000	unmapped</span>
<span class="cm">	 *  0x03210000	0x03210000</span>
<span class="cm">	 *  0x03400000	unmapped</span>
<span class="cm">	 *  0x08000000	0x08000000</span>
<span class="cm">	 *  0x10000000	unmapped</span>
<span class="cm">	 *</span>
<span class="cm">	 * FIXME: we don&#39;t follow this 100% yet.</span>
<span class="cm">	 */</span>
	<span class="n">pgd_t</span> <span class="o">*</span><span class="n">src_pgd</span><span class="p">,</span> <span class="o">*</span><span class="n">dst_pgd</span><span class="p">;</span>

	<span class="n">src_pgd</span> <span class="o">=</span> <span class="n">pgd_offset</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">IO_BASE</span><span class="p">);</span>
	<span class="n">dst_pgd</span> <span class="o">=</span> <span class="n">pgd_offset</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="n">IO_START</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dst_pgd</span><span class="p">,</span> <span class="n">src_pgd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pgd_t</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">IO_SIZE</span> <span class="o">/</span> <span class="n">PGDIR_SIZE</span><span class="p">));</span>

	<span class="n">src_pgd</span> <span class="o">=</span> <span class="n">pgd_offset</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">EASI_BASE</span><span class="p">);</span>
	<span class="n">dst_pgd</span> <span class="o">=</span> <span class="n">pgd_offset</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="n">EASI_START</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dst_pgd</span><span class="p">,</span> <span class="n">src_pgd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pgd_t</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">EASI_SIZE</span> <span class="o">/</span> <span class="n">PGDIR_SIZE</span><span class="p">));</span>

	<span class="n">vma</span><span class="p">.</span><span class="n">vm_flags</span> <span class="o">=</span> <span class="n">VM_EXEC</span><span class="p">;</span>
	<span class="n">vma</span><span class="p">.</span><span class="n">vm_mm</span> <span class="o">=</span> <span class="n">mm</span><span class="p">;</span>

	<span class="n">flush_tlb_range</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vma</span><span class="p">,</span> <span class="n">IO_START</span><span class="p">,</span> <span class="n">IO_START</span> <span class="o">+</span> <span class="n">IO_SIZE</span><span class="p">);</span>
	<span class="n">flush_tlb_range</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vma</span><span class="p">,</span> <span class="n">EASI_START</span><span class="p">,</span> <span class="n">EASI_START</span> <span class="o">+</span> <span class="n">EASI_SIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ecard_init_mm</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span> <span class="n">mm</span> <span class="o">=</span> <span class="n">mm_alloc</span><span class="p">();</span>
	<span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">active_mm</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">active_mm</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mm</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span> <span class="o">=</span> <span class="n">mm</span><span class="p">;</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="n">active_mm</span> <span class="o">=</span> <span class="n">mm</span><span class="p">;</span>
	<span class="n">activate_mm</span><span class="p">(</span><span class="n">active_mm</span><span class="p">,</span> <span class="n">mm</span><span class="p">);</span>
	<span class="n">mmdrop</span><span class="p">(</span><span class="n">active_mm</span><span class="p">);</span>
	<span class="n">ecard_init_pgtables</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ecard_task</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Allocate a mm.  We&#39;re not a lazy-TLB kernel task since we need</span>
<span class="cm">	 * to set page table entries where the user space would be.  Note</span>
<span class="cm">	 * that this also creates the page tables.  Failure is not an</span>
<span class="cm">	 * option here.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ecard_init_mm</span><span class="p">())</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;kecardd: unable to alloc mm</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ecard_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

		<span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">ecard_wait</span><span class="p">,</span> <span class="n">ecard_req</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="n">req</span> <span class="o">=</span> <span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ecard_req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
			<span class="n">complete</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wake the expansion card daemon to action our request.</span>
<span class="cm"> *</span>
<span class="cm"> * FIXME: The test here is not sufficient to detect if the</span>
<span class="cm"> * kcardd is running.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ecard_call</span><span class="p">(</span><span class="k">struct</span> <span class="n">ecard_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECLARE_COMPLETION_ONSTACK</span><span class="p">(</span><span class="n">completion</span><span class="p">);</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">completion</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ecard_mutex</span><span class="p">);</span>
	<span class="n">ecard_req</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ecard_wait</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now wait for kecardd to run.</span>
<span class="cm">	 */</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">completion</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ecard_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ======================= Mid-level card control ===================== */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ecard_readbytes</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">ecard_t</span> <span class="o">*</span><span class="n">ec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">off</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">useld</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ecard_request</span> <span class="n">req</span><span class="p">;</span>

	<span class="n">req</span><span class="p">.</span><span class="n">fn</span>		<span class="o">=</span> <span class="n">ecard_task_readbytes</span><span class="p">;</span>
	<span class="n">req</span><span class="p">.</span><span class="n">ec</span>		<span class="o">=</span> <span class="n">ec</span><span class="p">;</span>
	<span class="n">req</span><span class="p">.</span><span class="n">address</span>	<span class="o">=</span> <span class="n">off</span><span class="p">;</span>
	<span class="n">req</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">req</span><span class="p">.</span><span class="n">use_loader</span>	<span class="o">=</span> <span class="n">useld</span><span class="p">;</span>
	<span class="n">req</span><span class="p">.</span><span class="n">buffer</span>	<span class="o">=</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">ecard_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ecard_readchunk</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_chunk_dir</span> <span class="o">*</span><span class="n">cd</span><span class="p">,</span> <span class="n">ecard_t</span> <span class="o">*</span><span class="n">ec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ex_chunk_dir</span> <span class="n">excd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">useld</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">.</span><span class="n">cd</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecard_readbytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">excd</span><span class="p">,</span> <span class="n">ec</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">useld</span><span class="p">);</span>
		<span class="n">index</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">excd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">useld</span> <span class="o">&amp;&amp;</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">loader</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">useld</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">excd</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* link */</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">c_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">excd</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">excd</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* loader */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">loader</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ec</span><span class="o">-&gt;</span><span class="n">loader</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">c_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">excd</span><span class="p">),</span>
							       <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">loader</span><span class="p">)</span>
					<span class="n">ecard_readbytes</span><span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">loader</span><span class="p">,</span> <span class="n">ec</span><span class="p">,</span>
							<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">c_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">excd</span><span class="p">),</span>
							<span class="n">c_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">excd</span><span class="p">),</span> <span class="n">useld</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">excd</span><span class="p">)</span> <span class="o">==</span> <span class="n">id</span> <span class="o">&amp;&amp;</span> <span class="n">num</span><span class="o">--</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">excd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">c_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">excd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x70</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x70</span>:
			<span class="n">ecard_readbytes</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">excd</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">string</span><span class="p">,</span> <span class="n">ec</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">c_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">excd</span><span class="p">),</span> <span class="n">c_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">excd</span><span class="p">),</span>
					<span class="n">useld</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x00</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">cd</span><span class="o">-&gt;</span><span class="n">start_offset</span> <span class="o">=</span> <span class="n">c_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">excd</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">string</span><span class="p">,</span> <span class="n">excd</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">string</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ======================= Interrupt control ============================ */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ecard_def_irq_enable</span><span class="p">(</span><span class="n">ecard_t</span> <span class="o">*</span><span class="n">ec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irqnr</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ecard_def_irq_disable</span><span class="p">(</span><span class="n">ecard_t</span> <span class="o">*</span><span class="n">ec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irqnr</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ecard_def_irq_pending</span><span class="p">(</span><span class="n">ecard_t</span> <span class="o">*</span><span class="n">ec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">irqmask</span> <span class="o">||</span> <span class="n">readb</span><span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">irqaddr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">irqmask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ecard_def_fiq_enable</span><span class="p">(</span><span class="n">ecard_t</span> <span class="o">*</span><span class="n">ec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fiqnr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">panic</span><span class="p">(</span><span class="s">&quot;ecard_def_fiq_enable called - impossible&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ecard_def_fiq_disable</span><span class="p">(</span><span class="n">ecard_t</span> <span class="o">*</span><span class="n">ec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fiqnr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">panic</span><span class="p">(</span><span class="s">&quot;ecard_def_fiq_disable called - impossible&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ecard_def_fiq_pending</span><span class="p">(</span><span class="n">ecard_t</span> <span class="o">*</span><span class="n">ec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">fiqmask</span> <span class="o">||</span> <span class="n">readb</span><span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">fiqaddr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">fiqmask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">expansioncard_ops_t</span> <span class="n">ecard_default_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ecard_def_irq_enable</span><span class="p">,</span>
	<span class="n">ecard_def_irq_disable</span><span class="p">,</span>
	<span class="n">ecard_def_irq_pending</span><span class="p">,</span>
	<span class="n">ecard_def_fiq_enable</span><span class="p">,</span>
	<span class="n">ecard_def_fiq_disable</span><span class="p">,</span>
	<span class="n">ecard_def_fiq_pending</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Enable and disable interrupts from expansion cards.</span>
<span class="cm"> * (interrupts are disabled for these functions).</span>
<span class="cm"> *</span>
<span class="cm"> * They are not meant to be called directly, but via enable/disable_irq.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ecard_irq_unmask</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ecard_t</span> <span class="o">*</span><span class="n">ec</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ec</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">)</span>
			<span class="n">ec</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ecard_default_ops</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">claimed</span> <span class="o">&amp;&amp;</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">irqenable</span><span class="p">)</span>
			<span class="n">ec</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">irqenable</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ecard: rejecting request to &quot;</span>
				<span class="s">&quot;enable IRQs for %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ecard_irq_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ecard_t</span> <span class="o">*</span><span class="n">ec</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ec</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">)</span>
			<span class="n">ec</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ecard_default_ops</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">&amp;&amp;</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">irqdisable</span><span class="p">)</span>
			<span class="n">ec</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">irqdisable</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">ecard_chip</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ECARD&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_ack</span>	<span class="o">=</span> <span class="n">ecard_irq_mask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask</span>	<span class="o">=</span> <span class="n">ecard_irq_mask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span>	<span class="o">=</span> <span class="n">ecard_irq_unmask</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">ecard_enablefiq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fiqnr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ecard_t</span> <span class="o">*</span><span class="n">ec</span> <span class="o">=</span> <span class="n">slot_to_ecard</span><span class="p">(</span><span class="n">fiqnr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ec</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">)</span>
			<span class="n">ec</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ecard_default_ops</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">claimed</span> <span class="o">&amp;&amp;</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">fiqenable</span><span class="p">)</span>
			<span class="n">ec</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">fiqenable</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="n">fiqnr</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ecard: rejecting request to &quot;</span>
				<span class="s">&quot;enable FIQs for %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fiqnr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ecard_disablefiq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fiqnr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ecard_t</span> <span class="o">*</span><span class="n">ec</span> <span class="o">=</span> <span class="n">slot_to_ecard</span><span class="p">(</span><span class="n">fiqnr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ec</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">)</span>
			<span class="n">ec</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ecard_default_ops</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">fiqdisable</span><span class="p">)</span>
			<span class="n">ec</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">fiqdisable</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="n">fiqnr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ecard_dump_irq_state</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ecard_t</span> <span class="o">*</span><span class="n">ec</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Expansion card IRQ state:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ec</span> <span class="o">=</span> <span class="n">cards</span><span class="p">;</span> <span class="n">ec</span><span class="p">;</span> <span class="n">ec</span> <span class="o">=</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">slot_no</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  %d: %sclaimed, &quot;</span><span class="p">,</span>
		       <span class="n">ec</span><span class="o">-&gt;</span><span class="n">slot_no</span><span class="p">,</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">claimed</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;not &quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">&amp;&amp;</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">irqpending</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ec</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">ecard_default_ops</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;irq %spending</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ec</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">irqpending</span><span class="p">(</span><span class="n">ec</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;not &quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;irqaddr %p, mask = %02X, status = %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ec</span><span class="o">-&gt;</span><span class="n">irqaddr</span><span class="p">,</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">irqmask</span><span class="p">,</span> <span class="n">readb</span><span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">irqaddr</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ecard_check_lockup</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">lockup</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the timer interrupt has not run since the last million</span>
<span class="cm">	 * unrecognised expansion card interrupts, then there is</span>
<span class="cm">	 * something seriously wrong.  Disable the expansion card</span>
<span class="cm">	 * interrupts so at least we can continue.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Maybe we ought to start a timer to re-enable them some time</span>
<span class="cm">	 * later?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">last</span> <span class="o">==</span> <span class="n">jiffies</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lockup</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lockup</span> <span class="o">&gt;</span> <span class="mi">1000000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Interrupt lockup detected - &quot;</span>
			       <span class="s">&quot;disabling all expansion card interrupts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
			<span class="n">ecard_dump_irq_state</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">lockup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we did not recognise the source of this interrupt,</span>
<span class="cm">	 * warn the user, but don&#39;t flood the user with these messages.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">last</span> <span class="o">||</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">last</span> <span class="o">+</span> <span class="mi">5</span><span class="o">*</span><span class="n">HZ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">last</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Unrecognised interrupt from backplane</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ecard_dump_irq_state</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ecard_irq_handler</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ecard_t</span> <span class="o">*</span><span class="n">ec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">called</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ec</span> <span class="o">=</span> <span class="n">cards</span><span class="p">;</span> <span class="n">ec</span><span class="p">;</span> <span class="n">ec</span> <span class="o">=</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">pending</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">claimed</span> <span class="o">||</span> <span class="o">!</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">||</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">slot_no</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">&amp;&amp;</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">irqpending</span><span class="p">)</span>
			<span class="n">pending</span> <span class="o">=</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">irqpending</span><span class="p">(</span><span class="n">ec</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">pending</span> <span class="o">=</span> <span class="n">ecard_default_ops</span><span class="p">.</span><span class="n">irqpending</span><span class="p">(</span><span class="n">ec</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pending</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">generic_handle_irq</span><span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
			<span class="n">called</span> <span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_unmask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">called</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ecard_check_lockup</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">__ecard_address</span><span class="p">(</span><span class="n">ecard_t</span> <span class="o">*</span><span class="n">ec</span><span class="p">,</span> <span class="n">card_type_t</span> <span class="n">type</span><span class="p">,</span> <span class="n">card_speed_t</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">address</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot</span> <span class="o">=</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">slot_no</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">slot_no</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ECARD_MEMC8_BASE</span><span class="p">;</span>

	<span class="n">ectcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">slot</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ECARD_MEMC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">address</span> <span class="o">=</span> <span class="n">ECARD_MEMC_BASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ECARD_IOC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">address</span> <span class="o">=</span> <span class="n">ECARD_IOC_BASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">address</span> <span class="o">=</span> <span class="n">ECARD_IOC4_BASE</span> <span class="o">+</span> <span class="p">((</span><span class="n">slot</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">address</span><span class="p">)</span>
			<span class="n">address</span> <span class="o">+=</span> <span class="n">speed</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ECARD_EASI</span>:
		<span class="n">address</span> <span class="o">=</span> <span class="n">ECARD_EASI_BASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">ECARD_FAST</span><span class="p">)</span>
			<span class="n">ectcr</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">slot</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef IOMD_ECTCR</span>
	<span class="n">iomd_writeb</span><span class="p">(</span><span class="n">ectcr</span><span class="p">,</span> <span class="n">IOMD_ECTCR</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">address</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ecard_prints</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">ecard_t</span> <span class="o">*</span><span class="n">ec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  %d: %s &quot;</span><span class="p">,</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">slot_no</span><span class="p">,</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">easi</span> <span class="o">?</span> <span class="s">&quot;EASI&quot;</span> <span class="o">:</span> <span class="s">&quot;    &quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">in_chunk_dir</span> <span class="n">incd</span><span class="p">;</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;[%04X:%04X] &quot;</span><span class="p">,</span>
			<span class="n">ec</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">.</span><span class="n">manufacturer</span><span class="p">,</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">.</span><span class="n">product</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">card_desc</span> <span class="o">&amp;&amp;</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">.</span><span class="n">cd</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ecard_readchunk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">incd</span><span class="p">,</span> <span class="n">ec</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ec</span><span class="o">-&gt;</span><span class="n">card_desc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">incd</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">string</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">card_desc</span><span class="p">)</span>
				<span class="n">strcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">card_desc</span><span class="p">,</span> <span class="n">incd</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">string</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">card_desc</span> <span class="o">?</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">card_desc</span> <span class="o">:</span> <span class="s">&quot;*unknown*&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Simple card %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ecard_devices_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ecard_t</span> <span class="o">*</span><span class="n">ec</span> <span class="o">=</span> <span class="n">cards</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">ec</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecard_prints</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">ec</span><span class="p">);</span>
		<span class="n">ec</span> <span class="o">=</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ecard_devices_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">ecard_devices_proc_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">bus_ecard_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">ecard_devices_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">proc_bus_ecard_dir</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ecard_proc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">proc_bus_ecard_dir</span> <span class="o">=</span> <span class="n">proc_mkdir</span><span class="p">(</span><span class="s">&quot;bus/ecard&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;devices&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">proc_bus_ecard_dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus_ecard_proc_fops</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define ec_set_resource(ec,nr,st,sz)				\</span>
<span class="cp">	do {							\</span>
<span class="cp">		(ec)-&gt;resource[nr].name = dev_name(&amp;ec-&gt;dev);	\</span>
<span class="cp">		(ec)-&gt;resource[nr].start = st;			\</span>
<span class="cp">		(ec)-&gt;resource[nr].end = (st) + (sz) - 1;	\</span>
<span class="cp">		(ec)-&gt;resource[nr].flags = IORESOURCE_MEM;	\</span>
<span class="cp">	} while (0)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">ecard_free_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">expansion_card</span> <span class="o">*</span><span class="n">ec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ECARD_NUM_RESOURCES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">)</span>
			<span class="n">release_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ec</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">expansion_card</span> <span class="o">*</span><span class="n">__init</span> <span class="nf">ecard_alloc_card</span><span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">expansion_card</span> <span class="o">*</span><span class="n">ec</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ec</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ecard_t</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ec</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ec</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">nomem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">slot_no</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">easi</span> <span class="o">=</span> <span class="n">type</span> <span class="o">==</span> <span class="n">ECARD_EASI</span><span class="p">;</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">fiq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">NO_DMA</span><span class="p">;</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ecard_default_ops</span><span class="p">;</span>

	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ecard%d&quot;</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ecard_bus_type</span><span class="p">;</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">dma_mask</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">dma_mask</span><span class="p">;</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">dma_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">coherent_dma_mask</span> <span class="o">=</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">dma_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ec_set_resource</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="n">ECARD_RES_MEMC</span><span class="p">,</span>
				<span class="n">PODSLOT_MEMC_BASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">),</span>
				<span class="n">PODSLOT_MEMC_SIZE</span><span class="p">);</span>
		<span class="n">base</span> <span class="o">=</span> <span class="n">PODSLOT_IOC0_BASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">base</span> <span class="o">=</span> <span class="n">PODSLOT_IOC4_BASE</span> <span class="o">+</span> <span class="p">((</span><span class="n">slot</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_ARCH_RPC</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ec_set_resource</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="n">ECARD_RES_EASI</span><span class="p">,</span>
				<span class="n">PODSLOT_EASI_BASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">),</span>
				<span class="n">PODSLOT_EASI_SIZE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ec_set_resource</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="n">ECARD_RES_MEMC</span><span class="p">,</span> <span class="n">NETSLOT_BASE</span><span class="p">,</span> <span class="n">NETSLOT_SIZE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">ECARD_RES_IOCSYNC</span> <span class="o">-</span> <span class="n">ECARD_RES_IOCSLOW</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ec_set_resource</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">ECARD_RES_IOCSLOW</span><span class="p">,</span>
				<span class="n">base</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">),</span> <span class="n">PODSLOT_IOC_SIZE</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ECARD_NUM_RESOURCES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;&amp;</span>
		    <span class="n">request_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iomem_resource</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;resource(s) not available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ec</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">end</span> <span class="o">-=</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">start</span><span class="p">;</span>
			<span class="n">ec</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ec</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

 <span class="nl">nomem:</span>
	<span class="k">return</span> <span class="n">ec</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ecard_show_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">expansion_card</span> <span class="o">*</span><span class="n">ec</span> <span class="o">=</span> <span class="n">ECARD_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ecard_show_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">expansion_card</span> <span class="o">*</span><span class="n">ec</span> <span class="o">=</span> <span class="n">ECARD_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ecard_show_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">expansion_card</span> <span class="o">*</span><span class="n">ec</span> <span class="o">=</span> <span class="n">ECARD_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ECARD_NUM_RESOURCES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">str</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;%08x %08x %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ec</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">start</span><span class="p">,</span>
				<span class="n">ec</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">end</span><span class="p">,</span>
				<span class="n">ec</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">str</span> <span class="o">-</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ecard_show_vendor</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">expansion_card</span> <span class="o">*</span><span class="n">ec</span> <span class="o">=</span> <span class="n">ECARD_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">.</span><span class="n">manufacturer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ecard_show_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">expansion_card</span> <span class="o">*</span><span class="n">ec</span> <span class="o">=</span> <span class="n">ECARD_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">.</span><span class="n">product</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ecard_show_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">expansion_card</span> <span class="o">*</span><span class="n">ec</span> <span class="o">=</span> <span class="n">ECARD_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">easi</span> <span class="o">?</span> <span class="s">&quot;EASI&quot;</span> <span class="o">:</span> <span class="s">&quot;IOC&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">ecard_dev_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">device</span><span class="p">,</span>   <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">ecard_show_device</span><span class="p">,</span>    <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span>      <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">ecard_show_dma</span><span class="p">,</span>       <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span>      <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">ecard_show_irq</span><span class="p">,</span>       <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">ecard_show_resources</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">type</span><span class="p">,</span>     <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">ecard_show_type</span><span class="p">,</span>      <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">vendor</span><span class="p">,</span>   <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">ecard_show_vendor</span><span class="p">,</span>    <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR_NULL</span><span class="p">,</span>
<span class="p">};</span>


<span class="kt">int</span> <span class="nf">ecard_request_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">expansion_card</span> <span class="o">*</span><span class="n">ec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ECARD_NUM_RESOURCES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ecard_resource_end</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">ecard_resource_start</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
					<span class="n">ecard_resource_len</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
					<span class="n">ec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ecard_resource_end</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
				<span class="n">release_mem_region</span><span class="p">(</span><span class="n">ecard_resource_start</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
						   <span class="n">ecard_resource_len</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ecard_request_resources</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ecard_release_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">expansion_card</span> <span class="o">*</span><span class="n">ec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ECARD_NUM_RESOURCES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ecard_resource_end</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
			<span class="n">release_mem_region</span><span class="p">(</span><span class="n">ecard_resource_start</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
					   <span class="n">ecard_resource_len</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ecard_release_resources</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ecard_setirq</span><span class="p">(</span><span class="k">struct</span> <span class="n">expansion_card</span> <span class="o">*</span><span class="n">ec</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">expansion_card_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">irq_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">irq_data</span> <span class="o">=</span> <span class="n">irq_data</span><span class="p">;</span>
	<span class="n">barrier</span><span class="p">();</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ops</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ecard_setirq</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">ecardm_iomap</span><span class="p">(</span><span class="k">struct</span> <span class="n">expansion_card</span> <span class="o">*</span><span class="n">ec</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">res</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">maxsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">ecard_resource_start</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span> <span class="o">=</span> <span class="n">ecard_resource_end</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">start</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">maxsize</span> <span class="o">&amp;&amp;</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">maxsize</span><span class="p">)</span>
		<span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">maxsize</span><span class="p">;</span>
	
	<span class="k">return</span> <span class="n">devm_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ecardm_iomap</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Probe for an expansion card.</span>
<span class="cm"> *</span>
<span class="cm"> * If bit 1 of the first byte of the card is set, then the</span>
<span class="cm"> * card does not exist.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ecard_probe</span><span class="p">(</span><span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">irq</span><span class="p">,</span> <span class="n">card_type_t</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ecard_t</span> <span class="o">**</span><span class="n">ecp</span><span class="p">;</span>
	<span class="n">ecard_t</span> <span class="o">*</span><span class="n">ec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ex_ecid</span> <span class="n">cid</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ec</span> <span class="o">=</span> <span class="n">ecard_alloc_card</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ec</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ec</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">nomem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">addr</span> <span class="o">=</span> <span class="n">__ecard_address</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">ECARD_SYNC</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nodev</span><span class="p">;</span>

	<span class="n">cid</span><span class="p">.</span><span class="n">r_zero</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ecard_readbytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cid</span><span class="p">,</span> <span class="n">ec</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cid</span><span class="p">.</span><span class="n">r_zero</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nodev</span><span class="p">;</span>

	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="n">cid</span><span class="p">.</span><span class="n">r_id</span><span class="p">;</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">.</span><span class="n">cd</span>	<span class="o">=</span> <span class="n">cid</span><span class="p">.</span><span class="n">r_cd</span><span class="p">;</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">.</span><span class="n">is</span>	<span class="o">=</span> <span class="n">cid</span><span class="p">.</span><span class="n">r_is</span><span class="p">;</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">.</span><span class="n">w</span>	<span class="o">=</span> <span class="n">cid</span><span class="p">.</span><span class="n">r_w</span><span class="p">;</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">.</span><span class="n">manufacturer</span> <span class="o">=</span> <span class="n">ecard_getu16</span><span class="p">(</span><span class="n">cid</span><span class="p">.</span><span class="n">r_manu</span><span class="p">);</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">ecard_getu16</span><span class="p">(</span><span class="n">cid</span><span class="p">.</span><span class="n">r_prod</span><span class="p">);</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">.</span><span class="n">country</span> <span class="o">=</span> <span class="n">cid</span><span class="p">.</span><span class="n">r_country</span><span class="p">;</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">.</span><span class="n">irqmask</span> <span class="o">=</span> <span class="n">cid</span><span class="p">.</span><span class="n">r_irqmask</span><span class="p">;</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">.</span><span class="n">irqoff</span>  <span class="o">=</span> <span class="n">ecard_gets24</span><span class="p">(</span><span class="n">cid</span><span class="p">.</span><span class="n">r_irqoff</span><span class="p">);</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">.</span><span class="n">fiqmask</span> <span class="o">=</span> <span class="n">cid</span><span class="p">.</span><span class="n">r_fiqmask</span><span class="p">;</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">.</span><span class="n">fiqoff</span>  <span class="o">=</span> <span class="n">ecard_gets24</span><span class="p">(</span><span class="n">cid</span><span class="p">.</span><span class="n">r_fiqoff</span><span class="p">);</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">fiqaddr</span>	<span class="o">=</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">irqaddr</span>	<span class="o">=</span> <span class="n">addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">.</span><span class="n">is</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ec</span><span class="o">-&gt;</span><span class="n">irqmask</span> <span class="o">=</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">.</span><span class="n">irqmask</span><span class="p">;</span>
		<span class="n">ec</span><span class="o">-&gt;</span><span class="n">irqaddr</span> <span class="o">+=</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">.</span><span class="n">irqoff</span><span class="p">;</span>
		<span class="n">ec</span><span class="o">-&gt;</span><span class="n">fiqmask</span> <span class="o">=</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">.</span><span class="n">fiqmask</span><span class="p">;</span>
		<span class="n">ec</span><span class="o">-&gt;</span><span class="n">fiqaddr</span> <span class="o">+=</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">.</span><span class="n">fiqoff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ec</span><span class="o">-&gt;</span><span class="n">irqmask</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ec</span><span class="o">-&gt;</span><span class="n">fiqmask</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">blacklist</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">blacklist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">manufacturer</span> <span class="o">==</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">.</span><span class="n">manufacturer</span> <span class="o">&amp;&amp;</span>
		    <span class="n">blacklist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">product</span> <span class="o">==</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">.</span><span class="n">product</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ec</span><span class="o">-&gt;</span><span class="n">card_desc</span> <span class="o">=</span> <span class="n">blacklist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * hook the interrupt handlers</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq_set_chip_and_handler</span><span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ecard_chip</span><span class="p">,</span>
					 <span class="n">handle_level_irq</span><span class="p">);</span>
		<span class="n">irq_set_chip_data</span><span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ec</span><span class="p">);</span>
		<span class="n">set_irq_flags</span><span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">IRQF_VALID</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_ARCH_RPC</span>
	<span class="cm">/* On RiscPC, only first two slots have DMA capability */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">ec</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">slot</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ecp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cards</span><span class="p">;</span> <span class="o">*</span><span class="n">ecp</span><span class="p">;</span> <span class="n">ecp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">ecp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>

	<span class="o">*</span><span class="n">ecp</span> <span class="o">=</span> <span class="n">ec</span><span class="p">;</span>
	<span class="n">slot_to_expcard</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">=</span> <span class="n">ec</span><span class="p">;</span>

	<span class="n">device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">nodev:</span>
	<span class="n">ecard_free_card</span><span class="p">(</span><span class="n">ec</span><span class="p">);</span>
 <span class="nl">nomem:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialise the expansion card system.</span>
<span class="cm"> * Locate all hardware - interrupt management and</span>
<span class="cm"> * actual cards.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ecard_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="n">irqbase</span><span class="p">;</span>

	<span class="n">irqbase</span> <span class="o">=</span> <span class="n">irq_alloc_descs</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irqbase</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">irqbase</span><span class="p">;</span>

	<span class="n">task</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">ecard_task</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;kecardd&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Ecard: unable to create kernel thread: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">));</span>
		<span class="n">irq_free_descs</span><span class="p">(</span><span class="n">irqbase</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Probing expansion cards</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">slot</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">slot</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ecard_probe</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">irqbase</span> <span class="o">+</span> <span class="n">slot</span><span class="p">,</span> <span class="n">ECARD_EASI</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
			<span class="n">ecard_probe</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">irqbase</span> <span class="o">+</span> <span class="n">slot</span><span class="p">,</span> <span class="n">ECARD_IOC</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ecard_probe</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">ECARD_IOC</span><span class="p">);</span>

	<span class="n">irq_set_chained_handler</span><span class="p">(</span><span class="n">IRQ_EXPANSIONCARD</span><span class="p">,</span> <span class="n">ecard_irq_handler</span><span class="p">);</span>

	<span class="n">ecard_proc_init</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">ecard_init</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *	ECARD &quot;bus&quot;</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ecard_id</span> <span class="o">*</span>
<span class="nf">ecard_match_device</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ecard_id</span> <span class="o">*</span><span class="n">ids</span><span class="p">,</span> <span class="k">struct</span> <span class="n">expansion_card</span> <span class="o">*</span><span class="n">ec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">manufacturer</span> <span class="o">!=</span> <span class="mi">65535</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">.</span><span class="n">manufacturer</span> <span class="o">==</span> <span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">manufacturer</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ec</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">.</span><span class="n">product</span> <span class="o">==</span> <span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">product</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ids</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ecard_drv_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">expansion_card</span> <span class="o">*</span><span class="n">ec</span> <span class="o">=</span> <span class="n">ECARD_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ecard_driver</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">ECARD_DRV</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ecard_id</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">ecard_match_device</span><span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">id_table</span><span class="p">,</span> <span class="n">ec</span><span class="p">);</span>

	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">claimed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ec</span><span class="o">-&gt;</span><span class="n">claimed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ecard_drv_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">expansion_card</span> <span class="o">*</span><span class="n">ec</span> <span class="o">=</span> <span class="n">ECARD_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ecard_driver</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">ECARD_DRV</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>

	<span class="n">drv</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">(</span><span class="n">ec</span><span class="p">);</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">claimed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Restore the default operations.  We ensure that the</span>
<span class="cm">	 * ops are set before we change the data.</span>
<span class="cm">	 */</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ecard_default_ops</span><span class="p">;</span>
	<span class="n">barrier</span><span class="p">();</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">irq_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Before rebooting, we must make sure that the expansion card is in a</span>
<span class="cm"> * sensible state, so it can be re-detected.  This means that the first</span>
<span class="cm"> * page of the ROM must be visible.  We call the expansion cards reset</span>
<span class="cm"> * handler, if any.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ecard_drv_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">expansion_card</span> <span class="o">*</span><span class="n">ec</span> <span class="o">=</span> <span class="n">ECARD_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ecard_driver</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">ECARD_DRV</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ecard_request</span> <span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">)</span>
			<span class="n">drv</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">(</span><span class="n">ec</span><span class="p">);</span>
		<span class="n">ec</span><span class="o">-&gt;</span><span class="n">claimed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If this card has a loader, call the reset handler.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">loader</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="p">.</span><span class="n">fn</span> <span class="o">=</span> <span class="n">ecard_task_reset</span><span class="p">;</span>
		<span class="n">req</span><span class="p">.</span><span class="n">ec</span> <span class="o">=</span> <span class="n">ec</span><span class="p">;</span>
		<span class="n">ecard_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ecard_register_driver</span><span class="p">(</span><span class="k">struct</span> <span class="n">ecard_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drv</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ecard_bus_type</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ecard_remove_driver</span><span class="p">(</span><span class="k">struct</span> <span class="n">ecard_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ecard_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">_drv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">expansion_card</span> <span class="o">*</span><span class="n">ec</span> <span class="o">=</span> <span class="n">ECARD_DEV</span><span class="p">(</span><span class="n">_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ecard_driver</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">ECARD_DRV</span><span class="p">(</span><span class="n">_drv</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">id_table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ecard_match_device</span><span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">id_table</span><span class="p">,</span> <span class="n">ec</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">bus_type</span> <span class="n">ecard_bus_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ecard&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev_attrs</span>	<span class="o">=</span> <span class="n">ecard_dev_attrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">match</span>		<span class="o">=</span> <span class="n">ecard_match</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">ecard_drv_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">ecard_drv_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">ecard_drv_shutdown</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ecard_bus_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">bus_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ecard_bus_type</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">postcore_initcall</span><span class="p">(</span><span class="n">ecard_bus_init</span><span class="p">);</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ecard_readchunk</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ecard_register_driver</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ecard_remove_driver</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ecard_bus_type</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
