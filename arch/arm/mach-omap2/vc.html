<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › mach-omap2 › vc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>vc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * OMAP Voltage Controller (VC) interface</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2011 Texas Instruments, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * This file is licensed under the terms of the GNU General Public</span>
<span class="cm"> * License version 2. This program is licensed &quot;as is&quot; without any</span>
<span class="cm"> * warranty of any kind, whether express or implied.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/bug.h&gt;</span>

<span class="cp">#include &lt;plat/cpu.h&gt;</span>

<span class="cp">#include &quot;voltage.h&quot;</span>
<span class="cp">#include &quot;vc.h&quot;</span>
<span class="cp">#include &quot;prm-regbits-34xx.h&quot;</span>
<span class="cp">#include &quot;prm-regbits-44xx.h&quot;</span>
<span class="cp">#include &quot;prm44xx.h&quot;</span>

<span class="cm">/**</span>
<span class="cm"> * struct omap_vc_channel_cfg - describe the cfg_channel bitfield</span>
<span class="cm"> * @sa: bit for slave address</span>
<span class="cm"> * @rav: bit for voltage configuration register</span>
<span class="cm"> * @rac: bit for command configuration register</span>
<span class="cm"> * @racen: enable bit for RAC</span>
<span class="cm"> * @cmd: bit for command value set selection</span>
<span class="cm"> *</span>
<span class="cm"> * Channel configuration bits, common for OMAP3+</span>
<span class="cm"> * OMAP3 register: PRM_VC_CH_CONF</span>
<span class="cm"> * OMAP4 register: PRM_VC_CFG_CHANNEL</span>
<span class="cm"> * OMAP5 register: PRM_VC_SMPS_&lt;voltdm&gt;_CONFIG</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">omap_vc_channel_cfg</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">sa</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rav</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rac</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">racen</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cmd</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">omap_vc_channel_cfg</span> <span class="n">vc_default_channel_cfg</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">sa</span>    <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
	<span class="p">.</span><span class="n">rav</span>   <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
	<span class="p">.</span><span class="n">rac</span>   <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
	<span class="p">.</span><span class="n">racen</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
	<span class="p">.</span><span class="n">cmd</span>   <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * On OMAP3+, all VC channels have the above default bitfield</span>
<span class="cm"> * configuration, except the OMAP4 MPU channel.  This appears</span>
<span class="cm"> * to be a freak accident as every other VC channel has the</span>
<span class="cm"> * default configuration, thus creating a mutant channel config.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">omap_vc_channel_cfg</span> <span class="n">vc_mutant_channel_cfg</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">sa</span>    <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
	<span class="p">.</span><span class="n">rav</span>   <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
	<span class="p">.</span><span class="n">rac</span>   <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
	<span class="p">.</span><span class="n">racen</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
	<span class="p">.</span><span class="n">cmd</span>   <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">omap_vc_channel_cfg</span> <span class="o">*</span><span class="n">vc_cfg_bits</span><span class="p">;</span>
<span class="cp">#define CFG_CHANNEL_MASK 0x1f</span>

<span class="cm">/**</span>
<span class="cm"> * omap_vc_config_channel - configure VC channel to PMIC mappings</span>
<span class="cm"> * @voltdm: pointer to voltagdomain defining the desired VC channel</span>
<span class="cm"> *</span>
<span class="cm"> * Configures the VC channel to PMIC mappings for the following</span>
<span class="cm"> * PMIC settings</span>
<span class="cm"> * - i2c slave address (SA)</span>
<span class="cm"> * - voltage configuration address (RAV)</span>
<span class="cm"> * - command configuration address (RAC) and enable bit (RACEN)</span>
<span class="cm"> * - command values for ON, ONLP, RET and OFF (CMD)</span>
<span class="cm"> *</span>
<span class="cm"> * This function currently only allows flexible configuration of the</span>
<span class="cm"> * non-default channel.  Starting with OMAP4, there are more than 2</span>
<span class="cm"> * channels, with one defined as the default (on OMAP4, it&#39;s MPU.)</span>
<span class="cm"> * Only the non-default channel can be configured.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_vc_config_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">voltagedomain</span> <span class="o">*</span><span class="n">voltdm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_vc_channel</span> <span class="o">*</span><span class="n">vc</span> <span class="o">=</span> <span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">vc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * For default channel, the only configurable bit is RACEN.</span>
<span class="cm">	 * All others must stay at zero (see function comment above.)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">OMAP_VC_CHANNEL_DEFAULT</span><span class="p">)</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">cfg_channel</span> <span class="o">&amp;=</span> <span class="n">vc_cfg_bits</span><span class="o">-&gt;</span><span class="n">racen</span><span class="p">;</span>

	<span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">rmw</span><span class="p">(</span><span class="n">CFG_CHANNEL_MASK</span> <span class="o">&lt;&lt;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">cfg_channel_sa_shift</span><span class="p">,</span>
		    <span class="n">vc</span><span class="o">-&gt;</span><span class="n">cfg_channel</span> <span class="o">&lt;&lt;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">cfg_channel_sa_shift</span><span class="p">,</span>
		    <span class="n">vc</span><span class="o">-&gt;</span><span class="n">cfg_channel_reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Voltage scale and accessory APIs */</span>
<span class="kt">int</span> <span class="nf">omap_vc_pre_scale</span><span class="p">(</span><span class="k">struct</span> <span class="n">voltagedomain</span> <span class="o">*</span><span class="n">voltdm</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">target_volt</span><span class="p">,</span>
		      <span class="n">u8</span> <span class="o">*</span><span class="n">target_vsel</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">current_vsel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_vc_channel</span> <span class="o">*</span><span class="n">vc</span> <span class="o">=</span> <span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">vc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vc_cmdval</span><span class="p">;</span>

	<span class="cm">/* Check if sufficient pmic info is available for this vdd */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">pmic</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Insufficient pmic info to scale the vdd_%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">pmic</span><span class="o">-&gt;</span><span class="n">uv_to_vsel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: PMIC function to convert voltage in uV to&quot;</span>
			<span class="s">&quot;vsel not registered. Hence unable to scale voltage&quot;</span>
			<span class="s">&quot;for vdd_%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">||</span> <span class="o">!</span><span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: No read/write API for accessing vdd_%s regs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">target_vsel</span> <span class="o">=</span> <span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">pmic</span><span class="o">-&gt;</span><span class="n">uv_to_vsel</span><span class="p">(</span><span class="n">target_volt</span><span class="p">);</span>
	<span class="o">*</span><span class="n">current_vsel</span> <span class="o">=</span> <span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">pmic</span><span class="o">-&gt;</span><span class="n">uv_to_vsel</span><span class="p">(</span><span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">nominal_volt</span><span class="p">);</span>

	<span class="cm">/* Setting the ON voltage to the new target voltage */</span>
	<span class="n">vc_cmdval</span> <span class="o">=</span> <span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">cmdval_reg</span><span class="p">);</span>
	<span class="n">vc_cmdval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cmd_on_mask</span><span class="p">;</span>
	<span class="n">vc_cmdval</span> <span class="o">|=</span> <span class="p">(</span><span class="o">*</span><span class="n">target_vsel</span> <span class="o">&lt;&lt;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cmd_on_shift</span><span class="p">);</span>
	<span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">vc_cmdval</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">cmdval_reg</span><span class="p">);</span>

	<span class="n">omap_vp_update_errorgain</span><span class="p">(</span><span class="n">voltdm</span><span class="p">,</span> <span class="n">target_volt</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">omap_vc_post_scale</span><span class="p">(</span><span class="k">struct</span> <span class="n">voltagedomain</span> <span class="o">*</span><span class="n">voltdm</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">target_volt</span><span class="p">,</span>
			<span class="n">u8</span> <span class="n">target_vsel</span><span class="p">,</span> <span class="n">u8</span> <span class="n">current_vsel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">smps_steps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">smps_delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">smps_steps</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">target_vsel</span> <span class="o">-</span> <span class="n">current_vsel</span><span class="p">);</span>
	<span class="cm">/* SMPS slew rate / step size. 2us added as buffer. */</span>
	<span class="n">smps_delay</span> <span class="o">=</span> <span class="p">((</span><span class="n">smps_steps</span> <span class="o">*</span> <span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">pmic</span><span class="o">-&gt;</span><span class="n">step_size</span><span class="p">)</span> <span class="o">/</span>
			<span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">pmic</span><span class="o">-&gt;</span><span class="n">slew_rate</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">smps_delay</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* vc_bypass_scale - VC bypass method of voltage scaling */</span>
<span class="kt">int</span> <span class="nf">omap_vc_bypass_scale</span><span class="p">(</span><span class="k">struct</span> <span class="n">voltagedomain</span> <span class="o">*</span><span class="n">voltdm</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">target_volt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_vc_channel</span> <span class="o">*</span><span class="n">vc</span> <span class="o">=</span> <span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">vc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">loop_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">retries_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vc_valid</span><span class="p">,</span> <span class="n">vc_bypass_val_reg</span><span class="p">,</span> <span class="n">vc_bypass_value</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">target_vsel</span><span class="p">,</span> <span class="n">current_vsel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">omap_vc_pre_scale</span><span class="p">(</span><span class="n">voltdm</span><span class="p">,</span> <span class="n">target_volt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target_vsel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current_vsel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">vc_valid</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">;</span>
	<span class="n">vc_bypass_val_reg</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">bypass_val_reg</span><span class="p">;</span>
	<span class="n">vc_bypass_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_vsel</span> <span class="o">&lt;&lt;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">data_shift</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">volt_reg_addr</span> <span class="o">&lt;&lt;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">regaddr_shift</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">i2c_slave_addr</span> <span class="o">&lt;&lt;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">slaveaddr_shift</span><span class="p">);</span>

	<span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">vc_bypass_value</span><span class="p">,</span> <span class="n">vc_bypass_val_reg</span><span class="p">);</span>
	<span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">vc_bypass_value</span> <span class="o">|</span> <span class="n">vc_valid</span><span class="p">,</span> <span class="n">vc_bypass_val_reg</span><span class="p">);</span>

	<span class="n">vc_bypass_value</span> <span class="o">=</span> <span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">vc_bypass_val_reg</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Loop till the bypass command is acknowledged from the SMPS.</span>
<span class="cm">	 * NOTE: This is legacy code. The loop count and retry count needs</span>
<span class="cm">	 * to be revisited.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vc_bypass_value</span> <span class="o">&amp;</span> <span class="n">vc_valid</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">loop_cnt</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">retries_cnt</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: Retry count exceeded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">loop_cnt</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retries_cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">loop_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">vc_bypass_value</span> <span class="o">=</span> <span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">vc_bypass_val_reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">omap_vc_post_scale</span><span class="p">(</span><span class="n">voltdm</span><span class="p">,</span> <span class="n">target_volt</span><span class="p">,</span> <span class="n">target_vsel</span><span class="p">,</span> <span class="n">current_vsel</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">omap3_vfsm_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">voltagedomain</span> <span class="o">*</span><span class="n">voltdm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Voltage Manager FSM parameters init</span>
<span class="cm">	 * XXX This data should be passed in from the board file</span>
<span class="cm">	 */</span>
	<span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">OMAP3_CLKSETUP</span><span class="p">,</span> <span class="n">OMAP3_PRM_CLKSETUP_OFFSET</span><span class="p">);</span>
	<span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">OMAP3_VOLTOFFSET</span><span class="p">,</span> <span class="n">OMAP3_PRM_VOLTOFFSET_OFFSET</span><span class="p">);</span>
	<span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">OMAP3_VOLTSETUP2</span><span class="p">,</span> <span class="n">OMAP3_PRM_VOLTSETUP2_OFFSET</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">omap3_vc_init_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">voltagedomain</span> <span class="o">*</span><span class="n">voltdm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">bool</span> <span class="n">is_initialized</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_initialized</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">omap3_vfsm_init</span><span class="p">(</span><span class="n">voltdm</span><span class="p">);</span>

	<span class="n">is_initialized</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* OMAP4 specific voltage init functions */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">omap4_vc_init_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">voltagedomain</span> <span class="o">*</span><span class="n">voltdm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">bool</span> <span class="n">is_initialized</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vc_val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_initialized</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* XXX These are magic numbers and do not belong! */</span>
	<span class="n">vc_val</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x60</span> <span class="o">&lt;&lt;</span> <span class="n">OMAP4430_SCLL_SHIFT</span> <span class="o">|</span> <span class="mh">0x26</span> <span class="o">&lt;&lt;</span> <span class="n">OMAP4430_SCLH_SHIFT</span><span class="p">);</span>
	<span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">vc_val</span><span class="p">,</span> <span class="n">OMAP4_PRM_VC_CFG_I2C_CLK_OFFSET</span><span class="p">);</span>

	<span class="n">is_initialized</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * omap_vc_i2c_init - initialize I2C interface to PMIC</span>
<span class="cm"> * @voltdm: voltage domain containing VC data</span>
<span class="cm"> *</span>
<span class="cm"> * Use PMIC supplied settings for I2C high-speed mode and</span>
<span class="cm"> * master code (if set) and program the VC I2C configuration</span>
<span class="cm"> * register.</span>
<span class="cm"> *</span>
<span class="cm"> * The VC I2C configuration is common to all VC channels,</span>
<span class="cm"> * so this function only configures I2C for the first VC</span>
<span class="cm"> * channel registers.  All other VC channels will use the</span>
<span class="cm"> * same configuration.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">omap_vc_i2c_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">voltagedomain</span> <span class="o">*</span><span class="n">voltdm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_vc_channel</span> <span class="o">*</span><span class="n">vc</span> <span class="o">=</span> <span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">vc</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">bool</span> <span class="n">initialized</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">bool</span> <span class="n">i2c_high_speed</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mcode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">initialized</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">pmic</span><span class="o">-&gt;</span><span class="n">i2c_high_speed</span> <span class="o">!=</span> <span class="n">i2c_high_speed</span><span class="p">)</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%s: I2C config for vdd_%s does not match other channels (%u).&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i2c_high_speed</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i2c_high_speed</span> <span class="o">=</span> <span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">pmic</span><span class="o">-&gt;</span><span class="n">i2c_high_speed</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_high_speed</span><span class="p">)</span>
		<span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">rmw</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">i2c_cfg_hsen_mask</span><span class="p">,</span>
			    <span class="n">vc</span><span class="o">-&gt;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">i2c_cfg_hsen_mask</span><span class="p">,</span>
			    <span class="n">vc</span><span class="o">-&gt;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">i2c_cfg_reg</span><span class="p">);</span>

	<span class="n">mcode</span> <span class="o">=</span> <span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">pmic</span><span class="o">-&gt;</span><span class="n">i2c_mcode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mcode</span><span class="p">)</span>
		<span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">rmw</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">i2c_mcode_mask</span><span class="p">,</span>
			    <span class="n">mcode</span> <span class="o">&lt;&lt;</span> <span class="n">__ffs</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">i2c_mcode_mask</span><span class="p">),</span>
			    <span class="n">vc</span><span class="o">-&gt;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">i2c_cfg_reg</span><span class="p">);</span>

	<span class="n">initialized</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">omap_vc_init_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">voltagedomain</span> <span class="o">*</span><span class="n">voltdm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_vc_channel</span> <span class="o">*</span><span class="n">vc</span> <span class="o">=</span> <span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">vc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">on_vsel</span><span class="p">,</span> <span class="n">onlp_vsel</span><span class="p">,</span> <span class="n">ret_vsel</span><span class="p">,</span> <span class="n">off_vsel</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">pmic</span> <span class="o">||</span> <span class="o">!</span><span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">pmic</span><span class="o">-&gt;</span><span class="n">uv_to_vsel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: No PMIC info for vdd_%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">||</span> <span class="o">!</span><span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: No read/write API for accessing vdd_%s regs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">cfg_channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">OMAP_VC_CHANNEL_CFG_MUTANT</span><span class="p">)</span>
		<span class="n">vc_cfg_bits</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vc_mutant_channel_cfg</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">vc_cfg_bits</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vc_default_channel_cfg</span><span class="p">;</span>

	<span class="cm">/* get PMIC/board specific settings */</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">i2c_slave_addr</span> <span class="o">=</span> <span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">pmic</span><span class="o">-&gt;</span><span class="n">i2c_slave_addr</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">volt_reg_addr</span> <span class="o">=</span> <span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">pmic</span><span class="o">-&gt;</span><span class="n">volt_reg_addr</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">cmd_reg_addr</span> <span class="o">=</span> <span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">pmic</span><span class="o">-&gt;</span><span class="n">cmd_reg_addr</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">setup_time</span> <span class="o">=</span> <span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">pmic</span><span class="o">-&gt;</span><span class="n">volt_setup_time</span><span class="p">;</span>

	<span class="cm">/* Configure the i2c slave address for this VC */</span>
	<span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">rmw</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">smps_sa_mask</span><span class="p">,</span>
		    <span class="n">vc</span><span class="o">-&gt;</span><span class="n">i2c_slave_addr</span> <span class="o">&lt;&lt;</span> <span class="n">__ffs</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">smps_sa_mask</span><span class="p">),</span>
		    <span class="n">vc</span><span class="o">-&gt;</span><span class="n">smps_sa_reg</span><span class="p">);</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">cfg_channel</span> <span class="o">|=</span> <span class="n">vc_cfg_bits</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Configure the PMIC register addresses.</span>
<span class="cm">	 */</span>
	<span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">rmw</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">smps_volra_mask</span><span class="p">,</span>
		    <span class="n">vc</span><span class="o">-&gt;</span><span class="n">volt_reg_addr</span> <span class="o">&lt;&lt;</span> <span class="n">__ffs</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">smps_volra_mask</span><span class="p">),</span>
		    <span class="n">vc</span><span class="o">-&gt;</span><span class="n">smps_volra_reg</span><span class="p">);</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">cfg_channel</span> <span class="o">|=</span> <span class="n">vc_cfg_bits</span><span class="o">-&gt;</span><span class="n">rav</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">cmd_reg_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">rmw</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">smps_cmdra_mask</span><span class="p">,</span>
			    <span class="n">vc</span><span class="o">-&gt;</span><span class="n">cmd_reg_addr</span> <span class="o">&lt;&lt;</span> <span class="n">__ffs</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">smps_cmdra_mask</span><span class="p">),</span>
			    <span class="n">vc</span><span class="o">-&gt;</span><span class="n">smps_cmdra_reg</span><span class="p">);</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">cfg_channel</span> <span class="o">|=</span> <span class="n">vc_cfg_bits</span><span class="o">-&gt;</span><span class="n">rac</span> <span class="o">|</span> <span class="n">vc_cfg_bits</span><span class="o">-&gt;</span><span class="n">racen</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set up the on, inactive, retention and off voltage */</span>
	<span class="n">on_vsel</span> <span class="o">=</span> <span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">pmic</span><span class="o">-&gt;</span><span class="n">uv_to_vsel</span><span class="p">(</span><span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">pmic</span><span class="o">-&gt;</span><span class="n">on_volt</span><span class="p">);</span>
	<span class="n">onlp_vsel</span> <span class="o">=</span> <span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">pmic</span><span class="o">-&gt;</span><span class="n">uv_to_vsel</span><span class="p">(</span><span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">pmic</span><span class="o">-&gt;</span><span class="n">onlp_volt</span><span class="p">);</span>
	<span class="n">ret_vsel</span> <span class="o">=</span> <span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">pmic</span><span class="o">-&gt;</span><span class="n">uv_to_vsel</span><span class="p">(</span><span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">pmic</span><span class="o">-&gt;</span><span class="n">ret_volt</span><span class="p">);</span>
	<span class="n">off_vsel</span> <span class="o">=</span> <span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">pmic</span><span class="o">-&gt;</span><span class="n">uv_to_vsel</span><span class="p">(</span><span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">pmic</span><span class="o">-&gt;</span><span class="n">off_volt</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="n">on_vsel</span> <span class="o">&lt;&lt;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cmd_on_shift</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">(</span><span class="n">onlp_vsel</span> <span class="o">&lt;&lt;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cmd_onlp_shift</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">(</span><span class="n">ret_vsel</span> <span class="o">&lt;&lt;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cmd_ret_shift</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">(</span><span class="n">off_vsel</span> <span class="o">&lt;&lt;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cmd_off_shift</span><span class="p">));</span>
	<span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">cmdval_reg</span><span class="p">);</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">cfg_channel</span> <span class="o">|=</span> <span class="n">vc_cfg_bits</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>

	<span class="cm">/* Channel configuration */</span>
	<span class="n">omap_vc_config_channel</span><span class="p">(</span><span class="n">voltdm</span><span class="p">);</span>

	<span class="cm">/* Configure the setup times */</span>
	<span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">rmw</span><span class="p">(</span><span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">vfsm</span><span class="o">-&gt;</span><span class="n">voltsetup_mask</span><span class="p">,</span>
		    <span class="n">vc</span><span class="o">-&gt;</span><span class="n">setup_time</span> <span class="o">&lt;&lt;</span> <span class="n">__ffs</span><span class="p">(</span><span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">vfsm</span><span class="o">-&gt;</span><span class="n">voltsetup_mask</span><span class="p">),</span>
		    <span class="n">voltdm</span><span class="o">-&gt;</span><span class="n">vfsm</span><span class="o">-&gt;</span><span class="n">voltsetup_reg</span><span class="p">);</span>

	<span class="n">omap_vc_i2c_init</span><span class="p">(</span><span class="n">voltdm</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap34xx</span><span class="p">())</span>
		<span class="n">omap3_vc_init_channel</span><span class="p">(</span><span class="n">voltdm</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap44xx</span><span class="p">())</span>
		<span class="n">omap4_vc_init_channel</span><span class="p">(</span><span class="n">voltdm</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
