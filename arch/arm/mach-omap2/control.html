<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › mach-omap2 › control.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>control.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * OMAP2/3 System Control Module register access</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007 Texas Instruments, Inc.</span>
<span class="cm"> * Copyright (C) 2007 Nokia Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * Written by Paul Walmsley</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>
<span class="cp">#undef DEBUG</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>

<span class="cp">#include &lt;plat/hardware.h&gt;</span>
<span class="cp">#include &lt;plat/sdrc.h&gt;</span>

<span class="cp">#include &quot;iomap.h&quot;</span>
<span class="cp">#include &quot;common.h&quot;</span>
<span class="cp">#include &quot;cm-regbits-34xx.h&quot;</span>
<span class="cp">#include &quot;prm-regbits-34xx.h&quot;</span>
<span class="cp">#include &quot;prm2xxx_3xxx.h&quot;</span>
<span class="cp">#include &quot;cm2xxx_3xxx.h&quot;</span>
<span class="cp">#include &quot;sdrc.h&quot;</span>
<span class="cp">#include &quot;pm.h&quot;</span>
<span class="cp">#include &quot;control.h&quot;</span>

<span class="cm">/* Used by omap3_ctrl_save_padconf() */</span>
<span class="cp">#define START_PADCONF_SAVE		0x2</span>
<span class="cp">#define PADCONF_SAVE_DONE		0x1</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">omap2_ctrl_base</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">omap4_ctrl_pad_base</span><span class="p">;</span>

<span class="cp">#if defined(CONFIG_ARCH_OMAP3) &amp;&amp; defined(CONFIG_PM)</span>
<span class="k">struct</span> <span class="n">omap3_scratchpad</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">boot_config_ptr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">public_restore_ptr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">secure_ram_restore_ptr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sdrc_module_semaphore</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">prcm_block_offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sdrc_block_offset</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">omap3_scratchpad_prcm_block</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">prm_clksrc_ctrl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">prm_clksel</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cm_clksel_core</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cm_clksel_wkup</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cm_clken_pll</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cm_autoidle_pll</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cm_clksel1_pll</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cm_clksel2_pll</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cm_clksel3_pll</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cm_clken_pll_mpu</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cm_autoidle_pll_mpu</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cm_clksel1_pll_mpu</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cm_clksel2_pll_mpu</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">prcm_block_size</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">omap3_scratchpad_sdrc_block</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">sysconfig</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cs_cfg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sharing</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">err_type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dll_a_ctrl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dll_b_ctrl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">power</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cs_0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mcfg_0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mr_0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">emr_1_0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">emr_2_0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">emr_3_0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">actim_ctrla_0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">actim_ctrlb_0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rfr_ctrl_0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cs_1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mcfg_1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mr_1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">emr_1_1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">emr_2_1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">emr_3_1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">actim_ctrla_1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">actim_ctrlb_1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rfr_ctrl_1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">dcdl_1_ctrl</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">dcdl_2_ctrl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">block_size</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="o">*</span><span class="n">omap3_secure_ram_storage</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * This is used to store ARM registers in SDRAM before attempting</span>
<span class="cm"> * an MPU OFF. The save and restore happens from the SRAM sleep code.</span>
<span class="cm"> * The address is stored in scratchpad, so that it can be used</span>
<span class="cm"> * during the restore path.</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="n">omap3_arm_context</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>

<span class="k">struct</span> <span class="n">omap3_control_regs</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">sysconfig</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">devconf0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mem_dftrw0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mem_dftrw1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">msuspendmux_0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">msuspendmux_1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">msuspendmux_2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">msuspendmux_3</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">msuspendmux_4</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">msuspendmux_5</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sec_ctrl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">devconf1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">csirxfe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">iva2_bootaddr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">iva2_bootmod</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">debobs_0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">debobs_1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">debobs_2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">debobs_3</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">debobs_4</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">debobs_5</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">debobs_6</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">debobs_7</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">debobs_8</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">prog_io0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">prog_io1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dss_dpll_spreading</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">core_dpll_spreading</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">per_dpll_spreading</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">usbhost_dpll_spreading</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pbias_lite</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp_sensor</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sramldo4</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sramldo5</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">csi</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">padconf_sys_nirq</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">omap3_control_regs</span> <span class="n">control_context</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ARCH_OMAP3 &amp;&amp; CONFIG_PM */</span><span class="cp"></span>

<span class="cp">#define OMAP_CTRL_REGADDR(reg)		(omap2_ctrl_base + (reg))</span>
<span class="cp">#define OMAP4_CTRL_PAD_REGADDR(reg)	(omap4_ctrl_pad_base + (reg))</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">omap2_set_globals_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_globals</span> <span class="o">*</span><span class="n">omap2_globals</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">omap2_globals</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">)</span>
		<span class="n">omap2_ctrl_base</span> <span class="o">=</span> <span class="n">omap2_globals</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">omap2_globals</span><span class="o">-&gt;</span><span class="n">ctrl_pad</span><span class="p">)</span>
		<span class="n">omap4_ctrl_pad_base</span> <span class="o">=</span> <span class="n">omap2_globals</span><span class="o">-&gt;</span><span class="n">ctrl_pad</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">omap_ctrl_base_get</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">omap2_ctrl_base</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">omap_ctrl_readb</span><span class="p">(</span><span class="n">u16</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__raw_readb</span><span class="p">(</span><span class="n">OMAP_CTRL_REGADDR</span><span class="p">(</span><span class="n">offset</span><span class="p">));</span>
<span class="p">}</span>

<span class="n">u16</span> <span class="nf">omap_ctrl_readw</span><span class="p">(</span><span class="n">u16</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__raw_readw</span><span class="p">(</span><span class="n">OMAP_CTRL_REGADDR</span><span class="p">(</span><span class="n">offset</span><span class="p">));</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">omap_ctrl_readl</span><span class="p">(</span><span class="n">u16</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">OMAP_CTRL_REGADDR</span><span class="p">(</span><span class="n">offset</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">omap_ctrl_writeb</span><span class="p">(</span><span class="n">u8</span> <span class="n">val</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__raw_writeb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">OMAP_CTRL_REGADDR</span><span class="p">(</span><span class="n">offset</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">omap_ctrl_writew</span><span class="p">(</span><span class="n">u16</span> <span class="n">val</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">OMAP_CTRL_REGADDR</span><span class="p">(</span><span class="n">offset</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">omap_ctrl_writel</span><span class="p">(</span><span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">OMAP_CTRL_REGADDR</span><span class="p">(</span><span class="n">offset</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * On OMAP4 control pad are not addressable from control</span>
<span class="cm"> * core base. So the common omap_ctrl_read/write APIs breaks</span>
<span class="cm"> * Hence export separate APIs to manage the omap4 pad control</span>
<span class="cm"> * registers. This APIs will work only for OMAP4</span>
<span class="cm"> */</span>

<span class="n">u32</span> <span class="nf">omap4_ctrl_pad_readl</span><span class="p">(</span><span class="n">u16</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">OMAP4_CTRL_PAD_REGADDR</span><span class="p">(</span><span class="n">offset</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">omap4_ctrl_pad_writel</span><span class="p">(</span><span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">OMAP4_CTRL_PAD_REGADDR</span><span class="p">(</span><span class="n">offset</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_ARCH_OMAP3</span>

<span class="cm">/**</span>
<span class="cm"> * omap3_ctrl_write_boot_mode - set scratchpad boot mode for the next boot</span>
<span class="cm"> * @bootmode: 8-bit value to pass to some boot code</span>
<span class="cm"> *</span>
<span class="cm"> * Set the bootmode in the scratchpad RAM.  This is used after the</span>
<span class="cm"> * system restarts.  Not sure what actually uses this - it may be the</span>
<span class="cm"> * bootloader, rather than the boot ROM - contrary to the preserved</span>
<span class="cm"> * comment below.  No return value.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">omap3_ctrl_write_boot_mode</span><span class="p">(</span><span class="n">u8</span> <span class="n">bootmode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="sc">&#39;B&#39;</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="sc">&#39;M&#39;</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">bootmode</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reserve the first word in scratchpad for communicating</span>
<span class="cm">	 * with the boot ROM. A pointer to a data structure</span>
<span class="cm">	 * describing the boot process can be stored there,</span>
<span class="cm">	 * cf. OMAP34xx TRM, Initialization / Software Booting</span>
<span class="cm">	 * Configuration.</span>
<span class="cm">	 *</span>
<span class="cm">	 * XXX This should use some omap_ctrl_writel()-type function</span>
<span class="cm">	 */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">OMAP2_L4_IO_ADDRESS</span><span class="p">(</span><span class="n">OMAP343X_SCRATCHPAD</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_ARCH_OMAP3) &amp;&amp; defined(CONFIG_PM)</span>
<span class="cm">/*</span>
<span class="cm"> * Clears the scratchpad contents in case of cold boot-</span>
<span class="cm"> * called during bootup</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">omap3_clear_scratchpad_contents</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">max_offset</span> <span class="o">=</span> <span class="n">OMAP343X_SCRATCHPAD_ROM_OFFSET</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">v_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">v_addr</span> <span class="o">=</span> <span class="n">OMAP2_L4_IO_ADDRESS</span><span class="p">(</span><span class="n">OMAP343X_SCRATCHPAD_ROM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">omap2_prm_read_mod_reg</span><span class="p">(</span><span class="n">OMAP3430_GR_MOD</span><span class="p">,</span> <span class="n">OMAP3_PRM_RSTST_OFFSET</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="n">OMAP3430_GLOBAL_COLD_RST_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">offset</span> <span class="o">&lt;=</span> <span class="n">max_offset</span><span class="p">;</span> <span class="n">offset</span> <span class="o">+=</span> <span class="mh">0x4</span><span class="p">)</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="p">(</span><span class="n">v_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">));</span>
		<span class="n">omap2_prm_set_mod_reg_bits</span><span class="p">(</span><span class="n">OMAP3430_GLOBAL_COLD_RST_MASK</span><span class="p">,</span>
					   <span class="n">OMAP3430_GR_MOD</span><span class="p">,</span>
					   <span class="n">OMAP3_PRM_RSTST_OFFSET</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Populate the scratchpad structure with restore structure */</span>
<span class="kt">void</span> <span class="nf">omap3_save_scratchpad_contents</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span>  <span class="n">__iomem</span> <span class="o">*</span><span class="n">scratchpad_address</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">arm_context_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap3_scratchpad</span> <span class="n">scratchpad_contents</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap3_scratchpad_prcm_block</span> <span class="n">prcm_block_contents</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap3_scratchpad_sdrc_block</span> <span class="n">sdrc_block_contents</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Populate the Scratchpad contents</span>
<span class="cm">	 *</span>
<span class="cm">	 * The &quot;get_*restore_pointer&quot; functions are used to provide a</span>
<span class="cm">	 * physical restore address where the ROM code jumps while waking</span>
<span class="cm">	 * up from MPU OFF/OSWR state.</span>
<span class="cm">	 * The restore pointer is stored into the scratchpad.</span>
<span class="cm">	 */</span>
	<span class="n">scratchpad_contents</span><span class="p">.</span><span class="n">boot_config_ptr</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap3630</span><span class="p">())</span>
		<span class="n">scratchpad_contents</span><span class="p">.</span><span class="n">public_restore_ptr</span> <span class="o">=</span>
			<span class="n">virt_to_phys</span><span class="p">(</span><span class="n">omap3_restore_3630</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">omap_rev</span><span class="p">()</span> <span class="o">!=</span> <span class="n">OMAP3430_REV_ES3_0</span> <span class="o">&amp;&amp;</span>
					<span class="n">omap_rev</span><span class="p">()</span> <span class="o">!=</span> <span class="n">OMAP3430_REV_ES3_1</span><span class="p">)</span>
		<span class="n">scratchpad_contents</span><span class="p">.</span><span class="n">public_restore_ptr</span> <span class="o">=</span>
			<span class="n">virt_to_phys</span><span class="p">(</span><span class="n">omap3_restore</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">scratchpad_contents</span><span class="p">.</span><span class="n">public_restore_ptr</span> <span class="o">=</span>
			<span class="n">virt_to_phys</span><span class="p">(</span><span class="n">omap3_restore_es3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">omap_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">OMAP2_DEVICE_TYPE_GP</span><span class="p">)</span>
		<span class="n">scratchpad_contents</span><span class="p">.</span><span class="n">secure_ram_restore_ptr</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">scratchpad_contents</span><span class="p">.</span><span class="n">secure_ram_restore_ptr</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">__pa</span><span class="p">(</span><span class="n">omap3_secure_ram_storage</span><span class="p">);</span>
	<span class="n">scratchpad_contents</span><span class="p">.</span><span class="n">sdrc_module_semaphore</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">scratchpad_contents</span><span class="p">.</span><span class="n">prcm_block_offset</span> <span class="o">=</span> <span class="mh">0x2C</span><span class="p">;</span>
	<span class="n">scratchpad_contents</span><span class="p">.</span><span class="n">sdrc_block_offset</span> <span class="o">=</span> <span class="mh">0x64</span><span class="p">;</span>

	<span class="cm">/* Populate the PRCM block contents */</span>
	<span class="n">prcm_block_contents</span><span class="p">.</span><span class="n">prm_clksrc_ctrl</span> <span class="o">=</span>
		<span class="n">omap2_prm_read_mod_reg</span><span class="p">(</span><span class="n">OMAP3430_GR_MOD</span><span class="p">,</span>
				       <span class="n">OMAP3_PRM_CLKSRC_CTRL_OFFSET</span><span class="p">);</span>
	<span class="n">prcm_block_contents</span><span class="p">.</span><span class="n">prm_clksel</span> <span class="o">=</span>
		<span class="n">omap2_prm_read_mod_reg</span><span class="p">(</span><span class="n">OMAP3430_CCR_MOD</span><span class="p">,</span>
				       <span class="n">OMAP3_PRM_CLKSEL_OFFSET</span><span class="p">);</span>
	<span class="n">prcm_block_contents</span><span class="p">.</span><span class="n">cm_clksel_core</span> <span class="o">=</span>
			<span class="n">omap2_cm_read_mod_reg</span><span class="p">(</span><span class="n">CORE_MOD</span><span class="p">,</span> <span class="n">CM_CLKSEL</span><span class="p">);</span>
	<span class="n">prcm_block_contents</span><span class="p">.</span><span class="n">cm_clksel_wkup</span> <span class="o">=</span>
			<span class="n">omap2_cm_read_mod_reg</span><span class="p">(</span><span class="n">WKUP_MOD</span><span class="p">,</span> <span class="n">CM_CLKSEL</span><span class="p">);</span>
	<span class="n">prcm_block_contents</span><span class="p">.</span><span class="n">cm_clken_pll</span> <span class="o">=</span>
			<span class="n">omap2_cm_read_mod_reg</span><span class="p">(</span><span class="n">PLL_MOD</span><span class="p">,</span> <span class="n">CM_CLKEN</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * As per erratum i671, ROM code does not respect the PER DPLL</span>
<span class="cm">	 * programming scheme if CM_AUTOIDLE_PLL..AUTO_PERIPH_DPLL == 1.</span>
<span class="cm">	 * Then,  in anycase, clear these bits to avoid extra latencies.</span>
<span class="cm">	 */</span>
	<span class="n">prcm_block_contents</span><span class="p">.</span><span class="n">cm_autoidle_pll</span> <span class="o">=</span>
			<span class="n">omap2_cm_read_mod_reg</span><span class="p">(</span><span class="n">PLL_MOD</span><span class="p">,</span> <span class="n">CM_AUTOIDLE</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="o">~</span><span class="n">OMAP3430_AUTO_PERIPH_DPLL_MASK</span><span class="p">;</span>
	<span class="n">prcm_block_contents</span><span class="p">.</span><span class="n">cm_clksel1_pll</span> <span class="o">=</span>
			<span class="n">omap2_cm_read_mod_reg</span><span class="p">(</span><span class="n">PLL_MOD</span><span class="p">,</span> <span class="n">OMAP3430_CM_CLKSEL1_PLL</span><span class="p">);</span>
	<span class="n">prcm_block_contents</span><span class="p">.</span><span class="n">cm_clksel2_pll</span> <span class="o">=</span>
			<span class="n">omap2_cm_read_mod_reg</span><span class="p">(</span><span class="n">PLL_MOD</span><span class="p">,</span> <span class="n">OMAP3430_CM_CLKSEL2_PLL</span><span class="p">);</span>
	<span class="n">prcm_block_contents</span><span class="p">.</span><span class="n">cm_clksel3_pll</span> <span class="o">=</span>
			<span class="n">omap2_cm_read_mod_reg</span><span class="p">(</span><span class="n">PLL_MOD</span><span class="p">,</span> <span class="n">OMAP3430_CM_CLKSEL3</span><span class="p">);</span>
	<span class="n">prcm_block_contents</span><span class="p">.</span><span class="n">cm_clken_pll_mpu</span> <span class="o">=</span>
			<span class="n">omap2_cm_read_mod_reg</span><span class="p">(</span><span class="n">MPU_MOD</span><span class="p">,</span> <span class="n">OMAP3430_CM_CLKEN_PLL</span><span class="p">);</span>
	<span class="n">prcm_block_contents</span><span class="p">.</span><span class="n">cm_autoidle_pll_mpu</span> <span class="o">=</span>
			<span class="n">omap2_cm_read_mod_reg</span><span class="p">(</span><span class="n">MPU_MOD</span><span class="p">,</span> <span class="n">OMAP3430_CM_AUTOIDLE_PLL</span><span class="p">);</span>
	<span class="n">prcm_block_contents</span><span class="p">.</span><span class="n">cm_clksel1_pll_mpu</span> <span class="o">=</span>
			<span class="n">omap2_cm_read_mod_reg</span><span class="p">(</span><span class="n">MPU_MOD</span><span class="p">,</span> <span class="n">OMAP3430_CM_CLKSEL1_PLL</span><span class="p">);</span>
	<span class="n">prcm_block_contents</span><span class="p">.</span><span class="n">cm_clksel2_pll_mpu</span> <span class="o">=</span>
			<span class="n">omap2_cm_read_mod_reg</span><span class="p">(</span><span class="n">MPU_MOD</span><span class="p">,</span> <span class="n">OMAP3430_CM_CLKSEL2_PLL</span><span class="p">);</span>
	<span class="n">prcm_block_contents</span><span class="p">.</span><span class="n">prcm_block_size</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>

	<span class="cm">/* Populate the SDRC block contents */</span>
	<span class="n">sdrc_block_contents</span><span class="p">.</span><span class="n">sysconfig</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">sdrc_read_reg</span><span class="p">(</span><span class="n">SDRC_SYSCONFIG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>
	<span class="n">sdrc_block_contents</span><span class="p">.</span><span class="n">cs_cfg</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">sdrc_read_reg</span><span class="p">(</span><span class="n">SDRC_CS_CFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>
	<span class="n">sdrc_block_contents</span><span class="p">.</span><span class="n">sharing</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">sdrc_read_reg</span><span class="p">(</span><span class="n">SDRC_SHARING</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>
	<span class="n">sdrc_block_contents</span><span class="p">.</span><span class="n">err_type</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">sdrc_read_reg</span><span class="p">(</span><span class="n">SDRC_ERR_TYPE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>
	<span class="n">sdrc_block_contents</span><span class="p">.</span><span class="n">dll_a_ctrl</span> <span class="o">=</span> <span class="n">sdrc_read_reg</span><span class="p">(</span><span class="n">SDRC_DLLA_CTRL</span><span class="p">);</span>
	<span class="n">sdrc_block_contents</span><span class="p">.</span><span class="n">dll_b_ctrl</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Due to a OMAP3 errata (1.142), on EMU/HS devices SRDC should</span>
<span class="cm">	 * be programed to issue automatic self refresh on timeout</span>
<span class="cm">	 * of AUTO_CNT = 1 prior to any transition to OFF mode.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">omap_type</span><span class="p">()</span> <span class="o">!=</span> <span class="n">OMAP2_DEVICE_TYPE_GP</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">omap_rev</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">OMAP3430_REV_ES3_0</span><span class="p">))</span>
		<span class="n">sdrc_block_contents</span><span class="p">.</span><span class="n">power</span> <span class="o">=</span> <span class="p">(</span><span class="n">sdrc_read_reg</span><span class="p">(</span><span class="n">SDRC_POWER</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="o">~</span><span class="p">(</span><span class="n">SDRC_POWER_AUTOCOUNT_MASK</span><span class="o">|</span>
				<span class="n">SDRC_POWER_CLKCTRL_MASK</span><span class="p">))</span> <span class="o">|</span>
				<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SDRC_POWER_AUTOCOUNT_SHIFT</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">SDRC_SELF_REFRESH_ON_AUTOCOUNT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sdrc_block_contents</span><span class="p">.</span><span class="n">power</span> <span class="o">=</span> <span class="n">sdrc_read_reg</span><span class="p">(</span><span class="n">SDRC_POWER</span><span class="p">);</span>

	<span class="n">sdrc_block_contents</span><span class="p">.</span><span class="n">cs_0</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">sdrc_block_contents</span><span class="p">.</span><span class="n">mcfg_0</span> <span class="o">=</span> <span class="n">sdrc_read_reg</span><span class="p">(</span><span class="n">SDRC_MCFG_0</span><span class="p">);</span>
	<span class="n">sdrc_block_contents</span><span class="p">.</span><span class="n">mr_0</span> <span class="o">=</span> <span class="p">(</span><span class="n">sdrc_read_reg</span><span class="p">(</span><span class="n">SDRC_MR_0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>
	<span class="n">sdrc_block_contents</span><span class="p">.</span><span class="n">emr_1_0</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">sdrc_block_contents</span><span class="p">.</span><span class="n">emr_2_0</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">sdrc_block_contents</span><span class="p">.</span><span class="n">emr_3_0</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">sdrc_block_contents</span><span class="p">.</span><span class="n">actim_ctrla_0</span> <span class="o">=</span>
			<span class="n">sdrc_read_reg</span><span class="p">(</span><span class="n">SDRC_ACTIM_CTRL_A_0</span><span class="p">);</span>
	<span class="n">sdrc_block_contents</span><span class="p">.</span><span class="n">actim_ctrlb_0</span> <span class="o">=</span>
			<span class="n">sdrc_read_reg</span><span class="p">(</span><span class="n">SDRC_ACTIM_CTRL_B_0</span><span class="p">);</span>
	<span class="n">sdrc_block_contents</span><span class="p">.</span><span class="n">rfr_ctrl_0</span> <span class="o">=</span>
			<span class="n">sdrc_read_reg</span><span class="p">(</span><span class="n">SDRC_RFR_CTRL_0</span><span class="p">);</span>
	<span class="n">sdrc_block_contents</span><span class="p">.</span><span class="n">cs_1</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">sdrc_block_contents</span><span class="p">.</span><span class="n">mcfg_1</span> <span class="o">=</span> <span class="n">sdrc_read_reg</span><span class="p">(</span><span class="n">SDRC_MCFG_1</span><span class="p">);</span>
	<span class="n">sdrc_block_contents</span><span class="p">.</span><span class="n">mr_1</span> <span class="o">=</span> <span class="n">sdrc_read_reg</span><span class="p">(</span><span class="n">SDRC_MR_1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="n">sdrc_block_contents</span><span class="p">.</span><span class="n">emr_1_1</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">sdrc_block_contents</span><span class="p">.</span><span class="n">emr_2_1</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">sdrc_block_contents</span><span class="p">.</span><span class="n">emr_3_1</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">sdrc_block_contents</span><span class="p">.</span><span class="n">actim_ctrla_1</span> <span class="o">=</span>
			<span class="n">sdrc_read_reg</span><span class="p">(</span><span class="n">SDRC_ACTIM_CTRL_A_1</span><span class="p">);</span>
	<span class="n">sdrc_block_contents</span><span class="p">.</span><span class="n">actim_ctrlb_1</span> <span class="o">=</span>
			<span class="n">sdrc_read_reg</span><span class="p">(</span><span class="n">SDRC_ACTIM_CTRL_B_1</span><span class="p">);</span>
	<span class="n">sdrc_block_contents</span><span class="p">.</span><span class="n">rfr_ctrl_1</span> <span class="o">=</span>
			<span class="n">sdrc_read_reg</span><span class="p">(</span><span class="n">SDRC_RFR_CTRL_1</span><span class="p">);</span>
	<span class="n">sdrc_block_contents</span><span class="p">.</span><span class="n">dcdl_1_ctrl</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">sdrc_block_contents</span><span class="p">.</span><span class="n">dcdl_2_ctrl</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">sdrc_block_contents</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">sdrc_block_contents</span><span class="p">.</span><span class="n">block_size</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>

	<span class="n">arm_context_addr</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">omap3_arm_context</span><span class="p">);</span>

	<span class="cm">/* Copy all the contents to the scratchpad location */</span>
	<span class="n">scratchpad_address</span> <span class="o">=</span> <span class="n">OMAP2_L4_IO_ADDRESS</span><span class="p">(</span><span class="n">OMAP343X_SCRATCHPAD</span><span class="p">);</span>
	<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">scratchpad_address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scratchpad_contents</span><span class="p">,</span>
		 <span class="k">sizeof</span><span class="p">(</span><span class="n">scratchpad_contents</span><span class="p">));</span>
	<span class="cm">/* Scratchpad contents being 32 bits, a divide by 4 done here */</span>
	<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">scratchpad_address</span> <span class="o">+</span>
		<span class="n">scratchpad_contents</span><span class="p">.</span><span class="n">prcm_block_offset</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">prcm_block_contents</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">prcm_block_contents</span><span class="p">));</span>
	<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">scratchpad_address</span> <span class="o">+</span>
		<span class="n">scratchpad_contents</span><span class="p">.</span><span class="n">sdrc_block_offset</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">sdrc_block_contents</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sdrc_block_contents</span><span class="p">));</span>
	<span class="cm">/*</span>
<span class="cm">	 * Copies the address of the location in SDRAM where ARM</span>
<span class="cm">	 * registers get saved during a MPU OFF transition.</span>
<span class="cm">	 */</span>
	<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">scratchpad_address</span> <span class="o">+</span>
		<span class="n">scratchpad_contents</span><span class="p">.</span><span class="n">sdrc_block_offset</span> <span class="o">+</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">sdrc_block_contents</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">arm_context_addr</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">omap3_control_save_context</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">control_context</span><span class="p">.</span><span class="n">sysconfig</span> <span class="o">=</span> <span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP2_CONTROL_SYSCONFIG</span><span class="p">);</span>
	<span class="n">control_context</span><span class="p">.</span><span class="n">devconf0</span> <span class="o">=</span> <span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP2_CONTROL_DEVCONF0</span><span class="p">);</span>
	<span class="n">control_context</span><span class="p">.</span><span class="n">mem_dftrw0</span> <span class="o">=</span>
			<span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP343X_CONTROL_MEM_DFTRW0</span><span class="p">);</span>
	<span class="n">control_context</span><span class="p">.</span><span class="n">mem_dftrw1</span> <span class="o">=</span>
			<span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP343X_CONTROL_MEM_DFTRW1</span><span class="p">);</span>
	<span class="n">control_context</span><span class="p">.</span><span class="n">msuspendmux_0</span> <span class="o">=</span>
			<span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP2_CONTROL_MSUSPENDMUX_0</span><span class="p">);</span>
	<span class="n">control_context</span><span class="p">.</span><span class="n">msuspendmux_1</span> <span class="o">=</span>
			<span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP2_CONTROL_MSUSPENDMUX_1</span><span class="p">);</span>
	<span class="n">control_context</span><span class="p">.</span><span class="n">msuspendmux_2</span> <span class="o">=</span>
			<span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP2_CONTROL_MSUSPENDMUX_2</span><span class="p">);</span>
	<span class="n">control_context</span><span class="p">.</span><span class="n">msuspendmux_3</span> <span class="o">=</span>
			<span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP2_CONTROL_MSUSPENDMUX_3</span><span class="p">);</span>
	<span class="n">control_context</span><span class="p">.</span><span class="n">msuspendmux_4</span> <span class="o">=</span>
			<span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP2_CONTROL_MSUSPENDMUX_4</span><span class="p">);</span>
	<span class="n">control_context</span><span class="p">.</span><span class="n">msuspendmux_5</span> <span class="o">=</span>
			<span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP2_CONTROL_MSUSPENDMUX_5</span><span class="p">);</span>
	<span class="n">control_context</span><span class="p">.</span><span class="n">sec_ctrl</span> <span class="o">=</span> <span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP2_CONTROL_SEC_CTRL</span><span class="p">);</span>
	<span class="n">control_context</span><span class="p">.</span><span class="n">devconf1</span> <span class="o">=</span> <span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP343X_CONTROL_DEVCONF1</span><span class="p">);</span>
	<span class="n">control_context</span><span class="p">.</span><span class="n">csirxfe</span> <span class="o">=</span> <span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP343X_CONTROL_CSIRXFE</span><span class="p">);</span>
	<span class="n">control_context</span><span class="p">.</span><span class="n">iva2_bootaddr</span> <span class="o">=</span>
			<span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP343X_CONTROL_IVA2_BOOTADDR</span><span class="p">);</span>
	<span class="n">control_context</span><span class="p">.</span><span class="n">iva2_bootmod</span> <span class="o">=</span>
			<span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP343X_CONTROL_IVA2_BOOTMOD</span><span class="p">);</span>
	<span class="n">control_context</span><span class="p">.</span><span class="n">debobs_0</span> <span class="o">=</span> <span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP343X_CONTROL_DEBOBS</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">control_context</span><span class="p">.</span><span class="n">debobs_1</span> <span class="o">=</span> <span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP343X_CONTROL_DEBOBS</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">control_context</span><span class="p">.</span><span class="n">debobs_2</span> <span class="o">=</span> <span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP343X_CONTROL_DEBOBS</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
	<span class="n">control_context</span><span class="p">.</span><span class="n">debobs_3</span> <span class="o">=</span> <span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP343X_CONTROL_DEBOBS</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
	<span class="n">control_context</span><span class="p">.</span><span class="n">debobs_4</span> <span class="o">=</span> <span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP343X_CONTROL_DEBOBS</span><span class="p">(</span><span class="mi">4</span><span class="p">));</span>
	<span class="n">control_context</span><span class="p">.</span><span class="n">debobs_5</span> <span class="o">=</span> <span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP343X_CONTROL_DEBOBS</span><span class="p">(</span><span class="mi">5</span><span class="p">));</span>
	<span class="n">control_context</span><span class="p">.</span><span class="n">debobs_6</span> <span class="o">=</span> <span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP343X_CONTROL_DEBOBS</span><span class="p">(</span><span class="mi">6</span><span class="p">));</span>
	<span class="n">control_context</span><span class="p">.</span><span class="n">debobs_7</span> <span class="o">=</span> <span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP343X_CONTROL_DEBOBS</span><span class="p">(</span><span class="mi">7</span><span class="p">));</span>
	<span class="n">control_context</span><span class="p">.</span><span class="n">debobs_8</span> <span class="o">=</span> <span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP343X_CONTROL_DEBOBS</span><span class="p">(</span><span class="mi">8</span><span class="p">));</span>
	<span class="n">control_context</span><span class="p">.</span><span class="n">prog_io0</span> <span class="o">=</span> <span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP343X_CONTROL_PROG_IO0</span><span class="p">);</span>
	<span class="n">control_context</span><span class="p">.</span><span class="n">prog_io1</span> <span class="o">=</span> <span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP343X_CONTROL_PROG_IO1</span><span class="p">);</span>
	<span class="n">control_context</span><span class="p">.</span><span class="n">dss_dpll_spreading</span> <span class="o">=</span>
			<span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP343X_CONTROL_DSS_DPLL_SPREADING</span><span class="p">);</span>
	<span class="n">control_context</span><span class="p">.</span><span class="n">core_dpll_spreading</span> <span class="o">=</span>
			<span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP343X_CONTROL_CORE_DPLL_SPREADING</span><span class="p">);</span>
	<span class="n">control_context</span><span class="p">.</span><span class="n">per_dpll_spreading</span> <span class="o">=</span>
			<span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP343X_CONTROL_PER_DPLL_SPREADING</span><span class="p">);</span>
	<span class="n">control_context</span><span class="p">.</span><span class="n">usbhost_dpll_spreading</span> <span class="o">=</span>
		<span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP343X_CONTROL_USBHOST_DPLL_SPREADING</span><span class="p">);</span>
	<span class="n">control_context</span><span class="p">.</span><span class="n">pbias_lite</span> <span class="o">=</span>
			<span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP343X_CONTROL_PBIAS_LITE</span><span class="p">);</span>
	<span class="n">control_context</span><span class="p">.</span><span class="n">temp_sensor</span> <span class="o">=</span>
			<span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP343X_CONTROL_TEMP_SENSOR</span><span class="p">);</span>
	<span class="n">control_context</span><span class="p">.</span><span class="n">sramldo4</span> <span class="o">=</span> <span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP343X_CONTROL_SRAMLDO4</span><span class="p">);</span>
	<span class="n">control_context</span><span class="p">.</span><span class="n">sramldo5</span> <span class="o">=</span> <span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP343X_CONTROL_SRAMLDO5</span><span class="p">);</span>
	<span class="n">control_context</span><span class="p">.</span><span class="n">csi</span> <span class="o">=</span> <span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP343X_CONTROL_CSI</span><span class="p">);</span>
	<span class="n">control_context</span><span class="p">.</span><span class="n">padconf_sys_nirq</span> <span class="o">=</span>
		<span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP343X_CONTROL_PADCONF_SYSNIRQ</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">omap3_control_restore_context</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">control_context</span><span class="p">.</span><span class="n">sysconfig</span><span class="p">,</span> <span class="n">OMAP2_CONTROL_SYSCONFIG</span><span class="p">);</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">control_context</span><span class="p">.</span><span class="n">devconf0</span><span class="p">,</span> <span class="n">OMAP2_CONTROL_DEVCONF0</span><span class="p">);</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">control_context</span><span class="p">.</span><span class="n">mem_dftrw0</span><span class="p">,</span>
					<span class="n">OMAP343X_CONTROL_MEM_DFTRW0</span><span class="p">);</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">control_context</span><span class="p">.</span><span class="n">mem_dftrw1</span><span class="p">,</span>
					<span class="n">OMAP343X_CONTROL_MEM_DFTRW1</span><span class="p">);</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">control_context</span><span class="p">.</span><span class="n">msuspendmux_0</span><span class="p">,</span>
					<span class="n">OMAP2_CONTROL_MSUSPENDMUX_0</span><span class="p">);</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">control_context</span><span class="p">.</span><span class="n">msuspendmux_1</span><span class="p">,</span>
					<span class="n">OMAP2_CONTROL_MSUSPENDMUX_1</span><span class="p">);</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">control_context</span><span class="p">.</span><span class="n">msuspendmux_2</span><span class="p">,</span>
					<span class="n">OMAP2_CONTROL_MSUSPENDMUX_2</span><span class="p">);</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">control_context</span><span class="p">.</span><span class="n">msuspendmux_3</span><span class="p">,</span>
					<span class="n">OMAP2_CONTROL_MSUSPENDMUX_3</span><span class="p">);</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">control_context</span><span class="p">.</span><span class="n">msuspendmux_4</span><span class="p">,</span>
					<span class="n">OMAP2_CONTROL_MSUSPENDMUX_4</span><span class="p">);</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">control_context</span><span class="p">.</span><span class="n">msuspendmux_5</span><span class="p">,</span>
					<span class="n">OMAP2_CONTROL_MSUSPENDMUX_5</span><span class="p">);</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">control_context</span><span class="p">.</span><span class="n">sec_ctrl</span><span class="p">,</span> <span class="n">OMAP2_CONTROL_SEC_CTRL</span><span class="p">);</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">control_context</span><span class="p">.</span><span class="n">devconf1</span><span class="p">,</span> <span class="n">OMAP343X_CONTROL_DEVCONF1</span><span class="p">);</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">control_context</span><span class="p">.</span><span class="n">csirxfe</span><span class="p">,</span> <span class="n">OMAP343X_CONTROL_CSIRXFE</span><span class="p">);</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">control_context</span><span class="p">.</span><span class="n">iva2_bootaddr</span><span class="p">,</span>
					<span class="n">OMAP343X_CONTROL_IVA2_BOOTADDR</span><span class="p">);</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">control_context</span><span class="p">.</span><span class="n">iva2_bootmod</span><span class="p">,</span>
					<span class="n">OMAP343X_CONTROL_IVA2_BOOTMOD</span><span class="p">);</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">control_context</span><span class="p">.</span><span class="n">debobs_0</span><span class="p">,</span> <span class="n">OMAP343X_CONTROL_DEBOBS</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">control_context</span><span class="p">.</span><span class="n">debobs_1</span><span class="p">,</span> <span class="n">OMAP343X_CONTROL_DEBOBS</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">control_context</span><span class="p">.</span><span class="n">debobs_2</span><span class="p">,</span> <span class="n">OMAP343X_CONTROL_DEBOBS</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">control_context</span><span class="p">.</span><span class="n">debobs_3</span><span class="p">,</span> <span class="n">OMAP343X_CONTROL_DEBOBS</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">control_context</span><span class="p">.</span><span class="n">debobs_4</span><span class="p">,</span> <span class="n">OMAP343X_CONTROL_DEBOBS</span><span class="p">(</span><span class="mi">4</span><span class="p">));</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">control_context</span><span class="p">.</span><span class="n">debobs_5</span><span class="p">,</span> <span class="n">OMAP343X_CONTROL_DEBOBS</span><span class="p">(</span><span class="mi">5</span><span class="p">));</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">control_context</span><span class="p">.</span><span class="n">debobs_6</span><span class="p">,</span> <span class="n">OMAP343X_CONTROL_DEBOBS</span><span class="p">(</span><span class="mi">6</span><span class="p">));</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">control_context</span><span class="p">.</span><span class="n">debobs_7</span><span class="p">,</span> <span class="n">OMAP343X_CONTROL_DEBOBS</span><span class="p">(</span><span class="mi">7</span><span class="p">));</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">control_context</span><span class="p">.</span><span class="n">debobs_8</span><span class="p">,</span> <span class="n">OMAP343X_CONTROL_DEBOBS</span><span class="p">(</span><span class="mi">8</span><span class="p">));</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">control_context</span><span class="p">.</span><span class="n">prog_io0</span><span class="p">,</span> <span class="n">OMAP343X_CONTROL_PROG_IO0</span><span class="p">);</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">control_context</span><span class="p">.</span><span class="n">prog_io1</span><span class="p">,</span> <span class="n">OMAP343X_CONTROL_PROG_IO1</span><span class="p">);</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">control_context</span><span class="p">.</span><span class="n">dss_dpll_spreading</span><span class="p">,</span>
					<span class="n">OMAP343X_CONTROL_DSS_DPLL_SPREADING</span><span class="p">);</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">control_context</span><span class="p">.</span><span class="n">core_dpll_spreading</span><span class="p">,</span>
					<span class="n">OMAP343X_CONTROL_CORE_DPLL_SPREADING</span><span class="p">);</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">control_context</span><span class="p">.</span><span class="n">per_dpll_spreading</span><span class="p">,</span>
					<span class="n">OMAP343X_CONTROL_PER_DPLL_SPREADING</span><span class="p">);</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">control_context</span><span class="p">.</span><span class="n">usbhost_dpll_spreading</span><span class="p">,</span>
				<span class="n">OMAP343X_CONTROL_USBHOST_DPLL_SPREADING</span><span class="p">);</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">control_context</span><span class="p">.</span><span class="n">pbias_lite</span><span class="p">,</span>
					<span class="n">OMAP343X_CONTROL_PBIAS_LITE</span><span class="p">);</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">control_context</span><span class="p">.</span><span class="n">temp_sensor</span><span class="p">,</span>
					<span class="n">OMAP343X_CONTROL_TEMP_SENSOR</span><span class="p">);</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">control_context</span><span class="p">.</span><span class="n">sramldo4</span><span class="p">,</span> <span class="n">OMAP343X_CONTROL_SRAMLDO4</span><span class="p">);</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">control_context</span><span class="p">.</span><span class="n">sramldo5</span><span class="p">,</span> <span class="n">OMAP343X_CONTROL_SRAMLDO5</span><span class="p">);</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">control_context</span><span class="p">.</span><span class="n">csi</span><span class="p">,</span> <span class="n">OMAP343X_CONTROL_CSI</span><span class="p">);</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">control_context</span><span class="p">.</span><span class="n">padconf_sys_nirq</span><span class="p">,</span>
			 <span class="n">OMAP343X_CONTROL_PADCONF_SYSNIRQ</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">omap3630_ctrl_disable_rta</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_is_omap3630</span><span class="p">())</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">OMAP36XX_RTA_DISABLE</span><span class="p">,</span> <span class="n">OMAP36XX_CONTROL_MEM_RTA_CTRL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * omap3_ctrl_save_padconf - save padconf registers to scratchpad RAM</span>
<span class="cm"> *</span>
<span class="cm"> * Tell the SCM to start saving the padconf registers, then wait for</span>
<span class="cm"> * the process to complete.  Returns 0 unconditionally, although it</span>
<span class="cm"> * should also eventually be able to return -ETIMEDOUT, if the save</span>
<span class="cm"> * does not complete.</span>
<span class="cm"> *</span>
<span class="cm"> * XXX This function is missing a timeout.  What should it be?</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">omap3_ctrl_save_padconf</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cpo</span><span class="p">;</span>

	<span class="cm">/* Save the padconf registers */</span>
	<span class="n">cpo</span> <span class="o">=</span> <span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP343X_CONTROL_PADCONF_OFF</span><span class="p">);</span>
	<span class="n">cpo</span> <span class="o">|=</span> <span class="n">START_PADCONF_SAVE</span><span class="p">;</span>
	<span class="n">omap_ctrl_writel</span><span class="p">(</span><span class="n">cpo</span><span class="p">,</span> <span class="n">OMAP343X_CONTROL_PADCONF_OFF</span><span class="p">);</span>

	<span class="cm">/* wait for the save to complete */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">omap_ctrl_readl</span><span class="p">(</span><span class="n">OMAP343X_CONTROL_GENERAL_PURPOSE_STATUS</span><span class="p">)</span>
		 <span class="o">&amp;</span> <span class="n">PADCONF_SAVE_DONE</span><span class="p">))</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_ARCH_OMAP3 &amp;&amp; CONFIG_PM */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
