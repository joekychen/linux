<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › mach-omap2 › gpmc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>gpmc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * GPMC support functions</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005-2006 Nokia Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Juha Yrjola</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2009 Texas Instruments</span>
<span class="cm"> * Added OMAP4 support - Santosh Shilimkar &lt;santosh.shilimkar@ti.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>
<span class="cp">#undef DEBUG</span>

<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>

<span class="cp">#include &lt;asm/mach-types.h&gt;</span>
<span class="cp">#include &lt;plat/gpmc.h&gt;</span>

<span class="cp">#include &lt;plat/sdrc.h&gt;</span>

<span class="cm">/* GPMC register offsets */</span>
<span class="cp">#define GPMC_REVISION		0x00</span>
<span class="cp">#define GPMC_SYSCONFIG		0x10</span>
<span class="cp">#define GPMC_SYSSTATUS		0x14</span>
<span class="cp">#define GPMC_IRQSTATUS		0x18</span>
<span class="cp">#define GPMC_IRQENABLE		0x1c</span>
<span class="cp">#define GPMC_TIMEOUT_CONTROL	0x40</span>
<span class="cp">#define GPMC_ERR_ADDRESS	0x44</span>
<span class="cp">#define GPMC_ERR_TYPE		0x48</span>
<span class="cp">#define GPMC_CONFIG		0x50</span>
<span class="cp">#define GPMC_STATUS		0x54</span>
<span class="cp">#define GPMC_PREFETCH_CONFIG1	0x1e0</span>
<span class="cp">#define GPMC_PREFETCH_CONFIG2	0x1e4</span>
<span class="cp">#define GPMC_PREFETCH_CONTROL	0x1ec</span>
<span class="cp">#define GPMC_PREFETCH_STATUS	0x1f0</span>
<span class="cp">#define GPMC_ECC_CONFIG		0x1f4</span>
<span class="cp">#define GPMC_ECC_CONTROL	0x1f8</span>
<span class="cp">#define GPMC_ECC_SIZE_CONFIG	0x1fc</span>
<span class="cp">#define GPMC_ECC1_RESULT        0x200</span>
<span class="cp">#define GPMC_ECC_BCH_RESULT_0   0x240   </span><span class="cm">/* not available on OMAP2 */</span><span class="cp"></span>

<span class="cm">/* GPMC ECC control settings */</span>
<span class="cp">#define GPMC_ECC_CTRL_ECCCLEAR		0x100</span>
<span class="cp">#define GPMC_ECC_CTRL_ECCDISABLE	0x000</span>
<span class="cp">#define GPMC_ECC_CTRL_ECCREG1		0x001</span>
<span class="cp">#define GPMC_ECC_CTRL_ECCREG2		0x002</span>
<span class="cp">#define GPMC_ECC_CTRL_ECCREG3		0x003</span>
<span class="cp">#define GPMC_ECC_CTRL_ECCREG4		0x004</span>
<span class="cp">#define GPMC_ECC_CTRL_ECCREG5		0x005</span>
<span class="cp">#define GPMC_ECC_CTRL_ECCREG6		0x006</span>
<span class="cp">#define GPMC_ECC_CTRL_ECCREG7		0x007</span>
<span class="cp">#define GPMC_ECC_CTRL_ECCREG8		0x008</span>
<span class="cp">#define GPMC_ECC_CTRL_ECCREG9		0x009</span>

<span class="cp">#define GPMC_CS0_OFFSET		0x60</span>
<span class="cp">#define GPMC_CS_SIZE		0x30</span>

<span class="cp">#define GPMC_MEM_START		0x00000000</span>
<span class="cp">#define GPMC_MEM_END		0x3FFFFFFF</span>
<span class="cp">#define BOOT_ROM_SPACE		0x100000	</span><span class="cm">/* 1MB */</span><span class="cp"></span>

<span class="cp">#define GPMC_CHUNK_SHIFT	24		</span><span class="cm">/* 16 MB */</span><span class="cp"></span>
<span class="cp">#define GPMC_SECTION_SHIFT	28		</span><span class="cm">/* 128 MB */</span><span class="cp"></span>

<span class="cp">#define CS_NUM_SHIFT		24</span>
<span class="cp">#define ENABLE_PREFETCH		(0x1 &lt;&lt; 7)</span>
<span class="cp">#define DMA_MPU_MODE		2</span>

<span class="cm">/* Structure to save gpmc cs context */</span>
<span class="k">struct</span> <span class="n">gpmc_cs_config</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">config1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">config2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">config3</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">config4</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">config5</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">config6</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">config7</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_valid</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Structure to save/restore gpmc context</span>
<span class="cm"> * to support core off on OMAP3</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">omap3_gpmc_regs</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">sysconfig</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">irqenable</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">timeout_ctrl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">config</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">prefetch_config1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">prefetch_config2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">prefetch_control</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gpmc_cs_config</span> <span class="n">cs_context</span><span class="p">[</span><span class="n">GPMC_CS_NUM</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span>	<span class="n">gpmc_mem_root</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span>	<span class="n">gpmc_cs_mem</span><span class="p">[</span><span class="n">GPMC_CS_NUM</span><span class="p">];</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">gpmc_mem_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gpmc_cs_map</span><span class="p">;</span>	<span class="cm">/* flag for cs which are initialized */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gpmc_ecc_used</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>	<span class="cm">/* cs using ecc engine */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">gpmc_base</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">gpmc_l3_clk</span><span class="p">;</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">gpmc_handle_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gpmc_write_reg</span><span class="p">(</span><span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">gpmc_base</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">gpmc_read_reg</span><span class="p">(</span><span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">gpmc_base</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gpmc_cs_write_byte</span><span class="p">(</span><span class="kt">int</span> <span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg_addr</span><span class="p">;</span>

	<span class="n">reg_addr</span> <span class="o">=</span> <span class="n">gpmc_base</span> <span class="o">+</span> <span class="n">GPMC_CS0_OFFSET</span> <span class="o">+</span> <span class="p">(</span><span class="n">cs</span> <span class="o">*</span> <span class="n">GPMC_CS_SIZE</span><span class="p">)</span> <span class="o">+</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">__raw_writeb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">gpmc_cs_read_byte</span><span class="p">(</span><span class="kt">int</span> <span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg_addr</span><span class="p">;</span>

	<span class="n">reg_addr</span> <span class="o">=</span> <span class="n">gpmc_base</span> <span class="o">+</span> <span class="n">GPMC_CS0_OFFSET</span> <span class="o">+</span> <span class="p">(</span><span class="n">cs</span> <span class="o">*</span> <span class="n">GPMC_CS_SIZE</span><span class="p">)</span> <span class="o">+</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">__raw_readb</span><span class="p">(</span><span class="n">reg_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gpmc_cs_write_reg</span><span class="p">(</span><span class="kt">int</span> <span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg_addr</span><span class="p">;</span>

	<span class="n">reg_addr</span> <span class="o">=</span> <span class="n">gpmc_base</span> <span class="o">+</span> <span class="n">GPMC_CS0_OFFSET</span> <span class="o">+</span> <span class="p">(</span><span class="n">cs</span> <span class="o">*</span> <span class="n">GPMC_CS_SIZE</span><span class="p">)</span> <span class="o">+</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">gpmc_cs_read_reg</span><span class="p">(</span><span class="kt">int</span> <span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg_addr</span><span class="p">;</span>

	<span class="n">reg_addr</span> <span class="o">=</span> <span class="n">gpmc_base</span> <span class="o">+</span> <span class="n">GPMC_CS0_OFFSET</span> <span class="o">+</span> <span class="p">(</span><span class="n">cs</span> <span class="o">*</span> <span class="n">GPMC_CS_SIZE</span><span class="p">)</span> <span class="o">+</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">reg_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* TODO: Add support for gpmc_fck to clock framework and use it */</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">gpmc_get_fclk_period</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate</span> <span class="o">=</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="n">gpmc_l3_clk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;gpmc_l3_clk not enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rate</span> <span class="o">/=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">rate</span> <span class="o">=</span> <span class="mi">1000000000</span> <span class="o">/</span> <span class="n">rate</span><span class="p">;</span>	<span class="cm">/* In picoseconds */</span>

	<span class="k">return</span> <span class="n">rate</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">gpmc_ns_to_ticks</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">time_ns</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tick_ps</span><span class="p">;</span>

	<span class="cm">/* Calculate in picosecs to yield more exact results */</span>
	<span class="n">tick_ps</span> <span class="o">=</span> <span class="n">gpmc_get_fclk_period</span><span class="p">();</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">time_ns</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">+</span> <span class="n">tick_ps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">tick_ps</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">gpmc_ps_to_ticks</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">time_ps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tick_ps</span><span class="p">;</span>

	<span class="cm">/* Calculate in picosecs to yield more exact results */</span>
	<span class="n">tick_ps</span> <span class="o">=</span> <span class="n">gpmc_get_fclk_period</span><span class="p">();</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">time_ps</span> <span class="o">+</span> <span class="n">tick_ps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">tick_ps</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">gpmc_ticks_to_ns</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ticks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ticks</span> <span class="o">*</span> <span class="n">gpmc_get_fclk_period</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">gpmc_round_ns_to_ticks</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">time_ns</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ticks</span> <span class="o">=</span> <span class="n">gpmc_ns_to_ticks</span><span class="p">(</span><span class="n">time_ns</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ticks</span> <span class="o">*</span> <span class="n">gpmc_get_fclk_period</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">set_gpmc_timing_reg</span><span class="p">(</span><span class="kt">int</span> <span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">st_bit</span><span class="p">,</span> <span class="kt">int</span> <span class="n">end_bit</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">time</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">set_gpmc_timing_reg</span><span class="p">(</span><span class="kt">int</span> <span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">st_bit</span><span class="p">,</span> <span class="kt">int</span> <span class="n">end_bit</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">time</span><span class="p">)</span>
<span class="cp">#endif</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ticks</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">nr_bits</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ticks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ticks</span> <span class="o">=</span> <span class="n">gpmc_ns_to_ticks</span><span class="p">(</span><span class="n">time</span><span class="p">);</span>
	<span class="n">nr_bits</span> <span class="o">=</span> <span class="n">end_bit</span> <span class="o">-</span> <span class="n">st_bit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ticks</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">nr_bits</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;GPMC CS%d: %-10s* %3d ns, %3d ticks &gt;= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">cs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">ticks</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">nr_bits</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">nr_bits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">gpmc_cs_read_reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		<span class="s">&quot;GPMC CS%d: %-10s: %3d ticks, %3lu ns (was %3i ticks) %3d ns</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ticks</span><span class="p">,</span> <span class="n">gpmc_get_fclk_period</span><span class="p">()</span> <span class="o">*</span> <span class="n">ticks</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span>
			<span class="p">(</span><span class="n">l</span> <span class="o">&gt;&gt;</span> <span class="n">st_bit</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">,</span> <span class="n">time</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">st_bit</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">ticks</span> <span class="o">&lt;&lt;</span> <span class="n">st_bit</span><span class="p">;</span>
	<span class="n">gpmc_cs_write_reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
<span class="cp">#define GPMC_SET_ONE(reg, st, end, field) \</span>
<span class="cp">	if (set_gpmc_timing_reg(cs, (reg), (st), (end),		\</span>
<span class="cp">			t-&gt;field, #field) &lt; 0)			\</span>
<span class="cp">		return -1</span>
<span class="cp">#else</span>
<span class="cp">#define GPMC_SET_ONE(reg, st, end, field) \</span>
<span class="cp">	if (set_gpmc_timing_reg(cs, (reg), (st), (end), t-&gt;field) &lt; 0) \</span>
<span class="cp">		return -1</span>
<span class="cp">#endif</span>

<span class="kt">int</span> <span class="n">gpmc_cs_calc_divider</span><span class="p">(</span><span class="kt">int</span> <span class="n">cs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sync_clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">div</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">sync_clk</span> <span class="o">+</span> <span class="p">(</span><span class="n">gpmc_get_fclk_period</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">div</span> <span class="o">=</span> <span class="n">l</span> <span class="o">/</span> <span class="n">gpmc_get_fclk_period</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">div</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">div</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">div</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">div</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">gpmc_cs_set_timings</span><span class="p">(</span><span class="kt">int</span> <span class="n">cs</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">gpmc_timings</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">div</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

	<span class="n">div</span> <span class="o">=</span> <span class="n">gpmc_cs_calc_divider</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">sync_clk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">div</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">GPMC_SET_ONE</span><span class="p">(</span><span class="n">GPMC_CS_CONFIG2</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span> <span class="n">cs_on</span><span class="p">);</span>
	<span class="n">GPMC_SET_ONE</span><span class="p">(</span><span class="n">GPMC_CS_CONFIG2</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">cs_rd_off</span><span class="p">);</span>
	<span class="n">GPMC_SET_ONE</span><span class="p">(</span><span class="n">GPMC_CS_CONFIG2</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">cs_wr_off</span><span class="p">);</span>

	<span class="n">GPMC_SET_ONE</span><span class="p">(</span><span class="n">GPMC_CS_CONFIG3</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span> <span class="n">adv_on</span><span class="p">);</span>
	<span class="n">GPMC_SET_ONE</span><span class="p">(</span><span class="n">GPMC_CS_CONFIG3</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">adv_rd_off</span><span class="p">);</span>
	<span class="n">GPMC_SET_ONE</span><span class="p">(</span><span class="n">GPMC_CS_CONFIG3</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">adv_wr_off</span><span class="p">);</span>

	<span class="n">GPMC_SET_ONE</span><span class="p">(</span><span class="n">GPMC_CS_CONFIG4</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span> <span class="n">oe_on</span><span class="p">);</span>
	<span class="n">GPMC_SET_ONE</span><span class="p">(</span><span class="n">GPMC_CS_CONFIG4</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">oe_off</span><span class="p">);</span>
	<span class="n">GPMC_SET_ONE</span><span class="p">(</span><span class="n">GPMC_CS_CONFIG4</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="n">we_on</span><span class="p">);</span>
	<span class="n">GPMC_SET_ONE</span><span class="p">(</span><span class="n">GPMC_CS_CONFIG4</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="n">we_off</span><span class="p">);</span>

	<span class="n">GPMC_SET_ONE</span><span class="p">(</span><span class="n">GPMC_CS_CONFIG5</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span> <span class="n">rd_cycle</span><span class="p">);</span>
	<span class="n">GPMC_SET_ONE</span><span class="p">(</span><span class="n">GPMC_CS_CONFIG5</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">wr_cycle</span><span class="p">);</span>
	<span class="n">GPMC_SET_ONE</span><span class="p">(</span><span class="n">GPMC_CS_CONFIG5</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">access</span><span class="p">);</span>

	<span class="n">GPMC_SET_ONE</span><span class="p">(</span><span class="n">GPMC_CS_CONFIG5</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="n">page_burst_access</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap34xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">GPMC_SET_ONE</span><span class="p">(</span><span class="n">GPMC_CS_CONFIG6</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="n">wr_data_mux_bus</span><span class="p">);</span>
		<span class="n">GPMC_SET_ONE</span><span class="p">(</span><span class="n">GPMC_CS_CONFIG6</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="n">wr_access</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* caller is expected to have initialized CONFIG1 to cover</span>
<span class="cm">	 * at least sync vs async</span>
<span class="cm">	 */</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">gpmc_cs_read_reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">GPMC_CS_CONFIG1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">GPMC_CONFIG1_READTYPE_SYNC</span> <span class="o">|</span> <span class="n">GPMC_CONFIG1_WRITETYPE_SYNC</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;GPMC CS%d CLK period is %lu ns (div %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">cs</span><span class="p">,</span> <span class="p">(</span><span class="n">div</span> <span class="o">*</span> <span class="n">gpmc_get_fclk_period</span><span class="p">())</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">div</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">;</span>
		<span class="n">l</span> <span class="o">|=</span> <span class="p">(</span><span class="n">div</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">gpmc_cs_write_reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">GPMC_CS_CONFIG1</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">gpmc_cs_enable_mem</span><span class="p">(</span><span class="kt">int</span> <span class="n">cs</span><span class="p">,</span> <span class="n">u32</span> <span class="n">base</span><span class="p">,</span> <span class="n">u32</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">GPMC_SECTION_SHIFT</span><span class="p">)</span> <span class="o">-</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">gpmc_cs_read_reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">GPMC_CS_CONFIG7</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x3f</span><span class="p">;</span>
	<span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="n">base</span> <span class="o">&gt;&gt;</span> <span class="n">GPMC_CHUNK_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x0f</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="p">((</span><span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="n">GPMC_CHUNK_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">GPMC_CONFIG7_CSVALID</span><span class="p">;</span>
	<span class="n">gpmc_cs_write_reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">GPMC_CS_CONFIG7</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">gpmc_cs_disable_mem</span><span class="p">(</span><span class="kt">int</span> <span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">gpmc_cs_read_reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">GPMC_CS_CONFIG7</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GPMC_CONFIG7_CSVALID</span><span class="p">;</span>
	<span class="n">gpmc_cs_write_reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">GPMC_CS_CONFIG7</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">gpmc_cs_get_memconf</span><span class="p">(</span><span class="kt">int</span> <span class="n">cs</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">gpmc_cs_read_reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">GPMC_CS_CONFIG7</span><span class="p">);</span>
	<span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">GPMC_CHUNK_SHIFT</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">GPMC_SECTION_SHIFT</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">GPMC_CHUNK_SHIFT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">gpmc_cs_mem_enabled</span><span class="p">(</span><span class="kt">int</span> <span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">gpmc_cs_read_reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">GPMC_CS_CONFIG7</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">l</span> <span class="o">&amp;</span> <span class="n">GPMC_CONFIG7_CSVALID</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">gpmc_cs_set_reserved</span><span class="p">(</span><span class="kt">int</span> <span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reserved</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span> <span class="o">&gt;</span> <span class="n">GPMC_CS_NUM</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">gpmc_cs_map</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">cs</span><span class="p">);</span>
	<span class="n">gpmc_cs_map</span> <span class="o">|=</span> <span class="p">(</span><span class="n">reserved</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">cs</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">gpmc_cs_reserved</span><span class="p">(</span><span class="kt">int</span> <span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span> <span class="o">&gt;</span> <span class="n">GPMC_CS_NUM</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">gpmc_cs_map</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">cs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">gpmc_mem_align</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">order</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">GPMC_CHUNK_SHIFT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">order</span> <span class="o">=</span> <span class="n">GPMC_CHUNK_SHIFT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">order</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">gpmc_cs_insert_mem</span><span class="p">(</span><span class="kt">int</span> <span class="n">cs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span>	<span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gpmc_cs_mem</span><span class="p">[</span><span class="n">cs</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">gpmc_mem_align</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpmc_mem_lock</span><span class="p">);</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">request_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpmc_mem_root</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpmc_mem_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">gpmc_cs_request</span><span class="p">(</span><span class="kt">int</span> <span class="n">cs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gpmc_cs_mem</span><span class="p">[</span><span class="n">cs</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span> <span class="o">&gt;</span> <span class="n">GPMC_CS_NUM</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">gpmc_mem_align</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">GPMC_SECTION_SHIFT</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpmc_mem_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpmc_cs_reserved</span><span class="p">(</span><span class="n">cs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpmc_cs_mem_enabled</span><span class="p">(</span><span class="n">cs</span><span class="p">))</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">adjust_resource</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">allocate_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpmc_mem_root</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span>
				      <span class="n">size</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">gpmc_cs_enable_mem</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">gpmc_cs_set_reserved</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpmc_mem_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">gpmc_cs_request</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">gpmc_cs_free</span><span class="p">(</span><span class="kt">int</span> <span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpmc_mem_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span> <span class="o">&gt;=</span> <span class="n">GPMC_CS_NUM</span> <span class="o">||</span> <span class="n">cs</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">!</span><span class="n">gpmc_cs_reserved</span><span class="p">(</span><span class="n">cs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Trying to free non-reserved GPMC CS%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cs</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpmc_mem_lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">gpmc_cs_disable_mem</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="n">release_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpmc_cs_mem</span><span class="p">[</span><span class="n">cs</span><span class="p">]);</span>
	<span class="n">gpmc_cs_set_reserved</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpmc_mem_lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">gpmc_cs_free</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * gpmc_read_status - read access request to get the different gpmc status</span>
<span class="cm"> * @cmd: command type</span>
<span class="cm"> * @return status</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">gpmc_read_status</span><span class="p">(</span><span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">regval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GPMC_GET_IRQ_STATUS</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">gpmc_read_reg</span><span class="p">(</span><span class="n">GPMC_IRQSTATUS</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">GPMC_PREFETCH_FIFO_CNT</span>:
		<span class="n">regval</span> <span class="o">=</span> <span class="n">gpmc_read_reg</span><span class="p">(</span><span class="n">GPMC_PREFETCH_STATUS</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">GPMC_PREFETCH_STATUS_FIFO_CNT</span><span class="p">(</span><span class="n">regval</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">GPMC_PREFETCH_COUNT</span>:
		<span class="n">regval</span> <span class="o">=</span> <span class="n">gpmc_read_reg</span><span class="p">(</span><span class="n">GPMC_PREFETCH_STATUS</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">GPMC_PREFETCH_STATUS_COUNT</span><span class="p">(</span><span class="n">regval</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">GPMC_STATUS_BUFFER</span>:
		<span class="n">regval</span> <span class="o">=</span> <span class="n">gpmc_read_reg</span><span class="p">(</span><span class="n">GPMC_STATUS</span><span class="p">);</span>
		<span class="cm">/* 1 : buffer is available to write */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">regval</span> <span class="o">&amp;</span> <span class="n">GPMC_STATUS_BUFF_EMPTY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;gpmc_read_status: Not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">gpmc_read_status</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * gpmc_cs_configure - write request to configure gpmc</span>
<span class="cm"> * @cs: chip select number</span>
<span class="cm"> * @cmd: command type</span>
<span class="cm"> * @wval: value to write</span>
<span class="cm"> * @return status of the operation</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">gpmc_cs_configure</span><span class="p">(</span><span class="kt">int</span> <span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">regval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GPMC_ENABLE_IRQ</span>:
		<span class="n">gpmc_write_reg</span><span class="p">(</span><span class="n">GPMC_IRQENABLE</span><span class="p">,</span> <span class="n">wval</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">GPMC_SET_IRQ_STATUS</span>:
		<span class="n">gpmc_write_reg</span><span class="p">(</span><span class="n">GPMC_IRQSTATUS</span><span class="p">,</span> <span class="n">wval</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">GPMC_CONFIG_WP</span>:
		<span class="n">regval</span> <span class="o">=</span> <span class="n">gpmc_read_reg</span><span class="p">(</span><span class="n">GPMC_CONFIG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wval</span><span class="p">)</span>
			<span class="n">regval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GPMC_CONFIG_WRITEPROTECT</span><span class="p">;</span> <span class="cm">/* WP is ON */</span>
		<span class="k">else</span>
			<span class="n">regval</span> <span class="o">|=</span> <span class="n">GPMC_CONFIG_WRITEPROTECT</span><span class="p">;</span>  <span class="cm">/* WP is OFF */</span>
		<span class="n">gpmc_write_reg</span><span class="p">(</span><span class="n">GPMC_CONFIG</span><span class="p">,</span> <span class="n">regval</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">GPMC_CONFIG_RDY_BSY</span>:
		<span class="n">regval</span>  <span class="o">=</span> <span class="n">gpmc_cs_read_reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">GPMC_CS_CONFIG1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wval</span><span class="p">)</span>
			<span class="n">regval</span> <span class="o">|=</span> <span class="n">WR_RD_PIN_MONITORING</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">regval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WR_RD_PIN_MONITORING</span><span class="p">;</span>
		<span class="n">gpmc_cs_write_reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">GPMC_CS_CONFIG1</span><span class="p">,</span> <span class="n">regval</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">GPMC_CONFIG_DEV_SIZE</span>:
		<span class="n">regval</span>  <span class="o">=</span> <span class="n">gpmc_cs_read_reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">GPMC_CS_CONFIG1</span><span class="p">);</span>

		<span class="cm">/* clear 2 target bits */</span>
		<span class="n">regval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GPMC_CONFIG1_DEVICESIZE</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

		<span class="cm">/* set the proper value */</span>
		<span class="n">regval</span> <span class="o">|=</span> <span class="n">GPMC_CONFIG1_DEVICESIZE</span><span class="p">(</span><span class="n">wval</span><span class="p">);</span>

		<span class="n">gpmc_cs_write_reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">GPMC_CS_CONFIG1</span><span class="p">,</span> <span class="n">regval</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">GPMC_CONFIG_DEV_TYPE</span>:
		<span class="n">regval</span>  <span class="o">=</span> <span class="n">gpmc_cs_read_reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">GPMC_CS_CONFIG1</span><span class="p">);</span>
		<span class="n">regval</span> <span class="o">|=</span> <span class="n">GPMC_CONFIG1_DEVICETYPE</span><span class="p">(</span><span class="n">wval</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wval</span> <span class="o">==</span> <span class="n">GPMC_DEVICETYPE_NOR</span><span class="p">)</span>
			<span class="n">regval</span> <span class="o">|=</span> <span class="n">GPMC_CONFIG1_MUXADDDATA</span><span class="p">;</span>
		<span class="n">gpmc_cs_write_reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">GPMC_CS_CONFIG1</span><span class="p">,</span> <span class="n">regval</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;gpmc_configure_cs: Not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">gpmc_cs_configure</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * gpmc_nand_read - nand specific read access request</span>
<span class="cm"> * @cs: chip select number</span>
<span class="cm"> * @cmd: command type</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">gpmc_nand_read</span><span class="p">(</span><span class="kt">int</span> <span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GPMC_NAND_DATA</span>:
		<span class="n">rval</span> <span class="o">=</span> <span class="n">gpmc_cs_read_byte</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">GPMC_CS_NAND_DATA</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;gpmc_read_nand_ctrl: Not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">gpmc_nand_read</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * gpmc_nand_write - nand specific write request</span>
<span class="cm"> * @cs: chip select number</span>
<span class="cm"> * @cmd: command type</span>
<span class="cm"> * @wval: value to write</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">gpmc_nand_write</span><span class="p">(</span><span class="kt">int</span> <span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GPMC_NAND_COMMAND</span>:
		<span class="n">gpmc_cs_write_byte</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">GPMC_CS_NAND_COMMAND</span><span class="p">,</span> <span class="n">wval</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">GPMC_NAND_ADDRESS</span>:
		<span class="n">gpmc_cs_write_byte</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">GPMC_CS_NAND_ADDRESS</span><span class="p">,</span> <span class="n">wval</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">GPMC_NAND_DATA</span>:
		<span class="n">gpmc_cs_write_byte</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">GPMC_CS_NAND_DATA</span><span class="p">,</span> <span class="n">wval</span><span class="p">);</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;gpmc_write_nand_ctrl: Not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">gpmc_nand_write</span><span class="p">);</span>



<span class="cm">/**</span>
<span class="cm"> * gpmc_prefetch_enable - configures and starts prefetch transfer</span>
<span class="cm"> * @cs: cs (chip select) number</span>
<span class="cm"> * @fifo_th: fifo threshold to be used for read/ write</span>
<span class="cm"> * @dma_mode: dma mode enable (1) or disable (0)</span>
<span class="cm"> * @u32_count: number of bytes to be transferred</span>
<span class="cm"> * @is_write: prefetch read(0) or write post(1) mode</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">gpmc_prefetch_enable</span><span class="p">(</span><span class="kt">int</span> <span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fifo_th</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dma_mode</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">u32_count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_write</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fifo_th</span> <span class="o">&gt;</span> <span class="n">PREFETCH_FIFOTHRESHOLD_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;gpmc: fifo threshold is not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">gpmc_read_reg</span><span class="p">(</span><span class="n">GPMC_PREFETCH_CONTROL</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Set the amount of bytes to be prefetched */</span>
		<span class="n">gpmc_write_reg</span><span class="p">(</span><span class="n">GPMC_PREFETCH_CONFIG2</span><span class="p">,</span> <span class="n">u32_count</span><span class="p">);</span>

		<span class="cm">/* Set dma/mpu mode, the prefetch read / post write and</span>
<span class="cm">		 * enable the engine. Set which cs is has requested for.</span>
<span class="cm">		 */</span>
		<span class="n">gpmc_write_reg</span><span class="p">(</span><span class="n">GPMC_PREFETCH_CONFIG1</span><span class="p">,</span> <span class="p">((</span><span class="n">cs</span> <span class="o">&lt;&lt;</span> <span class="n">CS_NUM_SHIFT</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">PREFETCH_FIFOTHRESHOLD</span><span class="p">(</span><span class="n">fifo_th</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">ENABLE_PREFETCH</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">dma_mode</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_MPU_MODE</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="mh">0x1</span> <span class="o">&amp;</span> <span class="n">is_write</span><span class="p">)));</span>

		<span class="cm">/*  Start the prefetch engine */</span>
		<span class="n">gpmc_write_reg</span><span class="p">(</span><span class="n">GPMC_PREFETCH_CONTROL</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">gpmc_prefetch_enable</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * gpmc_prefetch_reset - disables and stops the prefetch engine</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">gpmc_prefetch_reset</span><span class="p">(</span><span class="kt">int</span> <span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">config1</span><span class="p">;</span>

	<span class="cm">/* check if the same module/cs is trying to reset */</span>
	<span class="n">config1</span> <span class="o">=</span> <span class="n">gpmc_read_reg</span><span class="p">(</span><span class="n">GPMC_PREFETCH_CONFIG1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">config1</span> <span class="o">&gt;&gt;</span> <span class="n">CS_NUM_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">!=</span> <span class="n">cs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Stop the PFPW engine */</span>
	<span class="n">gpmc_write_reg</span><span class="p">(</span><span class="n">GPMC_PREFETCH_CONTROL</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="cm">/* Reset/disable the PFPW engine */</span>
	<span class="n">gpmc_write_reg</span><span class="p">(</span><span class="n">GPMC_PREFETCH_CONFIG1</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">gpmc_prefetch_reset</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">gpmc_mem_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">boot_rom_space</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* never allocate the first page, to facilitate bug detection;</span>
<span class="cm">	 * even if we didn&#39;t boot from ROM.</span>
<span class="cm">	 */</span>
	<span class="n">boot_rom_space</span> <span class="o">=</span> <span class="n">BOOT_ROM_SPACE</span><span class="p">;</span>
	<span class="cm">/* In apollon the CS0 is mapped as 0x0000 0000 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">machine_is_omap_apollon</span><span class="p">())</span>
		<span class="n">boot_rom_space</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">gpmc_mem_root</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">GPMC_MEM_START</span> <span class="o">+</span> <span class="n">boot_rom_space</span><span class="p">;</span>
	<span class="n">gpmc_mem_root</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">GPMC_MEM_END</span><span class="p">;</span>

	<span class="cm">/* Reserve all regions that has been set up by bootloader */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cs</span> <span class="o">&lt;</span> <span class="n">GPMC_CS_NUM</span><span class="p">;</span> <span class="n">cs</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">base</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gpmc_cs_mem_enabled</span><span class="p">(</span><span class="n">cs</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">gpmc_cs_get_memconf</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpmc_cs_insert_mem</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">gpmc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">,</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cs</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">gpmc_irq</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ck</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap24xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">ck</span> <span class="o">=</span> <span class="s">&quot;core_l3_ck&quot;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap2420</span><span class="p">())</span>
			<span class="n">l</span> <span class="o">=</span> <span class="n">OMAP2420_GPMC_BASE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">l</span> <span class="o">=</span> <span class="n">OMAP34XX_GPMC_BASE</span><span class="p">;</span>
		<span class="n">gpmc_irq</span> <span class="o">=</span> <span class="n">INT_34XX_GPMC_IRQ</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap34xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">ck</span> <span class="o">=</span> <span class="s">&quot;gpmc_fck&quot;</span><span class="p">;</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">OMAP34XX_GPMC_BASE</span><span class="p">;</span>
		<span class="n">gpmc_irq</span> <span class="o">=</span> <span class="n">INT_34XX_GPMC_IRQ</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap44xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">ck</span> <span class="o">=</span> <span class="s">&quot;gpmc_ck&quot;</span><span class="p">;</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">OMAP44XX_GPMC_BASE</span><span class="p">;</span>
		<span class="n">gpmc_irq</span> <span class="o">=</span> <span class="n">OMAP44XX_IRQ_GPMC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ck</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">gpmc_l3_clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">ck</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">gpmc_l3_clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Could not get GPMC clock %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ck</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">gpmc_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">SZ_4K</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gpmc_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clk_put</span><span class="p">(</span><span class="n">gpmc_l3_clk</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Could not get GPMC register memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">clk_enable</span><span class="p">(</span><span class="n">gpmc_l3_clk</span><span class="p">);</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">gpmc_read_reg</span><span class="p">(</span><span class="n">GPMC_REVISION</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;GPMC revision %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="n">l</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="cm">/* Set smart idle mode and automatic L3 clock gating */</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">gpmc_read_reg</span><span class="p">(</span><span class="n">GPMC_SYSCONFIG</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">&amp;=</span> <span class="mh">0x03</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x02</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gpmc_write_reg</span><span class="p">(</span><span class="n">GPMC_SYSCONFIG</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
	<span class="n">gpmc_mem_init</span><span class="p">();</span>

	<span class="cm">/* initalize the irq_chained */</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">OMAP_GPMC_IRQ_BASE</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cs</span> <span class="o">&lt;</span> <span class="n">GPMC_CS_NUM</span><span class="p">;</span> <span class="n">cs</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq_set_chip_and_handler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy_irq_chip</span><span class="p">,</span>
						<span class="n">handle_simple_irq</span><span class="p">);</span>
		<span class="n">set_irq_flags</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">IRQF_VALID</span><span class="p">);</span>
		<span class="n">irq</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">gpmc_irq</span><span class="p">,</span> <span class="n">gpmc_handle_irq</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;gpmc&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;gpmc: irq-%d could not claim: err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">gpmc_irq</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">postcore_initcall</span><span class="p">(</span><span class="n">gpmc_init</span><span class="p">);</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">gpmc_handle_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">cs</span><span class="p">;</span>

	<span class="cm">/* check cs to invoke the irq */</span>
	<span class="n">cs</span> <span class="o">=</span> <span class="p">((</span><span class="n">gpmc_read_reg</span><span class="p">(</span><span class="n">GPMC_PREFETCH_CONFIG1</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="n">CS_NUM_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">OMAP_GPMC_IRQ_BASE</span><span class="o">+</span><span class="n">cs</span> <span class="o">&lt;=</span> <span class="n">OMAP_GPMC_IRQ_END</span><span class="p">)</span>
		<span class="n">generic_handle_irq</span><span class="p">(</span><span class="n">OMAP_GPMC_IRQ_BASE</span><span class="o">+</span><span class="n">cs</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_ARCH_OMAP3</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">omap3_gpmc_regs</span> <span class="n">gpmc_context</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">omap3_gpmc_save_context</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">gpmc_context</span><span class="p">.</span><span class="n">sysconfig</span> <span class="o">=</span> <span class="n">gpmc_read_reg</span><span class="p">(</span><span class="n">GPMC_SYSCONFIG</span><span class="p">);</span>
	<span class="n">gpmc_context</span><span class="p">.</span><span class="n">irqenable</span> <span class="o">=</span> <span class="n">gpmc_read_reg</span><span class="p">(</span><span class="n">GPMC_IRQENABLE</span><span class="p">);</span>
	<span class="n">gpmc_context</span><span class="p">.</span><span class="n">timeout_ctrl</span> <span class="o">=</span> <span class="n">gpmc_read_reg</span><span class="p">(</span><span class="n">GPMC_TIMEOUT_CONTROL</span><span class="p">);</span>
	<span class="n">gpmc_context</span><span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">gpmc_read_reg</span><span class="p">(</span><span class="n">GPMC_CONFIG</span><span class="p">);</span>
	<span class="n">gpmc_context</span><span class="p">.</span><span class="n">prefetch_config1</span> <span class="o">=</span> <span class="n">gpmc_read_reg</span><span class="p">(</span><span class="n">GPMC_PREFETCH_CONFIG1</span><span class="p">);</span>
	<span class="n">gpmc_context</span><span class="p">.</span><span class="n">prefetch_config2</span> <span class="o">=</span> <span class="n">gpmc_read_reg</span><span class="p">(</span><span class="n">GPMC_PREFETCH_CONFIG2</span><span class="p">);</span>
	<span class="n">gpmc_context</span><span class="p">.</span><span class="n">prefetch_control</span> <span class="o">=</span> <span class="n">gpmc_read_reg</span><span class="p">(</span><span class="n">GPMC_PREFETCH_CONTROL</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GPMC_CS_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gpmc_context</span><span class="p">.</span><span class="n">cs_context</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">is_valid</span> <span class="o">=</span> <span class="n">gpmc_cs_mem_enabled</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpmc_context</span><span class="p">.</span><span class="n">cs_context</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">is_valid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gpmc_context</span><span class="p">.</span><span class="n">cs_context</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">config1</span> <span class="o">=</span>
				<span class="n">gpmc_cs_read_reg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">GPMC_CS_CONFIG1</span><span class="p">);</span>
			<span class="n">gpmc_context</span><span class="p">.</span><span class="n">cs_context</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">config2</span> <span class="o">=</span>
				<span class="n">gpmc_cs_read_reg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">GPMC_CS_CONFIG2</span><span class="p">);</span>
			<span class="n">gpmc_context</span><span class="p">.</span><span class="n">cs_context</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">config3</span> <span class="o">=</span>
				<span class="n">gpmc_cs_read_reg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">GPMC_CS_CONFIG3</span><span class="p">);</span>
			<span class="n">gpmc_context</span><span class="p">.</span><span class="n">cs_context</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">config4</span> <span class="o">=</span>
				<span class="n">gpmc_cs_read_reg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">GPMC_CS_CONFIG4</span><span class="p">);</span>
			<span class="n">gpmc_context</span><span class="p">.</span><span class="n">cs_context</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">config5</span> <span class="o">=</span>
				<span class="n">gpmc_cs_read_reg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">GPMC_CS_CONFIG5</span><span class="p">);</span>
			<span class="n">gpmc_context</span><span class="p">.</span><span class="n">cs_context</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">config6</span> <span class="o">=</span>
				<span class="n">gpmc_cs_read_reg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">GPMC_CS_CONFIG6</span><span class="p">);</span>
			<span class="n">gpmc_context</span><span class="p">.</span><span class="n">cs_context</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">config7</span> <span class="o">=</span>
				<span class="n">gpmc_cs_read_reg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">GPMC_CS_CONFIG7</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">omap3_gpmc_restore_context</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">gpmc_write_reg</span><span class="p">(</span><span class="n">GPMC_SYSCONFIG</span><span class="p">,</span> <span class="n">gpmc_context</span><span class="p">.</span><span class="n">sysconfig</span><span class="p">);</span>
	<span class="n">gpmc_write_reg</span><span class="p">(</span><span class="n">GPMC_IRQENABLE</span><span class="p">,</span> <span class="n">gpmc_context</span><span class="p">.</span><span class="n">irqenable</span><span class="p">);</span>
	<span class="n">gpmc_write_reg</span><span class="p">(</span><span class="n">GPMC_TIMEOUT_CONTROL</span><span class="p">,</span> <span class="n">gpmc_context</span><span class="p">.</span><span class="n">timeout_ctrl</span><span class="p">);</span>
	<span class="n">gpmc_write_reg</span><span class="p">(</span><span class="n">GPMC_CONFIG</span><span class="p">,</span> <span class="n">gpmc_context</span><span class="p">.</span><span class="n">config</span><span class="p">);</span>
	<span class="n">gpmc_write_reg</span><span class="p">(</span><span class="n">GPMC_PREFETCH_CONFIG1</span><span class="p">,</span> <span class="n">gpmc_context</span><span class="p">.</span><span class="n">prefetch_config1</span><span class="p">);</span>
	<span class="n">gpmc_write_reg</span><span class="p">(</span><span class="n">GPMC_PREFETCH_CONFIG2</span><span class="p">,</span> <span class="n">gpmc_context</span><span class="p">.</span><span class="n">prefetch_config2</span><span class="p">);</span>
	<span class="n">gpmc_write_reg</span><span class="p">(</span><span class="n">GPMC_PREFETCH_CONTROL</span><span class="p">,</span> <span class="n">gpmc_context</span><span class="p">.</span><span class="n">prefetch_control</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GPMC_CS_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpmc_context</span><span class="p">.</span><span class="n">cs_context</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">is_valid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gpmc_cs_write_reg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">GPMC_CS_CONFIG1</span><span class="p">,</span>
				<span class="n">gpmc_context</span><span class="p">.</span><span class="n">cs_context</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">config1</span><span class="p">);</span>
			<span class="n">gpmc_cs_write_reg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">GPMC_CS_CONFIG2</span><span class="p">,</span>
				<span class="n">gpmc_context</span><span class="p">.</span><span class="n">cs_context</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">config2</span><span class="p">);</span>
			<span class="n">gpmc_cs_write_reg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">GPMC_CS_CONFIG3</span><span class="p">,</span>
				<span class="n">gpmc_context</span><span class="p">.</span><span class="n">cs_context</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">config3</span><span class="p">);</span>
			<span class="n">gpmc_cs_write_reg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">GPMC_CS_CONFIG4</span><span class="p">,</span>
				<span class="n">gpmc_context</span><span class="p">.</span><span class="n">cs_context</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">config4</span><span class="p">);</span>
			<span class="n">gpmc_cs_write_reg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">GPMC_CS_CONFIG5</span><span class="p">,</span>
				<span class="n">gpmc_context</span><span class="p">.</span><span class="n">cs_context</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">config5</span><span class="p">);</span>
			<span class="n">gpmc_cs_write_reg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">GPMC_CS_CONFIG6</span><span class="p">,</span>
				<span class="n">gpmc_context</span><span class="p">.</span><span class="n">cs_context</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">config6</span><span class="p">);</span>
			<span class="n">gpmc_cs_write_reg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">GPMC_CS_CONFIG7</span><span class="p">,</span>
				<span class="n">gpmc_context</span><span class="p">.</span><span class="n">cs_context</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">config7</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ARCH_OMAP3 */</span><span class="cp"></span>

<span class="cm">/**</span>
<span class="cm"> * gpmc_enable_hwecc - enable hardware ecc functionality</span>
<span class="cm"> * @cs: chip select number</span>
<span class="cm"> * @mode: read/write mode</span>
<span class="cm"> * @dev_width: device bus width(1 for x16, 0 for x8)</span>
<span class="cm"> * @ecc_size: bytes for which ECC will be generated</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">gpmc_enable_hwecc</span><span class="p">(</span><span class="kt">int</span> <span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev_width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ecc_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* check if ecc module is in used */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpmc_ecc_used</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">gpmc_ecc_used</span> <span class="o">=</span> <span class="n">cs</span><span class="p">;</span>

	<span class="cm">/* clear ecc and enable bits */</span>
	<span class="n">gpmc_write_reg</span><span class="p">(</span><span class="n">GPMC_ECC_CONTROL</span><span class="p">,</span>
			<span class="n">GPMC_ECC_CTRL_ECCCLEAR</span> <span class="o">|</span>
			<span class="n">GPMC_ECC_CTRL_ECCREG1</span><span class="p">);</span>

	<span class="cm">/* program ecc and result sizes */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">((((</span><span class="n">ecc_size</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x0000000F</span><span class="p">));</span>
	<span class="n">gpmc_write_reg</span><span class="p">(</span><span class="n">GPMC_ECC_SIZE_CONFIG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GPMC_ECC_READ</span>:
	<span class="k">case</span> <span class="n">GPMC_ECC_WRITE</span>:
		<span class="n">gpmc_write_reg</span><span class="p">(</span><span class="n">GPMC_ECC_CONTROL</span><span class="p">,</span>
				<span class="n">GPMC_ECC_CTRL_ECCCLEAR</span> <span class="o">|</span>
				<span class="n">GPMC_ECC_CTRL_ECCREG1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPMC_ECC_READSYN</span>:
		<span class="n">gpmc_write_reg</span><span class="p">(</span><span class="n">GPMC_ECC_CONTROL</span><span class="p">,</span>
				<span class="n">GPMC_ECC_CTRL_ECCCLEAR</span> <span class="o">|</span>
				<span class="n">GPMC_ECC_CTRL_ECCDISABLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Error: Unrecognized Mode[%d]!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* (ECC 16 or 8 bit col) | ( CS  )  | ECC Enable */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev_width</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cs</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x1</span><span class="p">);</span>
	<span class="n">gpmc_write_reg</span><span class="p">(</span><span class="n">GPMC_ECC_CONFIG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">gpmc_enable_hwecc</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * gpmc_calculate_ecc - generate non-inverted ecc bytes</span>
<span class="cm"> * @cs: chip select number</span>
<span class="cm"> * @dat: data pointer over which ecc is computed</span>
<span class="cm"> * @ecc_code: ecc code buffer</span>
<span class="cm"> *</span>
<span class="cm"> * Using non-inverted ECC is considered ugly since writing a blank</span>
<span class="cm"> * page (padding) will clear the ECC bytes. This is not a problem as long</span>
<span class="cm"> * no one is trying to write data on the seemingly unused page. Reading</span>
<span class="cm"> * an erased page will produce an ECC mismatch between generated and read</span>
<span class="cm"> * ECC bytes that has to be dealt with separately.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">gpmc_calculate_ecc</span><span class="p">(</span><span class="kt">int</span> <span class="n">cs</span><span class="p">,</span> <span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">dat</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">ecc_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpmc_ecc_used</span> <span class="o">!=</span> <span class="n">cs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* read ecc result */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">gpmc_read_reg</span><span class="p">(</span><span class="n">GPMC_ECC1_RESULT</span><span class="p">);</span>
	<span class="o">*</span><span class="n">ecc_code</span><span class="o">++</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>          <span class="cm">/* P128e, ..., P1e */</span>
	<span class="o">*</span><span class="n">ecc_code</span><span class="o">++</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>    <span class="cm">/* P128o, ..., P1o */</span>
	<span class="cm">/* P2048o, P1024o, P512o, P256o, P2048e, P1024e, P512e, P256e */</span>
	<span class="o">*</span><span class="n">ecc_code</span><span class="o">++</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">);</span>

	<span class="n">gpmc_ecc_used</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">gpmc_calculate_ecc</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_ARCH_OMAP3</span>

<span class="cm">/**</span>
<span class="cm"> * gpmc_init_hwecc_bch - initialize hardware BCH ecc functionality</span>
<span class="cm"> * @cs: chip select number</span>
<span class="cm"> * @nsectors: how many 512-byte sectors to process</span>
<span class="cm"> * @nerrors: how many errors to correct per sector (4 or 8)</span>
<span class="cm"> *</span>
<span class="cm"> * This function must be executed before any call to gpmc_enable_hwecc_bch.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">gpmc_init_hwecc_bch</span><span class="p">(</span><span class="kt">int</span> <span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nsectors</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nerrors</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* check if ecc module is in use */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpmc_ecc_used</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* support only OMAP3 class */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_is_omap34xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;BCH ecc is not supported on this CPU</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * For now, assume 4-bit mode is only supported on OMAP3630 ES1.x, x&gt;=1.</span>
<span class="cm">	 * Other chips may be added if confirmed to work.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">nerrors</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">cpu_is_omap3630</span><span class="p">()</span> <span class="o">||</span> <span class="p">(</span><span class="n">GET_OMAP_REVISION</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;BCH 4-bit mode is not supported on this CPU</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* sanity check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nsectors</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;BCH cannot process %d sectors (max is 8)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">nsectors</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">gpmc_init_hwecc_bch</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * gpmc_enable_hwecc_bch - enable hardware BCH ecc functionality</span>
<span class="cm"> * @cs: chip select number</span>
<span class="cm"> * @mode: read/write mode</span>
<span class="cm"> * @dev_width: device bus width(1 for x16, 0 for x8)</span>
<span class="cm"> * @nsectors: how many 512-byte sectors to process</span>
<span class="cm"> * @nerrors: how many errors to correct per sector (4 or 8)</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">gpmc_enable_hwecc_bch</span><span class="p">(</span><span class="kt">int</span> <span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev_width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nsectors</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">nerrors</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* check if ecc module is in use */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpmc_ecc_used</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">gpmc_ecc_used</span> <span class="o">=</span> <span class="n">cs</span><span class="p">;</span>

	<span class="cm">/* clear ecc and enable bits */</span>
	<span class="n">gpmc_write_reg</span><span class="p">(</span><span class="n">GPMC_ECC_CONTROL</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * When using BCH, sector size is hardcoded to 512 bytes.</span>
<span class="cm">	 * Here we are using wrapping mode 6 both for reading and writing, with:</span>
<span class="cm">	 *  size0 = 0  (no additional protected byte in spare area)</span>
<span class="cm">	 *  size1 = 32 (skip 32 nibbles = 16 bytes per sector in spare area)</span>
<span class="cm">	 */</span>
	<span class="n">gpmc_write_reg</span><span class="p">(</span><span class="n">GPMC_ECC_SIZE_CONFIG</span><span class="p">,</span> <span class="p">(</span><span class="mi">32</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">));</span>

	<span class="cm">/* BCH configuration */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span>                        <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* enable BCH */</span>
	       <span class="p">(((</span><span class="n">nerrors</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* 8 or 4 bits */</span>
	       <span class="p">(</span><span class="mh">0x06</span>                     <span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* wrap mode = 6 */</span>
	       <span class="p">(</span><span class="n">dev_width</span>                <span class="o">&lt;&lt;</span>  <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* bus width */</span>
	       <span class="p">(((</span><span class="n">nsectors</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span>     <span class="o">&lt;&lt;</span>  <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* number of sectors */</span>
	       <span class="p">(</span><span class="n">cs</span>                       <span class="o">&lt;&lt;</span>  <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* ECC CS */</span>
	       <span class="p">(</span><span class="mh">0x1</span><span class="p">));</span>                            <span class="cm">/* enable ECC */</span>

	<span class="n">gpmc_write_reg</span><span class="p">(</span><span class="n">GPMC_ECC_CONFIG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">gpmc_write_reg</span><span class="p">(</span><span class="n">GPMC_ECC_CONTROL</span><span class="p">,</span> <span class="mh">0x101</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">gpmc_enable_hwecc_bch</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * gpmc_calculate_ecc_bch4 - Generate 7 ecc bytes per sector of 512 data bytes</span>
<span class="cm"> * @cs:  chip select number</span>
<span class="cm"> * @dat: The pointer to data on which ecc is computed</span>
<span class="cm"> * @ecc: The ecc output buffer</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">gpmc_calculate_ecc_bch4</span><span class="p">(</span><span class="kt">int</span> <span class="n">cs</span><span class="p">,</span> <span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">dat</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">ecc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nsectors</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val1</span><span class="p">,</span> <span class="n">val2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpmc_ecc_used</span> <span class="o">!=</span> <span class="n">cs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">nsectors</span> <span class="o">=</span> <span class="p">((</span><span class="n">gpmc_read_reg</span><span class="p">(</span><span class="n">GPMC_ECC_CONFIG</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nsectors</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">GPMC_ECC_BCH_RESULT_0</span> <span class="o">+</span> <span class="mi">16</span><span class="o">*</span><span class="n">i</span><span class="p">;</span>

		<span class="cm">/* Read hw-computed remainder */</span>
		<span class="n">val1</span> <span class="o">=</span> <span class="n">gpmc_read_reg</span><span class="p">(</span><span class="n">reg</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">val2</span> <span class="o">=</span> <span class="n">gpmc_read_reg</span><span class="p">(</span><span class="n">reg</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Add constant polynomial to remainder, in order to get an ecc</span>
<span class="cm">		 * sequence of 0xFFs for a buffer filled with 0xFFs; and</span>
<span class="cm">		 * left-justify the resulting polynomial.</span>
<span class="cm">		 */</span>
		<span class="o">*</span><span class="n">ecc</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x28</span> <span class="o">^</span> <span class="p">((</span><span class="n">val2</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="o">*</span><span class="n">ecc</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x13</span> <span class="o">^</span> <span class="p">((</span><span class="n">val2</span> <span class="o">&gt;&gt;</span>  <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="o">*</span><span class="n">ecc</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xcc</span> <span class="o">^</span> <span class="p">(((</span><span class="n">val2</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span><span class="o">|</span><span class="p">((</span><span class="n">val1</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">));</span>
		<span class="o">*</span><span class="n">ecc</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x39</span> <span class="o">^</span> <span class="p">((</span><span class="n">val1</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="o">*</span><span class="n">ecc</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x96</span> <span class="o">^</span> <span class="p">((</span><span class="n">val1</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="o">*</span><span class="n">ecc</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xac</span> <span class="o">^</span> <span class="p">((</span><span class="n">val1</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="o">*</span><span class="n">ecc</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x7f</span> <span class="o">^</span> <span class="p">((</span><span class="n">val1</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">gpmc_ecc_used</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">gpmc_calculate_ecc_bch4</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * gpmc_calculate_ecc_bch8 - Generate 13 ecc bytes per block of 512 data bytes</span>
<span class="cm"> * @cs:  chip select number</span>
<span class="cm"> * @dat: The pointer to data on which ecc is computed</span>
<span class="cm"> * @ecc: The ecc output buffer</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">gpmc_calculate_ecc_bch8</span><span class="p">(</span><span class="kt">int</span> <span class="n">cs</span><span class="p">,</span> <span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">dat</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">ecc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nsectors</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val1</span><span class="p">,</span> <span class="n">val2</span><span class="p">,</span> <span class="n">val3</span><span class="p">,</span> <span class="n">val4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpmc_ecc_used</span> <span class="o">!=</span> <span class="n">cs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">nsectors</span> <span class="o">=</span> <span class="p">((</span><span class="n">gpmc_read_reg</span><span class="p">(</span><span class="n">GPMC_ECC_CONFIG</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nsectors</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">GPMC_ECC_BCH_RESULT_0</span> <span class="o">+</span> <span class="mi">16</span><span class="o">*</span><span class="n">i</span><span class="p">;</span>

		<span class="cm">/* Read hw-computed remainder */</span>
		<span class="n">val1</span> <span class="o">=</span> <span class="n">gpmc_read_reg</span><span class="p">(</span><span class="n">reg</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">val2</span> <span class="o">=</span> <span class="n">gpmc_read_reg</span><span class="p">(</span><span class="n">reg</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">val3</span> <span class="o">=</span> <span class="n">gpmc_read_reg</span><span class="p">(</span><span class="n">reg</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">val4</span> <span class="o">=</span> <span class="n">gpmc_read_reg</span><span class="p">(</span><span class="n">reg</span> <span class="o">+</span> <span class="mi">12</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Add constant polynomial to remainder, in order to get an ecc</span>
<span class="cm">		 * sequence of 0xFFs for a buffer filled with 0xFFs.</span>
<span class="cm">		 */</span>
		<span class="o">*</span><span class="n">ecc</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xef</span> <span class="o">^</span> <span class="p">(</span><span class="n">val4</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="o">*</span><span class="n">ecc</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x51</span> <span class="o">^</span> <span class="p">((</span><span class="n">val3</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="o">*</span><span class="n">ecc</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x2e</span> <span class="o">^</span> <span class="p">((</span><span class="n">val3</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="o">*</span><span class="n">ecc</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x09</span> <span class="o">^</span> <span class="p">((</span><span class="n">val3</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="o">*</span><span class="n">ecc</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xed</span> <span class="o">^</span> <span class="p">(</span><span class="n">val3</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="o">*</span><span class="n">ecc</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x93</span> <span class="o">^</span> <span class="p">((</span><span class="n">val2</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="o">*</span><span class="n">ecc</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x9a</span> <span class="o">^</span> <span class="p">((</span><span class="n">val2</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="o">*</span><span class="n">ecc</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xc2</span> <span class="o">^</span> <span class="p">((</span><span class="n">val2</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="o">*</span><span class="n">ecc</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x97</span> <span class="o">^</span> <span class="p">(</span><span class="n">val2</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="o">*</span><span class="n">ecc</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x79</span> <span class="o">^</span> <span class="p">((</span><span class="n">val1</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="o">*</span><span class="n">ecc</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xe5</span> <span class="o">^</span> <span class="p">((</span><span class="n">val1</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="o">*</span><span class="n">ecc</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x24</span> <span class="o">^</span> <span class="p">((</span><span class="n">val1</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="o">*</span><span class="n">ecc</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xb5</span> <span class="o">^</span> <span class="p">(</span><span class="n">val1</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">gpmc_ecc_used</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">gpmc_calculate_ecc_bch8</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_ARCH_OMAP3 */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
