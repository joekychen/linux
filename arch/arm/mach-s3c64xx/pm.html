<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › mach-s3c64xx › pm.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>pm.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* linux/arch/arm/plat-s3c64xx/pm.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2008 Openmoko, Inc.</span>
<span class="cm"> * Copyright 2008 Simtec Electronics</span>
<span class="cm"> *	Ben Dooks &lt;ben@simtec.co.uk&gt;</span>
<span class="cm"> *	http://armlinux.simtec.co.uk/</span>
<span class="cm"> *</span>
<span class="cm"> * S3C64XX CPU PM support.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm">*/</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/suspend.h&gt;</span>
<span class="cp">#include &lt;linux/serial_core.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/pm_domain.h&gt;</span>

<span class="cp">#include &lt;mach/map.h&gt;</span>
<span class="cp">#include &lt;mach/irqs.h&gt;</span>

<span class="cp">#include &lt;plat/devs.h&gt;</span>
<span class="cp">#include &lt;plat/pm.h&gt;</span>
<span class="cp">#include &lt;plat/wakeup-mask.h&gt;</span>

<span class="cp">#include &lt;mach/regs-sys.h&gt;</span>
<span class="cp">#include &lt;mach/regs-gpio.h&gt;</span>
<span class="cp">#include &lt;mach/regs-clock.h&gt;</span>
<span class="cp">#include &lt;mach/regs-syscon-power.h&gt;</span>
<span class="cp">#include &lt;mach/regs-gpio-memport.h&gt;</span>
<span class="cp">#include &lt;mach/regs-modem.h&gt;</span>

<span class="k">struct</span> <span class="n">s3c64xx_pm_domain</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">name</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ena</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pwr_stat</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="n">pd</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c64xx_pd_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">domain</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c64xx_pm_domain</span> <span class="o">*</span><span class="n">pd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">pd</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s3c64xx_pm_domain</span><span class="p">,</span> <span class="n">pd</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">S3C64XX_NORMAL_CFG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">ena</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">S3C64XX_NORMAL_CFG</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c64xx_pd_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">generic_pm_domain</span> <span class="o">*</span><span class="n">domain</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c64xx_pm_domain</span> <span class="o">*</span><span class="n">pd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">retry</span> <span class="o">=</span> <span class="mi">1000000L</span><span class="p">;</span>

	<span class="n">pd</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s3c64xx_pm_domain</span><span class="p">,</span> <span class="n">pd</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">S3C64XX_NORMAL_CFG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">ena</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">S3C64XX_NORMAL_CFG</span><span class="p">);</span>

	<span class="cm">/* Not all domains provide power status readback */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">pwr_stat</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">cpu_relax</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">S3C64XX_BLK_PWR_STAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">pwr_stat</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">retry</span><span class="o">--</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retry</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to start domain %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">s3c64xx_pm_domain</span> <span class="n">s3c64xx_pm_irom</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;IROM&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ena</span> <span class="o">=</span> <span class="n">S3C64XX_NORMALCFG_IROM_ON</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">power_off</span> <span class="o">=</span> <span class="n">s3c64xx_pd_off</span><span class="p">,</span>
		<span class="p">.</span><span class="n">power_on</span> <span class="o">=</span> <span class="n">s3c64xx_pd_on</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">s3c64xx_pm_domain</span> <span class="n">s3c64xx_pm_etm</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ETM&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ena</span> <span class="o">=</span> <span class="n">S3C64XX_NORMALCFG_DOMAIN_ETM_ON</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pwr_stat</span> <span class="o">=</span> <span class="n">S3C64XX_BLKPWRSTAT_ETM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">power_off</span> <span class="o">=</span> <span class="n">s3c64xx_pd_off</span><span class="p">,</span>
		<span class="p">.</span><span class="n">power_on</span> <span class="o">=</span> <span class="n">s3c64xx_pd_on</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">s3c64xx_pm_domain</span> <span class="n">s3c64xx_pm_s</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;S&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ena</span> <span class="o">=</span> <span class="n">S3C64XX_NORMALCFG_DOMAIN_S_ON</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pwr_stat</span> <span class="o">=</span> <span class="n">S3C64XX_BLKPWRSTAT_S</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">power_off</span> <span class="o">=</span> <span class="n">s3c64xx_pd_off</span><span class="p">,</span>
		<span class="p">.</span><span class="n">power_on</span> <span class="o">=</span> <span class="n">s3c64xx_pd_on</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">s3c64xx_pm_domain</span> <span class="n">s3c64xx_pm_f</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;F&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ena</span> <span class="o">=</span> <span class="n">S3C64XX_NORMALCFG_DOMAIN_F_ON</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pwr_stat</span> <span class="o">=</span> <span class="n">S3C64XX_BLKPWRSTAT_F</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">power_off</span> <span class="o">=</span> <span class="n">s3c64xx_pd_off</span><span class="p">,</span>
		<span class="p">.</span><span class="n">power_on</span> <span class="o">=</span> <span class="n">s3c64xx_pd_on</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">s3c64xx_pm_domain</span> <span class="n">s3c64xx_pm_p</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;P&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ena</span> <span class="o">=</span> <span class="n">S3C64XX_NORMALCFG_DOMAIN_P_ON</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pwr_stat</span> <span class="o">=</span> <span class="n">S3C64XX_BLKPWRSTAT_P</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">power_off</span> <span class="o">=</span> <span class="n">s3c64xx_pd_off</span><span class="p">,</span>
		<span class="p">.</span><span class="n">power_on</span> <span class="o">=</span> <span class="n">s3c64xx_pd_on</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">s3c64xx_pm_domain</span> <span class="n">s3c64xx_pm_i</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;I&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ena</span> <span class="o">=</span> <span class="n">S3C64XX_NORMALCFG_DOMAIN_I_ON</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pwr_stat</span> <span class="o">=</span> <span class="n">S3C64XX_BLKPWRSTAT_I</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">power_off</span> <span class="o">=</span> <span class="n">s3c64xx_pd_off</span><span class="p">,</span>
		<span class="p">.</span><span class="n">power_on</span> <span class="o">=</span> <span class="n">s3c64xx_pd_on</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">s3c64xx_pm_domain</span> <span class="n">s3c64xx_pm_g</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;G&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ena</span> <span class="o">=</span> <span class="n">S3C64XX_NORMALCFG_DOMAIN_G_ON</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">power_off</span> <span class="o">=</span> <span class="n">s3c64xx_pd_off</span><span class="p">,</span>
		<span class="p">.</span><span class="n">power_on</span> <span class="o">=</span> <span class="n">s3c64xx_pd_on</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">s3c64xx_pm_domain</span> <span class="n">s3c64xx_pm_v</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;V&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ena</span> <span class="o">=</span> <span class="n">S3C64XX_NORMALCFG_DOMAIN_V_ON</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pwr_stat</span> <span class="o">=</span> <span class="n">S3C64XX_BLKPWRSTAT_V</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">power_off</span> <span class="o">=</span> <span class="n">s3c64xx_pd_off</span><span class="p">,</span>
		<span class="p">.</span><span class="n">power_on</span> <span class="o">=</span> <span class="n">s3c64xx_pd_on</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">s3c64xx_pm_domain</span> <span class="o">*</span><span class="n">s3c64xx_always_on_pm_domains</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">s3c64xx_pm_irom</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">s3c64xx_pm_domain</span> <span class="o">*</span><span class="n">s3c64xx_pm_domains</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">s3c64xx_pm_etm</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">s3c64xx_pm_g</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">s3c64xx_pm_v</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">s3c64xx_pm_i</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">s3c64xx_pm_p</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">s3c64xx_pm_s</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">s3c64xx_pm_f</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_S3C_PM_DEBUG_LED_SMDK</span>
<span class="kt">void</span> <span class="nf">s3c_pm_debug_smdkled</span><span class="p">(</span><span class="n">u32</span> <span class="n">set</span><span class="p">,</span> <span class="n">u32</span> <span class="n">clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
			<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">S3C64XX_GPN</span><span class="p">(</span><span class="mi">12</span> <span class="o">+</span> <span class="n">i</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
			<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">S3C64XX_GPN</span><span class="p">(</span><span class="mi">12</span> <span class="o">+</span> <span class="n">i</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sleep_save</span> <span class="n">core_save</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SAVE_ITEM</span><span class="p">(</span><span class="n">S3C_APLL_LOCK</span><span class="p">),</span>
	<span class="n">SAVE_ITEM</span><span class="p">(</span><span class="n">S3C_MPLL_LOCK</span><span class="p">),</span>
	<span class="n">SAVE_ITEM</span><span class="p">(</span><span class="n">S3C_EPLL_LOCK</span><span class="p">),</span>
	<span class="n">SAVE_ITEM</span><span class="p">(</span><span class="n">S3C_CLK_SRC</span><span class="p">),</span>
	<span class="n">SAVE_ITEM</span><span class="p">(</span><span class="n">S3C_CLK_DIV0</span><span class="p">),</span>
	<span class="n">SAVE_ITEM</span><span class="p">(</span><span class="n">S3C_CLK_DIV1</span><span class="p">),</span>
	<span class="n">SAVE_ITEM</span><span class="p">(</span><span class="n">S3C_CLK_DIV2</span><span class="p">),</span>
	<span class="n">SAVE_ITEM</span><span class="p">(</span><span class="n">S3C_CLK_OUT</span><span class="p">),</span>
	<span class="n">SAVE_ITEM</span><span class="p">(</span><span class="n">S3C_HCLK_GATE</span><span class="p">),</span>
	<span class="n">SAVE_ITEM</span><span class="p">(</span><span class="n">S3C_PCLK_GATE</span><span class="p">),</span>
	<span class="n">SAVE_ITEM</span><span class="p">(</span><span class="n">S3C_SCLK_GATE</span><span class="p">),</span>
	<span class="n">SAVE_ITEM</span><span class="p">(</span><span class="n">S3C_MEM0_GATE</span><span class="p">),</span>

	<span class="n">SAVE_ITEM</span><span class="p">(</span><span class="n">S3C_EPLL_CON1</span><span class="p">),</span>
	<span class="n">SAVE_ITEM</span><span class="p">(</span><span class="n">S3C_EPLL_CON0</span><span class="p">),</span>

	<span class="n">SAVE_ITEM</span><span class="p">(</span><span class="n">S3C64XX_MEM0DRVCON</span><span class="p">),</span>
	<span class="n">SAVE_ITEM</span><span class="p">(</span><span class="n">S3C64XX_MEM1DRVCON</span><span class="p">),</span>

<span class="cp">#ifndef CONFIG_CPU_FREQ</span>
	<span class="n">SAVE_ITEM</span><span class="p">(</span><span class="n">S3C_APLL_CON</span><span class="p">),</span>
	<span class="n">SAVE_ITEM</span><span class="p">(</span><span class="n">S3C_MPLL_CON</span><span class="p">),</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sleep_save</span> <span class="n">misc_save</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SAVE_ITEM</span><span class="p">(</span><span class="n">S3C64XX_AHB_CON0</span><span class="p">),</span>
	<span class="n">SAVE_ITEM</span><span class="p">(</span><span class="n">S3C64XX_AHB_CON1</span><span class="p">),</span>
	<span class="n">SAVE_ITEM</span><span class="p">(</span><span class="n">S3C64XX_AHB_CON2</span><span class="p">),</span>
	
	<span class="n">SAVE_ITEM</span><span class="p">(</span><span class="n">S3C64XX_SPCON</span><span class="p">),</span>

	<span class="n">SAVE_ITEM</span><span class="p">(</span><span class="n">S3C64XX_MEM0CONSTOP</span><span class="p">),</span>
	<span class="n">SAVE_ITEM</span><span class="p">(</span><span class="n">S3C64XX_MEM1CONSTOP</span><span class="p">),</span>
	<span class="n">SAVE_ITEM</span><span class="p">(</span><span class="n">S3C64XX_MEM0CONSLP0</span><span class="p">),</span>
	<span class="n">SAVE_ITEM</span><span class="p">(</span><span class="n">S3C64XX_MEM0CONSLP1</span><span class="p">),</span>
	<span class="n">SAVE_ITEM</span><span class="p">(</span><span class="n">S3C64XX_MEM1CONSLP</span><span class="p">),</span>

	<span class="n">SAVE_ITEM</span><span class="p">(</span><span class="n">S3C64XX_SDMA_SEL</span><span class="p">),</span>
	<span class="n">SAVE_ITEM</span><span class="p">(</span><span class="n">S3C64XX_MODEM_MIFPCON</span><span class="p">),</span>

	<span class="n">SAVE_ITEM</span><span class="p">(</span><span class="n">S3C64XX_NORMAL_CFG</span><span class="p">),</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">s3c_pm_configure_extint</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">s3c_irqwake_eintmask</span><span class="p">,</span> <span class="n">S3C64XX_EINT_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">s3c_pm_restore_core</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">S3C64XX_EINT_MASK</span><span class="p">);</span>

	<span class="n">s3c_pm_debug_smdkled</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">s3c_pm_do_restore_core</span><span class="p">(</span><span class="n">core_save</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">core_save</span><span class="p">));</span>
	<span class="n">s3c_pm_do_restore</span><span class="p">(</span><span class="n">misc_save</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">misc_save</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">s3c_pm_save_core</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s3c_pm_do_save</span><span class="p">(</span><span class="n">misc_save</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">misc_save</span><span class="p">));</span>
	<span class="n">s3c_pm_do_save</span><span class="p">(</span><span class="n">core_save</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">core_save</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* since both s3c6400 and s3c6410 share the same sleep pm calls, we</span>
<span class="cm"> * put the per-cpu code in here until any new cpu comes along and changes</span>
<span class="cm"> * this.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c64xx_cpu_suspend</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* set our standby method to sleep */</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">S3C64XX_PWR_CFG</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">S3C64XX_PWRCFG_CFG_WFI_MASK</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">S3C64XX_PWRCFG_CFG_WFI_SLEEP</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">S3C64XX_PWR_CFG</span><span class="p">);</span>

	<span class="cm">/* clear any old wakeup */</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">S3C64XX_WAKEUP_STAT</span><span class="p">),</span>
		     <span class="n">S3C64XX_WAKEUP_STAT</span><span class="p">);</span>

	<span class="cm">/* set the LED state to 0110 over sleep */</span>
	<span class="n">s3c_pm_debug_smdkled</span><span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">);</span>

	<span class="cm">/* issue the standby signal into the pm unit. Note, we</span>
<span class="cm">	 * issue a write-buffer drain just in case */</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">asm</span><span class="p">(</span><span class="s">&quot;b 1f</span><span class="se">\n\t</span><span class="s">&quot;</span>
	    <span class="s">&quot;.align 5</span><span class="se">\n\t</span><span class="s">&quot;</span>
	    <span class="s">&quot;1:</span><span class="se">\n\t</span><span class="s">&quot;</span>
	    <span class="s">&quot;mcr p15, 0, %0, c7, c10, 5</span><span class="se">\n\t</span><span class="s">&quot;</span>
	    <span class="s">&quot;mcr p15, 0, %0, c7, c10, 4</span><span class="se">\n\t</span><span class="s">&quot;</span>
	    <span class="s">&quot;mcr p15, 0, %0, c7, c0, 4&quot;</span> <span class="o">::</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">tmp</span><span class="p">));</span>

	<span class="cm">/* we should never get past here */</span>

	<span class="n">panic</span><span class="p">(</span><span class="s">&quot;sleep resumed to originator?&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* mapping of interrupts to parts of the wakeup mask */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">samsung_wakeup_mask</span> <span class="n">wake_irqs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">IRQ_RTC_ALARM</span><span class="p">,</span>	<span class="p">.</span><span class="n">bit</span> <span class="o">=</span> <span class="n">S3C64XX_PWRCFG_RTC_ALARM_DISABLE</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">IRQ_RTC_TIC</span><span class="p">,</span>	<span class="p">.</span><span class="n">bit</span> <span class="o">=</span> <span class="n">S3C64XX_PWRCFG_RTC_TICK_DISABLE</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">IRQ_PENDN</span><span class="p">,</span>	<span class="p">.</span><span class="n">bit</span> <span class="o">=</span> <span class="n">S3C64XX_PWRCFG_TS_DISABLE</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">IRQ_HSMMC0</span><span class="p">,</span>	<span class="p">.</span><span class="n">bit</span> <span class="o">=</span> <span class="n">S3C64XX_PWRCFG_MMC0_DISABLE</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">IRQ_HSMMC1</span><span class="p">,</span>	<span class="p">.</span><span class="n">bit</span> <span class="o">=</span> <span class="n">S3C64XX_PWRCFG_MMC1_DISABLE</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">IRQ_HSMMC2</span><span class="p">,</span>	<span class="p">.</span><span class="n">bit</span> <span class="o">=</span> <span class="n">S3C64XX_PWRCFG_MMC2_DISABLE</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">NO_WAKEUP_IRQ</span><span class="p">,</span>	<span class="p">.</span><span class="n">bit</span> <span class="o">=</span> <span class="n">S3C64XX_PWRCFG_BATF_DISABLE</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">NO_WAKEUP_IRQ</span><span class="p">,</span>	<span class="p">.</span><span class="n">bit</span> <span class="o">=</span> <span class="n">S3C64XX_PWRCFG_MSM_DISABLE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">NO_WAKEUP_IRQ</span><span class="p">,</span>	<span class="p">.</span><span class="n">bit</span> <span class="o">=</span> <span class="n">S3C64XX_PWRCFG_HSI_DISABLE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">NO_WAKEUP_IRQ</span><span class="p">,</span>	<span class="p">.</span><span class="n">bit</span> <span class="o">=</span> <span class="n">S3C64XX_PWRCFG_MSM_DISABLE</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c64xx_pm_prepare</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">samsung_sync_wakemask</span><span class="p">(</span><span class="n">S3C64XX_PWR_CFG</span><span class="p">,</span>
			      <span class="n">wake_irqs</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wake_irqs</span><span class="p">));</span>

	<span class="cm">/* store address of resume. */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="n">s3c_cpu_resume</span><span class="p">),</span> <span class="n">S3C64XX_INFORM0</span><span class="p">);</span>

	<span class="cm">/* ensure previous wakeup state is cleared before sleeping */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">S3C64XX_WAKEUP_STAT</span><span class="p">),</span> <span class="n">S3C64XX_WAKEUP_STAT</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">s3c64xx_pm_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">s3c_pm_init</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">s3c64xx_always_on_pm_domains</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pm_genpd_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s3c64xx_always_on_pm_domains</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">pd</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">pm_domain_always_on_gov</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">s3c64xx_pm_domains</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pm_genpd_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s3c64xx_pm_domains</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">pd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_get_platdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s3c_device_fb</span><span class="p">.</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">pm_genpd_add_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s3c64xx_pm_f</span><span class="p">.</span><span class="n">pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s3c_device_fb</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">int</span> <span class="nf">s3c64xx_pm_initcall</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pm_cpu_prep</span> <span class="o">=</span> <span class="n">s3c64xx_pm_prepare</span><span class="p">;</span>
	<span class="n">pm_cpu_sleep</span> <span class="o">=</span> <span class="n">s3c64xx_cpu_suspend</span><span class="p">;</span>
	<span class="n">pm_uart_udivslot</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_S3C_PM_DEBUG_LED_SMDK</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">S3C64XX_GPN</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span> <span class="s">&quot;DEBUG_LED0&quot;</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">S3C64XX_GPN</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span> <span class="s">&quot;DEBUG_LED1&quot;</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">S3C64XX_GPN</span><span class="p">(</span><span class="mi">14</span><span class="p">),</span> <span class="s">&quot;DEBUG_LED2&quot;</span><span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span><span class="n">S3C64XX_GPN</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span> <span class="s">&quot;DEBUG_LED3&quot;</span><span class="p">);</span>
	<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">S3C64XX_GPN</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">S3C64XX_GPN</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">S3C64XX_GPN</span><span class="p">(</span><span class="mi">14</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">S3C64XX_GPN</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">arch_initcall</span><span class="p">(</span><span class="n">s3c64xx_pm_initcall</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">s3c64xx_pm_late_initcall</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pm_genpd_poweroff_unused</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
