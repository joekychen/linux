<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › include › asm › tlbflush.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>tlbflush.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  arch/arm/include/asm/tlbflush.h</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 1999-2003 Russell King</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>
<span class="cp">#ifndef _ASMARM_TLBFLUSH_H</span>
<span class="cp">#define _ASMARM_TLBFLUSH_H</span>

<span class="cp">#ifdef CONFIG_MMU</span>

<span class="cp">#include &lt;asm/glue.h&gt;</span>

<span class="cp">#define TLB_V3_PAGE	(1 &lt;&lt; 0)</span>
<span class="cp">#define TLB_V4_U_PAGE	(1 &lt;&lt; 1)</span>
<span class="cp">#define TLB_V4_D_PAGE	(1 &lt;&lt; 2)</span>
<span class="cp">#define TLB_V4_I_PAGE	(1 &lt;&lt; 3)</span>
<span class="cp">#define TLB_V6_U_PAGE	(1 &lt;&lt; 4)</span>
<span class="cp">#define TLB_V6_D_PAGE	(1 &lt;&lt; 5)</span>
<span class="cp">#define TLB_V6_I_PAGE	(1 &lt;&lt; 6)</span>

<span class="cp">#define TLB_V3_FULL	(1 &lt;&lt; 8)</span>
<span class="cp">#define TLB_V4_U_FULL	(1 &lt;&lt; 9)</span>
<span class="cp">#define TLB_V4_D_FULL	(1 &lt;&lt; 10)</span>
<span class="cp">#define TLB_V4_I_FULL	(1 &lt;&lt; 11)</span>
<span class="cp">#define TLB_V6_U_FULL	(1 &lt;&lt; 12)</span>
<span class="cp">#define TLB_V6_D_FULL	(1 &lt;&lt; 13)</span>
<span class="cp">#define TLB_V6_I_FULL	(1 &lt;&lt; 14)</span>

<span class="cp">#define TLB_V6_U_ASID	(1 &lt;&lt; 16)</span>
<span class="cp">#define TLB_V6_D_ASID	(1 &lt;&lt; 17)</span>
<span class="cp">#define TLB_V6_I_ASID	(1 &lt;&lt; 18)</span>

<span class="cm">/* Unified Inner Shareable TLB operations (ARMv7 MP extensions) */</span>
<span class="cp">#define TLB_V7_UIS_PAGE	(1 &lt;&lt; 19)</span>
<span class="cp">#define TLB_V7_UIS_FULL (1 &lt;&lt; 20)</span>
<span class="cp">#define TLB_V7_UIS_ASID (1 &lt;&lt; 21)</span>

<span class="cp">#define TLB_BARRIER	(1 &lt;&lt; 28)</span>
<span class="cp">#define TLB_L2CLEAN_FR	(1 &lt;&lt; 29)		</span><span class="cm">/* Feroceon */</span><span class="cp"></span>
<span class="cp">#define TLB_DCLEAN	(1 &lt;&lt; 30)</span>
<span class="cp">#define TLB_WB		(1 &lt;&lt; 31)</span>

<span class="cm">/*</span>
<span class="cm"> *	MMU TLB Model</span>
<span class="cm"> *	=============</span>
<span class="cm"> *</span>
<span class="cm"> *	We have the following to choose from:</span>
<span class="cm"> *	  v3    - ARMv3</span>
<span class="cm"> *	  v4    - ARMv4 without write buffer</span>
<span class="cm"> *	  v4wb  - ARMv4 with write buffer without I TLB flush entry instruction</span>
<span class="cm"> *	  v4wbi - ARMv4 with write buffer with I TLB flush entry instruction</span>
<span class="cm"> *	  fr    - Feroceon (v4wbi with non-outer-cacheable page table walks)</span>
<span class="cm"> *	  fa    - Faraday (v4 with write buffer with UTLB)</span>
<span class="cm"> *	  v6wbi - ARMv6 with write buffer with I TLB flush entry instruction</span>
<span class="cm"> *	  v7wbi - identical to v6wbi</span>
<span class="cm"> */</span>
<span class="cp">#undef _TLB</span>
<span class="cp">#undef MULTI_TLB</span>

<span class="cp">#ifdef CONFIG_SMP_ON_UP</span>
<span class="cp">#define MULTI_TLB 1</span>
<span class="cp">#endif</span>

<span class="cp">#define v4_tlb_flags	(TLB_V4_U_FULL | TLB_V4_U_PAGE)</span>

<span class="cp">#ifdef CONFIG_CPU_TLB_V4WT</span>
<span class="cp"># define v4_possible_flags	v4_tlb_flags</span>
<span class="cp"># define v4_always_flags	v4_tlb_flags</span>
<span class="cp"># ifdef _TLB</span>
<span class="cp">#  define MULTI_TLB 1</span>
<span class="cp"># else</span>
<span class="cp">#  define _TLB v4</span>
<span class="cp"># endif</span>
<span class="cp">#else</span>
<span class="cp"># define v4_possible_flags	0</span>
<span class="cp"># define v4_always_flags	(-1UL)</span>
<span class="cp">#endif</span>

<span class="cp">#define fa_tlb_flags	(TLB_WB | TLB_DCLEAN | TLB_BARRIER | \</span>
<span class="cp">			 TLB_V4_U_FULL | TLB_V4_U_PAGE)</span>

<span class="cp">#ifdef CONFIG_CPU_TLB_FA</span>
<span class="cp"># define fa_possible_flags	fa_tlb_flags</span>
<span class="cp"># define fa_always_flags	fa_tlb_flags</span>
<span class="cp"># ifdef _TLB</span>
<span class="cp">#  define MULTI_TLB 1</span>
<span class="cp"># else</span>
<span class="cp">#  define _TLB fa</span>
<span class="cp"># endif</span>
<span class="cp">#else</span>
<span class="cp"># define fa_possible_flags	0</span>
<span class="cp"># define fa_always_flags	(-1UL)</span>
<span class="cp">#endif</span>

<span class="cp">#define v4wbi_tlb_flags	(TLB_WB | TLB_DCLEAN | \</span>
<span class="cp">			 TLB_V4_I_FULL | TLB_V4_D_FULL | \</span>
<span class="cp">			 TLB_V4_I_PAGE | TLB_V4_D_PAGE)</span>

<span class="cp">#ifdef CONFIG_CPU_TLB_V4WBI</span>
<span class="cp"># define v4wbi_possible_flags	v4wbi_tlb_flags</span>
<span class="cp"># define v4wbi_always_flags	v4wbi_tlb_flags</span>
<span class="cp"># ifdef _TLB</span>
<span class="cp">#  define MULTI_TLB 1</span>
<span class="cp"># else</span>
<span class="cp">#  define _TLB v4wbi</span>
<span class="cp"># endif</span>
<span class="cp">#else</span>
<span class="cp"># define v4wbi_possible_flags	0</span>
<span class="cp"># define v4wbi_always_flags	(-1UL)</span>
<span class="cp">#endif</span>

<span class="cp">#define fr_tlb_flags	(TLB_WB | TLB_DCLEAN | TLB_L2CLEAN_FR | \</span>
<span class="cp">			 TLB_V4_I_FULL | TLB_V4_D_FULL | \</span>
<span class="cp">			 TLB_V4_I_PAGE | TLB_V4_D_PAGE)</span>

<span class="cp">#ifdef CONFIG_CPU_TLB_FEROCEON</span>
<span class="cp"># define fr_possible_flags	fr_tlb_flags</span>
<span class="cp"># define fr_always_flags	fr_tlb_flags</span>
<span class="cp"># ifdef _TLB</span>
<span class="cp">#  define MULTI_TLB 1</span>
<span class="cp"># else</span>
<span class="cp">#  define _TLB v4wbi</span>
<span class="cp"># endif</span>
<span class="cp">#else</span>
<span class="cp"># define fr_possible_flags	0</span>
<span class="cp"># define fr_always_flags	(-1UL)</span>
<span class="cp">#endif</span>

<span class="cp">#define v4wb_tlb_flags	(TLB_WB | TLB_DCLEAN | \</span>
<span class="cp">			 TLB_V4_I_FULL | TLB_V4_D_FULL | \</span>
<span class="cp">			 TLB_V4_D_PAGE)</span>

<span class="cp">#ifdef CONFIG_CPU_TLB_V4WB</span>
<span class="cp"># define v4wb_possible_flags	v4wb_tlb_flags</span>
<span class="cp"># define v4wb_always_flags	v4wb_tlb_flags</span>
<span class="cp"># ifdef _TLB</span>
<span class="cp">#  define MULTI_TLB 1</span>
<span class="cp"># else</span>
<span class="cp">#  define _TLB v4wb</span>
<span class="cp"># endif</span>
<span class="cp">#else</span>
<span class="cp"># define v4wb_possible_flags	0</span>
<span class="cp"># define v4wb_always_flags	(-1UL)</span>
<span class="cp">#endif</span>

<span class="cp">#define v6wbi_tlb_flags (TLB_WB | TLB_DCLEAN | TLB_BARRIER | \</span>
<span class="cp">			 TLB_V6_I_FULL | TLB_V6_D_FULL | \</span>
<span class="cp">			 TLB_V6_I_PAGE | TLB_V6_D_PAGE | \</span>
<span class="cp">			 TLB_V6_I_ASID | TLB_V6_D_ASID)</span>

<span class="cp">#ifdef CONFIG_CPU_TLB_V6</span>
<span class="cp"># define v6wbi_possible_flags	v6wbi_tlb_flags</span>
<span class="cp"># define v6wbi_always_flags	v6wbi_tlb_flags</span>
<span class="cp"># ifdef _TLB</span>
<span class="cp">#  define MULTI_TLB 1</span>
<span class="cp"># else</span>
<span class="cp">#  define _TLB v6wbi</span>
<span class="cp"># endif</span>
<span class="cp">#else</span>
<span class="cp"># define v6wbi_possible_flags	0</span>
<span class="cp"># define v6wbi_always_flags	(-1UL)</span>
<span class="cp">#endif</span>

<span class="cp">#define v7wbi_tlb_flags_smp	(TLB_WB | TLB_DCLEAN | TLB_BARRIER | \</span>
<span class="cp">			 TLB_V7_UIS_FULL | TLB_V7_UIS_PAGE | TLB_V7_UIS_ASID)</span>
<span class="cp">#define v7wbi_tlb_flags_up	(TLB_WB | TLB_DCLEAN | TLB_BARRIER | \</span>
<span class="cp">			 TLB_V6_U_FULL | TLB_V6_U_PAGE | TLB_V6_U_ASID)</span>

<span class="cp">#ifdef CONFIG_CPU_TLB_V7</span>

<span class="cp"># ifdef CONFIG_SMP_ON_UP</span>
<span class="cp">#  define v7wbi_possible_flags	(v7wbi_tlb_flags_smp | v7wbi_tlb_flags_up)</span>
<span class="cp">#  define v7wbi_always_flags	(v7wbi_tlb_flags_smp &amp; v7wbi_tlb_flags_up)</span>
<span class="cp"># elif defined(CONFIG_SMP)</span>
<span class="cp">#  define v7wbi_possible_flags	v7wbi_tlb_flags_smp</span>
<span class="cp">#  define v7wbi_always_flags	v7wbi_tlb_flags_smp</span>
<span class="cp"># else</span>
<span class="cp">#  define v7wbi_possible_flags	v7wbi_tlb_flags_up</span>
<span class="cp">#  define v7wbi_always_flags	v7wbi_tlb_flags_up</span>
<span class="cp"># endif</span>
<span class="cp"># ifdef _TLB</span>
<span class="cp">#  define MULTI_TLB 1</span>
<span class="cp"># else</span>
<span class="cp">#  define _TLB v7wbi</span>
<span class="cp"># endif</span>
<span class="cp">#else</span>
<span class="cp"># define v7wbi_possible_flags	0</span>
<span class="cp"># define v7wbi_always_flags	(-1UL)</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef _TLB</span>
<span class="cp">#error Unknown TLB model</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef __ASSEMBLY__</span>

<span class="cp">#include &lt;linux/sched.h&gt;</span>

<span class="k">struct</span> <span class="n">cpu_tlb_fns</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">flush_user_range</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">flush_kern_range</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tlb_flags</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Select the calling method</span>
<span class="cm"> */</span>
<span class="cp">#ifdef MULTI_TLB</span>

<span class="cp">#define __cpu_flush_user_tlb_range	cpu_tlb.flush_user_range</span>
<span class="cp">#define __cpu_flush_kern_tlb_range	cpu_tlb.flush_kern_range</span>

<span class="cp">#else</span>

<span class="cp">#define __cpu_flush_user_tlb_range	__glue(_TLB,_flush_user_tlb_range)</span>
<span class="cp">#define __cpu_flush_kern_tlb_range	__glue(_TLB,_flush_kern_tlb_range)</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">__cpu_flush_user_tlb_range</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">__cpu_flush_kern_tlb_range</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>

<span class="cp">#endif</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">cpu_tlb_fns</span> <span class="n">cpu_tlb</span><span class="p">;</span>

<span class="cp">#define __cpu_tlb_flags			cpu_tlb.tlb_flags</span>

<span class="cm">/*</span>
<span class="cm"> *	TLB Management</span>
<span class="cm"> *	==============</span>
<span class="cm"> *</span>
<span class="cm"> *	The arch/arm/mm/tlb-*.S files implement these methods.</span>
<span class="cm"> *</span>
<span class="cm"> *	The TLB specific code is expected to perform whatever tests it</span>
<span class="cm"> *	needs to determine if it should invalidate the TLB for each</span>
<span class="cm"> *	call.  Start addresses are inclusive and end addresses are</span>
<span class="cm"> *	exclusive; it is safe to round these addresses down.</span>
<span class="cm"> *</span>
<span class="cm"> *	flush_tlb_all()</span>
<span class="cm"> *</span>
<span class="cm"> *		Invalidate the entire TLB.</span>
<span class="cm"> *</span>
<span class="cm"> *	flush_tlb_mm(mm)</span>
<span class="cm"> *</span>
<span class="cm"> *		Invalidate all TLB entries in a particular address</span>
<span class="cm"> *		space.</span>
<span class="cm"> *		- mm	- mm_struct describing address space</span>
<span class="cm"> *</span>
<span class="cm"> *	flush_tlb_range(mm,start,end)</span>
<span class="cm"> *</span>
<span class="cm"> *		Invalidate a range of TLB entries in the specified</span>
<span class="cm"> *		address space.</span>
<span class="cm"> *		- mm	- mm_struct describing address space</span>
<span class="cm"> *		- start - start address (may not be aligned)</span>
<span class="cm"> *		- end	- end address (exclusive, may not be aligned)</span>
<span class="cm"> *</span>
<span class="cm"> *	flush_tlb_page(vaddr,vma)</span>
<span class="cm"> *</span>
<span class="cm"> *		Invalidate the specified page in the specified address range.</span>
<span class="cm"> *		- vaddr - virtual address (may not be aligned)</span>
<span class="cm"> *		- vma	- vma_struct describing address range</span>
<span class="cm"> *</span>
<span class="cm"> *	flush_kern_tlb_page(kaddr)</span>
<span class="cm"> *</span>
<span class="cm"> *		Invalidate the TLB entry for the specified page.  The address</span>
<span class="cm"> *		will be in the kernels virtual memory space.  Current uses</span>
<span class="cm"> *		only require the D-TLB to be invalidated.</span>
<span class="cm"> *		- kaddr - Kernel virtual memory address</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * We optimise the code below by:</span>
<span class="cm"> *  - building a set of TLB flags that might be set in __cpu_tlb_flags</span>
<span class="cm"> *  - building a set of TLB flags that will always be set in __cpu_tlb_flags</span>
<span class="cm"> *  - if we&#39;re going to need __cpu_tlb_flags, access it once and only once</span>
<span class="cm"> *</span>
<span class="cm"> * This allows us to build optimal assembly for the single-CPU type case,</span>
<span class="cm"> * and as close to optimal given the compiler constrants for multi-CPU</span>
<span class="cm"> * case.  We could do better for the multi-CPU case if the compiler</span>
<span class="cm"> * implemented the &quot;%?&quot; method, but this has been discontinued due to too</span>
<span class="cm"> * many people getting it wrong.</span>
<span class="cm"> */</span>
<span class="cp">#define possible_tlb_flags	(v4_possible_flags | \</span>
<span class="cp">				 v4wbi_possible_flags | \</span>
<span class="cp">				 fr_possible_flags | \</span>
<span class="cp">				 v4wb_possible_flags | \</span>
<span class="cp">				 fa_possible_flags | \</span>
<span class="cp">				 v6wbi_possible_flags | \</span>
<span class="cp">				 v7wbi_possible_flags)</span>

<span class="cp">#define always_tlb_flags	(v4_always_flags &amp; \</span>
<span class="cp">				 v4wbi_always_flags &amp; \</span>
<span class="cp">				 fr_always_flags &amp; \</span>
<span class="cp">				 v4wb_always_flags &amp; \</span>
<span class="cp">				 fa_always_flags &amp; \</span>
<span class="cp">				 v6wbi_always_flags &amp; \</span>
<span class="cp">				 v7wbi_always_flags)</span>

<span class="cp">#define tlb_flag(f)	((always_tlb_flags &amp; (f)) || (__tlb_flag &amp; possible_tlb_flags &amp; (f)))</span>

<span class="cp">#define __tlb_op(f, insnarg, arg)					\</span>
<span class="cp">	do {								\</span>
<span class="cp">		if (always_tlb_flags &amp; (f))				\</span>
<span class="cp">			asm(&quot;mcr &quot; insnarg				\</span>
<span class="cp">			    : : &quot;r&quot; (arg) : &quot;cc&quot;);			\</span>
<span class="cp">		else if (possible_tlb_flags &amp; (f))			\</span>
<span class="cp">			asm(&quot;tst %1, %2\n\t&quot;				\</span>
<span class="cp">			    &quot;mcrne &quot; insnarg				\</span>
<span class="cp">			    : : &quot;r&quot; (arg), &quot;r&quot; (__tlb_flag), &quot;Ir&quot; (f)	\</span>
<span class="cp">			    : &quot;cc&quot;);					\</span>
<span class="cp">	} while (0)</span>

<span class="cp">#define tlb_op(f, regs, arg)	__tlb_op(f, &quot;p15, 0, %0, &quot; regs, arg)</span>
<span class="cp">#define tlb_l2_op(f, regs, arg)	__tlb_op(f, &quot;p15, 1, %0, &quot; regs, arg)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">local_flush_tlb_all</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">zero</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__tlb_flag</span> <span class="o">=</span> <span class="n">__cpu_tlb_flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tlb_flag</span><span class="p">(</span><span class="n">TLB_WB</span><span class="p">))</span>
		<span class="n">dsb</span><span class="p">();</span>

	<span class="n">tlb_op</span><span class="p">(</span><span class="n">TLB_V3_FULL</span><span class="p">,</span> <span class="s">&quot;c6, c0, 0&quot;</span><span class="p">,</span> <span class="n">zero</span><span class="p">);</span>
	<span class="n">tlb_op</span><span class="p">(</span><span class="n">TLB_V4_U_FULL</span> <span class="o">|</span> <span class="n">TLB_V6_U_FULL</span><span class="p">,</span> <span class="s">&quot;c8, c7, 0&quot;</span><span class="p">,</span> <span class="n">zero</span><span class="p">);</span>
	<span class="n">tlb_op</span><span class="p">(</span><span class="n">TLB_V4_D_FULL</span> <span class="o">|</span> <span class="n">TLB_V6_D_FULL</span><span class="p">,</span> <span class="s">&quot;c8, c6, 0&quot;</span><span class="p">,</span> <span class="n">zero</span><span class="p">);</span>
	<span class="n">tlb_op</span><span class="p">(</span><span class="n">TLB_V4_I_FULL</span> <span class="o">|</span> <span class="n">TLB_V6_I_FULL</span><span class="p">,</span> <span class="s">&quot;c8, c5, 0&quot;</span><span class="p">,</span> <span class="n">zero</span><span class="p">);</span>
	<span class="n">tlb_op</span><span class="p">(</span><span class="n">TLB_V7_UIS_FULL</span><span class="p">,</span> <span class="s">&quot;c8, c3, 0&quot;</span><span class="p">,</span> <span class="n">zero</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tlb_flag</span><span class="p">(</span><span class="n">TLB_BARRIER</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dsb</span><span class="p">();</span>
		<span class="n">isb</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">local_flush_tlb_mm</span><span class="p">(</span><span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">zero</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">asid</span> <span class="o">=</span> <span class="n">ASID</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__tlb_flag</span> <span class="o">=</span> <span class="n">__cpu_tlb_flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tlb_flag</span><span class="p">(</span><span class="n">TLB_WB</span><span class="p">))</span>
		<span class="n">dsb</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">possible_tlb_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TLB_V3_FULL</span><span class="o">|</span><span class="n">TLB_V4_U_FULL</span><span class="o">|</span><span class="n">TLB_V4_D_FULL</span><span class="o">|</span><span class="n">TLB_V4_I_FULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpumask_test_cpu</span><span class="p">(</span><span class="n">get_cpu</span><span class="p">(),</span> <span class="n">mm_cpumask</span><span class="p">(</span><span class="n">mm</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">tlb_op</span><span class="p">(</span><span class="n">TLB_V3_FULL</span><span class="p">,</span> <span class="s">&quot;c6, c0, 0&quot;</span><span class="p">,</span> <span class="n">zero</span><span class="p">);</span>
			<span class="n">tlb_op</span><span class="p">(</span><span class="n">TLB_V4_U_FULL</span><span class="p">,</span> <span class="s">&quot;c8, c7, 0&quot;</span><span class="p">,</span> <span class="n">zero</span><span class="p">);</span>
			<span class="n">tlb_op</span><span class="p">(</span><span class="n">TLB_V4_D_FULL</span><span class="p">,</span> <span class="s">&quot;c8, c6, 0&quot;</span><span class="p">,</span> <span class="n">zero</span><span class="p">);</span>
			<span class="n">tlb_op</span><span class="p">(</span><span class="n">TLB_V4_I_FULL</span><span class="p">,</span> <span class="s">&quot;c8, c5, 0&quot;</span><span class="p">,</span> <span class="n">zero</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">put_cpu</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">tlb_op</span><span class="p">(</span><span class="n">TLB_V6_U_ASID</span><span class="p">,</span> <span class="s">&quot;c8, c7, 2&quot;</span><span class="p">,</span> <span class="n">asid</span><span class="p">);</span>
	<span class="n">tlb_op</span><span class="p">(</span><span class="n">TLB_V6_D_ASID</span><span class="p">,</span> <span class="s">&quot;c8, c6, 2&quot;</span><span class="p">,</span> <span class="n">asid</span><span class="p">);</span>
	<span class="n">tlb_op</span><span class="p">(</span><span class="n">TLB_V6_I_ASID</span><span class="p">,</span> <span class="s">&quot;c8, c5, 2&quot;</span><span class="p">,</span> <span class="n">asid</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ARM_ERRATA_720789</span>
	<span class="n">tlb_op</span><span class="p">(</span><span class="n">TLB_V7_UIS_ASID</span><span class="p">,</span> <span class="s">&quot;c8, c3, 0&quot;</span><span class="p">,</span> <span class="n">zero</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">tlb_op</span><span class="p">(</span><span class="n">TLB_V7_UIS_ASID</span><span class="p">,</span> <span class="s">&quot;c8, c3, 2&quot;</span><span class="p">,</span> <span class="n">asid</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tlb_flag</span><span class="p">(</span><span class="n">TLB_BARRIER</span><span class="p">))</span>
		<span class="n">dsb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">local_flush_tlb_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">uaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">zero</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__tlb_flag</span> <span class="o">=</span> <span class="n">__cpu_tlb_flags</span><span class="p">;</span>

	<span class="n">uaddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">uaddr</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">ASID</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_mm</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tlb_flag</span><span class="p">(</span><span class="n">TLB_WB</span><span class="p">))</span>
		<span class="n">dsb</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">possible_tlb_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TLB_V3_PAGE</span><span class="o">|</span><span class="n">TLB_V4_U_PAGE</span><span class="o">|</span><span class="n">TLB_V4_D_PAGE</span><span class="o">|</span><span class="n">TLB_V4_I_PAGE</span><span class="o">|</span><span class="n">TLB_V4_I_FULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cpumask_test_cpu</span><span class="p">(</span><span class="n">smp_processor_id</span><span class="p">(),</span> <span class="n">mm_cpumask</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_mm</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">tlb_op</span><span class="p">(</span><span class="n">TLB_V3_PAGE</span><span class="p">,</span> <span class="s">&quot;c6, c0, 0&quot;</span><span class="p">,</span> <span class="n">uaddr</span><span class="p">);</span>
		<span class="n">tlb_op</span><span class="p">(</span><span class="n">TLB_V4_U_PAGE</span><span class="p">,</span> <span class="s">&quot;c8, c7, 1&quot;</span><span class="p">,</span> <span class="n">uaddr</span><span class="p">);</span>
		<span class="n">tlb_op</span><span class="p">(</span><span class="n">TLB_V4_D_PAGE</span><span class="p">,</span> <span class="s">&quot;c8, c6, 1&quot;</span><span class="p">,</span> <span class="n">uaddr</span><span class="p">);</span>
		<span class="n">tlb_op</span><span class="p">(</span><span class="n">TLB_V4_I_PAGE</span><span class="p">,</span> <span class="s">&quot;c8, c5, 1&quot;</span><span class="p">,</span> <span class="n">uaddr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tlb_flag</span><span class="p">(</span><span class="n">TLB_V4_I_PAGE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">tlb_flag</span><span class="p">(</span><span class="n">TLB_V4_I_FULL</span><span class="p">))</span>
			<span class="n">asm</span><span class="p">(</span><span class="s">&quot;mcr p15, 0, %0, c8, c5, 0&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">zero</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;cc&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tlb_op</span><span class="p">(</span><span class="n">TLB_V6_U_PAGE</span><span class="p">,</span> <span class="s">&quot;c8, c7, 1&quot;</span><span class="p">,</span> <span class="n">uaddr</span><span class="p">);</span>
	<span class="n">tlb_op</span><span class="p">(</span><span class="n">TLB_V6_D_PAGE</span><span class="p">,</span> <span class="s">&quot;c8, c6, 1&quot;</span><span class="p">,</span> <span class="n">uaddr</span><span class="p">);</span>
	<span class="n">tlb_op</span><span class="p">(</span><span class="n">TLB_V6_I_PAGE</span><span class="p">,</span> <span class="s">&quot;c8, c5, 1&quot;</span><span class="p">,</span> <span class="n">uaddr</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ARM_ERRATA_720789</span>
	<span class="n">tlb_op</span><span class="p">(</span><span class="n">TLB_V7_UIS_PAGE</span><span class="p">,</span> <span class="s">&quot;c8, c3, 3&quot;</span><span class="p">,</span> <span class="n">uaddr</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">tlb_op</span><span class="p">(</span><span class="n">TLB_V7_UIS_PAGE</span><span class="p">,</span> <span class="s">&quot;c8, c3, 1&quot;</span><span class="p">,</span> <span class="n">uaddr</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tlb_flag</span><span class="p">(</span><span class="n">TLB_BARRIER</span><span class="p">))</span>
		<span class="n">dsb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">local_flush_tlb_kernel_page</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">kaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">zero</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__tlb_flag</span> <span class="o">=</span> <span class="n">__cpu_tlb_flags</span><span class="p">;</span>

	<span class="n">kaddr</span> <span class="o">&amp;=</span> <span class="n">PAGE_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tlb_flag</span><span class="p">(</span><span class="n">TLB_WB</span><span class="p">))</span>
		<span class="n">dsb</span><span class="p">();</span>

	<span class="n">tlb_op</span><span class="p">(</span><span class="n">TLB_V3_PAGE</span><span class="p">,</span> <span class="s">&quot;c6, c0, 0&quot;</span><span class="p">,</span> <span class="n">kaddr</span><span class="p">);</span>
	<span class="n">tlb_op</span><span class="p">(</span><span class="n">TLB_V4_U_PAGE</span><span class="p">,</span> <span class="s">&quot;c8, c7, 1&quot;</span><span class="p">,</span> <span class="n">kaddr</span><span class="p">);</span>
	<span class="n">tlb_op</span><span class="p">(</span><span class="n">TLB_V4_D_PAGE</span><span class="p">,</span> <span class="s">&quot;c8, c6, 1&quot;</span><span class="p">,</span> <span class="n">kaddr</span><span class="p">);</span>
	<span class="n">tlb_op</span><span class="p">(</span><span class="n">TLB_V4_I_PAGE</span><span class="p">,</span> <span class="s">&quot;c8, c5, 1&quot;</span><span class="p">,</span> <span class="n">kaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tlb_flag</span><span class="p">(</span><span class="n">TLB_V4_I_PAGE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">tlb_flag</span><span class="p">(</span><span class="n">TLB_V4_I_FULL</span><span class="p">))</span>
		<span class="n">asm</span><span class="p">(</span><span class="s">&quot;mcr p15, 0, %0, c8, c5, 0&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">zero</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;cc&quot;</span><span class="p">);</span>

	<span class="n">tlb_op</span><span class="p">(</span><span class="n">TLB_V6_U_PAGE</span><span class="p">,</span> <span class="s">&quot;c8, c7, 1&quot;</span><span class="p">,</span> <span class="n">kaddr</span><span class="p">);</span>
	<span class="n">tlb_op</span><span class="p">(</span><span class="n">TLB_V6_D_PAGE</span><span class="p">,</span> <span class="s">&quot;c8, c6, 1&quot;</span><span class="p">,</span> <span class="n">kaddr</span><span class="p">);</span>
	<span class="n">tlb_op</span><span class="p">(</span><span class="n">TLB_V6_I_PAGE</span><span class="p">,</span> <span class="s">&quot;c8, c5, 1&quot;</span><span class="p">,</span> <span class="n">kaddr</span><span class="p">);</span>
	<span class="n">tlb_op</span><span class="p">(</span><span class="n">TLB_V7_UIS_PAGE</span><span class="p">,</span> <span class="s">&quot;c8, c3, 1&quot;</span><span class="p">,</span> <span class="n">kaddr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tlb_flag</span><span class="p">(</span><span class="n">TLB_BARRIER</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dsb</span><span class="p">();</span>
		<span class="n">isb</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	flush_pmd_entry</span>
<span class="cm"> *</span>
<span class="cm"> *	Flush a PMD entry (word aligned, or double-word aligned) to</span>
<span class="cm"> *	RAM if the TLB for the CPU we are running on requires this.</span>
<span class="cm"> *	This is typically used when we are creating PMD entries.</span>
<span class="cm"> *</span>
<span class="cm"> *	clean_pmd_entry</span>
<span class="cm"> *</span>
<span class="cm"> *	Clean (but don&#39;t drain the write buffer) if the CPU requires</span>
<span class="cm"> *	these operations.  This is typically used when we are removing</span>
<span class="cm"> *	PMD entries.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">flush_pmd_entry</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">pmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__tlb_flag</span> <span class="o">=</span> <span class="n">__cpu_tlb_flags</span><span class="p">;</span>

	<span class="n">tlb_op</span><span class="p">(</span><span class="n">TLB_DCLEAN</span><span class="p">,</span> <span class="s">&quot;c7, c10, 1	@ flush_pmd&quot;</span><span class="p">,</span> <span class="n">pmd</span><span class="p">);</span>
	<span class="n">tlb_l2_op</span><span class="p">(</span><span class="n">TLB_L2CLEAN_FR</span><span class="p">,</span> <span class="s">&quot;c15, c9, 1  @ L2 flush_pmd&quot;</span><span class="p">,</span> <span class="n">pmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tlb_flag</span><span class="p">(</span><span class="n">TLB_WB</span><span class="p">))</span>
		<span class="n">dsb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">clean_pmd_entry</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">pmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__tlb_flag</span> <span class="o">=</span> <span class="n">__cpu_tlb_flags</span><span class="p">;</span>

	<span class="n">tlb_op</span><span class="p">(</span><span class="n">TLB_DCLEAN</span><span class="p">,</span> <span class="s">&quot;c7, c10, 1	@ flush_pmd&quot;</span><span class="p">,</span> <span class="n">pmd</span><span class="p">);</span>
	<span class="n">tlb_l2_op</span><span class="p">(</span><span class="n">TLB_L2CLEAN_FR</span><span class="p">,</span> <span class="s">&quot;c15, c9, 1  @ L2 flush_pmd&quot;</span><span class="p">,</span> <span class="n">pmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#undef tlb_op</span>
<span class="cp">#undef tlb_flag</span>
<span class="cp">#undef always_tlb_flags</span>
<span class="cp">#undef possible_tlb_flags</span>

<span class="cm">/*</span>
<span class="cm"> * Convert calls to our calling convention.</span>
<span class="cm"> */</span>
<span class="cp">#define local_flush_tlb_range(vma,start,end)	__cpu_flush_user_tlb_range(start,end,vma)</span>
<span class="cp">#define local_flush_tlb_kernel_range(s,e)	__cpu_flush_kern_tlb_range(s,e)</span>

<span class="cp">#ifndef CONFIG_SMP</span>
<span class="cp">#define flush_tlb_all		local_flush_tlb_all</span>
<span class="cp">#define flush_tlb_mm		local_flush_tlb_mm</span>
<span class="cp">#define flush_tlb_page		local_flush_tlb_page</span>
<span class="cp">#define flush_tlb_kernel_page	local_flush_tlb_kernel_page</span>
<span class="cp">#define flush_tlb_range		local_flush_tlb_range</span>
<span class="cp">#define flush_tlb_kernel_range	local_flush_tlb_kernel_range</span>
<span class="cp">#else</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">flush_tlb_all</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">flush_tlb_mm</span><span class="p">(</span><span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">flush_tlb_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">uaddr</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">flush_tlb_kernel_page</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">kaddr</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">flush_tlb_range</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">flush_tlb_kernel_range</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * If PG_dcache_clean is not set for the page, we need to ensure that any</span>
<span class="cm"> * cache entries for the kernels virtual memory range are written</span>
<span class="cm"> * back to the page. On ARMv6 and later, the cache coherency is handled via</span>
<span class="cm"> * the set_pte_at() function.</span>
<span class="cm"> */</span>
<span class="cp">#if __LINUX_ARM_ARCH__ &lt; 6</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">update_mmu_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span>
	<span class="n">pte_t</span> <span class="o">*</span><span class="n">ptep</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">update_mmu_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="n">pte_t</span> <span class="o">*</span><span class="n">ptep</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#endif</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_MMU */</span><span class="cp"></span>

<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
