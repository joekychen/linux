<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › mach-at91 › at91sam9260_devices.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>at91sam9260_devices.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * arch/arm/mach-at91/at91sam9260_devices.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2006 Atmel</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;asm/mach/arch.h&gt;</span>
<span class="cp">#include &lt;asm/mach/map.h&gt;</span>

<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/i2c-gpio.h&gt;</span>

<span class="cp">#include &lt;linux/platform_data/at91_adc.h&gt;</span>

<span class="cp">#include &lt;mach/board.h&gt;</span>
<span class="cp">#include &lt;mach/cpu.h&gt;</span>
<span class="cp">#include &lt;mach/at91sam9260.h&gt;</span>
<span class="cp">#include &lt;mach/at91sam9260_matrix.h&gt;</span>
<span class="cp">#include &lt;mach/at91_matrix.h&gt;</span>
<span class="cp">#include &lt;mach/at91sam9_smc.h&gt;</span>
<span class="cp">#include &lt;mach/at91_adc.h&gt;</span>

<span class="cp">#include &quot;generic.h&quot;</span>


<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  USB Host</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>

<span class="cp">#if defined(CONFIG_USB_OHCI_HCD) || defined(CONFIG_USB_OHCI_HCD_MODULE)</span>
<span class="k">static</span> <span class="n">u64</span> <span class="n">ohci_dmamask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">at91_usbh_data</span> <span class="n">usbh_data</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">usbh_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_UHP_BASE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_UHP_BASE</span> <span class="o">+</span> <span class="n">SZ_1M</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_UHP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_UHP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91_usbh_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;at91_ohci&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">dma_mask</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ohci_dmamask</span><span class="p">,</span>
				<span class="p">.</span><span class="n">coherent_dma_mask</span>	<span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
				<span class="p">.</span><span class="n">platform_data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">usbh_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">usbh_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">usbh_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_usbh</span><span class="p">(</span><span class="k">struct</span> <span class="n">at91_usbh_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Enable overcurrent notification */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">overcurrent_pin</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">at91_set_gpio_input</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">overcurrent_pin</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">usbh_data</span> <span class="o">=</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at91_usbh_device</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_usbh</span><span class="p">(</span><span class="k">struct</span> <span class="n">at91_usbh_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>


<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  USB Device (Gadget)</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>

<span class="cp">#if defined(CONFIG_USB_AT91) || defined(CONFIG_USB_AT91_MODULE)</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">at91_udc_data</span> <span class="n">udc_data</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">udc_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_UDP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_UDP</span> <span class="o">+</span> <span class="n">SZ_16K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_UDP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_UDP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91_udc_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;at91_udc&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">platform_data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">udc_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">udc_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">udc_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_udc</span><span class="p">(</span><span class="k">struct</span> <span class="n">at91_udc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vbus_pin</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">at91_set_gpio_input</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vbus_pin</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">at91_set_deglitch</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vbus_pin</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Pullup pin is handled internally by USB device peripheral */</span>

	<span class="n">udc_data</span> <span class="o">=</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at91_udc_device</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_udc</span><span class="p">(</span><span class="k">struct</span> <span class="n">at91_udc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>


<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  Ethernet</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>

<span class="cp">#if defined(CONFIG_MACB) || defined(CONFIG_MACB_MODULE)</span>
<span class="k">static</span> <span class="n">u64</span> <span class="n">eth_dmamask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">macb_platform_data</span> <span class="n">eth_data</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">eth_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_EMAC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_EMAC</span> <span class="o">+</span> <span class="n">SZ_16K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_EMAC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_EMAC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9260_eth_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;macb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">dma_mask</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">eth_dmamask</span><span class="p">,</span>
				<span class="p">.</span><span class="n">coherent_dma_mask</span>	<span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
				<span class="p">.</span><span class="n">platform_data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">eth_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">eth_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">eth_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_eth</span><span class="p">(</span><span class="k">struct</span> <span class="n">macb_platform_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">phy_irq_pin</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">at91_set_gpio_input</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">phy_irq_pin</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">at91_set_deglitch</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">phy_irq_pin</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Pins used for MII and RMII */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA19</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* ETXCK_EREFCK */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA17</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* ERXDV */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA14</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* ERX0 */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA15</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* ERX1 */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA18</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* ERXER */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA16</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* ETXEN */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA12</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* ETX0 */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA13</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* ETX1 */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA21</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* EMDIO */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA20</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* EMDC */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">is_rmii</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA28</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* ECRS */</span>
		<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA29</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* ECOL */</span>
		<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA25</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* ERX2 */</span>
		<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA26</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* ERX3 */</span>
		<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA27</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* ERXCK */</span>
		<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA23</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* ETX2 */</span>
		<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA24</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* ETX3 */</span>
		<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA22</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* ETXER */</span>
	<span class="p">}</span>

	<span class="n">eth_data</span> <span class="o">=</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at91sam9260_eth_device</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_eth</span><span class="p">(</span><span class="k">struct</span> <span class="n">macb_platform_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>


<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  MMC / SD</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>

<span class="cp">#if defined(CONFIG_MMC_AT91) || defined(CONFIG_MMC_AT91_MODULE)</span>
<span class="k">static</span> <span class="n">u64</span> <span class="n">mmc_dmamask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">at91_mmc_data</span> <span class="n">mmc_data</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">mmc_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_MCI</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_MCI</span> <span class="o">+</span> <span class="n">SZ_16K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_MCI</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_MCI</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9260_mmc_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;at91_mci&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">dma_mask</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">mmc_dmamask</span><span class="p">,</span>
				<span class="p">.</span><span class="n">coherent_dma_mask</span>	<span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
				<span class="p">.</span><span class="n">platform_data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">mmc_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">mmc_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mmc_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_mmc</span><span class="p">(</span><span class="kt">short</span> <span class="n">mmc_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">at91_mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* input/irq */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">det_pin</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">at91_set_gpio_input</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">det_pin</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">at91_set_deglitch</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">det_pin</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">wp_pin</span><span class="p">))</span>
		<span class="n">at91_set_gpio_input</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">wp_pin</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vcc_pin</span><span class="p">))</span>
		<span class="n">at91_set_gpio_output</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vcc_pin</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* CLK */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">slot_b</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* CMD */</span>
		<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* DAT0, maybe DAT1..DAT3 */</span>
		<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">wire4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA5</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA3</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* CMD */</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA7</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* DAT0, maybe DAT1..DAT3 */</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA6</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">wire4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA9</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA10</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA11</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mmc_data</span> <span class="o">=</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at91sam9260_mmc_device</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_mmc</span><span class="p">(</span><span class="kt">short</span> <span class="n">mmc_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">at91_mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>

<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  MMC / SD Slot for Atmel MCI Driver</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>

<span class="cp">#if defined(CONFIG_MMC_ATMELMCI) || defined(CONFIG_MMC_ATMELMCI_MODULE)</span>
<span class="k">static</span> <span class="n">u64</span> <span class="n">mmc_dmamask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mci_platform_data</span> <span class="n">mmc_data</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">mmc_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_MCI</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_MCI</span> <span class="o">+</span> <span class="n">SZ_16K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_MCI</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_MCI</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9260_mmc_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;atmel_mci&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">dma_mask</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">mmc_dmamask</span><span class="p">,</span>
				<span class="p">.</span><span class="n">coherent_dma_mask</span>	<span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
				<span class="p">.</span><span class="n">platform_data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">mmc_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">mmc_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mmc_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_mci</span><span class="p">(</span><span class="kt">short</span> <span class="n">mmc_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mci_platform_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">slot_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATMCI_MAX_NR_SLOTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bus_width</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* input/irq */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">detect_pin</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">at91_set_gpio_input</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">detect_pin</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">at91_set_deglitch</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">detect_pin</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">wp_pin</span><span class="p">))</span>
				<span class="n">at91_set_gpio_input</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">wp_pin</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="cm">/* CMD */</span>
				<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA7</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="cm">/* DAT0, maybe DAT1..DAT3 */</span>
				<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA6</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bus_width</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA9</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
					<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA10</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
					<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA11</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">slot_count</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="cm">/* CMD */</span>
				<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="cm">/* DAT0, maybe DAT1..DAT3 */</span>
				<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bus_width</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA5</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
					<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
					<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA3</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">slot_count</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
					<span class="s">&quot;AT91: SD/MMC slot %d not available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* CLK */</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">mmc_data</span> <span class="o">=</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
		<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at91sam9260_mmc_device</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_mci</span><span class="p">(</span><span class="kt">short</span> <span class="n">mmc_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mci_platform_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>


<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  NAND / SmartMedia</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>

<span class="cp">#if defined(CONFIG_MTD_NAND_ATMEL) || defined(CONFIG_MTD_NAND_ATMEL_MODULE)</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">atmel_nand_data</span> <span class="n">nand_data</span><span class="p">;</span>

<span class="cp">#define NAND_BASE	AT91_CHIPSELECT_3</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">nand_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">NAND_BASE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">NAND_BASE</span> <span class="o">+</span> <span class="n">SZ_256M</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_ECC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_ECC</span> <span class="o">+</span> <span class="n">SZ_512</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9260_nand_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;atmel_nand&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">nand_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">nand_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">nand_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_nand</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_nand_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">csa</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">csa</span> <span class="o">=</span> <span class="n">at91_matrix_read</span><span class="p">(</span><span class="n">AT91_MATRIX_EBICSA</span><span class="p">);</span>
	<span class="n">at91_matrix_write</span><span class="p">(</span><span class="n">AT91_MATRIX_EBICSA</span><span class="p">,</span> <span class="n">csa</span> <span class="o">|</span> <span class="n">AT91_MATRIX_CS3A_SMC_SMARTMEDIA</span><span class="p">);</span>

	<span class="cm">/* enable pin */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">enable_pin</span><span class="p">))</span>
		<span class="n">at91_set_gpio_output</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">enable_pin</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* ready/busy pin */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rdy_pin</span><span class="p">))</span>
		<span class="n">at91_set_gpio_input</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rdy_pin</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* card detect pin */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">det_pin</span><span class="p">))</span>
		<span class="n">at91_set_gpio_input</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">det_pin</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">nand_data</span> <span class="o">=</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at91sam9260_nand_device</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_nand</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_nand_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>


<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  TWI (i2c)</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>

<span class="cm">/*</span>
<span class="cm"> * Prefer the GPIO code since the TWI controller isn&#39;t robust</span>
<span class="cm"> * (gets overruns and underruns under load) and can only issue</span>
<span class="cm"> * repeated STARTs in one scenario (the driver doesn&#39;t yet handle them).</span>
<span class="cm"> */</span>

<span class="cp">#if defined(CONFIG_I2C_GPIO) || defined(CONFIG_I2C_GPIO_MODULE)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_gpio_platform_data</span> <span class="n">pdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">sda_pin</span>		<span class="o">=</span> <span class="n">AT91_PIN_PA23</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sda_is_open_drain</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">scl_pin</span>		<span class="o">=</span> <span class="n">AT91_PIN_PA24</span><span class="p">,</span>
	<span class="p">.</span><span class="n">scl_is_open_drain</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udelay</span>			<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>		<span class="cm">/* ~100 kHz */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9260_twi_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;i2c-gpio&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>			<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">pdata</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_i2c</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="o">*</span><span class="n">devices</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_devices</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">at91_set_GPIO_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA23</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>		<span class="cm">/* TWD (SDA) */</span>
	<span class="n">at91_set_multi_drive</span><span class="p">(</span><span class="n">AT91_PIN_PA23</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">at91_set_GPIO_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA24</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>		<span class="cm">/* TWCK (SCL) */</span>
	<span class="n">at91_set_multi_drive</span><span class="p">(</span><span class="n">AT91_PIN_PA24</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">i2c_register_board_info</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devices</span><span class="p">,</span> <span class="n">nr_devices</span><span class="p">);</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at91sam9260_twi_device</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#elif defined(CONFIG_I2C_AT91) || defined(CONFIG_I2C_AT91_MODULE)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">twi_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_TWI</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_TWI</span> <span class="o">+</span> <span class="n">SZ_16K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_TWI</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_TWI</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9260_twi_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;at91_i2c&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">twi_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">twi_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_i2c</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="o">*</span><span class="n">devices</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_devices</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* pins used for TWI interface */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA23</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* TWD */</span>
	<span class="n">at91_set_multi_drive</span><span class="p">(</span><span class="n">AT91_PIN_PA23</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA24</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* TWCK */</span>
	<span class="n">at91_set_multi_drive</span><span class="p">(</span><span class="n">AT91_PIN_PA24</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">i2c_register_board_info</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devices</span><span class="p">,</span> <span class="n">nr_devices</span><span class="p">);</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at91sam9260_twi_device</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_i2c</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="o">*</span><span class="n">devices</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_devices</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>


<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  SPI</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>

<span class="cp">#if defined(CONFIG_SPI_ATMEL) || defined(CONFIG_SPI_ATMEL_MODULE)</span>
<span class="k">static</span> <span class="n">u64</span> <span class="n">spi_dmamask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">spi0_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_SPI0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_SPI0</span> <span class="o">+</span> <span class="n">SZ_16K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_SPI0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_SPI0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9260_spi0_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;atmel_spi&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">dma_mask</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">spi_dmamask</span><span class="p">,</span>
				<span class="p">.</span><span class="n">coherent_dma_mask</span>	<span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">spi0_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">spi0_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="n">spi0_standard_cs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">AT91_PIN_PA3</span><span class="p">,</span> <span class="n">AT91_PIN_PC11</span><span class="p">,</span> <span class="n">AT91_PIN_PC16</span><span class="p">,</span> <span class="n">AT91_PIN_PC17</span> <span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">spi1_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_SPI1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_SPI1</span> <span class="o">+</span> <span class="n">SZ_16K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_SPI1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_SPI1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9260_spi1_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;atmel_spi&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">dma_mask</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">spi_dmamask</span><span class="p">,</span>
				<span class="p">.</span><span class="n">coherent_dma_mask</span>	<span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">spi1_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">spi1_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="n">spi1_standard_cs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">AT91_PIN_PB3</span><span class="p">,</span> <span class="n">AT91_PIN_PC5</span><span class="p">,</span> <span class="n">AT91_PIN_PC4</span><span class="p">,</span> <span class="n">AT91_PIN_PC3</span> <span class="p">};</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_spi</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_board_info</span> <span class="o">*</span><span class="n">devices</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_devices</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cs_pin</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">enable_spi0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">enable_spi1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Choose SPI chip-selects */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_devices</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devices</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">controller_data</span><span class="p">)</span>
			<span class="n">cs_pin</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">devices</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">controller_data</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">devices</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bus_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">cs_pin</span> <span class="o">=</span> <span class="n">spi0_standard_cs</span><span class="p">[</span><span class="n">devices</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chip_select</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">cs_pin</span> <span class="o">=</span> <span class="n">spi1_standard_cs</span><span class="p">[</span><span class="n">devices</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chip_select</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">cs_pin</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devices</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bus_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">enable_spi0</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">enable_spi1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* enable chip-select pin */</span>
		<span class="n">at91_set_gpio_output</span><span class="p">(</span><span class="n">cs_pin</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* pass chip-select pin to driver */</span>
		<span class="n">devices</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">controller_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">cs_pin</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spi_register_board_info</span><span class="p">(</span><span class="n">devices</span><span class="p">,</span> <span class="n">nr_devices</span><span class="p">);</span>

	<span class="cm">/* Configure SPI bus(es) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable_spi0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* SPI0_MISO */</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* SPI0_MOSI */</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* SPI1_SPCK */</span>

		<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at91sam9260_spi0_device</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable_spi1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PB0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* SPI1_MISO */</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PB1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* SPI1_MOSI */</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PB2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* SPI1_SPCK */</span>

		<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at91sam9260_spi1_device</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_spi</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_board_info</span> <span class="o">*</span><span class="n">devices</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_devices</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>


<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  Timer/Counter blocks</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>

<span class="cp">#ifdef CONFIG_ATMEL_TCLIB</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">tcb0_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_TCB0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_TCB0</span> <span class="o">+</span> <span class="n">SZ_256</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_TC0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_TC0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_TC1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_TC1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_TC2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_TC2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9260_tcb0_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;atmel_tcb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">tcb0_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tcb0_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">tcb1_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_TCB1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_TCB1</span> <span class="o">+</span> <span class="n">SZ_256</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_TC3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_TC3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_TC4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_TC4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_TC5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_TC5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9260_tcb1_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;atmel_tcb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">tcb1_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tcb1_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_tc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at91sam9260_tcb0_device</span><span class="p">);</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at91sam9260_tcb1_device</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_tc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="cp">#endif</span>


<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  RTT</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">rtt_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_RTT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_RTT</span> <span class="o">+</span> <span class="n">SZ_16</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9260_rtt_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;at91_rtt&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">rtt_resources</span><span class="p">,</span>
<span class="p">};</span>


<span class="cp">#if IS_ENABLED(CONFIG_RTC_DRV_AT91SAM9)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_rtt_rtc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">at91sam9260_rtt_device</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;rtc-at91sam9&quot;</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * The second resource is needed:</span>
<span class="cm">	 * GPBR will serve as the storage for RTC time offset</span>
<span class="cm">	 */</span>
	<span class="n">at91sam9260_rtt_device</span><span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">rtt_resources</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span> <span class="o">=</span> <span class="n">AT91SAM9260_BASE_GPBR</span> <span class="o">+</span>
				 <span class="mi">4</span> <span class="o">*</span> <span class="n">CONFIG_RTC_DRV_AT91SAM9_GPBR</span><span class="p">;</span>
	<span class="n">rtt_resources</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">end</span> <span class="o">=</span> <span class="n">rtt_resources</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_rtt_rtc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Only one resource is needed: RTT not used as RTC */</span>
	<span class="n">at91sam9260_rtt_device</span><span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_rtt</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">at91_add_device_rtt_rtc</span><span class="p">();</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at91sam9260_rtt_device</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  Watchdog</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>

<span class="cp">#if defined(CONFIG_AT91SAM9X_WATCHDOG) || defined(CONFIG_AT91SAM9X_WATCHDOG_MODULE)</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">wdt_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_WDT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_WDT</span> <span class="o">+</span> <span class="n">SZ_16</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9260_wdt_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;at91_wdt&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">wdt_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wdt_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_watchdog</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at91sam9260_wdt_device</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_watchdog</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>


<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  SSC -- Synchronous Serial Controller</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>

<span class="cp">#if defined(CONFIG_ATMEL_SSC) || defined(CONFIG_ATMEL_SSC_MODULE)</span>
<span class="k">static</span> <span class="n">u64</span> <span class="n">ssc_dmamask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">ssc_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_SSC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_SSC</span> <span class="o">+</span> <span class="n">SZ_16K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_SSC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_SSC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9260_ssc_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;ssc&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dma_mask</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ssc_dmamask</span><span class="p">,</span>
		<span class="p">.</span><span class="n">coherent_dma_mask</span>	<span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">ssc_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ssc_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">configure_ssc_pins</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">pins</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_SSC_TF</span><span class="p">)</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PB17</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_SSC_TK</span><span class="p">)</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PB16</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_SSC_TD</span><span class="p">)</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PB18</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_SSC_RD</span><span class="p">)</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PB19</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_SSC_RK</span><span class="p">)</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PB20</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_SSC_RF</span><span class="p">)</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PB21</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * SSC controllers are accessed through library code, instead of any</span>
<span class="cm"> * kind of all-singing/all-dancing driver.  For example one could be</span>
<span class="cm"> * used by a particular I2S audio codec&#39;s driver, while another one</span>
<span class="cm"> * on the same system might be used by a custom data capture driver.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_ssc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">pins</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * NOTE: caller is responsible for passing information matching</span>
<span class="cm">	 * &quot;pins&quot; to whatever will be using each particular controller.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AT91SAM9260_ID_SSC</span>:
		<span class="n">pdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">at91sam9260_ssc_device</span><span class="p">;</span>
		<span class="n">configure_ssc_pins</span><span class="p">(</span><span class="n">pins</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">platform_device_register</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_ssc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">pins</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>


<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  UART</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>
<span class="cp">#if defined(CONFIG_SERIAL_ATMEL)</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">dbgu_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_DBGU</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_DBGU</span> <span class="o">+</span> <span class="n">SZ_512</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91_ID_SYS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91_ID_SYS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">atmel_uart_data</span> <span class="n">dbgu_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">use_dma_tx</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_dma_rx</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>		<span class="cm">/* DBGU not capable of receive DMA */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u64</span> <span class="n">dbgu_dmamask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9260_dbgu_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;atmel_usart&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">dma_mask</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">dbgu_dmamask</span><span class="p">,</span>
				<span class="p">.</span><span class="n">coherent_dma_mask</span>	<span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
				<span class="p">.</span><span class="n">platform_data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">dbgu_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">dbgu_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dbgu_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">configure_dbgu_pins</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PB14</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* DRXD */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PB15</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>		<span class="cm">/* DTXD */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">uart0_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_US0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_US0</span> <span class="o">+</span> <span class="n">SZ_16K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_US0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_US0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">atmel_uart_data</span> <span class="n">uart0_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">use_dma_tx</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_dma_rx</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u64</span> <span class="n">uart0_dmamask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9260_uart0_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;atmel_usart&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">dma_mask</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">uart0_dmamask</span><span class="p">,</span>
				<span class="p">.</span><span class="n">coherent_dma_mask</span>	<span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
				<span class="p">.</span><span class="n">platform_data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">uart0_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">uart0_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">uart0_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">configure_usart0_pins</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">pins</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PB4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>		<span class="cm">/* TXD0 */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PB5</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* RXD0 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_UART_RTS</span><span class="p">)</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PB26</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* RTS0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_UART_CTS</span><span class="p">)</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PB27</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* CTS0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_UART_DTR</span><span class="p">)</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PB24</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* DTR0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_UART_DSR</span><span class="p">)</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PB22</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* DSR0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_UART_DCD</span><span class="p">)</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PB23</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* DCD0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_UART_RI</span><span class="p">)</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PB25</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* RI0 */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">uart1_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_US1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_US1</span> <span class="o">+</span> <span class="n">SZ_16K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_US1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_US1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">atmel_uart_data</span> <span class="n">uart1_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">use_dma_tx</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_dma_rx</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u64</span> <span class="n">uart1_dmamask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9260_uart1_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;atmel_usart&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">dma_mask</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">uart1_dmamask</span><span class="p">,</span>
				<span class="p">.</span><span class="n">coherent_dma_mask</span>	<span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
				<span class="p">.</span><span class="n">platform_data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">uart1_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">uart1_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">uart1_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">configure_usart1_pins</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">pins</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PB6</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>		<span class="cm">/* TXD1 */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PB7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* RXD1 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_UART_RTS</span><span class="p">)</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PB28</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* RTS1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_UART_CTS</span><span class="p">)</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PB29</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* CTS1 */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">uart2_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_US2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_US2</span> <span class="o">+</span> <span class="n">SZ_16K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_US2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_US2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">atmel_uart_data</span> <span class="n">uart2_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">use_dma_tx</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_dma_rx</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u64</span> <span class="n">uart2_dmamask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9260_uart2_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;atmel_usart&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">dma_mask</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">uart2_dmamask</span><span class="p">,</span>
				<span class="p">.</span><span class="n">coherent_dma_mask</span>	<span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
				<span class="p">.</span><span class="n">platform_data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">uart2_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">uart2_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">uart2_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">configure_usart2_pins</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">pins</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PB8</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>		<span class="cm">/* TXD2 */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PB9</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* RXD2 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_UART_RTS</span><span class="p">)</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* RTS2 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_UART_CTS</span><span class="p">)</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA5</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* CTS2 */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">uart3_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_US3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_US3</span> <span class="o">+</span> <span class="n">SZ_16K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_US3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_US3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">atmel_uart_data</span> <span class="n">uart3_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">use_dma_tx</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_dma_rx</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u64</span> <span class="n">uart3_dmamask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9260_uart3_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;atmel_usart&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">dma_mask</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">uart3_dmamask</span><span class="p">,</span>
				<span class="p">.</span><span class="n">coherent_dma_mask</span>	<span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
				<span class="p">.</span><span class="n">platform_data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">uart3_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">uart3_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">uart3_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">configure_usart3_pins</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">pins</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PB10</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>		<span class="cm">/* TXD3 */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PB11</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* RXD3 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_UART_RTS</span><span class="p">)</span>
		<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PC8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* RTS3 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_UART_CTS</span><span class="p">)</span>
		<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PC10</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* CTS3 */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">uart4_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_US4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_US4</span> <span class="o">+</span> <span class="n">SZ_16K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_US4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_US4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">atmel_uart_data</span> <span class="n">uart4_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">use_dma_tx</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_dma_rx</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u64</span> <span class="n">uart4_dmamask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9260_uart4_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;atmel_usart&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">dma_mask</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">uart4_dmamask</span><span class="p">,</span>
				<span class="p">.</span><span class="n">coherent_dma_mask</span>	<span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
				<span class="p">.</span><span class="n">platform_data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">uart4_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">uart4_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">uart4_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">configure_usart4_pins</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA31</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>		<span class="cm">/* TXD4 */</span>
	<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA30</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* RXD4 */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">uart5_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_US5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_US5</span> <span class="o">+</span> <span class="n">SZ_16K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_US5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_US5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">atmel_uart_data</span> <span class="n">uart5_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">use_dma_tx</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_dma_rx</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u64</span> <span class="n">uart5_dmamask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9260_uart5_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;atmel_usart&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">dma_mask</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">uart5_dmamask</span><span class="p">,</span>
				<span class="p">.</span><span class="n">coherent_dma_mask</span>	<span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
				<span class="p">.</span><span class="n">platform_data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">uart5_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">uart5_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">uart5_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">configure_usart5_pins</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PB12</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>		<span class="cm">/* TXD5 */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PB13</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* RXD5 */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">__initdata</span> <span class="n">at91_uarts</span><span class="p">[</span><span class="n">ATMEL_MAX_UART</span><span class="p">];</span>	<span class="cm">/* the UARTs to use */</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_register_uart</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">portnr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">pins</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atmel_uart_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:		<span class="cm">/* DBGU */</span>
			<span class="n">pdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">at91sam9260_dbgu_device</span><span class="p">;</span>
			<span class="n">configure_dbgu_pins</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AT91SAM9260_ID_US0</span>:
			<span class="n">pdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">at91sam9260_uart0_device</span><span class="p">;</span>
			<span class="n">configure_usart0_pins</span><span class="p">(</span><span class="n">pins</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AT91SAM9260_ID_US1</span>:
			<span class="n">pdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">at91sam9260_uart1_device</span><span class="p">;</span>
			<span class="n">configure_usart1_pins</span><span class="p">(</span><span class="n">pins</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AT91SAM9260_ID_US2</span>:
			<span class="n">pdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">at91sam9260_uart2_device</span><span class="p">;</span>
			<span class="n">configure_usart2_pins</span><span class="p">(</span><span class="n">pins</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AT91SAM9260_ID_US3</span>:
			<span class="n">pdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">at91sam9260_uart3_device</span><span class="p">;</span>
			<span class="n">configure_usart3_pins</span><span class="p">(</span><span class="n">pins</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AT91SAM9260_ID_US4</span>:
			<span class="n">pdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">at91sam9260_uart4_device</span><span class="p">;</span>
			<span class="n">configure_usart4_pins</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AT91SAM9260_ID_US5</span>:
			<span class="n">pdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">at91sam9260_uart5_device</span><span class="p">;</span>
			<span class="n">configure_usart5_pins</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pdata</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">=</span> <span class="n">portnr</span><span class="p">;</span>		<span class="cm">/* update to mapped ID */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">portnr</span> <span class="o">&lt;</span> <span class="n">ATMEL_MAX_UART</span><span class="p">)</span>
		<span class="n">at91_uarts</span><span class="p">[</span><span class="n">portnr</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_serial</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATMEL_MAX_UART</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">at91_uarts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">platform_device_register</span><span class="p">(</span><span class="n">at91_uarts</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_register_uart</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">portnr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">pins</span><span class="p">)</span> <span class="p">{}</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_serial</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>

<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  CF/IDE</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>

<span class="cp">#if defined(CONFIG_PATA_AT91) || defined(CONFIG_PATA_AT91_MODULE) || \</span>
<span class="cp">	defined(CONFIG_AT91_CF) || defined(CONFIG_AT91_CF_MODULE)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">at91_cf_data</span> <span class="n">cf0_data</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">cf0_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91_CHIPSELECT_4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91_CHIPSELECT_4</span> <span class="o">+</span> <span class="n">SZ_256M</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">cf0_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">cf0_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">cf0_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cf0_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">at91_cf_data</span> <span class="n">cf1_data</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">cf1_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91_CHIPSELECT_5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91_CHIPSELECT_5</span> <span class="o">+</span> <span class="n">SZ_256M</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">cf1_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">cf1_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">cf1_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cf1_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_cf</span><span class="p">(</span><span class="k">struct</span> <span class="n">at91_cf_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">csa</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">csa</span> <span class="o">=</span> <span class="n">at91_matrix_read</span><span class="p">(</span><span class="n">AT91_MATRIX_EBICSA</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">chipselect</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">at91_set_multi_drive</span><span class="p">(</span><span class="n">AT91_PIN_PC8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PC8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">csa</span> <span class="o">|=</span> <span class="n">AT91_MATRIX_CS4A_SMC_CF1</span><span class="p">;</span>
		<span class="n">cf0_data</span> <span class="o">=</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
		<span class="n">pdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cf0_device</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">at91_set_multi_drive</span><span class="p">(</span><span class="n">AT91_PIN_PC9</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PC9</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">csa</span> <span class="o">|=</span> <span class="n">AT91_MATRIX_CS5A_SMC_CF2</span><span class="p">;</span>
		<span class="n">cf1_data</span> <span class="o">=</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
		<span class="n">pdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cf1_device</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;AT91 CF: bad chip-select requested (%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">data</span><span class="o">-&gt;</span><span class="n">chipselect</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">at91_matrix_write</span><span class="p">(</span><span class="n">AT91_MATRIX_EBICSA</span><span class="p">,</span> <span class="n">csa</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rst_pin</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">at91_set_multi_drive</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rst_pin</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">at91_set_gpio_output</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rst_pin</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">irq_pin</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">at91_set_gpio_input</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">irq_pin</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">at91_set_deglitch</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">irq_pin</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">det_pin</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">at91_set_gpio_input</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">det_pin</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">at91_set_deglitch</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">det_pin</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PC6</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>     <span class="cm">/* CFCE1 */</span>
	<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PC7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>     <span class="cm">/* CFCE2 */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PC10</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>    <span class="cm">/* CFRNW */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PC15</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>    <span class="cm">/* NWAIT */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AT91_CF_TRUE_IDE</span><span class="p">)</span>
<span class="cp">#if defined(CONFIG_PATA_AT91) || defined(CONFIG_PATA_AT91_MODULE)</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pata_at91&quot;</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="cp">#warning &quot;board requires AT91_CF_TRUE_IDE: enable pata_at91&quot;</span>
<span class="cp">#endif</span>
	<span class="k">else</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;at91_cf&quot;</span><span class="p">;</span>

	<span class="n">platform_device_register</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_cf</span><span class="p">(</span><span class="k">struct</span> <span class="n">at91_cf_data</span> <span class="o">*</span> <span class="n">data</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>

<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  ADCs</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>

<span class="cp">#if IS_ENABLED(CONFIG_AT91_ADC)</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">at91_adc_data</span> <span class="n">adc_data</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">adc_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_ADC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_BASE_ADC</span> <span class="o">+</span> <span class="n">SZ_16K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_ADC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9260_ID_ADC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91_adc_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;at91_adc&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">platform_data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">adc_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">adc_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">adc_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">at91_adc_trigger</span> <span class="n">at91_adc_triggers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;timer-counter-0&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">AT91_ADC_TRGSEL_TC0</span> <span class="o">|</span> <span class="n">AT91_ADC_TRGEN</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;timer-counter-1&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">AT91_ADC_TRGSEL_TC1</span> <span class="o">|</span> <span class="n">AT91_ADC_TRGEN</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;timer-counter-2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">AT91_ADC_TRGSEL_TC2</span> <span class="o">|</span> <span class="n">AT91_ADC_TRGEN</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;external&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">AT91_ADC_TRGSEL_EXTERNAL</span> <span class="o">|</span> <span class="n">AT91_ADC_TRGEN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">is_external</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">at91_adc_reg_desc</span> <span class="n">at91_adc_register_g20</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">channel_base</span> <span class="o">=</span> <span class="n">AT91_ADC_CHR</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
	<span class="p">.</span><span class="n">drdy_mask</span> <span class="o">=</span> <span class="n">AT91_ADC_DRDY</span><span class="p">,</span>
	<span class="p">.</span><span class="n">status_register</span> <span class="o">=</span> <span class="n">AT91_ADC_SR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger_register</span> <span class="o">=</span> <span class="n">AT91_ADC_MR</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_adc</span><span class="p">(</span><span class="k">struct</span> <span class="n">at91_adc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">channels_used</span><span class="p">))</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PC0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">channels_used</span><span class="p">))</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PC1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">channels_used</span><span class="p">))</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PC2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">channels_used</span><span class="p">))</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PC3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">use_external_triggers</span><span class="p">)</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA22</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">num_channels</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">startup_time</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">registers</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">at91_adc_register_g20</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">trigger_number</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">trigger_list</span> <span class="o">=</span> <span class="n">at91_adc_triggers</span><span class="p">;</span>

	<span class="n">adc_data</span> <span class="o">=</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at91_adc_device</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_adc</span><span class="p">(</span><span class="k">struct</span> <span class="n">at91_adc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>

<span class="cm">/* -------------------------------------------------------------------- */</span>
<span class="cm">/*</span>
<span class="cm"> * These devices are always present and don&#39;t need any board-specific</span>
<span class="cm"> * setup.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">at91_add_standard_devices</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_have_populated_dt</span><span class="p">())</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">at91_add_device_rtt</span><span class="p">();</span>
	<span class="n">at91_add_device_watchdog</span><span class="p">();</span>
	<span class="n">at91_add_device_tc</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">arch_initcall</span><span class="p">(</span><span class="n">at91_add_standard_devices</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
