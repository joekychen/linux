<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › mach-at91 › at91sam9rl_devices.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>at91sam9rl_devices.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Copyright (C) 2007 Atmel Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License.  See the file COPYING in the main directory of this archive for</span>
<span class="cm"> * more details.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;asm/mach/arch.h&gt;</span>
<span class="cp">#include &lt;asm/mach/map.h&gt;</span>

<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/i2c-gpio.h&gt;</span>

<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;video/atmel_lcdc.h&gt;</span>

<span class="cp">#include &lt;mach/board.h&gt;</span>
<span class="cp">#include &lt;mach/at91sam9rl.h&gt;</span>
<span class="cp">#include &lt;mach/at91sam9rl_matrix.h&gt;</span>
<span class="cp">#include &lt;mach/at91_matrix.h&gt;</span>
<span class="cp">#include &lt;mach/at91sam9_smc.h&gt;</span>
<span class="cp">#include &lt;mach/at_hdmac.h&gt;</span>

<span class="cp">#include &quot;generic.h&quot;</span>


<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  HDMAC - AHB DMA Controller</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>

<span class="cp">#if defined(CONFIG_AT_HDMAC) || defined(CONFIG_AT_HDMAC_MODULE)</span>
<span class="k">static</span> <span class="n">u64</span> <span class="n">hdmac_dmamask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">hdmac_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_DMA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_DMA</span> <span class="o">+</span> <span class="n">SZ_512</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_ID_DMA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_ID_DMA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at_hdmac_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;at91sam9rl_dma&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">dma_mask</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">hdmac_dmamask</span><span class="p">,</span>
				<span class="p">.</span><span class="n">coherent_dma_mask</span>	<span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">hdmac_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hdmac_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_hdmac</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at_hdmac_device</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_hdmac</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>

<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  USB HS Device (Gadget)</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>

<span class="cp">#if defined(CONFIG_USB_ATMEL_USBA) || defined(CONFIG_USB_ATMEL_USBA_MODULE)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">usba_udc_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_UDPHS_FIFO</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_UDPHS_FIFO</span> <span class="o">+</span> <span class="n">SZ_512K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_UDPHS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_UDPHS</span> <span class="o">+</span> <span class="n">SZ_1K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_ID_UDPHS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_ID_UDPHS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cp">#define EP(nam, idx, maxpkt, maxbk, dma, isoc)			\</span>
<span class="cp">	[idx] = {						\</span>
<span class="cp">		.name		= nam,				\</span>
<span class="cp">		.index		= idx,				\</span>
<span class="cp">		.fifo_size	= maxpkt,			\</span>
<span class="cp">		.nr_banks	= maxbk,			\</span>
<span class="cp">		.can_dma	= dma,				\</span>
<span class="cp">		.can_isoc	= isoc,				\</span>
<span class="cp">	}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usba_ep_data</span> <span class="n">usba_udc_ep</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">EP</span><span class="p">(</span><span class="s">&quot;ep0&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">EP</span><span class="p">(</span><span class="s">&quot;ep1&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">EP</span><span class="p">(</span><span class="s">&quot;ep2&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">EP</span><span class="p">(</span><span class="s">&quot;ep3&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">EP</span><span class="p">(</span><span class="s">&quot;ep4&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">EP</span><span class="p">(</span><span class="s">&quot;ep5&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">EP</span><span class="p">(</span><span class="s">&quot;ep6&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">};</span>

<span class="cp">#undef EP</span>

<span class="cm">/*</span>
<span class="cm"> * pdata doesn&#39;t have room for any endpoints, so we need to</span>
<span class="cm"> * append room for the ones we need right after it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">usba_platform_data</span> <span class="n">pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usba_ep_data</span> <span class="n">ep</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
<span class="p">}</span> <span class="n">usba_udc_data</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91_usba_udc_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;atmel_usba_udc&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">usba_udc_data</span><span class="p">.</span><span class="n">pdata</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">usba_udc_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">usba_udc_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_usba</span><span class="p">(</span><span class="k">struct</span> <span class="n">usba_platform_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Invalid pins are 0 on AT91, but the usba driver is shared</span>
<span class="cm">	 * with AVR32, which use negative values instead. Once/if</span>
<span class="cm">	 * gpio_is_valid() is ported to AT91, revisit this code.</span>
<span class="cm">	 */</span>
	<span class="n">usba_udc_data</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">vbus_pin</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">usba_udc_data</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">num_ep</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">usba_udc_ep</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">usba_udc_data</span><span class="p">.</span><span class="n">ep</span><span class="p">,</span> <span class="n">usba_udc_ep</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">usba_udc_ep</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vbus_pin</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">at91_set_gpio_input</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vbus_pin</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">at91_set_deglitch</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vbus_pin</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">usba_udc_data</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">vbus_pin</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">vbus_pin</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Pullup pin is handled internally by USB device peripheral */</span>

	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at91_usba_udc_device</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_usba</span><span class="p">(</span><span class="k">struct</span> <span class="n">usba_platform_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>


<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  MMC / SD</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>

<span class="cp">#if defined(CONFIG_MMC_AT91) || defined(CONFIG_MMC_AT91_MODULE)</span>
<span class="k">static</span> <span class="n">u64</span> <span class="n">mmc_dmamask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">at91_mmc_data</span> <span class="n">mmc_data</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">mmc_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_MCI</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_MCI</span> <span class="o">+</span> <span class="n">SZ_16K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_ID_MCI</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_ID_MCI</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9rl_mmc_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;at91_mci&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">dma_mask</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">mmc_dmamask</span><span class="p">,</span>
				<span class="p">.</span><span class="n">coherent_dma_mask</span>	<span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
				<span class="p">.</span><span class="n">platform_data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">mmc_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">mmc_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mmc_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_mmc</span><span class="p">(</span><span class="kt">short</span> <span class="n">mmc_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">at91_mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* input/irq */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">det_pin</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">at91_set_gpio_input</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">det_pin</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">at91_set_deglitch</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">det_pin</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">wp_pin</span><span class="p">))</span>
		<span class="n">at91_set_gpio_input</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">wp_pin</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vcc_pin</span><span class="p">))</span>
		<span class="n">at91_set_gpio_output</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vcc_pin</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* CLK */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* CMD */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* DAT0, maybe DAT1..DAT3 */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">wire4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA3</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA5</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mmc_data</span> <span class="o">=</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at91sam9rl_mmc_device</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_mmc</span><span class="p">(</span><span class="kt">short</span> <span class="n">mmc_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">at91_mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>


<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  NAND / SmartMedia</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>

<span class="cp">#if defined(CONFIG_MTD_NAND_ATMEL) || defined(CONFIG_MTD_NAND_ATMEL_MODULE)</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">atmel_nand_data</span> <span class="n">nand_data</span><span class="p">;</span>

<span class="cp">#define NAND_BASE	AT91_CHIPSELECT_3</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">nand_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">NAND_BASE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">NAND_BASE</span> <span class="o">+</span> <span class="n">SZ_256M</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_ECC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_ECC</span> <span class="o">+</span> <span class="n">SZ_512</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">atmel_nand_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;atmel_nand&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">nand_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">nand_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">nand_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_nand</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_nand_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">csa</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">csa</span> <span class="o">=</span> <span class="n">at91_matrix_read</span><span class="p">(</span><span class="n">AT91_MATRIX_EBICSA</span><span class="p">);</span>
	<span class="n">at91_matrix_write</span><span class="p">(</span><span class="n">AT91_MATRIX_EBICSA</span><span class="p">,</span> <span class="n">csa</span> <span class="o">|</span> <span class="n">AT91_MATRIX_CS3A_SMC_SMARTMEDIA</span><span class="p">);</span>

	<span class="cm">/* enable pin */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">enable_pin</span><span class="p">))</span>
		<span class="n">at91_set_gpio_output</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">enable_pin</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* ready/busy pin */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rdy_pin</span><span class="p">))</span>
		<span class="n">at91_set_gpio_input</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rdy_pin</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* card detect pin */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">det_pin</span><span class="p">))</span>
		<span class="n">at91_set_gpio_input</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">det_pin</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PB4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* NANDOE */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PB5</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* NANDWE */</span>

	<span class="n">nand_data</span> <span class="o">=</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atmel_nand_device</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_nand</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_nand_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>


<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  TWI (i2c)</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>

<span class="cm">/*</span>
<span class="cm"> * Prefer the GPIO code since the TWI controller isn&#39;t robust</span>
<span class="cm"> * (gets overruns and underruns under load) and can only issue</span>
<span class="cm"> * repeated STARTs in one scenario (the driver doesn&#39;t yet handle them).</span>
<span class="cm"> */</span>
<span class="cp">#if defined(CONFIG_I2C_GPIO) || defined(CONFIG_I2C_GPIO_MODULE)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_gpio_platform_data</span> <span class="n">pdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">sda_pin</span>		<span class="o">=</span> <span class="n">AT91_PIN_PA23</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sda_is_open_drain</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">scl_pin</span>		<span class="o">=</span> <span class="n">AT91_PIN_PA24</span><span class="p">,</span>
	<span class="p">.</span><span class="n">scl_is_open_drain</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udelay</span>			<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>		<span class="cm">/* ~100 kHz */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9rl_twi_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;i2c-gpio&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>			<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">pdata</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_i2c</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="o">*</span><span class="n">devices</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_devices</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">at91_set_GPIO_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA23</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>		<span class="cm">/* TWD (SDA) */</span>
	<span class="n">at91_set_multi_drive</span><span class="p">(</span><span class="n">AT91_PIN_PA23</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">at91_set_GPIO_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA24</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>		<span class="cm">/* TWCK (SCL) */</span>
	<span class="n">at91_set_multi_drive</span><span class="p">(</span><span class="n">AT91_PIN_PA24</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">i2c_register_board_info</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devices</span><span class="p">,</span> <span class="n">nr_devices</span><span class="p">);</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at91sam9rl_twi_device</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#elif defined(CONFIG_I2C_AT91) || defined(CONFIG_I2C_AT91_MODULE)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">twi_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_TWI0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_TWI0</span> <span class="o">+</span> <span class="n">SZ_16K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_ID_TWI0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_ID_TWI0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9rl_twi_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;at91_i2c&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">twi_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">twi_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_i2c</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="o">*</span><span class="n">devices</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_devices</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* pins used for TWI interface */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA23</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* TWD */</span>
	<span class="n">at91_set_multi_drive</span><span class="p">(</span><span class="n">AT91_PIN_PA23</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA24</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* TWCK */</span>
	<span class="n">at91_set_multi_drive</span><span class="p">(</span><span class="n">AT91_PIN_PA24</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">i2c_register_board_info</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">devices</span><span class="p">,</span> <span class="n">nr_devices</span><span class="p">);</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at91sam9rl_twi_device</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_i2c</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="o">*</span><span class="n">devices</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_devices</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>


<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  SPI</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>

<span class="cp">#if defined(CONFIG_SPI_ATMEL) || defined(CONFIG_SPI_ATMEL_MODULE)</span>
<span class="k">static</span> <span class="n">u64</span> <span class="n">spi_dmamask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">spi_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_SPI</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_SPI</span> <span class="o">+</span> <span class="n">SZ_16K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_ID_SPI</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_ID_SPI</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9rl_spi_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;atmel_spi&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">dma_mask</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">spi_dmamask</span><span class="p">,</span>
				<span class="p">.</span><span class="n">coherent_dma_mask</span>	<span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">spi_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">spi_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="n">spi_standard_cs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">AT91_PIN_PA28</span><span class="p">,</span> <span class="n">AT91_PIN_PB7</span><span class="p">,</span> <span class="n">AT91_PIN_PD8</span><span class="p">,</span> <span class="n">AT91_PIN_PD9</span> <span class="p">};</span>


<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_spi</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_board_info</span> <span class="o">*</span><span class="n">devices</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_devices</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cs_pin</span><span class="p">;</span>

	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA25</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* MISO */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA26</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* MOSI */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA27</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* SPCK */</span>

	<span class="cm">/* Enable SPI chip-selects */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_devices</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devices</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">controller_data</span><span class="p">)</span>
			<span class="n">cs_pin</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">devices</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">controller_data</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cs_pin</span> <span class="o">=</span> <span class="n">spi_standard_cs</span><span class="p">[</span><span class="n">devices</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chip_select</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">cs_pin</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* enable chip-select pin */</span>
		<span class="n">at91_set_gpio_output</span><span class="p">(</span><span class="n">cs_pin</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* pass chip-select pin to driver */</span>
		<span class="n">devices</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">controller_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">cs_pin</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spi_register_board_info</span><span class="p">(</span><span class="n">devices</span><span class="p">,</span> <span class="n">nr_devices</span><span class="p">);</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at91sam9rl_spi_device</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_spi</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_board_info</span> <span class="o">*</span><span class="n">devices</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_devices</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>


<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  AC97</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>

<span class="cp">#if defined(CONFIG_SND_ATMEL_AC97C) || defined(CONFIG_SND_ATMEL_AC97C_MODULE)</span>
<span class="k">static</span> <span class="n">u64</span> <span class="n">ac97_dmamask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ac97c_platform_data</span> <span class="n">ac97_data</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">ac97_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_AC97C</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_AC97C</span> <span class="o">+</span> <span class="n">SZ_16K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_ID_AC97C</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_ID_AC97C</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9rl_ac97_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;atmel_ac97c&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">dma_mask</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ac97_dmamask</span><span class="p">,</span>
				<span class="p">.</span><span class="n">coherent_dma_mask</span>	<span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
				<span class="p">.</span><span class="n">platform_data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ac97_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">ac97_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ac97_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_ac97</span><span class="p">(</span><span class="k">struct</span> <span class="n">ac97c_platform_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PD1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* AC97FS */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PD2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* AC97CK */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PD3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* AC97TX */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PD4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* AC97RX */</span>

	<span class="cm">/* reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">reset_pin</span><span class="p">))</span>
		<span class="n">at91_set_gpio_output</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">reset_pin</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ac97_data</span> <span class="o">=</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at91sam9rl_ac97_device</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_ac97</span><span class="p">(</span><span class="k">struct</span> <span class="n">ac97c_platform_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>


<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  LCD Controller</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>

<span class="cp">#if defined(CONFIG_FB_ATMEL) || defined(CONFIG_FB_ATMEL_MODULE)</span>
<span class="k">static</span> <span class="n">u64</span> <span class="n">lcdc_dmamask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">atmel_lcdfb_info</span> <span class="n">lcdc_data</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">lcdc_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_LCDC_BASE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_LCDC_BASE</span> <span class="o">+</span> <span class="n">SZ_4K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_ID_LCDC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_ID_LCDC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91_lcdc_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;atmel_lcdfb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">dma_mask</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">lcdc_dmamask</span><span class="p">,</span>
				<span class="p">.</span><span class="n">coherent_dma_mask</span>	<span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
				<span class="p">.</span><span class="n">platform_data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">lcdc_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">lcdc_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">lcdc_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_lcdc</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_lcdfb_info</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PC1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* LCDPWR */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PC5</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* LCDHSYNC */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PC6</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* LCDDOTCK */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PC7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* LCDDEN */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PC3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* LCDCC */</span>
	<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PC9</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* LCDD3 */</span>
	<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PC10</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* LCDD4 */</span>
	<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PC11</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* LCDD5 */</span>
	<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PC12</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* LCDD6 */</span>
	<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PC13</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* LCDD7 */</span>
	<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PC15</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* LCDD11 */</span>
	<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PC16</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* LCDD12 */</span>
	<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PC17</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* LCDD13 */</span>
	<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PC18</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* LCDD14 */</span>
	<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PC19</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* LCDD15 */</span>
	<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PC20</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* LCDD18 */</span>
	<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PC21</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* LCDD19 */</span>
	<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PC22</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* LCDD20 */</span>
	<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PC23</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* LCDD21 */</span>
	<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PC24</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* LCDD22 */</span>
	<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PC25</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* LCDD23 */</span>

	<span class="n">lcdc_data</span> <span class="o">=</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at91_lcdc_device</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_lcdc</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_lcdfb_info</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>


<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  Timer/Counter block</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>

<span class="cp">#ifdef CONFIG_ATMEL_TCLIB</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">tcb_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_TCB0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_TCB0</span> <span class="o">+</span> <span class="n">SZ_16K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_ID_TC0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_ID_TC0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_ID_TC1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_ID_TC1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_ID_TC2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_ID_TC2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9rl_tcb_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;atmel_tcb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">tcb_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tcb_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_tc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at91sam9rl_tcb_device</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_tc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="cp">#endif</span>


<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  Touchscreen</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>

<span class="cp">#if defined(CONFIG_TOUCHSCREEN_ATMEL_TSADCC) || defined(CONFIG_TOUCHSCREEN_ATMEL_TSADCC_MODULE)</span>
<span class="k">static</span> <span class="n">u64</span> <span class="n">tsadcc_dmamask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">at91_tsadcc_data</span> <span class="n">tsadcc_data</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">tsadcc_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_TSC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_TSC</span> <span class="o">+</span> <span class="n">SZ_16K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_ID_TSC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_ID_TSC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9rl_tsadcc_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;atmel_tsadcc&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">dma_mask</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">tsadcc_dmamask</span><span class="p">,</span>
				<span class="p">.</span><span class="n">coherent_dma_mask</span>	<span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
				<span class="p">.</span><span class="n">platform_data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">tsadcc_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">tsadcc_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tsadcc_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_tsadcc</span><span class="p">(</span><span class="k">struct</span> <span class="n">at91_tsadcc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA17</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* AD0_XR */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA18</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* AD1_XL */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA19</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* AD2_YT */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA20</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* AD3_TB */</span>

	<span class="n">tsadcc_data</span> <span class="o">=</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at91sam9rl_tsadcc_device</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_tsadcc</span><span class="p">(</span><span class="k">struct</span> <span class="n">at91_tsadcc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>


<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  RTC</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>

<span class="cp">#if defined(CONFIG_RTC_DRV_AT91RM9200) || defined(CONFIG_RTC_DRV_AT91RM9200_MODULE)</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9rl_rtc_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;at91_rtc&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_rtc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at91sam9rl_rtc_device</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_rtc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>


<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  RTT</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">rtt_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_RTT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_RTT</span> <span class="o">+</span> <span class="n">SZ_16</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9rl_rtt_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;at91_rtt&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">rtt_resources</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#if IS_ENABLED(CONFIG_RTC_DRV_AT91SAM9)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_rtt_rtc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">at91sam9rl_rtt_device</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;rtc-at91sam9&quot;</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * The second resource is needed:</span>
<span class="cm">	 * GPBR will serve as the storage for RTC time offset</span>
<span class="cm">	 */</span>
	<span class="n">at91sam9rl_rtt_device</span><span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">rtt_resources</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span> <span class="o">=</span> <span class="n">AT91SAM9RL_BASE_GPBR</span> <span class="o">+</span>
				 <span class="mi">4</span> <span class="o">*</span> <span class="n">CONFIG_RTC_DRV_AT91SAM9_GPBR</span><span class="p">;</span>
	<span class="n">rtt_resources</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">end</span> <span class="o">=</span> <span class="n">rtt_resources</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_rtt_rtc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Only one resource is needed: RTT not used as RTC */</span>
	<span class="n">at91sam9rl_rtt_device</span><span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_rtt</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">at91_add_device_rtt_rtc</span><span class="p">();</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at91sam9rl_rtt_device</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  Watchdog</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>

<span class="cp">#if defined(CONFIG_AT91SAM9X_WATCHDOG) || defined(CONFIG_AT91SAM9X_WATCHDOG_MODULE)</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">wdt_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_WDT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_WDT</span> <span class="o">+</span> <span class="n">SZ_16</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9rl_wdt_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;at91_wdt&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">wdt_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wdt_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_watchdog</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at91sam9rl_wdt_device</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_watchdog</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>


<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  PWM</span>
<span class="cm"> * --------------------------------------------------------------------*/</span>

<span class="cp">#if defined(CONFIG_ATMEL_PWM)</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">pwm_mask</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">pwm_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_PWMC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_PWMC</span> <span class="o">+</span> <span class="n">SZ_16K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_ID_PWMC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_ID_PWMC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9rl_pwm0_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;atmel_pwm&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pwm_mask</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">pwm_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pwm_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_pwm</span><span class="p">(</span><span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">AT91_PWM0</span><span class="p">))</span>
		<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PB8</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* enable PWM0 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">AT91_PWM1</span><span class="p">))</span>
		<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PB9</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* enable PWM1 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">AT91_PWM2</span><span class="p">))</span>
		<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PD5</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* enable PWM2 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">AT91_PWM3</span><span class="p">))</span>
		<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PD8</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* enable PWM3 */</span>

	<span class="n">pwm_mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at91sam9rl_pwm0_device</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_pwm</span><span class="p">(</span><span class="n">u32</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>


<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  SSC -- Synchronous Serial Controller</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>

<span class="cp">#if defined(CONFIG_ATMEL_SSC) || defined(CONFIG_ATMEL_SSC_MODULE)</span>
<span class="k">static</span> <span class="n">u64</span> <span class="n">ssc0_dmamask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">ssc0_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_SSC0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_SSC0</span> <span class="o">+</span> <span class="n">SZ_16K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_ID_SSC0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_ID_SSC0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9rl_ssc0_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;ssc&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dma_mask</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ssc0_dmamask</span><span class="p">,</span>
		<span class="p">.</span><span class="n">coherent_dma_mask</span>	<span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">ssc0_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ssc0_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">configure_ssc0_pins</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">pins</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_SSC_TF</span><span class="p">)</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PC0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_SSC_TK</span><span class="p">)</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PC1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_SSC_TD</span><span class="p">)</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA15</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_SSC_RD</span><span class="p">)</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA16</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_SSC_RK</span><span class="p">)</span>
		<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA10</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_SSC_RF</span><span class="p">)</span>
		<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA22</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="n">ssc1_dmamask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">ssc1_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_SSC1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_SSC1</span> <span class="o">+</span> <span class="n">SZ_16K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_ID_SSC1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_ID_SSC1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9rl_ssc1_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;ssc&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dma_mask</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ssc1_dmamask</span><span class="p">,</span>
		<span class="p">.</span><span class="n">coherent_dma_mask</span>	<span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">ssc1_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ssc1_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">configure_ssc1_pins</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">pins</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_SSC_TF</span><span class="p">)</span>
		<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA29</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_SSC_TK</span><span class="p">)</span>
		<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA30</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_SSC_TD</span><span class="p">)</span>
		<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA13</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_SSC_RD</span><span class="p">)</span>
		<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA14</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_SSC_RK</span><span class="p">)</span>
		<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA9</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_SSC_RF</span><span class="p">)</span>
		<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA8</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * SSC controllers are accessed through library code, instead of any</span>
<span class="cm"> * kind of all-singing/all-dancing driver.  For example one could be</span>
<span class="cm"> * used by a particular I2S audio codec&#39;s driver, while another one</span>
<span class="cm"> * on the same system might be used by a custom data capture driver.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_ssc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">pins</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * NOTE: caller is responsible for passing information matching</span>
<span class="cm">	 * &quot;pins&quot; to whatever will be using each particular controller.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AT91SAM9RL_ID_SSC0</span>:
		<span class="n">pdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">at91sam9rl_ssc0_device</span><span class="p">;</span>
		<span class="n">configure_ssc0_pins</span><span class="p">(</span><span class="n">pins</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AT91SAM9RL_ID_SSC1</span>:
		<span class="n">pdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">at91sam9rl_ssc1_device</span><span class="p">;</span>
		<span class="n">configure_ssc1_pins</span><span class="p">(</span><span class="n">pins</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">platform_device_register</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_ssc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">pins</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>


<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  UART</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>

<span class="cp">#if defined(CONFIG_SERIAL_ATMEL)</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">dbgu_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_DBGU</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_DBGU</span> <span class="o">+</span> <span class="n">SZ_512</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91_ID_SYS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91_ID_SYS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">atmel_uart_data</span> <span class="n">dbgu_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">use_dma_tx</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_dma_rx</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>		<span class="cm">/* DBGU not capable of receive DMA */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u64</span> <span class="n">dbgu_dmamask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9rl_dbgu_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;atmel_usart&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">dma_mask</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">dbgu_dmamask</span><span class="p">,</span>
				<span class="p">.</span><span class="n">coherent_dma_mask</span>	<span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
				<span class="p">.</span><span class="n">platform_data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">dbgu_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">dbgu_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dbgu_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">configure_dbgu_pins</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA21</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* DRXD */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA22</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>		<span class="cm">/* DTXD */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">uart0_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_US0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_US0</span> <span class="o">+</span> <span class="n">SZ_16K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_ID_US0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_ID_US0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">atmel_uart_data</span> <span class="n">uart0_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">use_dma_tx</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_dma_rx</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u64</span> <span class="n">uart0_dmamask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9rl_uart0_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;atmel_usart&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">dma_mask</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">uart0_dmamask</span><span class="p">,</span>
				<span class="p">.</span><span class="n">coherent_dma_mask</span>	<span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
				<span class="p">.</span><span class="n">platform_data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">uart0_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">uart0_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">uart0_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">configure_usart0_pins</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">pins</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA6</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>		<span class="cm">/* TXD0 */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* RXD0 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_UART_RTS</span><span class="p">)</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA9</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* RTS0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_UART_CTS</span><span class="p">)</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA10</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* CTS0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_UART_DSR</span><span class="p">)</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PD14</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* DSR0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_UART_DTR</span><span class="p">)</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PD15</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* DTR0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_UART_DCD</span><span class="p">)</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PD16</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* DCD0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_UART_RI</span><span class="p">)</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PD17</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* RI0 */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">uart1_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_US1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_US1</span> <span class="o">+</span> <span class="n">SZ_16K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_ID_US1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_ID_US1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">atmel_uart_data</span> <span class="n">uart1_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">use_dma_tx</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_dma_rx</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u64</span> <span class="n">uart1_dmamask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9rl_uart1_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;atmel_usart&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">dma_mask</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">uart1_dmamask</span><span class="p">,</span>
				<span class="p">.</span><span class="n">coherent_dma_mask</span>	<span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
				<span class="p">.</span><span class="n">platform_data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">uart1_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">uart1_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">uart1_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">configure_usart1_pins</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">pins</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA11</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>		<span class="cm">/* TXD1 */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA12</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* RXD1 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_UART_RTS</span><span class="p">)</span>
		<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA18</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* RTS1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_UART_CTS</span><span class="p">)</span>
		<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA19</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* CTS1 */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">uart2_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_US2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_US2</span> <span class="o">+</span> <span class="n">SZ_16K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_ID_US2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_ID_US2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">atmel_uart_data</span> <span class="n">uart2_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">use_dma_tx</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_dma_rx</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u64</span> <span class="n">uart2_dmamask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9rl_uart2_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;atmel_usart&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">dma_mask</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">uart2_dmamask</span><span class="p">,</span>
				<span class="p">.</span><span class="n">coherent_dma_mask</span>	<span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
				<span class="p">.</span><span class="n">platform_data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">uart2_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">uart2_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">uart2_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">configure_usart2_pins</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">pins</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA13</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>		<span class="cm">/* TXD2 */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA14</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* RXD2 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_UART_RTS</span><span class="p">)</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA29</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* RTS2 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_UART_CTS</span><span class="p">)</span>
		<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PA30</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* CTS2 */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">uart3_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_US3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_BASE_US3</span> <span class="o">+</span> <span class="n">SZ_16K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_ID_US3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AT91SAM9RL_ID_US3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">atmel_uart_data</span> <span class="n">uart3_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">use_dma_tx</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_dma_rx</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u64</span> <span class="n">uart3_dmamask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at91sam9rl_uart3_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;atmel_usart&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">dma_mask</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">uart3_dmamask</span><span class="p">,</span>
				<span class="p">.</span><span class="n">coherent_dma_mask</span>	<span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
				<span class="p">.</span><span class="n">platform_data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">uart3_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">uart3_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">uart3_resources</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">configure_usart3_pins</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">pins</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PB0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>		<span class="cm">/* TXD3 */</span>
	<span class="n">at91_set_A_periph</span><span class="p">(</span><span class="n">AT91_PIN_PB1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* RXD3 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_UART_RTS</span><span class="p">)</span>
		<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PD4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* RTS3 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&amp;</span> <span class="n">ATMEL_UART_CTS</span><span class="p">)</span>
		<span class="n">at91_set_B_periph</span><span class="p">(</span><span class="n">AT91_PIN_PD3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* CTS3 */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">__initdata</span> <span class="n">at91_uarts</span><span class="p">[</span><span class="n">ATMEL_MAX_UART</span><span class="p">];</span>	<span class="cm">/* the UARTs to use */</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_register_uart</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">portnr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">pins</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atmel_uart_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:		<span class="cm">/* DBGU */</span>
			<span class="n">pdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">at91sam9rl_dbgu_device</span><span class="p">;</span>
			<span class="n">configure_dbgu_pins</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AT91SAM9RL_ID_US0</span>:
			<span class="n">pdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">at91sam9rl_uart0_device</span><span class="p">;</span>
			<span class="n">configure_usart0_pins</span><span class="p">(</span><span class="n">pins</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AT91SAM9RL_ID_US1</span>:
			<span class="n">pdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">at91sam9rl_uart1_device</span><span class="p">;</span>
			<span class="n">configure_usart1_pins</span><span class="p">(</span><span class="n">pins</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AT91SAM9RL_ID_US2</span>:
			<span class="n">pdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">at91sam9rl_uart2_device</span><span class="p">;</span>
			<span class="n">configure_usart2_pins</span><span class="p">(</span><span class="n">pins</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AT91SAM9RL_ID_US3</span>:
			<span class="n">pdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">at91sam9rl_uart3_device</span><span class="p">;</span>
			<span class="n">configure_usart3_pins</span><span class="p">(</span><span class="n">pins</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pdata</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">=</span> <span class="n">portnr</span><span class="p">;</span>		<span class="cm">/* update to mapped ID */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">portnr</span> <span class="o">&lt;</span> <span class="n">ATMEL_MAX_UART</span><span class="p">)</span>
		<span class="n">at91_uarts</span><span class="p">[</span><span class="n">portnr</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_serial</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATMEL_MAX_UART</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">at91_uarts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">platform_device_register</span><span class="p">(</span><span class="n">at91_uarts</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_register_uart</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">portnr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">pins</span><span class="p">)</span> <span class="p">{}</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at91_add_device_serial</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>


<span class="cm">/* -------------------------------------------------------------------- */</span>

<span class="cm">/*</span>
<span class="cm"> * These devices are always present and don&#39;t need any board-specific</span>
<span class="cm"> * setup.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">at91_add_standard_devices</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">at91_add_device_hdmac</span><span class="p">();</span>
	<span class="n">at91_add_device_rtc</span><span class="p">();</span>
	<span class="n">at91_add_device_rtt</span><span class="p">();</span>
	<span class="n">at91_add_device_watchdog</span><span class="p">();</span>
	<span class="n">at91_add_device_tc</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">arch_initcall</span><span class="p">(</span><span class="n">at91_add_standard_devices</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
