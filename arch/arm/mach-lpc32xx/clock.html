<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › mach-lpc32xx › clock.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>clock.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * arch/arm/mach-lpc32xx/clock.c</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Kevin Wells &lt;kevin.wells@nxp.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2010 NXP Semiconductors</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * LPC32xx clock management driver overview</span>
<span class="cm"> *</span>
<span class="cm"> * The LPC32XX contains a number of high level system clocks that can be</span>
<span class="cm"> * generated from different sources. These system clocks are used to</span>
<span class="cm"> * generate the CPU and bus rates and the individual peripheral clocks in</span>
<span class="cm"> * the system. When Linux is started by the boot loader, the system</span>
<span class="cm"> * clocks are already running. Stopping a system clock during normal</span>
<span class="cm"> * Linux operation should never be attempted, as peripherals that require</span>
<span class="cm"> * those clocks will quit working (ie, DRAM).</span>
<span class="cm"> *</span>
<span class="cm"> * The LPC32xx high level clock tree looks as follows. Clocks marked with</span>
<span class="cm"> * an asterisk are always on and cannot be disabled. Clocks marked with</span>
<span class="cm"> * an ampersand can only be disabled in CPU suspend mode. Clocks marked</span>
<span class="cm"> * with a caret are always on if it is the selected clock for the SYSCLK</span>
<span class="cm"> * source. The clock that isn&#39;t used for SYSCLK can be enabled and</span>
<span class="cm"> * disabled normally.</span>
<span class="cm"> *                               32KHz oscillator*</span>
<span class="cm"> *                               /      |      \</span>
<span class="cm"> *                             RTC*   PLL397^ TOUCH</span>
<span class="cm"> *                                     /</span>
<span class="cm"> *               Main oscillator^     /</span>
<span class="cm"> *                   |        \      /</span>
<span class="cm"> *                   |         SYSCLK&amp;</span>
<span class="cm"> *                   |            \</span>
<span class="cm"> *                   |             \</span>
<span class="cm"> *                USB_PLL       HCLK_PLL&amp;</span>
<span class="cm"> *                   |           |    |</span>
<span class="cm"> *            USB host/device  PCLK&amp;  |</span>
<span class="cm"> *                               |    |</span>
<span class="cm"> *                             Peripherals</span>
<span class="cm"> *</span>
<span class="cm"> * The CPU and chip bus rates are derived from the HCLK PLL, which can</span>
<span class="cm"> * generate various clock rates up to 266MHz and beyond. The internal bus</span>
<span class="cm"> * rates (PCLK and HCLK) are generated from dividers based on the HCLK</span>
<span class="cm"> * PLL rate. HCLK can be a ratio of 1:1, 1:2, or 1:4 or HCLK PLL rate,</span>
<span class="cm"> * while PCLK can be 1:1 to 1:32 of HCLK PLL rate. Most peripherals high</span>
<span class="cm"> * level clocks are based on either HCLK or PCLK, but have their own</span>
<span class="cm"> * dividers as part of the IP itself. Because of this, the system clock</span>
<span class="cm"> * rates should not be changed.</span>
<span class="cm"> *</span>
<span class="cm"> * The HCLK PLL is clocked from SYSCLK, which can be derived from the</span>
<span class="cm"> * main oscillator or PLL397. PLL397 generates a rate that is 397 times</span>
<span class="cm"> * the 32KHz oscillator rate. The main oscillator runs at the selected</span>
<span class="cm"> * oscillator/crystal rate on the mosc_in pin of the LPC32xx. This rate</span>
<span class="cm"> * is normally 13MHz, but depends on the selection of external crystals</span>
<span class="cm"> * or oscillators. If USB operation is required, the main oscillator must</span>
<span class="cm"> * be used in the system.</span>
<span class="cm"> *</span>
<span class="cm"> * Switching SYSCLK between sources during normal Linux operation is not</span>
<span class="cm"> * supported. SYSCLK is preset in the bootloader. Because of the</span>
<span class="cm"> * complexities of clock management during clock frequency changes,</span>
<span class="cm"> * there are some limitations to the clock driver explained below:</span>
<span class="cm"> * - The PLL397 and main oscillator can be enabled and disabled by the</span>
<span class="cm"> *   clk_enable() and clk_disable() functions unless SYSCLK is based</span>
<span class="cm"> *   on that clock. This allows the other oscillator that isn&#39;t driving</span>
<span class="cm"> *   the HCLK PLL to be used as another system clock that can be routed</span>
<span class="cm"> *   to an external pin.</span>
<span class="cm"> * - The muxed SYSCLK input and HCLK_PLL rate cannot be changed with</span>
<span class="cm"> *   this driver.</span>
<span class="cm"> * - HCLK and PCLK rates cannot be changed as part of this driver.</span>
<span class="cm"> * - Most peripherals have their own dividers are part of the peripheral</span>
<span class="cm"> *   block. Changing SYSCLK, HCLK PLL, HCLK, or PCLK sources or rates</span>
<span class="cm"> *   will also impact the individual peripheral rates.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/amba/bus.h&gt;</span>
<span class="cp">#include &lt;linux/amba/clcd.h&gt;</span>
<span class="cp">#include &lt;linux/clkdev.h&gt;</span>

<span class="cp">#include &lt;mach/hardware.h&gt;</span>
<span class="cp">#include &lt;mach/platform.h&gt;</span>
<span class="cp">#include &quot;clock.h&quot;</span>
<span class="cp">#include &quot;common.h&quot;</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">global_clkregs_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">usb_pll_enable</span><span class="p">,</span> <span class="n">usb_pll_valid</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_armpll</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_usbpll</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Post divider values for PLLs based on selected register value</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">pll_postdivs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">local_return_parent_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * If a clock has a rate of 0, then it inherits it&#39;s parent</span>
<span class="cm">	 * clock rate</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">clk</span> <span class="o">=</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* 32KHz clock has a fixed rate and is not stoppable */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">osc_32KHz</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">rate</span>		<span class="o">=</span> <span class="n">LPC32XX_CLOCK_OSC_FREQ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">local_return_parent_rate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">local_pll397_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">LPC32XX_CLKPWR_PLL397_CTRL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">LPC32XX_CLKPWR_SYSCTRL_PLL397_DIS</span><span class="p">;</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">LPC32XX_CLKPWR_PLL397_CTRL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Enable PLL397 */</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LPC32XX_CLKPWR_SYSCTRL_PLL397_DIS</span><span class="p">;</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">LPC32XX_CLKPWR_PLL397_CTRL</span><span class="p">);</span>

		<span class="cm">/* Wait for PLL397 lock */</span>
		<span class="k">while</span> <span class="p">(((</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">LPC32XX_CLKPWR_PLL397_CTRL</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">LPC32XX_CLKPWR_SYSCTRL_PLL397_STS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
			<span class="n">cpu_relax</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">LPC32XX_CLKPWR_PLL397_CTRL</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">LPC32XX_CLKPWR_SYSCTRL_PLL397_STS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">local_oscmain_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">LPC32XX_CLKPWR_MAIN_OSC_CTRL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">LPC32XX_CLKPWR_MOSC_DISABLE</span><span class="p">;</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">LPC32XX_CLKPWR_MAIN_OSC_CTRL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Enable main oscillator */</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LPC32XX_CLKPWR_MOSC_DISABLE</span><span class="p">;</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">LPC32XX_CLKPWR_MAIN_OSC_CTRL</span><span class="p">);</span>

		<span class="cm">/* Wait for main oscillator to start */</span>
		<span class="k">while</span> <span class="p">(((</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">LPC32XX_CLKPWR_MAIN_OSC_CTRL</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">LPC32XX_CLKPWR_MOSC_DISABLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
			<span class="n">cpu_relax</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">LPC32XX_CLKPWR_MAIN_OSC_CTRL</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">LPC32XX_CLKPWR_MOSC_DISABLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">osc_pll397</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">osc_32KHz</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">local_pll397_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate</span>		<span class="o">=</span> <span class="n">LPC32XX_CLOCK_OSC_FREQ</span> <span class="o">*</span> <span class="mi">397</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">local_return_parent_rate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">osc_main</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">local_oscmain_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate</span>		<span class="o">=</span> <span class="n">LPC32XX_MAIN_OSC_FREQ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">local_return_parent_rate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_sys</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Convert a PLL register value to a PLL output frequency</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">clk_get_pllrate_from_reg</span><span class="p">(</span><span class="n">u32</span> <span class="n">inputclk</span><span class="p">,</span> <span class="n">u32</span> <span class="n">regval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">clk_pll_setup</span> <span class="n">pllcfg</span><span class="p">;</span>

	<span class="n">pllcfg</span><span class="p">.</span><span class="n">cco_bypass_b15</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pllcfg</span><span class="p">.</span><span class="n">direct_output_b14</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pllcfg</span><span class="p">.</span><span class="n">fdbk_div_ctrl_b13</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">regval</span> <span class="o">&amp;</span> <span class="n">LPC32XX_CLKPWR_HCLKPLL_CCO_BYPASS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pllcfg</span><span class="p">.</span><span class="n">cco_bypass_b15</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">regval</span> <span class="o">&amp;</span> <span class="n">LPC32XX_CLKPWR_HCLKPLL_POSTDIV_BYPASS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pllcfg</span><span class="p">.</span><span class="n">direct_output_b14</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">regval</span> <span class="o">&amp;</span> <span class="n">LPC32XX_CLKPWR_HCLKPLL_FDBK_SEL_FCLK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pllcfg</span><span class="p">.</span><span class="n">fdbk_div_ctrl_b13</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pllcfg</span><span class="p">.</span><span class="n">pll_m</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">((</span><span class="n">regval</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">pllcfg</span><span class="p">.</span><span class="n">pll_n</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">((</span><span class="n">regval</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">);</span>
	<span class="n">pllcfg</span><span class="p">.</span><span class="n">pll_p</span> <span class="o">=</span> <span class="n">pll_postdivs</span><span class="p">[((</span><span class="n">regval</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)];</span>

	<span class="k">return</span> <span class="n">clk_check_pll_setup</span><span class="p">(</span><span class="n">inputclk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pllcfg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Setup the HCLK PLL with a PLL structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">local_clk_pll_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk_pll_setup</span> <span class="o">*</span><span class="n">PllSetup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tv</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PllSetup</span><span class="o">-&gt;</span><span class="n">analog_on</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">LPC32XX_CLKPWR_HCLKPLL_POWER_UP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PllSetup</span><span class="o">-&gt;</span><span class="n">cco_bypass_b15</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">LPC32XX_CLKPWR_HCLKPLL_CCO_BYPASS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PllSetup</span><span class="o">-&gt;</span><span class="n">direct_output_b14</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">LPC32XX_CLKPWR_HCLKPLL_POSTDIV_BYPASS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PllSetup</span><span class="o">-&gt;</span><span class="n">fdbk_div_ctrl_b13</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">LPC32XX_CLKPWR_HCLKPLL_FDBK_SEL_FCLK</span><span class="p">;</span>

	<span class="n">tv</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">PllSetup</span><span class="o">-&gt;</span><span class="n">pll_p</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">PllSetup</span><span class="o">-&gt;</span><span class="n">pll_p</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">tv</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">LPC32XX_CLKPWR_HCLKPLL_POSTDIV_2POW</span><span class="p">(</span><span class="n">tv</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">LPC32XX_CLKPWR_HCLKPLL_PREDIV_PLUS1</span><span class="p">(</span><span class="n">PllSetup</span><span class="o">-&gt;</span><span class="n">pll_n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">LPC32XX_CLKPWR_HCLKPLL_PLLM</span><span class="p">(</span><span class="n">PllSetup</span><span class="o">-&gt;</span><span class="n">pll_m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Update the ARM core PLL frequency rate variable from the actual PLL setting</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">local_update_armpll_rate</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">clkin</span><span class="p">,</span> <span class="n">pllreg</span><span class="p">;</span>

	<span class="n">clkin</span> <span class="o">=</span> <span class="n">clk_armpll</span><span class="p">.</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">;</span>
	<span class="n">pllreg</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">LPC32XX_CLKPWR_HCLKPLL_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1FFFF</span><span class="p">;</span>

	<span class="n">clk_armpll</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="n">clk_get_pllrate_from_reg</span><span class="p">(</span><span class="n">clkin</span><span class="p">,</span> <span class="n">pllreg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Find a PLL configuration for the selected input frequency</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">local_clk_find_pll_cfg</span><span class="p">(</span><span class="n">u32</span> <span class="n">pllin_freq</span><span class="p">,</span> <span class="n">u32</span> <span class="n">target_freq</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">clk_pll_setup</span> <span class="o">*</span><span class="n">pllsetup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ifreq</span><span class="p">,</span> <span class="n">freqtol</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">fclkout</span><span class="p">;</span>

	<span class="cm">/* Determine frequency tolerance limits */</span>
	<span class="n">freqtol</span> <span class="o">=</span> <span class="n">target_freq</span> <span class="o">/</span> <span class="mi">250</span><span class="p">;</span>
	<span class="n">ifreq</span> <span class="o">=</span> <span class="n">pllin_freq</span><span class="p">;</span>

	<span class="cm">/* Is direct bypass mode possible? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">pllin_freq</span> <span class="o">-</span> <span class="n">target_freq</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">freqtol</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pllsetup</span><span class="o">-&gt;</span><span class="n">analog_on</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pllsetup</span><span class="o">-&gt;</span><span class="n">cco_bypass_b15</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pllsetup</span><span class="o">-&gt;</span><span class="n">direct_output_b14</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pllsetup</span><span class="o">-&gt;</span><span class="n">fdbk_div_ctrl_b13</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pllsetup</span><span class="o">-&gt;</span><span class="n">pll_p</span> <span class="o">=</span> <span class="n">pll_postdivs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">pllsetup</span><span class="o">-&gt;</span><span class="n">pll_n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pllsetup</span><span class="o">-&gt;</span><span class="n">pll_m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">clk_check_pll_setup</span><span class="p">(</span><span class="n">ifreq</span><span class="p">,</span> <span class="n">pllsetup</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">target_freq</span> <span class="o">&lt;=</span> <span class="n">ifreq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pllsetup</span><span class="o">-&gt;</span><span class="n">analog_on</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pllsetup</span><span class="o">-&gt;</span><span class="n">cco_bypass_b15</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pllsetup</span><span class="o">-&gt;</span><span class="n">direct_output_b14</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pllsetup</span><span class="o">-&gt;</span><span class="n">fdbk_div_ctrl_b13</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pllsetup</span><span class="o">-&gt;</span><span class="n">pll_n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pllsetup</span><span class="o">-&gt;</span><span class="n">pll_m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pllsetup</span><span class="o">-&gt;</span><span class="n">pll_p</span> <span class="o">=</span> <span class="n">pll_postdivs</span><span class="p">[</span><span class="n">p</span><span class="p">];</span>
			<span class="n">fclkout</span> <span class="o">=</span> <span class="n">clk_check_pll_setup</span><span class="p">(</span><span class="n">ifreq</span><span class="p">,</span> <span class="n">pllsetup</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">target_freq</span> <span class="o">-</span> <span class="n">fclkout</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">freqtol</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">fclkout</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Is direct mode possible? */</span>
	<span class="n">pllsetup</span><span class="o">-&gt;</span><span class="n">analog_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pllsetup</span><span class="o">-&gt;</span><span class="n">cco_bypass_b15</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pllsetup</span><span class="o">-&gt;</span><span class="n">direct_output_b14</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pllsetup</span><span class="o">-&gt;</span><span class="n">fdbk_div_ctrl_b13</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pllsetup</span><span class="o">-&gt;</span><span class="n">pll_p</span> <span class="o">=</span> <span class="n">pll_postdivs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">m</span> <span class="o">&lt;=</span> <span class="mi">256</span><span class="p">;</span> <span class="n">m</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Compute output frequency for this value */</span>
			<span class="n">pllsetup</span><span class="o">-&gt;</span><span class="n">pll_n</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
			<span class="n">pllsetup</span><span class="o">-&gt;</span><span class="n">pll_m</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
			<span class="n">fclkout</span> <span class="o">=</span> <span class="n">clk_check_pll_setup</span><span class="p">(</span><span class="n">ifreq</span><span class="p">,</span>
				<span class="n">pllsetup</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">target_freq</span> <span class="o">-</span> <span class="n">fclkout</span><span class="p">)</span> <span class="o">&lt;=</span>
				<span class="n">freqtol</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">fclkout</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Is integer mode possible? */</span>
	<span class="n">pllsetup</span><span class="o">-&gt;</span><span class="n">analog_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pllsetup</span><span class="o">-&gt;</span><span class="n">cco_bypass_b15</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pllsetup</span><span class="o">-&gt;</span><span class="n">direct_output_b14</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pllsetup</span><span class="o">-&gt;</span><span class="n">fdbk_div_ctrl_b13</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">m</span> <span class="o">&lt;=</span> <span class="mi">256</span><span class="p">;</span> <span class="n">m</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Compute output frequency */</span>
				<span class="n">pllsetup</span><span class="o">-&gt;</span><span class="n">pll_p</span> <span class="o">=</span> <span class="n">pll_postdivs</span><span class="p">[</span><span class="n">p</span><span class="p">];</span>
				<span class="n">pllsetup</span><span class="o">-&gt;</span><span class="n">pll_n</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
				<span class="n">pllsetup</span><span class="o">-&gt;</span><span class="n">pll_m</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
				<span class="n">fclkout</span> <span class="o">=</span> <span class="n">clk_check_pll_setup</span><span class="p">(</span>
					<span class="n">ifreq</span><span class="p">,</span> <span class="n">pllsetup</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">target_freq</span> <span class="o">-</span> <span class="n">fclkout</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">freqtol</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">fclkout</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Try non-integer mode */</span>
	<span class="n">pllsetup</span><span class="o">-&gt;</span><span class="n">analog_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pllsetup</span><span class="o">-&gt;</span><span class="n">cco_bypass_b15</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pllsetup</span><span class="o">-&gt;</span><span class="n">direct_output_b14</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pllsetup</span><span class="o">-&gt;</span><span class="n">fdbk_div_ctrl_b13</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">m</span> <span class="o">&lt;=</span> <span class="mi">256</span><span class="p">;</span> <span class="n">m</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Compute output frequency */</span>
				<span class="n">pllsetup</span><span class="o">-&gt;</span><span class="n">pll_p</span> <span class="o">=</span> <span class="n">pll_postdivs</span><span class="p">[</span><span class="n">p</span><span class="p">];</span>
				<span class="n">pllsetup</span><span class="o">-&gt;</span><span class="n">pll_n</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
				<span class="n">pllsetup</span><span class="o">-&gt;</span><span class="n">pll_m</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
				<span class="n">fclkout</span> <span class="o">=</span> <span class="n">clk_check_pll_setup</span><span class="p">(</span>
					<span class="n">ifreq</span><span class="p">,</span> <span class="n">pllsetup</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">target_freq</span> <span class="o">-</span> <span class="n">fclkout</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">freqtol</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">fclkout</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_armpll</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">clk_sys</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">local_return_parent_rate</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Setup the USB PLL with a PLL structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">local_clk_usbpll_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk_pll_setup</span> <span class="o">*</span><span class="n">pHCLKPllSetup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">local_clk_pll_setup</span><span class="p">(</span><span class="n">pHCLKPllSetup</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">LPC32XX_CLKPWR_USB_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1FFFF</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">LPC32XX_CLKPWR_USB_CTRL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">clk_check_pll_setup</span><span class="p">(</span><span class="n">clk_usbpll</span><span class="p">.</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">,</span>
		<span class="n">pHCLKPllSetup</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">local_usbpll_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">LPC32XX_CLKPWR_USB_CTRL</span><span class="p">);</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">LPC32XX_CLKPWR_USBCTRL_CLK_EN2</span> <span class="o">|</span>
		<span class="n">LPC32XX_CLKPWR_USBCTRL_PLL_PWRUP</span><span class="p">),</span>
		<span class="n">LPC32XX_CLKPWR_USB_CTRL</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LPC32XX_CLKPWR_USBCTRL_CLK_EN1</span><span class="p">,</span>
		<span class="n">LPC32XX_CLKPWR_USB_CTRL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span> <span class="o">&amp;&amp;</span> <span class="n">usb_pll_valid</span> <span class="o">&amp;&amp;</span> <span class="n">usb_pll_enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * If the PLL rate has been previously set, then the rate</span>
<span class="cm">		 * in the PLL register is valid and can be enabled here.</span>
<span class="cm">		 * Otherwise, it needs to be enabled as part of setrate.</span>
<span class="cm">		 */</span>

		<span class="cm">/*</span>
<span class="cm">		 * Gate clock into PLL</span>
<span class="cm">		 */</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">LPC32XX_CLKPWR_USBCTRL_CLK_EN1</span><span class="p">;</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">LPC32XX_CLKPWR_USB_CTRL</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Enable PLL</span>
<span class="cm">		 */</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">LPC32XX_CLKPWR_USBCTRL_PLL_PWRUP</span><span class="p">;</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">LPC32XX_CLKPWR_USB_CTRL</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Wait for PLL to lock</span>
<span class="cm">		 */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">LPC32XX_CLKPWR_USB_CTRL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">LPC32XX_CLKPWR_USBCTRL_PLL_STS</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Gate clock from PLL if PLL is locked</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="n">reg</span> <span class="o">|</span> <span class="n">LPC32XX_CLKPWR_USBCTRL_CLK_EN2</span><span class="p">,</span>
				<span class="n">LPC32XX_CLKPWR_USB_CTRL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">LPC32XX_CLKPWR_USBCTRL_CLK_EN1</span> <span class="o">|</span>
				<span class="n">LPC32XX_CLKPWR_USBCTRL_PLL_PWRUP</span><span class="p">),</span>
				<span class="n">LPC32XX_CLKPWR_USB_CTRL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">enable</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">usb_pll_valid</span>  <span class="o">&amp;&amp;</span> <span class="n">usb_pll_enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_pll_valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">usb_pll_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">local_usbpll_round_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">clkin</span><span class="p">,</span> <span class="n">usbdiv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk_pll_setup</span> <span class="n">pllsetup</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Unlike other clocks, this clock has a KHz input rate, so bump</span>
<span class="cm">	 * it up to work with the PLL function</span>
<span class="cm">	 */</span>
	<span class="n">rate</span> <span class="o">=</span> <span class="n">rate</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">clkin</span> <span class="o">=</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">get_rate</span><span class="p">(</span><span class="n">clk</span><span class="p">);</span>
	<span class="n">usbdiv</span> <span class="o">=</span> <span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">LPC32XX_CLKPWR_USBCLK_PDIV</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="n">LPC32XX_CLKPWR_USBPDIV_PLL_MASK</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">clkin</span> <span class="o">=</span> <span class="n">clkin</span> <span class="o">/</span> <span class="n">usbdiv</span><span class="p">;</span>

	<span class="cm">/* Try to find a good rate setup */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local_clk_find_pll_cfg</span><span class="p">(</span><span class="n">clkin</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pllsetup</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">clk_check_pll_setup</span><span class="p">(</span><span class="n">clkin</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pllsetup</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">local_usbpll_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">clkin</span><span class="p">,</span> <span class="n">usbdiv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk_pll_setup</span> <span class="n">pllsetup</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Unlike other clocks, this clock has a KHz input rate, so bump</span>
<span class="cm">	 * it up to work with the PLL function</span>
<span class="cm">	 */</span>
	<span class="n">rate</span> <span class="o">=</span> <span class="n">rate</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">clkin</span> <span class="o">=</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">get_rate</span><span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="n">usbdiv</span> <span class="o">=</span> <span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">LPC32XX_CLKPWR_USBCLK_PDIV</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="n">LPC32XX_CLKPWR_USBPDIV_PLL_MASK</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">clkin</span> <span class="o">=</span> <span class="n">clkin</span> <span class="o">/</span> <span class="n">usbdiv</span><span class="p">;</span>

	<span class="cm">/* Try to find a good rate setup */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local_clk_find_pll_cfg</span><span class="p">(</span><span class="n">clkin</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pllsetup</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable PLL clocks during PLL change</span>
<span class="cm">	 */</span>
	<span class="n">local_usbpll_enable</span><span class="p">(</span><span class="n">clk</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pllsetup</span><span class="p">.</span><span class="n">analog_on</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">local_clk_usbpll_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pllsetup</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Start USB PLL and check PLL status</span>
<span class="cm">	 */</span>

	<span class="n">usb_pll_valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">usb_pll_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">local_usbpll_enable</span><span class="p">(</span><span class="n">clk</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">clk</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="n">clk_check_pll_setup</span><span class="p">(</span><span class="n">clkin</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pllsetup</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_usbpll</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">osc_main</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rate</span>	<span class="o">=</span> <span class="n">local_usbpll_set_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">local_usbpll_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate</span>		<span class="o">=</span> <span class="mi">48000</span><span class="p">,</span> <span class="cm">/* In KHz */</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">local_return_parent_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">round_rate</span>	<span class="o">=</span> <span class="n">local_usbpll_round_rate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">clk_get_hclk_div</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">hclkdivs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">};</span>
	<span class="k">return</span> <span class="n">hclkdivs</span><span class="p">[</span><span class="n">LPC32XX_CLKPWR_HCLKDIV_DIV_2POW</span><span class="p">(</span>
		<span class="n">__raw_readl</span><span class="p">(</span><span class="n">LPC32XX_CLKPWR_HCLK_DIV</span><span class="p">))];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_hclk</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">clk_armpll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">local_return_parent_rate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_pclk</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">clk_armpll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">local_return_parent_rate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">local_onoff_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">enable_reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">enable_mask</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">enable_mask</span><span class="p">;</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">enable_reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Peripheral clock sources */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_timer0</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">clk_pclk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">local_onoff_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_reg</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_TIMERS_PWMS_CLK_CTRL_1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_TMRPWMCLK_TIMER0_EN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">local_return_parent_rate</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_timer1</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">clk_pclk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">local_onoff_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_reg</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_TIMERS_PWMS_CLK_CTRL_1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_TMRPWMCLK_TIMER1_EN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">local_return_parent_rate</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_timer2</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">clk_pclk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">local_onoff_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_reg</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_TIMERS_PWMS_CLK_CTRL_1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_TMRPWMCLK_TIMER2_EN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">local_return_parent_rate</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_timer3</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">clk_pclk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">local_onoff_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_reg</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_TIMERS_PWMS_CLK_CTRL_1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_TMRPWMCLK_TIMER3_EN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">local_return_parent_rate</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_wdt</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">clk_pclk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">local_onoff_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_reg</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_TIMER_CLK_CTRL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_PWMCLK_WDOG_EN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">local_return_parent_rate</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_vfp9</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">clk_pclk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">local_onoff_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_reg</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_DEBUG_CTRL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_VFP_CLOCK_ENABLE_BIT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">local_return_parent_rate</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_dma</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">clk_hclk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">local_onoff_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_reg</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_DMA_CLK_CTRL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_DMACLKCTRL_CLK_EN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">local_return_parent_rate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_uart3</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">clk_pclk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">local_onoff_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_reg</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_UART_CLK_CTRL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_UARTCLKCTRL_UART3_EN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">local_return_parent_rate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_uart4</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">clk_pclk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">local_onoff_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_reg</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_UART_CLK_CTRL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_UARTCLKCTRL_UART4_EN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">local_return_parent_rate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_uart5</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">clk_pclk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">local_onoff_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_reg</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_UART_CLK_CTRL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_UARTCLKCTRL_UART5_EN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">local_return_parent_rate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_uart6</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">clk_pclk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">local_onoff_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_reg</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_UART_CLK_CTRL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_UARTCLKCTRL_UART6_EN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">local_return_parent_rate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_i2c0</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">clk_hclk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">local_onoff_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_reg</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_I2C_CLK_CTRL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_I2CCLK_I2C1CLK_EN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">local_return_parent_rate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_i2c1</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">clk_hclk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">local_onoff_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_reg</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_I2C_CLK_CTRL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_I2CCLK_I2C2CLK_EN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">local_return_parent_rate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_i2c2</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">clk_pclk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">local_onoff_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_reg</span>	<span class="o">=</span> <span class="n">io_p2v</span><span class="p">(</span><span class="n">LPC32XX_USB_BASE</span> <span class="o">+</span> <span class="mh">0xFF4</span><span class="p">),</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="mh">0x4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">local_return_parent_rate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_ssp0</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">clk_hclk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">local_onoff_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_reg</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_SSP_CLK_CTRL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_SSPCTRL_SSPCLK0_EN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">local_return_parent_rate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_ssp1</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">clk_hclk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">local_onoff_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_reg</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_SSP_CLK_CTRL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_SSPCTRL_SSPCLK1_EN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">local_return_parent_rate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_kscan</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">osc_32KHz</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">local_onoff_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_reg</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_KEY_CLK_CTRL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_KEYCLKCTRL_CLK_EN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">local_return_parent_rate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_nand</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">clk_hclk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">local_onoff_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_reg</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_NAND_CLK_CTRL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_NANDCLK_SLCCLK_EN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">local_return_parent_rate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_i2s0</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">clk_hclk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">local_onoff_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_reg</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_I2S_CLK_CTRL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_I2SCTRL_I2SCLK0_EN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">local_return_parent_rate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_i2s1</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">clk_hclk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">local_onoff_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_reg</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_I2S_CLK_CTRL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_I2SCTRL_I2SCLK1_EN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">local_return_parent_rate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_net</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">clk_hclk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">local_onoff_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_reg</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_MACCLK_CTRL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="p">(</span><span class="n">LPC32XX_CLKPWR_MACCTRL_DMACLK_EN</span> <span class="o">|</span>
		<span class="n">LPC32XX_CLKPWR_MACCTRL_MMIOCLK_EN</span> <span class="o">|</span>
		<span class="n">LPC32XX_CLKPWR_MACCTRL_HRCCLK_EN</span><span class="p">),</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">local_return_parent_rate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_rtc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">osc_32KHz</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="cm">/* 1 Hz */</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">local_return_parent_rate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_usbd</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">clk_usbpll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">local_onoff_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_reg</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_USB_CTRL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_USBCTRL_HCLK_EN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">local_return_parent_rate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsc_onoff_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* Make sure 32KHz clock is the selected clock */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">LPC32XX_CLKPWR_ADC_CLK_CTRL_1</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LPC32XX_CLKPWR_ADCCTRL1_PCLK_SEL</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">LPC32XX_CLKPWR_ADC_CLK_CTRL_1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">enable_reg</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">enable_mask</span><span class="p">,</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">enable_reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_tsc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">osc_32KHz</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">tsc_onoff_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_reg</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_ADC_CLK_CTRL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_ADC32CLKCTRL_CLK_EN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">local_return_parent_rate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">adc_onoff_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">divider</span><span class="p">;</span>

	<span class="cm">/* Use PERIPH_CLOCK */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">LPC32XX_CLKPWR_ADC_CLK_CTRL_1</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">LPC32XX_CLKPWR_ADCCTRL1_PCLK_SEL</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Set clock divider so that we have equal to or less than</span>
<span class="cm">	 * 4.5MHz clock at ADC</span>
<span class="cm">	 */</span>
	<span class="n">divider</span> <span class="o">=</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">get_rate</span><span class="p">(</span><span class="n">clk</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4500000</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">divider</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">LPC32XX_CLKPWR_ADC_CLK_CTRL_1</span><span class="p">);</span>

	<span class="cm">/* synchronize rate of this clock w/ actual HW setting */</span>
	<span class="n">clk</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">get_rate</span><span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span> <span class="o">/</span> <span class="n">divider</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">enable_reg</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">enable_mask</span><span class="p">,</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">enable_reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_adc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">clk_pclk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">adc_onoff_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_reg</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_ADC_CLK_CTRL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_ADC32CLKCTRL_CLK_EN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">local_return_parent_rate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_onoff_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">LPC32XX_CLKPWR_MS_CTRL</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="o">~</span><span class="n">LPC32XX_CLKPWR_MSCARD_SDCARD_EN</span><span class="p">;</span>

	<span class="cm">/* If rate is 0, disable clock */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">LPC32XX_CLKPWR_MSCARD_SDCARD_EN</span><span class="p">;</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">LPC32XX_CLKPWR_MS_CTRL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">mmc_get_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">div</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">oldclk</span><span class="p">;</span>

	<span class="cm">/* The MMC clock must be on when accessing an MMC register */</span>
	<span class="n">oldclk</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">LPC32XX_CLKPWR_MS_CTRL</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">oldclk</span> <span class="o">|</span> <span class="n">LPC32XX_CLKPWR_MSCARD_SDCARD_EN</span><span class="p">,</span>
		<span class="n">LPC32XX_CLKPWR_MS_CTRL</span><span class="p">);</span>
	<span class="n">div</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">LPC32XX_CLKPWR_MS_CTRL</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">oldclk</span><span class="p">,</span> <span class="n">LPC32XX_CLKPWR_MS_CTRL</span><span class="p">);</span>

	<span class="cm">/* Get the parent clock rate */</span>
	<span class="n">rate</span> <span class="o">=</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">get_rate</span><span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>

	<span class="cm">/* Get the MMC controller clock divider value */</span>
	<span class="n">div</span> <span class="o">=</span> <span class="n">div</span> <span class="o">&amp;</span> <span class="n">LPC32XX_CLKPWR_MSCARD_SDCARD_DIV</span><span class="p">(</span><span class="mh">0xf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">div</span><span class="p">)</span>
		<span class="n">div</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rate</span> <span class="o">/</span> <span class="n">div</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">mmc_round_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">div</span><span class="p">,</span> <span class="n">prate</span><span class="p">;</span>

	<span class="cm">/* Get the parent clock rate */</span>
	<span class="n">prate</span> <span class="o">=</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">get_rate</span><span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;=</span> <span class="n">prate</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">prate</span><span class="p">;</span>

	<span class="n">div</span> <span class="o">=</span> <span class="n">prate</span> <span class="o">/</span> <span class="n">rate</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">div</span> <span class="o">&gt;</span> <span class="mh">0xf</span><span class="p">)</span>
		<span class="n">div</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">prate</span> <span class="o">/</span> <span class="n">div</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">oldclk</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">prate</span><span class="p">,</span> <span class="n">div</span><span class="p">,</span> <span class="n">crate</span> <span class="o">=</span> <span class="n">mmc_round_rate</span><span class="p">(</span><span class="n">clk</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>

	<span class="n">prate</span> <span class="o">=</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">get_rate</span><span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>

	<span class="n">div</span> <span class="o">=</span> <span class="n">prate</span> <span class="o">/</span> <span class="n">crate</span><span class="p">;</span>

	<span class="cm">/* The MMC clock must be on when accessing an MMC register */</span>
	<span class="n">oldclk</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">LPC32XX_CLKPWR_MS_CTRL</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">oldclk</span> <span class="o">|</span> <span class="n">LPC32XX_CLKPWR_MSCARD_SDCARD_EN</span><span class="p">,</span>
		<span class="n">LPC32XX_CLKPWR_MS_CTRL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">LPC32XX_CLKPWR_MS_CTRL</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="o">~</span><span class="n">LPC32XX_CLKPWR_MSCARD_SDCARD_DIV</span><span class="p">(</span><span class="mh">0xf</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">LPC32XX_CLKPWR_MSCARD_SDCARD_DIV</span><span class="p">(</span><span class="n">div</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">LPC32XX_CLKPWR_MS_CTRL</span><span class="p">);</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">oldclk</span><span class="p">,</span> <span class="n">LPC32XX_CLKPWR_MS_CTRL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_mmc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">clk_armpll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rate</span>	<span class="o">=</span> <span class="n">mmc_set_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">mmc_get_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">round_rate</span>	<span class="o">=</span> <span class="n">mmc_round_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">mmc_onoff_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_reg</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_MS_CTRL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_MSCARD_SDCARD_EN</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">clcd_get_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">div</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">oldclk</span><span class="p">;</span>

	<span class="cm">/* The LCD clock must be on when accessing an LCD register */</span>
	<span class="n">oldclk</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">LPC32XX_CLKPWR_LCDCLK_CTRL</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">oldclk</span> <span class="o">|</span> <span class="n">LPC32XX_CLKPWR_LCDCTRL_CLK_EN</span><span class="p">,</span>
		<span class="n">LPC32XX_CLKPWR_LCDCLK_CTRL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">io_p2v</span><span class="p">(</span><span class="n">LPC32XX_LCD_BASE</span> <span class="o">+</span> <span class="n">CLCD_TIM2</span><span class="p">));</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">oldclk</span><span class="p">,</span> <span class="n">LPC32XX_CLKPWR_LCDCLK_CTRL</span><span class="p">);</span>

	<span class="n">rate</span> <span class="o">=</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">get_rate</span><span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>

	<span class="cm">/* Only supports internal clocking */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">TIM2_BCD</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rate</span><span class="p">;</span>

	<span class="n">div</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xF8</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">22</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">rate</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="n">div</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">clcd_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">prate</span><span class="p">,</span> <span class="n">div</span><span class="p">,</span> <span class="n">oldclk</span><span class="p">;</span>

	<span class="cm">/* The LCD clock must be on when accessing an LCD register */</span>
	<span class="n">oldclk</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">LPC32XX_CLKPWR_LCDCLK_CTRL</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">oldclk</span> <span class="o">|</span> <span class="n">LPC32XX_CLKPWR_LCDCTRL_CLK_EN</span><span class="p">,</span>
		<span class="n">LPC32XX_CLKPWR_LCDCLK_CTRL</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">io_p2v</span><span class="p">(</span><span class="n">LPC32XX_LCD_BASE</span> <span class="o">+</span> <span class="n">CLCD_TIM2</span><span class="p">))</span> <span class="o">|</span> <span class="n">TIM2_BCD</span><span class="p">;</span>
	<span class="n">prate</span> <span class="o">=</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">get_rate</span><span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&lt;</span> <span class="n">prate</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Find closest divider */</span>
		<span class="n">div</span> <span class="o">=</span> <span class="n">prate</span> <span class="o">/</span> <span class="n">rate</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">div</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">div</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TIM2_BCD</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xF800001F</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">div</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(((</span><span class="n">div</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">27</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">io_p2v</span><span class="p">(</span><span class="n">LPC32XX_LCD_BASE</span> <span class="o">+</span> <span class="n">CLCD_TIM2</span><span class="p">));</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">oldclk</span><span class="p">,</span> <span class="n">LPC32XX_CLKPWR_LCDCLK_CTRL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">clcd_round_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">prate</span><span class="p">,</span> <span class="n">div</span><span class="p">;</span>

	<span class="n">prate</span> <span class="o">=</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">get_rate</span><span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;=</span> <span class="n">prate</span><span class="p">)</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">prate</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">div</span> <span class="o">=</span> <span class="n">prate</span> <span class="o">/</span> <span class="n">rate</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">div</span> <span class="o">&gt;</span> <span class="mh">0x3ff</span><span class="p">)</span>
			<span class="n">div</span> <span class="o">=</span> <span class="mh">0x3ff</span><span class="p">;</span>

		<span class="n">rate</span> <span class="o">=</span> <span class="n">prate</span> <span class="o">/</span> <span class="n">div</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rate</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_lcd</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">clk_hclk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rate</span>	<span class="o">=</span> <span class="n">clcd_set_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">clcd_get_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">round_rate</span>	<span class="o">=</span> <span class="n">clcd_round_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable</span>		<span class="o">=</span> <span class="n">local_onoff_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_reg</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_LCDCLK_CTRL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">LPC32XX_CLKPWR_LCDCTRL_CLK_EN</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">local_clk_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Don&#39;t attempt to disable clock if it has no users */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">usecount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clk</span><span class="o">-&gt;</span><span class="n">usecount</span><span class="o">--</span><span class="p">;</span>

		<span class="cm">/* Only disable clock when it has no more users */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">usecount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">))</span>
			<span class="n">clk</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">(</span><span class="n">clk</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Check parent clocks, they may need to be disabled too */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span>
			<span class="n">local_clk_disable</span><span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">local_clk_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Enable parent clocks first and update use counts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">local_clk_enable</span><span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Only enable clock if it&#39;s currently disabled */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">usecount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">(</span><span class="n">clk</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">clk</span><span class="o">-&gt;</span><span class="n">usecount</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span>
			<span class="n">local_clk_disable</span><span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * clk_enable - inform the system when the clock source should be running.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">clk_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global_clkregs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">local_clk_enable</span><span class="p">(</span><span class="n">clk</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global_clkregs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">clk_enable</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * clk_disable - inform the system when the clock source is no longer required</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">clk_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global_clkregs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">local_clk_disable</span><span class="p">(</span><span class="n">clk</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global_clkregs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">clk_disable</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * clk_get_rate - obtain the current clock rate (in Hz) for a clock source</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">clk_get_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">get_rate</span><span class="p">(</span><span class="n">clk</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">clk_get_rate</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * clk_set_rate - set the clock rate for a clock source</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">clk_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Most system clocks can only be enabled or disabled, with</span>
<span class="cm">	 * the actual rate set as part of the peripheral dividers</span>
<span class="cm">	 * instead of high level clock control</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">set_rate</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">set_rate</span><span class="p">(</span><span class="n">clk</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">clk_set_rate</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * clk_round_rate - adjust a rate to the exact rate a clock can provide</span>
<span class="cm"> */</span>
<span class="kt">long</span> <span class="nf">clk_round_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">round_rate</span><span class="p">)</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">round_rate</span><span class="p">(</span><span class="n">clk</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">get_rate</span><span class="p">(</span><span class="n">clk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rate</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">clk_round_rate</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * clk_set_parent - set the parent clock source for this clock</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">clk_set_parent</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">parent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Clock re-parenting is not supported */</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">clk_set_parent</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * clk_get_parent - get the parent clock source for this clock</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="nf">clk_get_parent</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">clk_get_parent</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk_lookup</span> <span class="n">lookups</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">CLKDEV_INIT</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;osc_32KHz&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">osc_32KHz</span><span class="p">),</span>
	<span class="n">CLKDEV_INIT</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;osc_pll397&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">osc_pll397</span><span class="p">),</span>
	<span class="n">CLKDEV_INIT</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;osc_main&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">osc_main</span><span class="p">),</span>
	<span class="n">CLKDEV_INIT</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;sys_ck&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clk_sys</span><span class="p">),</span>
	<span class="n">CLKDEV_INIT</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;arm_pll_ck&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clk_armpll</span><span class="p">),</span>
	<span class="n">CLKDEV_INIT</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;ck_pll5&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clk_usbpll</span><span class="p">),</span>
	<span class="n">CLKDEV_INIT</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;hclk_ck&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clk_hclk</span><span class="p">),</span>
	<span class="n">CLKDEV_INIT</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;pclk_ck&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clk_pclk</span><span class="p">),</span>
	<span class="n">CLKDEV_INIT</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;timer0_ck&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clk_timer0</span><span class="p">),</span>
	<span class="n">CLKDEV_INIT</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;timer1_ck&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clk_timer1</span><span class="p">),</span>
	<span class="n">CLKDEV_INIT</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;timer2_ck&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clk_timer2</span><span class="p">),</span>
	<span class="n">CLKDEV_INIT</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;timer3_ck&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clk_timer3</span><span class="p">),</span>
	<span class="n">CLKDEV_INIT</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;vfp9_ck&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clk_vfp9</span><span class="p">),</span>
	<span class="n">CLKDEV_INIT</span><span class="p">(</span><span class="s">&quot;pl08xdmac&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clk_dma</span><span class="p">),</span>
	<span class="n">CLKDEV_INIT</span><span class="p">(</span><span class="s">&quot;4003c000.watchdog&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clk_wdt</span><span class="p">),</span>
	<span class="n">CLKDEV_INIT</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;uart3_ck&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clk_uart3</span><span class="p">),</span>
	<span class="n">CLKDEV_INIT</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;uart4_ck&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clk_uart4</span><span class="p">),</span>
	<span class="n">CLKDEV_INIT</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;uart5_ck&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clk_uart5</span><span class="p">),</span>
	<span class="n">CLKDEV_INIT</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;uart6_ck&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clk_uart6</span><span class="p">),</span>
	<span class="n">CLKDEV_INIT</span><span class="p">(</span><span class="s">&quot;400a0000.i2c&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clk_i2c0</span><span class="p">),</span>
	<span class="n">CLKDEV_INIT</span><span class="p">(</span><span class="s">&quot;400a8000.i2c&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clk_i2c1</span><span class="p">),</span>
	<span class="n">CLKDEV_INIT</span><span class="p">(</span><span class="s">&quot;31020300.i2c&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clk_i2c2</span><span class="p">),</span>
	<span class="n">CLKDEV_INIT</span><span class="p">(</span><span class="s">&quot;dev:ssp0&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clk_ssp0</span><span class="p">),</span>
	<span class="n">CLKDEV_INIT</span><span class="p">(</span><span class="s">&quot;dev:ssp1&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clk_ssp1</span><span class="p">),</span>
	<span class="n">CLKDEV_INIT</span><span class="p">(</span><span class="s">&quot;lpc32xx_keys.0&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clk_kscan</span><span class="p">),</span>
	<span class="n">CLKDEV_INIT</span><span class="p">(</span><span class="s">&quot;lpc32xx-nand.0&quot;</span><span class="p">,</span> <span class="s">&quot;nand_ck&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clk_nand</span><span class="p">),</span>
	<span class="n">CLKDEV_INIT</span><span class="p">(</span><span class="s">&quot;40048000.adc&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clk_adc</span><span class="p">),</span>
	<span class="n">CLKDEV_INIT</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;i2s0_ck&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clk_i2s0</span><span class="p">),</span>
	<span class="n">CLKDEV_INIT</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;i2s1_ck&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clk_i2s1</span><span class="p">),</span>
	<span class="n">CLKDEV_INIT</span><span class="p">(</span><span class="s">&quot;40048000.tsc&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clk_tsc</span><span class="p">),</span>
	<span class="n">CLKDEV_INIT</span><span class="p">(</span><span class="s">&quot;20098000.sd&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clk_mmc</span><span class="p">),</span>
	<span class="n">CLKDEV_INIT</span><span class="p">(</span><span class="s">&quot;31060000.ethernet&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clk_net</span><span class="p">),</span>
	<span class="n">CLKDEV_INIT</span><span class="p">(</span><span class="s">&quot;dev:clcd&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clk_lcd</span><span class="p">),</span>
	<span class="n">CLKDEV_INIT</span><span class="p">(</span><span class="s">&quot;31020000.usbd&quot;</span><span class="p">,</span> <span class="s">&quot;ck_usbd&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clk_usbd</span><span class="p">),</span>
	<span class="n">CLKDEV_INIT</span><span class="p">(</span><span class="s">&quot;lpc32xx_rtc&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clk_rtc</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">clk_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">lookups</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">clkdev_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lookups</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup muxed SYSCLK for HCLK PLL base -this selects the</span>
<span class="cm">	 * parent clock used for the ARM PLL and is used to derive</span>
<span class="cm">	 * the many system clock rates in the device.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clk_is_sysclk_mainosc</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">clk_sys</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">osc_main</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">clk_sys</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">osc_pll397</span><span class="p">;</span>

	<span class="n">clk_sys</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="n">clk_sys</span><span class="p">.</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">;</span>

	<span class="cm">/* Compute the current ARM PLL and USB PLL frequencies */</span>
	<span class="n">local_update_armpll_rate</span><span class="p">();</span>

	<span class="cm">/* Compute HCLK and PCLK bus rates */</span>
	<span class="n">clk_hclk</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="n">clk_hclk</span><span class="p">.</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">/</span> <span class="n">clk_get_hclk_div</span><span class="p">();</span>
	<span class="n">clk_pclk</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="n">clk_pclk</span><span class="p">.</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">/</span> <span class="n">clk_get_pclk_div</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable system clocks - this step is somewhat formal, as the</span>
<span class="cm">	 * clocks are already running, but it does get the clock data</span>
<span class="cm">	 * inline with the actual system state. Never disable these</span>
<span class="cm">	 * clocks as they will only stop if the system is going to sleep.</span>
<span class="cm">	 * In that case, the chip/system power management functions will</span>
<span class="cm">	 * handle clock gating.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clk_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clk_hclk</span><span class="p">)</span> <span class="o">||</span> <span class="n">clk_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clk_pclk</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Error enabling system HCLK and PCLK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Timers 0 and 1 were enabled and are being used by the high</span>
<span class="cm">	 * resolution tick function prior to this driver being initialized.</span>
<span class="cm">	 * Tag them now as used.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clk_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clk_timer0</span><span class="p">)</span> <span class="o">||</span> <span class="n">clk_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clk_timer1</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Error enabling timer tick clocks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">core_initcall</span><span class="p">(</span><span class="n">clk_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
