<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › mach-msm › smd_debug.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>smd_debug.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* arch/arm/mach-msm/smd_debug.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007 Google, Inc.</span>
<span class="cm"> * Author: Brian Swetland &lt;swetland@google.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This software is licensed under the terms of the GNU General Public</span>
<span class="cm"> * License version 2, as published by the Free Software Foundation, and</span>
<span class="cm"> * may be copied, distributed, and modified under those terms.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>

<span class="cp">#include &lt;mach/msm_iomap.h&gt;</span>

<span class="cp">#include &quot;smd_private.h&quot;</span>

<span class="cp">#if defined(CONFIG_DEBUG_FS)</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">chstate</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SMD_SS_CLOSED</span>:
		<span class="k">return</span> <span class="s">&quot;CLOSED&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SMD_SS_OPENING</span>:
		<span class="k">return</span> <span class="s">&quot;OPENING&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SMD_SS_OPENED</span>:
		<span class="k">return</span> <span class="s">&quot;OPENED&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SMD_SS_FLUSHING</span>:
		<span class="k">return</span> <span class="s">&quot;FLUSHING&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SMD_SS_CLOSING</span>:
		<span class="k">return</span> <span class="s">&quot;CLOSING&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SMD_SS_RESET</span>:
		<span class="k">return</span> <span class="s">&quot;RESET&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SMD_SS_RESET_OPENING</span>:
		<span class="k">return</span> <span class="s">&quot;ROPENING&quot;</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="s">&quot;UNKNOWN&quot;</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">dump_ch</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smd_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">smd_half_channel</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">smd_half_channel</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span>
		<span class="n">buf</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span>
		<span class="s">&quot;ch%02d:&quot;</span>
		<span class="s">&quot; %8s(%05d/%05d) %c%c%c%c%c%c%c &lt;-&gt;&quot;</span>
		<span class="s">&quot; %8s(%05d/%05d) %c%c%c%c%c%c%c &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">,</span>
		<span class="n">chstate</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">),</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">fDSR</span> <span class="o">?</span> <span class="sc">&#39;D&#39;</span> <span class="o">:</span> <span class="sc">&#39;d&#39;</span><span class="p">,</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">fCTS</span> <span class="o">?</span> <span class="sc">&#39;C&#39;</span> <span class="o">:</span> <span class="sc">&#39;c&#39;</span><span class="p">,</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">fCD</span> <span class="o">?</span> <span class="sc">&#39;C&#39;</span> <span class="o">:</span> <span class="sc">&#39;c&#39;</span><span class="p">,</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">fRI</span> <span class="o">?</span> <span class="sc">&#39;I&#39;</span> <span class="o">:</span> <span class="sc">&#39;i&#39;</span><span class="p">,</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">fHEAD</span> <span class="o">?</span> <span class="sc">&#39;W&#39;</span> <span class="o">:</span> <span class="sc">&#39;w&#39;</span><span class="p">,</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">fTAIL</span> <span class="o">?</span> <span class="sc">&#39;R&#39;</span> <span class="o">:</span> <span class="sc">&#39;r&#39;</span><span class="p">,</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">fSTATE</span> <span class="o">?</span> <span class="sc">&#39;S&#39;</span> <span class="o">:</span> <span class="sc">&#39;s&#39;</span><span class="p">,</span>
		<span class="n">chstate</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">),</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">fDSR</span> <span class="o">?</span> <span class="sc">&#39;D&#39;</span> <span class="o">:</span> <span class="sc">&#39;d&#39;</span><span class="p">,</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">fCTS</span> <span class="o">?</span> <span class="sc">&#39;R&#39;</span> <span class="o">:</span> <span class="sc">&#39;r&#39;</span><span class="p">,</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">fCD</span> <span class="o">?</span> <span class="sc">&#39;C&#39;</span> <span class="o">:</span> <span class="sc">&#39;c&#39;</span><span class="p">,</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">fRI</span> <span class="o">?</span> <span class="sc">&#39;I&#39;</span> <span class="o">:</span> <span class="sc">&#39;i&#39;</span><span class="p">,</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">fHEAD</span> <span class="o">?</span> <span class="sc">&#39;W&#39;</span> <span class="o">:</span> <span class="sc">&#39;w&#39;</span><span class="p">,</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">fTAIL</span> <span class="o">?</span> <span class="sc">&#39;R&#39;</span> <span class="o">:</span> <span class="sc">&#39;r&#39;</span><span class="p">,</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">fSTATE</span> <span class="o">?</span> <span class="sc">&#39;S&#39;</span> <span class="o">:</span> <span class="sc">&#39;s&#39;</span><span class="p">,</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">name</span>
		<span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">debug_read_stat</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">smem_find</span><span class="p">(</span><span class="n">ID_DIAG_ERR_MSG</span><span class="p">,</span> <span class="n">SZ_DIAG_ERR_MSG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">raw_smsm_get_state</span><span class="p">(</span><span class="n">SMSM_STATE_MODEM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SMSM_RESET</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">max</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span>
			       <span class="s">&quot;smsm: ARM9 HAS CRASHED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">max</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="s">&quot;smsm: a9: %08x a11: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">raw_smsm_get_state</span><span class="p">(</span><span class="n">SMSM_STATE_MODEM</span><span class="p">),</span>
		       <span class="n">raw_smsm_get_state</span><span class="p">(</span><span class="n">SMSM_STATE_APPS</span><span class="p">));</span>
<span class="cp">#ifdef CONFIG_ARCH_MSM_SCORPION</span>
	<span class="n">i</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">max</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="s">&quot;smsm dem: apps: %08x modem: %08x &quot;</span>
		       <span class="s">&quot;qdsp6: %08x power: %08x time: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">raw_smsm_get_state</span><span class="p">(</span><span class="n">SMSM_STATE_APPS_DEM</span><span class="p">),</span>
		       <span class="n">raw_smsm_get_state</span><span class="p">(</span><span class="n">SMSM_STATE_MODEM_DEM</span><span class="p">),</span>
		       <span class="n">raw_smsm_get_state</span><span class="p">(</span><span class="n">SMSM_STATE_QDSP6_DEM</span><span class="p">),</span>
		       <span class="n">raw_smsm_get_state</span><span class="p">(</span><span class="n">SMSM_STATE_POWER_MASTER_DEM</span><span class="p">),</span>
		       <span class="n">raw_smsm_get_state</span><span class="p">(</span><span class="n">SMSM_STATE_TIME_MASTER_DEM</span><span class="p">));</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msg</span><span class="p">[</span><span class="n">SZ_DIAG_ERR_MSG</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">max</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="s">&quot;diag: &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">debug_read_mem</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smem_shared</span> <span class="o">*</span><span class="n">shared</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">MSM_SHARED_RAM_BASE</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smem_heap_entry</span> <span class="o">*</span><span class="n">toc</span> <span class="o">=</span> <span class="n">shared</span><span class="o">-&gt;</span><span class="n">heap_toc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">max</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span>
		       <span class="s">&quot;heap: init=%d free=%d remain=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">shared</span><span class="o">-&gt;</span><span class="n">heap_info</span><span class="p">.</span><span class="n">initialized</span><span class="p">,</span>
		       <span class="n">shared</span><span class="o">-&gt;</span><span class="n">heap_info</span><span class="p">.</span><span class="n">free_offset</span><span class="p">,</span>
		       <span class="n">shared</span><span class="o">-&gt;</span><span class="n">heap_info</span><span class="p">.</span><span class="n">heap_remaining</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">SMEM_NUM_ITEMS</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">toc</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">allocated</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">max</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span>
			       <span class="s">&quot;%04d: offset %08x size %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">n</span><span class="p">,</span> <span class="n">toc</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">offset</span><span class="p">,</span> <span class="n">toc</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">debug_read_ch</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smd_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">smd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smd_ch_list_dsp</span><span class="p">,</span> <span class="n">ch_list</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="n">dump_ch</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">max</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smd_ch_list_modem</span><span class="p">,</span> <span class="n">ch_list</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="n">dump_ch</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">max</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smd_ch_closed_list</span><span class="p">,</span> <span class="n">ch_list</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="n">dump_ch</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">max</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">smd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">debug_read_version</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smem_shared</span> <span class="o">*</span><span class="n">shared</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">MSM_SHARED_RAM_BASE</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">version</span> <span class="o">=</span> <span class="n">shared</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="n">VERSION_MODEM</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">version</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">debug_read_build_id</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">smem_item</span><span class="p">(</span><span class="n">SMEM_HW_SW_BUILD_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="n">max</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">debug_read_alloc_tbl</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smd_alloc_elm</span> <span class="o">*</span><span class="n">shared</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">shared</span> <span class="o">=</span> <span class="n">smem_find</span><span class="p">(</span><span class="n">ID_CH_ALLOC_TBL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">shared</span><span class="p">)</span> <span class="o">*</span> <span class="mi">64</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">shared</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">ref_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">max</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span>
			       <span class="s">&quot;%03d: %-20s cid=%02d type=%03d &quot;</span>
			       <span class="s">&quot;kind=%02d ref_count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">n</span><span class="p">,</span> <span class="n">shared</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">shared</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">cid</span><span class="p">,</span>
			       <span class="n">shared</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">ctype</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">shared</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">ctype</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">,</span>
			       <span class="n">shared</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">ref_count</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define DEBUG_BUFMAX 4096</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">debug_buffer</span><span class="p">[</span><span class="n">DEBUG_BUFMAX</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">debug_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			  <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">fill</span><span class="p">)(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max</span><span class="p">)</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bsize</span> <span class="o">=</span> <span class="n">fill</span><span class="p">(</span><span class="n">debug_buffer</span><span class="p">,</span> <span class="n">DEBUG_BUFMAX</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">debug_buffer</span><span class="p">,</span> <span class="n">bsize</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">debug_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">debug_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">debug_create</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">umode_t</span> <span class="n">mode</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dent</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">fill</span><span class="p">)(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max</span><span class="p">))</span>
<span class="p">{</span>
	<span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">dent</span><span class="p">,</span> <span class="n">fill</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debug_ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">smd_debugfs_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dent</span><span class="p">;</span>

	<span class="n">dent</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="s">&quot;smd&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dent</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">debug_create</span><span class="p">(</span><span class="s">&quot;ch&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">dent</span><span class="p">,</span> <span class="n">debug_read_ch</span><span class="p">);</span>
	<span class="n">debug_create</span><span class="p">(</span><span class="s">&quot;stat&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">dent</span><span class="p">,</span> <span class="n">debug_read_stat</span><span class="p">);</span>
	<span class="n">debug_create</span><span class="p">(</span><span class="s">&quot;mem&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">dent</span><span class="p">,</span> <span class="n">debug_read_mem</span><span class="p">);</span>
	<span class="n">debug_create</span><span class="p">(</span><span class="s">&quot;version&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">dent</span><span class="p">,</span> <span class="n">debug_read_version</span><span class="p">);</span>
	<span class="n">debug_create</span><span class="p">(</span><span class="s">&quot;tbl&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">dent</span><span class="p">,</span> <span class="n">debug_read_alloc_tbl</span><span class="p">);</span>
	<span class="n">debug_create</span><span class="p">(</span><span class="s">&quot;build&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">dent</span><span class="p">,</span> <span class="n">debug_read_build_id</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>


<span class="cp">#define MAX_NUM_SLEEP_CLIENTS		64</span>
<span class="cp">#define MAX_SLEEP_NAME_LEN		8</span>

<span class="cp">#define NUM_GPIO_INT_REGISTERS		6</span>
<span class="cp">#define GPIO_SMEM_NUM_GROUPS		2</span>
<span class="cp">#define GPIO_SMEM_MAX_PC_INTERRUPTS	8</span>

<span class="k">struct</span> <span class="n">tramp_gpio_save</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">detect</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">polarity</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">tramp_gpio_smem</span> <span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">num_fired</span><span class="p">[</span><span class="n">GPIO_SMEM_NUM_GROUPS</span><span class="p">];</span>
	<span class="kt">uint16_t</span> <span class="n">fired</span><span class="p">[</span><span class="n">GPIO_SMEM_NUM_GROUPS</span><span class="p">][</span><span class="n">GPIO_SMEM_MAX_PC_INTERRUPTS</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">enabled</span><span class="p">[</span><span class="n">NUM_GPIO_INT_REGISTERS</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">detection</span><span class="p">[</span><span class="n">NUM_GPIO_INT_REGISTERS</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">polarity</span><span class="p">[</span><span class="n">NUM_GPIO_INT_REGISTERS</span><span class="p">];</span>
<span class="p">};</span>


<span class="kt">void</span> <span class="nf">smsm_print_sleep_info</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
<span class="cp">#ifndef CONFIG_ARCH_MSM_SCORPION</span>
	<span class="k">struct</span> <span class="n">tramp_gpio_smem</span> <span class="o">*</span><span class="n">gpio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smsm_interrupt_info</span> <span class="o">*</span><span class="n">int_info</span><span class="p">;</span>
<span class="cp">#endif</span>


	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">smem_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">smem_alloc</span><span class="p">(</span><span class="n">SMEM_SMSM_SLEEP_DELAY</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;SMEM_SMSM_SLEEP_DELAY: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">smem_alloc</span><span class="p">(</span><span class="n">SMEM_SMSM_LIMIT_SLEEP</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;SMEM_SMSM_LIMIT_SLEEP: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">smem_alloc</span><span class="p">(</span><span class="n">SMEM_SLEEP_POWER_COLLAPSE_DISABLED</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;SMEM_SLEEP_POWER_COLLAPSE_DISABLED: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>

<span class="cp">#ifndef CONFIG_ARCH_MSM_SCORPION</span>
	<span class="n">int_info</span> <span class="o">=</span> <span class="n">smem_alloc</span><span class="p">(</span><span class="n">SMEM_SMSM_INT_INFO</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">int_info</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">int_info</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;SMEM_SMSM_INT_INFO %x %x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">int_info</span><span class="o">-&gt;</span><span class="n">interrupt_mask</span><span class="p">,</span>
			<span class="n">int_info</span><span class="o">-&gt;</span><span class="n">pending_interrupts</span><span class="p">,</span>
			<span class="n">int_info</span><span class="o">-&gt;</span><span class="n">wakeup_reason</span><span class="p">);</span>

	<span class="n">gpio</span> <span class="o">=</span> <span class="n">smem_alloc</span><span class="p">(</span><span class="n">SMEM_GPIO_INT</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">gpio</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_GPIO_INT_REGISTERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;SMEM_GPIO_INT: %d: e %x d %x p %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">i</span><span class="p">,</span> <span class="n">gpio</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">gpio</span><span class="o">-&gt;</span><span class="n">detection</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">polarity</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GPIO_SMEM_NUM_GROUPS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;SMEM_GPIO_INT: %d: f %d: %d %d...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">i</span><span class="p">,</span> <span class="n">gpio</span><span class="o">-&gt;</span><span class="n">num_fired</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">gpio</span><span class="o">-&gt;</span><span class="n">fired</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
				<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">fired</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#endif</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">smem_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
