<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › mach-msm › acpuclock-arm11.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>acpuclock-arm11.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* arch/arm/mach-msm/acpuclock.c</span>
<span class="cm"> *</span>
<span class="cm"> * MSM architecture clock driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007 Google, Inc.</span>
<span class="cm"> * Copyright (c) 2007 QUALCOMM Incorporated</span>
<span class="cm"> * Author: San Mehat &lt;san@android.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This software is licensed under the terms of the GNU General Public</span>
<span class="cm"> * License version 2, as published by the Free Software Foundation, and</span>
<span class="cm"> * may be copied, distributed, and modified under those terms.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.	 See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/cpufreq.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;mach/board.h&gt;</span>
<span class="cp">#include &lt;mach/msm_iomap.h&gt;</span>

<span class="cp">#include &quot;proc_comm.h&quot;</span>
<span class="cp">#include &quot;acpuclock.h&quot;</span>


<span class="cp">#define A11S_CLK_CNTL_ADDR (MSM_CSR_BASE + 0x100)</span>
<span class="cp">#define A11S_CLK_SEL_ADDR (MSM_CSR_BASE + 0x104)</span>
<span class="cp">#define A11S_VDD_SVS_PLEVEL_ADDR (MSM_CSR_BASE + 0x124)</span>

<span class="cm">/*</span>
<span class="cm"> * ARM11 clock configuration for specific ACPU speeds</span>
<span class="cm"> */</span>

<span class="cp">#define ACPU_PLL_TCXO	-1</span>
<span class="cp">#define ACPU_PLL_0	0</span>
<span class="cp">#define ACPU_PLL_1	1</span>
<span class="cp">#define ACPU_PLL_2	2</span>
<span class="cp">#define ACPU_PLL_3	3</span>

<span class="cp">#define PERF_SWITCH_DEBUG 0</span>
<span class="cp">#define PERF_SWITCH_STEP_DEBUG 0</span>

<span class="k">struct</span> <span class="n">clock_state</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">clkctl_acpu_speed</span>	<span class="o">*</span><span class="n">current_speed</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span>			<span class="n">lock</span><span class="p">;</span>
	<span class="kt">uint32_t</span>			<span class="n">acpu_switch_time_us</span><span class="p">;</span>
	<span class="kt">uint32_t</span>			<span class="n">max_speed_delta_khz</span><span class="p">;</span>
	<span class="kt">uint32_t</span>			<span class="n">vdd_switch_time_us</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>			<span class="n">power_collapse_khz</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>			<span class="n">wait_for_irq_khz</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">ebi1_clk</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clock_state</span> <span class="n">drv_state</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="n">acpuclk_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/* MSM7201A Levels 3-6 all correspond to 1.2V, level 7 corresponds to 1.325V. */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">VDD_0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">VDD_1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">VDD_2</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">VDD_3</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">VDD_4</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">VDD_5</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">VDD_6</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">VDD_7</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
	<span class="n">VDD_END</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">clkctl_acpu_speed</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">a11clk_khz</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">pll</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">a11clk_src_sel</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">a11clk_src_div</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">ahbclk_khz</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">ahbclk_div</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">vdd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> 	<span class="n">axiclk_khz</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">lpj</span><span class="p">;</span> <span class="cm">/* loops_per_jiffy */</span>
<span class="cm">/* Index in acpu_freq_tbl[] for steppings. */</span>
	<span class="kt">short</span>		<span class="n">down</span><span class="p">;</span>
	<span class="kt">short</span>		<span class="n">up</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * ACPU speed table. Complete table is shown but certain speeds are commented</span>
<span class="cm"> * out to optimized speed switching. Initialize loops_per_jiffy to 0.</span>
<span class="cm"> *</span>
<span class="cm"> * Table stepping up/down is optimized for 256mhz jumps while staying on the</span>
<span class="cm"> * same PLL.</span>
<span class="cm"> */</span>
<span class="cp">#if (0)</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clkctl_acpu_speed</span>  <span class="n">acpu_freq_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">19200</span><span class="p">,</span> <span class="n">ACPU_PLL_TCXO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">19200</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">VDD_0</span><span class="p">,</span> <span class="mi">30720</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">61440</span><span class="p">,</span> <span class="n">ACPU_PLL_0</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">61440</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="n">VDD_0</span><span class="p">,</span> <span class="mi">30720</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">81920</span><span class="p">,</span> <span class="n">ACPU_PLL_0</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">40960</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="n">VDD_0</span><span class="p">,</span> <span class="mi">61440</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">96000</span><span class="p">,</span> <span class="n">ACPU_PLL_1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">48000</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="n">VDD_0</span><span class="p">,</span> <span class="mi">61440</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">9</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">122880</span><span class="p">,</span> <span class="n">ACPU_PLL_0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">61440</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="n">VDD_3</span><span class="p">,</span> <span class="mi">61440</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">128000</span><span class="p">,</span> <span class="n">ACPU_PLL_1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">64000</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="n">VDD_3</span><span class="p">,</span> <span class="mi">61440</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">176000</span><span class="p">,</span> <span class="n">ACPU_PLL_2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">88000</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="n">VDD_3</span><span class="p">,</span> <span class="mi">61440</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">11</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">192000</span><span class="p">,</span> <span class="n">ACPU_PLL_1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">64000</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span> <span class="n">VDD_3</span><span class="p">,</span> <span class="mi">61440</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">245760</span><span class="p">,</span> <span class="n">ACPU_PLL_0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">81920</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span> <span class="n">VDD_4</span><span class="p">,</span> <span class="mi">61440</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">256000</span><span class="p">,</span> <span class="n">ACPU_PLL_1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">128000</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">VDD_5</span><span class="p">,</span> <span class="mi">128000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">264000</span><span class="p">,</span> <span class="n">ACPU_PLL_2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">88000</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span> <span class="n">VDD_5</span><span class="p">,</span> <span class="mi">128000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">13</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">352000</span><span class="p">,</span> <span class="n">ACPU_PLL_2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">88000</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span> <span class="n">VDD_5</span><span class="p">,</span> <span class="mi">128000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">13</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">384000</span><span class="p">,</span> <span class="n">ACPU_PLL_1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">128000</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">VDD_6</span><span class="p">,</span> <span class="mi">128000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">528000</span><span class="p">,</span> <span class="n">ACPU_PLL_2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">132000</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">VDD_7</span><span class="p">,</span> <span class="mi">128000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
<span class="p">};</span>
<span class="cp">#else </span><span class="cm">/* Table of freq we currently use. */</span><span class="cp"></span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clkctl_acpu_speed</span>  <span class="n">acpu_freq_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">19200</span><span class="p">,</span> <span class="n">ACPU_PLL_TCXO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">19200</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">VDD_0</span><span class="p">,</span> <span class="mi">30720</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">122880</span><span class="p">,</span> <span class="n">ACPU_PLL_0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">61440</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">VDD_3</span><span class="p">,</span> <span class="mi">61440</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">128000</span><span class="p">,</span> <span class="n">ACPU_PLL_1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">64000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">VDD_3</span><span class="p">,</span> <span class="mi">61440</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">176000</span><span class="p">,</span> <span class="n">ACPU_PLL_2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">88000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">VDD_3</span><span class="p">,</span> <span class="mi">61440</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">245760</span><span class="p">,</span> <span class="n">ACPU_PLL_0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">81920</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">VDD_4</span><span class="p">,</span> <span class="mi">61440</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">352000</span><span class="p">,</span> <span class="n">ACPU_PLL_2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">88000</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">VDD_5</span><span class="p">,</span> <span class="mi">128000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">384000</span><span class="p">,</span> <span class="n">ACPU_PLL_1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">128000</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">VDD_6</span><span class="p">,</span> <span class="mi">128000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">528000</span><span class="p">,</span> <span class="n">ACPU_PLL_2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">132000</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">VDD_7</span><span class="p">,</span> <span class="mi">128000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
<span class="p">};</span>
<span class="cp">#endif</span>


<span class="cp">#ifdef CONFIG_CPU_FREQ_TABLE</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">cpufreq_frequency_table</span> <span class="n">freq_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">122880</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">128000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">245760</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">384000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">528000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">5</span><span class="p">,</span> <span class="n">CPUFREQ_TABLE_END</span> <span class="p">},</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pc_pll_request</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">on</span> <span class="o">=</span> <span class="o">!!</span><span class="n">on</span><span class="p">;</span>

<span class="cp">#if PERF_SWITCH_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Enabling PLL %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Disabling PLL %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">msm_proc_comm</span><span class="p">(</span><span class="n">PCOM_CLKCTL_RPC_PLL_REQUEST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">on</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

<span class="cp">#if PERF_SWITCH_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;PLL %d enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;PLL %d disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*----------------------------------------------------------------------------</span>
<span class="cm"> * ARM11 &#39;owned&#39; clock control</span>
<span class="cm"> *---------------------------------------------------------------------------*/</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">acpuclk_power_collapse</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">acpuclk_get_rate</span><span class="p">();</span>
	<span class="n">ret</span> <span class="o">*=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="n">drv_state</span><span class="p">.</span><span class="n">power_collapse_khz</span><span class="p">)</span>
		<span class="n">acpuclk_set_rate</span><span class="p">(</span><span class="n">drv_state</span><span class="p">.</span><span class="n">power_collapse_khz</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">acpuclk_get_wfi_rate</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">drv_state</span><span class="p">.</span><span class="n">wait_for_irq_khz</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">acpuclk_wait_for_irq</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">acpuclk_get_rate</span><span class="p">();</span>
	<span class="n">ret</span> <span class="o">*=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="n">drv_state</span><span class="p">.</span><span class="n">wait_for_irq_khz</span><span class="p">)</span>
		<span class="n">acpuclk_set_rate</span><span class="p">(</span><span class="n">drv_state</span><span class="p">.</span><span class="n">wait_for_irq_khz</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpuclk_set_vdd_level</span><span class="p">(</span><span class="kt">int</span> <span class="n">vdd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">current_vdd</span><span class="p">;</span>

	<span class="n">current_vdd</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">A11S_VDD_SVS_PLEVEL_ADDR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>

<span class="cp">#if PERF_SWITCH_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;acpuclock: Switching VDD from %u -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">current_vdd</span><span class="p">,</span> <span class="n">vdd</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">writel</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">vdd</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span> <span class="n">A11S_VDD_SVS_PLEVEL_ADDR</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">drv_state</span><span class="p">.</span><span class="n">vdd_switch_time_us</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">A11S_VDD_SVS_PLEVEL_ADDR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">!=</span> <span class="n">vdd</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if PERF_SWITCH_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;acpuclock: VDD set failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if PERF_SWITCH_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;acpuclock: VDD switched</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Set proper dividers for the given clock speed. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">acpuclk_set_div</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">clkctl_acpu_speed</span> <span class="o">*</span><span class="n">hunt_s</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">reg_clkctl</span><span class="p">,</span> <span class="n">reg_clksel</span><span class="p">,</span> <span class="n">clk_div</span><span class="p">;</span>

	<span class="cm">/* AHB_CLK_DIV */</span>
	<span class="n">clk_div</span> <span class="o">=</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">A11S_CLK_SEL_ADDR</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * If the new clock divider is higher than the previous, then</span>
<span class="cm">	 * program the divider before switching the clock</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hunt_s</span><span class="o">-&gt;</span><span class="n">ahbclk_div</span> <span class="o">&gt;</span> <span class="n">clk_div</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg_clksel</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">A11S_CLK_SEL_ADDR</span><span class="p">);</span>
		<span class="n">reg_clksel</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x3</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">reg_clksel</span> <span class="o">|=</span> <span class="p">(</span><span class="n">hunt_s</span><span class="o">-&gt;</span><span class="n">ahbclk_div</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">reg_clksel</span><span class="p">,</span> <span class="n">A11S_CLK_SEL_ADDR</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">A11S_CLK_SEL_ADDR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* SRC0 */</span>

		<span class="cm">/* Program clock source */</span>
		<span class="n">reg_clkctl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">A11S_CLK_CNTL_ADDR</span><span class="p">);</span>
		<span class="n">reg_clkctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x07</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">reg_clkctl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">hunt_s</span><span class="o">-&gt;</span><span class="n">a11clk_src_sel</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">reg_clkctl</span><span class="p">,</span> <span class="n">A11S_CLK_CNTL_ADDR</span><span class="p">);</span>

		<span class="cm">/* Program clock divider */</span>
		<span class="n">reg_clkctl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">A11S_CLK_CNTL_ADDR</span><span class="p">);</span>
		<span class="n">reg_clkctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xf</span><span class="p">;</span>
		<span class="n">reg_clkctl</span> <span class="o">|=</span> <span class="n">hunt_s</span><span class="o">-&gt;</span><span class="n">a11clk_src_div</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">reg_clkctl</span><span class="p">,</span> <span class="n">A11S_CLK_CNTL_ADDR</span><span class="p">);</span>

		<span class="cm">/* Program clock source selection */</span>
		<span class="n">reg_clksel</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">A11S_CLK_SEL_ADDR</span><span class="p">);</span>
		<span class="n">reg_clksel</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* CLK_SEL_SRC1NO  == SRC1 */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">reg_clksel</span><span class="p">,</span> <span class="n">A11S_CLK_SEL_ADDR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* SRC1 */</span>

		<span class="cm">/* Program clock source */</span>
		<span class="n">reg_clkctl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">A11S_CLK_CNTL_ADDR</span><span class="p">);</span>
		<span class="n">reg_clkctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x07</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
		<span class="n">reg_clkctl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">hunt_s</span><span class="o">-&gt;</span><span class="n">a11clk_src_sel</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">reg_clkctl</span><span class="p">,</span> <span class="n">A11S_CLK_CNTL_ADDR</span><span class="p">);</span>

		<span class="cm">/* Program clock divider */</span>
		<span class="n">reg_clkctl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">A11S_CLK_CNTL_ADDR</span><span class="p">);</span>
		<span class="n">reg_clkctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xf</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">reg_clkctl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">hunt_s</span><span class="o">-&gt;</span><span class="n">a11clk_src_div</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">reg_clkctl</span><span class="p">,</span> <span class="n">A11S_CLK_CNTL_ADDR</span><span class="p">);</span>

		<span class="cm">/* Program clock source selection */</span>
		<span class="n">reg_clksel</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">A11S_CLK_SEL_ADDR</span><span class="p">);</span>
		<span class="n">reg_clksel</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* CLK_SEL_SRC1NO  == SRC0 */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">reg_clksel</span><span class="p">,</span> <span class="n">A11S_CLK_SEL_ADDR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the new clock divider is lower than the previous, then</span>
<span class="cm">	 * program the divider after switching the clock</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hunt_s</span><span class="o">-&gt;</span><span class="n">ahbclk_div</span> <span class="o">&lt;</span> <span class="n">clk_div</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg_clksel</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">A11S_CLK_SEL_ADDR</span><span class="p">);</span>
		<span class="n">reg_clksel</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x3</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">reg_clksel</span> <span class="o">|=</span> <span class="p">(</span><span class="n">hunt_s</span><span class="o">-&gt;</span><span class="n">ahbclk_div</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">reg_clksel</span><span class="p">,</span> <span class="n">A11S_CLK_SEL_ADDR</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">acpuclk_set_rate</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate</span><span class="p">,</span> <span class="kt">int</span> <span class="n">for_power_collapse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">reg_clkctl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clkctl_acpu_speed</span> <span class="o">*</span><span class="n">cur_s</span><span class="p">,</span> <span class="o">*</span><span class="n">tgt_s</span><span class="p">,</span> <span class="o">*</span><span class="n">strt_s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">plls_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pll</span><span class="p">;</span>

	<span class="n">strt_s</span> <span class="o">=</span> <span class="n">cur_s</span> <span class="o">=</span> <span class="n">drv_state</span><span class="p">.</span><span class="n">current_speed</span><span class="p">;</span>

	<span class="n">WARN_ONCE</span><span class="p">(</span><span class="n">cur_s</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;acpuclk_set_rate: not initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cur_s</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="p">(</span><span class="n">cur_s</span><span class="o">-&gt;</span><span class="n">a11clk_khz</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">tgt_s</span> <span class="o">=</span> <span class="n">acpu_freq_tbl</span><span class="p">;</span> <span class="n">tgt_s</span><span class="o">-&gt;</span><span class="n">a11clk_khz</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tgt_s</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tgt_s</span><span class="o">-&gt;</span><span class="n">a11clk_khz</span> <span class="o">==</span> <span class="p">(</span><span class="n">rate</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tgt_s</span><span class="o">-&gt;</span><span class="n">a11clk_khz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Choose the highest speed speed at or below &#39;rate&#39; with same PLL. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">for_power_collapse</span> <span class="o">&amp;&amp;</span> <span class="n">tgt_s</span><span class="o">-&gt;</span><span class="n">a11clk_khz</span> <span class="o">&lt;</span> <span class="n">cur_s</span><span class="o">-&gt;</span><span class="n">a11clk_khz</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">tgt_s</span><span class="o">-&gt;</span><span class="n">pll</span> <span class="o">!=</span> <span class="n">ACPU_PLL_TCXO</span> <span class="o">&amp;&amp;</span> <span class="n">tgt_s</span><span class="o">-&gt;</span><span class="n">pll</span> <span class="o">!=</span> <span class="n">cur_s</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">)</span>
			<span class="n">tgt_s</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strt_s</span><span class="o">-&gt;</span><span class="n">pll</span> <span class="o">!=</span> <span class="n">ACPU_PLL_TCXO</span><span class="p">)</span>
		<span class="n">plls_enabled</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">strt_s</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">for_power_collapse</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drv_state</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strt_s</span><span class="o">-&gt;</span><span class="n">pll</span> <span class="o">!=</span> <span class="n">tgt_s</span><span class="o">-&gt;</span><span class="n">pll</span> <span class="o">&amp;&amp;</span> <span class="n">tgt_s</span><span class="o">-&gt;</span><span class="n">pll</span> <span class="o">!=</span> <span class="n">ACPU_PLL_TCXO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">pc_pll_request</span><span class="p">(</span><span class="n">tgt_s</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;PLL%d enable failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">tgt_s</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">plls_enabled</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">tgt_s</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Increase VDD if needed. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tgt_s</span><span class="o">-&gt;</span><span class="n">vdd</span> <span class="o">&gt;</span> <span class="n">cur_s</span><span class="o">-&gt;</span><span class="n">vdd</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">acpuclk_set_vdd_level</span><span class="p">(</span><span class="n">tgt_s</span><span class="o">-&gt;</span><span class="n">vdd</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Unable to switch ACPU vdd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Set wait states for CPU between frequency changes */</span>
	<span class="n">reg_clkctl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">A11S_CLK_CNTL_ADDR</span><span class="p">);</span>
	<span class="n">reg_clkctl</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">100</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span> <span class="cm">/* set WT_ST_CNT */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">reg_clkctl</span><span class="p">,</span> <span class="n">A11S_CLK_CNTL_ADDR</span><span class="p">);</span>

<span class="cp">#if PERF_SWITCH_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;acpuclock: Switching from ACPU rate %u -&gt; %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">strt_s</span><span class="o">-&gt;</span><span class="n">a11clk_khz</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">tgt_s</span><span class="o">-&gt;</span><span class="n">a11clk_khz</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">cur_s</span> <span class="o">!=</span> <span class="n">tgt_s</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Always jump to target freq if within 256mhz, regulardless of</span>
<span class="cm">		 * PLL. If differnece is greater, use the predefinied</span>
<span class="cm">		 * steppings in the table.</span>
<span class="cm">		 */</span>
		<span class="kt">int</span> <span class="n">d</span> <span class="o">=</span> <span class="n">abs</span><span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">cur_s</span><span class="o">-&gt;</span><span class="n">a11clk_khz</span> <span class="o">-</span> <span class="n">tgt_s</span><span class="o">-&gt;</span><span class="n">a11clk_khz</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">&gt;</span> <span class="n">drv_state</span><span class="p">.</span><span class="n">max_speed_delta_khz</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Step up or down depending on target vs current. */</span>
			<span class="kt">int</span> <span class="n">clk_index</span> <span class="o">=</span> <span class="n">tgt_s</span><span class="o">-&gt;</span><span class="n">a11clk_khz</span> <span class="o">&gt;</span> <span class="n">cur_s</span><span class="o">-&gt;</span><span class="n">a11clk_khz</span> <span class="o">?</span>
				<span class="n">cur_s</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">:</span> <span class="n">cur_s</span><span class="o">-&gt;</span><span class="n">down</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">clk_index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* This should not happen. */</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cur:%u target: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">cur_s</span><span class="o">-&gt;</span><span class="n">a11clk_khz</span><span class="p">,</span> <span class="n">tgt_s</span><span class="o">-&gt;</span><span class="n">a11clk_khz</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">cur_s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">acpu_freq_tbl</span><span class="p">[</span><span class="n">clk_index</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cur_s</span> <span class="o">=</span> <span class="n">tgt_s</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#if PERF_SWITCH_STEP_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: STEP khz = %u, pll = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FUNCTION__</span><span class="p">,</span> <span class="n">cur_s</span><span class="o">-&gt;</span><span class="n">a11clk_khz</span><span class="p">,</span> <span class="n">cur_s</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">for_power_collapse</span><span class="o">&amp;&amp;</span> <span class="n">cur_s</span><span class="o">-&gt;</span><span class="n">pll</span> <span class="o">!=</span> <span class="n">ACPU_PLL_TCXO</span>
		    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">plls_enabled</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">cur_s</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">pc_pll_request</span><span class="p">(</span><span class="n">cur_s</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;PLL%d enable failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">cur_s</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">plls_enabled</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">cur_s</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">acpuclk_set_div</span><span class="p">(</span><span class="n">cur_s</span><span class="p">);</span>
		<span class="n">drv_state</span><span class="p">.</span><span class="n">current_speed</span> <span class="o">=</span> <span class="n">cur_s</span><span class="p">;</span>
		<span class="cm">/* Re-adjust lpj for the new clock speed. */</span>
		<span class="n">loops_per_jiffy</span> <span class="o">=</span> <span class="n">cur_s</span><span class="o">-&gt;</span><span class="n">lpj</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">drv_state</span><span class="p">.</span><span class="n">acpu_switch_time_us</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Nothing else to do for power collapse. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">for_power_collapse</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Disable PLLs we are not using anymore. */</span>
	<span class="n">plls_enabled</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">tgt_s</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pll</span> <span class="o">=</span> <span class="n">ACPU_PLL_0</span><span class="p">;</span> <span class="n">pll</span> <span class="o">&lt;=</span> <span class="n">ACPU_PLL_2</span><span class="p">;</span> <span class="n">pll</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plls_enabled</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pll</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">pc_pll_request</span><span class="p">(</span><span class="n">pll</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;PLL%d disable failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pll</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="cm">/* Change the AXI bus frequency if we can. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strt_s</span><span class="o">-&gt;</span><span class="n">axiclk_khz</span> <span class="o">!=</span> <span class="n">tgt_s</span><span class="o">-&gt;</span><span class="n">axiclk_khz</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">clk_set_rate</span><span class="p">(</span><span class="n">ebi1_clk</span><span class="p">,</span> <span class="n">tgt_s</span><span class="o">-&gt;</span><span class="n">axiclk_khz</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Setting AXI min rate failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Drop VDD level if we can. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tgt_s</span><span class="o">-&gt;</span><span class="n">vdd</span> <span class="o">&lt;</span> <span class="n">strt_s</span><span class="o">-&gt;</span><span class="n">vdd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acpuclk_set_vdd_level</span><span class="p">(</span><span class="n">tgt_s</span><span class="o">-&gt;</span><span class="n">vdd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;acpuclock: Unable to drop ACPU vdd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#if PERF_SWITCH_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: ACPU speed change complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">for_power_collapse</span><span class="p">)</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drv_state</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">acpuclk_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">clkctl_acpu_speed</span> <span class="o">*</span><span class="n">speed</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">div</span><span class="p">,</span> <span class="n">sel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Determine the rate of ACPU clock</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">A11S_CLK_SEL_ADDR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* CLK_SEL_SRC1N0 */</span>
		<span class="cm">/* CLK_SRC0_SEL */</span>
		<span class="n">sel</span> <span class="o">=</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">A11S_CLK_CNTL_ADDR</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
		<span class="cm">/* CLK_SRC0_DIV */</span>
		<span class="n">div</span> <span class="o">=</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">A11S_CLK_CNTL_ADDR</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* CLK_SRC1_SEL */</span>
		<span class="n">sel</span> <span class="o">=</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">A11S_CLK_CNTL_ADDR</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
		<span class="cm">/* CLK_SRC1_DIV */</span>
		<span class="n">div</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">A11S_CLK_CNTL_ADDR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">speed</span> <span class="o">=</span> <span class="n">acpu_freq_tbl</span><span class="p">;</span> <span class="n">speed</span><span class="o">-&gt;</span><span class="n">a11clk_khz</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">speed</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span><span class="o">-&gt;</span><span class="n">a11clk_src_sel</span> <span class="o">==</span> <span class="n">sel</span>
		 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">speed</span><span class="o">-&gt;</span><span class="n">a11clk_src_div</span> <span class="o">==</span> <span class="n">div</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span><span class="o">-&gt;</span><span class="n">a11clk_khz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Warning - ACPU clock reports invalid speed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">drv_state</span><span class="p">.</span><span class="n">current_speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">clk_set_rate</span><span class="p">(</span><span class="n">ebi1_clk</span><span class="p">,</span> <span class="n">speed</span><span class="o">-&gt;</span><span class="n">axiclk_khz</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Setting AXI min rate failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ACPU running at %d KHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">speed</span><span class="o">-&gt;</span><span class="n">a11clk_khz</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">acpuclk_get_rate</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN_ONCE</span><span class="p">(</span><span class="n">drv_state</span><span class="p">.</span><span class="n">current_speed</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">,</span>
		  <span class="s">&quot;acpuclk_get_rate: not initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drv_state</span><span class="p">.</span><span class="n">current_speed</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">drv_state</span><span class="p">.</span><span class="n">current_speed</span><span class="o">-&gt;</span><span class="n">a11clk_khz</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">uint32_t</span> <span class="nf">acpuclk_get_switch_time</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">drv_state</span><span class="p">.</span><span class="n">acpu_switch_time_us</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------------</span>
<span class="cm"> * Clock driver initialization</span>
<span class="cm"> *---------------------------------------------------------------------------*/</span>

<span class="cm">/* Initialize the lpj field in the acpu_freq_tbl. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">lpj_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">clkctl_acpu_speed</span> <span class="o">*</span><span class="n">base_clk</span> <span class="o">=</span> <span class="n">drv_state</span><span class="p">.</span><span class="n">current_speed</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">acpu_freq_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">a11clk_khz</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">acpu_freq_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lpj</span> <span class="o">=</span> <span class="n">cpufreq_scale</span><span class="p">(</span><span class="n">loops_per_jiffy</span><span class="p">,</span>
						<span class="n">base_clk</span><span class="o">-&gt;</span><span class="n">a11clk_khz</span><span class="p">,</span>
						<span class="n">acpu_freq_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">a11clk_khz</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">msm_acpu_clock_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">msm_acpu_clock_platform_data</span> <span class="o">*</span><span class="n">clkdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;acpu_clock_init()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ebi1_clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;ebi1_clk&quot;</span><span class="p">);</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drv_state</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">drv_state</span><span class="p">.</span><span class="n">acpu_switch_time_us</span> <span class="o">=</span> <span class="n">clkdata</span><span class="o">-&gt;</span><span class="n">acpu_switch_time_us</span><span class="p">;</span>
	<span class="n">drv_state</span><span class="p">.</span><span class="n">max_speed_delta_khz</span> <span class="o">=</span> <span class="n">clkdata</span><span class="o">-&gt;</span><span class="n">max_speed_delta_khz</span><span class="p">;</span>
	<span class="n">drv_state</span><span class="p">.</span><span class="n">vdd_switch_time_us</span> <span class="o">=</span> <span class="n">clkdata</span><span class="o">-&gt;</span><span class="n">vdd_switch_time_us</span><span class="p">;</span>
	<span class="n">drv_state</span><span class="p">.</span><span class="n">power_collapse_khz</span> <span class="o">=</span> <span class="n">clkdata</span><span class="o">-&gt;</span><span class="n">power_collapse_khz</span><span class="p">;</span>
	<span class="n">drv_state</span><span class="p">.</span><span class="n">wait_for_irq_khz</span> <span class="o">=</span> <span class="n">clkdata</span><span class="o">-&gt;</span><span class="n">wait_for_irq_khz</span><span class="p">;</span>
	<span class="n">acpuclk_init</span><span class="p">();</span>
	<span class="n">lpj_init</span><span class="p">();</span>
<span class="cp">#ifdef CONFIG_CPU_FREQ_TABLE</span>
	<span class="n">cpufreq_frequency_table_get_attr</span><span class="p">(</span><span class="n">freq_table</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">());</span>
<span class="cp">#endif</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
