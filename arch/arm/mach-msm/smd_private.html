<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › mach-msm › smd_private.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>smd_private.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* arch/arm/mach-msm/smd_private.h</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007 Google, Inc.</span>
<span class="cm"> * Copyright (c) 2007 QUALCOMM Incorporated</span>
<span class="cm"> *</span>
<span class="cm"> * This software is licensed under the terms of the GNU General Public</span>
<span class="cm"> * License version 2, as published by the Free Software Foundation, and</span>
<span class="cm"> * may be copied, distributed, and modified under those terms.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#ifndef _ARCH_ARM_MACH_MSM_MSM_SMD_PRIVATE_H_</span>
<span class="cp">#define _ARCH_ARM_MACH_MSM_MSM_SMD_PRIVATE_H_</span>

<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>

<span class="cp">#include &lt;mach/msm_iomap.h&gt;</span>

<span class="k">struct</span> <span class="n">smem_heap_info</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">initialized</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">free_offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">heap_remaining</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">reserved</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">smem_heap_entry</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">allocated</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">reserved</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">smem_proc_comm</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">command</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">data1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">data2</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define PC_APPS  0</span>
<span class="cp">#define PC_MODEM 1</span>

<span class="cp">#define VERSION_SMD       0</span>
<span class="cp">#define VERSION_QDSP6     4</span>
<span class="cp">#define VERSION_APPS_SBL  6</span>
<span class="cp">#define VERSION_MODEM_SBL 7</span>
<span class="cp">#define VERSION_APPS      8</span>
<span class="cp">#define VERSION_MODEM     9</span>

<span class="k">struct</span> <span class="n">smem_shared</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">smem_proc_comm</span> <span class="n">proc_comm</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="n">version</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">smem_heap_info</span> <span class="n">heap_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smem_heap_entry</span> <span class="n">heap_toc</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#define SMSM_V1_SIZE		(sizeof(unsigned) * 8)</span>
<span class="cp">#define SMSM_V2_SIZE		(sizeof(unsigned) * 4)</span>

<span class="cp">#ifdef CONFIG_MSM_SMD_PKG3</span>
<span class="k">struct</span> <span class="n">smsm_interrupt_info</span> <span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">interrupt_mask</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">pending_interrupts</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">wakeup_reason</span><span class="p">;</span>
<span class="p">};</span>
<span class="cp">#else</span>
<span class="cp">#define DEM_MAX_PORT_NAME_LEN (20)</span>
<span class="k">struct</span> <span class="n">msm_dem_slave_data</span> <span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">sleep_time</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">interrupt_mask</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">resources_used</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">reserved1</span><span class="p">;</span>

	<span class="kt">uint32_t</span> <span class="n">wakeup_reason</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">pending_interrupts</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">rpc_prog</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">rpc_proc</span><span class="p">;</span>
	<span class="kt">char</span>     <span class="n">smd_port_name</span><span class="p">[</span><span class="n">DEM_MAX_PORT_NAME_LEN</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">reserved2</span><span class="p">;</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="cp">#define SZ_DIAG_ERR_MSG 0xC8</span>
<span class="cp">#define ID_DIAG_ERR_MSG SMEM_DIAG_ERR_MESSAGE</span>
<span class="cp">#define ID_SMD_CHANNELS SMEM_SMD_BASE_ID</span>
<span class="cp">#define ID_SHARED_STATE SMEM_SMSM_SHARED_STATE</span>
<span class="cp">#define ID_CH_ALLOC_TBL SMEM_CHANNEL_ALLOC_TBL</span>

<span class="cp">#define SMSM_INIT		0x00000001</span>
<span class="cp">#define SMSM_SMDINIT		0x00000008</span>
<span class="cp">#define SMSM_RPCINIT		0x00000020</span>
<span class="cp">#define SMSM_RESET		0x00000040</span>
<span class="cp">#define SMSM_RSA		0x00000080</span>
<span class="cp">#define SMSM_RUN		0x00000100</span>
<span class="cp">#define SMSM_PWRC		0x00000200</span>
<span class="cp">#define SMSM_TIMEWAIT		0x00000400</span>
<span class="cp">#define SMSM_TIMEINIT		0x00000800</span>
<span class="cp">#define SMSM_PWRC_EARLY_EXIT	0x00001000</span>
<span class="cp">#define SMSM_WFPI		0x00002000</span>
<span class="cp">#define SMSM_SLEEP		0x00004000</span>
<span class="cp">#define SMSM_SLEEPEXIT		0x00008000</span>
<span class="cp">#define SMSM_APPS_REBOOT	0x00020000</span>
<span class="cp">#define SMSM_SYSTEM_POWER_DOWN	0x00040000</span>
<span class="cp">#define SMSM_SYSTEM_REBOOT	0x00080000</span>
<span class="cp">#define SMSM_SYSTEM_DOWNLOAD	0x00100000</span>
<span class="cp">#define SMSM_PWRC_SUSPEND	0x00200000</span>
<span class="cp">#define SMSM_APPS_SHUTDOWN	0x00400000</span>
<span class="cp">#define SMSM_SMD_LOOPBACK	0x00800000</span>
<span class="cp">#define SMSM_RUN_QUIET		0x01000000</span>
<span class="cp">#define SMSM_MODEM_WAIT		0x02000000</span>
<span class="cp">#define SMSM_MODEM_BREAK	0x04000000</span>
<span class="cp">#define SMSM_MODEM_CONTINUE	0x08000000</span>
<span class="cp">#define SMSM_UNKNOWN		0x80000000</span>

<span class="cp">#define SMSM_WKUP_REASON_RPC	0x00000001</span>
<span class="cp">#define SMSM_WKUP_REASON_INT	0x00000002</span>
<span class="cp">#define SMSM_WKUP_REASON_GPIO	0x00000004</span>
<span class="cp">#define SMSM_WKUP_REASON_TIMER	0x00000008</span>
<span class="cp">#define SMSM_WKUP_REASON_ALARM	0x00000010</span>
<span class="cp">#define SMSM_WKUP_REASON_RESET	0x00000020</span>

<span class="cp">#ifdef CONFIG_ARCH_MSM7X00A</span>
<span class="k">enum</span> <span class="n">smsm_state_item</span> <span class="p">{</span>
	<span class="n">SMSM_STATE_APPS</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">SMSM_STATE_MODEM</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">SMSM_STATE_COUNT</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#else</span>
<span class="k">enum</span> <span class="n">smsm_state_item</span> <span class="p">{</span>
	<span class="n">SMSM_STATE_APPS</span><span class="p">,</span>
	<span class="n">SMSM_STATE_MODEM</span><span class="p">,</span>
	<span class="n">SMSM_STATE_HEXAGON</span><span class="p">,</span>
	<span class="n">SMSM_STATE_APPS_DEM</span><span class="p">,</span>
	<span class="n">SMSM_STATE_MODEM_DEM</span><span class="p">,</span>
	<span class="n">SMSM_STATE_QDSP6_DEM</span><span class="p">,</span>
	<span class="n">SMSM_STATE_POWER_MASTER_DEM</span><span class="p">,</span>
	<span class="n">SMSM_STATE_TIME_MASTER_DEM</span><span class="p">,</span>
	<span class="n">SMSM_STATE_COUNT</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="kt">void</span> <span class="o">*</span><span class="n">smem_alloc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">size</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">smsm_change_state</span><span class="p">(</span><span class="k">enum</span> <span class="n">smsm_state_item</span> <span class="n">item</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">clear_mask</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">set_mask</span><span class="p">);</span>
<span class="kt">uint32_t</span> <span class="n">smsm_get_state</span><span class="p">(</span><span class="k">enum</span> <span class="n">smsm_state_item</span> <span class="n">item</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">smsm_set_sleep_duration</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">delay</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">smsm_print_sleep_info</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cp">#define SMEM_NUM_SMD_CHANNELS        64</span>

<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
	<span class="cm">/* fixed items */</span>
	<span class="n">SMEM_PROC_COMM</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">SMEM_HEAP_INFO</span><span class="p">,</span>
	<span class="n">SMEM_ALLOCATION_TABLE</span><span class="p">,</span>
	<span class="n">SMEM_VERSION_INFO</span><span class="p">,</span>
	<span class="n">SMEM_HW_RESET_DETECT</span><span class="p">,</span>
	<span class="n">SMEM_AARM_WARM_BOOT</span><span class="p">,</span>
	<span class="n">SMEM_DIAG_ERR_MESSAGE</span><span class="p">,</span>
	<span class="n">SMEM_SPINLOCK_ARRAY</span><span class="p">,</span>
	<span class="n">SMEM_MEMORY_BARRIER_LOCATION</span><span class="p">,</span>

	<span class="cm">/* dynamic items */</span>
	<span class="n">SMEM_AARM_PARTITION_TABLE</span><span class="p">,</span>
	<span class="n">SMEM_AARM_BAD_BLOCK_TABLE</span><span class="p">,</span>
	<span class="n">SMEM_RESERVE_BAD_BLOCKS</span><span class="p">,</span>
	<span class="n">SMEM_WM_UUID</span><span class="p">,</span>
	<span class="n">SMEM_CHANNEL_ALLOC_TBL</span><span class="p">,</span>
	<span class="n">SMEM_SMD_BASE_ID</span><span class="p">,</span>
	<span class="n">SMEM_SMEM_LOG_IDX</span> <span class="o">=</span> <span class="n">SMEM_SMD_BASE_ID</span> <span class="o">+</span> <span class="n">SMEM_NUM_SMD_CHANNELS</span><span class="p">,</span>
	<span class="n">SMEM_SMEM_LOG_EVENTS</span><span class="p">,</span>
	<span class="n">SMEM_SMEM_STATIC_LOG_IDX</span><span class="p">,</span>
	<span class="n">SMEM_SMEM_STATIC_LOG_EVENTS</span><span class="p">,</span>
	<span class="n">SMEM_SMEM_SLOW_CLOCK_SYNC</span><span class="p">,</span>
	<span class="n">SMEM_SMEM_SLOW_CLOCK_VALUE</span><span class="p">,</span>
	<span class="n">SMEM_BIO_LED_BUF</span><span class="p">,</span>
	<span class="n">SMEM_SMSM_SHARED_STATE</span><span class="p">,</span>
	<span class="n">SMEM_SMSM_INT_INFO</span><span class="p">,</span>
	<span class="n">SMEM_SMSM_SLEEP_DELAY</span><span class="p">,</span>
	<span class="n">SMEM_SMSM_LIMIT_SLEEP</span><span class="p">,</span>
	<span class="n">SMEM_SLEEP_POWER_COLLAPSE_DISABLED</span><span class="p">,</span>
	<span class="n">SMEM_KEYPAD_KEYS_PRESSED</span><span class="p">,</span>
	<span class="n">SMEM_KEYPAD_STATE_UPDATED</span><span class="p">,</span>
	<span class="n">SMEM_KEYPAD_STATE_IDX</span><span class="p">,</span>
	<span class="n">SMEM_GPIO_INT</span><span class="p">,</span>
	<span class="n">SMEM_MDDI_LCD_IDX</span><span class="p">,</span>
	<span class="n">SMEM_MDDI_HOST_DRIVER_STATE</span><span class="p">,</span>
	<span class="n">SMEM_MDDI_LCD_DISP_STATE</span><span class="p">,</span>
	<span class="n">SMEM_LCD_CUR_PANEL</span><span class="p">,</span>
	<span class="n">SMEM_MARM_BOOT_SEGMENT_INFO</span><span class="p">,</span>
	<span class="n">SMEM_AARM_BOOT_SEGMENT_INFO</span><span class="p">,</span>
	<span class="n">SMEM_SLEEP_STATIC</span><span class="p">,</span>
	<span class="n">SMEM_SCORPION_FREQUENCY</span><span class="p">,</span>
	<span class="n">SMEM_SMD_PROFILES</span><span class="p">,</span>
	<span class="n">SMEM_TSSC_BUSY</span><span class="p">,</span>
	<span class="n">SMEM_HS_SUSPEND_FILTER_INFO</span><span class="p">,</span>
	<span class="n">SMEM_BATT_INFO</span><span class="p">,</span>
	<span class="n">SMEM_APPS_BOOT_MODE</span><span class="p">,</span>
	<span class="n">SMEM_VERSION_FIRST</span><span class="p">,</span>
	<span class="n">SMEM_VERSION_LAST</span> <span class="o">=</span> <span class="n">SMEM_VERSION_FIRST</span> <span class="o">+</span> <span class="mi">24</span><span class="p">,</span>
	<span class="n">SMEM_OSS_RRCASN1_BUF1</span><span class="p">,</span>
	<span class="n">SMEM_OSS_RRCASN1_BUF2</span><span class="p">,</span>
	<span class="n">SMEM_ID_VENDOR0</span><span class="p">,</span>
	<span class="n">SMEM_ID_VENDOR1</span><span class="p">,</span>
	<span class="n">SMEM_ID_VENDOR2</span><span class="p">,</span>
	<span class="n">SMEM_HW_SW_BUILD_ID</span><span class="p">,</span>
	<span class="n">SMEM_SMD_BLOCK_PORT_BASE_ID</span><span class="p">,</span>
	<span class="n">SMEM_SMD_BLOCK_PORT_PROC0_HEAP</span> <span class="o">=</span> <span class="n">SMEM_SMD_BLOCK_PORT_BASE_ID</span> <span class="o">+</span> <span class="n">SMEM_NUM_SMD_CHANNELS</span><span class="p">,</span>
	<span class="n">SMEM_SMD_BLOCK_PORT_PROC1_HEAP</span> <span class="o">=</span> <span class="n">SMEM_SMD_BLOCK_PORT_PROC0_HEAP</span> <span class="o">+</span> <span class="n">SMEM_NUM_SMD_CHANNELS</span><span class="p">,</span>
	<span class="n">SMEM_I2C_MUTEX</span> <span class="o">=</span> <span class="n">SMEM_SMD_BLOCK_PORT_PROC1_HEAP</span> <span class="o">+</span> <span class="n">SMEM_NUM_SMD_CHANNELS</span><span class="p">,</span>
	<span class="n">SMEM_SCLK_CONVERSION</span><span class="p">,</span>
	<span class="n">SMEM_SMD_SMSM_INTR_MUX</span><span class="p">,</span>
	<span class="n">SMEM_SMSM_CPU_INTR_MASK</span><span class="p">,</span>
	<span class="n">SMEM_APPS_DEM_SLAVE_DATA</span><span class="p">,</span>
	<span class="n">SMEM_QDSP6_DEM_SLAVE_DATA</span><span class="p">,</span>
	<span class="n">SMEM_CLKREGIM_BSP</span><span class="p">,</span>
	<span class="n">SMEM_CLKREGIM_SOURCES</span><span class="p">,</span>
	<span class="n">SMEM_SMD_FIFO_BASE_ID</span><span class="p">,</span>
	<span class="n">SMEM_USABLE_RAM_PARTITION_TABLE</span> <span class="o">=</span> <span class="n">SMEM_SMD_FIFO_BASE_ID</span> <span class="o">+</span> <span class="n">SMEM_NUM_SMD_CHANNELS</span><span class="p">,</span>
	<span class="n">SMEM_POWER_ON_STATUS_INFO</span><span class="p">,</span>
	<span class="n">SMEM_DAL_AREA</span><span class="p">,</span>
	<span class="n">SMEM_SMEM_LOG_POWER_IDX</span><span class="p">,</span>
	<span class="n">SMEM_SMEM_LOG_POWER_WRAP</span><span class="p">,</span>
	<span class="n">SMEM_SMEM_LOG_POWER_EVENTS</span><span class="p">,</span>
	<span class="n">SMEM_ERR_CRASH_LOG</span><span class="p">,</span>
	<span class="n">SMEM_ERR_F3_TRACE_LOG</span><span class="p">,</span>
	<span class="n">SMEM_NUM_ITEMS</span><span class="p">,</span>
<span class="p">}</span> <span class="n">smem_mem_type</span><span class="p">;</span>


<span class="cp">#define SMD_SS_CLOSED		0x00000000</span>
<span class="cp">#define SMD_SS_OPENING		0x00000001</span>
<span class="cp">#define SMD_SS_OPENED		0x00000002</span>
<span class="cp">#define SMD_SS_FLUSHING		0x00000003</span>
<span class="cp">#define SMD_SS_CLOSING		0x00000004</span>
<span class="cp">#define SMD_SS_RESET		0x00000005</span>
<span class="cp">#define SMD_SS_RESET_OPENING	0x00000006</span>

<span class="cp">#define SMD_BUF_SIZE		8192</span>
<span class="cp">#define SMD_CHANNELS		64</span>

<span class="cp">#define SMD_HEADER_SIZE		20</span>

<span class="k">struct</span> <span class="n">smd_alloc_elm</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">cid</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ctype</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ref_count</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">smd_half_channel</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fDSR</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fCTS</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fCD</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fRI</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fHEAD</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fTAIL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fSTATE</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fUNUSED</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">tail</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">head</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span> <span class="n">aligned</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">packed</span> <span class="p">));</span>

<span class="cm">/* Only used on SMD package v3 on msm7201a */</span>
<span class="k">struct</span> <span class="n">smd_shared_v1</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">smd_half_channel</span> <span class="n">ch0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data0</span><span class="p">[</span><span class="n">SMD_BUF_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">smd_half_channel</span> <span class="n">ch1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data1</span><span class="p">[</span><span class="n">SMD_BUF_SIZE</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* Used on SMD package v4 */</span>
<span class="k">struct</span> <span class="n">smd_shared_v2</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">smd_half_channel</span> <span class="n">ch0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smd_half_channel</span> <span class="n">ch1</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">smd_channel</span> <span class="p">{</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">smd_half_channel</span> <span class="o">*</span><span class="n">send</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">smd_half_channel</span> <span class="o">*</span><span class="n">recv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">send_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">recv_data</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="n">fifo_mask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">fifo_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">current_packet</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">ch_list</span><span class="p">;</span>

	<span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">notify</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">flags</span><span class="p">);</span>

	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">read</span><span class="p">)(</span><span class="k">struct</span> <span class="n">smd_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">write</span><span class="p">)(</span><span class="k">struct</span> <span class="n">smd_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">read_avail</span><span class="p">)(</span><span class="k">struct</span> <span class="n">smd_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">write_avail</span><span class="p">)(</span><span class="k">struct</span> <span class="n">smd_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">);</span>

	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">update_state</span><span class="p">)(</span><span class="k">struct</span> <span class="n">smd_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">last_state</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">notify_other_cpu</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">type</span><span class="p">;</span>

	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="n">pdev</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define SMD_TYPE_MASK		0x0FF</span>
<span class="cp">#define SMD_TYPE_APPS_MODEM	0x000</span>
<span class="cp">#define SMD_TYPE_APPS_DSP	0x001</span>
<span class="cp">#define SMD_TYPE_MODEM_DSP	0x002</span>

<span class="cp">#define SMD_KIND_MASK		0xF00</span>
<span class="cp">#define SMD_KIND_UNKNOWN	0x000</span>
<span class="cp">#define SMD_KIND_STREAM		0x100</span>
<span class="cp">#define SMD_KIND_PACKET		0x200</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="n">smd_ch_closed_list</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="n">smd_ch_list_modem</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="n">smd_ch_list_dsp</span><span class="p">;</span>

<span class="k">extern</span> <span class="n">spinlock_t</span> <span class="n">smd_lock</span><span class="p">;</span>
<span class="k">extern</span> <span class="n">spinlock_t</span> <span class="n">smem_lock</span><span class="p">;</span>

<span class="kt">void</span> <span class="o">*</span><span class="n">smem_find</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">size</span><span class="p">);</span>
<span class="kt">void</span> <span class="o">*</span><span class="n">smem_item</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="o">*</span><span class="n">size</span><span class="p">);</span>
<span class="kt">uint32_t</span> <span class="n">raw_smsm_get_state</span><span class="p">(</span><span class="k">enum</span> <span class="n">smsm_state_item</span> <span class="n">item</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">msm_init_last_radio_log</span><span class="p">(</span><span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_MSM_SMD_PKG3</span>
<span class="cm">/*</span>
<span class="cm"> * This allocator assumes an SMD Package v3 which only exists on</span>
<span class="cm"> * MSM7x00 SoC&#39;s.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">_smd_alloc_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">smd_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smd_shared_v1</span> <span class="o">*</span><span class="n">shared1</span><span class="p">;</span>

	<span class="n">shared1</span> <span class="o">=</span> <span class="n">smem_alloc</span><span class="p">(</span><span class="n">ID_SMD_CHANNELS</span> <span class="o">+</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">shared1</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">shared1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;smd_alloc_channel() cid %d does not exist</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">send</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">shared1</span><span class="o">-&gt;</span><span class="n">ch0</span><span class="p">;</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">recv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">shared1</span><span class="o">-&gt;</span><span class="n">ch1</span><span class="p">;</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">send_data</span> <span class="o">=</span> <span class="n">shared1</span><span class="o">-&gt;</span><span class="n">data0</span><span class="p">;</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">recv_data</span> <span class="o">=</span> <span class="n">shared1</span><span class="o">-&gt;</span><span class="n">data1</span><span class="p">;</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="n">SMD_BUF_SIZE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cm">/*</span>
<span class="cm"> * This allocator assumes an SMD Package v4, the most common</span>
<span class="cm"> * and the default.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">_smd_alloc_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">smd_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smd_shared_v2</span> <span class="o">*</span><span class="n">shared2</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">buffer_sz</span><span class="p">;</span>

	<span class="n">shared2</span> <span class="o">=</span> <span class="n">smem_alloc</span><span class="p">(</span><span class="n">SMEM_SMD_BASE_ID</span> <span class="o">+</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">shared2</span><span class="p">));</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="n">smem_item</span><span class="p">(</span><span class="n">SMEM_SMD_FIFO_BASE_ID</span> <span class="o">+</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer_sz</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* buffer must be a power-of-two size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer_sz</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">buffer_sz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">buffer_sz</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">send</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">shared2</span><span class="o">-&gt;</span><span class="n">ch0</span><span class="p">;</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">recv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">shared2</span><span class="o">-&gt;</span><span class="n">ch1</span><span class="p">;</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">send_data</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">recv_data</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">buffer_sz</span><span class="p">;</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="n">buffer_sz</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MSM_SMD_PKG3 */</span><span class="cp"></span>

<span class="cp">#if defined(CONFIG_ARCH_MSM7X30)</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">msm_a2m_int</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">irq</span><span class="p">,</span> <span class="n">MSM_GCC_BASE</span> <span class="o">+</span> <span class="mh">0x8</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">msm_a2m_int</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">MSM_CSR_BASE</span> <span class="o">+</span> <span class="mh">0x400</span> <span class="o">+</span> <span class="p">(</span><span class="n">irq</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ARCH_MSM7X30 */</span><span class="cp"></span>


<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
