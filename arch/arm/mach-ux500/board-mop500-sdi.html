<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › mach-ux500 › board-mop500-sdi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>board-mop500-sdi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) ST-Ericsson SA 2010</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Hanumath Prasad &lt;hanumath.prasad@stericsson.com&gt;</span>
<span class="cm"> * License terms: GNU General Public License (GPL) version 2</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/amba/bus.h&gt;</span>
<span class="cp">#include &lt;linux/amba/mmci.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/host.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>

<span class="cp">#include &lt;asm/mach-types.h&gt;</span>
<span class="cp">#include &lt;plat/ste_dma40.h&gt;</span>
<span class="cp">#include &lt;mach/devices.h&gt;</span>
<span class="cp">#include &lt;mach/hardware.h&gt;</span>

<span class="cp">#include &quot;devices-db8500.h&quot;</span>
<span class="cp">#include &quot;board-mop500.h&quot;</span>
<span class="cp">#include &quot;ste-dma40-db8500.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * v2 has a new version of this block that need to be forced, the number found</span>
<span class="cm"> * in hardware is incorrect</span>
<span class="cm"> */</span>
<span class="cp">#define U8500_SDI_V2_PERIPHID 0x10480180</span>

<span class="cm">/*</span>
<span class="cm"> * SDI 0 (MicroSD slot)</span>
<span class="cm"> */</span>

<span class="cm">/* GPIO pins used by the sdi0 level shifter */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sdi0_en</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sdi0_vsel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mop500_sdi0_ios_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_ios</span> <span class="o">*</span><span class="n">ios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">power_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MMC_POWER_UP</span>:
	<span class="k">case</span> <span class="n">MMC_POWER_ON</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Level shifter voltage should depend on vdd to when deciding</span>
<span class="cm">		 * on either 1.8V or 2.9V. Once the decision has been made the</span>
<span class="cm">		 * level shifter must be disabled and re-enabled with a changed</span>
<span class="cm">		 * select signal in order to switch the voltage. Since there is</span>
<span class="cm">		 * no framework support yet for indicating 1.8V in vdd, use the</span>
<span class="cm">		 * default 2.9V.</span>
<span class="cm">		 */</span>
		<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">sdi0_vsel</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">sdi0_en</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MMC_POWER_OFF</span>:
		<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">sdi0_vsel</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">sdi0_en</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_STE_DMA40</span>
<span class="k">struct</span> <span class="n">stedma40_chan_cfg</span> <span class="n">mop500_sdi0_dma_cfg_rx</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">STEDMA40_MODE_LOGICAL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="n">STEDMA40_PERIPH_TO_MEM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_dev_type</span> <span class="o">=</span> <span class="n">DB8500_DMA_DEV29_SD_MM0_RX</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dst_dev_type</span> <span class="o">=</span> <span class="n">STEDMA40_DEV_DST_MEMORY</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_info</span><span class="p">.</span><span class="n">data_width</span> <span class="o">=</span> <span class="n">STEDMA40_WORD_WIDTH</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dst_info</span><span class="p">.</span><span class="n">data_width</span> <span class="o">=</span> <span class="n">STEDMA40_WORD_WIDTH</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">stedma40_chan_cfg</span> <span class="n">mop500_sdi0_dma_cfg_tx</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">STEDMA40_MODE_LOGICAL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="n">STEDMA40_MEM_TO_PERIPH</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_dev_type</span> <span class="o">=</span> <span class="n">STEDMA40_DEV_SRC_MEMORY</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dst_dev_type</span> <span class="o">=</span> <span class="n">DB8500_DMA_DEV29_SD_MM0_TX</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_info</span><span class="p">.</span><span class="n">data_width</span> <span class="o">=</span> <span class="n">STEDMA40_WORD_WIDTH</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dst_info</span><span class="p">.</span><span class="n">data_width</span> <span class="o">=</span> <span class="n">STEDMA40_WORD_WIDTH</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mmci_platform_data</span> <span class="n">mop500_sdi0_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ios_handler</span>	<span class="o">=</span> <span class="n">mop500_sdi0_ios_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ocr_mask</span>	<span class="o">=</span> <span class="n">MMC_VDD_29_30</span><span class="p">,</span>
	<span class="p">.</span><span class="n">f_max</span>		<span class="o">=</span> <span class="mi">50000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">capabilities</span>	<span class="o">=</span> <span class="n">MMC_CAP_4_BIT_DATA</span> <span class="o">|</span>
				<span class="n">MMC_CAP_SD_HIGHSPEED</span> <span class="o">|</span>
				<span class="n">MMC_CAP_MMC_HIGHSPEED</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gpio_wp</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sigdir</span>		<span class="o">=</span> <span class="n">MCI_ST_FBCLKEN</span> <span class="o">|</span>
				<span class="n">MCI_ST_CMDDIREN</span> <span class="o">|</span>
				<span class="n">MCI_ST_DATA0DIREN</span> <span class="o">|</span>
				<span class="n">MCI_ST_DATA2DIREN</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_STE_DMA40</span>
	<span class="p">.</span><span class="n">dma_filter</span>	<span class="o">=</span> <span class="n">stedma40_filter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_rx_param</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">mop500_sdi0_dma_cfg_rx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_tx_param</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">mop500_sdi0_dma_cfg_tx</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdi0_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">sdi0_en</span><span class="p">,</span> <span class="s">&quot;level shifter enable&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">sdi0_vsel</span><span class="p">,</span>
				   <span class="s">&quot;level shifter 1v8-3v select&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;unable to config sdi0 gpios for level shifter.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Select the default 2.9V and enable level shifter */</span>
	<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">sdi0_vsel</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">sdi0_en</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Add the device, force v2 to subrevision 1 */</span>
	<span class="n">db8500_add_sdi0</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mop500_sdi0_data</span><span class="p">,</span> <span class="n">U8500_SDI_V2_PERIPHID</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mop500_sdi_tc35892_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mop500_sdi0_data</span><span class="p">.</span><span class="n">gpio_cd</span> <span class="o">=</span> <span class="n">GPIO_SDMMC_CD</span><span class="p">;</span>
	<span class="n">sdi0_en</span> <span class="o">=</span> <span class="n">GPIO_SDMMC_EN</span><span class="p">;</span>
	<span class="n">sdi0_vsel</span> <span class="o">=</span> <span class="n">GPIO_SDMMC_1V8_3V_SEL</span><span class="p">;</span>
	<span class="n">sdi0_configure</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * SDI1 (SDIO WLAN)</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_STE_DMA40</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">stedma40_chan_cfg</span> <span class="n">sdi1_dma_cfg_rx</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">STEDMA40_MODE_LOGICAL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="n">STEDMA40_PERIPH_TO_MEM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_dev_type</span> <span class="o">=</span> <span class="n">DB8500_DMA_DEV32_SD_MM1_RX</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dst_dev_type</span> <span class="o">=</span> <span class="n">STEDMA40_DEV_DST_MEMORY</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_info</span><span class="p">.</span><span class="n">data_width</span> <span class="o">=</span> <span class="n">STEDMA40_WORD_WIDTH</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dst_info</span><span class="p">.</span><span class="n">data_width</span> <span class="o">=</span> <span class="n">STEDMA40_WORD_WIDTH</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">stedma40_chan_cfg</span> <span class="n">sdi1_dma_cfg_tx</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">STEDMA40_MODE_LOGICAL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="n">STEDMA40_MEM_TO_PERIPH</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_dev_type</span> <span class="o">=</span> <span class="n">STEDMA40_DEV_SRC_MEMORY</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dst_dev_type</span> <span class="o">=</span> <span class="n">DB8500_DMA_DEV32_SD_MM1_TX</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_info</span><span class="p">.</span><span class="n">data_width</span> <span class="o">=</span> <span class="n">STEDMA40_WORD_WIDTH</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dst_info</span><span class="p">.</span><span class="n">data_width</span> <span class="o">=</span> <span class="n">STEDMA40_WORD_WIDTH</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mmci_platform_data</span> <span class="n">mop500_sdi1_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ocr_mask</span>	<span class="o">=</span> <span class="n">MMC_VDD_29_30</span><span class="p">,</span>
	<span class="p">.</span><span class="n">f_max</span>		<span class="o">=</span> <span class="mi">50000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">capabilities</span>	<span class="o">=</span> <span class="n">MMC_CAP_4_BIT_DATA</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gpio_cd</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gpio_wp</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_STE_DMA40</span>
	<span class="p">.</span><span class="n">dma_filter</span>	<span class="o">=</span> <span class="n">stedma40_filter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_rx_param</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">sdi1_dma_cfg_rx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_tx_param</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">sdi1_dma_cfg_tx</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * SDI 2 (POP eMMC, not on DB8500ed)</span>
<span class="cm"> */</span>

<span class="cp">#ifdef CONFIG_STE_DMA40</span>
<span class="k">struct</span> <span class="n">stedma40_chan_cfg</span> <span class="n">mop500_sdi2_dma_cfg_rx</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">STEDMA40_MODE_LOGICAL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="n">STEDMA40_PERIPH_TO_MEM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_dev_type</span> <span class="o">=</span>  <span class="n">DB8500_DMA_DEV28_SD_MM2_RX</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dst_dev_type</span> <span class="o">=</span> <span class="n">STEDMA40_DEV_DST_MEMORY</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_info</span><span class="p">.</span><span class="n">data_width</span> <span class="o">=</span> <span class="n">STEDMA40_WORD_WIDTH</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dst_info</span><span class="p">.</span><span class="n">data_width</span> <span class="o">=</span> <span class="n">STEDMA40_WORD_WIDTH</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">stedma40_chan_cfg</span> <span class="n">mop500_sdi2_dma_cfg_tx</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">STEDMA40_MODE_LOGICAL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="n">STEDMA40_MEM_TO_PERIPH</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_dev_type</span> <span class="o">=</span> <span class="n">STEDMA40_DEV_SRC_MEMORY</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dst_dev_type</span> <span class="o">=</span> <span class="n">DB8500_DMA_DEV28_SD_MM2_TX</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_info</span><span class="p">.</span><span class="n">data_width</span> <span class="o">=</span> <span class="n">STEDMA40_WORD_WIDTH</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dst_info</span><span class="p">.</span><span class="n">data_width</span> <span class="o">=</span> <span class="n">STEDMA40_WORD_WIDTH</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mmci_platform_data</span> <span class="n">mop500_sdi2_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ocr_mask</span>	<span class="o">=</span> <span class="n">MMC_VDD_165_195</span><span class="p">,</span>
	<span class="p">.</span><span class="n">f_max</span>		<span class="o">=</span> <span class="mi">50000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">capabilities</span>	<span class="o">=</span> <span class="n">MMC_CAP_4_BIT_DATA</span> <span class="o">|</span> <span class="n">MMC_CAP_8_BIT_DATA</span> <span class="o">|</span>
			  <span class="n">MMC_CAP_MMC_HIGHSPEED</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gpio_cd</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gpio_wp</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_STE_DMA40</span>
	<span class="p">.</span><span class="n">dma_filter</span>	<span class="o">=</span> <span class="n">stedma40_filter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_rx_param</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">mop500_sdi2_dma_cfg_rx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_tx_param</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">mop500_sdi2_dma_cfg_tx</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * SDI 4 (on-board eMMC)</span>
<span class="cm"> */</span>

<span class="cp">#ifdef CONFIG_STE_DMA40</span>
<span class="k">struct</span> <span class="n">stedma40_chan_cfg</span> <span class="n">mop500_sdi4_dma_cfg_rx</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">STEDMA40_MODE_LOGICAL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="n">STEDMA40_PERIPH_TO_MEM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_dev_type</span> <span class="o">=</span>  <span class="n">DB8500_DMA_DEV42_SD_MM4_RX</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dst_dev_type</span> <span class="o">=</span> <span class="n">STEDMA40_DEV_DST_MEMORY</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_info</span><span class="p">.</span><span class="n">data_width</span> <span class="o">=</span> <span class="n">STEDMA40_WORD_WIDTH</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dst_info</span><span class="p">.</span><span class="n">data_width</span> <span class="o">=</span> <span class="n">STEDMA40_WORD_WIDTH</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">stedma40_chan_cfg</span> <span class="n">mop500_sdi4_dma_cfg_tx</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">STEDMA40_MODE_LOGICAL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="n">STEDMA40_MEM_TO_PERIPH</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_dev_type</span> <span class="o">=</span> <span class="n">STEDMA40_DEV_SRC_MEMORY</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dst_dev_type</span> <span class="o">=</span> <span class="n">DB8500_DMA_DEV42_SD_MM4_TX</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_info</span><span class="p">.</span><span class="n">data_width</span> <span class="o">=</span> <span class="n">STEDMA40_WORD_WIDTH</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dst_info</span><span class="p">.</span><span class="n">data_width</span> <span class="o">=</span> <span class="n">STEDMA40_WORD_WIDTH</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mmci_platform_data</span> <span class="n">mop500_sdi4_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ocr_mask</span>	<span class="o">=</span> <span class="n">MMC_VDD_29_30</span><span class="p">,</span>
	<span class="p">.</span><span class="n">f_max</span>		<span class="o">=</span> <span class="mi">50000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">capabilities</span>	<span class="o">=</span> <span class="n">MMC_CAP_4_BIT_DATA</span> <span class="o">|</span> <span class="n">MMC_CAP_8_BIT_DATA</span> <span class="o">|</span>
			  <span class="n">MMC_CAP_MMC_HIGHSPEED</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gpio_cd</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gpio_wp</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_STE_DMA40</span>
	<span class="p">.</span><span class="n">dma_filter</span>	<span class="o">=</span> <span class="n">stedma40_filter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_rx_param</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">mop500_sdi4_dma_cfg_rx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_tx_param</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">mop500_sdi4_dma_cfg_tx</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">mop500_sdi_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* PoP:ed eMMC */</span>
	<span class="n">db8500_add_sdi2</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mop500_sdi2_data</span><span class="p">,</span> <span class="n">U8500_SDI_V2_PERIPHID</span><span class="p">);</span>
	<span class="cm">/* On-board eMMC */</span>
	<span class="n">db8500_add_sdi4</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mop500_sdi4_data</span><span class="p">,</span> <span class="n">U8500_SDI_V2_PERIPHID</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * On boards with the TC35892 GPIO expander, sdi0 will finally</span>
<span class="cm">	 * be added when the TC35892 initializes and calls</span>
<span class="cm">	 * mop500_sdi_tc35892_init() above.</span>
<span class="cm">	 */</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">snowball_sdi_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* On Snowball MMC_CAP_SD_HIGHSPEED isn&#39;t supported (Hardware issue?) */</span>
	<span class="n">mop500_sdi0_data</span><span class="p">.</span><span class="n">capabilities</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MMC_CAP_SD_HIGHSPEED</span><span class="p">;</span>
	<span class="cm">/* On-board eMMC */</span>
	<span class="n">db8500_add_sdi4</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mop500_sdi4_data</span><span class="p">,</span> <span class="n">U8500_SDI_V2_PERIPHID</span><span class="p">);</span>
	<span class="cm">/* External Micro SD slot */</span>
	<span class="n">mop500_sdi0_data</span><span class="p">.</span><span class="n">gpio_cd</span> <span class="o">=</span> <span class="n">SNOWBALL_SDMMC_CD_GPIO</span><span class="p">;</span>
	<span class="n">mop500_sdi0_data</span><span class="p">.</span><span class="n">cd_invert</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">sdi0_en</span> <span class="o">=</span> <span class="n">SNOWBALL_SDMMC_EN_GPIO</span><span class="p">;</span>
	<span class="n">sdi0_vsel</span> <span class="o">=</span> <span class="n">SNOWBALL_SDMMC_1V8_3V_GPIO</span><span class="p">;</span>
	<span class="n">sdi0_configure</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">hrefv60_sdi_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* PoP:ed eMMC */</span>
	<span class="n">db8500_add_sdi2</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mop500_sdi2_data</span><span class="p">,</span> <span class="n">U8500_SDI_V2_PERIPHID</span><span class="p">);</span>
	<span class="cm">/* On-board eMMC */</span>
	<span class="n">db8500_add_sdi4</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mop500_sdi4_data</span><span class="p">,</span> <span class="n">U8500_SDI_V2_PERIPHID</span><span class="p">);</span>
	<span class="cm">/* External Micro SD slot */</span>
	<span class="n">mop500_sdi0_data</span><span class="p">.</span><span class="n">gpio_cd</span> <span class="o">=</span> <span class="n">HREFV60_SDMMC_CD_GPIO</span><span class="p">;</span>
	<span class="n">sdi0_en</span> <span class="o">=</span> <span class="n">HREFV60_SDMMC_EN_GPIO</span><span class="p">;</span>
	<span class="n">sdi0_vsel</span> <span class="o">=</span> <span class="n">HREFV60_SDMMC_1V8_3V_GPIO</span><span class="p">;</span>
	<span class="n">sdi0_configure</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
	<span class="cm">/* WLAN SDIO channel */</span>
	<span class="n">db8500_add_sdi1</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mop500_sdi1_data</span><span class="p">,</span> <span class="n">U8500_SDI_V2_PERIPHID</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
