<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › plat-iop › pci.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>pci.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * arch/arm/plat-iop/pci.c</span>
<span class="cm"> *</span>
<span class="cm"> * PCI support for the Intel IOP32X and IOP33X processors</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Rory Bolt &lt;rorybolt@pacbell.net&gt;</span>
<span class="cm"> * Copyright (C) 2002 Rory Bolt</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/signal.h&gt;</span>
<span class="cp">#include &lt;mach/hardware.h&gt;</span>
<span class="cp">#include &lt;asm/mach/pci.h&gt;</span>
<span class="cp">#include &lt;asm/hardware/iop3xx.h&gt;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><h1>define DEBUG</h1></td><td class="code"><div class="highlight"><pre><span class="cp">#ifdef DEBUG</span>
<span class="cp">#define  DBG(x...) printk(x)</span>
<span class="cp">#else</span>
<span class="cp">#define  DBG(x...) do { } while (0)</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * This routine builds either a type0 or type1 configuration command.  If the</span>
<span class="cm"> * bus is on the 803xx then a type0 made, else a type1 is created.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">iop3xx_cfg_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">where</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_sys_data</span> <span class="o">*</span><span class="n">sys</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">sysdata</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sys</span><span class="o">-&gt;</span><span class="n">busnr</span> <span class="o">==</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">)</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">devfn</span><span class="p">)</span> <span class="o">+</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">devfn</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">devfn</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">|=</span>	<span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">devfn</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="p">(</span><span class="n">where</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine checks the status of the last configuration cycle.  If an error</span>
<span class="cm"> * was detected it returns a 1, else it returns a 0.  The errors being checked</span>
<span class="cm"> * are parity, master abort, target abort (master and target).  These types of</span>
<span class="cm"> * errors occur during a config cycle where there is no device, like during</span>
<span class="cm"> * the discovery stage.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">iop3xx_pci_status</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check the status registers.</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="o">*</span><span class="n">IOP3XX_ATUSR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xf900</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t\t</span><span class="s">PCI: P0 - status = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="o">*</span><span class="n">IOP3XX_ATUSR</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xf900</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="o">*</span><span class="n">IOP3XX_ATUISR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x679f</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t\t\t</span><span class="s">PCI: P1 - status = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="o">*</span><span class="n">IOP3XX_ATUISR</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x679f</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Simply write the address register and read the configuration</span>
<span class="cm"> * data.  Note that the 4 nops ensure that we are able to handle</span>
<span class="cm"> * a delayed abort (in theory.)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">iop3xx_read</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span>
		<span class="s">&quot;str	%1, [%2]</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;ldr	%0, [%3]</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;nop</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;nop</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;nop</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;nop</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">addr</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">IOP3XX_OCCAR</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">IOP3XX_OCCDR</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The read routines must check the error status of the last configuration</span>
<span class="cm"> * cycle.  If there was an error, the routine returns all hex f&#39;s.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">iop3xx_read_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">where</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">iop3xx_cfg_address</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">where</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">iop3xx_read</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">((</span><span class="n">where</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iop3xx_pci_status</span><span class="p">())</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>

	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">PCIBIOS_SUCCESSFUL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">iop3xx_write_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">where</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">iop3xx_cfg_address</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">where</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">iop3xx_read</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iop3xx_pci_status</span><span class="p">())</span>
			<span class="k">return</span> <span class="n">PCIBIOS_SUCCESSFUL</span><span class="p">;</span>

		<span class="n">where</span> <span class="o">=</span> <span class="p">(</span><span class="n">where</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xff</span> <span class="o">&lt;&lt;</span> <span class="n">where</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xffff</span> <span class="o">&lt;&lt;</span> <span class="n">where</span><span class="p">);</span>

		<span class="o">*</span><span class="n">IOP3XX_OCCDR</span> <span class="o">=</span> <span class="n">val</span> <span class="o">|</span> <span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="n">where</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span>
			<span class="s">&quot;str	%1, [%2]</span><span class="se">\n\t</span><span class="s">&quot;</span>
			<span class="s">&quot;str	%0, [%3]</span><span class="se">\n\t</span><span class="s">&quot;</span>
			<span class="s">&quot;nop</span><span class="se">\n\t</span><span class="s">&quot;</span>
			<span class="s">&quot;nop</span><span class="se">\n\t</span><span class="s">&quot;</span>
			<span class="s">&quot;nop</span><span class="se">\n\t</span><span class="s">&quot;</span>
			<span class="s">&quot;nop</span><span class="se">\n\t</span><span class="s">&quot;</span>
			<span class="o">:</span>
			<span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">addr</span><span class="p">),</span>
			  <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">IOP3XX_OCCAR</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">IOP3XX_OCCDR</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">PCIBIOS_SUCCESSFUL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">pci_ops</span> <span class="n">iop3xx_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span>	<span class="o">=</span> <span class="n">iop3xx_read_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>	<span class="o">=</span> <span class="n">iop3xx_write_config</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * When a PCI device does not exist during config cycles, the 80200 gets a</span>
<span class="cm"> * bus error instead of returning 0xffffffff. This handler simply returns.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">iop3xx_pci_abort</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fsr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;PCI abort: address = 0x%08lx fsr = 0x%03x PC = 0x%08lx LR = 0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">addr</span><span class="p">,</span> <span class="n">fsr</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ARM_pc</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ARM_lr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If it was an imprecise abort, then we need to correct the</span>
<span class="cm">	 * return address to be _after_ the instruction.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fsr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">))</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">ARM_pc</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">iop3xx_pci_setup</span><span class="p">(</span><span class="kt">int</span> <span class="n">nr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_sys_data</span> <span class="o">*</span><span class="n">sys</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;PCI: unable to alloc resources&quot;</span><span class="p">);</span>

	<span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span> <span class="o">=</span> <span class="n">IOP3XX_PCI_LOWER_IO_PA</span><span class="p">;</span>
	<span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">end</span>   <span class="o">=</span> <span class="n">IOP3XX_PCI_LOWER_IO_PA</span> <span class="o">+</span> <span class="n">IOP3XX_PCI_IO_WINDOW_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;IOP3XX PCI I/O Space&quot;</span><span class="p">;</span>
	<span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IO</span><span class="p">;</span>
	<span class="n">request_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioport_resource</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span> <span class="o">=</span> <span class="n">IOP3XX_PCI_LOWER_MEM_PA</span><span class="p">;</span>
	<span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">end</span>   <span class="o">=</span> <span class="n">IOP3XX_PCI_LOWER_MEM_PA</span> <span class="o">+</span> <span class="n">IOP3XX_PCI_MEM_WINDOW_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;IOP3XX PCI Memory Space&quot;</span><span class="p">;</span>
	<span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">;</span>
	<span class="n">request_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iomem_resource</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Use whatever translation is already setup.</span>
<span class="cm">	 */</span>
	<span class="n">sys</span><span class="o">-&gt;</span><span class="n">mem_offset</span> <span class="o">=</span> <span class="n">IOP3XX_PCI_LOWER_MEM_PA</span> <span class="o">-</span> <span class="o">*</span><span class="n">IOP3XX_OMWTVR0</span><span class="p">;</span>
	<span class="n">sys</span><span class="o">-&gt;</span><span class="n">io_offset</span>  <span class="o">=</span> <span class="n">IOP3XX_PCI_LOWER_IO_PA</span> <span class="o">-</span> <span class="o">*</span><span class="n">IOP3XX_OIOWTVR</span><span class="p">;</span>

	<span class="n">pci_add_resource_offset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sys</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sys</span><span class="o">-&gt;</span><span class="n">io_offset</span><span class="p">);</span>
	<span class="n">pci_add_resource_offset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sys</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sys</span><span class="o">-&gt;</span><span class="n">mem_offset</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">iop3xx_atu_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* BAR 0 ( Disabled ) */</span>
	<span class="o">*</span><span class="n">IOP3XX_IAUBAR0</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">IOP3XX_IABAR0</span>  <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">IOP3XX_IATVR0</span>  <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">IOP3XX_IALR0</span>   <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>

	<span class="cm">/* BAR 1 ( Disabled ) */</span>
	<span class="o">*</span><span class="n">IOP3XX_IAUBAR1</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">IOP3XX_IABAR1</span>  <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">IOP3XX_IALR1</span>   <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>

	<span class="cm">/* BAR 2 (1:1 mapping with Physical RAM) */</span>
	<span class="cm">/* Set limit and enable */</span>
	<span class="o">*</span><span class="n">IOP3XX_IALR2</span> <span class="o">=</span> <span class="o">~</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">IOP3XX_MAX_RAM_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1</span><span class="p">;</span>
	<span class="o">*</span><span class="n">IOP3XX_IAUBAR2</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>

	<span class="cm">/* Align the inbound bar with the base of memory */</span>
	<span class="o">*</span><span class="n">IOP3XX_IABAR2</span> <span class="o">=</span> <span class="n">PHYS_OFFSET</span> <span class="o">|</span>
			       <span class="n">PCI_BASE_ADDRESS_MEM_TYPE_64</span> <span class="o">|</span>
			       <span class="n">PCI_BASE_ADDRESS_MEM_PREFETCH</span><span class="p">;</span>

	<span class="o">*</span><span class="n">IOP3XX_IATVR2</span> <span class="o">=</span> <span class="n">PHYS_OFFSET</span><span class="p">;</span>

	<span class="cm">/* Outbound window 0 */</span>
	<span class="o">*</span><span class="n">IOP3XX_OMWTVR0</span> <span class="o">=</span> <span class="n">IOP3XX_PCI_LOWER_MEM_BA</span><span class="p">;</span>
	<span class="o">*</span><span class="n">IOP3XX_OUMWTVR0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Outbound window 1 */</span>
	<span class="o">*</span><span class="n">IOP3XX_OMWTVR1</span> <span class="o">=</span> <span class="n">IOP3XX_PCI_LOWER_MEM_BA</span> <span class="o">+</span>
			  <span class="n">IOP3XX_PCI_MEM_WINDOW_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="o">*</span><span class="n">IOP3XX_OUMWTVR1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* BAR 3 ( Disabled ) */</span>
	<span class="o">*</span><span class="n">IOP3XX_IAUBAR3</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">IOP3XX_IABAR3</span>  <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">IOP3XX_IATVR3</span>  <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">IOP3XX_IALR3</span>   <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>

	<span class="cm">/* Setup the I/O Bar</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">IOP3XX_OIOWTVR</span> <span class="o">=</span> <span class="n">IOP3XX_PCI_LOWER_IO_BA</span><span class="p">;</span>

	<span class="cm">/* Enable inbound and outbound cycles</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">IOP3XX_ATUCMD</span> <span class="o">|=</span> <span class="n">PCI_COMMAND_MEMORY</span> <span class="o">|</span> <span class="n">PCI_COMMAND_MASTER</span> <span class="o">|</span>
			       <span class="n">PCI_COMMAND_PARITY</span> <span class="o">|</span> <span class="n">PCI_COMMAND_SERR</span><span class="p">;</span>
	<span class="o">*</span><span class="n">IOP3XX_ATUCR</span> <span class="o">|=</span> <span class="n">IOP3XX_ATUCR_OUT_EN</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">iop3xx_atu_disable</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">IOP3XX_ATUCMD</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">IOP3XX_ATUCR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* wait for cycles to quiesce */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">IOP3XX_PCSR</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IOP3XX_PCSR_OUT_Q_BUSY</span> <span class="o">|</span>
				     <span class="n">IOP3XX_PCSR_IN_Q_BUSY</span><span class="p">))</span>
		<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="cm">/* BAR 0 ( Disabled ) */</span>
	<span class="o">*</span><span class="n">IOP3XX_IAUBAR0</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">IOP3XX_IABAR0</span>  <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">IOP3XX_IATVR0</span>  <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">IOP3XX_IALR0</span>   <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>

	<span class="cm">/* BAR 1 ( Disabled ) */</span>
	<span class="o">*</span><span class="n">IOP3XX_IAUBAR1</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">IOP3XX_IABAR1</span>  <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">IOP3XX_IALR1</span>   <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>

	<span class="cm">/* BAR 2 ( Disabled ) */</span>
	<span class="o">*</span><span class="n">IOP3XX_IAUBAR2</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">IOP3XX_IABAR2</span>  <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">IOP3XX_IATVR2</span>  <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">IOP3XX_IALR2</span>   <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>

	<span class="cm">/* BAR 3 ( Disabled ) */</span>
	<span class="o">*</span><span class="n">IOP3XX_IAUBAR3</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">IOP3XX_IABAR3</span>  <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">IOP3XX_IATVR3</span>  <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">IOP3XX_IALR3</span>   <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>

	<span class="cm">/* Clear the outbound windows */</span>
	<span class="o">*</span><span class="n">IOP3XX_OIOWTVR</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Outbound window 0 */</span>
	<span class="o">*</span><span class="n">IOP3XX_OMWTVR0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">IOP3XX_OUMWTVR0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Outbound window 1 */</span>
	<span class="o">*</span><span class="n">IOP3XX_OMWTVR1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">IOP3XX_OUMWTVR1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Flag to determine whether the ATU is initialized and the PCI bus scanned */</span>
<span class="kt">int</span> <span class="n">init_atu</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">iop3xx_get_init_atu</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* check if default has been overridden */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">init_atu</span> <span class="o">!=</span> <span class="n">IOP3XX_INIT_ATU_DEFAULT</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">init_atu</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">IOP3XX_INIT_ATU_DISABLE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">iop3xx_atu_debug</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;PCI: Intel IOP3xx PCI init.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;PCI: Outbound memory window 0: PCI 0x%08x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="o">*</span><span class="n">IOP3XX_OUMWTVR0</span><span class="p">,</span> <span class="o">*</span><span class="n">IOP3XX_OMWTVR0</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;PCI: Outbound memory window 1: PCI 0x%08x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="o">*</span><span class="n">IOP3XX_OUMWTVR1</span><span class="p">,</span> <span class="o">*</span><span class="n">IOP3XX_OMWTVR1</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;PCI: Outbound IO window: PCI 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="o">*</span><span class="n">IOP3XX_OIOWTVR</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;PCI: Inbound memory window 0: PCI 0x%08x%08x 0x%08x -&gt; 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="o">*</span><span class="n">IOP3XX_IAUBAR0</span><span class="p">,</span> <span class="o">*</span><span class="n">IOP3XX_IABAR0</span><span class="p">,</span> <span class="o">*</span><span class="n">IOP3XX_IALR0</span><span class="p">,</span> <span class="o">*</span><span class="n">IOP3XX_IATVR0</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;PCI: Inbound memory window 1: PCI 0x%08x%08x 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="o">*</span><span class="n">IOP3XX_IAUBAR1</span><span class="p">,</span> <span class="o">*</span><span class="n">IOP3XX_IABAR1</span><span class="p">,</span> <span class="o">*</span><span class="n">IOP3XX_IALR1</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;PCI: Inbound memory window 2: PCI 0x%08x%08x 0x%08x -&gt; 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="o">*</span><span class="n">IOP3XX_IAUBAR2</span><span class="p">,</span> <span class="o">*</span><span class="n">IOP3XX_IABAR2</span><span class="p">,</span> <span class="o">*</span><span class="n">IOP3XX_IALR2</span><span class="p">,</span> <span class="o">*</span><span class="n">IOP3XX_IATVR2</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;PCI: Inbound memory window 3: PCI 0x%08x%08x 0x%08x -&gt; 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="o">*</span><span class="n">IOP3XX_IAUBAR3</span><span class="p">,</span> <span class="o">*</span><span class="n">IOP3XX_IABAR3</span><span class="p">,</span> <span class="o">*</span><span class="n">IOP3XX_IALR3</span><span class="p">,</span> <span class="o">*</span><span class="n">IOP3XX_IATVR3</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;PCI: Expansion ROM window: PCI 0x%08x%08x 0x%08x -&gt; 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">IOP3XX_ERBAR</span><span class="p">,</span> <span class="o">*</span><span class="n">IOP3XX_ERLR</span><span class="p">,</span> <span class="o">*</span><span class="n">IOP3XX_ERTVR</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;ATU: IOP3XX_ATUCMD=0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">IOP3XX_ATUCMD</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;ATU: IOP3XX_ATUCR=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">IOP3XX_ATUCR</span><span class="p">);</span>

	<span class="n">hook_fault_code</span><span class="p">(</span><span class="mi">16</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="n">iop3xx_pci_abort</span><span class="p">,</span> <span class="n">SIGBUS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;imprecise external abort&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* for platforms that might be host-bus-adapters */</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">iop3xx_pci_preinit_cond</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iop3xx_get_init_atu</span><span class="p">()</span> <span class="o">==</span> <span class="n">IOP3XX_INIT_ATU_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iop3xx_atu_disable</span><span class="p">();</span>
		<span class="n">iop3xx_atu_setup</span><span class="p">();</span>
		<span class="n">iop3xx_atu_debug</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">iop3xx_pci_preinit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pcibios_min_io</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pcibios_min_mem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">iop3xx_atu_disable</span><span class="p">();</span>
	<span class="n">iop3xx_atu_setup</span><span class="p">();</span>
	<span class="n">iop3xx_atu_debug</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* allow init_atu to be user overridden */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">iop3xx_init_atu_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">init_atu</span> <span class="o">=</span> <span class="n">IOP3XX_INIT_ATU_DEFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="sc">&#39;y&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;Y&#39;</span>:
				<span class="n">init_atu</span> <span class="o">=</span> <span class="n">IOP3XX_INIT_ATU_ENABLE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;n&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;N&#39;</span>:
				<span class="n">init_atu</span> <span class="o">=</span> <span class="n">IOP3XX_INIT_ATU_DISABLE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;,&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> malformed at &quot;</span>
					    <span class="s">&quot;character: </span><span class="se">\&#39;</span><span class="s">%c</span><span class="se">\&#39;</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">__func__</span><span class="p">,</span>
					    <span class="o">*</span><span class="n">str</span><span class="p">);</span>
				<span class="o">*</span><span class="p">(</span><span class="n">str</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">str</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;iop3xx_init_atu&quot;</span><span class="p">,</span> <span class="n">iop3xx_init_atu_setup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
