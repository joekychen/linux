<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › common › locomo.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>locomo.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/arch/arm/common/locomo.c</span>
<span class="cm"> *</span>
<span class="cm"> * Sharp LoCoMo support</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This file contains all generic LoCoMo support.</span>
<span class="cm"> *</span>
<span class="cm"> * All initialization functions provided here are intended to be called</span>
<span class="cm"> * from machine specific code with proper arguments when required.</span>
<span class="cm"> *</span>
<span class="cm"> * Based on sa1111.c</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>

<span class="cp">#include &lt;mach/hardware.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/mach/irq.h&gt;</span>

<span class="cp">#include &lt;asm/hardware/locomo.h&gt;</span>

<span class="cm">/* LoCoMo Interrupts */</span>
<span class="cp">#define IRQ_LOCOMO_KEY		(0)</span>
<span class="cp">#define IRQ_LOCOMO_GPIO		(1)</span>
<span class="cp">#define IRQ_LOCOMO_LT		(2)</span>
<span class="cp">#define IRQ_LOCOMO_SPI		(3)</span>

<span class="cm">/* M62332 output channel selection */</span>
<span class="cp">#define M62332_EVR_CH	1	</span><span class="cm">/* M62332 volume channel number  */</span><span class="cp"></span>
				<span class="cm">/*   0 : CH.1 , 1 : CH. 2        */</span>
<span class="cm">/* DAC send data */</span>
<span class="cp">#define	M62332_SLAVE_ADDR	0x4e	</span><span class="cm">/* Slave address  */</span><span class="cp"></span>
<span class="cp">#define	M62332_W_BIT		0x00	</span><span class="cm">/* W bit (0 only) */</span><span class="cp"></span>
<span class="cp">#define	M62332_SUB_ADDR		0x00	</span><span class="cm">/* Sub address    */</span><span class="cp"></span>
<span class="cp">#define	M62332_A_BIT		0x00	</span><span class="cm">/* A bit (0 only) */</span><span class="cp"></span>

<span class="cm">/* DAC setup and hold times (expressed in us) */</span>
<span class="cp">#define DAC_BUS_FREE_TIME	5	</span><span class="cm">/*   4.7 us */</span><span class="cp"></span>
<span class="cp">#define DAC_START_SETUP_TIME	5	</span><span class="cm">/*   4.7 us */</span><span class="cp"></span>
<span class="cp">#define DAC_STOP_SETUP_TIME	4	</span><span class="cm">/*   4.0 us */</span><span class="cp"></span>
<span class="cp">#define DAC_START_HOLD_TIME	5	</span><span class="cm">/*   4.7 us */</span><span class="cp"></span>
<span class="cp">#define DAC_SCL_LOW_HOLD_TIME	5	</span><span class="cm">/*   4.7 us */</span><span class="cp"></span>
<span class="cp">#define DAC_SCL_HIGH_HOLD_TIME	4	</span><span class="cm">/*   4.0 us */</span><span class="cp"></span>
<span class="cp">#define DAC_DATA_SETUP_TIME	1	</span><span class="cm">/*   250 ns */</span><span class="cp"></span>
<span class="cp">#define DAC_DATA_HOLD_TIME	1	</span><span class="cm">/*   300 ns */</span><span class="cp"></span>
<span class="cp">#define DAC_LOW_SETUP_TIME	1	</span><span class="cm">/*   300 ns */</span><span class="cp"></span>
<span class="cp">#define DAC_HIGH_SETUP_TIME	1	</span><span class="cm">/*  1000 ns */</span><span class="cp"></span>

<span class="cm">/* the following is the overall data for the locomo chip */</span>
<span class="k">struct</span> <span class="n">locomo</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">phys</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq_base</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">saved_state</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">locomo_dev_info</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">length</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">devid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">irq</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span>	<span class="n">name</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* All the locomo devices.  If offset is non-zero, the mapbase for the</span>
<span class="cm"> * locomo_dev will be set to the chip base plus offset.  If offset is</span>
<span class="cm"> * zero, then the mapbase for the locomo_dev will be set to zero.  An</span>
<span class="cm"> * offset of zero means the device only uses GPIOs or other helper</span>
<span class="cm"> * functions inside this file */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">locomo_dev_info</span> <span class="n">locomo_devices</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">devid</span> 		<span class="o">=</span> <span class="n">LOCOMO_DEVID_KEYBOARD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">irq</span>		<span class="o">=</span> <span class="p">{</span> <span class="n">IRQ_LOCOMO_KEY</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;locomo-keyboard&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="n">LOCOMO_KEYBOARD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">length</span>		<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">devid</span>		<span class="o">=</span> <span class="n">LOCOMO_DEVID_FRONTLIGHT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">irq</span>		<span class="o">=</span> <span class="p">{},</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;locomo-frontlight&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="n">LOCOMO_FRONTLIGHT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">length</span>		<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>

	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">devid</span>		<span class="o">=</span> <span class="n">LOCOMO_DEVID_BACKLIGHT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">irq</span>		<span class="o">=</span> <span class="p">{},</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;locomo-backlight&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="n">LOCOMO_BACKLIGHT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">length</span>		<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">devid</span>		<span class="o">=</span> <span class="n">LOCOMO_DEVID_AUDIO</span><span class="p">,</span>
		<span class="p">.</span><span class="n">irq</span>		<span class="o">=</span> <span class="p">{},</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;locomo-audio&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="n">LOCOMO_AUDIO</span><span class="p">,</span>
		<span class="p">.</span><span class="n">length</span>		<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">devid</span>		<span class="o">=</span> <span class="n">LOCOMO_DEVID_LED</span><span class="p">,</span>
		<span class="p">.</span><span class="n">irq</span> 		<span class="o">=</span> <span class="p">{},</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;locomo-led&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="n">LOCOMO_LED</span><span class="p">,</span>
		<span class="p">.</span><span class="n">length</span>		<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">devid</span>		<span class="o">=</span> <span class="n">LOCOMO_DEVID_UART</span><span class="p">,</span>
		<span class="p">.</span><span class="n">irq</span>		<span class="o">=</span> <span class="p">{},</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;locomo-uart&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">length</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">devid</span>		<span class="o">=</span> <span class="n">LOCOMO_DEVID_SPI</span><span class="p">,</span>
		<span class="p">.</span><span class="n">irq</span>		<span class="o">=</span> <span class="p">{},</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;locomo-spi&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="n">LOCOMO_SPI</span><span class="p">,</span>
		<span class="p">.</span><span class="n">length</span>		<span class="o">=</span> <span class="mh">0x30</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">locomo_handler</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">locomo</span> <span class="o">*</span><span class="n">lchip</span> <span class="o">=</span> <span class="n">irq_get_chip_data</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">req</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Acknowledge the parent IRQ */</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_ack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>

	<span class="cm">/* check why this interrupt was generated */</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_ICR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f00</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* generate the next interrupt(s) */</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">irq</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x0100</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">generic_handle_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
			<span class="p">}</span>

		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">locomo_ack_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">locomo_mask_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">locomo</span> <span class="o">*</span><span class="n">lchip</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_ICR</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x0010</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">));</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_ICR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">locomo_unmask_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">locomo</span> <span class="o">*</span><span class="n">lchip</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_ICR</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x0010</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">));</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_ICR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">locomo_chip</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;LOCOMO&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_ack</span>	<span class="o">=</span> <span class="n">locomo_ack_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask</span>	<span class="o">=</span> <span class="n">locomo_mask_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span>	<span class="o">=</span> <span class="n">locomo_unmask_irq</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">locomo_setup_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">locomo</span> <span class="o">*</span><span class="n">lchip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Install handler for IRQ_LOCOMO_HW.</span>
<span class="cm">	 */</span>
	<span class="n">irq_set_irq_type</span><span class="p">(</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">IRQ_TYPE_EDGE_FALLING</span><span class="p">);</span>
	<span class="n">irq_set_chip_data</span><span class="p">(</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">lchip</span><span class="p">);</span>
	<span class="n">irq_set_chained_handler</span><span class="p">(</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">locomo_handler</span><span class="p">);</span>

	<span class="cm">/* Install handlers for IRQ_LOCOMO_* */</span>
	<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">irq</span> <span class="o">&lt;=</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">irq_base</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span> <span class="n">irq</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq_set_chip_and_handler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">locomo_chip</span><span class="p">,</span> <span class="n">handle_level_irq</span><span class="p">);</span>
		<span class="n">irq_set_chip_data</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">lchip</span><span class="p">);</span>
		<span class="n">set_irq_flags</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">IRQF_VALID</span> <span class="o">|</span> <span class="n">IRQF_PROBE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">locomo_dev_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">locomo_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">LOCOMO_DEV</span><span class="p">(</span><span class="n">_dev</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">locomo_init_one_child</span><span class="p">(</span><span class="k">struct</span> <span class="n">locomo</span> <span class="o">*</span><span class="n">lchip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">locomo_dev_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">locomo_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">locomo_dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the parent device has a DMA mask associated with it,</span>
<span class="cm">	 * propagate it down to the children.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_mask</span> <span class="o">=</span> <span class="o">*</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_mask</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">dma_mask</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_mask</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">devid</span>	 <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span>  <span class="o">=</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">bus</span>     <span class="o">=</span> <span class="o">&amp;</span><span class="n">locomo_bus_type</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">locomo_dev_release</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">coherent_dma_mask</span> <span class="o">=</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">coherent_dma_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mapbase</span> <span class="o">=</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mapbase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">irq_base</span> <span class="o">==</span> <span class="n">NO_IRQ</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">NO_IRQ</span> <span class="o">:</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">irq_base</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
 <span class="nl">out:</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>

<span class="k">struct</span> <span class="n">locomo_save_data</span> <span class="p">{</span>
	<span class="n">u16</span>	<span class="n">LCM_GPO</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">LCM_SPICT</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">LCM_GPE</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">LCM_ASD</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">LCM_SPIMD</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">locomo_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">locomo</span> <span class="o">*</span><span class="n">lchip</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">locomo_save_data</span> <span class="o">*</span><span class="n">save</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">save</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">locomo_save_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">save</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">lchip</span><span class="o">-&gt;</span><span class="n">saved_state</span> <span class="o">=</span> <span class="n">save</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">save</span><span class="o">-&gt;</span><span class="n">LCM_GPO</span>     <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_GPO</span><span class="p">);</span>	<span class="cm">/* GPIO */</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_GPO</span><span class="p">);</span>
	<span class="n">save</span><span class="o">-&gt;</span><span class="n">LCM_SPICT</span>   <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_SPI</span> <span class="o">+</span> <span class="n">LOCOMO_SPICT</span><span class="p">);</span>	<span class="cm">/* SPI */</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_SPI</span> <span class="o">+</span> <span class="n">LOCOMO_SPICT</span><span class="p">);</span>
	<span class="n">save</span><span class="o">-&gt;</span><span class="n">LCM_GPE</span>     <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_GPE</span><span class="p">);</span>	<span class="cm">/* GPIO */</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_GPE</span><span class="p">);</span>
	<span class="n">save</span><span class="o">-&gt;</span><span class="n">LCM_ASD</span>     <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_ASD</span><span class="p">);</span>	<span class="cm">/* ADSTART */</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_ASD</span><span class="p">);</span>
	<span class="n">save</span><span class="o">-&gt;</span><span class="n">LCM_SPIMD</span>   <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_SPI</span> <span class="o">+</span> <span class="n">LOCOMO_SPIMD</span><span class="p">);</span>	<span class="cm">/* SPI */</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="mh">0x3C14</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_SPI</span> <span class="o">+</span> <span class="n">LOCOMO_SPIMD</span><span class="p">);</span>

	<span class="n">locomo_writel</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_PAIF</span><span class="p">);</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_BACKLIGHT</span> <span class="o">+</span> <span class="n">LOCOMO_TC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">locomo_readl</span><span class="p">(</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_LED</span> <span class="o">+</span> <span class="n">LOCOMO_LPT0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x88</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">locomo_readl</span><span class="p">(</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_LED</span> <span class="o">+</span> <span class="n">LOCOMO_LPT1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x88</span><span class="p">))</span>
		<span class="n">locomo_writel</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_C32K</span><span class="p">);</span> 	<span class="cm">/* CLK32 off */</span>
	<span class="k">else</span>
		<span class="cm">/* 18MHz already enabled, so no wait */</span>
		<span class="n">locomo_writel</span><span class="p">(</span><span class="mh">0xc1</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_C32K</span><span class="p">);</span> 	<span class="cm">/* CLK32 on */</span>

	<span class="n">locomo_writel</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_TADC</span><span class="p">);</span>		<span class="cm">/* 18MHz clock off*/</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_AUDIO</span> <span class="o">+</span> <span class="n">LOCOMO_ACC</span><span class="p">);</span>			<span class="cm">/* 22MHz/24MHz clock off */</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_FRONTLIGHT</span> <span class="o">+</span> <span class="n">LOCOMO_ALS</span><span class="p">);</span>			<span class="cm">/* FL */</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">locomo_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">locomo</span> <span class="o">*</span><span class="n">lchip</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">locomo_save_data</span> <span class="o">*</span><span class="n">save</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">save</span> <span class="o">=</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">saved_state</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">save</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">locomo_writel</span><span class="p">(</span><span class="n">save</span><span class="o">-&gt;</span><span class="n">LCM_GPO</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_GPO</span><span class="p">);</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="n">save</span><span class="o">-&gt;</span><span class="n">LCM_SPICT</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_SPI</span> <span class="o">+</span> <span class="n">LOCOMO_SPICT</span><span class="p">);</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="n">save</span><span class="o">-&gt;</span><span class="n">LCM_GPE</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_GPE</span><span class="p">);</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="n">save</span><span class="o">-&gt;</span><span class="n">LCM_ASD</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_ASD</span><span class="p">);</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="n">save</span><span class="o">-&gt;</span><span class="n">LCM_SPIMD</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_SPI</span> <span class="o">+</span> <span class="n">LOCOMO_SPIMD</span><span class="p">);</span>

	<span class="n">locomo_writel</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_C32K</span><span class="p">);</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="mh">0x90</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_TADC</span><span class="p">);</span>

	<span class="n">locomo_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_KEYBOARD</span> <span class="o">+</span> <span class="n">LOCOMO_KSC</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_KEYBOARD</span> <span class="o">+</span> <span class="n">LOCOMO_KIC</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">&amp;=</span> <span class="mh">0xFEFF</span><span class="p">;</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_KEYBOARD</span> <span class="o">+</span> <span class="n">LOCOMO_KIC</span><span class="p">);</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="mh">0x1</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_KEYBOARD</span> <span class="o">+</span> <span class="n">LOCOMO_KCMD</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">lchip</span><span class="o">-&gt;</span><span class="n">saved_state</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">save</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="cm">/**</span>
<span class="cm"> *	locomo_probe - probe for a single LoCoMo chip.</span>
<span class="cm"> *	@phys_addr: physical address of device.</span>
<span class="cm"> *</span>
<span class="cm"> *	Probe for a LoCoMo chip.  This must be called</span>
<span class="cm"> *	before any other locomo-specific code.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *	%-ENODEV	device not found.</span>
<span class="cm"> *	%-EBUSY		physical address already marked in-use.</span>
<span class="cm"> *	%0		successful.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">__locomo_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">me</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">mem</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">locomo_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">me</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">locomo</span> <span class="o">*</span><span class="n">lchip</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">lchip</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">locomo</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lchip</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">lchip</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">me</span><span class="p">;</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">lchip</span><span class="p">);</span>

	<span class="n">lchip</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">lchip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">lchip</span><span class="o">-&gt;</span><span class="n">irq_base</span> <span class="o">=</span> <span class="p">(</span><span class="n">pdata</span><span class="p">)</span> <span class="o">?</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">irq_base</span> <span class="o">:</span> <span class="n">NO_IRQ</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Map the whole region.  This also maps the</span>
<span class="cm">	 * registers for our children.</span>
<span class="cm">	 */</span>
	<span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* locomo initialize */</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_ICR</span><span class="p">);</span>
	<span class="cm">/* KEYBOARD */</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_KEYBOARD</span> <span class="o">+</span> <span class="n">LOCOMO_KIC</span><span class="p">);</span>

	<span class="cm">/* GPIO */</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_GPO</span><span class="p">);</span>
	<span class="n">locomo_writel</span><span class="p">((</span><span class="n">LOCOMO_GPIO</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">LOCOMO_GPIO</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">LOCOMO_GPIO</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="n">LOCOMO_GPIO</span><span class="p">(</span><span class="mi">14</span><span class="p">))</span>
			<span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_GPE</span><span class="p">);</span>
	<span class="n">locomo_writel</span><span class="p">((</span><span class="n">LOCOMO_GPIO</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">LOCOMO_GPIO</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">LOCOMO_GPIO</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="n">LOCOMO_GPIO</span><span class="p">(</span><span class="mi">14</span><span class="p">))</span>
			<span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_GPD</span><span class="p">);</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_GIE</span><span class="p">);</span>

	<span class="cm">/* Frontlight */</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_FRONTLIGHT</span> <span class="o">+</span> <span class="n">LOCOMO_ALS</span><span class="p">);</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_FRONTLIGHT</span> <span class="o">+</span> <span class="n">LOCOMO_ALD</span><span class="p">);</span>

	<span class="cm">/* Longtime timer */</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_LTINT</span><span class="p">);</span>
	<span class="cm">/* SPI */</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_SPI</span> <span class="o">+</span> <span class="n">LOCOMO_SPIIE</span><span class="p">);</span>

	<span class="n">locomo_writel</span><span class="p">(</span><span class="mi">6</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">320</span> <span class="o">+</span> <span class="mi">30</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_ASD</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_ASD</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">|=</span> <span class="mh">0x8000</span><span class="p">;</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_ASD</span><span class="p">);</span>

	<span class="n">locomo_writel</span><span class="p">(</span><span class="mi">6</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">320</span> <span class="o">+</span> <span class="mi">30</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">-</span> <span class="mi">128</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_HSD</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_HSD</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">|=</span> <span class="mh">0x8000</span><span class="p">;</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_HSD</span><span class="p">);</span>

	<span class="n">locomo_writel</span><span class="p">(</span><span class="mi">128</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_HSC</span><span class="p">);</span>

	<span class="cm">/* XON */</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_TADC</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="cm">/* CLK9MEN */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_TADC</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_TADC</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="cm">/* init DAC */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">|=</span> <span class="n">LOCOMO_DAC_SCLOEB</span> <span class="o">|</span> <span class="n">LOCOMO_DAC_SDAOEB</span><span class="p">;</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_VER</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;LoCoMo Chip: %lu%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">),</span> <span class="p">(</span><span class="n">r</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * The interrupt controller must be initialised before any</span>
<span class="cm">	 * other device to ensure that the interrupts are available.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">!=</span> <span class="n">NO_IRQ</span> <span class="o">&amp;&amp;</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">irq_base</span> <span class="o">!=</span> <span class="n">NO_IRQ</span><span class="p">)</span>
		<span class="n">locomo_setup_irq</span><span class="p">(</span><span class="n">lchip</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">locomo_devices</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">locomo_init_one_child</span><span class="p">(</span><span class="n">lchip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">locomo_devices</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">lchip</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">locomo_remove_child</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">device_unregister</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> 

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__locomo_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">locomo</span> <span class="o">*</span><span class="n">lchip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">device_for_each_child</span><span class="p">(</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">locomo_remove_child</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">!=</span> <span class="n">NO_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq_set_chained_handler</span><span class="p">(</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">irq_set_handler_data</span><span class="p">(</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">lchip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">locomo_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="n">mem</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">__locomo_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">mem</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">locomo_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">locomo</span> <span class="o">*</span><span class="n">lchip</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lchip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__locomo_remove</span><span class="p">(</span><span class="n">lchip</span><span class="p">);</span>
		<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Not sure if this should be on the system bus or not yet.</span>
<span class="cm"> *	We really want some way to register a system device at</span>
<span class="cm"> *	the per-machine level, and then have this driver pick</span>
<span class="cm"> *	up the registered devices.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">locomo_device_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">locomo_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">locomo_remove</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">locomo_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">locomo_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;locomo&quot;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *	Get the parent device driver (us) structure</span>
<span class="cm"> *	from a child function device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">locomo</span> <span class="o">*</span><span class="nf">locomo_chip_driver</span><span class="p">(</span><span class="k">struct</span> <span class="n">locomo_dev</span> <span class="o">*</span><span class="n">ldev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">locomo</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">ldev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">locomo_gpio_set_dir</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">locomo</span> <span class="o">*</span><span class="n">lchip</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lchip</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_GPD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dir</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">|=</span> <span class="n">bits</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">r</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">bits</span><span class="p">;</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_GPD</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_GPE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dir</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">|=</span> <span class="n">bits</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">r</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">bits</span><span class="p">;</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_GPE</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">locomo_gpio_set_dir</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">locomo_gpio_read_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">locomo</span> <span class="o">*</span><span class="n">lchip</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lchip</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_GPL</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">&amp;=</span> <span class="n">bits</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">locomo_gpio_read_level</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">locomo_gpio_read_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">locomo</span> <span class="o">*</span><span class="n">lchip</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lchip</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_GPO</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">&amp;=</span> <span class="n">bits</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">locomo_gpio_read_output</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">locomo_gpio_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">locomo</span> <span class="o">*</span><span class="n">lchip</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lchip</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_GPO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">|=</span> <span class="n">bits</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">r</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">bits</span><span class="p">;</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_GPO</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">locomo_gpio_write</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">locomo_m62332_sendbit</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">mapbase</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">&amp;=</span>  <span class="o">~</span><span class="p">(</span><span class="n">LOCOMO_DAC_SCLOEB</span><span class="p">);</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">DAC_LOW_SETUP_TIME</span><span class="p">);</span>	<span class="cm">/* 300 nsec */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">DAC_DATA_HOLD_TIME</span><span class="p">);</span>	<span class="cm">/* 300 nsec */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">&amp;=</span>  <span class="o">~</span><span class="p">(</span><span class="n">LOCOMO_DAC_SCLOEB</span><span class="p">);</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">DAC_LOW_SETUP_TIME</span><span class="p">);</span>	<span class="cm">/* 300 nsec */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">DAC_SCL_LOW_HOLD_TIME</span><span class="p">);</span>	<span class="cm">/* 4.7 usec */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bit</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">|=</span>  <span class="n">LOCOMO_DAC_SDAOEB</span><span class="p">;</span>
		<span class="n">locomo_writel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">DAC_HIGH_SETUP_TIME</span><span class="p">);</span>	<span class="cm">/* 1000 nsec */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">&amp;=</span>  <span class="o">~</span><span class="p">(</span><span class="n">LOCOMO_DAC_SDAOEB</span><span class="p">);</span>
		<span class="n">locomo_writel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">DAC_LOW_SETUP_TIME</span><span class="p">);</span>	<span class="cm">/* 300 nsec */</span>
	<span class="p">}</span>

	<span class="n">udelay</span><span class="p">(</span><span class="n">DAC_DATA_SETUP_TIME</span><span class="p">);</span>	<span class="cm">/* 250 nsec */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">|=</span>  <span class="n">LOCOMO_DAC_SCLOEB</span><span class="p">;</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">DAC_HIGH_SETUP_TIME</span><span class="p">);</span>	<span class="cm">/* 1000 nsec */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">DAC_SCL_HIGH_HOLD_TIME</span><span class="p">);</span>	<span class="cm">/*  4.0 usec */</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">locomo_m62332_senddata</span><span class="p">(</span><span class="k">struct</span> <span class="n">locomo_dev</span> <span class="o">*</span><span class="n">ldev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dac_data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">locomo</span> <span class="o">*</span><span class="n">lchip</span> <span class="o">=</span> <span class="n">locomo_chip_driver</span><span class="p">(</span><span class="n">ldev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">mapbase</span> <span class="o">=</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Start */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">DAC_BUS_FREE_TIME</span><span class="p">);</span>	<span class="cm">/* 5.0 usec */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">|=</span>  <span class="n">LOCOMO_DAC_SCLOEB</span> <span class="o">|</span> <span class="n">LOCOMO_DAC_SDAOEB</span><span class="p">;</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">DAC_HIGH_SETUP_TIME</span><span class="p">);</span>	<span class="cm">/* 1000 nsec */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">DAC_SCL_HIGH_HOLD_TIME</span><span class="p">);</span>	<span class="cm">/* 4.0 usec */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">&amp;=</span>  <span class="o">~</span><span class="p">(</span><span class="n">LOCOMO_DAC_SDAOEB</span><span class="p">);</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">DAC_START_HOLD_TIME</span><span class="p">);</span>	<span class="cm">/* 5.0 usec */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">DAC_DATA_HOLD_TIME</span><span class="p">);</span>	<span class="cm">/* 300 nsec */</span>

	<span class="cm">/* Send slave address and W bit (LSB is W bit) */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">M62332_SLAVE_ADDR</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">M62332_W_BIT</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">locomo_m62332_sendbit</span><span class="p">(</span><span class="n">mapbase</span><span class="p">,</span> <span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Check A bit */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">&amp;=</span>  <span class="o">~</span><span class="p">(</span><span class="n">LOCOMO_DAC_SCLOEB</span><span class="p">);</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">DAC_LOW_SETUP_TIME</span><span class="p">);</span>	<span class="cm">/* 300 nsec */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">DAC_SCL_LOW_HOLD_TIME</span><span class="p">);</span>	<span class="cm">/* 4.7 usec */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">&amp;=</span>  <span class="o">~</span><span class="p">(</span><span class="n">LOCOMO_DAC_SDAOEB</span><span class="p">);</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">DAC_LOW_SETUP_TIME</span><span class="p">);</span>	<span class="cm">/* 300 nsec */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">|=</span>  <span class="n">LOCOMO_DAC_SCLOEB</span><span class="p">;</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">DAC_HIGH_SETUP_TIME</span><span class="p">);</span>	<span class="cm">/* 1000 nsec */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">DAC_SCL_HIGH_HOLD_TIME</span><span class="p">);</span>	<span class="cm">/* 4.7 usec */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">locomo_readl</span><span class="p">(</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LOCOMO_DAC_SDAOEB</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* High is error */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;locomo: m62332_senddata Error 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Send Sub address (LSB is channel select) */</span>
	<span class="cm">/*    channel = 0 : ch1 select              */</span>
	<span class="cm">/*            = 1 : ch2 select              */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">M62332_SUB_ADDR</span> <span class="o">+</span> <span class="n">channel</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">locomo_m62332_sendbit</span><span class="p">(</span><span class="n">mapbase</span><span class="p">,</span> <span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Check A bit */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">&amp;=</span>  <span class="o">~</span><span class="p">(</span><span class="n">LOCOMO_DAC_SCLOEB</span><span class="p">);</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">DAC_LOW_SETUP_TIME</span><span class="p">);</span>	<span class="cm">/* 300 nsec */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">DAC_SCL_LOW_HOLD_TIME</span><span class="p">);</span>	<span class="cm">/* 4.7 usec */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">&amp;=</span>  <span class="o">~</span><span class="p">(</span><span class="n">LOCOMO_DAC_SDAOEB</span><span class="p">);</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">DAC_LOW_SETUP_TIME</span><span class="p">);</span>	<span class="cm">/* 300 nsec */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">|=</span>  <span class="n">LOCOMO_DAC_SCLOEB</span><span class="p">;</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">DAC_HIGH_SETUP_TIME</span><span class="p">);</span>	<span class="cm">/* 1000 nsec */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">DAC_SCL_HIGH_HOLD_TIME</span><span class="p">);</span>	<span class="cm">/* 4.7 usec */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">locomo_readl</span><span class="p">(</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LOCOMO_DAC_SDAOEB</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* High is error */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;locomo: m62332_senddata Error 2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Send DAC data */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">locomo_m62332_sendbit</span><span class="p">(</span><span class="n">mapbase</span><span class="p">,</span> <span class="n">dac_data</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Check A bit */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">&amp;=</span>  <span class="o">~</span><span class="p">(</span><span class="n">LOCOMO_DAC_SCLOEB</span><span class="p">);</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">DAC_LOW_SETUP_TIME</span><span class="p">);</span>	<span class="cm">/* 300 nsec */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">DAC_SCL_LOW_HOLD_TIME</span><span class="p">);</span>	<span class="cm">/* 4.7 usec */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">&amp;=</span>  <span class="o">~</span><span class="p">(</span><span class="n">LOCOMO_DAC_SDAOEB</span><span class="p">);</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">DAC_LOW_SETUP_TIME</span><span class="p">);</span>	<span class="cm">/* 300 nsec */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">|=</span>  <span class="n">LOCOMO_DAC_SCLOEB</span><span class="p">;</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">DAC_HIGH_SETUP_TIME</span><span class="p">);</span>	<span class="cm">/* 1000 nsec */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">DAC_SCL_HIGH_HOLD_TIME</span><span class="p">);</span>	<span class="cm">/* 4.7 usec */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">locomo_readl</span><span class="p">(</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LOCOMO_DAC_SDAOEB</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* High is error */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;locomo: m62332_senddata Error 3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="cm">/* stop */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">&amp;=</span>  <span class="o">~</span><span class="p">(</span><span class="n">LOCOMO_DAC_SCLOEB</span><span class="p">);</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">DAC_LOW_SETUP_TIME</span><span class="p">);</span>	<span class="cm">/* 300 nsec */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">DAC_SCL_LOW_HOLD_TIME</span><span class="p">);</span>	<span class="cm">/* 4.7 usec */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">|=</span>  <span class="n">LOCOMO_DAC_SCLOEB</span><span class="p">;</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">DAC_HIGH_SETUP_TIME</span><span class="p">);</span>	<span class="cm">/* 1000 nsec */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">DAC_SCL_HIGH_HOLD_TIME</span><span class="p">);</span>	<span class="cm">/* 4 usec */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">|=</span>  <span class="n">LOCOMO_DAC_SDAOEB</span><span class="p">;</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">DAC_HIGH_SETUP_TIME</span><span class="p">);</span>	<span class="cm">/* 1000 nsec */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">DAC_SCL_HIGH_HOLD_TIME</span><span class="p">);</span>	<span class="cm">/* 4 usec */</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">locomo_readl</span><span class="p">(</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">|=</span>  <span class="n">LOCOMO_DAC_SCLOEB</span> <span class="o">|</span> <span class="n">LOCOMO_DAC_SDAOEB</span><span class="p">;</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">mapbase</span> <span class="o">+</span> <span class="n">LOCOMO_DAC</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">DAC_LOW_SETUP_TIME</span><span class="p">);</span>	<span class="cm">/* 1000 nsec */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">DAC_SCL_LOW_HOLD_TIME</span><span class="p">);</span>	<span class="cm">/* 4.7 usec */</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">locomo_m62332_senddata</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *	Frontlight control</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">locomo_frontlight_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">locomo_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">duty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bpwf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">locomo</span> <span class="o">*</span><span class="n">lchip</span> <span class="o">=</span> <span class="n">locomo_chip_driver</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vr</span><span class="p">)</span>
		<span class="n">locomo_gpio_write</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">LOCOMO_GPIO_FL_VR</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">locomo_gpio_write</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">LOCOMO_GPIO_FL_VR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="n">bpwf</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_FRONTLIGHT</span> <span class="o">+</span> <span class="n">LOCOMO_ALS</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="n">duty</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_FRONTLIGHT</span> <span class="o">+</span> <span class="n">LOCOMO_ALD</span><span class="p">);</span>
	<span class="n">locomo_writel</span><span class="p">(</span><span class="n">bpwf</span> <span class="o">|</span> <span class="n">LOCOMO_ALC_EN</span><span class="p">,</span> <span class="n">lchip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">LOCOMO_FRONTLIGHT</span> <span class="o">+</span> <span class="n">LOCOMO_ALS</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lchip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">locomo_frontlight_set</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *	LoCoMo &quot;Register Access Bus.&quot;</span>
<span class="cm"> *</span>
<span class="cm"> *	We model this as a regular bus type, and hang devices directly</span>
<span class="cm"> *	off this.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">locomo_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">_drv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">locomo_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">LOCOMO_DEV</span><span class="p">(</span><span class="n">_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">locomo_driver</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">LOCOMO_DRV</span><span class="p">(</span><span class="n">_drv</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devid</span> <span class="o">==</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">locomo_bus_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">locomo_dev</span> <span class="o">*</span><span class="n">ldev</span> <span class="o">=</span> <span class="n">LOCOMO_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">locomo_driver</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">LOCOMO_DRV</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drv</span> <span class="o">&amp;&amp;</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">(</span><span class="n">ldev</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">locomo_bus_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">locomo_dev</span> <span class="o">*</span><span class="n">ldev</span> <span class="o">=</span> <span class="n">LOCOMO_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">locomo_driver</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">LOCOMO_DRV</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drv</span> <span class="o">&amp;&amp;</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="n">ldev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">locomo_bus_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">locomo_dev</span> <span class="o">*</span><span class="n">ldev</span> <span class="o">=</span> <span class="n">LOCOMO_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">locomo_driver</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">LOCOMO_DRV</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">(</span><span class="n">ldev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">locomo_bus_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">locomo_dev</span> <span class="o">*</span><span class="n">ldev</span> <span class="o">=</span> <span class="n">LOCOMO_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">locomo_driver</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">LOCOMO_DRV</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">(</span><span class="n">ldev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">bus_type</span> <span class="n">locomo_bus_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;locomo-bus&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">match</span>		<span class="o">=</span> <span class="n">locomo_match</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">locomo_bus_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">locomo_bus_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">locomo_bus_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">locomo_bus_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">locomo_driver_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">locomo_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">locomo_bus_type</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">locomo_driver_register</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">locomo_driver_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">locomo_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">locomo_driver_unregister</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">locomo_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">bus_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locomo_bus_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locomo_device_driver</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">locomo_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locomo_device_driver</span><span class="p">);</span>
	<span class="n">bus_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locomo_bus_type</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">locomo_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">locomo_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Sharp LoCoMo core driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;John Lenz &lt;lenz@cs.wisc.edu&gt;&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
