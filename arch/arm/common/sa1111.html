<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › common › sa1111.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>sa1111.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/arch/arm/common/sa1111.c</span>
<span class="cm"> *</span>
<span class="cm"> * SA1111 support</span>
<span class="cm"> *</span>
<span class="cm"> * Original code by John Dorsey</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This file contains all generic SA1111 support.</span>
<span class="cm"> *</span>
<span class="cm"> * All initialization functions provided here are intended to be called</span>
<span class="cm"> * from machine specific code with proper arguments when required.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>

<span class="cp">#include &lt;mach/hardware.h&gt;</span>
<span class="cp">#include &lt;asm/mach/irq.h&gt;</span>
<span class="cp">#include &lt;asm/mach-types.h&gt;</span>
<span class="cp">#include &lt;asm/sizes.h&gt;</span>

<span class="cp">#include &lt;asm/hardware/sa1111.h&gt;</span>

<span class="cm">/* SA1111 IRQs */</span>
<span class="cp">#define IRQ_GPAIN0		(0)</span>
<span class="cp">#define IRQ_GPAIN1		(1)</span>
<span class="cp">#define IRQ_GPAIN2		(2)</span>
<span class="cp">#define IRQ_GPAIN3		(3)</span>
<span class="cp">#define IRQ_GPBIN0		(4)</span>
<span class="cp">#define IRQ_GPBIN1		(5)</span>
<span class="cp">#define IRQ_GPBIN2		(6)</span>
<span class="cp">#define IRQ_GPBIN3		(7)</span>
<span class="cp">#define IRQ_GPBIN4		(8)</span>
<span class="cp">#define IRQ_GPBIN5		(9)</span>
<span class="cp">#define IRQ_GPCIN0		(10)</span>
<span class="cp">#define IRQ_GPCIN1		(11)</span>
<span class="cp">#define IRQ_GPCIN2		(12)</span>
<span class="cp">#define IRQ_GPCIN3		(13)</span>
<span class="cp">#define IRQ_GPCIN4		(14)</span>
<span class="cp">#define IRQ_GPCIN5		(15)</span>
<span class="cp">#define IRQ_GPCIN6		(16)</span>
<span class="cp">#define IRQ_GPCIN7		(17)</span>
<span class="cp">#define IRQ_MSTXINT		(18)</span>
<span class="cp">#define IRQ_MSRXINT		(19)</span>
<span class="cp">#define IRQ_MSSTOPERRINT	(20)</span>
<span class="cp">#define IRQ_TPTXINT		(21)</span>
<span class="cp">#define IRQ_TPRXINT		(22)</span>
<span class="cp">#define IRQ_TPSTOPERRINT	(23)</span>
<span class="cp">#define SSPXMTINT		(24)</span>
<span class="cp">#define SSPRCVINT		(25)</span>
<span class="cp">#define SSPROR			(26)</span>
<span class="cp">#define AUDXMTDMADONEA		(32)</span>
<span class="cp">#define AUDRCVDMADONEA		(33)</span>
<span class="cp">#define AUDXMTDMADONEB		(34)</span>
<span class="cp">#define AUDRCVDMADONEB		(35)</span>
<span class="cp">#define AUDTFSR			(36)</span>
<span class="cp">#define AUDRFSR			(37)</span>
<span class="cp">#define AUDTUR			(38)</span>
<span class="cp">#define AUDROR			(39)</span>
<span class="cp">#define AUDDTS			(40)</span>
<span class="cp">#define AUDRDD			(41)</span>
<span class="cp">#define AUDSTO			(42)</span>
<span class="cp">#define IRQ_USBPWR		(43)</span>
<span class="cp">#define IRQ_HCIM		(44)</span>
<span class="cp">#define IRQ_HCIBUFFACC		(45)</span>
<span class="cp">#define IRQ_HCIRMTWKP		(46)</span>
<span class="cp">#define IRQ_NHCIMFCIR		(47)</span>
<span class="cp">#define IRQ_USB_PORT_RESUME	(48)</span>
<span class="cp">#define IRQ_S0_READY_NINT	(49)</span>
<span class="cp">#define IRQ_S1_READY_NINT	(50)</span>
<span class="cp">#define IRQ_S0_CD_VALID		(51)</span>
<span class="cp">#define IRQ_S1_CD_VALID		(52)</span>
<span class="cp">#define IRQ_S0_BVD1_STSCHG	(53)</span>
<span class="cp">#define IRQ_S1_BVD1_STSCHG	(54)</span>
<span class="cp">#define SA1111_IRQ_NR		(55)</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">sa1110_mb_enable</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">sa1110_mb_disable</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * We keep the following data for the overall SA1111.  Note that the</span>
<span class="cm"> * struct device and struct resource are &quot;fake&quot;; they should be supplied</span>
<span class="cm"> * by the bus above us.  However, in the interests of getting all SA1111</span>
<span class="cm"> * drivers converted over to the device model, we provide this as an</span>
<span class="cm"> * anchor point for all the other drivers.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">sa1111</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span>	<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span>	<span class="o">*</span><span class="n">clk</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">phys</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">irq_base</span><span class="p">;</span>	<span class="cm">/* base for cascaded on-chip IRQs */</span>
	<span class="n">spinlock_t</span>	<span class="n">lock</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sa1111_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="kt">void</span>		<span class="o">*</span><span class="n">saved_state</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * We _really_ need to eliminate this.  Its only users</span>
<span class="cm"> * are the PWM and DMA checking code.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sa1111</span> <span class="o">*</span><span class="n">g_sa1111</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">sa1111_dev_info</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">skpcr_mask</span><span class="p">;</span>
	<span class="n">bool</span>		<span class="n">dma</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">devid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">irq</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sa1111_dev_info</span> <span class="n">sa1111_devices</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="n">SA1111_USB</span><span class="p">,</span>
		<span class="p">.</span><span class="n">skpcr_mask</span>	<span class="o">=</span> <span class="n">SKPCR_UCLKEN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dma</span>		<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">devid</span>		<span class="o">=</span> <span class="n">SA1111_DEVID_USB</span><span class="p">,</span>
		<span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">IRQ_USBPWR</span><span class="p">,</span>
			<span class="n">IRQ_HCIM</span><span class="p">,</span>
			<span class="n">IRQ_HCIBUFFACC</span><span class="p">,</span>
			<span class="n">IRQ_HCIRMTWKP</span><span class="p">,</span>
			<span class="n">IRQ_NHCIMFCIR</span><span class="p">,</span>
			<span class="n">IRQ_USB_PORT_RESUME</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mh">0x0600</span><span class="p">,</span>
		<span class="p">.</span><span class="n">skpcr_mask</span>	<span class="o">=</span> <span class="n">SKPCR_I2SCLKEN</span> <span class="o">|</span> <span class="n">SKPCR_L3CLKEN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dma</span>		<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">devid</span>		<span class="o">=</span> <span class="n">SA1111_DEVID_SAC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">AUDXMTDMADONEA</span><span class="p">,</span>
			<span class="n">AUDXMTDMADONEB</span><span class="p">,</span>
			<span class="n">AUDRCVDMADONEA</span><span class="p">,</span>
			<span class="n">AUDRCVDMADONEB</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mh">0x0800</span><span class="p">,</span>
		<span class="p">.</span><span class="n">skpcr_mask</span>	<span class="o">=</span> <span class="n">SKPCR_SCLKEN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">devid</span>		<span class="o">=</span> <span class="n">SA1111_DEVID_SSP</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="n">SA1111_KBD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">skpcr_mask</span>	<span class="o">=</span> <span class="n">SKPCR_PTCLKEN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">devid</span>		<span class="o">=</span> <span class="n">SA1111_DEVID_PS2_KBD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">IRQ_TPRXINT</span><span class="p">,</span>
			<span class="n">IRQ_TPTXINT</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="n">SA1111_MSE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">skpcr_mask</span>	<span class="o">=</span> <span class="n">SKPCR_PMCLKEN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">devid</span>		<span class="o">=</span> <span class="n">SA1111_DEVID_PS2_MSE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">IRQ_MSRXINT</span><span class="p">,</span>
			<span class="n">IRQ_MSTXINT</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mh">0x1800</span><span class="p">,</span>
		<span class="p">.</span><span class="n">skpcr_mask</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">devid</span>		<span class="o">=</span> <span class="n">SA1111_DEVID_PCMCIA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">IRQ_S0_READY_NINT</span><span class="p">,</span>
			<span class="n">IRQ_S0_CD_VALID</span><span class="p">,</span>
			<span class="n">IRQ_S0_BVD1_STSCHG</span><span class="p">,</span>
			<span class="n">IRQ_S1_READY_NINT</span><span class="p">,</span>
			<span class="n">IRQ_S1_CD_VALID</span><span class="p">,</span>
			<span class="n">IRQ_S1_BVD1_STSCHG</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * SA1111 interrupt support.  Since clearing an IRQ while there are</span>
<span class="cm"> * active IRQs causes the interrupt output to pulse, the upper levels</span>
<span class="cm"> * will call us again if there are more interrupts to process.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sa1111_irq_handler</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stat0</span><span class="p">,</span> <span class="n">stat1</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sa1111</span> <span class="o">*</span><span class="n">sachip</span> <span class="o">=</span> <span class="n">irq_get_handler_data</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mapbase</span> <span class="o">=</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_INTC</span><span class="p">;</span>

	<span class="n">stat0</span> <span class="o">=</span> <span class="n">sa1111_readl</span><span class="p">(</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">SA1111_INTSTATCLR0</span><span class="p">);</span>
	<span class="n">stat1</span> <span class="o">=</span> <span class="n">sa1111_readl</span><span class="p">(</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">SA1111_INTSTATCLR1</span><span class="p">);</span>

	<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">stat0</span><span class="p">,</span> <span class="n">mapbase</span> <span class="o">+</span> <span class="n">SA1111_INTSTATCLR0</span><span class="p">);</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_ack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>

	<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">stat1</span><span class="p">,</span> <span class="n">mapbase</span> <span class="o">+</span> <span class="n">SA1111_INTSTATCLR1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stat0</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">stat1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">do_bad_IRQ</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">stat0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">stat0</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat0</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">generic_handle_irq</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span> <span class="n">stat1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">stat1</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat1</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">generic_handle_irq</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">);</span>

	<span class="cm">/* For level-based interrupts */</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_unmask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define SA1111_IRQMASK_LO(x)	(1 &lt;&lt; (x - sachip-&gt;irq_base))</span>
<span class="cp">#define SA1111_IRQMASK_HI(x)	(1 &lt;&lt; (x - sachip-&gt;irq_base - 32))</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sa1111_ack_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sa1111_mask_lowirq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1111</span> <span class="o">*</span><span class="n">sachip</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mapbase</span> <span class="o">=</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_INTC</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ie0</span><span class="p">;</span>

	<span class="n">ie0</span> <span class="o">=</span> <span class="n">sa1111_readl</span><span class="p">(</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">SA1111_INTEN0</span><span class="p">);</span>
	<span class="n">ie0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SA1111_IRQMASK_LO</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ie0</span><span class="p">,</span> <span class="n">mapbase</span> <span class="o">+</span> <span class="n">SA1111_INTEN0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sa1111_unmask_lowirq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1111</span> <span class="o">*</span><span class="n">sachip</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mapbase</span> <span class="o">=</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_INTC</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ie0</span><span class="p">;</span>

	<span class="n">ie0</span> <span class="o">=</span> <span class="n">sa1111_readl</span><span class="p">(</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">SA1111_INTEN0</span><span class="p">);</span>
	<span class="n">ie0</span> <span class="o">|=</span> <span class="n">SA1111_IRQMASK_LO</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">ie0</span><span class="p">,</span> <span class="n">mapbase</span> <span class="o">+</span> <span class="n">SA1111_INTEN0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Attempt to re-trigger the interrupt.  The SA1111 contains a register</span>
<span class="cm"> * (INTSET) which claims to do this.  However, in practice no amount of</span>
<span class="cm"> * manipulation of INTEN and INTSET guarantees that the interrupt will</span>
<span class="cm"> * be triggered.  In fact, its very difficult, if not impossible to get</span>
<span class="cm"> * INTSET to re-trigger the interrupt.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sa1111_retrigger_lowirq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1111</span> <span class="o">*</span><span class="n">sachip</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mapbase</span> <span class="o">=</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_INTC</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">SA1111_IRQMASK_LO</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ip0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ip0</span> <span class="o">=</span> <span class="n">sa1111_readl</span><span class="p">(</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">SA1111_INTPOL0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">ip0</span> <span class="o">^</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mapbase</span> <span class="o">+</span> <span class="n">SA1111_INTPOL0</span><span class="p">);</span>
		<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">ip0</span><span class="p">,</span> <span class="n">mapbase</span> <span class="o">+</span> <span class="n">SA1111_INTPOL0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sa1111_readl</span><span class="p">(</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">SA1111_INTSTATCLR0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Danger Will Robinson: failed to &quot;</span>
			<span class="s">&quot;re-trigger IRQ%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sa1111_type_lowirq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1111</span> <span class="o">*</span><span class="n">sachip</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mapbase</span> <span class="o">=</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_INTC</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">SA1111_IRQMASK_LO</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ip0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">==</span> <span class="n">IRQ_TYPE_PROBE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">)</span> <span class="o">^</span> <span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IRQ_TYPE_EDGE_FALLING</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ip0</span> <span class="o">=</span> <span class="n">sa1111_readl</span><span class="p">(</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">SA1111_INTPOL0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">)</span>
		<span class="n">ip0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ip0</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">ip0</span><span class="p">,</span> <span class="n">mapbase</span> <span class="o">+</span> <span class="n">SA1111_INTPOL0</span><span class="p">);</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">ip0</span><span class="p">,</span> <span class="n">mapbase</span> <span class="o">+</span> <span class="n">SA1111_WAKEPOL0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sa1111_wake_lowirq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1111</span> <span class="o">*</span><span class="n">sachip</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mapbase</span> <span class="o">=</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_INTC</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">SA1111_IRQMASK_LO</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">we0</span><span class="p">;</span>

	<span class="n">we0</span> <span class="o">=</span> <span class="n">sa1111_readl</span><span class="p">(</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">SA1111_WAKEEN0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">we0</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">we0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">we0</span><span class="p">,</span> <span class="n">mapbase</span> <span class="o">+</span> <span class="n">SA1111_WAKEEN0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">sa1111_low_chip</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;SA1111-l&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_ack</span>	<span class="o">=</span> <span class="n">sa1111_ack_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask</span>	<span class="o">=</span> <span class="n">sa1111_mask_lowirq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span>	<span class="o">=</span> <span class="n">sa1111_unmask_lowirq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_retrigger</span>	<span class="o">=</span> <span class="n">sa1111_retrigger_lowirq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_set_type</span>	<span class="o">=</span> <span class="n">sa1111_type_lowirq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_set_wake</span>	<span class="o">=</span> <span class="n">sa1111_wake_lowirq</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sa1111_mask_highirq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1111</span> <span class="o">*</span><span class="n">sachip</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mapbase</span> <span class="o">=</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_INTC</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ie1</span><span class="p">;</span>

	<span class="n">ie1</span> <span class="o">=</span> <span class="n">sa1111_readl</span><span class="p">(</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">SA1111_INTEN1</span><span class="p">);</span>
	<span class="n">ie1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SA1111_IRQMASK_HI</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">ie1</span><span class="p">,</span> <span class="n">mapbase</span> <span class="o">+</span> <span class="n">SA1111_INTEN1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sa1111_unmask_highirq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1111</span> <span class="o">*</span><span class="n">sachip</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mapbase</span> <span class="o">=</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_INTC</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ie1</span><span class="p">;</span>

	<span class="n">ie1</span> <span class="o">=</span> <span class="n">sa1111_readl</span><span class="p">(</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">SA1111_INTEN1</span><span class="p">);</span>
	<span class="n">ie1</span> <span class="o">|=</span> <span class="n">SA1111_IRQMASK_HI</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">ie1</span><span class="p">,</span> <span class="n">mapbase</span> <span class="o">+</span> <span class="n">SA1111_INTEN1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Attempt to re-trigger the interrupt.  The SA1111 contains a register</span>
<span class="cm"> * (INTSET) which claims to do this.  However, in practice no amount of</span>
<span class="cm"> * manipulation of INTEN and INTSET guarantees that the interrupt will</span>
<span class="cm"> * be triggered.  In fact, its very difficult, if not impossible to get</span>
<span class="cm"> * INTSET to re-trigger the interrupt.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sa1111_retrigger_highirq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1111</span> <span class="o">*</span><span class="n">sachip</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mapbase</span> <span class="o">=</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_INTC</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">SA1111_IRQMASK_HI</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ip1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ip1</span> <span class="o">=</span> <span class="n">sa1111_readl</span><span class="p">(</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">SA1111_INTPOL1</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">ip1</span> <span class="o">^</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mapbase</span> <span class="o">+</span> <span class="n">SA1111_INTPOL1</span><span class="p">);</span>
		<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">ip1</span><span class="p">,</span> <span class="n">mapbase</span> <span class="o">+</span> <span class="n">SA1111_INTPOL1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sa1111_readl</span><span class="p">(</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">SA1111_INTSTATCLR1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Danger Will Robinson: failed to &quot;</span>
			<span class="s">&quot;re-trigger IRQ%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sa1111_type_highirq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1111</span> <span class="o">*</span><span class="n">sachip</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mapbase</span> <span class="o">=</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_INTC</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">SA1111_IRQMASK_HI</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ip1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">==</span> <span class="n">IRQ_TYPE_PROBE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">)</span> <span class="o">^</span> <span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IRQ_TYPE_EDGE_FALLING</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ip1</span> <span class="o">=</span> <span class="n">sa1111_readl</span><span class="p">(</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">SA1111_INTPOL1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">)</span>
		<span class="n">ip1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ip1</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">ip1</span><span class="p">,</span> <span class="n">mapbase</span> <span class="o">+</span> <span class="n">SA1111_INTPOL1</span><span class="p">);</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">ip1</span><span class="p">,</span> <span class="n">mapbase</span> <span class="o">+</span> <span class="n">SA1111_WAKEPOL1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sa1111_wake_highirq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1111</span> <span class="o">*</span><span class="n">sachip</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mapbase</span> <span class="o">=</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_INTC</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">SA1111_IRQMASK_HI</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">we1</span><span class="p">;</span>

	<span class="n">we1</span> <span class="o">=</span> <span class="n">sa1111_readl</span><span class="p">(</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">SA1111_WAKEEN1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">we1</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">we1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">we1</span><span class="p">,</span> <span class="n">mapbase</span> <span class="o">+</span> <span class="n">SA1111_WAKEEN1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">sa1111_high_chip</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;SA1111-h&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_ack</span>	<span class="o">=</span> <span class="n">sa1111_ack_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask</span>	<span class="o">=</span> <span class="n">sa1111_mask_highirq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span>	<span class="o">=</span> <span class="n">sa1111_unmask_highirq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_retrigger</span>	<span class="o">=</span> <span class="n">sa1111_retrigger_highirq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_set_type</span>	<span class="o">=</span> <span class="n">sa1111_type_highirq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_set_wake</span>	<span class="o">=</span> <span class="n">sa1111_wake_highirq</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sa1111_setup_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">sa1111</span> <span class="o">*</span><span class="n">sachip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">irq_base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">irqbase</span> <span class="o">=</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_INTC</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">,</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We&#39;re guaranteed that this region hasn&#39;t been taken.</span>
<span class="cm">	 */</span>
	<span class="n">request_mem_region</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">+</span> <span class="n">SA1111_INTC</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="s">&quot;irq&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">irq_alloc_descs</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">irq_base</span><span class="p">,</span> <span class="n">SA1111_IRQ_NR</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to allocate %u irqs: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">SA1111_IRQ_NR</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sachip</span><span class="o">-&gt;</span><span class="n">irq_base</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* disable all IRQs */</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">irqbase</span> <span class="o">+</span> <span class="n">SA1111_INTEN0</span><span class="p">);</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">irqbase</span> <span class="o">+</span> <span class="n">SA1111_INTEN1</span><span class="p">);</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">irqbase</span> <span class="o">+</span> <span class="n">SA1111_WAKEEN0</span><span class="p">);</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">irqbase</span> <span class="o">+</span> <span class="n">SA1111_WAKEEN1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * detect on rising edge.  Note: Feb 2001 Errata for SA1111</span>
<span class="cm">	 * specifies that S0ReadyInt and S1ReadyInt should be &#39;1&#39;.</span>
<span class="cm">	 */</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">irqbase</span> <span class="o">+</span> <span class="n">SA1111_INTPOL0</span><span class="p">);</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">SA1111_IRQMASK_HI</span><span class="p">(</span><span class="n">IRQ_S0_READY_NINT</span><span class="p">)</span> <span class="o">|</span>
		      <span class="n">SA1111_IRQMASK_HI</span><span class="p">(</span><span class="n">IRQ_S1_READY_NINT</span><span class="p">),</span>
		      <span class="n">irqbase</span> <span class="o">+</span> <span class="n">SA1111_INTPOL1</span><span class="p">);</span>

	<span class="cm">/* clear all IRQs */</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">irqbase</span> <span class="o">+</span> <span class="n">SA1111_INTSTATCLR0</span><span class="p">);</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">irqbase</span> <span class="o">+</span> <span class="n">SA1111_INTSTATCLR1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">IRQ_GPAIN0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">SSPROR</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">irq_base</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">irq_set_chip_and_handler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sa1111_low_chip</span><span class="p">,</span>
					 <span class="n">handle_edge_irq</span><span class="p">);</span>
		<span class="n">irq_set_chip_data</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">sachip</span><span class="p">);</span>
		<span class="n">set_irq_flags</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">IRQF_VALID</span> <span class="o">|</span> <span class="n">IRQF_PROBE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">AUDXMTDMADONEA</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">IRQ_S1_BVD1_STSCHG</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">irq_base</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">irq_set_chip_and_handler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sa1111_high_chip</span><span class="p">,</span>
					 <span class="n">handle_edge_irq</span><span class="p">);</span>
		<span class="n">irq_set_chip_data</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">sachip</span><span class="p">);</span>
		<span class="n">set_irq_flags</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">IRQF_VALID</span> <span class="o">|</span> <span class="n">IRQF_PROBE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Register SA1111 interrupt</span>
<span class="cm">	 */</span>
	<span class="n">irq_set_irq_type</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">);</span>
	<span class="n">irq_set_handler_data</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">sachip</span><span class="p">);</span>
	<span class="n">irq_set_chained_handler</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">sa1111_irq_handler</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Providing IRQ%u-%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sachip</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">,</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">irq_base</span> <span class="o">+</span> <span class="n">SA1111_IRQ_NR</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Bring the SA1111 out of reset.  This requires a set procedure:</span>
<span class="cm"> *  1. nRESET asserted (by hardware)</span>
<span class="cm"> *  2. CLK turned on from SA1110</span>
<span class="cm"> *  3. nRESET deasserted</span>
<span class="cm"> *  4. VCO turned on, PLL_BYPASS turned off</span>
<span class="cm"> *  5. Wait lock time, then assert RCLKEn</span>
<span class="cm"> *  7. PCR set to allow clocking of individual functions</span>
<span class="cm"> *</span>
<span class="cm"> * Until we&#39;ve done this, the only registers we can access are:</span>
<span class="cm"> *   SBI_SKCR</span>
<span class="cm"> *   SBI_SMCR</span>
<span class="cm"> *   SBI_SKID</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sa1111_wake</span><span class="p">(</span><span class="k">struct</span> <span class="n">sa1111</span> <span class="o">*</span><span class="n">sachip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">clk_enable</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Turn VCO on, and disable PLL Bypass.</span>
<span class="cm">	 */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">sa1111_readl</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_SKCR</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SKCR_VCO_OFF</span><span class="p">;</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_SKCR</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">|=</span> <span class="n">SKCR_PLL_BYPASS</span> <span class="o">|</span> <span class="n">SKCR_OE_EN</span><span class="p">;</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_SKCR</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait lock time.  SA1111 manual _doesn&#39;t_</span>
<span class="cm">	 * specify a figure for this!  We choose 100us.</span>
<span class="cm">	 */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable RCLK.  We also ensure that RDYEN is set.</span>
<span class="cm">	 */</span>
	<span class="n">r</span> <span class="o">|=</span> <span class="n">SKCR_RCLKEN</span> <span class="o">|</span> <span class="n">SKCR_RDYEN</span><span class="p">;</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_SKCR</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait 14 RCLK cycles for the chip to finish coming out</span>
<span class="cm">	 * of reset. (RCLK=24MHz).  This is 590ns.</span>
<span class="cm">	 */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Ensure all clocks are initially off.</span>
<span class="cm">	 */</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_SKPCR</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_ARCH_SA1100</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">sa1111_dma_mask</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">~</span><span class="mi">0</span><span class="p">,</span>
	<span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">),</span>
	<span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">),</span>
	<span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">),</span>
	<span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">25</span><span class="p">),</span>
	<span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">),</span>
	<span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">),</span>
	<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Configure the SA1111 shared memory controller.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">sa1111_configure_smc</span><span class="p">(</span><span class="k">struct</span> <span class="n">sa1111</span> <span class="o">*</span><span class="n">sachip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sdram</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">drac</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cas_latency</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">smcr</span> <span class="o">=</span> <span class="n">SMCR_DTIM</span> <span class="o">|</span> <span class="n">SMCR_MBGE</span> <span class="o">|</span> <span class="n">FInsrt</span><span class="p">(</span><span class="n">drac</span><span class="p">,</span> <span class="n">SMCR_DRAC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cas_latency</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">smcr</span> <span class="o">|=</span> <span class="n">SMCR_CLAT</span><span class="p">;</span>

	<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">smcr</span><span class="p">,</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_SMCR</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now clear the bits in the DMA mask to work around the SA1111</span>
<span class="cm">	 * DMA erratum (Intel StrongARM SA-1111 Microprocessor Companion</span>
<span class="cm">	 * Chip Specification Update, June 2000, Erratum #7).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_mask</span><span class="p">)</span>
		<span class="o">*</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_mask</span> <span class="o">&amp;=</span> <span class="n">sa1111_dma_mask</span><span class="p">[</span><span class="n">drac</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">];</span>

	<span class="n">sachip</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">coherent_dma_mask</span> <span class="o">&amp;=</span> <span class="n">sa1111_dma_mask</span><span class="p">[</span><span class="n">drac</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">];</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sa1111_dev_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1111_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">SA1111_DEV</span><span class="p">(</span><span class="n">_dev</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sa1111_init_one_child</span><span class="p">(</span><span class="k">struct</span> <span class="n">sa1111</span> <span class="o">*</span><span class="n">sachip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">sa1111_dev_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1111_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sa1111_dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_alloc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">device_initialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%4.4lx&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">devid</span>	 <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span>  <span class="o">=</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">bus</span>     <span class="o">=</span> <span class="o">&amp;</span><span class="n">sa1111_bus_type</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">sa1111_dev_release</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">start</span>   <span class="o">=</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">end</span>     <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">start</span> <span class="o">+</span> <span class="mi">511</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">name</span>    <span class="o">=</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">flags</span>   <span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mapbase</span>     <span class="o">=</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">skpcr_mask</span>  <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">skpcr_mask</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">irq_base</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the parent device has a DMA mask associated with it, and</span>
<span class="cm">	 * this child supports DMA, propagate it down to the children.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&amp;&amp;</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_mask</span> <span class="o">=</span> <span class="o">*</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_mask</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">dma_mask</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_mask</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">coherent_dma_mask</span> <span class="o">=</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">coherent_dma_mask</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_resource</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to allocate resource for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_resource</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">device_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_add</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err_add:</span>
	<span class="n">release_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">);</span>
 <span class="nl">err_resource:</span>
	<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
 <span class="nl">err_alloc:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	sa1111_probe - probe for a single SA1111 chip.</span>
<span class="cm"> *	@phys_addr: physical address of device.</span>
<span class="cm"> *</span>
<span class="cm"> *	Probe for a SA1111 chip.  This must be called</span>
<span class="cm"> *	before any other SA1111-specific code.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *	%-ENODEV	device not found.</span>
<span class="cm"> *	%-EBUSY		physical address already marked in-use.</span>
<span class="cm"> *	%-EINVAL	no platform data passed</span>
<span class="cm"> *	%0		successful.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">__sa1111_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">me</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">mem</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1111_platform_data</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">me</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sa1111</span> <span class="o">*</span><span class="n">sachip</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">has_devs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">sachip</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sa1111</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sachip</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">sachip</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="s">&quot;SA1111_CLK&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">clk_prepare</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_clkput</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">sachip</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">me</span><span class="p">;</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">sachip</span><span class="p">);</span>

	<span class="n">sachip</span><span class="o">-&gt;</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">pd</span><span class="p">;</span>
	<span class="n">sachip</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">sachip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Map the whole region.  This also maps the</span>
<span class="cm">	 * registers for our children.</span>
<span class="cm">	 */</span>
	<span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_clk_unprep</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Probe for the chip.  Only touch the SBI registers.</span>
<span class="cm">	 */</span>
	<span class="n">id</span> <span class="o">=</span> <span class="n">sa1111_readl</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_SKID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">SKID_ID_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SKID_SA1111_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;SA1111 not detected: ID = %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_unmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;SA1111 Microprocessor Companion Chip: &quot;</span>
		<span class="s">&quot;silicon revision %lx, metal revision %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">SKID_SIREV_MASK</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">SKID_MTREV_MASK</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * We found it.  Wake the chip up, and initialise.</span>
<span class="cm">	 */</span>
	<span class="n">sa1111_wake</span><span class="p">(</span><span class="n">sachip</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The interrupt controller must be initialised before any</span>
<span class="cm">	 * other device to ensure that the interrupts are available.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">!=</span> <span class="n">NO_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sa1111_setup_irq</span><span class="p">(</span><span class="n">sachip</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_unmap</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_ARCH_SA1100</span>
	<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The SDRAM configuration of the SA1110 and the SA1111 must</span>
<span class="cm">	 * match.  This is very important to ensure that SA1111 accesses</span>
<span class="cm">	 * don&#39;t corrupt the SDRAM.  Note that this ungates the SA1111&#39;s</span>
<span class="cm">	 * MBGNT signal, so we must have called sa1110_mb_disable()</span>
<span class="cm">	 * beforehand.</span>
<span class="cm">	 */</span>
	<span class="n">sa1111_configure_smc</span><span class="p">(</span><span class="n">sachip</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			     <span class="n">FExtr</span><span class="p">(</span><span class="n">MDCNFG</span><span class="p">,</span> <span class="n">MDCNFG_SA1110_DRAC0</span><span class="p">),</span>
			     <span class="n">FExtr</span><span class="p">(</span><span class="n">MDCNFG</span><span class="p">,</span> <span class="n">MDCNFG_SA1110_TDL0</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * We only need to turn on DCLK whenever we want to use the</span>
<span class="cm">	 * DMA.  It can otherwise be held firmly in the off position.</span>
<span class="cm">	 * (currently, we always enable it.)</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">sa1111_readl</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_SKPCR</span><span class="p">);</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">SKPCR_DCLKEN</span><span class="p">,</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_SKPCR</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable the SA1110 memory bus request and grant signals.</span>
<span class="cm">	 */</span>
	<span class="n">sa1110_mb_enable</span><span class="p">();</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">g_sa1111</span> <span class="o">=</span> <span class="n">sachip</span><span class="p">;</span>

	<span class="n">has_devs</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="p">)</span>
		<span class="n">has_devs</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">disable_devs</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sa1111_devices</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sa1111_devices</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">devid</span> <span class="o">&amp;</span> <span class="n">has_devs</span><span class="p">)</span>
			<span class="n">sa1111_init_one_child</span><span class="p">(</span><span class="n">sachip</span><span class="p">,</span> <span class="n">mem</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sa1111_devices</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err_unmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
 <span class="nl">err_clk_unprep:</span>
	<span class="n">clk_unprepare</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
 <span class="nl">err_clkput:</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
 <span class="nl">err_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sachip</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sa1111_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1111_dev</span> <span class="o">*</span><span class="n">sadev</span> <span class="o">=</span> <span class="n">SA1111_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">device_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sadev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">release_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sadev</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">);</span>
	<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sadev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__sa1111_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">sa1111</span> <span class="o">*</span><span class="n">sachip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">irqbase</span> <span class="o">=</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_INTC</span><span class="p">;</span>

	<span class="n">device_for_each_child</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">sa1111_remove_one</span><span class="p">);</span>

	<span class="cm">/* disable all IRQs */</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">irqbase</span> <span class="o">+</span> <span class="n">SA1111_INTEN0</span><span class="p">);</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">irqbase</span> <span class="o">+</span> <span class="n">SA1111_INTEN1</span><span class="p">);</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">irqbase</span> <span class="o">+</span> <span class="n">SA1111_WAKEEN0</span><span class="p">);</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">irqbase</span> <span class="o">+</span> <span class="n">SA1111_WAKEEN1</span><span class="p">);</span>

	<span class="n">clk_disable</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="n">clk_unprepare</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">!=</span> <span class="n">NO_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq_set_chained_handler</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">irq_set_handler_data</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">irq_free_descs</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">,</span> <span class="n">SA1111_IRQ_NR</span><span class="p">);</span>

		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">+</span> <span class="n">SA1111_INTC</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sachip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">sa1111_save_data</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">skcr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">skpcr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">skcdr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">skaud</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">skpwm0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">skpwm1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Interrupt controller</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">intpol0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">intpol1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">inten0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">inten1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">wakepol0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">wakepol1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">wakeen0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">wakeen1</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_PM</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sa1111_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1111</span> <span class="o">*</span><span class="n">sachip</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sa1111_save_data</span> <span class="o">*</span><span class="n">save</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>

	<span class="n">save</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sa1111_save_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">save</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">sachip</span><span class="o">-&gt;</span><span class="n">saved_state</span> <span class="o">=</span> <span class="n">save</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Save state.</span>
<span class="cm">	 */</span>
	<span class="n">base</span> <span class="o">=</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">save</span><span class="o">-&gt;</span><span class="n">skcr</span>     <span class="o">=</span> <span class="n">sa1111_readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_SKCR</span><span class="p">);</span>
	<span class="n">save</span><span class="o">-&gt;</span><span class="n">skpcr</span>    <span class="o">=</span> <span class="n">sa1111_readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_SKPCR</span><span class="p">);</span>
	<span class="n">save</span><span class="o">-&gt;</span><span class="n">skcdr</span>    <span class="o">=</span> <span class="n">sa1111_readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_SKCDR</span><span class="p">);</span>
	<span class="n">save</span><span class="o">-&gt;</span><span class="n">skaud</span>    <span class="o">=</span> <span class="n">sa1111_readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_SKAUD</span><span class="p">);</span>
	<span class="n">save</span><span class="o">-&gt;</span><span class="n">skpwm0</span>   <span class="o">=</span> <span class="n">sa1111_readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_SKPWM0</span><span class="p">);</span>
	<span class="n">save</span><span class="o">-&gt;</span><span class="n">skpwm1</span>   <span class="o">=</span> <span class="n">sa1111_readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_SKPWM1</span><span class="p">);</span>

	<span class="n">sa1111_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_SKPWM0</span><span class="p">);</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_SKPWM1</span><span class="p">);</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_INTC</span><span class="p">;</span>
	<span class="n">save</span><span class="o">-&gt;</span><span class="n">intpol0</span>  <span class="o">=</span> <span class="n">sa1111_readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_INTPOL0</span><span class="p">);</span>
	<span class="n">save</span><span class="o">-&gt;</span><span class="n">intpol1</span>  <span class="o">=</span> <span class="n">sa1111_readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_INTPOL1</span><span class="p">);</span>
	<span class="n">save</span><span class="o">-&gt;</span><span class="n">inten0</span>   <span class="o">=</span> <span class="n">sa1111_readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_INTEN0</span><span class="p">);</span>
	<span class="n">save</span><span class="o">-&gt;</span><span class="n">inten1</span>   <span class="o">=</span> <span class="n">sa1111_readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_INTEN1</span><span class="p">);</span>
	<span class="n">save</span><span class="o">-&gt;</span><span class="n">wakepol0</span> <span class="o">=</span> <span class="n">sa1111_readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_WAKEPOL0</span><span class="p">);</span>
	<span class="n">save</span><span class="o">-&gt;</span><span class="n">wakepol1</span> <span class="o">=</span> <span class="n">sa1111_readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_WAKEPOL1</span><span class="p">);</span>
	<span class="n">save</span><span class="o">-&gt;</span><span class="n">wakeen0</span>  <span class="o">=</span> <span class="n">sa1111_readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_WAKEEN0</span><span class="p">);</span>
	<span class="n">save</span><span class="o">-&gt;</span><span class="n">wakeen1</span>  <span class="o">=</span> <span class="n">sa1111_readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_WAKEEN1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable.</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">sa1111_readl</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_SKCR</span><span class="p">);</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">SKCR_SLEEP</span><span class="p">,</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_SKCR</span><span class="p">);</span>

	<span class="n">clk_disable</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_ARCH_SA1100</span>
	<span class="n">sa1110_mb_disable</span><span class="p">();</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	sa1111_resume - Restore the SA1111 device state.</span>
<span class="cm"> *	@dev: device to restore</span>
<span class="cm"> *</span>
<span class="cm"> *	Restore the general state of the SA1111; clock control and</span>
<span class="cm"> *	interrupt controller.  Other parts of the SA1111 must be</span>
<span class="cm"> *	restored by their respective drivers, and must be called</span>
<span class="cm"> *	via LDM after this function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sa1111_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1111</span> <span class="o">*</span><span class="n">sachip</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sa1111_save_data</span> <span class="o">*</span><span class="n">save</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>

	<span class="n">save</span> <span class="o">=</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">saved_state</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">save</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Ensure that the SA1111 is still here.</span>
<span class="cm">	 * FIXME: shouldn&#39;t do this here.</span>
<span class="cm">	 */</span>
	<span class="n">id</span> <span class="o">=</span> <span class="n">sa1111_readl</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_SKID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">SKID_ID_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SKID_SA1111_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__sa1111_remove</span><span class="p">(</span><span class="n">sachip</span><span class="p">);</span>
		<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">save</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * First of all, wake up the chip.</span>
<span class="cm">	 */</span>
	<span class="n">sa1111_wake</span><span class="p">(</span><span class="n">sachip</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_ARCH_SA1100</span>
	<span class="cm">/* Enable the memory bus request/grant signals */</span>
	<span class="n">sa1110_mb_enable</span><span class="p">();</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * Only lock for write ops. Also, sa1111_wake must be called with</span>
<span class="cm">	 * released spinlock!</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">sa1111_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_INTC</span> <span class="o">+</span> <span class="n">SA1111_INTEN0</span><span class="p">);</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_INTC</span> <span class="o">+</span> <span class="n">SA1111_INTEN1</span><span class="p">);</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">save</span><span class="o">-&gt;</span><span class="n">skcr</span><span class="p">,</span>     <span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_SKCR</span><span class="p">);</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">save</span><span class="o">-&gt;</span><span class="n">skpcr</span><span class="p">,</span>    <span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_SKPCR</span><span class="p">);</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">save</span><span class="o">-&gt;</span><span class="n">skcdr</span><span class="p">,</span>    <span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_SKCDR</span><span class="p">);</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">save</span><span class="o">-&gt;</span><span class="n">skaud</span><span class="p">,</span>    <span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_SKAUD</span><span class="p">);</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">save</span><span class="o">-&gt;</span><span class="n">skpwm0</span><span class="p">,</span>   <span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_SKPWM0</span><span class="p">);</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">save</span><span class="o">-&gt;</span><span class="n">skpwm1</span><span class="p">,</span>   <span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_SKPWM1</span><span class="p">);</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_INTC</span><span class="p">;</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">save</span><span class="o">-&gt;</span><span class="n">intpol0</span><span class="p">,</span>  <span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_INTPOL0</span><span class="p">);</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">save</span><span class="o">-&gt;</span><span class="n">intpol1</span><span class="p">,</span>  <span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_INTPOL1</span><span class="p">);</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">save</span><span class="o">-&gt;</span><span class="n">inten0</span><span class="p">,</span>   <span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_INTEN0</span><span class="p">);</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">save</span><span class="o">-&gt;</span><span class="n">inten1</span><span class="p">,</span>   <span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_INTEN1</span><span class="p">);</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">save</span><span class="o">-&gt;</span><span class="n">wakepol0</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_WAKEPOL0</span><span class="p">);</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">save</span><span class="o">-&gt;</span><span class="n">wakepol1</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_WAKEPOL1</span><span class="p">);</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">save</span><span class="o">-&gt;</span><span class="n">wakeen0</span><span class="p">,</span>  <span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_WAKEEN0</span><span class="p">);</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">save</span><span class="o">-&gt;</span><span class="n">wakeen1</span><span class="p">,</span>  <span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_WAKEEN1</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">sachip</span><span class="o">-&gt;</span><span class="n">saved_state</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">save</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="cp">#define sa1111_suspend NULL</span>
<span class="cp">#define sa1111_resume  NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sa1111_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="n">mem</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">__sa1111_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">mem</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sa1111_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1111</span> <span class="o">*</span><span class="n">sachip</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sachip</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_PM</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">saved_state</span><span class="p">);</span>
		<span class="n">sachip</span><span class="o">-&gt;</span><span class="n">saved_state</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">__sa1111_remove</span><span class="p">(</span><span class="n">sachip</span><span class="p">);</span>
		<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Not sure if this should be on the system bus or not yet.</span>
<span class="cm"> *	We really want some way to register a system device at</span>
<span class="cm"> *	the per-machine level, and then have this driver pick</span>
<span class="cm"> *	up the registered devices.</span>
<span class="cm"> *</span>
<span class="cm"> *	We also need to handle the SDRAM configuration for</span>
<span class="cm"> *	PXA250/SA1110 machine classes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">sa1111_device_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">sa1111_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">sa1111_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">sa1111_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">sa1111_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;sa1111&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *	Get the parent device driver (us) structure</span>
<span class="cm"> *	from a child function device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">sa1111</span> <span class="o">*</span><span class="nf">sa1111_chip_driver</span><span class="p">(</span><span class="k">struct</span> <span class="n">sa1111_dev</span> <span class="o">*</span><span class="n">sadev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sa1111</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">sadev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The bits in the opdiv field are non-linear.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">opdiv_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">8</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">__sa1111_pll_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">sa1111</span> <span class="o">*</span><span class="n">sachip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">skcdr</span><span class="p">,</span> <span class="n">fbdiv</span><span class="p">,</span> <span class="n">ipdiv</span><span class="p">,</span> <span class="n">opdiv</span><span class="p">;</span>

	<span class="n">skcdr</span> <span class="o">=</span> <span class="n">sa1111_readl</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_SKCDR</span><span class="p">);</span>

	<span class="n">fbdiv</span> <span class="o">=</span> <span class="p">(</span><span class="n">skcdr</span> <span class="o">&amp;</span> <span class="mh">0x007f</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">ipdiv</span> <span class="o">=</span> <span class="p">((</span><span class="n">skcdr</span> <span class="o">&amp;</span> <span class="mh">0x0f80</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">opdiv</span> <span class="o">=</span> <span class="n">opdiv_table</span><span class="p">[(</span><span class="n">skcdr</span> <span class="o">&amp;</span> <span class="mh">0x3000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">];</span>

	<span class="k">return</span> <span class="mi">3686400</span> <span class="o">*</span> <span class="n">fbdiv</span> <span class="o">/</span> <span class="p">(</span><span class="n">ipdiv</span> <span class="o">*</span> <span class="n">opdiv</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	sa1111_pll_clock - return the current PLL clock frequency.</span>
<span class="cm"> *	@sadev: SA1111 function block</span>
<span class="cm"> *</span>
<span class="cm"> *	BUG: we should look at SKCR.  We also blindly believe that</span>
<span class="cm"> *	the chip is being fed with the 3.6864MHz clock.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns the PLL clock in Hz.</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">sa1111_pll_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">sa1111_dev</span> <span class="o">*</span><span class="n">sadev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1111</span> <span class="o">*</span><span class="n">sachip</span> <span class="o">=</span> <span class="n">sa1111_chip_driver</span><span class="p">(</span><span class="n">sadev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">__sa1111_pll_clock</span><span class="p">(</span><span class="n">sachip</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sa1111_pll_clock</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	sa1111_select_audio_mode - select I2S or AC link mode</span>
<span class="cm"> *	@sadev: SA1111 function block</span>
<span class="cm"> *	@mode: One of %SA1111_AUDIO_ACLINK or %SA1111_AUDIO_I2S</span>
<span class="cm"> *</span>
<span class="cm"> *	Frob the SKCR to select AC Link mode or I2S mode for</span>
<span class="cm"> *	the audio block.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">sa1111_select_audio_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">sa1111_dev</span> <span class="o">*</span><span class="n">sadev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1111</span> <span class="o">*</span><span class="n">sachip</span> <span class="o">=</span> <span class="n">sa1111_chip_driver</span><span class="p">(</span><span class="n">sadev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">sa1111_readl</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_SKCR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">SA1111_AUDIO_I2S</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SKCR_SELAC</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">SKCR_SELAC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_SKCR</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sa1111_select_audio_mode</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	sa1111_set_audio_rate - set the audio sample rate</span>
<span class="cm"> *	@sadev: SA1111 SAC function block</span>
<span class="cm"> *	@rate: sample rate to select</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">sa1111_set_audio_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">sa1111_dev</span> <span class="o">*</span><span class="n">sadev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1111</span> <span class="o">*</span><span class="n">sachip</span> <span class="o">=</span> <span class="n">sa1111_chip_driver</span><span class="p">(</span><span class="n">sadev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">div</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sadev</span><span class="o">-&gt;</span><span class="n">devid</span> <span class="o">!=</span> <span class="n">SA1111_DEVID_SAC</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">div</span> <span class="o">=</span> <span class="p">(</span><span class="n">__sa1111_pll_clock</span><span class="p">(</span><span class="n">sachip</span><span class="p">)</span> <span class="o">/</span> <span class="mi">256</span> <span class="o">+</span> <span class="n">rate</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">rate</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">div</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">div</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">div</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">)</span>
		<span class="n">div</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>

	<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">div</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_SKAUD</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sa1111_set_audio_rate</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	sa1111_get_audio_rate - get the audio sample rate</span>
<span class="cm"> *	@sadev: SA1111 SAC function block device</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">sa1111_get_audio_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">sa1111_dev</span> <span class="o">*</span><span class="n">sadev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1111</span> <span class="o">*</span><span class="n">sachip</span> <span class="o">=</span> <span class="n">sa1111_chip_driver</span><span class="p">(</span><span class="n">sadev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">div</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sadev</span><span class="o">-&gt;</span><span class="n">devid</span> <span class="o">!=</span> <span class="n">SA1111_DEVID_SAC</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">div</span> <span class="o">=</span> <span class="n">sa1111_readl</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_SKAUD</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">__sa1111_pll_clock</span><span class="p">(</span><span class="n">sachip</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">256</span> <span class="o">*</span> <span class="n">div</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sa1111_get_audio_rate</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">sa1111_set_io_dir</span><span class="p">(</span><span class="k">struct</span> <span class="n">sa1111_dev</span> <span class="o">*</span><span class="n">sadev</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sleep_dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1111</span> <span class="o">*</span><span class="n">sachip</span> <span class="o">=</span> <span class="n">sa1111_chip_driver</span><span class="p">(</span><span class="n">sadev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">gpio</span> <span class="o">=</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_GPIO</span><span class="p">;</span>

<span class="cp">#define MODIFY_BITS(port, mask, dir)		\</span>
<span class="cp">	if (mask) {				\</span>
<span class="cp">		val = sa1111_readl(port);	\</span>
<span class="cp">		val &amp;= ~(mask);			\</span>
<span class="cp">		val |= (dir) &amp; (mask);		\</span>
<span class="cp">		sa1111_writel(val, port);	\</span>
<span class="cp">	}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">MODIFY_BITS</span><span class="p">(</span><span class="n">gpio</span> <span class="o">+</span> <span class="n">SA1111_GPIO_PADDR</span><span class="p">,</span> <span class="n">bits</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
	<span class="n">MODIFY_BITS</span><span class="p">(</span><span class="n">gpio</span> <span class="o">+</span> <span class="n">SA1111_GPIO_PBDDR</span><span class="p">,</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">,</span> <span class="n">dir</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">MODIFY_BITS</span><span class="p">(</span><span class="n">gpio</span> <span class="o">+</span> <span class="n">SA1111_GPIO_PCDDR</span><span class="p">,</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">,</span> <span class="n">dir</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">MODIFY_BITS</span><span class="p">(</span><span class="n">gpio</span> <span class="o">+</span> <span class="n">SA1111_GPIO_PASDR</span><span class="p">,</span> <span class="n">bits</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">,</span> <span class="n">sleep_dir</span><span class="p">);</span>
	<span class="n">MODIFY_BITS</span><span class="p">(</span><span class="n">gpio</span> <span class="o">+</span> <span class="n">SA1111_GPIO_PBSDR</span><span class="p">,</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">,</span> <span class="n">sleep_dir</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">MODIFY_BITS</span><span class="p">(</span><span class="n">gpio</span> <span class="o">+</span> <span class="n">SA1111_GPIO_PCSDR</span><span class="p">,</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">,</span> <span class="n">sleep_dir</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sa1111_set_io_dir</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">sa1111_set_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">sa1111_dev</span> <span class="o">*</span><span class="n">sadev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1111</span> <span class="o">*</span><span class="n">sachip</span> <span class="o">=</span> <span class="n">sa1111_chip_driver</span><span class="p">(</span><span class="n">sadev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">gpio</span> <span class="o">=</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_GPIO</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">MODIFY_BITS</span><span class="p">(</span><span class="n">gpio</span> <span class="o">+</span> <span class="n">SA1111_GPIO_PADWR</span><span class="p">,</span> <span class="n">bits</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
	<span class="n">MODIFY_BITS</span><span class="p">(</span><span class="n">gpio</span> <span class="o">+</span> <span class="n">SA1111_GPIO_PBDWR</span><span class="p">,</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">,</span> <span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">MODIFY_BITS</span><span class="p">(</span><span class="n">gpio</span> <span class="o">+</span> <span class="n">SA1111_GPIO_PCDWR</span><span class="p">,</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">,</span> <span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sa1111_set_io</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">sa1111_set_sleep_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">sa1111_dev</span> <span class="o">*</span><span class="n">sadev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1111</span> <span class="o">*</span><span class="n">sachip</span> <span class="o">=</span> <span class="n">sa1111_chip_driver</span><span class="p">(</span><span class="n">sadev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">gpio</span> <span class="o">=</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_GPIO</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">MODIFY_BITS</span><span class="p">(</span><span class="n">gpio</span> <span class="o">+</span> <span class="n">SA1111_GPIO_PASSR</span><span class="p">,</span> <span class="n">bits</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
	<span class="n">MODIFY_BITS</span><span class="p">(</span><span class="n">gpio</span> <span class="o">+</span> <span class="n">SA1111_GPIO_PBSSR</span><span class="p">,</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">,</span> <span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">MODIFY_BITS</span><span class="p">(</span><span class="n">gpio</span> <span class="o">+</span> <span class="n">SA1111_GPIO_PCSSR</span><span class="p">,</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">,</span> <span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sa1111_set_sleep_io</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Individual device operations.</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> *	sa1111_enable_device - enable an on-chip SA1111 function block</span>
<span class="cm"> *	@sadev: SA1111 function block device to enable</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">sa1111_enable_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">sa1111_dev</span> <span class="o">*</span><span class="n">sadev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1111</span> <span class="o">*</span><span class="n">sachip</span> <span class="o">=</span> <span class="n">sa1111_chip_driver</span><span class="p">(</span><span class="n">sadev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">pdata</span> <span class="o">&amp;&amp;</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">sadev</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">sa1111_readl</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_SKPCR</span><span class="p">);</span>
		<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">sadev</span><span class="o">-&gt;</span><span class="n">skpcr_mask</span><span class="p">,</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_SKPCR</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sa1111_enable_device</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	sa1111_disable_device - disable an on-chip SA1111 function block</span>
<span class="cm"> *	@sadev: SA1111 function block device to disable</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">sa1111_disable_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">sa1111_dev</span> <span class="o">*</span><span class="n">sadev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1111</span> <span class="o">*</span><span class="n">sachip</span> <span class="o">=</span> <span class="n">sa1111_chip_driver</span><span class="p">(</span><span class="n">sadev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">sa1111_readl</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_SKPCR</span><span class="p">);</span>
	<span class="n">sa1111_writel</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">sadev</span><span class="o">-&gt;</span><span class="n">skpcr_mask</span><span class="p">,</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SA1111_SKPCR</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">pdata</span> <span class="o">&amp;&amp;</span> <span class="n">sachip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">)</span>
		<span class="n">sachip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">(</span><span class="n">sachip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">sadev</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sa1111_disable_device</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *	SA1111 &quot;Register Access Bus.&quot;</span>
<span class="cm"> *</span>
<span class="cm"> *	We model this as a regular bus type, and hang devices directly</span>
<span class="cm"> *	off this.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sa1111_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">_drv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1111_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">SA1111_DEV</span><span class="p">(</span><span class="n">_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sa1111_driver</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">SA1111_DRV</span><span class="p">(</span><span class="n">_drv</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devid</span> <span class="o">&amp;</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sa1111_bus_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1111_dev</span> <span class="o">*</span><span class="n">sadev</span> <span class="o">=</span> <span class="n">SA1111_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sa1111_driver</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">SA1111_DRV</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drv</span> <span class="o">&amp;&amp;</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">(</span><span class="n">sadev</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sa1111_bus_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1111_dev</span> <span class="o">*</span><span class="n">sadev</span> <span class="o">=</span> <span class="n">SA1111_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sa1111_driver</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">SA1111_DRV</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drv</span> <span class="o">&amp;&amp;</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="n">sadev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sa1111_bus_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1111_driver</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">SA1111_DRV</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drv</span> <span class="o">&amp;&amp;</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">)</span>
		<span class="n">drv</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">(</span><span class="n">SA1111_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sa1111_bus_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1111_dev</span> <span class="o">*</span><span class="n">sadev</span> <span class="o">=</span> <span class="n">SA1111_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sa1111_driver</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">SA1111_DRV</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">(</span><span class="n">sadev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sa1111_bus_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1111_dev</span> <span class="o">*</span><span class="n">sadev</span> <span class="o">=</span> <span class="n">SA1111_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sa1111_driver</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">SA1111_DRV</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">(</span><span class="n">sadev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">bus_type</span> <span class="n">sa1111_bus_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;sa1111-rab&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">match</span>		<span class="o">=</span> <span class="n">sa1111_match</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">sa1111_bus_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">sa1111_bus_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">sa1111_bus_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">sa1111_bus_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">sa1111_bus_shutdown</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sa1111_bus_type</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">sa1111_driver_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">sa1111_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sa1111_bus_type</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sa1111_driver_register</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">sa1111_driver_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">sa1111_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sa1111_driver_unregister</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_DMABOUNCE</span>
<span class="cm">/*</span>
<span class="cm"> * According to the &quot;Intel StrongARM SA-1111 Microprocessor Companion</span>
<span class="cm"> * Chip Specification Update&quot; (June 2000), erratum #7, there is a</span>
<span class="cm"> * significant bug in the SA1111 SDRAM shared memory controller.  If</span>
<span class="cm"> * an access to a region of memory above 1MB relative to the bank base,</span>
<span class="cm"> * it is important that address bit 10 _NOT_ be asserted. Depending</span>
<span class="cm"> * on the configuration of the RAM, bit 10 may correspond to one</span>
<span class="cm"> * of several different (processor-relative) address bits.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine only identifies whether or not a given DMA address</span>
<span class="cm"> * is susceptible to the bug.</span>
<span class="cm"> *</span>
<span class="cm"> * This should only get called for sa1111_device types due to the</span>
<span class="cm"> * way we configure our device dma_masks.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sa1111_needs_bounce</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Section 4.6 of the &quot;Intel StrongARM SA-1111 Development Module</span>
<span class="cm">	 * User&#39;s Guide&quot; mentions that jumpers R51 and R52 control the</span>
<span class="cm">	 * target of SA-1111 DMA (either SDRAM bank 0 on Assabet, or</span>
<span class="cm">	 * SDRAM bank 1 on Neponset). The default configuration selects</span>
<span class="cm">	 * Assabet, so any address in bank 1 is necessarily invalid.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">machine_is_assabet</span><span class="p">()</span> <span class="o">||</span> <span class="n">machine_is_pfs168</span><span class="p">())</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="mh">0xc8000000</span> <span class="o">||</span> <span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">size</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0xc8000000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sa1111_notifier_call</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">action</span><span class="p">,</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sa1111_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">SA1111_DEV</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BUS_NOTIFY_ADD_DEVICE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">dma_mask</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_mask</span> <span class="o">&lt;</span> <span class="mh">0xffffffffUL</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">dmabounce_register_dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span>
					<span class="n">sa1111_needs_bounce</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to register with dmabounce: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BUS_NOTIFY_DEL_DEVICE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">dma_mask</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_mask</span> <span class="o">&lt;</span> <span class="mh">0xffffffffUL</span><span class="p">)</span>
			<span class="n">dmabounce_unregister_dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">sa1111_bus_notifier</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">sa1111_notifier_call</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sa1111_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">bus_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sa1111_bus_type</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_DMABOUNCE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">bus_register_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sa1111_bus_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sa1111_bus_notifier</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sa1111_device_driver</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">sa1111_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sa1111_device_driver</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_DMABOUNCE</span>
	<span class="n">bus_unregister_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sa1111_bus_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sa1111_bus_notifier</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">bus_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sa1111_bus_type</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">sa1111_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">sa1111_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Intel Corporation SA1111 core driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
