<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › mach-bcmring › csp › dmac › dmacHw.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>dmacHw.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*****************************************************************************</span>
<span class="cm">* Copyright 2003 - 2008 Broadcom Corporation.  All rights reserved.</span>
<span class="cm">*</span>
<span class="cm">* Unless you and Broadcom execute a separate written software license</span>
<span class="cm">* agreement governing use of this software, this software is licensed to you</span>
<span class="cm">* under the terms of the GNU General Public License version 2, available at</span>
<span class="cm">* http://www.broadcom.com/licenses/GPLv2.php (the &quot;GPL&quot;).</span>
<span class="cm">*</span>
<span class="cm">* Notwithstanding the above, under no circumstances may you combine this</span>
<span class="cm">* software in any way with any other Broadcom software provided under a</span>
<span class="cm">* license other than the GPL, without Broadcom&#39;s express prior written</span>
<span class="cm">* consent.</span>
<span class="cm">*****************************************************************************/</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*  @file    dmacHw.c</span>
<span class="cm">*</span>
<span class="cm">*  @brief   Low level DMA controller driver routines</span>
<span class="cm">*</span>
<span class="cm">*  @note</span>
<span class="cm">*</span>
<span class="cm">*   These routines provide basic DMA functionality only.</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>

<span class="cm">/* ---- Include Files ---------------------------------------------------- */</span>
<span class="cp">#include &lt;csp/stdint.h&gt;</span>
<span class="cp">#include &lt;csp/string.h&gt;</span>
<span class="cp">#include &lt;stddef.h&gt;</span>

<span class="cp">#include &lt;csp/dmacHw.h&gt;</span>
<span class="cp">#include &lt;mach/csp/dmacHw_reg.h&gt;</span>
<span class="cp">#include &lt;mach/csp/dmacHw_priv.h&gt;</span>
<span class="cp">#include &lt;mach/csp/chipcHw_inline.h&gt;</span>

<span class="cm">/* ---- External Function Prototypes ------------------------------------- */</span>

<span class="cm">/* Allocate DMA control blocks */</span>
<span class="n">dmacHw_CBLK_t</span> <span class="n">dmacHw_gCblk</span><span class="p">[</span><span class="n">dmacHw_MAX_CHANNEL_COUNT</span><span class="p">];</span>

<span class="kt">uint32_t</span> <span class="n">dmaChannelCount_0</span> <span class="o">=</span> <span class="n">dmacHw_MAX_CHANNEL_COUNT</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
<span class="kt">uint32_t</span> <span class="n">dmaChannelCount_1</span> <span class="o">=</span> <span class="n">dmacHw_MAX_CHANNEL_COUNT</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*  @brief   Get maximum FIFO for a DMA channel</span>
<span class="cm">*</span>
<span class="cm">*  @return  Maximum allowable FIFO size</span>
<span class="cm">*</span>
<span class="cm">*</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">uint32_t</span> <span class="nf">GetFifoSize</span><span class="p">(</span><span class="n">dmacHw_HANDLE_t</span> <span class="n">handle</span>	<span class="cm">/*   [ IN ] DMA Channel handle */</span>
    <span class="p">)</span> <span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dmacHw_CBLK_t</span> <span class="o">*</span><span class="n">pCblk</span> <span class="o">=</span> <span class="n">dmacHw_HANDLE_TO_CBLK</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">dmacHw_MISC_t</span> <span class="o">*</span><span class="n">pMiscReg</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">dmacHw_MISC_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dmacHw_REG_MISC_BASE</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">pMiscReg</span><span class="o">-&gt;</span><span class="n">CompParm2</span><span class="p">.</span><span class="n">lo</span> <span class="o">&amp;</span> <span class="mh">0x70000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">pMiscReg</span><span class="o">-&gt;</span><span class="n">CompParm3</span><span class="p">.</span><span class="n">hi</span> <span class="o">&amp;</span> <span class="mh">0x70000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">pMiscReg</span><span class="o">-&gt;</span><span class="n">CompParm3</span><span class="p">.</span><span class="n">lo</span> <span class="o">&amp;</span> <span class="mh">0x70000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">pMiscReg</span><span class="o">-&gt;</span><span class="n">CompParm4</span><span class="p">.</span><span class="n">hi</span> <span class="o">&amp;</span> <span class="mh">0x70000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">pMiscReg</span><span class="o">-&gt;</span><span class="n">CompParm4</span><span class="p">.</span><span class="n">lo</span> <span class="o">&amp;</span> <span class="mh">0x70000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">pMiscReg</span><span class="o">-&gt;</span><span class="n">CompParm5</span><span class="p">.</span><span class="n">hi</span> <span class="o">&amp;</span> <span class="mh">0x70000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">pMiscReg</span><span class="o">-&gt;</span><span class="n">CompParm5</span><span class="p">.</span><span class="n">lo</span> <span class="o">&amp;</span> <span class="mh">0x70000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">pMiscReg</span><span class="o">-&gt;</span><span class="n">CompParm6</span><span class="p">.</span><span class="n">hi</span> <span class="o">&amp;</span> <span class="mh">0x70000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;=</span> <span class="mh">0x4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="n">val</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dmacHw_ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*  @brief   Program channel register to initiate transfer</span>
<span class="cm">*</span>
<span class="cm">*  @return  void</span>
<span class="cm">*</span>
<span class="cm">*</span>
<span class="cm">*  @note</span>
<span class="cm">*     - Descriptor buffer MUST ALWAYS be flushed before calling this function</span>
<span class="cm">*     - This function should also be called from ISR to program the channel with</span>
<span class="cm">*       pending descriptors</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>
<span class="kt">void</span> <span class="nf">dmacHw_initiateTransfer</span><span class="p">(</span><span class="n">dmacHw_HANDLE_t</span> <span class="n">handle</span><span class="p">,</span>	<span class="cm">/*   [ IN ] DMA Channel handle */</span>
			     <span class="n">dmacHw_CONFIG_t</span> <span class="o">*</span><span class="n">pConfig</span><span class="p">,</span>	<span class="cm">/*   [ IN ] Configuration settings */</span>
			     <span class="kt">void</span> <span class="o">*</span><span class="n">pDescriptor</span>	<span class="cm">/*   [ IN ] Descriptor buffer */</span>
    <span class="p">)</span> <span class="p">{</span>
	<span class="n">dmacHw_DESC_RING_t</span> <span class="o">*</span><span class="n">pRing</span><span class="p">;</span>
	<span class="n">dmacHw_DESC_t</span> <span class="o">*</span><span class="n">pProg</span><span class="p">;</span>
	<span class="n">dmacHw_CBLK_t</span> <span class="o">*</span><span class="n">pCblk</span><span class="p">;</span>

	<span class="n">pCblk</span> <span class="o">=</span> <span class="n">dmacHw_HANDLE_TO_CBLK</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">pRing</span> <span class="o">=</span> <span class="n">dmacHw_GET_DESC_RING</span><span class="p">(</span><span class="n">pDescriptor</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHANNEL_BUSY</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Not safe yet to program the channel */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">varDataStarted</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">descUpdated</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">descUpdated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pProg</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">dmacHw_DESC_t</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span>
					       <span class="n">dmacHw_REG_LLP</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span>
							      <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span> <span class="o">+</span>
					       <span class="n">pRing</span><span class="o">-&gt;</span><span class="n">virt2PhyOffset</span><span class="p">);</span>

			<span class="cm">/* Load descriptor if not loaded */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pProg</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">.</span><span class="n">hi</span> <span class="o">&amp;</span> <span class="n">dmacHw_REG_CTL_DONE</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dmacHw_SET_SAR</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
					       <span class="n">pProg</span><span class="o">-&gt;</span><span class="n">sar</span><span class="p">);</span>
				<span class="n">dmacHw_SET_DAR</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
					       <span class="n">pProg</span><span class="o">-&gt;</span><span class="n">dar</span><span class="p">);</span>
				<span class="n">dmacHw_REG_CTL_LO</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span>
						  <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span> <span class="o">=</span>
				    <span class="n">pProg</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">.</span><span class="n">lo</span><span class="p">;</span>
				<span class="n">dmacHw_REG_CTL_HI</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span>
						  <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span> <span class="o">=</span>
				    <span class="n">pProg</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">.</span><span class="n">hi</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pProg</span> <span class="o">==</span> <span class="p">(</span><span class="n">dmacHw_DESC_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pEnd</span><span class="o">-&gt;</span><span class="n">llp</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Return as end descriptor is processed */</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dmacHw_ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">transferMode</span> <span class="o">==</span> <span class="n">dmacHw_TRANSFER_MODE_PERIODIC</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Do not make a single chain, rather process one descriptor at a time */</span>
			<span class="n">pProg</span> <span class="o">=</span> <span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pHead</span><span class="p">;</span>
			<span class="cm">/* Point to the next descriptor for next iteration */</span>
			<span class="n">dmacHw_NEXT_DESC</span><span class="p">(</span><span class="n">pRing</span><span class="p">,</span> <span class="n">pHead</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Return if no more pending descriptor */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pEnd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">pProg</span> <span class="o">=</span> <span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pProg</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">transferMode</span> <span class="o">==</span>
			    <span class="n">dmacHw_TRANSFER_MODE_CONTINUOUS</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Make sure a complete ring can be formed */</span>
				<span class="n">dmacHw_ASSERT</span><span class="p">((</span><span class="n">dmacHw_DESC_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pEnd</span><span class="o">-&gt;</span>
					      <span class="n">llp</span> <span class="o">==</span> <span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pProg</span><span class="p">);</span>
				<span class="cm">/* Make sure pProg pointing to the pHead */</span>
				<span class="n">dmacHw_ASSERT</span><span class="p">((</span><span class="n">dmacHw_DESC_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pProg</span> <span class="o">==</span>
					      <span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pHead</span><span class="p">);</span>
				<span class="cm">/* Make a complete ring */</span>
				<span class="k">do</span> <span class="p">{</span>
					<span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pProg</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">.</span><span class="n">lo</span> <span class="o">|=</span>
					    <span class="p">(</span><span class="n">dmacHw_REG_CTL_LLP_DST_EN</span> <span class="o">|</span>
					     <span class="n">dmacHw_REG_CTL_LLP_SRC_EN</span><span class="p">);</span>
					<span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pProg</span> <span class="o">=</span>
					    <span class="p">(</span><span class="n">dmacHw_DESC_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pProg</span><span class="o">-&gt;</span><span class="n">llp</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pProg</span> <span class="o">!=</span> <span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pHead</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Make a single long chain */</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pProg</span> <span class="o">!=</span> <span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pEnd</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pProg</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">.</span><span class="n">lo</span> <span class="o">|=</span>
					    <span class="p">(</span><span class="n">dmacHw_REG_CTL_LLP_DST_EN</span> <span class="o">|</span>
					     <span class="n">dmacHw_REG_CTL_LLP_SRC_EN</span><span class="p">);</span>
					<span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pProg</span> <span class="o">=</span>
					    <span class="p">(</span><span class="n">dmacHw_DESC_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pProg</span><span class="o">-&gt;</span><span class="n">llp</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Program the channel registers */</span>
		<span class="n">dmacHw_SET_SAR</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">pProg</span><span class="o">-&gt;</span><span class="n">sar</span><span class="p">);</span>
		<span class="n">dmacHw_SET_DAR</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">pProg</span><span class="o">-&gt;</span><span class="n">dar</span><span class="p">);</span>
		<span class="n">dmacHw_SET_LLP</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">pProg</span> <span class="o">-</span> <span class="n">pRing</span><span class="o">-&gt;</span><span class="n">virt2PhyOffset</span><span class="p">);</span>
		<span class="n">dmacHw_REG_CTL_LO</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span> <span class="o">=</span>
		    <span class="n">pProg</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">.</span><span class="n">lo</span><span class="p">;</span>
		<span class="n">dmacHw_REG_CTL_HI</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span> <span class="o">=</span>
		    <span class="n">pProg</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">.</span><span class="n">hi</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pEnd</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Remember the descriptor to use next */</span>
			<span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pProg</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmacHw_DESC_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pEnd</span><span class="o">-&gt;</span><span class="n">llp</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Indicate no more pending descriptor  */</span>
		<span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pEnd</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmacHw_DESC_t</span> <span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Start DMA operation */</span>
	<span class="n">dmacHw_DMA_START</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*  @brief   Initializes DMA</span>
<span class="cm">*</span>
<span class="cm">*  This function initializes DMA CSP driver</span>
<span class="cm">*</span>
<span class="cm">*  @note</span>
<span class="cm">*     Must be called before using any DMA channel</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>
<span class="kt">void</span> <span class="nf">dmacHw_initDma</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dmaChannelCount_0</span> <span class="o">=</span> <span class="n">dmacHw_GET_NUM_CHANNEL</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">dmaChannelCount_1</span> <span class="o">=</span> <span class="n">dmacHw_GET_NUM_CHANNEL</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Enable access to the DMA block */</span>
	<span class="n">chipcHw_busInterfaceClockEnable</span><span class="p">(</span><span class="n">chipcHw_REG_BUS_CLOCK_DMAC0</span><span class="p">);</span>
	<span class="n">chipcHw_busInterfaceClockEnable</span><span class="p">(</span><span class="n">chipcHw_REG_BUS_CLOCK_DMAC1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dmaChannelCount_0</span> <span class="o">+</span> <span class="n">dmaChannelCount_1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">dmacHw_MAX_CHANNEL_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmacHw_ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dmacHw_gCblk</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">dmacHw_CBLK_t</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">dmaChannelCount_0</span> <span class="o">+</span> <span class="n">dmaChannelCount_1</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dmaChannelCount_0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmacHw_gCblk</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">module</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dmacHw_gCblk</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dmaChannelCount_1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmacHw_gCblk</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">dmaChannelCount_0</span><span class="p">].</span><span class="n">module</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dmacHw_gCblk</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">dmaChannelCount_0</span><span class="p">].</span><span class="n">channel</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*  @brief   Exit function for  DMA</span>
<span class="cm">*</span>
<span class="cm">*  This function isolates DMA from the system</span>
<span class="cm">*</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>
<span class="kt">void</span> <span class="nf">dmacHw_exitDma</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Disable access to the DMA block */</span>
	<span class="n">chipcHw_busInterfaceClockDisable</span><span class="p">(</span><span class="n">chipcHw_REG_BUS_CLOCK_DMAC0</span><span class="p">);</span>
	<span class="n">chipcHw_busInterfaceClockDisable</span><span class="p">(</span><span class="n">chipcHw_REG_BUS_CLOCK_DMAC1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*  @brief   Gets a handle to a DMA channel</span>
<span class="cm">*</span>
<span class="cm">*  This function returns a handle, representing a control block of a particular DMA channel</span>
<span class="cm">*</span>
<span class="cm">*  @return  -1       - On Failure</span>
<span class="cm">*            handle  - On Success, representing a channel control block</span>
<span class="cm">*</span>
<span class="cm">*  @note</span>
<span class="cm">*     None  Channel ID must be created using &quot;dmacHw_MAKE_CHANNEL_ID&quot; macro</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>
<span class="n">dmacHw_HANDLE_t</span> <span class="nf">dmacHw_getChannelHandle</span><span class="p">(</span><span class="n">dmacHw_ID_t</span> <span class="n">channelId</span>	<span class="cm">/* [ IN ] DMA Channel Id */</span>
    <span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">((</span><span class="n">channelId</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">dmacHw_ASSERT</span><span class="p">((</span><span class="n">channelId</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">dmaChannelCount_0</span><span class="p">);</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">channelId</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">dmacHw_ASSERT</span><span class="p">((</span><span class="n">channelId</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">dmaChannelCount_1</span><span class="p">);</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">dmaChannelCount_0</span> <span class="o">+</span> <span class="p">(</span><span class="n">channelId</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dmacHw_ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">dmacHw_HANDLE_t</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">dmacHw_CBLK_TO_HANDLE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmacHw_gCblk</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*  @brief   Initializes a DMA channel for use</span>
<span class="cm">*</span>
<span class="cm">*  This function initializes and resets a DMA channel for use</span>
<span class="cm">*</span>
<span class="cm">*  @return  -1     - On Failure</span>
<span class="cm">*            0     - On Success</span>
<span class="cm">*</span>
<span class="cm">*  @note</span>
<span class="cm">*     None</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>
<span class="kt">int</span> <span class="nf">dmacHw_initChannel</span><span class="p">(</span><span class="n">dmacHw_HANDLE_t</span> <span class="n">handle</span>	<span class="cm">/*   [ IN ] DMA Channel handle */</span>
    <span class="p">)</span> <span class="p">{</span>
	<span class="n">dmacHw_CBLK_t</span> <span class="o">*</span><span class="n">pCblk</span> <span class="o">=</span> <span class="n">dmacHw_HANDLE_TO_CBLK</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">module</span> <span class="o">=</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>

	<span class="cm">/* Reinitialize the control block */</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pCblk</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dmacHw_CBLK_t</span><span class="p">));</span>
	<span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span> <span class="o">=</span> <span class="n">module</span><span class="p">;</span>
	<span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>

	<span class="cm">/* Enable DMA controller */</span>
	<span class="n">dmacHw_DMA_ENABLE</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">);</span>
	<span class="cm">/* Reset DMA channel */</span>
	<span class="n">dmacHw_RESET_CONTROL_LO</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">dmacHw_RESET_CONTROL_HI</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">dmacHw_RESET_CONFIG_LO</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">dmacHw_RESET_CONFIG_HI</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>

	<span class="cm">/* Clear all raw interrupt status */</span>
	<span class="n">dmacHw_TRAN_INT_CLEAR</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">dmacHw_BLOCK_INT_CLEAR</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">dmacHw_ERROR_INT_CLEAR</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>

	<span class="cm">/* Mask event specific interrupts */</span>
	<span class="n">dmacHw_TRAN_INT_DISABLE</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">dmacHw_BLOCK_INT_DISABLE</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">dmacHw_STRAN_INT_DISABLE</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">dmacHw_DTRAN_INT_DISABLE</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">dmacHw_ERROR_INT_DISABLE</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*  @brief  Finds amount of memory required to form a descriptor ring</span>
<span class="cm">*</span>
<span class="cm">*</span>
<span class="cm">*  @return   Number of bytes required to form a descriptor ring</span>
<span class="cm">*</span>
<span class="cm">*</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>
<span class="kt">uint32_t</span> <span class="nf">dmacHw_descriptorLen</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">descCnt</span>	<span class="cm">/* [ IN ] Number of descriptor in the ring */</span>
    <span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* Need extra 4 byte to ensure 32 bit alignment  */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">descCnt</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dmacHw_DESC_t</span><span class="p">))</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dmacHw_DESC_RING_t</span><span class="p">)</span> <span class="o">+</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*  @brief   Initializes descriptor ring</span>
<span class="cm">*</span>
<span class="cm">*  This function will initializes the descriptor ring of a DMA channel</span>
<span class="cm">*</span>
<span class="cm">*</span>
<span class="cm">*  @return   -1 - On failure</span>
<span class="cm">*             0 - On success</span>
<span class="cm">*  @note</span>
<span class="cm">*     - &quot;len&quot; parameter should be obtained from &quot;dmacHw_descriptorLen&quot;</span>
<span class="cm">*     - Descriptor buffer MUST be 32 bit aligned and uncached as it is</span>
<span class="cm">*       accessed by ARM and DMA</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>
<span class="kt">int</span> <span class="nf">dmacHw_initDescriptor</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">pDescriptorVirt</span><span class="p">,</span>	<span class="cm">/*  [ IN ] Virtual address of uncahced buffer allocated to form descriptor ring */</span>
			  <span class="kt">uint32_t</span> <span class="n">descriptorPhyAddr</span><span class="p">,</span>	<span class="cm">/*  [ IN ] Physical address of pDescriptorVirt (descriptor buffer) */</span>
			  <span class="kt">uint32_t</span> <span class="n">len</span><span class="p">,</span>	<span class="cm">/*  [ IN ] Size of the pBuf */</span>
			  <span class="kt">uint32_t</span> <span class="n">num</span>	<span class="cm">/*  [ IN ] Number of descriptor in the ring */</span>
    <span class="p">)</span> <span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">dmacHw_DESC_RING_t</span> <span class="o">*</span><span class="n">pRing</span><span class="p">;</span>
	<span class="n">dmacHw_DESC_t</span> <span class="o">*</span><span class="n">pDesc</span><span class="p">;</span>

	<span class="cm">/* Check the alignment of the descriptor */</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">pDescriptorVirt</span> <span class="o">&amp;</span> <span class="mh">0x00000003</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmacHw_ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if enough space has been allocated for descriptor ring */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">dmacHw_descriptorLen</span><span class="p">(</span><span class="n">num</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pRing</span> <span class="o">=</span> <span class="n">dmacHw_GET_DESC_RING</span><span class="p">(</span><span class="n">pDescriptorVirt</span><span class="p">);</span>
	<span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pHead</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">dmacHw_DESC_t</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">pRing</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dmacHw_DESC_RING_t</span><span class="p">));</span>
	<span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pFree</span> <span class="o">=</span> <span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pTail</span> <span class="o">=</span> <span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pEnd</span> <span class="o">=</span> <span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pHead</span><span class="p">;</span>
	<span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pProg</span> <span class="o">=</span> <span class="n">dmacHw_DESC_INIT</span><span class="p">;</span>
	<span class="cm">/* Initialize link item chain, starting from the head */</span>
	<span class="n">pDesc</span> <span class="o">=</span> <span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pHead</span><span class="p">;</span>
	<span class="cm">/* Find the offset between virtual to physical address */</span>
	<span class="n">pRing</span><span class="o">-&gt;</span><span class="n">virt2PhyOffset</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">pDescriptorVirt</span> <span class="o">-</span> <span class="n">descriptorPhyAddr</span><span class="p">;</span>

	<span class="cm">/* Form the descriptor ring */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Clear link list item */</span>
		<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDesc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dmacHw_DESC_t</span><span class="p">));</span>
		<span class="cm">/* Point to the next item in the physical address */</span>
		<span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">llpPhy</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="p">(</span><span class="n">pDesc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">pRing</span><span class="o">-&gt;</span><span class="n">virt2PhyOffset</span><span class="p">;</span>
		<span class="cm">/* Point to the next item in the virtual address */</span>
		<span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">llp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="p">(</span><span class="n">pDesc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* Mark descriptor is ready to use */</span>
		<span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">.</span><span class="n">hi</span> <span class="o">=</span> <span class="n">dmacHw_DESC_FREE</span><span class="p">;</span>
		<span class="cm">/* Look into next link list item */</span>
		<span class="n">pDesc</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clear last link list item */</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pDesc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dmacHw_DESC_t</span><span class="p">));</span>
	<span class="cm">/* Last item pointing to the first item in the</span>
<span class="cm">	   physical address to complete the ring */</span>
	<span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">llpPhy</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pHead</span> <span class="o">-</span> <span class="n">pRing</span><span class="o">-&gt;</span><span class="n">virt2PhyOffset</span><span class="p">;</span>
	<span class="cm">/* Last item pointing to the first item in the</span>
<span class="cm">	   virtual address to complete the ring</span>
<span class="cm">	 */</span>
	<span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">llp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pHead</span><span class="p">;</span>
	<span class="cm">/* Mark descriptor is ready to use */</span>
	<span class="n">pDesc</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">.</span><span class="n">hi</span> <span class="o">=</span> <span class="n">dmacHw_DESC_FREE</span><span class="p">;</span>
	<span class="cm">/* Set the number of descriptors in the ring */</span>
	<span class="n">pRing</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">=</span> <span class="n">num</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*  @brief   Configure DMA channel</span>
<span class="cm">*</span>
<span class="cm">*  @return  0  : On success</span>
<span class="cm">*           -1 : On failure</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>
<span class="kt">int</span> <span class="nf">dmacHw_configChannel</span><span class="p">(</span><span class="n">dmacHw_HANDLE_t</span> <span class="n">handle</span><span class="p">,</span>	<span class="cm">/*   [ IN ] DMA Channel handle */</span>
			 <span class="n">dmacHw_CONFIG_t</span> <span class="o">*</span><span class="n">pConfig</span>	<span class="cm">/*   [ IN ] Configuration settings */</span>
    <span class="p">)</span> <span class="p">{</span>
	<span class="n">dmacHw_CBLK_t</span> <span class="o">*</span><span class="n">pCblk</span> <span class="o">=</span> <span class="n">dmacHw_HANDLE_TO_CBLK</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="kt">uint32_t</span> <span class="n">cfgHigh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">srcTrSize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dstTrSize</span><span class="p">;</span>

	<span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">varDataStarted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">userData</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Configure</span>
<span class="cm">	   - Burst transaction when enough data in available in FIFO</span>
<span class="cm">	   - AHB Access protection 1</span>
<span class="cm">	   - Source and destination peripheral ports</span>
<span class="cm">	 */</span>
	<span class="n">cfgHigh</span> <span class="o">=</span>
	    <span class="n">dmacHw_REG_CFG_HI_FIFO_ENOUGH</span> <span class="o">|</span> <span class="n">dmacHw_REG_CFG_HI_AHB_HPROT_1</span> <span class="o">|</span>
	    <span class="n">dmacHw_SRC_PERI_INTF</span><span class="p">(</span><span class="n">pConfig</span><span class="o">-&gt;</span>
				 <span class="n">srcPeripheralPort</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">dmacHw_DST_PERI_INTF</span><span class="p">(</span><span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">dstPeripheralPort</span><span class="p">);</span>
	<span class="cm">/* Set priority */</span>
	<span class="n">dmacHw_SET_CHANNEL_PRIORITY</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
				    <span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">channelPriority</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">dstStatusRegisterAddress</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Destination status update enable */</span>
		<span class="n">cfgHigh</span> <span class="o">|=</span> <span class="n">dmacHw_REG_CFG_HI_UPDATE_DST_STAT</span><span class="p">;</span>
		<span class="cm">/* Configure status registers */</span>
		<span class="n">dmacHw_SET_DSTATAR</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
				   <span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">dstStatusRegisterAddress</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">srcStatusRegisterAddress</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Source status update enable */</span>
		<span class="n">cfgHigh</span> <span class="o">|=</span> <span class="n">dmacHw_REG_CFG_HI_UPDATE_SRC_STAT</span><span class="p">;</span>
		<span class="cm">/* Source status update enable */</span>
		<span class="n">dmacHw_SET_SSTATAR</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
				   <span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">srcStatusRegisterAddress</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Configure the config high register */</span>
	<span class="n">dmacHw_GET_CONFIG_HI</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span> <span class="o">=</span> <span class="n">cfgHigh</span><span class="p">;</span>

	<span class="cm">/* Clear all raw interrupt status */</span>
	<span class="n">dmacHw_TRAN_INT_CLEAR</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">dmacHw_BLOCK_INT_CLEAR</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">dmacHw_ERROR_INT_CLEAR</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>

	<span class="cm">/* Configure block interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">blockTransferInterrupt</span> <span class="o">==</span> <span class="n">dmacHw_INTERRUPT_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmacHw_BLOCK_INT_ENABLE</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dmacHw_BLOCK_INT_DISABLE</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Configure complete transfer interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">completeTransferInterrupt</span> <span class="o">==</span> <span class="n">dmacHw_INTERRUPT_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmacHw_TRAN_INT_ENABLE</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dmacHw_TRAN_INT_DISABLE</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Configure error interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">errorInterrupt</span> <span class="o">==</span> <span class="n">dmacHw_INTERRUPT_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmacHw_ERROR_INT_ENABLE</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dmacHw_ERROR_INT_DISABLE</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Configure gather register */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">srcGatherWidth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">srcTrSize</span> <span class="o">=</span>
		    <span class="n">dmacHw_GetTrWidthInBytes</span><span class="p">(</span><span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">srcMaxTransactionWidth</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span>
		    <span class="p">((</span><span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">srcGatherWidth</span> <span class="o">%</span> <span class="n">srcTrSize</span><span class="p">)</span>
		     <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">srcGatherJump</span> <span class="o">%</span> <span class="n">srcTrSize</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">dmacHw_REG_SGR_LO</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span> <span class="o">=</span>
			    <span class="p">((</span><span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">srcGatherWidth</span> <span class="o">/</span>
			      <span class="n">srcTrSize</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">srcGatherJump</span> <span class="o">/</span>
						   <span class="n">srcTrSize</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Configure scatter register */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">dstScatterWidth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dstTrSize</span> <span class="o">=</span>
		    <span class="n">dmacHw_GetTrWidthInBytes</span><span class="p">(</span><span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">dstMaxTransactionWidth</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span>
		    <span class="p">((</span><span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">dstScatterWidth</span> <span class="o">%</span> <span class="n">dstTrSize</span><span class="p">)</span>
		     <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">dstScatterJump</span> <span class="o">%</span> <span class="n">dstTrSize</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">dmacHw_REG_DSR_LO</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span> <span class="o">=</span>
			    <span class="p">((</span><span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">dstScatterWidth</span> <span class="o">/</span>
			      <span class="n">dstTrSize</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">dstScatterJump</span> <span class="o">/</span>
						   <span class="n">dstTrSize</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*  @brief   Indicates whether DMA transfer is in progress or completed</span>
<span class="cm">*</span>
<span class="cm">*  @return   DMA transfer status</span>
<span class="cm">*          dmacHw_TRANSFER_STATUS_BUSY:         DMA Transfer ongoing</span>
<span class="cm">*          dmacHw_TRANSFER_STATUS_DONE:         DMA Transfer completed</span>
<span class="cm">*          dmacHw_TRANSFER_STATUS_ERROR:        DMA Transfer error</span>
<span class="cm">*</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>
<span class="n">dmacHw_TRANSFER_STATUS_e</span> <span class="nf">dmacHw_transferCompleted</span><span class="p">(</span><span class="n">dmacHw_HANDLE_t</span> <span class="n">handle</span>	<span class="cm">/*   [ IN ] DMA Channel handle */</span>
    <span class="p">)</span> <span class="p">{</span>
	<span class="n">dmacHw_CBLK_t</span> <span class="o">*</span><span class="n">pCblk</span> <span class="o">=</span> <span class="n">dmacHw_HANDLE_TO_CBLK</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHANNEL_BUSY</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">dmacHw_TRANSFER_STATUS_BUSY</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dmacHw_REG_INT_RAW_ERROR</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">)</span> <span class="o">&amp;</span>
		   <span class="p">(</span><span class="mh">0x00000001</span> <span class="o">&lt;&lt;</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">dmacHw_TRANSFER_STATUS_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">dmacHw_TRANSFER_STATUS_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*  @brief   Set descriptors for known data length</span>
<span class="cm">*</span>
<span class="cm">*  When DMA has to work as a flow controller, this function prepares the</span>
<span class="cm">*  descriptor chain to transfer data</span>
<span class="cm">*</span>
<span class="cm">*  from:</span>
<span class="cm">*          - Memory to memory</span>
<span class="cm">*          - Peripheral to memory</span>
<span class="cm">*          - Memory to Peripheral</span>
<span class="cm">*          - Peripheral to Peripheral</span>
<span class="cm">*</span>
<span class="cm">*  @return   -1 - On failure</span>
<span class="cm">*             0 - On success</span>
<span class="cm">*</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>
<span class="kt">int</span> <span class="nf">dmacHw_setDataDescriptor</span><span class="p">(</span><span class="n">dmacHw_CONFIG_t</span> <span class="o">*</span><span class="n">pConfig</span><span class="p">,</span>	<span class="cm">/*   [ IN ] Configuration settings */</span>
			     <span class="kt">void</span> <span class="o">*</span><span class="n">pDescriptor</span><span class="p">,</span>	<span class="cm">/*   [ IN ] Descriptor buffer */</span>
			     <span class="kt">void</span> <span class="o">*</span><span class="n">pSrcAddr</span><span class="p">,</span>	<span class="cm">/*   [ IN ] Source (Peripheral/Memory) address */</span>
			     <span class="kt">void</span> <span class="o">*</span><span class="n">pDstAddr</span><span class="p">,</span>	<span class="cm">/*   [ IN ] Destination (Peripheral/Memory) address */</span>
			     <span class="kt">size_t</span> <span class="n">dataLen</span>	<span class="cm">/*   [ IN ] Data length in bytes */</span>
    <span class="p">)</span> <span class="p">{</span>
	<span class="n">dmacHw_TRANSACTION_WIDTH_e</span> <span class="n">dstTrWidth</span><span class="p">;</span>
	<span class="n">dmacHw_TRANSACTION_WIDTH_e</span> <span class="n">srcTrWidth</span><span class="p">;</span>
	<span class="n">dmacHw_DESC_RING_t</span> <span class="o">*</span><span class="n">pRing</span> <span class="o">=</span> <span class="n">dmacHw_GET_DESC_RING</span><span class="p">(</span><span class="n">pDescriptor</span><span class="p">);</span>
	<span class="n">dmacHw_DESC_t</span> <span class="o">*</span><span class="n">pStart</span><span class="p">;</span>
	<span class="n">dmacHw_DESC_t</span> <span class="o">*</span><span class="n">pProg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">srcTs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">blkTs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">oddSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">descCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dstTrSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">srcTrSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">maxBlockSize</span> <span class="o">=</span> <span class="n">dmacHw_MAX_BLOCKSIZE</span><span class="p">;</span>

	<span class="n">dstTrSize</span> <span class="o">=</span> <span class="n">dmacHw_GetTrWidthInBytes</span><span class="p">(</span><span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">dstMaxTransactionWidth</span><span class="p">);</span>
	<span class="n">srcTrSize</span> <span class="o">=</span> <span class="n">dmacHw_GetTrWidthInBytes</span><span class="p">(</span><span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">srcMaxTransactionWidth</span><span class="p">);</span>

	<span class="cm">/* Skip Tx if buffer is NULL  or length is unknown */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pSrcAddr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pDstAddr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">dataLen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Do not initiate transfer */</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Ensure scatter and gather are transaction aligned */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">srcGatherWidth</span> <span class="o">%</span> <span class="n">srcTrSize</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">dstScatterWidth</span> <span class="o">%</span> <span class="n">dstTrSize</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	   Background 1: DMAC can not perform DMA if source and destination addresses are</span>
<span class="cm">	   not properly aligned with the channel&#39;s transaction width. So, for successful</span>
<span class="cm">	   DMA transfer, transaction width must be set according to the alignment of the</span>
<span class="cm">	   source and destination address.</span>
<span class="cm">	 */</span>

	<span class="cm">/* Adjust destination transaction width if destination address is not aligned properly */</span>
	<span class="n">dstTrWidth</span> <span class="o">=</span> <span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">dstMaxTransactionWidth</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">dmacHw_ADDRESS_MASK</span><span class="p">(</span><span class="n">dstTrSize</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">pDstAddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dstTrWidth</span> <span class="o">=</span> <span class="n">dmacHw_GetNextTrWidth</span><span class="p">(</span><span class="n">dstTrWidth</span><span class="p">);</span>
		<span class="n">dstTrSize</span> <span class="o">=</span> <span class="n">dmacHw_GetTrWidthInBytes</span><span class="p">(</span><span class="n">dstTrWidth</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Adjust source transaction width if source address is not aligned properly */</span>
	<span class="n">srcTrWidth</span> <span class="o">=</span> <span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">srcMaxTransactionWidth</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">dmacHw_ADDRESS_MASK</span><span class="p">(</span><span class="n">srcTrSize</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">pSrcAddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">srcTrWidth</span> <span class="o">=</span> <span class="n">dmacHw_GetNextTrWidth</span><span class="p">(</span><span class="n">srcTrWidth</span><span class="p">);</span>
		<span class="n">srcTrSize</span> <span class="o">=</span> <span class="n">dmacHw_GetTrWidthInBytes</span><span class="p">(</span><span class="n">srcTrWidth</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Find the maximum transaction per descriptor */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">maxDataPerBlock</span>
	    <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">maxDataPerBlock</span> <span class="o">/</span> <span class="n">srcTrSize</span><span class="p">)</span> <span class="o">&lt;</span>
		<span class="n">dmacHw_MAX_BLOCKSIZE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">maxBlockSize</span> <span class="o">=</span> <span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">maxDataPerBlock</span> <span class="o">/</span> <span class="n">srcTrSize</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Find number of source transactions needed to complete the DMA transfer */</span>
	<span class="n">srcTs</span> <span class="o">=</span> <span class="n">dataLen</span> <span class="o">/</span> <span class="n">srcTrSize</span><span class="p">;</span>
	<span class="cm">/* Find the odd number of bytes that need to be transferred as single byte transaction width */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srcTs</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dstTrSize</span> <span class="o">&gt;</span> <span class="n">srcTrSize</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">oddSize</span> <span class="o">=</span> <span class="n">dataLen</span> <span class="o">%</span> <span class="n">dstTrSize</span><span class="p">;</span>
		<span class="cm">/* Adjust source transaction count due to &quot;oddSize&quot; */</span>
		<span class="n">srcTs</span> <span class="o">=</span> <span class="n">srcTs</span> <span class="o">-</span> <span class="p">(</span><span class="n">oddSize</span> <span class="o">/</span> <span class="n">srcTrSize</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">oddSize</span> <span class="o">=</span> <span class="n">dataLen</span> <span class="o">%</span> <span class="n">srcTrSize</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Adjust &quot;descCount&quot; due to &quot;oddSize&quot; */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oddSize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">descCount</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Find the number of descriptor needed for total &quot;srcTs&quot; */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srcTs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">descCount</span> <span class="o">+=</span> <span class="p">((</span><span class="n">srcTs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">maxBlockSize</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check the availability of &quot;descCount&quot; discriptors in the ring */</span>
	<span class="n">pProg</span> <span class="o">=</span> <span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pHead</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">descCount</span> <span class="o">&lt;=</span> <span class="n">pRing</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">descCount</span><span class="p">);</span>
	     <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pProg</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">.</span><span class="n">hi</span> <span class="o">&amp;</span> <span class="n">dmacHw_DESC_FREE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Sufficient descriptors are not available */</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pProg</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmacHw_DESC_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pProg</span><span class="o">-&gt;</span><span class="n">llp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Remember the link list item to program the channel registers */</span>
	<span class="n">pStart</span> <span class="o">=</span> <span class="n">pProg</span> <span class="o">=</span> <span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pHead</span><span class="p">;</span>
	<span class="cm">/* Make a link list with &quot;descCount(=count)&quot; number of descriptors */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Reset channel control information */</span>
		<span class="n">pProg</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">.</span><span class="n">lo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* Enable source gather if configured */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">srcGatherWidth</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pProg</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">.</span><span class="n">lo</span> <span class="o">|=</span> <span class="n">dmacHw_REG_CTL_SG_ENABLE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Enable destination scatter if configured */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">dstScatterWidth</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pProg</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">.</span><span class="n">lo</span> <span class="o">|=</span> <span class="n">dmacHw_REG_CTL_DS_ENABLE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Set source and destination address */</span>
		<span class="n">pProg</span><span class="o">-&gt;</span><span class="n">sar</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">pSrcAddr</span><span class="p">;</span>
		<span class="n">pProg</span><span class="o">-&gt;</span><span class="n">dar</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">pDstAddr</span><span class="p">;</span>
		<span class="cm">/* Use &quot;devCtl&quot; to mark that user memory need to be freed later if needed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pProg</span> <span class="o">==</span> <span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pHead</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pProg</span><span class="o">-&gt;</span><span class="n">devCtl</span> <span class="o">=</span> <span class="n">dmacHw_FREE_USER_MEMORY</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pProg</span><span class="o">-&gt;</span><span class="n">devCtl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">blkTs</span> <span class="o">=</span> <span class="n">srcTs</span><span class="p">;</span>

		<span class="cm">/* Special treatmeant for last descriptor */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Mark the last descriptor */</span>
			<span class="n">pProg</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">.</span><span class="n">lo</span> <span class="o">&amp;=</span>
			    <span class="o">~</span><span class="p">(</span><span class="n">dmacHw_REG_CTL_LLP_DST_EN</span> <span class="o">|</span>
			      <span class="n">dmacHw_REG_CTL_LLP_SRC_EN</span><span class="p">);</span>
			<span class="cm">/* Treatment for odd data bytes */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">oddSize</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Adjust for single byte transaction width */</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">transferType</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">dmacHw_TRANSFER_TYPE_PERIPHERAL_TO_MEM</span>:
					<span class="n">dstTrWidth</span> <span class="o">=</span>
					    <span class="n">dmacHw_DST_TRANSACTION_WIDTH_8</span><span class="p">;</span>
					<span class="n">blkTs</span> <span class="o">=</span>
					    <span class="p">(</span><span class="n">oddSize</span> <span class="o">/</span> <span class="n">srcTrSize</span><span class="p">)</span> <span class="o">+</span>
					    <span class="p">((</span><span class="n">oddSize</span> <span class="o">%</span> <span class="n">srcTrSize</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">dmacHw_TRANSFER_TYPE_MEM_TO_PERIPHERAL</span>:
					<span class="n">srcTrWidth</span> <span class="o">=</span>
					    <span class="n">dmacHw_SRC_TRANSACTION_WIDTH_8</span><span class="p">;</span>
					<span class="n">blkTs</span> <span class="o">=</span> <span class="n">oddSize</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">dmacHw_TRANSFER_TYPE_MEM_TO_MEM</span>:
					<span class="n">srcTrWidth</span> <span class="o">=</span>
					    <span class="n">dmacHw_SRC_TRANSACTION_WIDTH_8</span><span class="p">;</span>
					<span class="n">dstTrWidth</span> <span class="o">=</span>
					    <span class="n">dmacHw_DST_TRANSACTION_WIDTH_8</span><span class="p">;</span>
					<span class="n">blkTs</span> <span class="o">=</span> <span class="n">oddSize</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">dmacHw_TRANSFER_TYPE_PERIPHERAL_TO_PERIPHERAL</span>:
					<span class="cm">/* Do not adjust the transaction width  */</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">srcTs</span> <span class="o">-=</span> <span class="n">blkTs</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">srcTs</span> <span class="o">/</span> <span class="n">maxBlockSize</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">blkTs</span> <span class="o">=</span> <span class="n">maxBlockSize</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* Remaining source transactions for next iteration */</span>
			<span class="n">srcTs</span> <span class="o">-=</span> <span class="n">blkTs</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Must have a valid source transactions */</span>
		<span class="n">dmacHw_ASSERT</span><span class="p">(</span><span class="n">blkTs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* Set control information */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">flowControler</span> <span class="o">==</span> <span class="n">dmacHw_FLOW_CONTROL_DMA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pProg</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">.</span><span class="n">lo</span> <span class="o">|=</span> <span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">transferType</span> <span class="o">|</span>
			    <span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">srcUpdate</span> <span class="o">|</span>
			    <span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">dstUpdate</span> <span class="o">|</span>
			    <span class="n">srcTrWidth</span> <span class="o">|</span>
			    <span class="n">dstTrWidth</span> <span class="o">|</span>
			    <span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">srcMaxBurstWidth</span> <span class="o">|</span>
			    <span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">dstMaxBurstWidth</span> <span class="o">|</span>
			    <span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">srcMasterInterface</span> <span class="o">|</span>
			    <span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">dstMasterInterface</span> <span class="o">|</span> <span class="n">dmacHw_REG_CTL_INT_EN</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">uint32_t</span> <span class="n">transferType</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">transferType</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">dmacHw_TRANSFER_TYPE_PERIPHERAL_TO_MEM</span>:
				<span class="n">transferType</span> <span class="o">=</span> <span class="n">dmacHw_REG_CTL_TTFC_PM_PERI</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">dmacHw_TRANSFER_TYPE_MEM_TO_PERIPHERAL</span>:
				<span class="n">transferType</span> <span class="o">=</span> <span class="n">dmacHw_REG_CTL_TTFC_MP_PERI</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">dmacHw_ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">pProg</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">.</span><span class="n">lo</span> <span class="o">|=</span> <span class="n">transferType</span> <span class="o">|</span>
			    <span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">srcUpdate</span> <span class="o">|</span>
			    <span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">dstUpdate</span> <span class="o">|</span>
			    <span class="n">srcTrWidth</span> <span class="o">|</span>
			    <span class="n">dstTrWidth</span> <span class="o">|</span>
			    <span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">srcMaxBurstWidth</span> <span class="o">|</span>
			    <span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">dstMaxBurstWidth</span> <span class="o">|</span>
			    <span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">srcMasterInterface</span> <span class="o">|</span>
			    <span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">dstMasterInterface</span> <span class="o">|</span> <span class="n">dmacHw_REG_CTL_INT_EN</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Set block transaction size */</span>
		<span class="n">pProg</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">.</span><span class="n">hi</span> <span class="o">=</span> <span class="n">blkTs</span> <span class="o">&amp;</span> <span class="n">dmacHw_REG_CTL_BLOCK_TS_MASK</span><span class="p">;</span>
		<span class="cm">/* Look for next descriptor */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Point to the next descriptor */</span>
			<span class="n">pProg</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmacHw_DESC_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pProg</span><span class="o">-&gt;</span><span class="n">llp</span><span class="p">;</span>

			<span class="cm">/* Update source and destination address for next iteration */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">transferType</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">dmacHw_TRANSFER_TYPE_PERIPHERAL_TO_MEM</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">dstScatterWidth</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pDstAddr</span> <span class="o">=</span>
					    <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pDstAddr</span> <span class="o">+</span>
					    <span class="n">blkTs</span> <span class="o">*</span> <span class="n">srcTrSize</span> <span class="o">+</span>
					    <span class="p">(((</span><span class="n">blkTs</span> <span class="o">*</span> <span class="n">srcTrSize</span><span class="p">)</span> <span class="o">/</span>
					      <span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">dstScatterWidth</span><span class="p">)</span> <span class="o">*</span>
					     <span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">dstScatterJump</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">pDstAddr</span> <span class="o">=</span>
					    <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pDstAddr</span> <span class="o">+</span>
					    <span class="n">blkTs</span> <span class="o">*</span> <span class="n">srcTrSize</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">dmacHw_TRANSFER_TYPE_MEM_TO_PERIPHERAL</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">srcGatherWidth</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pSrcAddr</span> <span class="o">=</span>
					    <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pDstAddr</span> <span class="o">+</span>
					    <span class="n">blkTs</span> <span class="o">*</span> <span class="n">srcTrSize</span> <span class="o">+</span>
					    <span class="p">(((</span><span class="n">blkTs</span> <span class="o">*</span> <span class="n">srcTrSize</span><span class="p">)</span> <span class="o">/</span>
					      <span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">srcGatherWidth</span><span class="p">)</span> <span class="o">*</span>
					     <span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">srcGatherJump</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">pSrcAddr</span> <span class="o">=</span>
					    <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pSrcAddr</span> <span class="o">+</span>
					    <span class="n">blkTs</span> <span class="o">*</span> <span class="n">srcTrSize</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">dmacHw_TRANSFER_TYPE_MEM_TO_MEM</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">dstScatterWidth</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pDstAddr</span> <span class="o">=</span>
					    <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pDstAddr</span> <span class="o">+</span>
					    <span class="n">blkTs</span> <span class="o">*</span> <span class="n">srcTrSize</span> <span class="o">+</span>
					    <span class="p">(((</span><span class="n">blkTs</span> <span class="o">*</span> <span class="n">srcTrSize</span><span class="p">)</span> <span class="o">/</span>
					      <span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">dstScatterWidth</span><span class="p">)</span> <span class="o">*</span>
					     <span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">dstScatterJump</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">pDstAddr</span> <span class="o">=</span>
					    <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pDstAddr</span> <span class="o">+</span>
					    <span class="n">blkTs</span> <span class="o">*</span> <span class="n">srcTrSize</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">srcGatherWidth</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pSrcAddr</span> <span class="o">=</span>
					    <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pDstAddr</span> <span class="o">+</span>
					    <span class="n">blkTs</span> <span class="o">*</span> <span class="n">srcTrSize</span> <span class="o">+</span>
					    <span class="p">(((</span><span class="n">blkTs</span> <span class="o">*</span> <span class="n">srcTrSize</span><span class="p">)</span> <span class="o">/</span>
					      <span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">srcGatherWidth</span><span class="p">)</span> <span class="o">*</span>
					     <span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">srcGatherJump</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">pSrcAddr</span> <span class="o">=</span>
					    <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pSrcAddr</span> <span class="o">+</span>
					    <span class="n">blkTs</span> <span class="o">*</span> <span class="n">srcTrSize</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">dmacHw_TRANSFER_TYPE_PERIPHERAL_TO_PERIPHERAL</span>:
				<span class="cm">/* Do not adjust the address */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">dmacHw_ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* At the end of transfer &quot;srcTs&quot; must be zero */</span>
			<span class="n">dmacHw_ASSERT</span><span class="p">(</span><span class="n">srcTs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Remember the descriptor to initialize the registers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pProg</span> <span class="o">==</span> <span class="n">dmacHw_DESC_INIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pProg</span> <span class="o">=</span> <span class="n">pStart</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Indicate that the descriptor is updated */</span>
	<span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pEnd</span> <span class="o">=</span> <span class="n">pProg</span><span class="p">;</span>
	<span class="cm">/* Head pointing to the next descriptor */</span>
	<span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pHead</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmacHw_DESC_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pProg</span><span class="o">-&gt;</span><span class="n">llp</span><span class="p">;</span>
	<span class="cm">/* Update Tail pointer if destination is a peripheral,</span>
<span class="cm">	   because no one is going to read from the pTail</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dmacHw_DST_IS_MEMORY</span><span class="p">(</span><span class="n">pConfig</span><span class="o">-&gt;</span><span class="n">transferType</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pTail</span> <span class="o">=</span> <span class="n">pRing</span><span class="o">-&gt;</span><span class="n">pHead</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*  @brief   Provides DMA controller attributes</span>
<span class="cm">*</span>
<span class="cm">*</span>
<span class="cm">*  @return  DMA controller attributes</span>
<span class="cm">*</span>
<span class="cm">*  @note</span>
<span class="cm">*     None</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>
<span class="kt">uint32_t</span> <span class="nf">dmacHw_getDmaControllerAttribute</span><span class="p">(</span><span class="n">dmacHw_HANDLE_t</span> <span class="n">handle</span><span class="p">,</span>	<span class="cm">/*  [ IN ]  DMA Channel handle */</span>
					  <span class="n">dmacHw_CONTROLLER_ATTRIB_e</span> <span class="n">attr</span>	<span class="cm">/*  [ IN ]  DMA Controller attribute of type  dmacHw_CONTROLLER_ATTRIB_e */</span>
    <span class="p">)</span> <span class="p">{</span>
	<span class="n">dmacHw_CBLK_t</span> <span class="o">*</span><span class="n">pCblk</span> <span class="o">=</span> <span class="n">dmacHw_HANDLE_TO_CBLK</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">dmacHw_CONTROLLER_ATTRIB_CHANNEL_NUM</span>:
		<span class="k">return</span> <span class="n">dmacHw_GET_NUM_CHANNEL</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">dmacHw_CONTROLLER_ATTRIB_CHANNEL_MAX_BLOCK_SIZE</span>:
		<span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span>
			 <span class="p">(</span><span class="n">dmacHw_GET_MAX_BLOCK_SIZE</span>
			  <span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">dmacHw_CONTROLLER_ATTRIB_MASTER_INTF_NUM</span>:
		<span class="k">return</span> <span class="n">dmacHw_GET_NUM_INTERFACE</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">dmacHw_CONTROLLER_ATTRIB_CHANNEL_BUS_WIDTH</span>:
		<span class="k">return</span> <span class="mi">32</span> <span class="o">&lt;&lt;</span> <span class="n">dmacHw_GET_CHANNEL_DATA_WIDTH</span><span class="p">(</span><span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span>
							   <span class="n">pCblk</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">dmacHw_CONTROLLER_ATTRIB_CHANNEL_FIFO_SIZE</span>:
		<span class="k">return</span> <span class="n">GetFifoSize</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dmacHw_ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
