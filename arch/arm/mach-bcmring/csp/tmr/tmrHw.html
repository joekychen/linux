<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › mach-bcmring › csp › tmr › tmrHw.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>tmrHw.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*****************************************************************************</span>
<span class="cm">* Copyright 2003 - 2008 Broadcom Corporation.  All rights reserved.</span>
<span class="cm">*</span>
<span class="cm">* Unless you and Broadcom execute a separate written software license</span>
<span class="cm">* agreement governing use of this software, this software is licensed to you</span>
<span class="cm">* under the terms of the GNU General Public License version 2, available at</span>
<span class="cm">* http://www.broadcom.com/licenses/GPLv2.php (the &quot;GPL&quot;).</span>
<span class="cm">*</span>
<span class="cm">* Notwithstanding the above, under no circumstances may you combine this</span>
<span class="cm">* software in any way with any other Broadcom software provided under a</span>
<span class="cm">* license other than the GPL, without Broadcom&#39;s express prior written</span>
<span class="cm">* consent.</span>
<span class="cm">*****************************************************************************/</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*  @file    tmrHw.c</span>
<span class="cm">*</span>
<span class="cm">*  @brief   Low level Timer driver routines</span>
<span class="cm">*</span>
<span class="cm">*  @note</span>
<span class="cm">*</span>
<span class="cm">*   These routines provide basic timer functionality only.</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>

<span class="cm">/* ---- Include Files ---------------------------------------------------- */</span>

<span class="cp">#include &lt;csp/errno.h&gt;</span>
<span class="cp">#include &lt;csp/stdint.h&gt;</span>

<span class="cp">#include &lt;csp/tmrHw.h&gt;</span>
<span class="cp">#include &lt;mach/csp/tmrHw_reg.h&gt;</span>

<span class="cp">#define tmrHw_ASSERT(a)                     if (!(a)) *(char *)0 = 0</span>
<span class="cp">#define tmrHw_MILLISEC_PER_SEC              (1000)</span>

<span class="cp">#define tmrHw_LOW_1_RESOLUTION_COUNT        (tmrHw_LOW_RESOLUTION_CLOCK / tmrHw_MILLISEC_PER_SEC)</span>
<span class="cp">#define tmrHw_LOW_1_MAX_MILLISEC            (0xFFFFFFFF / tmrHw_LOW_1_RESOLUTION_COUNT)</span>
<span class="cp">#define tmrHw_LOW_16_RESOLUTION_COUNT       (tmrHw_LOW_1_RESOLUTION_COUNT / 16)</span>
<span class="cp">#define tmrHw_LOW_16_MAX_MILLISEC           (0xFFFFFFFF / tmrHw_LOW_16_RESOLUTION_COUNT)</span>
<span class="cp">#define tmrHw_LOW_256_RESOLUTION_COUNT      (tmrHw_LOW_1_RESOLUTION_COUNT / 256)</span>
<span class="cp">#define tmrHw_LOW_256_MAX_MILLISEC          (0xFFFFFFFF / tmrHw_LOW_256_RESOLUTION_COUNT)</span>

<span class="cp">#define tmrHw_HIGH_1_RESOLUTION_COUNT       (tmrHw_HIGH_RESOLUTION_CLOCK / tmrHw_MILLISEC_PER_SEC)</span>
<span class="cp">#define tmrHw_HIGH_1_MAX_MILLISEC           (0xFFFFFFFF / tmrHw_HIGH_1_RESOLUTION_COUNT)</span>
<span class="cp">#define tmrHw_HIGH_16_RESOLUTION_COUNT      (tmrHw_HIGH_1_RESOLUTION_COUNT / 16)</span>
<span class="cp">#define tmrHw_HIGH_16_MAX_MILLISEC          (0xFFFFFFFF / tmrHw_HIGH_16_RESOLUTION_COUNT)</span>
<span class="cp">#define tmrHw_HIGH_256_RESOLUTION_COUNT     (tmrHw_HIGH_1_RESOLUTION_COUNT / 256)</span>
<span class="cp">#define tmrHw_HIGH_256_MAX_MILLISEC         (0xFFFFFFFF / tmrHw_HIGH_256_RESOLUTION_COUNT)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ResetTimer</span><span class="p">(</span><span class="n">tmrHw_ID_t</span> <span class="n">timerId</span><span class="p">)</span>
    <span class="n">__attribute__</span> <span class="p">((</span><span class="n">section</span><span class="p">(</span><span class="s">&quot;.aramtext&quot;</span><span class="p">)));</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tmrHw_divide</span><span class="p">(</span><span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">denom</span><span class="p">)</span>
    <span class="n">__attribute__</span> <span class="p">((</span><span class="n">section</span><span class="p">(</span><span class="s">&quot;.aramtext&quot;</span><span class="p">)));</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*  @brief   Get timer capability</span>
<span class="cm">*</span>
<span class="cm">*  This function returns various capabilities/attributes of a timer</span>
<span class="cm">*</span>
<span class="cm">*  @return  Capability</span>
<span class="cm">*</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>
<span class="kt">uint32_t</span> <span class="nf">tmrHw_getTimerCapability</span><span class="p">(</span><span class="n">tmrHw_ID_t</span> <span class="n">timerId</span><span class="p">,</span>	<span class="cm">/*  [ IN ] Timer Id */</span>
				  <span class="n">tmrHw_CAPABILITY_e</span> <span class="n">capability</span>	<span class="cm">/*  [ IN ] Timer capability */</span>
<span class="p">)</span> <span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">capability</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">tmrHw_CAPABILITY_CLOCK</span>:
		<span class="k">return</span> <span class="p">(</span><span class="n">timerId</span> <span class="o">&lt;=</span>
			<span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">tmrHw_LOW_RESOLUTION_CLOCK</span> <span class="o">:</span>
		    <span class="n">tmrHw_HIGH_RESOLUTION_CLOCK</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">tmrHw_CAPABILITY_RESOLUTION</span>:
		<span class="k">return</span> <span class="mi">32</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*  @brief   Resets a timer</span>
<span class="cm">*</span>
<span class="cm">*  This function initializes  timer</span>
<span class="cm">*</span>
<span class="cm">*  @return  void</span>
<span class="cm">*</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ResetTimer</span><span class="p">(</span><span class="n">tmrHw_ID_t</span> <span class="n">timerId</span>	<span class="cm">/*  [ IN ] Timer Id */</span>
<span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* Reset timer */</span>
	<span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">LoadValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">CurrentValue</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">Control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">BackgroundLoad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Always configure as a 32 bit timer */</span>
	<span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">Control</span> <span class="o">|=</span> <span class="n">tmrHw_CONTROL_32BIT</span><span class="p">;</span>
	<span class="cm">/* Clear interrupt only if raw status interrupt is set */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">RawInterruptStatus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">InterruptClear</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*  @brief   Sets counter value for an interval in ms</span>
<span class="cm">*</span>
<span class="cm">*  @return   On success: Effective counter value set</span>
<span class="cm">*            On failure: 0</span>
<span class="cm">*</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="n">tmrHw_INTERVAL_t</span> <span class="nf">SetTimerPeriod</span><span class="p">(</span><span class="n">tmrHw_ID_t</span> <span class="n">timerId</span><span class="p">,</span>	<span class="cm">/*  [ IN ] Timer Id */</span>
				       <span class="n">tmrHw_INTERVAL_t</span> <span class="n">msec</span>	<span class="cm">/*  [ IN ] Interval in milli-second */</span>
<span class="p">)</span> <span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">scale</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timerId</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">timerId</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msec</span> <span class="o">&lt;=</span> <span class="n">tmrHw_LOW_1_MAX_MILLISEC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">Control</span> <span class="o">|=</span> <span class="n">tmrHw_CONTROL_PRESCALE_1</span><span class="p">;</span>
			<span class="n">scale</span> <span class="o">=</span> <span class="n">tmrHw_LOW_1_RESOLUTION_COUNT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">msec</span> <span class="o">&lt;=</span> <span class="n">tmrHw_LOW_16_MAX_MILLISEC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">Control</span> <span class="o">|=</span> <span class="n">tmrHw_CONTROL_PRESCALE_16</span><span class="p">;</span>
			<span class="n">scale</span> <span class="o">=</span> <span class="n">tmrHw_LOW_16_RESOLUTION_COUNT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">msec</span> <span class="o">&lt;=</span> <span class="n">tmrHw_LOW_256_MAX_MILLISEC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">Control</span> <span class="o">|=</span> <span class="n">tmrHw_CONTROL_PRESCALE_256</span><span class="p">;</span>
			<span class="n">scale</span> <span class="o">=</span> <span class="n">tmrHw_LOW_256_RESOLUTION_COUNT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">count</span> <span class="o">=</span> <span class="n">msec</span> <span class="o">*</span> <span class="n">scale</span><span class="p">;</span>
		<span class="cm">/* Set counter value */</span>
		<span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">LoadValue</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">BackgroundLoad</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">timerId</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">timerId</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msec</span> <span class="o">&lt;=</span> <span class="n">tmrHw_HIGH_1_MAX_MILLISEC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">Control</span> <span class="o">|=</span> <span class="n">tmrHw_CONTROL_PRESCALE_1</span><span class="p">;</span>
			<span class="n">scale</span> <span class="o">=</span> <span class="n">tmrHw_HIGH_1_RESOLUTION_COUNT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">msec</span> <span class="o">&lt;=</span> <span class="n">tmrHw_HIGH_16_MAX_MILLISEC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">Control</span> <span class="o">|=</span> <span class="n">tmrHw_CONTROL_PRESCALE_16</span><span class="p">;</span>
			<span class="n">scale</span> <span class="o">=</span> <span class="n">tmrHw_HIGH_16_RESOLUTION_COUNT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">msec</span> <span class="o">&lt;=</span> <span class="n">tmrHw_HIGH_256_MAX_MILLISEC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">Control</span> <span class="o">|=</span> <span class="n">tmrHw_CONTROL_PRESCALE_256</span><span class="p">;</span>
			<span class="n">scale</span> <span class="o">=</span> <span class="n">tmrHw_HIGH_256_RESOLUTION_COUNT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">count</span> <span class="o">=</span> <span class="n">msec</span> <span class="o">*</span> <span class="n">scale</span><span class="p">;</span>
		<span class="cm">/* Set counter value */</span>
		<span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">LoadValue</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">BackgroundLoad</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span> <span class="o">/</span> <span class="n">scale</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*  @brief   Configures a periodic timer in terms of timer interrupt rate</span>
<span class="cm">*</span>
<span class="cm">*  This function initializes a periodic timer to generate specific number of</span>
<span class="cm">*  timer interrupt per second</span>
<span class="cm">*</span>
<span class="cm">*  @return   On success: Effective timer frequency</span>
<span class="cm">*            On failure: 0</span>
<span class="cm">*</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>
<span class="n">tmrHw_RATE_t</span> <span class="nf">tmrHw_setPeriodicTimerRate</span><span class="p">(</span><span class="n">tmrHw_ID_t</span> <span class="n">timerId</span><span class="p">,</span>	<span class="cm">/*  [ IN ] Timer Id */</span>
					<span class="n">tmrHw_RATE_t</span> <span class="n">rate</span>	<span class="cm">/*  [ IN ] Number of timer interrupt per second */</span>
<span class="p">)</span> <span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">resolution</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ResetTimer</span><span class="p">(</span><span class="n">timerId</span><span class="p">);</span>

	<span class="cm">/* Set timer mode periodic */</span>
	<span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">Control</span> <span class="o">|=</span> <span class="n">tmrHw_CONTROL_PERIODIC</span><span class="p">;</span>
	<span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">Control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">tmrHw_CONTROL_ONESHOT</span><span class="p">;</span>
	<span class="cm">/* Set timer in highest resolution */</span>
	<span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">Control</span> <span class="o">|=</span> <span class="n">tmrHw_CONTROL_PRESCALE_1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">timerId</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">timerId</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;</span> <span class="n">tmrHw_LOW_RESOLUTION_CLOCK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">resolution</span> <span class="o">=</span> <span class="n">tmrHw_LOW_RESOLUTION_CLOCK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">timerId</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">timerId</span> <span class="o">==</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;</span> <span class="n">tmrHw_HIGH_RESOLUTION_CLOCK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">resolution</span> <span class="o">=</span> <span class="n">tmrHw_HIGH_RESOLUTION_CLOCK</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Find the counter value */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">resolution</span> <span class="o">/</span> <span class="n">rate</span><span class="p">;</span>
	<span class="cm">/* Set counter value */</span>
	<span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">LoadValue</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">BackgroundLoad</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">resolution</span> <span class="o">/</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*  @brief   Configures a periodic timer to generate timer interrupt after</span>
<span class="cm">*           certain time interval</span>
<span class="cm">*</span>
<span class="cm">*  This function initializes a periodic timer to generate timer interrupt</span>
<span class="cm">*  after every time interval in millisecond</span>
<span class="cm">*</span>
<span class="cm">*  @return   On success: Effective interval set in milli-second</span>
<span class="cm">*            On failure: 0</span>
<span class="cm">*</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>
<span class="n">tmrHw_INTERVAL_t</span> <span class="nf">tmrHw_setPeriodicTimerInterval</span><span class="p">(</span><span class="n">tmrHw_ID_t</span> <span class="n">timerId</span><span class="p">,</span>	<span class="cm">/*  [ IN ] Timer Id */</span>
						<span class="n">tmrHw_INTERVAL_t</span> <span class="n">msec</span>	<span class="cm">/*  [ IN ] Interval in milli-second */</span>
<span class="p">)</span> <span class="p">{</span>
	<span class="n">ResetTimer</span><span class="p">(</span><span class="n">timerId</span><span class="p">);</span>

	<span class="cm">/* Set timer mode periodic */</span>
	<span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">Control</span> <span class="o">|=</span> <span class="n">tmrHw_CONTROL_PERIODIC</span><span class="p">;</span>
	<span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">Control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">tmrHw_CONTROL_ONESHOT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">SetTimerPeriod</span><span class="p">(</span><span class="n">timerId</span><span class="p">,</span> <span class="n">msec</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*  @brief   Configures a periodic timer to generate timer interrupt just once</span>
<span class="cm">*           after certain time interval</span>
<span class="cm">*</span>
<span class="cm">*  This function initializes a periodic timer to generate a single ticks after</span>
<span class="cm">*  certain time interval in millisecond</span>
<span class="cm">*</span>
<span class="cm">*  @return   On success: Effective interval set in milli-second</span>
<span class="cm">*            On failure: 0</span>
<span class="cm">*</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>
<span class="n">tmrHw_INTERVAL_t</span> <span class="nf">tmrHw_setOneshotTimerInterval</span><span class="p">(</span><span class="n">tmrHw_ID_t</span> <span class="n">timerId</span><span class="p">,</span>	<span class="cm">/*  [ IN ] Timer Id */</span>
					       <span class="n">tmrHw_INTERVAL_t</span> <span class="n">msec</span>	<span class="cm">/*  [ IN ] Interval in milli-second */</span>
<span class="p">)</span> <span class="p">{</span>
	<span class="n">ResetTimer</span><span class="p">(</span><span class="n">timerId</span><span class="p">);</span>

	<span class="cm">/* Set timer mode oneshot */</span>
	<span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">Control</span> <span class="o">|=</span> <span class="n">tmrHw_CONTROL_PERIODIC</span><span class="p">;</span>
	<span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">Control</span> <span class="o">|=</span> <span class="n">tmrHw_CONTROL_ONESHOT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">SetTimerPeriod</span><span class="p">(</span><span class="n">timerId</span><span class="p">,</span> <span class="n">msec</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*  @brief   Configures a timer to run as a free running timer</span>
<span class="cm">*</span>
<span class="cm">*  This function initializes a timer to run as a free running timer</span>
<span class="cm">*</span>
<span class="cm">*  @return   Timer resolution (count / sec)</span>
<span class="cm">*</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>
<span class="n">tmrHw_RATE_t</span> <span class="nf">tmrHw_setFreeRunningTimer</span><span class="p">(</span><span class="n">tmrHw_ID_t</span> <span class="n">timerId</span><span class="p">,</span>	<span class="cm">/*  [ IN ] Timer Id */</span>
				       <span class="kt">uint32_t</span> <span class="n">divider</span>	<span class="cm">/*  [ IN ] Dividing the clock frequency */</span>
<span class="p">)</span> <span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">scale</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ResetTimer</span><span class="p">(</span><span class="n">timerId</span><span class="p">);</span>
	<span class="cm">/* Set timer as free running mode */</span>
	<span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">Control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">tmrHw_CONTROL_PERIODIC</span><span class="p">;</span>
	<span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">Control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">tmrHw_CONTROL_ONESHOT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">divider</span> <span class="o">&gt;=</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">Control</span> <span class="o">|=</span> <span class="n">tmrHw_CONTROL_PRESCALE_256</span><span class="p">;</span>
		<span class="n">scale</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">divider</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">Control</span> <span class="o">|=</span> <span class="n">tmrHw_CONTROL_PRESCALE_16</span><span class="p">;</span>
		<span class="n">scale</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">Control</span> <span class="o">|=</span> <span class="n">tmrHw_CONTROL_PRESCALE_1</span><span class="p">;</span>
		<span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timerId</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">timerId</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">tmrHw_divide</span><span class="p">(</span><span class="n">tmrHw_LOW_RESOLUTION_CLOCK</span><span class="p">,</span> <span class="n">scale</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">timerId</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">timerId</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">tmrHw_divide</span><span class="p">(</span><span class="n">tmrHw_HIGH_RESOLUTION_CLOCK</span><span class="p">,</span> <span class="n">scale</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*  @brief   Starts a timer</span>
<span class="cm">*</span>
<span class="cm">*  This function starts a preconfigured timer</span>
<span class="cm">*</span>
<span class="cm">*  @return  -1     - On Failure</span>
<span class="cm">*            0     - On Success</span>
<span class="cm">*</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>
<span class="kt">int</span> <span class="nf">tmrHw_startTimer</span><span class="p">(</span><span class="n">tmrHw_ID_t</span> <span class="n">timerId</span>	<span class="cm">/*  [ IN ] Timer id */</span>
<span class="p">)</span> <span class="p">{</span>
	<span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">Control</span> <span class="o">|=</span> <span class="n">tmrHw_CONTROL_TIMER_ENABLE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*  @brief   Stops a timer</span>
<span class="cm">*</span>
<span class="cm">*  This function stops a running timer</span>
<span class="cm">*</span>
<span class="cm">*  @return  -1     - On Failure</span>
<span class="cm">*            0     - On Success</span>
<span class="cm">*</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>
<span class="kt">int</span> <span class="nf">tmrHw_stopTimer</span><span class="p">(</span><span class="n">tmrHw_ID_t</span> <span class="n">timerId</span>	<span class="cm">/*  [ IN ] Timer id */</span>
<span class="p">)</span> <span class="p">{</span>
	<span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">Control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">tmrHw_CONTROL_TIMER_ENABLE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*  @brief   Gets current timer count</span>
<span class="cm">*</span>
<span class="cm">*  This function returns the current timer value</span>
<span class="cm">*</span>
<span class="cm">*  @return  Current downcounting timer value</span>
<span class="cm">*</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>
<span class="kt">uint32_t</span> <span class="nf">tmrHw_GetCurrentCount</span><span class="p">(</span><span class="n">tmrHw_ID_t</span> <span class="n">timerId</span>	<span class="cm">/*  [ IN ] Timer id */</span>
<span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* return 32 bit timer value */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">Control</span> <span class="o">&amp;</span> <span class="n">tmrHw_CONTROL_MODE_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">tmrHw_CONTROL_FREE_RUNNING</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">CurrentValue</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">tmrHw_MAX_COUNT</span> <span class="o">-</span> <span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">CurrentValue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">tmrHw_CONTROL_PERIODIC</span>:
	<span class="k">case</span> <span class="n">tmrHw_CONTROL_ONESHOT</span>:
		<span class="k">return</span> <span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">BackgroundLoad</span> <span class="o">-</span>
		    <span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">CurrentValue</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*  @brief   Gets timer count rate</span>
<span class="cm">*</span>
<span class="cm">*  This function returns the number of counts per second</span>
<span class="cm">*</span>
<span class="cm">*  @return  Count rate</span>
<span class="cm">*</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>
<span class="n">tmrHw_RATE_t</span> <span class="nf">tmrHw_getCountRate</span><span class="p">(</span><span class="n">tmrHw_ID_t</span> <span class="n">timerId</span>	<span class="cm">/*  [ IN ] Timer id */</span>
<span class="p">)</span> <span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">divider</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">Control</span> <span class="o">&amp;</span> <span class="n">tmrHw_CONTROL_PRESCALE_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">tmrHw_CONTROL_PRESCALE_1</span>:
		<span class="n">divider</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">tmrHw_CONTROL_PRESCALE_16</span>:
		<span class="n">divider</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">tmrHw_CONTROL_PRESCALE_256</span>:
		<span class="n">divider</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">tmrHw_ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timerId</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">timerId</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">tmrHw_divide</span><span class="p">(</span><span class="n">tmrHw_LOW_RESOLUTION_CLOCK</span><span class="p">,</span> <span class="n">divider</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">tmrHw_divide</span><span class="p">(</span><span class="n">tmrHw_HIGH_RESOLUTION_CLOCK</span><span class="p">,</span> <span class="n">divider</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*  @brief   Enables timer interrupt</span>
<span class="cm">*</span>
<span class="cm">*  This function enables the timer interrupt</span>
<span class="cm">*</span>
<span class="cm">*  @return   N/A</span>
<span class="cm">*</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>
<span class="kt">void</span> <span class="nf">tmrHw_enableInterrupt</span><span class="p">(</span><span class="n">tmrHw_ID_t</span> <span class="n">timerId</span>	<span class="cm">/*  [ IN ] Timer id */</span>
<span class="p">)</span> <span class="p">{</span>
	<span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">Control</span> <span class="o">|=</span> <span class="n">tmrHw_CONTROL_INTERRUPT_ENABLE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*  @brief   Disables timer interrupt</span>
<span class="cm">*</span>
<span class="cm">*  This function disable the timer interrupt</span>
<span class="cm">*</span>
<span class="cm">*  @return   N/A</span>
<span class="cm">*</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>
<span class="kt">void</span> <span class="nf">tmrHw_disableInterrupt</span><span class="p">(</span><span class="n">tmrHw_ID_t</span> <span class="n">timerId</span>	<span class="cm">/*  [ IN ] Timer id */</span>
<span class="p">)</span> <span class="p">{</span>
	<span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">Control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">tmrHw_CONTROL_INTERRUPT_ENABLE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*  @brief   Clears the interrupt</span>
<span class="cm">*</span>
<span class="cm">*  This function clears the timer interrupt</span>
<span class="cm">*</span>
<span class="cm">*  @return   N/A</span>
<span class="cm">*</span>
<span class="cm">*  @note</span>
<span class="cm">*     Must be called under the context of ISR</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>
<span class="kt">void</span> <span class="nf">tmrHw_clearInterrupt</span><span class="p">(</span><span class="n">tmrHw_ID_t</span> <span class="n">timerId</span>	<span class="cm">/*  [ IN ] Timer id */</span>
<span class="p">)</span> <span class="p">{</span>
	<span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">InterruptClear</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*  @brief   Gets the interrupt status</span>
<span class="cm">*</span>
<span class="cm">*  This function returns timer interrupt status</span>
<span class="cm">*</span>
<span class="cm">*  @return   Interrupt status</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>
<span class="n">tmrHw_INTERRUPT_STATUS_e</span> <span class="nf">tmrHw_getInterruptStatus</span><span class="p">(</span><span class="n">tmrHw_ID_t</span> <span class="n">timerId</span>	<span class="cm">/*  [ IN ] Timer id */</span>
<span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">InterruptStatus</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">tmrHw_INTERRUPT_STATUS_SET</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">tmrHw_INTERRUPT_STATUS_UNSET</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*  @brief   Indentifies a timer causing interrupt</span>
<span class="cm">*</span>
<span class="cm">*  This functions returns a timer causing interrupt</span>
<span class="cm">*</span>
<span class="cm">*  @return  0xFFFFFFFF   : No timer causing an interrupt</span>
<span class="cm">*           ! 0xFFFFFFFF : timer causing an interrupt</span>
<span class="cm">*  @note</span>
<span class="cm">*     tmrHw_clearIntrrupt() must be called with a valid timer id after calling this function</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>
<span class="n">tmrHw_ID_t</span> <span class="nf">tmrHw_getInterruptSource</span><span class="p">(</span><span class="kt">void</span>	<span class="cm">/*  void */</span>
<span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tmrHw_TIMER_NUM_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pTmrHw</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">InterruptStatus</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*  @brief   Displays specific timer registers</span>
<span class="cm">*</span>
<span class="cm">*</span>
<span class="cm">*  @return  void</span>
<span class="cm">*</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>
<span class="kt">void</span> <span class="nf">tmrHw_printDebugInfo</span><span class="p">(</span><span class="n">tmrHw_ID_t</span> <span class="n">timerId</span><span class="p">,</span>	<span class="cm">/*  [ IN ] Timer id */</span>
			  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">fpPrint</span><span class="p">)</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="p">...)</span>	<span class="cm">/*  [ IN ] Print callback function */</span>
<span class="p">)</span> <span class="p">{</span>
	<span class="p">(</span><span class="o">*</span><span class="n">fpPrint</span><span class="p">)</span> <span class="p">(</span><span class="s">&quot;Displaying register contents </span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="n">fpPrint</span><span class="p">)</span> <span class="p">(</span><span class="s">&quot;Timer %d: Load value              0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">timerId</span><span class="p">,</span>
		    <span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">LoadValue</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="n">fpPrint</span><span class="p">)</span> <span class="p">(</span><span class="s">&quot;Timer %d: Background load value   0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">timerId</span><span class="p">,</span>
		    <span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">BackgroundLoad</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="n">fpPrint</span><span class="p">)</span> <span class="p">(</span><span class="s">&quot;Timer %d: Control                 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">timerId</span><span class="p">,</span>
		    <span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">Control</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="n">fpPrint</span><span class="p">)</span> <span class="p">(</span><span class="s">&quot;Timer %d: Interrupt clear         0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">timerId</span><span class="p">,</span>
		    <span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">InterruptClear</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="n">fpPrint</span><span class="p">)</span> <span class="p">(</span><span class="s">&quot;Timer %d: Interrupt raw interrupt 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">timerId</span><span class="p">,</span>
		    <span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">RawInterruptStatus</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="n">fpPrint</span><span class="p">)</span> <span class="p">(</span><span class="s">&quot;Timer %d: Interrupt status        0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">timerId</span><span class="p">,</span>
		    <span class="n">pTmrHw</span><span class="p">[</span><span class="n">timerId</span><span class="p">].</span><span class="n">InterruptStatus</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*  @brief   Use a timer to perform a busy wait delay for a number of usecs.</span>
<span class="cm">*</span>
<span class="cm">*  @return   N/A</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>
<span class="kt">void</span> <span class="nf">tmrHw_udelay</span><span class="p">(</span><span class="n">tmrHw_ID_t</span> <span class="n">timerId</span><span class="p">,</span>	<span class="cm">/*  [ IN ] Timer id */</span>
		  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">usecs</span> <span class="cm">/*  [ IN ] usec to delay */</span>
<span class="p">)</span> <span class="p">{</span>
	<span class="n">tmrHw_RATE_t</span> <span class="n">usec_tick_rate</span><span class="p">;</span>
	<span class="n">tmrHw_COUNT_t</span> <span class="n">start_time</span><span class="p">;</span>
	<span class="n">tmrHw_COUNT_t</span> <span class="n">delta_time</span><span class="p">;</span>

	<span class="n">start_time</span> <span class="o">=</span> <span class="n">tmrHw_GetCurrentCount</span><span class="p">(</span><span class="n">timerId</span><span class="p">);</span>
	<span class="n">usec_tick_rate</span> <span class="o">=</span> <span class="n">tmrHw_divide</span><span class="p">(</span><span class="n">tmrHw_getCountRate</span><span class="p">(</span><span class="n">timerId</span><span class="p">),</span> <span class="mi">1000000</span><span class="p">);</span>
	<span class="n">delta_time</span> <span class="o">=</span> <span class="n">usecs</span> <span class="o">*</span> <span class="n">usec_tick_rate</span><span class="p">;</span>

	<span class="cm">/* Busy wait */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">delta_time</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">tmrHw_GetCurrentCount</span><span class="p">(</span><span class="n">timerId</span><span class="p">)</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
		<span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*  @brief   Local Divide function</span>
<span class="cm">*</span>
<span class="cm">*  This function does the divide</span>
<span class="cm">*</span>
<span class="cm">*  @return divide value</span>
<span class="cm">*</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tmrHw_divide</span><span class="p">(</span><span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">denom</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">t</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Shift denom and t up to the largest value to optimize algorithm */</span>
	<span class="cm">/* t contains the units of each divide */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">denom</span> <span class="o">&amp;</span> <span class="mh">0x40000000</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* fails if denom=0 */</span>
		<span class="n">denom</span> <span class="o">=</span> <span class="n">denom</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize the result */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* Determine if there exists a positive remainder */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">num</span> <span class="o">-</span> <span class="n">denom</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Accumlate t to the result and calculate a new remainder */</span>
			<span class="n">num</span> <span class="o">=</span> <span class="n">num</span> <span class="o">-</span> <span class="n">denom</span><span class="p">;</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">r</span> <span class="o">+</span> <span class="n">t</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Continue to shift denom and shift t down to 0 */</span>
		<span class="n">denom</span> <span class="o">=</span> <span class="n">denom</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">t</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
