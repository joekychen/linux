<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › mach-bcmring › dma.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>dma.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*****************************************************************************</span>
<span class="cm">* Copyright 2004 - 2008 Broadcom Corporation.  All rights reserved.</span>
<span class="cm">*</span>
<span class="cm">* Unless you and Broadcom execute a separate written software license</span>
<span class="cm">* agreement governing use of this software, this software is licensed to you</span>
<span class="cm">* under the terms of the GNU General Public License version 2, available at</span>
<span class="cm">* http://www.broadcom.com/licenses/GPLv2.php (the &quot;GPL&quot;).</span>
<span class="cm">*</span>
<span class="cm">* Notwithstanding the above, under no circumstances may you combine this</span>
<span class="cm">* software in any way with any other Broadcom software provided under a</span>
<span class="cm">* license other than the GPL, without Broadcom&#39;s express prior written</span>
<span class="cm">* consent.</span>
<span class="cm">*****************************************************************************/</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*   @file   dma.c</span>
<span class="cm">*</span>
<span class="cm">*   @brief  Implements the DMA interface.</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>

<span class="cm">/* ---- Include Files ---------------------------------------------------- */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/irqreturn.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;mach/timer.h&gt;</span>

<span class="cp">#include &lt;linux/pfn.h&gt;</span>
<span class="cp">#include &lt;linux/atomic.h&gt;</span>
<span class="cp">#include &lt;mach/dma.h&gt;</span>

<span class="cm">/* ---- Public Variables ------------------------------------------------- */</span>

<span class="cm">/* ---- Private Constants and Types -------------------------------------- */</span>

<span class="cp">#define MAKE_HANDLE(controllerIdx, channelIdx)    (((controllerIdx) &lt;&lt; 4) | (channelIdx))</span>

<span class="cp">#define CONTROLLER_FROM_HANDLE(handle)    (((handle) &gt;&gt; 4) &amp; 0x0f)</span>
<span class="cp">#define CHANNEL_FROM_HANDLE(handle)       ((handle) &amp; 0x0f)</span>


<span class="cm">/* ---- Private Variables ------------------------------------------------ */</span>

<span class="k">static</span> <span class="n">DMA_Global_t</span> <span class="n">gDMA</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">gDmaDir</span><span class="p">;</span>

<span class="cp">#include &quot;dma_device.c&quot;</span>

<span class="cm">/* ---- Private Function Prototypes -------------------------------------- */</span>

<span class="cm">/* ---- Functions  ------------------------------------------------------- */</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*   Displays information for /proc/dma/channels</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dma_proc_read_channels</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">start</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">offset</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">eof</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">controllerIdx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channelIdx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">limit</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">200</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">DMA_Channel_t</span> <span class="o">*</span><span class="n">channel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">down_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gDMA</span><span class="p">.</span><span class="n">lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">controllerIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">controllerIdx</span> <span class="o">&lt;</span> <span class="n">DMA_NUM_CONTROLLERS</span><span class="p">;</span>
	     <span class="n">controllerIdx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">channelIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">channelIdx</span> <span class="o">&lt;</span> <span class="n">DMA_NUM_CHANNELS</span><span class="p">;</span>
		     <span class="n">channelIdx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">limit</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">channel</span> <span class="o">=</span>
			    <span class="o">&amp;</span><span class="n">gDMA</span><span class="p">.</span><span class="n">controller</span><span class="p">[</span><span class="n">controllerIdx</span><span class="p">].</span><span class="n">channel</span><span class="p">[</span><span class="n">channelIdx</span><span class="p">];</span>

			<span class="n">len</span> <span class="o">+=</span>
			    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%d:%d &quot;</span><span class="p">,</span> <span class="n">controllerIdx</span><span class="p">,</span>
				    <span class="n">channelIdx</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_CHANNEL_FLAG_IS_DEDICATED</span><span class="p">)</span> <span class="o">!=</span>
			    <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">len</span> <span class="o">+=</span>
				    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;Dedicated for %s &quot;</span><span class="p">,</span>
					    <span class="n">DMA_gDeviceAttribute</span><span class="p">[</span><span class="n">channel</span><span class="o">-&gt;</span>
								 <span class="n">devType</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;Shared &quot;</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_CHANNEL_FLAG_NO_ISR</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;No ISR &quot;</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_CHANNEL_FLAG_LARGE_FIFO</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;Fifo: 128 &quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;Fifo: 64  &quot;</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_CHANNEL_FLAG_IN_USE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">len</span> <span class="o">+=</span>
				    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;InUse by %s&quot;</span><span class="p">,</span>
					    <span class="n">DMA_gDeviceAttribute</span><span class="p">[</span><span class="n">channel</span><span class="o">-&gt;</span>
								 <span class="n">devType</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#if (DMA_DEBUG_TRACK_RESERVATION)</span>
				<span class="n">len</span> <span class="o">+=</span>
				    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot; (%s:%d)&quot;</span><span class="p">,</span>
					    <span class="n">channel</span><span class="o">-&gt;</span><span class="n">fileName</span><span class="p">,</span>
					    <span class="n">channel</span><span class="o">-&gt;</span><span class="n">lineNum</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;Avail &quot;</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">lastDevType</span> <span class="o">!=</span> <span class="n">DMA_DEVICE_NONE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">len</span> <span class="o">+=</span>
				    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;Last use: %s &quot;</span><span class="p">,</span>
					    <span class="n">DMA_gDeviceAttribute</span><span class="p">[</span><span class="n">channel</span><span class="o">-&gt;</span>
								 <span class="n">lastDevType</span><span class="p">].</span>
					    <span class="n">name</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gDMA</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="o">*</span><span class="n">eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*   Displays information for /proc/dma/devices</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dma_proc_read_devices</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">start</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">offset</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">eof</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">limit</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">200</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">devIdx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">down_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gDMA</span><span class="p">.</span><span class="n">lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">devIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">devIdx</span> <span class="o">&lt;</span> <span class="n">DMA_NUM_DEVICE_ENTRIES</span><span class="p">;</span> <span class="n">devIdx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMA_DeviceAttribute_t</span> <span class="o">*</span><span class="n">devAttr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">DMA_gDeviceAttribute</span><span class="p">[</span><span class="n">devIdx</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">limit</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%-12s &quot;</span><span class="p">,</span> <span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_DEVICE_FLAG_IS_DEDICATED</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">+=</span>
			    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;Dedicated %d:%d &quot;</span><span class="p">,</span>
				    <span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">dedicatedController</span><span class="p">,</span>
				    <span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">dedicatedChannel</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;Shared DMA:&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_DEVICE_FLAG_ON_DMA0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;0&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_DEVICE_FLAG_ON_DMA1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;1&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_DEVICE_FLAG_NO_ISR</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;NoISR &quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_DEVICE_FLAG_ALLOW_LARGE_FIFO</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;Allow-128 &quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">len</span> <span class="o">+=</span>
		    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span>
			    <span class="s">&quot;Xfer #: %Lu Ticks: %Lu Bytes: %Lu DescLen: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">numTransfers</span><span class="p">,</span> <span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">transferTicks</span><span class="p">,</span>
			    <span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">transferBytes</span><span class="p">,</span>
			    <span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">bytesAllocated</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gDMA</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="o">*</span><span class="n">eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*   Determines if a DMA_Device_t is &quot;valid&quot;.</span>
<span class="cm">*</span>
<span class="cm">*   @return</span>
<span class="cm">*       TRUE        - dma device is valid</span>
<span class="cm">*       FALSE       - dma device isn&#39;t valid</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">IsDeviceValid</span><span class="p">(</span><span class="n">DMA_Device_t</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">device</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">device</span> <span class="o">&lt;</span> <span class="n">DMA_NUM_DEVICE_ENTRIES</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*   Translates a DMA handle into a pointer to a channel.</span>
<span class="cm">*</span>
<span class="cm">*   @return</span>
<span class="cm">*       non-NULL    - pointer to DMA_Channel_t</span>
<span class="cm">*       NULL        - DMA Handle was invalid</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">DMA_Channel_t</span> <span class="o">*</span><span class="nf">HandleToChannel</span><span class="p">(</span><span class="n">DMA_Handle_t</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">controllerIdx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channelIdx</span><span class="p">;</span>

	<span class="n">controllerIdx</span> <span class="o">=</span> <span class="n">CONTROLLER_FROM_HANDLE</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">channelIdx</span> <span class="o">=</span> <span class="n">CHANNEL_FROM_HANDLE</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">controllerIdx</span> <span class="o">&gt;</span> <span class="n">DMA_NUM_CONTROLLERS</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">channelIdx</span> <span class="o">&gt;</span> <span class="n">DMA_NUM_CHANNELS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">gDMA</span><span class="p">.</span><span class="n">controller</span><span class="p">[</span><span class="n">controllerIdx</span><span class="p">].</span><span class="n">channel</span><span class="p">[</span><span class="n">channelIdx</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*   Interrupt handler which is called to process DMA interrupts.</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">dma_interrupt_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DMA_Channel_t</span> <span class="o">*</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">DMA_DeviceAttribute_t</span> <span class="o">*</span><span class="n">devAttr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irqStatus</span><span class="p">;</span>

	<span class="n">channel</span> <span class="o">=</span> <span class="p">(</span><span class="n">DMA_Channel_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="cm">/* Figure out why we were called, and knock down the interrupt */</span>

	<span class="n">irqStatus</span> <span class="o">=</span> <span class="n">dmacHw_getInterruptStatus</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">dmacHwHandle</span><span class="p">);</span>
	<span class="n">dmacHw_clearInterrupt</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">dmacHwHandle</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">devType</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">devType</span> <span class="o">&gt;</span> <span class="n">DMA_NUM_DEVICE_ENTRIES</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dma_interrupt_handler: Invalid devType: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">channel</span><span class="o">-&gt;</span><span class="n">devType</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">devAttr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">DMA_gDeviceAttribute</span><span class="p">[</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">devType</span><span class="p">];</span>

	<span class="cm">/* Update stats */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">irqStatus</span> <span class="o">&amp;</span> <span class="n">dmacHw_INTERRUPT_STATUS_TRANS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">transferTicks</span> <span class="o">+=</span>
		    <span class="p">(</span><span class="n">timer_get_tick_count</span><span class="p">()</span> <span class="o">-</span> <span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">transferStartTime</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">irqStatus</span> <span class="o">&amp;</span> <span class="n">dmacHw_INTERRUPT_STATUS_ERROR</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;dma_interrupt_handler: devType :%d DMA error (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">channel</span><span class="o">-&gt;</span><span class="n">devType</span><span class="p">,</span> <span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">numTransfers</span><span class="o">++</span><span class="p">;</span>
		<span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">transferBytes</span> <span class="o">+=</span> <span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">numBytes</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Call any installed handler */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">devHandler</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">devHandler</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">devType</span><span class="p">,</span> <span class="n">irqStatus</span><span class="p">,</span>
				    <span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">userData</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*   Allocates memory to hold a descriptor ring. The descriptor ring then</span>
<span class="cm">*   needs to be populated by making one or more calls to</span>
<span class="cm">*   dna_add_descriptors.</span>
<span class="cm">*</span>
<span class="cm">*   The returned descriptor ring will be automatically initialized.</span>
<span class="cm">*</span>
<span class="cm">*   @return</span>
<span class="cm">*       0           Descriptor ring was allocated successfully</span>
<span class="cm">*       -EINVAL     Invalid parameters passed in</span>
<span class="cm">*       -ENOMEM     Unable to allocate memory for the desired number of descriptors.</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>

<span class="kt">int</span> <span class="nf">dma_alloc_descriptor_ring</span><span class="p">(</span><span class="n">DMA_DescriptorRing_t</span> <span class="o">*</span><span class="n">ring</span><span class="p">,</span>	<span class="cm">/* Descriptor ring to populate */</span>
			      <span class="kt">int</span> <span class="n">numDescriptors</span>	<span class="cm">/* Number of descriptors that need to be allocated. */</span>
    <span class="p">)</span> <span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">bytesToAlloc</span> <span class="o">=</span> <span class="n">dmacHw_descriptorLen</span><span class="p">(</span><span class="n">numDescriptors</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ring</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">numDescriptors</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">physAddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">descriptorsAllocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">bytesAllocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">virtAddr</span> <span class="o">=</span> <span class="n">dma_alloc_writecombine</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span>
						     <span class="n">bytesToAlloc</span><span class="p">,</span>
						     <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">physAddr</span><span class="p">,</span>
						     <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">virtAddr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">bytesAllocated</span> <span class="o">=</span> <span class="n">bytesToAlloc</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">descriptorsAllocated</span> <span class="o">=</span> <span class="n">numDescriptors</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">dma_init_descriptor_ring</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">numDescriptors</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dma_alloc_descriptor_ring</span><span class="p">);</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*   Releases the memory which was previously allocated for a descriptor ring.</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>

<span class="kt">void</span> <span class="nf">dma_free_descriptor_ring</span><span class="p">(</span><span class="n">DMA_DescriptorRing_t</span> <span class="o">*</span><span class="n">ring</span>	<span class="cm">/* Descriptor to release */</span>
    <span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">virtAddr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_writecombine</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span>
				      <span class="n">ring</span><span class="o">-&gt;</span><span class="n">bytesAllocated</span><span class="p">,</span>
				      <span class="n">ring</span><span class="o">-&gt;</span><span class="n">virtAddr</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">physAddr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">bytesAllocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">descriptorsAllocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">virtAddr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">physAddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dma_free_descriptor_ring</span><span class="p">);</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*   Initializes a descriptor ring, so that descriptors can be added to it.</span>
<span class="cm">*   Once a descriptor ring has been allocated, it may be reinitialized for</span>
<span class="cm">*   use with additional/different regions of memory.</span>
<span class="cm">*</span>
<span class="cm">*   Note that if 7 descriptors are allocated, it&#39;s perfectly acceptable to</span>
<span class="cm">*   initialize the ring with a smaller number of descriptors. The amount</span>
<span class="cm">*   of memory allocated for the descriptor ring will not be reduced, and</span>
<span class="cm">*   the descriptor ring may be reinitialized later</span>
<span class="cm">*</span>
<span class="cm">*   @return</span>
<span class="cm">*       0           Descriptor ring was initialized successfully</span>
<span class="cm">*       -ENOMEM     The descriptor which was passed in has insufficient space</span>
<span class="cm">*                   to hold the desired number of descriptors.</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>

<span class="kt">int</span> <span class="nf">dma_init_descriptor_ring</span><span class="p">(</span><span class="n">DMA_DescriptorRing_t</span> <span class="o">*</span><span class="n">ring</span><span class="p">,</span>	<span class="cm">/* Descriptor ring to initialize */</span>
			     <span class="kt">int</span> <span class="n">numDescriptors</span>	<span class="cm">/* Number of descriptors to initialize. */</span>
    <span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">virtAddr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmacHw_initDescriptor</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">virtAddr</span><span class="p">,</span>
				  <span class="n">ring</span><span class="o">-&gt;</span><span class="n">physAddr</span><span class="p">,</span>
				  <span class="n">ring</span><span class="o">-&gt;</span><span class="n">bytesAllocated</span><span class="p">,</span> <span class="n">numDescriptors</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;dma_init_descriptor_ring: dmacHw_initDescriptor failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dma_init_descriptor_ring</span><span class="p">);</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*   Determines the number of descriptors which would be required for a</span>
<span class="cm">*   transfer of the indicated memory region.</span>
<span class="cm">*</span>
<span class="cm">*   This function also needs to know which DMA device this transfer will</span>
<span class="cm">*   be destined for, so that the appropriate DMA configuration can be retrieved.</span>
<span class="cm">*   DMA parameters such as transfer width, and whether this is a memory-to-memory</span>
<span class="cm">*   or memory-to-peripheral, etc can all affect the actual number of descriptors</span>
<span class="cm">*   required.</span>
<span class="cm">*</span>
<span class="cm">*   @return</span>
<span class="cm">*       &gt; 0     Returns the number of descriptors required for the indicated transfer</span>
<span class="cm">*       -ENODEV - Device handed in is invalid.</span>
<span class="cm">*       -EINVAL Invalid parameters</span>
<span class="cm">*       -ENOMEM Memory exhausted</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>

<span class="kt">int</span> <span class="nf">dma_calculate_descriptor_count</span><span class="p">(</span><span class="n">DMA_Device_t</span> <span class="n">device</span><span class="p">,</span>	<span class="cm">/* DMA Device that this will be associated with */</span>
				   <span class="n">dma_addr_t</span> <span class="n">srcData</span><span class="p">,</span>	<span class="cm">/* Place to get data to write to device */</span>
				   <span class="n">dma_addr_t</span> <span class="n">dstData</span><span class="p">,</span>	<span class="cm">/* Pointer to device data address */</span>
				   <span class="kt">size_t</span> <span class="n">numBytes</span>	<span class="cm">/* Number of bytes to transfer to the device */</span>
    <span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">numDescriptors</span><span class="p">;</span>
	<span class="n">DMA_DeviceAttribute_t</span> <span class="o">*</span><span class="n">devAttr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IsDeviceValid</span><span class="p">(</span><span class="n">device</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">devAttr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">DMA_gDeviceAttribute</span><span class="p">[</span><span class="n">device</span><span class="p">];</span>

	<span class="n">numDescriptors</span> <span class="o">=</span> <span class="n">dmacHw_calculateDescriptorCount</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span>
							      <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">srcData</span><span class="p">,</span>
							      <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dstData</span><span class="p">,</span>
							      <span class="n">numBytes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">numDescriptors</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;dma_calculate_descriptor_count: dmacHw_calculateDescriptorCount failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">numDescriptors</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dma_calculate_descriptor_count</span><span class="p">);</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*   Adds a region of memory to the descriptor ring. Note that it may take</span>
<span class="cm">*   multiple descriptors for each region of memory. It is the callers</span>
<span class="cm">*   responsibility to allocate a sufficiently large descriptor ring.</span>
<span class="cm">*</span>
<span class="cm">*   @return</span>
<span class="cm">*       0       Descriptors were added successfully</span>
<span class="cm">*       -ENODEV Device handed in is invalid.</span>
<span class="cm">*       -EINVAL Invalid parameters</span>
<span class="cm">*       -ENOMEM Memory exhausted</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>

<span class="kt">int</span> <span class="nf">dma_add_descriptors</span><span class="p">(</span><span class="n">DMA_DescriptorRing_t</span> <span class="o">*</span><span class="n">ring</span><span class="p">,</span>	<span class="cm">/* Descriptor ring to add descriptors to */</span>
			<span class="n">DMA_Device_t</span> <span class="n">device</span><span class="p">,</span>	<span class="cm">/* DMA Device that descriptors are for */</span>
			<span class="n">dma_addr_t</span> <span class="n">srcData</span><span class="p">,</span>	<span class="cm">/* Place to get data (memory or device) */</span>
			<span class="n">dma_addr_t</span> <span class="n">dstData</span><span class="p">,</span>	<span class="cm">/* Place to put data (memory or device) */</span>
			<span class="kt">size_t</span> <span class="n">numBytes</span>	<span class="cm">/* Number of bytes to transfer to the device */</span>
    <span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">DMA_DeviceAttribute_t</span> <span class="o">*</span><span class="n">devAttr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IsDeviceValid</span><span class="p">(</span><span class="n">device</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">devAttr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">DMA_gDeviceAttribute</span><span class="p">[</span><span class="n">device</span><span class="p">];</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">dmacHw_setDataDescriptor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span>
				      <span class="n">ring</span><span class="o">-&gt;</span><span class="n">virtAddr</span><span class="p">,</span>
				      <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">srcData</span><span class="p">,</span>
				      <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dstData</span><span class="p">,</span> <span class="n">numBytes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;dma_add_descriptors: dmacHw_setDataDescriptor failed with code: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dma_add_descriptors</span><span class="p">);</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*   Sets the descriptor ring associated with a device.</span>
<span class="cm">*</span>
<span class="cm">*   Once set, the descriptor ring will be associated with the device, even</span>
<span class="cm">*   across channel request/free calls. Passing in a NULL descriptor ring</span>
<span class="cm">*   will release any descriptor ring currently associated with the device.</span>
<span class="cm">*</span>
<span class="cm">*   Note: If you call dma_transfer, or one of the other dma_alloc_ functions</span>
<span class="cm">*         the descriptor ring may be released and reallocated.</span>
<span class="cm">*</span>
<span class="cm">*   Note: This function will release the descriptor memory for any current</span>
<span class="cm">*         descriptor ring associated with this device.</span>
<span class="cm">*</span>
<span class="cm">*   @return</span>
<span class="cm">*       0       Descriptors were added successfully</span>
<span class="cm">*       -ENODEV Device handed in is invalid.</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>

<span class="kt">int</span> <span class="nf">dma_set_device_descriptor_ring</span><span class="p">(</span><span class="n">DMA_Device_t</span> <span class="n">device</span><span class="p">,</span>	<span class="cm">/* Device to update the descriptor ring for. */</span>
				   <span class="n">DMA_DescriptorRing_t</span> <span class="o">*</span><span class="n">ring</span>	<span class="cm">/* Descriptor ring to add descriptors to */</span>
    <span class="p">)</span> <span class="p">{</span>
	<span class="n">DMA_DeviceAttribute_t</span> <span class="o">*</span><span class="n">devAttr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IsDeviceValid</span><span class="p">(</span><span class="n">device</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">devAttr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">DMA_gDeviceAttribute</span><span class="p">[</span><span class="n">device</span><span class="p">];</span>

	<span class="cm">/* Free the previously allocated descriptor ring */</span>

	<span class="n">dma_free_descriptor_ring</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ring</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Copy in the new one */</span>

		<span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">ring</span> <span class="o">=</span> <span class="o">*</span><span class="n">ring</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set things up so that if dma_transfer is called then this descriptor */</span>
	<span class="cm">/* ring will get freed. */</span>

	<span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">prevSrcData</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">prevDstData</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">prevNumBytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dma_set_device_descriptor_ring</span><span class="p">);</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*   Retrieves the descriptor ring associated with a device.</span>
<span class="cm">*</span>
<span class="cm">*   @return</span>
<span class="cm">*       0       Descriptors were added successfully</span>
<span class="cm">*       -ENODEV Device handed in is invalid.</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>

<span class="kt">int</span> <span class="nf">dma_get_device_descriptor_ring</span><span class="p">(</span><span class="n">DMA_Device_t</span> <span class="n">device</span><span class="p">,</span>	<span class="cm">/* Device to retrieve the descriptor ring for. */</span>
				   <span class="n">DMA_DescriptorRing_t</span> <span class="o">*</span><span class="n">ring</span>	<span class="cm">/* Place to store retrieved ring */</span>
    <span class="p">)</span> <span class="p">{</span>
	<span class="n">DMA_DeviceAttribute_t</span> <span class="o">*</span><span class="n">devAttr</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ring</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IsDeviceValid</span><span class="p">(</span><span class="n">device</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">devAttr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">DMA_gDeviceAttribute</span><span class="p">[</span><span class="n">device</span><span class="p">];</span>

	<span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dma_get_device_descriptor_ring</span><span class="p">);</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*   Configures a DMA channel.</span>
<span class="cm">*</span>
<span class="cm">*   @return</span>
<span class="cm">*       &gt;= 0    - Initialization was successful.</span>
<span class="cm">*</span>
<span class="cm">*       -EBUSY  - Device is currently being used.</span>
<span class="cm">*       -ENODEV - Device handed in is invalid.</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ConfigChannel</span><span class="p">(</span><span class="n">DMA_Handle_t</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DMA_Channel_t</span> <span class="o">*</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">DMA_DeviceAttribute_t</span> <span class="o">*</span><span class="n">devAttr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">controllerIdx</span><span class="p">;</span>

	<span class="n">channel</span> <span class="o">=</span> <span class="n">HandleToChannel</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">devAttr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">DMA_gDeviceAttribute</span><span class="p">[</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">devType</span><span class="p">];</span>
	<span class="n">controllerIdx</span> <span class="o">=</span> <span class="n">CONTROLLER_FROM_HANDLE</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_DEVICE_FLAG_PORT_PER_DMAC</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">transferType</span> <span class="o">==</span>
		    <span class="n">dmacHw_TRANSFER_TYPE_MEM_TO_PERIPHERAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">dstPeripheralPort</span> <span class="o">=</span>
			    <span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">dmacPort</span><span class="p">[</span><span class="n">controllerIdx</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">transferType</span> <span class="o">==</span>
			   <span class="n">dmacHw_TRANSFER_TYPE_PERIPHERAL_TO_MEM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">srcPeripheralPort</span> <span class="o">=</span>
			    <span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">dmacPort</span><span class="p">[</span><span class="n">controllerIdx</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmacHw_configChannel</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">dmacHwHandle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ConfigChannel: dmacHw_configChannel failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*   Initializes all of the data structures associated with the DMA.</span>
<span class="cm">*   @return</span>
<span class="cm">*       &gt;= 0    - Initialization was successful.</span>
<span class="cm">*</span>
<span class="cm">*       -EBUSY  - Device is currently being used.</span>
<span class="cm">*       -ENODEV - Device handed in is invalid.</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>

<span class="kt">int</span> <span class="nf">dma_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">controllerIdx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channelIdx</span><span class="p">;</span>
	<span class="n">DMA_Device_t</span> <span class="n">devIdx</span><span class="p">;</span>
	<span class="n">DMA_Channel_t</span> <span class="o">*</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">DMA_Handle_t</span> <span class="n">dedicatedHandle</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gDMA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gDMA</span><span class="p">));</span>

	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gDMA</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gDMA</span><span class="p">.</span><span class="n">freeChannelQ</span><span class="p">);</span>

	<span class="cm">/* Initialize the Hardware */</span>

	<span class="n">dmacHw_initDma</span><span class="p">();</span>

	<span class="cm">/* Start off by marking all of the DMA channels as shared. */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">controllerIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">controllerIdx</span> <span class="o">&lt;</span> <span class="n">DMA_NUM_CONTROLLERS</span><span class="p">;</span>
	     <span class="n">controllerIdx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">channelIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">channelIdx</span> <span class="o">&lt;</span> <span class="n">DMA_NUM_CHANNELS</span><span class="p">;</span>
		     <span class="n">channelIdx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">channel</span> <span class="o">=</span>
			    <span class="o">&amp;</span><span class="n">gDMA</span><span class="p">.</span><span class="n">controller</span><span class="p">[</span><span class="n">controllerIdx</span><span class="p">].</span><span class="n">channel</span><span class="p">[</span><span class="n">channelIdx</span><span class="p">];</span>

			<span class="n">channel</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">channel</span><span class="o">-&gt;</span><span class="n">devType</span> <span class="o">=</span> <span class="n">DMA_DEVICE_NONE</span><span class="p">;</span>
			<span class="n">channel</span><span class="o">-&gt;</span><span class="n">lastDevType</span> <span class="o">=</span> <span class="n">DMA_DEVICE_NONE</span><span class="p">;</span>

<span class="cp">#if (DMA_DEBUG_TRACK_RESERVATION)</span>
			<span class="n">channel</span><span class="o">-&gt;</span><span class="n">fileName</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
			<span class="n">channel</span><span class="o">-&gt;</span><span class="n">lineNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

			<span class="n">channel</span><span class="o">-&gt;</span><span class="n">dmacHwHandle</span> <span class="o">=</span>
			    <span class="n">dmacHw_getChannelHandle</span><span class="p">(</span><span class="n">dmacHw_MAKE_CHANNEL_ID</span>
						    <span class="p">(</span><span class="n">controllerIdx</span><span class="p">,</span>
						     <span class="n">channelIdx</span><span class="p">));</span>
			<span class="n">dmacHw_initChannel</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">dmacHwHandle</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Record any special attributes that channels may have */</span>

	<span class="n">gDMA</span><span class="p">.</span><span class="n">controller</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">channel</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DMA_CHANNEL_FLAG_LARGE_FIFO</span><span class="p">;</span>
	<span class="n">gDMA</span><span class="p">.</span><span class="n">controller</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">channel</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DMA_CHANNEL_FLAG_LARGE_FIFO</span><span class="p">;</span>
	<span class="n">gDMA</span><span class="p">.</span><span class="n">controller</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">channel</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DMA_CHANNEL_FLAG_LARGE_FIFO</span><span class="p">;</span>
	<span class="n">gDMA</span><span class="p">.</span><span class="n">controller</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">channel</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DMA_CHANNEL_FLAG_LARGE_FIFO</span><span class="p">;</span>

	<span class="cm">/* Now walk through and record the dedicated channels. */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">devIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">devIdx</span> <span class="o">&lt;</span> <span class="n">DMA_NUM_DEVICE_ENTRIES</span><span class="p">;</span> <span class="n">devIdx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMA_DeviceAttribute_t</span> <span class="o">*</span><span class="n">devAttr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">DMA_gDeviceAttribute</span><span class="p">[</span><span class="n">devIdx</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(((</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_DEVICE_FLAG_NO_ISR</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_DEVICE_FLAG_IS_DEDICATED</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;DMA Device: %s Can only request NO_ISR for dedicated devices</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_DEVICE_FLAG_IS_DEDICATED</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This is a dedicated device. Mark the channel as being reserved. */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">dedicatedController</span> <span class="o">&gt;=</span> <span class="n">DMA_NUM_CONTROLLERS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				       <span class="s">&quot;DMA Device: %s DMA Controller %d is out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				       <span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">dedicatedController</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">dedicatedChannel</span> <span class="o">&gt;=</span> <span class="n">DMA_NUM_CHANNELS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				       <span class="s">&quot;DMA Device: %s DMA Channel %d is out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				       <span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">dedicatedChannel</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">dedicatedHandle</span> <span class="o">=</span>
			    <span class="n">MAKE_HANDLE</span><span class="p">(</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">dedicatedController</span><span class="p">,</span>
					<span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">dedicatedChannel</span><span class="p">);</span>
			<span class="n">channel</span> <span class="o">=</span> <span class="n">HandleToChannel</span><span class="p">(</span><span class="n">dedicatedHandle</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_CHANNEL_FLAG_IS_DEDICATED</span><span class="p">)</span> <span class="o">!=</span>
			    <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span>
				    <span class="p">(</span><span class="s">&quot;DMA Device: %s attempting to use same DMA Controller:Channel (%d:%d) as %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				     <span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">dedicatedController</span><span class="p">,</span>
				     <span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">dedicatedChannel</span><span class="p">,</span>
				     <span class="n">DMA_gDeviceAttribute</span><span class="p">[</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">devType</span><span class="p">].</span>
				     <span class="n">name</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">channel</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DMA_CHANNEL_FLAG_IS_DEDICATED</span><span class="p">;</span>
			<span class="n">channel</span><span class="o">-&gt;</span><span class="n">devType</span> <span class="o">=</span> <span class="n">devIdx</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_DEVICE_FLAG_NO_ISR</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">channel</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DMA_CHANNEL_FLAG_NO_ISR</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* For dedicated channels, we can go ahead and configure the DMA channel now */</span>
			<span class="cm">/* as well. */</span>

			<span class="n">ConfigChannel</span><span class="p">(</span><span class="n">dedicatedHandle</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Go through and register the interrupt handlers */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">controllerIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">controllerIdx</span> <span class="o">&lt;</span> <span class="n">DMA_NUM_CONTROLLERS</span><span class="p">;</span>
	     <span class="n">controllerIdx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">channelIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">channelIdx</span> <span class="o">&lt;</span> <span class="n">DMA_NUM_CHANNELS</span><span class="p">;</span>
		     <span class="n">channelIdx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">channel</span> <span class="o">=</span>
			    <span class="o">&amp;</span><span class="n">gDMA</span><span class="p">.</span><span class="n">controller</span><span class="p">[</span><span class="n">controllerIdx</span><span class="p">].</span><span class="n">channel</span><span class="p">[</span><span class="n">channelIdx</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_CHANNEL_FLAG_NO_ISR</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snprintf</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span>
					 <span class="s">&quot;dma %d:%d %s&quot;</span><span class="p">,</span> <span class="n">controllerIdx</span><span class="p">,</span>
					 <span class="n">channelIdx</span><span class="p">,</span>
					 <span class="n">channel</span><span class="o">-&gt;</span><span class="n">devType</span> <span class="o">==</span>
					 <span class="n">DMA_DEVICE_NONE</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span>
					 <span class="n">DMA_gDeviceAttribute</span><span class="p">[</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">devType</span><span class="p">].</span>
					 <span class="n">name</span><span class="p">);</span>

				<span class="n">rc</span> <span class="o">=</span>
				     <span class="n">request_irq</span><span class="p">(</span><span class="n">IRQ_DMA0C0</span> <span class="o">+</span>
						 <span class="p">(</span><span class="n">controllerIdx</span> <span class="o">*</span>
						  <span class="n">DMA_NUM_CHANNELS</span><span class="p">)</span> <span class="o">+</span>
						 <span class="n">channelIdx</span><span class="p">,</span>
						 <span class="n">dma_interrupt_handler</span><span class="p">,</span>
						 <span class="n">IRQF_DISABLED</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
						 <span class="n">channel</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
					       <span class="s">&quot;request_irq for IRQ_DMA%dC%d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">controllerIdx</span><span class="p">,</span> <span class="n">channelIdx</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Create /proc/dma/channels and /proc/dma/devices */</span>

	<span class="n">gDmaDir</span> <span class="o">=</span> <span class="n">proc_mkdir</span><span class="p">(</span><span class="s">&quot;dma&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gDmaDir</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Unable to create /proc/dma</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">create_proc_read_entry</span><span class="p">(</span><span class="s">&quot;channels&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gDmaDir</span><span class="p">,</span>
				       <span class="n">dma_proc_read_channels</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">create_proc_read_entry</span><span class="p">(</span><span class="s">&quot;devices&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gDmaDir</span><span class="p">,</span>
				       <span class="n">dma_proc_read_devices</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gDMA</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*   Reserves a channel for use with @a dev. If the device is setup to use</span>
<span class="cm">*   a shared channel, then this function will block until a free channel</span>
<span class="cm">*   becomes available.</span>
<span class="cm">*</span>
<span class="cm">*   @return</span>
<span class="cm">*       &gt;= 0    - A valid DMA Handle.</span>
<span class="cm">*       -EBUSY  - Device is currently being used.</span>
<span class="cm">*       -ENODEV - Device handed in is invalid.</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>

<span class="cp">#if (DMA_DEBUG_TRACK_RESERVATION)</span>
<span class="n">DMA_Handle_t</span> <span class="n">dma_request_channel_dbg</span>
    <span class="p">(</span><span class="n">DMA_Device_t</span> <span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fileName</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lineNum</span><span class="p">)</span>
<span class="cp">#else</span>
<span class="n">DMA_Handle_t</span> <span class="n">dma_request_channel</span><span class="p">(</span><span class="n">DMA_Device_t</span> <span class="n">dev</span><span class="p">)</span>
<span class="cp">#endif</span>
<span class="p">{</span>
	<span class="n">DMA_Handle_t</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">DMA_DeviceAttribute_t</span> <span class="o">*</span><span class="n">devAttr</span><span class="p">;</span>
	<span class="n">DMA_Channel_t</span> <span class="o">*</span><span class="n">channel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">controllerIdx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">controllerIdx2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channelIdx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">down_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gDMA</span><span class="p">.</span><span class="n">lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">DMA_NUM_DEVICE_ENTRIES</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">handle</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">devAttr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">DMA_gDeviceAttribute</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>

<span class="cp">#if (DMA_DEBUG_TRACK_RESERVATION)</span>
	<span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

		<span class="n">s</span> <span class="o">=</span> <span class="n">strrchr</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="sc">&#39;/&#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fileName</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_DEVICE_FLAG_IN_USE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This device has already been requested and not been freed */</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: device %s is already requested</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">handle</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_DEVICE_FLAG_IS_DEDICATED</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This device has a dedicated channel. */</span>

		<span class="n">channel</span> <span class="o">=</span>
		    <span class="o">&amp;</span><span class="n">gDMA</span><span class="p">.</span><span class="n">controller</span><span class="p">[</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">dedicatedController</span><span class="p">].</span>
		    <span class="n">channel</span><span class="p">[</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">dedicatedChannel</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_CHANNEL_FLAG_IN_USE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">handle</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DMA_CHANNEL_FLAG_IN_USE</span><span class="p">;</span>
		<span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DMA_DEVICE_FLAG_IN_USE</span><span class="p">;</span>

<span class="cp">#if (DMA_DEBUG_TRACK_RESERVATION)</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">fileName</span> <span class="o">=</span> <span class="n">fileName</span><span class="p">;</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">lineNum</span> <span class="o">=</span> <span class="n">lineNum</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">handle</span> <span class="o">=</span>
		    <span class="n">MAKE_HANDLE</span><span class="p">(</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">dedicatedController</span><span class="p">,</span>
				<span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">dedicatedChannel</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* This device needs to use one of the shared channels. */</span>

	<span class="n">handle</span> <span class="o">=</span> <span class="n">DMA_INVALID_HANDLE</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">handle</span> <span class="o">==</span> <span class="n">DMA_INVALID_HANDLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Scan through the shared channels and see if one is available */</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">controllerIdx2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">controllerIdx2</span> <span class="o">&lt;</span> <span class="n">DMA_NUM_CONTROLLERS</span><span class="p">;</span>
		     <span class="n">controllerIdx2</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Check to see if we should try on controller 1 first. */</span>

			<span class="n">controllerIdx</span> <span class="o">=</span> <span class="n">controllerIdx2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">devAttr</span><span class="o">-&gt;</span>
			     <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_DEVICE_FLAG_ALLOC_DMA1_FIRST</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">controllerIdx</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">controllerIdx</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* See if the device is available on the controller being tested */</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">devAttr</span><span class="o">-&gt;</span>
			     <span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DMA_DEVICE_FLAG_ON_DMA0</span> <span class="o">&lt;&lt;</span> <span class="n">controllerIdx</span><span class="p">))</span>
			    <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">channelIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				     <span class="n">channelIdx</span> <span class="o">&lt;</span> <span class="n">DMA_NUM_CHANNELS</span><span class="p">;</span>
				     <span class="n">channelIdx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">channel</span> <span class="o">=</span>
					    <span class="o">&amp;</span><span class="n">gDMA</span><span class="p">.</span><span class="n">controller</span><span class="p">[</span><span class="n">controllerIdx</span><span class="p">].</span>
					    <span class="n">channel</span><span class="p">[</span><span class="n">channelIdx</span><span class="p">];</span>

					<span class="k">if</span> <span class="p">(((</span><span class="n">channel</span><span class="o">-&gt;</span>
					      <span class="n">flags</span> <span class="o">&amp;</span>
					      <span class="n">DMA_CHANNEL_FLAG_IS_DEDICATED</span><span class="p">)</span> <span class="o">==</span>
					     <span class="mi">0</span><span class="p">)</span>
					    <span class="o">&amp;&amp;</span>
					    <span class="p">((</span><span class="n">channel</span><span class="o">-&gt;</span>
					      <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_CHANNEL_FLAG_IN_USE</span><span class="p">)</span>
					     <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(((</span><span class="n">channel</span><span class="o">-&gt;</span>
						      <span class="n">flags</span> <span class="o">&amp;</span>
						      <span class="n">DMA_CHANNEL_FLAG_LARGE_FIFO</span><span class="p">)</span>
						     <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
						    <span class="o">&amp;&amp;</span>
						    <span class="p">((</span><span class="n">devAttr</span><span class="o">-&gt;</span>
						      <span class="n">flags</span> <span class="o">&amp;</span>
						      <span class="n">DMA_DEVICE_FLAG_ALLOW_LARGE_FIFO</span><span class="p">)</span>
						     <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
							<span class="cm">/* This channel is a large fifo - don&#39;t tie it up */</span>
							<span class="cm">/* with devices that we don&#39;t want using it. */</span>

							<span class="k">continue</span><span class="p">;</span>
						<span class="p">}</span>

						<span class="n">channel</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span>
						    <span class="n">DMA_CHANNEL_FLAG_IN_USE</span><span class="p">;</span>
						<span class="n">channel</span><span class="o">-&gt;</span><span class="n">devType</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
						<span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span>
						    <span class="n">DMA_DEVICE_FLAG_IN_USE</span><span class="p">;</span>

<span class="cp">#if (DMA_DEBUG_TRACK_RESERVATION)</span>
						<span class="n">channel</span><span class="o">-&gt;</span><span class="n">fileName</span> <span class="o">=</span> <span class="n">fileName</span><span class="p">;</span>
						<span class="n">channel</span><span class="o">-&gt;</span><span class="n">lineNum</span> <span class="o">=</span> <span class="n">lineNum</span><span class="p">;</span>
<span class="cp">#endif</span>
						<span class="n">handle</span> <span class="o">=</span>
						    <span class="n">MAKE_HANDLE</span><span class="p">(</span><span class="n">controllerIdx</span><span class="p">,</span>
								<span class="n">channelIdx</span><span class="p">);</span>

						<span class="cm">/* Now that we&#39;ve reserved the channel - we can go ahead and configure it */</span>

						<span class="k">if</span> <span class="p">(</span><span class="n">ConfigChannel</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">handle</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
							<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
							       <span class="s">&quot;dma_request_channel: ConfigChannel failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="p">}</span>
						<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* No channels are currently available. Let&#39;s wait for one to free up. */</span>

		<span class="p">{</span>
			<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>

			<span class="n">prepare_to_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gDMA</span><span class="p">.</span><span class="n">freeChannelQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span>
					<span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gDMA</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">schedule</span><span class="p">();</span>
			<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gDMA</span><span class="p">.</span><span class="n">freeChannelQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* We don&#39;t currently hold gDMA.lock, so we return directly */</span>

				<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">down_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gDMA</span><span class="p">.</span><span class="n">lock</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gDMA</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">handle</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Create both _dbg and non _dbg functions for modules. */</span>

<span class="cp">#if (DMA_DEBUG_TRACK_RESERVATION)</span>
<span class="cp">#undef dma_request_channel</span>
<span class="n">DMA_Handle_t</span> <span class="n">dma_request_channel</span><span class="p">(</span><span class="n">DMA_Device_t</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dma_request_channel_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dma_request_channel_dbg</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dma_request_channel</span><span class="p">);</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*   Frees a previously allocated DMA Handle.</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>

<span class="kt">int</span> <span class="nf">dma_free_channel</span><span class="p">(</span><span class="n">DMA_Handle_t</span> <span class="n">handle</span>	<span class="cm">/* DMA handle. */</span>
    <span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">DMA_Channel_t</span> <span class="o">*</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">DMA_DeviceAttribute_t</span> <span class="o">*</span><span class="n">devAttr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">down_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gDMA</span><span class="p">.</span><span class="n">lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">channel</span> <span class="o">=</span> <span class="n">HandleToChannel</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">devAttr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">DMA_gDeviceAttribute</span><span class="p">[</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">devType</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_CHANNEL_FLAG_IS_DEDICATED</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">lastDevType</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">devType</span><span class="p">;</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">devType</span> <span class="o">=</span> <span class="n">DMA_DEVICE_NONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">channel</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMA_CHANNEL_FLAG_IN_USE</span><span class="p">;</span>
	<span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMA_DEVICE_FLAG_IN_USE</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gDMA</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gDMA</span><span class="p">.</span><span class="n">freeChannelQ</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dma_free_channel</span><span class="p">);</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*   Determines if a given device has been configured as using a shared</span>
<span class="cm">*   channel.</span>
<span class="cm">*</span>
<span class="cm">*   @return</span>
<span class="cm">*       0           Device uses a dedicated channel</span>
<span class="cm">*       &gt; zero      Device uses a shared channel</span>
<span class="cm">*       &lt; zero      Error code</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>

<span class="kt">int</span> <span class="nf">dma_device_is_channel_shared</span><span class="p">(</span><span class="n">DMA_Device_t</span> <span class="n">device</span>	<span class="cm">/* Device to check. */</span>
    <span class="p">)</span> <span class="p">{</span>
	<span class="n">DMA_DeviceAttribute_t</span> <span class="o">*</span><span class="n">devAttr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IsDeviceValid</span><span class="p">(</span><span class="n">device</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">devAttr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">DMA_gDeviceAttribute</span><span class="p">[</span><span class="n">device</span><span class="p">];</span>

	<span class="k">return</span> <span class="p">((</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_DEVICE_FLAG_IS_DEDICATED</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dma_device_is_channel_shared</span><span class="p">);</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*   Allocates buffers for the descriptors. This is normally done automatically</span>
<span class="cm">*   but needs to be done explicitly when initiating a dma from interrupt</span>
<span class="cm">*   context.</span>
<span class="cm">*</span>
<span class="cm">*   @return</span>
<span class="cm">*       0       Descriptors were allocated successfully</span>
<span class="cm">*       -EINVAL Invalid device type for this kind of transfer</span>
<span class="cm">*               (i.e. the device is _MEM_TO_DEV and not _DEV_TO_MEM)</span>
<span class="cm">*       -ENOMEM Memory exhausted</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>

<span class="kt">int</span> <span class="nf">dma_alloc_descriptors</span><span class="p">(</span><span class="n">DMA_Handle_t</span> <span class="n">handle</span><span class="p">,</span>	<span class="cm">/* DMA Handle */</span>
			  <span class="n">dmacHw_TRANSFER_TYPE_e</span> <span class="n">transferType</span><span class="p">,</span>	<span class="cm">/* Type of transfer being performed */</span>
			  <span class="n">dma_addr_t</span> <span class="n">srcData</span><span class="p">,</span>	<span class="cm">/* Place to get data to write to device */</span>
			  <span class="n">dma_addr_t</span> <span class="n">dstData</span><span class="p">,</span>	<span class="cm">/* Pointer to device data address */</span>
			  <span class="kt">size_t</span> <span class="n">numBytes</span>	<span class="cm">/* Number of bytes to transfer to the device */</span>
    <span class="p">)</span> <span class="p">{</span>
	<span class="n">DMA_Channel_t</span> <span class="o">*</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">DMA_DeviceAttribute_t</span> <span class="o">*</span><span class="n">devAttr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">numDescriptors</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">ringBytesRequired</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">channel</span> <span class="o">=</span> <span class="n">HandleToChannel</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">devAttr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">DMA_gDeviceAttribute</span><span class="p">[</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">devType</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">transferType</span> <span class="o">!=</span> <span class="n">transferType</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Figure out how many descriptors we need. */</span>

	<span class="cm">/* printk(&quot;srcData: 0x%08x dstData: 0x%08x, numBytes: %d\n&quot;, */</span>
	<span class="cm">/*        srcData, dstData, numBytes); */</span>

	<span class="n">numDescriptors</span> <span class="o">=</span> <span class="n">dmacHw_calculateDescriptorCount</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span>
							      <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">srcData</span><span class="p">,</span>
							      <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dstData</span><span class="p">,</span>
							      <span class="n">numBytes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">numDescriptors</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: dmacHw_calculateDescriptorCount failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check to see if we can reuse the existing descriptor ring, or if we need to allocate */</span>
	<span class="cm">/* a new one. */</span>

	<span class="n">ringBytesRequired</span> <span class="o">=</span> <span class="n">dmacHw_descriptorLen</span><span class="p">(</span><span class="n">numDescriptors</span><span class="p">);</span>

	<span class="cm">/* printk(&quot;ringBytesRequired: %d\n&quot;, ringBytesRequired); */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ringBytesRequired</span> <span class="o">&gt;</span> <span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">bytesAllocated</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Make sure that this code path is never taken from interrupt context. */</span>
		<span class="cm">/* It&#39;s OK for an interrupt to initiate a DMA transfer, but the descriptor */</span>
		<span class="cm">/* allocation needs to have already been done. */</span>

		<span class="n">might_sleep</span><span class="p">();</span>

		<span class="cm">/* Free the old descriptor ring and allocate a new one. */</span>

		<span class="n">dma_free_descriptor_ring</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">);</span>

		<span class="cm">/* And allocate a new one. */</span>

		<span class="n">rc</span> <span class="o">=</span>
		     <span class="n">dma_alloc_descriptor_ring</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">,</span>
					       <span class="n">numDescriptors</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;%s: dma_alloc_descriptor_ring(%d) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">numDescriptors</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Setup the descriptor for this transfer */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dmacHw_initDescriptor</span><span class="p">(</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">virtAddr</span><span class="p">,</span>
					  <span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">physAddr</span><span class="p">,</span>
					  <span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">bytesAllocated</span><span class="p">,</span>
					  <span class="n">numDescriptors</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: dmacHw_initDescriptor failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* We&#39;ve already got enough ring buffer allocated. All we need to do is reset */</span>
		<span class="cm">/* any control information, just in case the previous DMA was stopped. */</span>

		<span class="n">dmacHw_resetDescriptorControl</span><span class="p">(</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">virtAddr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* dma_alloc/free both set the prevSrc/DstData to 0. If they happen to be the same */</span>
	<span class="cm">/* as last time, then we don&#39;t need to call setDataDescriptor again. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmacHw_setDataDescriptor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span>
				     <span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">virtAddr</span><span class="p">,</span>
				     <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">srcData</span><span class="p">,</span>
				     <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dstData</span><span class="p">,</span> <span class="n">numBytes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: dmacHw_setDataDescriptor failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Remember the critical information for this transfer so that we can eliminate */</span>
	<span class="cm">/* another call to dma_alloc_descriptors if the caller reuses the same buffers */</span>

	<span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">prevSrcData</span> <span class="o">=</span> <span class="n">srcData</span><span class="p">;</span>
	<span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">prevDstData</span> <span class="o">=</span> <span class="n">dstData</span><span class="p">;</span>
	<span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">prevNumBytes</span> <span class="o">=</span> <span class="n">numBytes</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dma_alloc_descriptors</span><span class="p">);</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*   Allocates and sets up descriptors for a double buffered circular buffer.</span>
<span class="cm">*</span>
<span class="cm">*   This is primarily intended to be used for things like the ingress samples</span>
<span class="cm">*   from a microphone.</span>
<span class="cm">*</span>
<span class="cm">*   @return</span>
<span class="cm">*       &gt; 0     Number of descriptors actually allocated.</span>
<span class="cm">*       -EINVAL Invalid device type for this kind of transfer</span>
<span class="cm">*               (i.e. the device is _MEM_TO_DEV and not _DEV_TO_MEM)</span>
<span class="cm">*       -ENOMEM Memory exhausted</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>

<span class="kt">int</span> <span class="nf">dma_alloc_double_dst_descriptors</span><span class="p">(</span><span class="n">DMA_Handle_t</span> <span class="n">handle</span><span class="p">,</span>	<span class="cm">/* DMA Handle */</span>
				     <span class="n">dma_addr_t</span> <span class="n">srcData</span><span class="p">,</span>	<span class="cm">/* Physical address of source data */</span>
				     <span class="n">dma_addr_t</span> <span class="n">dstData1</span><span class="p">,</span>	<span class="cm">/* Physical address of first destination buffer */</span>
				     <span class="n">dma_addr_t</span> <span class="n">dstData2</span><span class="p">,</span>	<span class="cm">/* Physical address of second destination buffer */</span>
				     <span class="kt">size_t</span> <span class="n">numBytes</span>	<span class="cm">/* Number of bytes in each destination buffer */</span>
    <span class="p">)</span> <span class="p">{</span>
	<span class="n">DMA_Channel_t</span> <span class="o">*</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">DMA_DeviceAttribute_t</span> <span class="o">*</span><span class="n">devAttr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">numDst1Descriptors</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">numDst2Descriptors</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">numDescriptors</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">ringBytesRequired</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">channel</span> <span class="o">=</span> <span class="n">HandleToChannel</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">devAttr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">DMA_gDeviceAttribute</span><span class="p">[</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">devType</span><span class="p">];</span>

	<span class="cm">/* Figure out how many descriptors we need. */</span>

	<span class="cm">/* printk(&quot;srcData: 0x%08x dstData: 0x%08x, numBytes: %d\n&quot;, */</span>
	<span class="cm">/*        srcData, dstData, numBytes); */</span>

	<span class="n">numDst1Descriptors</span> <span class="o">=</span>
	     <span class="n">dmacHw_calculateDescriptorCount</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">srcData</span><span class="p">,</span>
					     <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dstData1</span><span class="p">,</span> <span class="n">numBytes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">numDst1Descriptors</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">numDst2Descriptors</span> <span class="o">=</span>
	     <span class="n">dmacHw_calculateDescriptorCount</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">srcData</span><span class="p">,</span>
					     <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dstData2</span><span class="p">,</span> <span class="n">numBytes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">numDst2Descriptors</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">numDescriptors</span> <span class="o">=</span> <span class="n">numDst1Descriptors</span> <span class="o">+</span> <span class="n">numDst2Descriptors</span><span class="p">;</span>
	<span class="cm">/* printk(&quot;numDescriptors: %d\n&quot;, numDescriptors); */</span>

	<span class="cm">/* Check to see if we can reuse the existing descriptor ring, or if we need to allocate */</span>
	<span class="cm">/* a new one. */</span>

	<span class="n">ringBytesRequired</span> <span class="o">=</span> <span class="n">dmacHw_descriptorLen</span><span class="p">(</span><span class="n">numDescriptors</span><span class="p">);</span>

	<span class="cm">/* printk(&quot;ringBytesRequired: %d\n&quot;, ringBytesRequired); */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ringBytesRequired</span> <span class="o">&gt;</span> <span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">bytesAllocated</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Make sure that this code path is never taken from interrupt context. */</span>
		<span class="cm">/* It&#39;s OK for an interrupt to initiate a DMA transfer, but the descriptor */</span>
		<span class="cm">/* allocation needs to have already been done. */</span>

		<span class="n">might_sleep</span><span class="p">();</span>

		<span class="cm">/* Free the old descriptor ring and allocate a new one. */</span>

		<span class="n">dma_free_descriptor_ring</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">);</span>

		<span class="cm">/* And allocate a new one. */</span>

		<span class="n">rc</span> <span class="o">=</span>
		     <span class="n">dma_alloc_descriptor_ring</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">,</span>
					       <span class="n">numDescriptors</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;%s: dma_alloc_descriptor_ring(%d) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">ringBytesRequired</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Setup the descriptor for this transfer. Since this function is used with */</span>
	<span class="cm">/* CONTINUOUS DMA operations, we need to reinitialize every time, otherwise */</span>
	<span class="cm">/* setDataDescriptor will keep trying to append onto the end. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmacHw_initDescriptor</span><span class="p">(</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">virtAddr</span><span class="p">,</span>
				  <span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">physAddr</span><span class="p">,</span>
				  <span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">bytesAllocated</span><span class="p">,</span>
				  <span class="n">numDescriptors</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: dmacHw_initDescriptor failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* dma_alloc/free both set the prevSrc/DstData to 0. If they happen to be the same */</span>
	<span class="cm">/* as last time, then we don&#39;t need to call setDataDescriptor again. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmacHw_setDataDescriptor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span>
				     <span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">virtAddr</span><span class="p">,</span>
				     <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">srcData</span><span class="p">,</span>
				     <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dstData1</span><span class="p">,</span> <span class="n">numBytes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: dmacHw_setDataDescriptor 1 failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmacHw_setDataDescriptor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span>
				     <span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">virtAddr</span><span class="p">,</span>
				     <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">srcData</span><span class="p">,</span>
				     <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dstData2</span><span class="p">,</span> <span class="n">numBytes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: dmacHw_setDataDescriptor 2 failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* You should use dma_start_transfer rather than dma_transfer_xxx so we don&#39;t */</span>
	<span class="cm">/* try to make the &#39;prev&#39; variables right. */</span>

	<span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">prevSrcData</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">prevDstData</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">prevNumBytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">numDescriptors</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dma_alloc_double_dst_descriptors</span><span class="p">);</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*   Initiates a transfer when the descriptors have already been setup.</span>
<span class="cm">*</span>
<span class="cm">*   This is a special case, and normally, the dma_transfer_xxx functions should</span>
<span class="cm">*   be used.</span>
<span class="cm">*</span>
<span class="cm">*   @return</span>
<span class="cm">*       0       Transfer was started successfully</span>
<span class="cm">*       -ENODEV Invalid handle</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>

<span class="kt">int</span> <span class="nf">dma_start_transfer</span><span class="p">(</span><span class="n">DMA_Handle_t</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DMA_Channel_t</span> <span class="o">*</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">DMA_DeviceAttribute_t</span> <span class="o">*</span><span class="n">devAttr</span><span class="p">;</span>

	<span class="n">channel</span> <span class="o">=</span> <span class="n">HandleToChannel</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">devAttr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">DMA_gDeviceAttribute</span><span class="p">[</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">devType</span><span class="p">];</span>

	<span class="n">dmacHw_initiateTransfer</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">dmacHwHandle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span>
				<span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">virtAddr</span><span class="p">);</span>

	<span class="cm">/* Since we got this far, everything went successfully */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dma_start_transfer</span><span class="p">);</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*   Stops a previously started DMA transfer.</span>
<span class="cm">*</span>
<span class="cm">*   @return</span>
<span class="cm">*       0       Transfer was stopped successfully</span>
<span class="cm">*       -ENODEV Invalid handle</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>

<span class="kt">int</span> <span class="nf">dma_stop_transfer</span><span class="p">(</span><span class="n">DMA_Handle_t</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DMA_Channel_t</span> <span class="o">*</span><span class="n">channel</span><span class="p">;</span>

	<span class="n">channel</span> <span class="o">=</span> <span class="n">HandleToChannel</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dmacHw_stopTransfer</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">dmacHwHandle</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dma_stop_transfer</span><span class="p">);</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*   Waits for a DMA to complete by polling. This function is only intended</span>
<span class="cm">*   to be used for testing. Interrupts should be used for most DMA operations.</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>

<span class="kt">int</span> <span class="nf">dma_wait_transfer_done</span><span class="p">(</span><span class="n">DMA_Handle_t</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DMA_Channel_t</span> <span class="o">*</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">dmacHw_TRANSFER_STATUS_e</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">channel</span> <span class="o">=</span> <span class="n">HandleToChannel</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span>
		<span class="n">dmacHw_transferCompleted</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">dmacHwHandle</span><span class="p">))</span> <span class="o">==</span>
	       <span class="n">dmacHw_TRANSFER_STATUS_BUSY</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">dmacHw_TRANSFER_STATUS_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: DMA transfer failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dma_wait_transfer_done</span><span class="p">);</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*   Initiates a DMA, allocating the descriptors as required.</span>
<span class="cm">*</span>
<span class="cm">*   @return</span>
<span class="cm">*       0       Transfer was started successfully</span>
<span class="cm">*       -EINVAL Invalid device type for this kind of transfer</span>
<span class="cm">*               (i.e. the device is _DEV_TO_MEM and not _MEM_TO_DEV)</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>

<span class="kt">int</span> <span class="nf">dma_transfer</span><span class="p">(</span><span class="n">DMA_Handle_t</span> <span class="n">handle</span><span class="p">,</span>	<span class="cm">/* DMA Handle */</span>
		 <span class="n">dmacHw_TRANSFER_TYPE_e</span> <span class="n">transferType</span><span class="p">,</span>	<span class="cm">/* Type of transfer being performed */</span>
		 <span class="n">dma_addr_t</span> <span class="n">srcData</span><span class="p">,</span>	<span class="cm">/* Place to get data to write to device */</span>
		 <span class="n">dma_addr_t</span> <span class="n">dstData</span><span class="p">,</span>	<span class="cm">/* Pointer to device data address */</span>
		 <span class="kt">size_t</span> <span class="n">numBytes</span>	<span class="cm">/* Number of bytes to transfer to the device */</span>
    <span class="p">)</span> <span class="p">{</span>
	<span class="n">DMA_Channel_t</span> <span class="o">*</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">DMA_DeviceAttribute_t</span> <span class="o">*</span><span class="n">devAttr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">channel</span> <span class="o">=</span> <span class="n">HandleToChannel</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">devAttr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">DMA_gDeviceAttribute</span><span class="p">[</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">devType</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">transferType</span> <span class="o">!=</span> <span class="n">transferType</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We keep track of the information about the previous request for this */</span>
	<span class="cm">/* device, and if the attributes match, then we can use the descriptors we setup */</span>
	<span class="cm">/* the last time, and not have to reinitialize everything. */</span>

	<span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span>
		     <span class="n">dma_alloc_descriptors</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">transferType</span><span class="p">,</span> <span class="n">srcData</span><span class="p">,</span>
					   <span class="n">dstData</span><span class="p">,</span> <span class="n">numBytes</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* And kick off the transfer */</span>

	<span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">numBytes</span> <span class="o">=</span> <span class="n">numBytes</span><span class="p">;</span>
	<span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">transferStartTime</span> <span class="o">=</span> <span class="n">timer_get_tick_count</span><span class="p">();</span>

	<span class="n">dmacHw_initiateTransfer</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">dmacHwHandle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span>
				<span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">virtAddr</span><span class="p">);</span>

	<span class="cm">/* Since we got this far, everything went successfully */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dma_transfer</span><span class="p">);</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/**</span>
<span class="cm">*   Set the callback function which will be called when a transfer completes.</span>
<span class="cm">*   If a NULL callback function is set, then no callback will occur.</span>
<span class="cm">*</span>
<span class="cm">*   @note   @a devHandler will be called from IRQ context.</span>
<span class="cm">*</span>
<span class="cm">*   @return</span>
<span class="cm">*       0       - Success</span>
<span class="cm">*       -ENODEV - Device handed in is invalid.</span>
<span class="cm">*/</span>
<span class="cm">/****************************************************************************/</span>

<span class="kt">int</span> <span class="nf">dma_set_device_handler</span><span class="p">(</span><span class="n">DMA_Device_t</span> <span class="n">dev</span><span class="p">,</span>	<span class="cm">/* Device to set the callback for. */</span>
			   <span class="n">DMA_DeviceHandler_t</span> <span class="n">devHandler</span><span class="p">,</span>	<span class="cm">/* Function to call when the DMA completes */</span>
			   <span class="kt">void</span> <span class="o">*</span><span class="n">userData</span>	<span class="cm">/* Pointer which will be passed to devHandler. */</span>
    <span class="p">)</span> <span class="p">{</span>
	<span class="n">DMA_DeviceAttribute_t</span> <span class="o">*</span><span class="n">devAttr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IsDeviceValid</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">devAttr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">DMA_gDeviceAttribute</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">userData</span> <span class="o">=</span> <span class="n">userData</span><span class="p">;</span>
	<span class="n">devAttr</span><span class="o">-&gt;</span><span class="n">devHandler</span> <span class="o">=</span> <span class="n">devHandler</span><span class="p">;</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dma_set_device_handler</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
