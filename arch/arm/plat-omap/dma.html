<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › plat-omap › dma.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>dma.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/arch/arm/plat-omap/dma.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2003 - 2008 Nokia Corporation</span>
<span class="cm"> * Author: Juha Yrjölä &lt;juha.yrjola@nokia.com&gt;</span>
<span class="cm"> * DMA channel linking for 1610 by Samuel Ortiz &lt;samuel.ortiz@nokia.com&gt;</span>
<span class="cm"> * Graphics DMA and LCD DMA graphics tranformations</span>
<span class="cm"> * by Imre Deak &lt;imre.deak@nokia.com&gt;</span>
<span class="cm"> * OMAP2/3 support Copyright (C) 2004-2007 Texas Instruments, Inc.</span>
<span class="cm"> * Merged to support both OMAP1 and OMAP2 by Tony Lindgren &lt;tony@atomide.com&gt;</span>
<span class="cm"> * Some functions based on earlier dma-omap.c Copyright (C) 2001 RidgeRun, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2009 Texas Instruments</span>
<span class="cm"> * Added OMAP4 support - Santosh Shilimkar &lt;santosh.shilimkar@ti.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Support functions for the OMAP internal DMA channels.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2010 Texas Instruments Incorporated - http://www.ti.com/</span>
<span class="cm"> * Converted DMA library into DMA platform driver.</span>
<span class="cm"> *	- G, Manjunath Kondaiah &lt;manjugk@ti.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>

<span class="cp">#include &lt;mach/hardware.h&gt;</span>
<span class="cp">#include &lt;plat/dma.h&gt;</span>

<span class="cp">#include &lt;plat/tc.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * MAX_LOGICAL_DMA_CH_COUNT: the maximum number of logical DMA</span>
<span class="cm"> * channels that an instance of the SDMA IP block can support.  Used</span>
<span class="cm"> * to size arrays.  (The actual maximum on a particular SoC may be less</span>
<span class="cm"> * than this -- for example, OMAP1 SDMA instances only support 17 logical</span>
<span class="cm"> * DMA channels.)</span>
<span class="cm"> */</span>
<span class="cp">#define MAX_LOGICAL_DMA_CH_COUNT		32</span>

<span class="cp">#undef DEBUG</span>

<span class="cp">#ifndef CONFIG_ARCH_OMAP1</span>
<span class="k">enum</span> <span class="p">{</span> <span class="n">DMA_CH_ALLOC_DONE</span><span class="p">,</span> <span class="n">DMA_CH_PARAMS_SET_DONE</span><span class="p">,</span> <span class="n">DMA_CH_STARTED</span><span class="p">,</span>
	<span class="n">DMA_CH_QUEUED</span><span class="p">,</span> <span class="n">DMA_CH_NOTSTARTED</span><span class="p">,</span> <span class="n">DMA_CH_PAUSED</span><span class="p">,</span> <span class="n">DMA_CH_LINK_ENABLED</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span> <span class="n">DMA_CHAIN_STARTED</span><span class="p">,</span> <span class="n">DMA_CHAIN_NOTSTARTED</span> <span class="p">};</span>
<span class="cp">#endif</span>

<span class="cp">#define OMAP_DMA_ACTIVE			0x01</span>
<span class="cp">#define OMAP2_DMA_CSR_CLEAR_MASK	0xffffffff</span>

<span class="cp">#define OMAP_FUNC_MUX_ARM_BASE		(0xfffe1000 + 0xec)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">omap_system_dma_plat_info</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">omap_dma_dev_attr</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">enable_1510_mode</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">errata</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">omap_dma_global_context_registers</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">dma_irqenable_l0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dma_ocp_sysconfig</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dma_gcr</span><span class="p">;</span>
<span class="p">}</span> <span class="n">omap_dma_global_context</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">dma_link_info</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">linked_dmach_q</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">no_of_lchs_linked</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">q_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">q_tail</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">q_head</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">chain_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chain_mode</span><span class="p">;</span>

<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_link_info</span> <span class="o">*</span><span class="n">dma_linked_lch</span><span class="p">;</span>

<span class="cp">#ifndef CONFIG_ARCH_OMAP1</span>

<span class="cm">/* Chain handling macros */</span>
<span class="cp">#define OMAP_DMA_CHAIN_QINIT(chain_id)					\</span>
<span class="cp">	do {								\</span>
<span class="cp">		dma_linked_lch[chain_id].q_head =			\</span>
<span class="cp">		dma_linked_lch[chain_id].q_tail =			\</span>
<span class="cp">		dma_linked_lch[chain_id].q_count = 0;			\</span>
<span class="cp">	} while (0)</span>
<span class="cp">#define OMAP_DMA_CHAIN_QFULL(chain_id)					\</span>
<span class="cp">		(dma_linked_lch[chain_id].no_of_lchs_linked ==		\</span>
<span class="cp">		dma_linked_lch[chain_id].q_count)</span>
<span class="cp">#define OMAP_DMA_CHAIN_QLAST(chain_id)					\</span>
<span class="cp">	do {								\</span>
<span class="cp">		((dma_linked_lch[chain_id].no_of_lchs_linked-1) ==	\</span>
<span class="cp">		dma_linked_lch[chain_id].q_count)			\</span>
<span class="cp">	} while (0)</span>
<span class="cp">#define OMAP_DMA_CHAIN_QEMPTY(chain_id)					\</span>
<span class="cp">		(0 == dma_linked_lch[chain_id].q_count)</span>
<span class="cp">#define __OMAP_DMA_CHAIN_INCQ(end)					\</span>
<span class="cp">	((end) = ((end)+1) % dma_linked_lch[chain_id].no_of_lchs_linked)</span>
<span class="cp">#define OMAP_DMA_CHAIN_INCQHEAD(chain_id)				\</span>
<span class="cp">	do {								\</span>
<span class="cp">		__OMAP_DMA_CHAIN_INCQ(dma_linked_lch[chain_id].q_head);	\</span>
<span class="cp">		dma_linked_lch[chain_id].q_count--;			\</span>
<span class="cp">	} while (0)</span>

<span class="cp">#define OMAP_DMA_CHAIN_INCQTAIL(chain_id)				\</span>
<span class="cp">	do {								\</span>
<span class="cp">		__OMAP_DMA_CHAIN_INCQ(dma_linked_lch[chain_id].q_tail);	\</span>
<span class="cp">		dma_linked_lch[chain_id].q_count++; \</span>
<span class="cp">	} while (0)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">dma_lch_count</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dma_chan_count</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">omap_dma_reserve_channels</span><span class="p">;</span>

<span class="k">static</span> <span class="n">spinlock_t</span> <span class="n">dma_chan_lock</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">omap_dma_lch</span> <span class="o">*</span><span class="n">dma_chan</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">disable_lnk</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">omap_disable_channel_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">omap_enable_channel_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">);</span>

<span class="cp">#define REVISIT_24XX()		printk(KERN_ERR &quot;FIXME: no %s on 24xx\n&quot;, \</span>
<span class="cp">						__func__);</span>

<span class="cp">#ifdef CONFIG_ARCH_OMAP15XX</span>
<span class="cm">/* Returns 1 if the DMA module is in OMAP1510-compatible mode, 0 otherwise */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_dma_in_1510_mode</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">enable_1510_mode</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define omap_dma_in_1510_mode()		0</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_ARCH_OMAP1</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">get_gdma_dev</span><span class="p">(</span><span class="kt">int</span> <span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">OMAP_FUNC_MUX_ARM_BASE</span> <span class="o">+</span> <span class="p">((</span><span class="n">req</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="p">((</span><span class="n">req</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">6</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">((</span><span class="n">omap_readl</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_gdma_dev</span><span class="p">(</span><span class="kt">int</span> <span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">OMAP_FUNC_MUX_ARM_BASE</span> <span class="o">+</span> <span class="p">((</span><span class="n">req</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="p">((</span><span class="n">req</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">omap_readl</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x3f</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="p">(</span><span class="n">dev</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>
	<span class="n">omap_writel</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define set_gdma_dev(req, dev)	do {} while (0)</span>
<span class="cp">#define omap_readl(reg)		0</span>
<span class="cp">#define omap_writel(val, reg)	do {} while (0)</span>
<span class="cp">#endif</span>

<span class="kt">void</span> <span class="nf">omap_set_dma_priority</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dst_port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">priority</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap1</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dst_port</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OMAP_DMA_PORT_OCP_T1</span>:	<span class="cm">/* FFFECC00 */</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">OMAP_TC_OCPT1_PRIOR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DMA_PORT_OCP_T2</span>:	<span class="cm">/* FFFECCD0 */</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">OMAP_TC_OCPT2_PRIOR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DMA_PORT_EMIFF</span>:	<span class="cm">/* FFFECC08 */</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">OMAP_TC_EMIFF_PRIOR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DMA_PORT_EMIFS</span>:	<span class="cm">/* FFFECC04 */</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">OMAP_TC_EMIFS_PRIOR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">BUG</span><span class="p">();</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">omap_readl</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xf</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">l</span> <span class="o">|=</span> <span class="p">(</span><span class="n">priority</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">omap_writel</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap2</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">ccr</span><span class="p">;</span>

		<span class="n">ccr</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CCR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priority</span><span class="p">)</span>
			<span class="n">ccr</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ccr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">ccr</span><span class="p">,</span> <span class="n">CCR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_set_dma_priority</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">omap_set_dma_transfer_params</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data_type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">elem_count</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">frame_count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sync_mode</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">dma_trigger</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src_or_dst_synch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CSDP</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">;</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">data_type</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">CSDP</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap1</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">ccr</span><span class="p">;</span>

		<span class="n">ccr</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CCR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
		<span class="n">ccr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sync_mode</span> <span class="o">==</span> <span class="n">OMAP_DMA_SYNC_FRAME</span><span class="p">)</span>
			<span class="n">ccr</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">ccr</span><span class="p">,</span> <span class="n">CCR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>

		<span class="n">ccr</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CCR2</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
		<span class="n">ccr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sync_mode</span> <span class="o">==</span> <span class="n">OMAP_DMA_SYNC_BLOCK</span><span class="p">)</span>
			<span class="n">ccr</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">ccr</span><span class="p">,</span> <span class="n">CCR2</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap2</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">dma_trigger</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CCR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>

		<span class="cm">/* DMA_SYNCHRO_CONTROL_UPPER depends on the channel number */</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x1f</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">dma_trigger</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">dma_trigger</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sync_mode</span> <span class="o">&amp;</span> <span class="n">OMAP_DMA_SYNC_FRAME</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sync_mode</span> <span class="o">&amp;</span> <span class="n">OMAP_DMA_SYNC_BLOCK</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">src_or_dst_synch</span> <span class="o">==</span> <span class="n">OMAP_DMA_DST_SYNC_PREFETCH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>	<span class="cm">/* dest synch */</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">);</span>	<span class="cm">/* Prefetch */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">src_or_dst_synch</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>		<span class="cm">/* source synch */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>	<span class="cm">/* dest synch */</span>
		<span class="p">}</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">CCR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">elem_count</span><span class="p">,</span> <span class="n">CEN</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">frame_count</span><span class="p">,</span> <span class="n">CFN</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_set_dma_transfer_params</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">omap_set_dma_color_mode</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">,</span> <span class="k">enum</span> <span class="n">omap_dma_color_mode</span> <span class="n">mode</span><span class="p">,</span> <span class="n">u32</span> <span class="n">color</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">omap_dma_in_1510_mode</span><span class="p">());</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap1</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">w</span><span class="p">;</span>

		<span class="n">w</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CCR2</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
		<span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OMAP_DMA_CONSTANT_FILL</span>:
			<span class="n">w</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DMA_TRANSPARENT_COPY</span>:
			<span class="n">w</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DMA_COLOR_DIS</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">CCR2</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>

		<span class="n">w</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">LCH_CTRL</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
		<span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x0f</span><span class="p">;</span>
		<span class="cm">/* Default is channel type 2D */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">COLOR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
			<span class="n">w</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* Channel type G */</span>
		<span class="p">}</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">LCH_CTRL</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap2</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CCR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OMAP_DMA_CONSTANT_FILL</span>:
			<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DMA_TRANSPARENT_COPY</span>:
			<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OMAP_DMA_COLOR_DIS</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">CCR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>

		<span class="n">color</span> <span class="o">&amp;=</span> <span class="mh">0xffffff</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">COLOR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_set_dma_color_mode</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">omap_set_dma_write_mode</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">,</span> <span class="k">enum</span> <span class="n">omap_dma_write_mode</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap2</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">csdp</span><span class="p">;</span>

		<span class="n">csdp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CSDP</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
		<span class="n">csdp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x3</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">csdp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">csdp</span><span class="p">,</span> <span class="n">CSDP</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_set_dma_write_mode</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">omap_set_dma_channel_mode</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">,</span> <span class="k">enum</span> <span class="n">omap_dma_channel_mode</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap1</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cpu_is_omap15xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

		<span class="n">l</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">LCH_CTRL</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
		<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x7</span><span class="p">;</span>
		<span class="n">l</span> <span class="o">|=</span> <span class="n">mode</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">LCH_CTRL</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_set_dma_channel_mode</span><span class="p">);</span>

<span class="cm">/* Note that src_port is only for omap1 */</span>
<span class="kt">void</span> <span class="nf">omap_set_dma_src_params</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src_port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src_amode</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">src_start</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">src_ei</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src_fi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap1</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">w</span><span class="p">;</span>

		<span class="n">w</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CSDP</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
		<span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1f</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">w</span> <span class="o">|=</span> <span class="n">src_port</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">CSDP</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CCR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x03</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">src_amode</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">CCR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">src_start</span><span class="p">,</span> <span class="n">CSSA</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">src_ei</span><span class="p">,</span> <span class="n">CSEI</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">src_fi</span><span class="p">,</span> <span class="n">CSFI</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_set_dma_src_params</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">omap_set_dma_params</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">omap_dma_channel_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">omap_set_dma_transfer_params</span><span class="p">(</span><span class="n">lch</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">data_type</span><span class="p">,</span>
				     <span class="n">params</span><span class="o">-&gt;</span><span class="n">elem_count</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">frame_count</span><span class="p">,</span>
				     <span class="n">params</span><span class="o">-&gt;</span><span class="n">sync_mode</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">trigger</span><span class="p">,</span>
				     <span class="n">params</span><span class="o">-&gt;</span><span class="n">src_or_dst_synch</span><span class="p">);</span>
	<span class="n">omap_set_dma_src_params</span><span class="p">(</span><span class="n">lch</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">src_port</span><span class="p">,</span>
				<span class="n">params</span><span class="o">-&gt;</span><span class="n">src_amode</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">src_start</span><span class="p">,</span>
				<span class="n">params</span><span class="o">-&gt;</span><span class="n">src_ei</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">src_fi</span><span class="p">);</span>

	<span class="n">omap_set_dma_dest_params</span><span class="p">(</span><span class="n">lch</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">dst_port</span><span class="p">,</span>
				 <span class="n">params</span><span class="o">-&gt;</span><span class="n">dst_amode</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">dst_start</span><span class="p">,</span>
				 <span class="n">params</span><span class="o">-&gt;</span><span class="n">dst_ei</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">dst_fi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">read_prio</span> <span class="o">||</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">write_prio</span><span class="p">)</span>
		<span class="n">omap_dma_set_prio_lch</span><span class="p">(</span><span class="n">lch</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">read_prio</span><span class="p">,</span>
				      <span class="n">params</span><span class="o">-&gt;</span><span class="n">write_prio</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_set_dma_params</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">omap_set_dma_src_index</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">eidx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fidx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap2</span><span class="p">())</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">eidx</span><span class="p">,</span> <span class="n">CSEI</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">fidx</span><span class="p">,</span> <span class="n">CSFI</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_set_dma_src_index</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">omap_set_dma_src_data_pack</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CSDP</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">l</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">CSDP</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_set_dma_src_data_pack</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">omap_set_dma_src_burst_mode</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">,</span> <span class="k">enum</span> <span class="n">omap_dma_burst_mode</span> <span class="n">burst_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">burst</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CSDP</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x03</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">burst_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OMAP_DMA_DATA_BURST_DIS</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_DMA_DATA_BURST_4</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap2</span><span class="p">())</span>
			<span class="n">burst</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">burst</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_DMA_DATA_BURST_8</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap2</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">burst</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * not supported by current hardware on OMAP1</span>
<span class="cm">		 * w |= (0x03 &lt;&lt; 7);</span>
<span class="cm">		 * fall through</span>
<span class="cm">		 */</span>
	<span class="k">case</span> <span class="n">OMAP_DMA_DATA_BURST_16</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap2</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">burst</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * OMAP1 don&#39;t support burst 16</span>
<span class="cm">		 * fall through</span>
<span class="cm">		 */</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">l</span> <span class="o">|=</span> <span class="p">(</span><span class="n">burst</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">CSDP</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_set_dma_src_burst_mode</span><span class="p">);</span>

<span class="cm">/* Note that dest_port is only for OMAP1 */</span>
<span class="kt">void</span> <span class="nf">omap_set_dma_dest_params</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dest_port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dest_amode</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dest_start</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">dst_ei</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dst_fi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap1</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CSDP</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
		<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1f</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>
		<span class="n">l</span> <span class="o">|=</span> <span class="n">dest_port</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">CSDP</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CCR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x03</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">dest_amode</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">CCR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">dest_start</span><span class="p">,</span> <span class="n">CDSA</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">dst_ei</span><span class="p">,</span> <span class="n">CDEI</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">dst_fi</span><span class="p">,</span> <span class="n">CDFI</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_set_dma_dest_params</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">omap_set_dma_dest_index</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">eidx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fidx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap2</span><span class="p">())</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">eidx</span><span class="p">,</span> <span class="n">CDEI</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">fidx</span><span class="p">,</span> <span class="n">CDFI</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_set_dma_dest_index</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">omap_set_dma_dest_data_pack</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CSDP</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">l</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">CSDP</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_set_dma_dest_data_pack</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">omap_set_dma_dest_burst_mode</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">,</span> <span class="k">enum</span> <span class="n">omap_dma_burst_mode</span> <span class="n">burst_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">burst</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CSDP</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x03</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">burst_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OMAP_DMA_DATA_BURST_DIS</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_DMA_DATA_BURST_4</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap2</span><span class="p">())</span>
			<span class="n">burst</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">burst</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_DMA_DATA_BURST_8</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap2</span><span class="p">())</span>
			<span class="n">burst</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">burst</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OMAP_DMA_DATA_BURST_16</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap2</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">burst</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * OMAP1 don&#39;t support burst 16</span>
<span class="cm">		 * fall through</span>
<span class="cm">		 */</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Invalid DMA burst mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="p">(</span><span class="n">burst</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">CSDP</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_set_dma_dest_burst_mode</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">omap_enable_channel_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* Clear CSR */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap1</span><span class="p">())</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CSR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap2</span><span class="p">())</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">OMAP2_DMA_CSR_CLEAR_MASK</span><span class="p">,</span> <span class="n">CSR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>

	<span class="cm">/* Enable some nice interrupts. */</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">dma_chan</span><span class="p">[</span><span class="n">lch</span><span class="p">].</span><span class="n">enabled_irqs</span><span class="p">,</span> <span class="n">CICR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_disable_channel_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap2</span><span class="p">())</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">CICR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">omap_enable_dma_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">,</span> <span class="n">u16</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_chan</span><span class="p">[</span><span class="n">lch</span><span class="p">].</span><span class="n">enabled_irqs</span> <span class="o">|=</span> <span class="n">bits</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_enable_dma_irq</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">omap_disable_dma_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">,</span> <span class="n">u16</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_chan</span><span class="p">[</span><span class="n">lch</span><span class="p">].</span><span class="n">enabled_irqs</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">bits</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_disable_dma_irq</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">enable_lnk</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CLNK_CTRL</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap1</span><span class="p">())</span>
		<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">);</span>

	<span class="cm">/* Set the ENABLE_LNK bits */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_chan</span><span class="p">[</span><span class="n">lch</span><span class="p">].</span><span class="n">next_lch</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">dma_chan</span><span class="p">[</span><span class="n">lch</span><span class="p">].</span><span class="n">next_lch</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>

<span class="cp">#ifndef CONFIG_ARCH_OMAP1</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap2</span><span class="p">())</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_chan</span><span class="p">[</span><span class="n">lch</span><span class="p">].</span><span class="n">next_linked_ch</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">l</span> <span class="o">=</span> <span class="n">dma_chan</span><span class="p">[</span><span class="n">lch</span><span class="p">].</span><span class="n">next_linked_ch</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">CLNK_CTRL</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">disable_lnk</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CLNK_CTRL</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>

	<span class="cm">/* Disable interrupts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap1</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">CICR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
		<span class="cm">/* Set the STOP_LNK bit */</span>
		<span class="n">l</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap2</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">omap_disable_channel_irq</span><span class="p">(</span><span class="n">lch</span><span class="p">);</span>
		<span class="cm">/* Clear the ENABLE_LNK bit */</span>
		<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">CLNK_CTRL</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="n">dma_chan</span><span class="p">[</span><span class="n">lch</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OMAP_DMA_ACTIVE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">omap2_enable_irq_lch</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_class_is_omap2</span><span class="p">())</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_chan_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">IRQENABLE_L0</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">lch</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">IRQENABLE_L0</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_chan_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">omap2_disable_irq_lch</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_class_is_omap2</span><span class="p">())</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_chan_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">IRQENABLE_L0</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">lch</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">IRQENABLE_L0</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_chan_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">omap_request_dma</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev_id</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">,</span>
		     <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">,</span> <span class="n">u16</span> <span class="n">ch_status</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">),</span>
		     <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">dma_ch_out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ch</span><span class="p">,</span> <span class="n">free_ch</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_dma_lch</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_chan_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="n">dma_chan_count</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">free_ch</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">dma_chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">dev_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">free_ch</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">free_ch</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_chan_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chan</span> <span class="o">=</span> <span class="n">dma_chan</span> <span class="o">+</span> <span class="n">free_ch</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">dev_id</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">clear_lch_regs</span><span class="p">)</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">clear_lch_regs</span><span class="p">(</span><span class="n">free_ch</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap2</span><span class="p">())</span>
		<span class="n">omap_clear_dma</span><span class="p">(</span><span class="n">free_ch</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_chan_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">dev_name</span> <span class="o">=</span> <span class="n">dev_name</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">callback</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifndef CONFIG_ARCH_OMAP1</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap2</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">chain_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">next_linked_ch</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">enabled_irqs</span> <span class="o">=</span> <span class="n">OMAP_DMA_DROP_IRQ</span> <span class="o">|</span> <span class="n">OMAP_DMA_BLOCK_IRQ</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap1</span><span class="p">())</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">enabled_irqs</span> <span class="o">|=</span> <span class="n">OMAP1_DMA_TOUT_IRQ</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap2</span><span class="p">())</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">enabled_irqs</span> <span class="o">|=</span> <span class="n">OMAP2_DMA_MISALIGNED_ERR_IRQ</span> <span class="o">|</span>
			<span class="n">OMAP2_DMA_TRANS_ERR_IRQ</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap16xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="cm">/* If the sync device is set, configure it dynamically. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_gdma_dev</span><span class="p">(</span><span class="n">free_ch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dev_id</span><span class="p">);</span>
			<span class="n">dev_id</span> <span class="o">=</span> <span class="n">free_ch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Disable the 1510 compatibility mode and set the sync device</span>
<span class="cm">		 * id.</span>
<span class="cm">		 */</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">dev_id</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">),</span> <span class="n">CCR</span><span class="p">,</span> <span class="n">free_ch</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap7xx</span><span class="p">()</span> <span class="o">||</span> <span class="n">cpu_is_omap15xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">dev_id</span><span class="p">,</span> <span class="n">CCR</span><span class="p">,</span> <span class="n">free_ch</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap2</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">omap2_enable_irq_lch</span><span class="p">(</span><span class="n">free_ch</span><span class="p">);</span>
		<span class="n">omap_enable_channel_irq</span><span class="p">(</span><span class="n">free_ch</span><span class="p">);</span>
		<span class="cm">/* Clear the CSR register and IRQ status register */</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">OMAP2_DMA_CSR_CLEAR_MASK</span><span class="p">,</span> <span class="n">CSR</span><span class="p">,</span> <span class="n">free_ch</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">free_ch</span><span class="p">,</span> <span class="n">IRQSTATUS_L0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">dma_ch_out</span> <span class="o">=</span> <span class="n">free_ch</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_request_dma</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">omap_free_dma</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma_chan</span><span class="p">[</span><span class="n">lch</span><span class="p">].</span><span class="n">dev_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;omap_dma: trying to free unallocated DMA channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">lch</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap1</span><span class="p">())</span> <span class="p">{</span>
		<span class="cm">/* Disable all DMA interrupts for the channel. */</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">CICR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
		<span class="cm">/* Make sure the DMA transfer is stopped. */</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">CCR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap2</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">omap2_disable_irq_lch</span><span class="p">(</span><span class="n">lch</span><span class="p">);</span>

		<span class="cm">/* Clear the CSR register and IRQ status register */</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">OMAP2_DMA_CSR_CLEAR_MASK</span><span class="p">,</span> <span class="n">CSR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">lch</span><span class="p">,</span> <span class="n">IRQSTATUS_L0</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>

		<span class="cm">/* Disable all DMA interrupts for the channel. */</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">CICR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>

		<span class="cm">/* Make sure the DMA transfer is stopped. */</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">CCR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
		<span class="n">omap_clear_dma</span><span class="p">(</span><span class="n">lch</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_chan_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dma_chan</span><span class="p">[</span><span class="n">lch</span><span class="p">].</span><span class="n">dev_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">dma_chan</span><span class="p">[</span><span class="n">lch</span><span class="p">].</span><span class="n">next_lch</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">dma_chan</span><span class="p">[</span><span class="n">lch</span><span class="p">].</span><span class="n">callback</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_chan_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_free_dma</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * @brief omap_dma_set_global_params : Set global priority settings for dma</span>
<span class="cm"> *</span>
<span class="cm"> * @param arb_rate</span>
<span class="cm"> * @param max_fifo_depth</span>
<span class="cm"> * @param tparams - Number of threads to reserve : DMA_THREAD_RESERVE_NORM</span>
<span class="cm"> * 						   DMA_THREAD_RESERVE_ONET</span>
<span class="cm"> * 						   DMA_THREAD_RESERVE_TWOT</span>
<span class="cm"> * 						   DMA_THREAD_RESERVE_THREET</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">omap_dma_set_global_params</span><span class="p">(</span><span class="kt">int</span> <span class="n">arb_rate</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_fifo_depth</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tparams</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_class_is_omap2</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;FIXME: no %s on 15xx/16xx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max_fifo_depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">max_fifo_depth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">arb_rate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">arb_rate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="mh">0xff</span> <span class="o">&amp;</span> <span class="n">max_fifo_depth</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x3</span> <span class="o">&amp;</span> <span class="n">tparams</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">arb_rate</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">GCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_dma_set_global_params</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * @brief omap_dma_set_prio_lch : Set channel wise priority settings</span>
<span class="cm"> *</span>
<span class="cm"> * @param lch</span>
<span class="cm"> * @param read_prio - Read priority</span>
<span class="cm"> * @param write_prio - Write priority</span>
<span class="cm"> * Both of the above can be set with one of the following values :</span>
<span class="cm"> * 	DMA_CH_PRIO_HIGH/DMA_CH_PRIO_LOW</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">omap_dma_set_prio_lch</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">read_prio</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">write_prio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">lch</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">lch</span> <span class="o">&gt;=</span> <span class="n">dma_lch_count</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Invalid channel id</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CCR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap2</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cpu_is_omap242x</span><span class="p">())</span>
		<span class="n">l</span> <span class="o">|=</span> <span class="p">((</span><span class="n">read_prio</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">write_prio</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">l</span> <span class="o">|=</span> <span class="p">((</span><span class="n">read_prio</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">CCR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_dma_set_prio_lch</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Clears any DMA state so the DMA engine is ready to restart with new buffers</span>
<span class="cm"> * through omap_start_dma(). Any buffers in flight are discarded.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">omap_clear_dma</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">clear_dma</span><span class="p">(</span><span class="n">lch</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_clear_dma</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">omap_start_dma</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The CPC/CDAC register needs to be initialized to zero</span>
<span class="cm">	 * before starting dma transfer.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap15xx</span><span class="p">())</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">CPC</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">CDAC</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">omap_dma_in_1510_mode</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">dma_chan</span><span class="p">[</span><span class="n">lch</span><span class="p">].</span><span class="n">next_lch</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">next_lch</span><span class="p">,</span> <span class="n">cur_lch</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">dma_chan_link_map</span><span class="p">[</span><span class="n">MAX_LOGICAL_DMA_CH_COUNT</span><span class="p">];</span>

		<span class="n">dma_chan_link_map</span><span class="p">[</span><span class="n">lch</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* Set the link register of the first channel */</span>
		<span class="n">enable_lnk</span><span class="p">(</span><span class="n">lch</span><span class="p">);</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">dma_chan_link_map</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dma_chan_link_map</span><span class="p">));</span>
		<span class="n">cur_lch</span> <span class="o">=</span> <span class="n">dma_chan</span><span class="p">[</span><span class="n">lch</span><span class="p">].</span><span class="n">next_lch</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">next_lch</span> <span class="o">=</span> <span class="n">dma_chan</span><span class="p">[</span><span class="n">cur_lch</span><span class="p">].</span><span class="n">next_lch</span><span class="p">;</span>

			<span class="cm">/* The loop case: we&#39;ve been here already */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dma_chan_link_map</span><span class="p">[</span><span class="n">cur_lch</span><span class="p">])</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* Mark the current channel */</span>
			<span class="n">dma_chan_link_map</span><span class="p">[</span><span class="n">cur_lch</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">enable_lnk</span><span class="p">(</span><span class="n">cur_lch</span><span class="p">);</span>
			<span class="n">omap_enable_channel_irq</span><span class="p">(</span><span class="n">cur_lch</span><span class="p">);</span>

			<span class="n">cur_lch</span> <span class="o">=</span> <span class="n">next_lch</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">next_lch</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_DMA_ERRATA</span><span class="p">(</span><span class="n">DMA_ERRATA_PARALLEL_CHANNELS</span><span class="p">))</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">lch</span><span class="p">,</span> <span class="n">CLNK_CTRL</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>

	<span class="n">omap_enable_channel_irq</span><span class="p">(</span><span class="n">lch</span><span class="p">);</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CCR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_DMA_ERRATA</span><span class="p">(</span><span class="n">DMA_ERRATA_IFRAME_BUFFERING</span><span class="p">))</span>
			<span class="n">l</span> <span class="o">|=</span> <span class="n">OMAP_DMA_CCR_BUFFERING_DISABLE</span><span class="p">;</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">OMAP_DMA_CCR_EN</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * As dma_write() uses IO accessors which are weakly ordered, there</span>
<span class="cm">	 * is no guarantee that data in coherent DMA memory will be visible</span>
<span class="cm">	 * to the DMA device.  Add a memory barrier here to ensure that any</span>
<span class="cm">	 * such data is visible prior to enabling DMA.</span>
<span class="cm">	 */</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">CCR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>

	<span class="n">dma_chan</span><span class="p">[</span><span class="n">lch</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">OMAP_DMA_ACTIVE</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_start_dma</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">omap_stop_dma</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

	<span class="cm">/* Disable all interrupts on the channel */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap1</span><span class="p">())</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">CICR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CCR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_DMA_ERRATA</span><span class="p">(</span><span class="n">DMA_ERRATA_i541</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">l</span> <span class="o">&amp;</span> <span class="n">OMAP_DMA_CCR_SEL_SRC_DST_SYNC</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">sys_cf</span><span class="p">;</span>

		<span class="cm">/* Configure No-Standby */</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">OCP_SYSCONFIG</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
		<span class="n">sys_cf</span> <span class="o">=</span> <span class="n">l</span><span class="p">;</span>
		<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMA_SYSCONFIG_MIDLEMODE_MASK</span><span class="p">;</span>
		<span class="n">l</span> <span class="o">|=</span> <span class="n">DMA_SYSCONFIG_MIDLEMODE</span><span class="p">(</span><span class="n">DMA_IDLEMODE_NO_IDLE</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">l</span> <span class="p">,</span> <span class="n">OCP_SYSCONFIG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">l</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CCR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
		<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OMAP_DMA_CCR_EN</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">CCR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>

		<span class="cm">/* Wait for sDMA FIFO drain */</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CCR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">l</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">OMAP_DMA_CCR_RD_ACTIVE</span> <span class="o">|</span>
					<span class="n">OMAP_DMA_CCR_WR_ACTIVE</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="n">l</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CCR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DMA drain did not complete on &quot;</span>
					<span class="s">&quot;lch %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
		<span class="cm">/* Restore OCP_SYSCONFIG */</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">sys_cf</span><span class="p">,</span> <span class="n">OCP_SYSCONFIG</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OMAP_DMA_CCR_EN</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">CCR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Ensure that data transferred by DMA is visible to any access</span>
<span class="cm">	 * after DMA has been disabled.  This is important for coherent</span>
<span class="cm">	 * DMA regions.</span>
<span class="cm">	 */</span>
	<span class="n">mb</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">omap_dma_in_1510_mode</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">dma_chan</span><span class="p">[</span><span class="n">lch</span><span class="p">].</span><span class="n">next_lch</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">next_lch</span><span class="p">,</span> <span class="n">cur_lch</span> <span class="o">=</span> <span class="n">lch</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">dma_chan_link_map</span><span class="p">[</span><span class="n">MAX_LOGICAL_DMA_CH_COUNT</span><span class="p">];</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">dma_chan_link_map</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dma_chan_link_map</span><span class="p">));</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="cm">/* The loop case: we&#39;ve been here already */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dma_chan_link_map</span><span class="p">[</span><span class="n">cur_lch</span><span class="p">])</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* Mark the current channel */</span>
			<span class="n">dma_chan_link_map</span><span class="p">[</span><span class="n">cur_lch</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">disable_lnk</span><span class="p">(</span><span class="n">cur_lch</span><span class="p">);</span>

			<span class="n">next_lch</span> <span class="o">=</span> <span class="n">dma_chan</span><span class="p">[</span><span class="n">cur_lch</span><span class="p">].</span><span class="n">next_lch</span><span class="p">;</span>
			<span class="n">cur_lch</span> <span class="o">=</span> <span class="n">next_lch</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">next_lch</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dma_chan</span><span class="p">[</span><span class="n">lch</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OMAP_DMA_ACTIVE</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_stop_dma</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Allows changing the DMA callback function or data. This may be needed if</span>
<span class="cm"> * the driver shares a single DMA channel for multiple dma triggers.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">omap_set_dma_callback</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">,</span>
			  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">,</span> <span class="n">u16</span> <span class="n">ch_status</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">),</span>
			  <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lch</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_chan_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_chan</span><span class="p">[</span><span class="n">lch</span><span class="p">].</span><span class="n">dev_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DMA callback for not set for free channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_chan_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dma_chan</span><span class="p">[</span><span class="n">lch</span><span class="p">].</span><span class="n">callback</span> <span class="o">=</span> <span class="n">callback</span><span class="p">;</span>
	<span class="n">dma_chan</span><span class="p">[</span><span class="n">lch</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_chan_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_set_dma_callback</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Returns current physical source address for the given DMA channel.</span>
<span class="cm"> * If the channel is running the caller must disable interrupts prior calling</span>
<span class="cm"> * this function and process the returned value before re-enabling interrupt to</span>
<span class="cm"> * prevent races with the interrupt handler. Note that in continuous mode there</span>
<span class="cm"> * is a chance for CSSA_L register overflow between the two reads resulting</span>
<span class="cm"> * in incorrect return value.</span>
<span class="cm"> */</span>
<span class="n">dma_addr_t</span> <span class="nf">omap_get_dma_src_pos</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_addr_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap15xx</span><span class="p">())</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CPC</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CSAC</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_DMA_ERRATA</span><span class="p">(</span><span class="n">DMA_ERRATA_3_3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CSAC</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_is_omap15xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * CDAC == 0 indicates that the DMA transfer on the channel has</span>
<span class="cm">		 * not been started (no data has been transferred so far).</span>
<span class="cm">		 * Return the programmed source start address in this case.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CDAC</span><span class="p">,</span> <span class="n">lch</span><span class="p">)))</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CSAC</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CSSA</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap1</span><span class="p">())</span>
		<span class="n">offset</span> <span class="o">|=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CSSA</span><span class="p">,</span> <span class="n">lch</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_get_dma_src_pos</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Returns current physical destination address for the given DMA channel.</span>
<span class="cm"> * If the channel is running the caller must disable interrupts prior calling</span>
<span class="cm"> * this function and process the returned value before re-enabling interrupt to</span>
<span class="cm"> * prevent races with the interrupt handler. Note that in continuous mode there</span>
<span class="cm"> * is a chance for CDSA_L register overflow between the two reads resulting</span>
<span class="cm"> * in incorrect return value.</span>
<span class="cm"> */</span>
<span class="n">dma_addr_t</span> <span class="nf">omap_get_dma_dst_pos</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_addr_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap15xx</span><span class="p">())</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CPC</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CDAC</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * omap 3.2/3.3 erratum: sometimes 0 is returned if CSAC/CDAC is</span>
<span class="cm">	 * read before the DMA controller finished disabling the channel.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_is_omap15xx</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CDAC</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * CDAC == 0 indicates that the DMA transfer on the channel has</span>
<span class="cm">		 * not been started (no data has been transferred so far).</span>
<span class="cm">		 * Return the programmed destination start address in this case.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">offset</span><span class="p">))</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CDSA</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap1</span><span class="p">())</span>
		<span class="n">offset</span> <span class="o">|=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CDSA</span><span class="p">,</span> <span class="n">lch</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_get_dma_dst_pos</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">omap_get_dma_active_status</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CCR</span><span class="p">,</span> <span class="n">lch</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OMAP_DMA_CCR_EN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_get_dma_active_status</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">omap_dma_running</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">lch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap1</span><span class="p">())</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">omap_lcd_dma_running</span><span class="p">())</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">lch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">lch</span> <span class="o">&lt;</span> <span class="n">dma_chan_count</span><span class="p">;</span> <span class="n">lch</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CCR</span><span class="p">,</span> <span class="n">lch</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OMAP_DMA_CCR_EN</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * lch_queue DMA will start right after lch_head one is finished.</span>
<span class="cm"> * For this DMA link to start, you still need to start (see omap_start_dma)</span>
<span class="cm"> * the first one. That will fire up the entire queue.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">omap_dma_link_lch</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch_head</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lch_queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">omap_dma_in_1510_mode</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lch_head</span> <span class="o">==</span> <span class="n">lch_queue</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CCR</span><span class="p">,</span> <span class="n">lch_head</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span>
								<span class="n">CCR</span><span class="p">,</span> <span class="n">lch_head</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DMA linking is not supported in 1510 mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dma_chan</span><span class="p">[</span><span class="n">lch_head</span><span class="p">].</span><span class="n">dev_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">dma_chan</span><span class="p">[</span><span class="n">lch_queue</span><span class="p">].</span><span class="n">dev_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;omap_dma: trying to link &quot;</span>
		       <span class="s">&quot;non requested channels</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dump_stack</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">dma_chan</span><span class="p">[</span><span class="n">lch_head</span><span class="p">].</span><span class="n">next_lch</span> <span class="o">=</span> <span class="n">lch_queue</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_dma_link_lch</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Once the DMA queue is stopped, we can destroy it.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">omap_dma_unlink_lch</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch_head</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lch_queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">omap_dma_in_1510_mode</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lch_head</span> <span class="o">==</span> <span class="n">lch_queue</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CCR</span><span class="p">,</span> <span class="n">lch_head</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span>
								<span class="n">CCR</span><span class="p">,</span> <span class="n">lch_head</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DMA linking is not supported in 1510 mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma_chan</span><span class="p">[</span><span class="n">lch_head</span><span class="p">].</span><span class="n">next_lch</span> <span class="o">!=</span> <span class="n">lch_queue</span> <span class="o">||</span>
	    <span class="n">dma_chan</span><span class="p">[</span><span class="n">lch_head</span><span class="p">].</span><span class="n">next_lch</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;omap_dma: trying to unlink &quot;</span>
		       <span class="s">&quot;non linked channels</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dump_stack</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dma_chan</span><span class="p">[</span><span class="n">lch_head</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">OMAP_DMA_ACTIVE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">dma_chan</span><span class="p">[</span><span class="n">lch_queue</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">OMAP_DMA_ACTIVE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;omap_dma: You need to stop the DMA channels &quot;</span>
		       <span class="s">&quot;before unlinking</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dump_stack</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">dma_chan</span><span class="p">[</span><span class="n">lch_head</span><span class="p">].</span><span class="n">next_lch</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_dma_unlink_lch</span><span class="p">);</span>

<span class="cp">#ifndef CONFIG_ARCH_OMAP1</span>
<span class="cm">/* Create chain of DMA channesls */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">create_dma_lch_chain</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch_head</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lch_queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

	<span class="cm">/* Check if this is the first link in chain */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_chan</span><span class="p">[</span><span class="n">lch_head</span><span class="p">].</span><span class="n">next_linked_ch</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_chan</span><span class="p">[</span><span class="n">lch_head</span><span class="p">].</span><span class="n">next_linked_ch</span> <span class="o">=</span> <span class="n">lch_queue</span><span class="p">;</span>
		<span class="n">dma_chan</span><span class="p">[</span><span class="n">lch_head</span><span class="p">].</span><span class="n">prev_linked_ch</span> <span class="o">=</span> <span class="n">lch_queue</span><span class="p">;</span>
		<span class="n">dma_chan</span><span class="p">[</span><span class="n">lch_queue</span><span class="p">].</span><span class="n">next_linked_ch</span> <span class="o">=</span> <span class="n">lch_head</span><span class="p">;</span>
		<span class="n">dma_chan</span><span class="p">[</span><span class="n">lch_queue</span><span class="p">].</span><span class="n">prev_linked_ch</span> <span class="o">=</span> <span class="n">lch_head</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* a link exists, link the new channel in circular chain */</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">dma_chan</span><span class="p">[</span><span class="n">lch_queue</span><span class="p">].</span><span class="n">next_linked_ch</span> <span class="o">=</span>
					<span class="n">dma_chan</span><span class="p">[</span><span class="n">lch_head</span><span class="p">].</span><span class="n">next_linked_ch</span><span class="p">;</span>
		<span class="n">dma_chan</span><span class="p">[</span><span class="n">lch_queue</span><span class="p">].</span><span class="n">prev_linked_ch</span> <span class="o">=</span> <span class="n">lch_head</span><span class="p">;</span>
		<span class="n">dma_chan</span><span class="p">[</span><span class="n">lch_head</span><span class="p">].</span><span class="n">next_linked_ch</span> <span class="o">=</span> <span class="n">lch_queue</span><span class="p">;</span>
		<span class="n">dma_chan</span><span class="p">[</span><span class="n">dma_chan</span><span class="p">[</span><span class="n">lch_queue</span><span class="p">].</span><span class="n">next_linked_ch</span><span class="p">].</span><span class="n">prev_linked_ch</span> <span class="o">=</span>
					<span class="n">lch_queue</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CLNK_CTRL</span><span class="p">,</span> <span class="n">lch_head</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1f</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">lch_queue</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">CLNK_CTRL</span><span class="p">,</span> <span class="n">lch_head</span><span class="p">);</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CLNK_CTRL</span><span class="p">,</span> <span class="n">lch_queue</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1f</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="p">(</span><span class="n">dma_chan</span><span class="p">[</span><span class="n">lch_queue</span><span class="p">].</span><span class="n">next_linked_ch</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">CLNK_CTRL</span><span class="p">,</span> <span class="n">lch_queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * @brief omap_request_dma_chain : Request a chain of DMA channels</span>
<span class="cm"> *</span>
<span class="cm"> * @param dev_id - Device id using the dma channel</span>
<span class="cm"> * @param dev_name - Device name</span>
<span class="cm"> * @param callback - Call back function</span>
<span class="cm"> * @chain_id -</span>
<span class="cm"> * @no_of_chans - Number of channels requested</span>
<span class="cm"> * @chain_mode - Dynamic or static chaining : OMAP_DMA_STATIC_CHAIN</span>
<span class="cm"> * 					      OMAP_DMA_DYNAMIC_CHAIN</span>
<span class="cm"> * @params - Channel parameters</span>
<span class="cm"> *</span>
<span class="cm"> * @return - Success : 0</span>
<span class="cm"> * 	     Failure: -EINVAL/-ENOMEM</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">omap_request_dma_chain</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev_id</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">,</span>
			   <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">,</span> <span class="n">u16</span> <span class="n">ch_status</span><span class="p">,</span>
					     <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">),</span>
			   <span class="kt">int</span> <span class="o">*</span><span class="n">chain_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">no_of_chans</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chain_mode</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">omap_dma_channel_params</span> <span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">channels</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Is the chain mode valid ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chain_mode</span> <span class="o">!=</span> <span class="n">OMAP_DMA_STATIC_CHAIN</span>
			<span class="o">&amp;&amp;</span> <span class="n">chain_mode</span> <span class="o">!=</span> <span class="n">OMAP_DMA_DYNAMIC_CHAIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Invalid chain mode requested</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">no_of_chans</span> <span class="o">&lt;</span> <span class="mi">1</span>
			<span class="o">||</span> <span class="n">no_of_chans</span> <span class="o">&gt;</span> <span class="n">dma_lch_count</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Invalid Number of channels requested</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate a queue to maintain the status of the channels</span>
<span class="cm">	 * in the chain</span>
<span class="cm">	 */</span>
	<span class="n">channels</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">channels</span><span class="p">)</span> <span class="o">*</span> <span class="n">no_of_chans</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channels</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;omap_dma: No memory for channel queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* request and reserve DMA channels for the chain */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">no_of_chans</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">omap_request_dma</span><span class="p">(</span><span class="n">dev_id</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">,</span>
					<span class="n">callback</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">omap_free_dma</span><span class="p">(</span><span class="n">channels</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">channels</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;omap_dma: Request failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dma_chan</span><span class="p">[</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]].</span><span class="n">prev_linked_ch</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">dma_chan</span><span class="p">[</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]].</span><span class="n">state</span> <span class="o">=</span> <span class="n">DMA_CH_NOTSTARTED</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Allowing client drivers to set common parameters now,</span>
<span class="cm">		 * so that later only relevant (src_start, dest_start</span>
<span class="cm">		 * and element count) can be set</span>
<span class="cm">		 */</span>
		<span class="n">omap_set_dma_params</span><span class="p">(</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">chain_id</span> <span class="o">=</span> <span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">dma_linked_lch</span><span class="p">[</span><span class="o">*</span><span class="n">chain_id</span><span class="p">].</span><span class="n">linked_dmach_q</span> <span class="o">=</span> <span class="n">channels</span><span class="p">;</span>
	<span class="n">dma_linked_lch</span><span class="p">[</span><span class="o">*</span><span class="n">chain_id</span><span class="p">].</span><span class="n">chain_mode</span> <span class="o">=</span> <span class="n">chain_mode</span><span class="p">;</span>
	<span class="n">dma_linked_lch</span><span class="p">[</span><span class="o">*</span><span class="n">chain_id</span><span class="p">].</span><span class="n">chain_state</span> <span class="o">=</span> <span class="n">DMA_CHAIN_NOTSTARTED</span><span class="p">;</span>
	<span class="n">dma_linked_lch</span><span class="p">[</span><span class="o">*</span><span class="n">chain_id</span><span class="p">].</span><span class="n">no_of_lchs_linked</span> <span class="o">=</span> <span class="n">no_of_chans</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">no_of_chans</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dma_chan</span><span class="p">[</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]].</span><span class="n">chain_id</span> <span class="o">=</span> <span class="o">*</span><span class="n">chain_id</span><span class="p">;</span>

	<span class="cm">/* Reset the Queue pointers */</span>
	<span class="n">OMAP_DMA_CHAIN_QINIT</span><span class="p">(</span><span class="o">*</span><span class="n">chain_id</span><span class="p">);</span>

	<span class="cm">/* Set up the chain */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">no_of_chans</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">create_dma_lch_chain</span><span class="p">(</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">no_of_chans</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">create_dma_lch_chain</span><span class="p">(</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">channels</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_request_dma_chain</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * @brief omap_modify_dma_chain_param : Modify the chain&#39;s params - Modify the</span>
<span class="cm"> * params after setting it. Dont do this while dma is running!!</span>
<span class="cm"> *</span>
<span class="cm"> * @param chain_id - Chained logical channel id.</span>
<span class="cm"> * @param params</span>
<span class="cm"> *</span>
<span class="cm"> * @return - Success : 0</span>
<span class="cm"> * 	     Failure : -EINVAL</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">omap_modify_dma_chain_params</span><span class="p">(</span><span class="kt">int</span> <span class="n">chain_id</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">omap_dma_channel_params</span> <span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">channels</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Check for input params */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">chain_id</span> <span class="o">&lt;</span> <span class="mi">0</span>
			<span class="o">||</span> <span class="n">chain_id</span> <span class="o">&gt;=</span> <span class="n">dma_lch_count</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Invalid chain id</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if the chain exists */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_linked_lch</span><span class="p">[</span><span class="n">chain_id</span><span class="p">].</span><span class="n">linked_dmach_q</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Chain doesn&#39;t exists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">channels</span> <span class="o">=</span> <span class="n">dma_linked_lch</span><span class="p">[</span><span class="n">chain_id</span><span class="p">].</span><span class="n">linked_dmach_q</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dma_linked_lch</span><span class="p">[</span><span class="n">chain_id</span><span class="p">].</span><span class="n">no_of_lchs_linked</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Allowing client drivers to set common parameters now,</span>
<span class="cm">		 * so that later only relevant (src_start, dest_start</span>
<span class="cm">		 * and element count) can be set</span>
<span class="cm">		 */</span>
		<span class="n">omap_set_dma_params</span><span class="p">(</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_modify_dma_chain_params</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * @brief omap_free_dma_chain - Free all the logical channels in a chain.</span>
<span class="cm"> *</span>
<span class="cm"> * @param chain_id</span>
<span class="cm"> *</span>
<span class="cm"> * @return - Success : 0</span>
<span class="cm"> * 	     Failure : -EINVAL</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">omap_free_dma_chain</span><span class="p">(</span><span class="kt">int</span> <span class="n">chain_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">channels</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Check for input params */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">chain_id</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">chain_id</span> <span class="o">&gt;=</span> <span class="n">dma_lch_count</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Invalid chain id</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if the chain exists */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_linked_lch</span><span class="p">[</span><span class="n">chain_id</span><span class="p">].</span><span class="n">linked_dmach_q</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Chain doesn&#39;t exists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">channels</span> <span class="o">=</span> <span class="n">dma_linked_lch</span><span class="p">[</span><span class="n">chain_id</span><span class="p">].</span><span class="n">linked_dmach_q</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dma_linked_lch</span><span class="p">[</span><span class="n">chain_id</span><span class="p">].</span><span class="n">no_of_lchs_linked</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_chan</span><span class="p">[</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]].</span><span class="n">next_linked_ch</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">dma_chan</span><span class="p">[</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]].</span><span class="n">prev_linked_ch</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">dma_chan</span><span class="p">[</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]].</span><span class="n">chain_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">dma_chan</span><span class="p">[</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]].</span><span class="n">state</span> <span class="o">=</span> <span class="n">DMA_CH_NOTSTARTED</span><span class="p">;</span>
		<span class="n">omap_free_dma</span><span class="p">(</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">channels</span><span class="p">);</span>

	<span class="n">dma_linked_lch</span><span class="p">[</span><span class="n">chain_id</span><span class="p">].</span><span class="n">linked_dmach_q</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dma_linked_lch</span><span class="p">[</span><span class="n">chain_id</span><span class="p">].</span><span class="n">chain_mode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">dma_linked_lch</span><span class="p">[</span><span class="n">chain_id</span><span class="p">].</span><span class="n">chain_state</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_free_dma_chain</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * @brief omap_dma_chain_status - Check if the chain is in</span>
<span class="cm"> * active / inactive state.</span>
<span class="cm"> * @param chain_id</span>
<span class="cm"> *</span>
<span class="cm"> * @return - Success : OMAP_DMA_CHAIN_ACTIVE/OMAP_DMA_CHAIN_INACTIVE</span>
<span class="cm"> * 	     Failure : -EINVAL</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">omap_dma_chain_status</span><span class="p">(</span><span class="kt">int</span> <span class="n">chain_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Check for input params */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">chain_id</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">chain_id</span> <span class="o">&gt;=</span> <span class="n">dma_lch_count</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Invalid chain id</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if the chain exists */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_linked_lch</span><span class="p">[</span><span class="n">chain_id</span><span class="p">].</span><span class="n">linked_dmach_q</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Chain doesn&#39;t exists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;CHAINID=%d, qcnt=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chain_id</span><span class="p">,</span>
			<span class="n">dma_linked_lch</span><span class="p">[</span><span class="n">chain_id</span><span class="p">].</span><span class="n">q_count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">OMAP_DMA_CHAIN_QEMPTY</span><span class="p">(</span><span class="n">chain_id</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">OMAP_DMA_CHAIN_INACTIVE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">OMAP_DMA_CHAIN_ACTIVE</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_dma_chain_status</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * @brief omap_dma_chain_a_transfer - Get a free channel from a chain,</span>
<span class="cm"> * set the params and start the transfer.</span>
<span class="cm"> *</span>
<span class="cm"> * @param chain_id</span>
<span class="cm"> * @param src_start - buffer start address</span>
<span class="cm"> * @param dest_start - Dest address</span>
<span class="cm"> * @param elem_count</span>
<span class="cm"> * @param frame_count</span>
<span class="cm"> * @param callbk_data - channel callback parameter data.</span>
<span class="cm"> *</span>
<span class="cm"> * @return  - Success : 0</span>
<span class="cm"> * 	      Failure: -EINVAL/-EBUSY</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">omap_dma_chain_a_transfer</span><span class="p">(</span><span class="kt">int</span> <span class="n">chain_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src_start</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dest_start</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">elem_count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">frame_count</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">callbk_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">channels</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">,</span> <span class="n">lch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">start_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * if buffer size is less than 1 then there is</span>
<span class="cm">	 * no use of starting the chain</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">elem_count</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Invalid buffer size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check for input params */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">chain_id</span> <span class="o">&lt;</span> <span class="mi">0</span>
			<span class="o">||</span> <span class="n">chain_id</span> <span class="o">&gt;=</span> <span class="n">dma_lch_count</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Invalid chain id</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if the chain exists */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_linked_lch</span><span class="p">[</span><span class="n">chain_id</span><span class="p">].</span><span class="n">linked_dmach_q</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Chain doesn&#39;t exist</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if all the channels in chain are in use */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">OMAP_DMA_CHAIN_QFULL</span><span class="p">(</span><span class="n">chain_id</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* Frame count may be negative in case of indexed transfers */</span>
	<span class="n">channels</span> <span class="o">=</span> <span class="n">dma_linked_lch</span><span class="p">[</span><span class="n">chain_id</span><span class="p">].</span><span class="n">linked_dmach_q</span><span class="p">;</span>

	<span class="cm">/* Get a free channel */</span>
	<span class="n">lch</span> <span class="o">=</span> <span class="n">channels</span><span class="p">[</span><span class="n">dma_linked_lch</span><span class="p">[</span><span class="n">chain_id</span><span class="p">].</span><span class="n">q_tail</span><span class="p">];</span>

	<span class="cm">/* Store the callback data */</span>
	<span class="n">dma_chan</span><span class="p">[</span><span class="n">lch</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="n">callbk_data</span><span class="p">;</span>

	<span class="cm">/* Increment the q_tail */</span>
	<span class="n">OMAP_DMA_CHAIN_INCQTAIL</span><span class="p">(</span><span class="n">chain_id</span><span class="p">);</span>

	<span class="cm">/* Set the params to the free channel */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">src_start</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">src_start</span><span class="p">,</span> <span class="n">CSSA</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dest_start</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">dest_start</span><span class="p">,</span> <span class="n">CDSA</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>

	<span class="cm">/* Write the buffer size */</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">elem_count</span><span class="p">,</span> <span class="n">CEN</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">frame_count</span><span class="p">,</span> <span class="n">CFN</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the chain is dynamically linked,</span>
<span class="cm">	 * then we may have to start the chain if its not active</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_linked_lch</span><span class="p">[</span><span class="n">chain_id</span><span class="p">].</span><span class="n">chain_mode</span> <span class="o">==</span> <span class="n">OMAP_DMA_DYNAMIC_CHAIN</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * In Dynamic chain, if the chain is not started,</span>
<span class="cm">		 * queue the channel</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_linked_lch</span><span class="p">[</span><span class="n">chain_id</span><span class="p">].</span><span class="n">chain_state</span> <span class="o">==</span>
						<span class="n">DMA_CHAIN_NOTSTARTED</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Enable the link in previous channel */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dma_chan</span><span class="p">[</span><span class="n">dma_chan</span><span class="p">[</span><span class="n">lch</span><span class="p">].</span><span class="n">prev_linked_ch</span><span class="p">].</span><span class="n">state</span> <span class="o">==</span>
								<span class="n">DMA_CH_QUEUED</span><span class="p">)</span>
				<span class="n">enable_lnk</span><span class="p">(</span><span class="n">dma_chan</span><span class="p">[</span><span class="n">lch</span><span class="p">].</span><span class="n">prev_linked_ch</span><span class="p">);</span>
			<span class="n">dma_chan</span><span class="p">[</span><span class="n">lch</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">DMA_CH_QUEUED</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Chain is already started, make sure its active,</span>
<span class="cm">		 * if not then start the chain</span>
<span class="cm">		 */</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">start_dma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dma_chan</span><span class="p">[</span><span class="n">dma_chan</span><span class="p">[</span><span class="n">lch</span><span class="p">].</span><span class="n">prev_linked_ch</span><span class="p">].</span><span class="n">state</span> <span class="o">==</span>
							<span class="n">DMA_CH_STARTED</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">enable_lnk</span><span class="p">(</span><span class="n">dma_chan</span><span class="p">[</span><span class="n">lch</span><span class="p">].</span><span class="n">prev_linked_ch</span><span class="p">);</span>
				<span class="n">dma_chan</span><span class="p">[</span><span class="n">lch</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">DMA_CH_QUEUED</span><span class="p">;</span>
				<span class="n">start_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span>
					<span class="n">CCR</span><span class="p">,</span> <span class="n">dma_chan</span><span class="p">[</span><span class="n">lch</span><span class="p">].</span><span class="n">prev_linked_ch</span><span class="p">)))</span> <span class="p">{</span>
					<span class="n">disable_lnk</span><span class="p">(</span><span class="n">dma_chan</span><span class="p">[</span><span class="n">lch</span><span class="p">].</span>
						    <span class="n">prev_linked_ch</span><span class="p">);</span>
					<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> prev ch is stopped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">start_dma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dma_chan</span><span class="p">[</span><span class="n">dma_chan</span><span class="p">[</span><span class="n">lch</span><span class="p">].</span><span class="n">prev_linked_ch</span><span class="p">].</span><span class="n">state</span>
							<span class="o">==</span> <span class="n">DMA_CH_QUEUED</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">enable_lnk</span><span class="p">(</span><span class="n">dma_chan</span><span class="p">[</span><span class="n">lch</span><span class="p">].</span><span class="n">prev_linked_ch</span><span class="p">);</span>
				<span class="n">dma_chan</span><span class="p">[</span><span class="n">lch</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">DMA_CH_QUEUED</span><span class="p">;</span>
				<span class="n">start_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">omap_enable_channel_irq</span><span class="p">(</span><span class="n">lch</span><span class="p">);</span>

			<span class="n">l</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CCR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">((</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">l</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">))))</span>
				<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">25</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">l</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">25</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">start_dma</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">l</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)))</span> <span class="p">{</span>
					<span class="n">l</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
					<span class="n">dma_chan</span><span class="p">[</span><span class="n">lch</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">DMA_CH_STARTED</span><span class="p">;</span>
					<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;starting %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
					<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">CCR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">start_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">l</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)))</span>
					<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">CCR</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">dma_chan</span><span class="p">[</span><span class="n">lch</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">OMAP_DMA_ACTIVE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_dma_chain_a_transfer</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * @brief omap_start_dma_chain_transfers - Start the chain</span>
<span class="cm"> *</span>
<span class="cm"> * @param chain_id</span>
<span class="cm"> *</span>
<span class="cm"> * @return - Success : 0</span>
<span class="cm"> * 	     Failure : -EINVAL/-EBUSY</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">omap_start_dma_chain_transfers</span><span class="p">(</span><span class="kt">int</span> <span class="n">chain_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">channels</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">chain_id</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">chain_id</span> <span class="o">&gt;=</span> <span class="n">dma_lch_count</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Invalid chain id</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">channels</span> <span class="o">=</span> <span class="n">dma_linked_lch</span><span class="p">[</span><span class="n">chain_id</span><span class="p">].</span><span class="n">linked_dmach_q</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma_linked_lch</span><span class="p">[</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">chain_state</span> <span class="o">==</span> <span class="n">DMA_CHAIN_STARTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Chain is already started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma_linked_lch</span><span class="p">[</span><span class="n">chain_id</span><span class="p">].</span><span class="n">chain_mode</span> <span class="o">==</span> <span class="n">OMAP_DMA_STATIC_CHAIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dma_linked_lch</span><span class="p">[</span><span class="n">chain_id</span><span class="p">].</span><span class="n">no_of_lchs_linked</span><span class="p">;</span>
									<span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">enable_lnk</span><span class="p">(</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">omap_enable_channel_irq</span><span class="p">(</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">omap_enable_channel_irq</span><span class="p">(</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CCR</span><span class="p">,</span> <span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
	<span class="n">dma_linked_lch</span><span class="p">[</span><span class="n">chain_id</span><span class="p">].</span><span class="n">chain_state</span> <span class="o">=</span> <span class="n">DMA_CHAIN_STARTED</span><span class="p">;</span>
	<span class="n">dma_chan</span><span class="p">[</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">state</span> <span class="o">=</span> <span class="n">DMA_CH_STARTED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">l</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">))))</span>
		<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">25</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">l</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">25</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">CCR</span><span class="p">,</span> <span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">dma_chan</span><span class="p">[</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">OMAP_DMA_ACTIVE</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_start_dma_chain_transfers</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * @brief omap_stop_dma_chain_transfers - Stop the dma transfer of a chain.</span>
<span class="cm"> *</span>
<span class="cm"> * @param chain_id</span>
<span class="cm"> *</span>
<span class="cm"> * @return - Success : 0</span>
<span class="cm"> * 	     Failure : EINVAL</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">omap_stop_dma_chain_transfers</span><span class="p">(</span><span class="kt">int</span> <span class="n">chain_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">channels</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sys_cf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Check for input params */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">chain_id</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">chain_id</span> <span class="o">&gt;=</span> <span class="n">dma_lch_count</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Invalid chain id</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if the chain exists */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_linked_lch</span><span class="p">[</span><span class="n">chain_id</span><span class="p">].</span><span class="n">linked_dmach_q</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Chain doesn&#39;t exists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">channels</span> <span class="o">=</span> <span class="n">dma_linked_lch</span><span class="p">[</span><span class="n">chain_id</span><span class="p">].</span><span class="n">linked_dmach_q</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_DMA_ERRATA</span><span class="p">(</span><span class="n">DMA_ERRATA_i88</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sys_cf</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">OCP_SYSCONFIG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">sys_cf</span><span class="p">;</span>
		<span class="cm">/* Middle mode reg set no Standby */</span>
		<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">));</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">OCP_SYSCONFIG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dma_linked_lch</span><span class="p">[</span><span class="n">chain_id</span><span class="p">].</span><span class="n">no_of_lchs_linked</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Stop the Channel transmission */</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CCR</span><span class="p">,</span> <span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">CCR</span><span class="p">,</span> <span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="cm">/* Disable the link in all the channels */</span>
		<span class="n">disable_lnk</span><span class="p">(</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">dma_chan</span><span class="p">[</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]].</span><span class="n">state</span> <span class="o">=</span> <span class="n">DMA_CH_NOTSTARTED</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="n">dma_linked_lch</span><span class="p">[</span><span class="n">chain_id</span><span class="p">].</span><span class="n">chain_state</span> <span class="o">=</span> <span class="n">DMA_CHAIN_NOTSTARTED</span><span class="p">;</span>

	<span class="cm">/* Reset the Queue pointers */</span>
	<span class="n">OMAP_DMA_CHAIN_QINIT</span><span class="p">(</span><span class="n">chain_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_DMA_ERRATA</span><span class="p">(</span><span class="n">DMA_ERRATA_i88</span><span class="p">))</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">sys_cf</span><span class="p">,</span> <span class="n">OCP_SYSCONFIG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_stop_dma_chain_transfers</span><span class="p">);</span>

<span class="cm">/* Get the index of the ongoing DMA in chain */</span>
<span class="cm">/**</span>
<span class="cm"> * @brief omap_get_dma_chain_index - Get the element and frame index</span>
<span class="cm"> * of the ongoing DMA in chain</span>
<span class="cm"> *</span>
<span class="cm"> * @param chain_id</span>
<span class="cm"> * @param ei - Element index</span>
<span class="cm"> * @param fi - Frame index</span>
<span class="cm"> *</span>
<span class="cm"> * @return - Success : 0</span>
<span class="cm"> * 	     Failure : -EINVAL</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">omap_get_dma_chain_index</span><span class="p">(</span><span class="kt">int</span> <span class="n">chain_id</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ei</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">fi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">lch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">channels</span><span class="p">;</span>

	<span class="cm">/* Check for input params */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">chain_id</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">chain_id</span> <span class="o">&gt;=</span> <span class="n">dma_lch_count</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Invalid chain id</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if the chain exists */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_linked_lch</span><span class="p">[</span><span class="n">chain_id</span><span class="p">].</span><span class="n">linked_dmach_q</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Chain doesn&#39;t exists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">ei</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">fi</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">channels</span> <span class="o">=</span> <span class="n">dma_linked_lch</span><span class="p">[</span><span class="n">chain_id</span><span class="p">].</span><span class="n">linked_dmach_q</span><span class="p">;</span>

	<span class="cm">/* Get the current channel */</span>
	<span class="n">lch</span> <span class="o">=</span> <span class="n">channels</span><span class="p">[</span><span class="n">dma_linked_lch</span><span class="p">[</span><span class="n">chain_id</span><span class="p">].</span><span class="n">q_head</span><span class="p">];</span>

	<span class="o">*</span><span class="n">ei</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CCEN</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
	<span class="o">*</span><span class="n">fi</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CCFN</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_get_dma_chain_index</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * @brief omap_get_dma_chain_dst_pos - Get the destination position of the</span>
<span class="cm"> * ongoing DMA in chain</span>
<span class="cm"> *</span>
<span class="cm"> * @param chain_id</span>
<span class="cm"> *</span>
<span class="cm"> * @return - Success : Destination position</span>
<span class="cm"> * 	     Failure : -EINVAL</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">omap_get_dma_chain_dst_pos</span><span class="p">(</span><span class="kt">int</span> <span class="n">chain_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">lch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">channels</span><span class="p">;</span>

	<span class="cm">/* Check for input params */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">chain_id</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">chain_id</span> <span class="o">&gt;=</span> <span class="n">dma_lch_count</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Invalid chain id</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if the chain exists */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_linked_lch</span><span class="p">[</span><span class="n">chain_id</span><span class="p">].</span><span class="n">linked_dmach_q</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Chain doesn&#39;t exists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">channels</span> <span class="o">=</span> <span class="n">dma_linked_lch</span><span class="p">[</span><span class="n">chain_id</span><span class="p">].</span><span class="n">linked_dmach_q</span><span class="p">;</span>

	<span class="cm">/* Get the current channel */</span>
	<span class="n">lch</span> <span class="o">=</span> <span class="n">channels</span><span class="p">[</span><span class="n">dma_linked_lch</span><span class="p">[</span><span class="n">chain_id</span><span class="p">].</span><span class="n">q_head</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CDAC</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_get_dma_chain_dst_pos</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * @brief omap_get_dma_chain_src_pos - Get the source position</span>
<span class="cm"> * of the ongoing DMA in chain</span>
<span class="cm"> * @param chain_id</span>
<span class="cm"> *</span>
<span class="cm"> * @return - Success : Destination position</span>
<span class="cm"> * 	     Failure : -EINVAL</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">omap_get_dma_chain_src_pos</span><span class="p">(</span><span class="kt">int</span> <span class="n">chain_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">lch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">channels</span><span class="p">;</span>

	<span class="cm">/* Check for input params */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">chain_id</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">chain_id</span> <span class="o">&gt;=</span> <span class="n">dma_lch_count</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Invalid chain id</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if the chain exists */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_linked_lch</span><span class="p">[</span><span class="n">chain_id</span><span class="p">].</span><span class="n">linked_dmach_q</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Chain doesn&#39;t exists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">channels</span> <span class="o">=</span> <span class="n">dma_linked_lch</span><span class="p">[</span><span class="n">chain_id</span><span class="p">].</span><span class="n">linked_dmach_q</span><span class="p">;</span>

	<span class="cm">/* Get the current channel */</span>
	<span class="n">lch</span> <span class="o">=</span> <span class="n">channels</span><span class="p">[</span><span class="n">dma_linked_lch</span><span class="p">[</span><span class="n">chain_id</span><span class="p">].</span><span class="n">q_head</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CSAC</span><span class="p">,</span> <span class="n">lch</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">omap_get_dma_chain_src_pos</span><span class="p">);</span>
<span class="cp">#endif	</span><span class="cm">/* ifndef CONFIG_ARCH_OMAP1 */</span><span class="cp"></span>

<span class="cm">/*----------------------------------------------------------------------------*/</span>

<span class="cp">#ifdef CONFIG_ARCH_OMAP1</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap1_dma_handle_ch</span><span class="p">(</span><span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">csr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable_1510_mode</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">csr</span> <span class="o">=</span> <span class="n">dma_chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">saved_csr</span><span class="p">;</span>
		<span class="n">dma_chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">saved_csr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">csr</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CSR</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable_1510_mode</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">csr</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_chan</span><span class="p">[</span><span class="n">ch</span> <span class="o">+</span> <span class="mi">6</span><span class="p">].</span><span class="n">saved_csr</span> <span class="o">=</span> <span class="n">csr</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">;</span>
		<span class="n">csr</span> <span class="o">&amp;=</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">dma_chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">dev_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Spurious interrupt from DMA channel &quot;</span>
		       <span class="s">&quot;%d (CSR %04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">csr</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">OMAP1_DMA_TOUT_IRQ</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;DMA timeout with device %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dma_chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">dev_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">OMAP_DMA_DROP_IRQ</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;DMA synchronization event drop occurred &quot;</span>
		       <span class="s">&quot;with device %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dma_chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">dev_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">OMAP_DMA_BLOCK_IRQ</span><span class="p">))</span>
		<span class="n">dma_chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OMAP_DMA_ACTIVE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">dma_chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">callback</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">dma_chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">callback</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">csr</span><span class="p">,</span> <span class="n">dma_chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">omap1_dma_irq_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ch</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">dev_id</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">handled_now</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">handled_now</span> <span class="o">+=</span> <span class="n">omap1_dma_handle_ch</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enable_1510_mode</span> <span class="o">&amp;&amp;</span> <span class="n">dma_chan</span><span class="p">[</span><span class="n">ch</span> <span class="o">+</span> <span class="mi">6</span><span class="p">].</span><span class="n">saved_csr</span><span class="p">)</span>
			<span class="n">handled_now</span> <span class="o">+=</span> <span class="n">omap1_dma_handle_ch</span><span class="p">(</span><span class="n">ch</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handled_now</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">handled</span> <span class="o">+=</span> <span class="n">handled_now</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">handled</span> <span class="o">?</span> <span class="n">IRQ_HANDLED</span> <span class="o">:</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="cp">#define omap1_dma_irq_handler	NULL</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_ARCH_OMAP2PLUS</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap2_dma_handle_ch</span><span class="p">(</span><span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CSR</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">printk_ratelimit</span><span class="p">())</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Spurious DMA IRQ for lch %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ch</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ch</span><span class="p">,</span> <span class="n">IRQSTATUS_L0</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">dma_chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">dev_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">printk_ratelimit</span><span class="p">())</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;IRQ %04x for non-allocated DMA&quot;</span>
					<span class="s">&quot;channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">OMAP_DMA_DROP_IRQ</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		       <span class="s">&quot;DMA synchronization event drop occurred with device &quot;</span>
		       <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dma_chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">dev_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">OMAP2_DMA_TRANS_ERR_IRQ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DMA transaction error with device %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dma_chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">dev_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_DMA_ERRATA</span><span class="p">(</span><span class="n">DMA_ERRATA_i378</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">ccr</span><span class="p">;</span>

			<span class="n">ccr</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CCR</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
			<span class="n">ccr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OMAP_DMA_CCR_EN</span><span class="p">;</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">ccr</span><span class="p">,</span> <span class="n">CCR</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
			<span class="n">dma_chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OMAP_DMA_ACTIVE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">OMAP2_DMA_SECURE_ERR_IRQ</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DMA secure error with device %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dma_chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">dev_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">OMAP2_DMA_MISALIGNED_ERR_IRQ</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DMA misaligned error with device %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dma_chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">dev_id</span><span class="p">);</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">CSR</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ch</span><span class="p">,</span> <span class="n">IRQSTATUS_L0</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="cm">/* read back the register to flush the write */</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">IRQSTATUS_L0</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>

	<span class="cm">/* If the ch is not chained then chain_id will be -1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">chain_id</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">chain_id</span> <span class="o">=</span> <span class="n">dma_chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">chain_id</span><span class="p">;</span>
		<span class="n">dma_chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">DMA_CH_NOTSTARTED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CLNK_CTRL</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">))</span>
			<span class="n">dma_chan</span><span class="p">[</span><span class="n">dma_chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">next_linked_ch</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span>
							<span class="n">DMA_CH_STARTED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_linked_lch</span><span class="p">[</span><span class="n">chain_id</span><span class="p">].</span><span class="n">chain_mode</span> <span class="o">==</span>
						<span class="n">OMAP_DMA_DYNAMIC_CHAIN</span><span class="p">)</span>
			<span class="n">disable_lnk</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">OMAP_DMA_CHAIN_QEMPTY</span><span class="p">(</span><span class="n">chain_id</span><span class="p">))</span>
			<span class="n">OMAP_DMA_CHAIN_INCQHEAD</span><span class="p">(</span><span class="n">chain_id</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">CSR</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">CSR</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">dma_chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">callback</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">dma_chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">callback</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">dma_chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* STATUS register count is from 1-32 while our is 0-31 */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">omap2_dma_irq_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">enable_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">IRQSTATUS_L0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">printk_ratelimit</span><span class="p">())</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Spurious DMA IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">enable_reg</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">IRQENABLE_L0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="n">enable_reg</span><span class="p">;</span> <span class="cm">/* Dispatch only relevant interrupts */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dma_lch_count</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">omap2_dma_handle_ch</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irqaction</span> <span class="n">omap24xx_dma_irq</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;DMA&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">omap2_dma_irq_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IRQF_DISABLED</span>
<span class="p">};</span>

<span class="cp">#else</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">irqaction</span> <span class="n">omap24xx_dma_irq</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cm">/*----------------------------------------------------------------------------*/</span>

<span class="kt">void</span> <span class="nf">omap_dma_global_context_save</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">omap_dma_global_context</span><span class="p">.</span><span class="n">dma_irqenable_l0</span> <span class="o">=</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">IRQENABLE_L0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">omap_dma_global_context</span><span class="p">.</span><span class="n">dma_ocp_sysconfig</span> <span class="o">=</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">OCP_SYSCONFIG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">omap_dma_global_context</span><span class="p">.</span><span class="n">dma_gcr</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_read</span><span class="p">(</span><span class="n">GCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">omap_dma_global_context_restore</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ch</span><span class="p">;</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">omap_dma_global_context</span><span class="p">.</span><span class="n">dma_gcr</span><span class="p">,</span> <span class="n">GCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">omap_dma_global_context</span><span class="p">.</span><span class="n">dma_ocp_sysconfig</span><span class="p">,</span>
		<span class="n">OCP_SYSCONFIG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="n">omap_dma_global_context</span><span class="p">.</span><span class="n">dma_irqenable_l0</span><span class="p">,</span>
		<span class="n">IRQENABLE_L0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_DMA_ERRATA</span><span class="p">(</span><span class="n">DMA_ROMCODE_BUG</span><span class="p">))</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_write</span><span class="p">(</span><span class="mh">0x3</span> <span class="p">,</span> <span class="n">IRQSTATUS_L0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="n">dma_chan_count</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">dev_id</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">omap_clear_dma</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">omap_system_dma_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ch</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dma_irq</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">irq_name</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">irq_rel</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: System DMA initialized without&quot;</span>
			<span class="s">&quot;platform data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">d</span>			<span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma_attr</span><span class="p">;</span>
	<span class="n">errata</span>			<span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">errata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">dev_caps</span> <span class="o">&amp;</span> <span class="n">RESERVE_CHANNEL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">omap_dma_reserve_channels</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">omap_dma_reserve_channels</span> <span class="o">&lt;=</span> <span class="n">dma_lch_count</span><span class="p">))</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">lch_count</span>	<span class="o">=</span> <span class="n">omap_dma_reserve_channels</span><span class="p">;</span>

	<span class="n">dma_lch_count</span>		<span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">lch_count</span><span class="p">;</span>
	<span class="n">dma_chan_count</span>		<span class="o">=</span> <span class="n">dma_lch_count</span><span class="p">;</span>
	<span class="n">dma_chan</span>		<span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">;</span>
	<span class="n">enable_1510_mode</span>	<span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">dev_caps</span> <span class="o">&amp;</span> <span class="n">ENABLE_1510_MODE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap2</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">dma_linked_lch</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_link_info</span><span class="p">)</span> <span class="o">*</span>
						<span class="n">dma_lch_count</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma_linked_lch</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit_dma_lch_fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_chan_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="n">dma_chan_count</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">omap_clear_dma</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap2</span><span class="p">())</span>
			<span class="n">omap2_disable_irq_lch</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>

		<span class="n">dma_chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">dev_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">dma_chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">next_lch</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&gt;=</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="n">enable_1510_mode</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap1</span><span class="p">())</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * request_irq() doesn&#39;t like dev_id (ie. ch) being</span>
<span class="cm">			 * zero, so we have to kludge around this.</span>
<span class="cm">			 */</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irq_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
			<span class="n">dma_irq</span> <span class="o">=</span> <span class="n">platform_get_irq_byname</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">irq_name</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dma_irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">dma_irq</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">exit_dma_irq_fail</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* INT_DMA_LCD is handled in lcd_dma.c */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dma_irq</span> <span class="o">==</span> <span class="n">INT_DMA_LCD</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">dma_irq</span><span class="p">,</span>
					<span class="n">omap1_dma_irq_handler</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;DMA&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">ch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">exit_dma_irq_fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap2</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cpu_is_omap242x</span><span class="p">())</span>
		<span class="n">omap_dma_set_global_params</span><span class="p">(</span><span class="n">DMA_DEFAULT_ARB_RATE</span><span class="p">,</span>
				<span class="n">DMA_DEFAULT_FIFO_DEPTH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap2</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">irq_name</span><span class="p">,</span> <span class="s">&quot;0&quot;</span><span class="p">);</span>
		<span class="n">dma_irq</span> <span class="o">=</span> <span class="n">platform_get_irq_byname</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">irq_name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed: request IRQ %d&quot;</span><span class="p">,</span> <span class="n">dma_irq</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">exit_dma_lch_fail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">setup_irq</span><span class="p">(</span><span class="n">dma_irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">omap24xx_dma_irq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;set_up failed for IRQ %d&quot;</span>
				<span class="s">&quot;for DMA (error %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dma_irq</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">exit_dma_lch_fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* reserve dma channels 0 and 1 in high security devices */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap34xx</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">omap_type</span><span class="p">()</span> <span class="o">!=</span> <span class="n">OMAP2_DEVICE_TYPE_GP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Reserving DMA channels 0 and 1 for &quot;</span>
				<span class="s">&quot;HS ROM code</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dma_chan</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dev_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dma_chan</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">dev_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">show_dma_caps</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">exit_dma_irq_fail:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to request IRQ %d&quot;</span>
			<span class="s">&quot;for DMA (error %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dma_irq</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">irq_rel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">irq_rel</span> <span class="o">&lt;</span> <span class="n">ch</span><span class="p">;</span>	<span class="n">irq_rel</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">irq_rel</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">dma_irq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">irq_rel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span>

<span class="nl">exit_dma_lch_fail:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dma_chan</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">omap_system_dma_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dma_irq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap2</span><span class="p">())</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">irq_name</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">irq_name</span><span class="p">,</span> <span class="s">&quot;0&quot;</span><span class="p">);</span>
		<span class="n">dma_irq</span> <span class="o">=</span> <span class="n">platform_get_irq_byname</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">irq_name</span><span class="p">);</span>
		<span class="n">remove_irq</span><span class="p">(</span><span class="n">dma_irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">omap24xx_dma_irq</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">irq_rel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">irq_rel</span> <span class="o">&lt;</span> <span class="n">dma_chan_count</span><span class="p">;</span> <span class="n">irq_rel</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma_irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">irq_rel</span><span class="p">);</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">dma_irq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">irq_rel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dma_chan</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">omap_system_dma_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">omap_system_dma_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">omap_system_dma_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;omap_dma_system&quot;</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">omap_system_dma_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_system_dma_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">arch_initcall</span><span class="p">(</span><span class="n">omap_system_dma_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">omap_system_dma_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">omap_system_dma_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;OMAP SYSTEM DMA DRIVER&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:&quot;</span> <span class="n">DRIVER_NAME</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Texas Instruments Inc&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Reserve the omap SDMA channels using cmdline bootarg</span>
<span class="cm"> * &quot;omap_dma_reserve_ch=&quot;. The valid range is 1 to 32</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">omap_dma_cmdline_reserve_ch</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_option</span><span class="p">(</span><span class="o">&amp;</span><span class="n">str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">omap_dma_reserve_channels</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">omap_dma_reserve_channels</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;omap_dma_reserve_ch=&quot;</span><span class="p">,</span> <span class="n">omap_dma_cmdline_reserve_ch</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
