<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › plat-omap › include › plat › dmtimer.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>dmtimer.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * arch/arm/plat-omap/include/plat/dmtimer.h</span>
<span class="cm"> *</span>
<span class="cm"> * OMAP Dual-Mode Timers</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2010 Texas Instruments Incorporated - http://www.ti.com/</span>
<span class="cm"> * Tarun Kanti DebBarma &lt;tarun.kanti@ti.com&gt;</span>
<span class="cm"> * Thara Gopinath &lt;thara@ti.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Platform device conversion and hwmod support.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005 Nokia Corporation</span>
<span class="cm"> * Author: Lauri Leukkunen &lt;lauri.leukkunen@nokia.com&gt;</span>
<span class="cm"> * PWM and clock framwork support by Timo Teras.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License as published by the</span>
<span class="cm"> * Free Software Foundation; either version 2 of the License, or (at your</span>
<span class="cm"> * option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED ``AS IS&#39;&#39; AND ANY EXPRESS OR IMPLIED</span>
<span class="cm"> * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN</span>
<span class="cm"> * NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<span class="cm"> * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT</span>
<span class="cm"> * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="cm"> * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF</span>
<span class="cm"> * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the  GNU General Public License along</span>
<span class="cm"> * with this program; if not, write  to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>

<span class="cp">#ifndef __ASM_ARCH_DMTIMER_H</span>
<span class="cp">#define __ASM_ARCH_DMTIMER_H</span>

<span class="cm">/* clock sources */</span>
<span class="cp">#define OMAP_TIMER_SRC_SYS_CLK			0x00</span>
<span class="cp">#define OMAP_TIMER_SRC_32_KHZ			0x01</span>
<span class="cp">#define OMAP_TIMER_SRC_EXT_CLK			0x02</span>

<span class="cm">/* timer interrupt enable bits */</span>
<span class="cp">#define OMAP_TIMER_INT_CAPTURE			(1 &lt;&lt; 2)</span>
<span class="cp">#define OMAP_TIMER_INT_OVERFLOW			(1 &lt;&lt; 1)</span>
<span class="cp">#define OMAP_TIMER_INT_MATCH			(1 &lt;&lt; 0)</span>

<span class="cm">/* trigger types */</span>
<span class="cp">#define OMAP_TIMER_TRIGGER_NONE			0x00</span>
<span class="cp">#define OMAP_TIMER_TRIGGER_OVERFLOW		0x01</span>
<span class="cp">#define OMAP_TIMER_TRIGGER_OVERFLOW_AND_COMPARE	0x02</span>

<span class="cm">/*</span>
<span class="cm"> * IP revision identifier so that Highlander IP</span>
<span class="cm"> * in OMAP4 can be distinguished.</span>
<span class="cm"> */</span>
<span class="cp">#define OMAP_TIMER_IP_VERSION_1                        0x1</span>

<span class="cm">/* timer capabilities used in hwmod database */</span>
<span class="cp">#define OMAP_TIMER_SECURE				0x80000000</span>
<span class="cp">#define OMAP_TIMER_ALWON				0x40000000</span>
<span class="cp">#define OMAP_TIMER_HAS_PWM				0x20000000</span>

<span class="k">struct</span> <span class="n">omap_timer_capability_dev_attr</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">timer_capability</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">omap_dm_timer</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">clk</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">timer_regs</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">tidr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tistat</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tisr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tier</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">twer</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tclr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tcrr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tldr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ttrg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">twps</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmar</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tcar1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tsicr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tcar2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tpir</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tnir</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tcvr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tocr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">towr</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dmtimer_platform_data</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">set_timer_src</span><span class="p">)(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">source</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">timer_ip_version</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">needs_manual_reset</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">reserved</span><span class="p">;</span>

	<span class="n">bool</span> <span class="n">loses_context</span><span class="p">;</span>

	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">get_context_loss_count</span><span class="p">)(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">omap_dm_timer</span> <span class="o">*</span><span class="n">omap_dm_timer_request</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">omap_dm_timer</span> <span class="o">*</span><span class="n">omap_dm_timer_request_specific</span><span class="p">(</span><span class="kt">int</span> <span class="n">timer_id</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">omap_dm_timer_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dm_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">omap_dm_timer_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dm_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">omap_dm_timer_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dm_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">omap_dm_timer_get_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dm_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">);</span>

<span class="n">u32</span> <span class="n">omap_dm_timer_modify_idlect_mask</span><span class="p">(</span><span class="n">u32</span> <span class="n">inputmask</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">omap_dm_timer_get_fclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dm_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">omap_dm_timer_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dm_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">omap_dm_timer_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dm_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">omap_dm_timer_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dm_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">omap_dm_timer_set_source</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dm_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">source</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">omap_dm_timer_set_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dm_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">autoreload</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">omap_dm_timer_set_load_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dm_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">autoreload</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">omap_dm_timer_set_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dm_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">match</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">omap_dm_timer_set_pwm</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dm_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">def_on</span><span class="p">,</span> <span class="kt">int</span> <span class="n">toggle</span><span class="p">,</span> <span class="kt">int</span> <span class="n">trigger</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">omap_dm_timer_set_prescaler</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dm_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prescaler</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">omap_dm_timer_set_int_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dm_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">omap_dm_timer_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dm_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">omap_dm_timer_write_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dm_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">);</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">omap_dm_timer_read_counter</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dm_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">omap_dm_timer_write_counter</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dm_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">omap_dm_timers_active</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Do not use the defines below, they are not needed. They should be only</span>
<span class="cm"> * used by dmtimer.c and sys_timer related code.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * The interrupt registers are different between v1 and v2 ip.</span>
<span class="cm"> * These registers are offsets from timer-&gt;iobase.</span>
<span class="cm"> */</span>
<span class="cp">#define OMAP_TIMER_ID_OFFSET		0x00</span>
<span class="cp">#define OMAP_TIMER_OCP_CFG_OFFSET	0x10</span>

<span class="cp">#define OMAP_TIMER_V1_SYS_STAT_OFFSET	0x14</span>
<span class="cp">#define OMAP_TIMER_V1_STAT_OFFSET	0x18</span>
<span class="cp">#define OMAP_TIMER_V1_INT_EN_OFFSET	0x1c</span>

<span class="cp">#define OMAP_TIMER_V2_IRQSTATUS_RAW	0x24</span>
<span class="cp">#define OMAP_TIMER_V2_IRQSTATUS		0x28</span>
<span class="cp">#define OMAP_TIMER_V2_IRQENABLE_SET	0x2c</span>
<span class="cp">#define OMAP_TIMER_V2_IRQENABLE_CLR	0x30</span>

<span class="cm">/*</span>
<span class="cm"> * The functional registers have a different base on v1 and v2 ip.</span>
<span class="cm"> * These registers are offsets from timer-&gt;func_base. The func_base</span>
<span class="cm"> * is samae as io_base for v1 and io_base + 0x14 for v2 ip.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#define OMAP_TIMER_V2_FUNC_OFFSET		0x14</span>

<span class="cp">#define _OMAP_TIMER_WAKEUP_EN_OFFSET	0x20</span>
<span class="cp">#define _OMAP_TIMER_CTRL_OFFSET		0x24</span>
<span class="cp">#define		OMAP_TIMER_CTRL_GPOCFG		(1 &lt;&lt; 14)</span>
<span class="cp">#define		OMAP_TIMER_CTRL_CAPTMODE	(1 &lt;&lt; 13)</span>
<span class="cp">#define		OMAP_TIMER_CTRL_PT		(1 &lt;&lt; 12)</span>
<span class="cp">#define		OMAP_TIMER_CTRL_TCM_LOWTOHIGH	(0x1 &lt;&lt; 8)</span>
<span class="cp">#define		OMAP_TIMER_CTRL_TCM_HIGHTOLOW	(0x2 &lt;&lt; 8)</span>
<span class="cp">#define		OMAP_TIMER_CTRL_TCM_BOTHEDGES	(0x3 &lt;&lt; 8)</span>
<span class="cp">#define		OMAP_TIMER_CTRL_SCPWM		(1 &lt;&lt; 7)</span>
<span class="cp">#define		OMAP_TIMER_CTRL_CE		(1 &lt;&lt; 6) </span><span class="cm">/* compare enable */</span><span class="cp"></span>
<span class="cp">#define		OMAP_TIMER_CTRL_PRE		(1 &lt;&lt; 5) </span><span class="cm">/* prescaler enable */</span><span class="cp"></span>
<span class="cp">#define		OMAP_TIMER_CTRL_PTV_SHIFT	2 </span><span class="cm">/* prescaler value shift */</span><span class="cp"></span>
<span class="cp">#define		OMAP_TIMER_CTRL_POSTED		(1 &lt;&lt; 2)</span>
<span class="cp">#define		OMAP_TIMER_CTRL_AR		(1 &lt;&lt; 1) </span><span class="cm">/* auto-reload enable */</span><span class="cp"></span>
<span class="cp">#define		OMAP_TIMER_CTRL_ST		(1 &lt;&lt; 0) </span><span class="cm">/* start timer */</span><span class="cp"></span>
<span class="cp">#define _OMAP_TIMER_COUNTER_OFFSET	0x28</span>
<span class="cp">#define _OMAP_TIMER_LOAD_OFFSET		0x2c</span>
<span class="cp">#define _OMAP_TIMER_TRIGGER_OFFSET	0x30</span>
<span class="cp">#define _OMAP_TIMER_WRITE_PEND_OFFSET	0x34</span>
<span class="cp">#define		WP_NONE			0	</span><span class="cm">/* no write pending bit */</span><span class="cp"></span>
<span class="cp">#define		WP_TCLR			(1 &lt;&lt; 0)</span>
<span class="cp">#define		WP_TCRR			(1 &lt;&lt; 1)</span>
<span class="cp">#define		WP_TLDR			(1 &lt;&lt; 2)</span>
<span class="cp">#define		WP_TTGR			(1 &lt;&lt; 3)</span>
<span class="cp">#define		WP_TMAR			(1 &lt;&lt; 4)</span>
<span class="cp">#define		WP_TPIR			(1 &lt;&lt; 5)</span>
<span class="cp">#define		WP_TNIR			(1 &lt;&lt; 6)</span>
<span class="cp">#define		WP_TCVR			(1 &lt;&lt; 7)</span>
<span class="cp">#define		WP_TOCR			(1 &lt;&lt; 8)</span>
<span class="cp">#define		WP_TOWR			(1 &lt;&lt; 9)</span>
<span class="cp">#define _OMAP_TIMER_MATCH_OFFSET	0x38</span>
<span class="cp">#define _OMAP_TIMER_CAPTURE_OFFSET	0x3c</span>
<span class="cp">#define _OMAP_TIMER_IF_CTRL_OFFSET	0x40</span>
<span class="cp">#define _OMAP_TIMER_CAPTURE2_OFFSET		0x44	</span><span class="cm">/* TCAR2, 34xx only */</span><span class="cp"></span>
<span class="cp">#define _OMAP_TIMER_TICK_POS_OFFSET		0x48	</span><span class="cm">/* TPIR, 34xx only */</span><span class="cp"></span>
<span class="cp">#define _OMAP_TIMER_TICK_NEG_OFFSET		0x4c	</span><span class="cm">/* TNIR, 34xx only */</span><span class="cp"></span>
<span class="cp">#define _OMAP_TIMER_TICK_COUNT_OFFSET		0x50	</span><span class="cm">/* TCVR, 34xx only */</span><span class="cp"></span>
<span class="cp">#define _OMAP_TIMER_TICK_INT_MASK_SET_OFFSET	0x54	</span><span class="cm">/* TOCR, 34xx only */</span><span class="cp"></span>
<span class="cp">#define _OMAP_TIMER_TICK_INT_MASK_COUNT_OFFSET	0x58	</span><span class="cm">/* TOWR, 34xx only */</span><span class="cp"></span>

<span class="cm">/* register offsets with the write pending bit encoded */</span>
<span class="cp">#define	WPSHIFT					16</span>

<span class="cp">#define OMAP_TIMER_WAKEUP_EN_REG		(_OMAP_TIMER_WAKEUP_EN_OFFSET \</span>
<span class="cp">							| (WP_NONE &lt;&lt; WPSHIFT))</span>

<span class="cp">#define OMAP_TIMER_CTRL_REG			(_OMAP_TIMER_CTRL_OFFSET \</span>
<span class="cp">							| (WP_TCLR &lt;&lt; WPSHIFT))</span>

<span class="cp">#define OMAP_TIMER_COUNTER_REG			(_OMAP_TIMER_COUNTER_OFFSET \</span>
<span class="cp">							| (WP_TCRR &lt;&lt; WPSHIFT))</span>

<span class="cp">#define OMAP_TIMER_LOAD_REG			(_OMAP_TIMER_LOAD_OFFSET \</span>
<span class="cp">							| (WP_TLDR &lt;&lt; WPSHIFT))</span>

<span class="cp">#define OMAP_TIMER_TRIGGER_REG			(_OMAP_TIMER_TRIGGER_OFFSET \</span>
<span class="cp">							| (WP_TTGR &lt;&lt; WPSHIFT))</span>

<span class="cp">#define OMAP_TIMER_WRITE_PEND_REG		(_OMAP_TIMER_WRITE_PEND_OFFSET \</span>
<span class="cp">							| (WP_NONE &lt;&lt; WPSHIFT))</span>

<span class="cp">#define OMAP_TIMER_MATCH_REG			(_OMAP_TIMER_MATCH_OFFSET \</span>
<span class="cp">							| (WP_TMAR &lt;&lt; WPSHIFT))</span>

<span class="cp">#define OMAP_TIMER_CAPTURE_REG			(_OMAP_TIMER_CAPTURE_OFFSET \</span>
<span class="cp">							| (WP_NONE &lt;&lt; WPSHIFT))</span>

<span class="cp">#define OMAP_TIMER_IF_CTRL_REG			(_OMAP_TIMER_IF_CTRL_OFFSET \</span>
<span class="cp">							| (WP_NONE &lt;&lt; WPSHIFT))</span>

<span class="cp">#define OMAP_TIMER_CAPTURE2_REG			(_OMAP_TIMER_CAPTURE2_OFFSET \</span>
<span class="cp">							| (WP_NONE &lt;&lt; WPSHIFT))</span>

<span class="cp">#define OMAP_TIMER_TICK_POS_REG			(_OMAP_TIMER_TICK_POS_OFFSET \</span>
<span class="cp">							| (WP_TPIR &lt;&lt; WPSHIFT))</span>

<span class="cp">#define OMAP_TIMER_TICK_NEG_REG			(_OMAP_TIMER_TICK_NEG_OFFSET \</span>
<span class="cp">							| (WP_TNIR &lt;&lt; WPSHIFT))</span>

<span class="cp">#define OMAP_TIMER_TICK_COUNT_REG		(_OMAP_TIMER_TICK_COUNT_OFFSET \</span>
<span class="cp">							| (WP_TCVR &lt;&lt; WPSHIFT))</span>

<span class="cp">#define OMAP_TIMER_TICK_INT_MASK_SET_REG				\</span>
<span class="cp">		(_OMAP_TIMER_TICK_INT_MASK_SET_OFFSET | (WP_TOCR &lt;&lt; WPSHIFT))</span>

<span class="cp">#define OMAP_TIMER_TICK_INT_MASK_COUNT_REG				\</span>
<span class="cp">		(_OMAP_TIMER_TICK_INT_MASK_COUNT_OFFSET | (WP_TOWR &lt;&lt; WPSHIFT))</span>

<span class="k">struct</span> <span class="n">omap_dm_timer</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">phys_base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">fclk</span><span class="p">;</span>

	<span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">io_base</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">sys_stat</span><span class="p">;</span>	<span class="cm">/* TISTAT timer status */</span>
	<span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">irq_stat</span><span class="p">;</span>	<span class="cm">/* TISR/IRQSTATUS interrupt status */</span>
	<span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">irq_ena</span><span class="p">;</span>	<span class="cm">/* irq enable */</span>
	<span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">irq_dis</span><span class="p">;</span>	<span class="cm">/* irq disable, only on v2 ip */</span>
	<span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">pend</span><span class="p">;</span>		<span class="cm">/* write pending */</span>
	<span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">func_base</span><span class="p">;</span>	<span class="cm">/* function register base */</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">reserved</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">posted</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_regs</span> <span class="n">context</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">loses_context</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ctx_loss_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">revision</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">node</span><span class="p">;</span>

	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">get_context_loss_count</span><span class="p">)(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">omap_dm_timer_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dm_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">__omap_dm_timer_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dm_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span>
						<span class="kt">int</span> <span class="n">posted</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">posted</span><span class="p">)</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">pend</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="n">WPSHIFT</span><span class="p">))</span>
			<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">func_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__omap_dm_timer_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dm_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">,</span>
					<span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">posted</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">posted</span><span class="p">)</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">pend</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="n">WPSHIFT</span><span class="p">))</span>
			<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">timer</span><span class="o">-&gt;</span><span class="n">func_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__omap_dm_timer_init_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dm_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tidr</span><span class="p">;</span>

	<span class="cm">/* Assume v1 ip if bits [31:16] are zero */</span>
	<span class="n">tidr</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tidr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">timer</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">timer</span><span class="o">-&gt;</span><span class="n">sys_stat</span> <span class="o">=</span> <span class="n">timer</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">+</span>
				<span class="n">OMAP_TIMER_V1_SYS_STAT_OFFSET</span><span class="p">;</span>
		<span class="n">timer</span><span class="o">-&gt;</span><span class="n">irq_stat</span> <span class="o">=</span> <span class="n">timer</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">+</span> <span class="n">OMAP_TIMER_V1_STAT_OFFSET</span><span class="p">;</span>
		<span class="n">timer</span><span class="o">-&gt;</span><span class="n">irq_ena</span> <span class="o">=</span> <span class="n">timer</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">+</span> <span class="n">OMAP_TIMER_V1_INT_EN_OFFSET</span><span class="p">;</span>
		<span class="n">timer</span><span class="o">-&gt;</span><span class="n">irq_dis</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">timer</span><span class="o">-&gt;</span><span class="n">pend</span> <span class="o">=</span> <span class="n">timer</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">+</span> <span class="n">_OMAP_TIMER_WRITE_PEND_OFFSET</span><span class="p">;</span>
		<span class="n">timer</span><span class="o">-&gt;</span><span class="n">func_base</span> <span class="o">=</span> <span class="n">timer</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">timer</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">timer</span><span class="o">-&gt;</span><span class="n">sys_stat</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">timer</span><span class="o">-&gt;</span><span class="n">irq_stat</span> <span class="o">=</span> <span class="n">timer</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">+</span> <span class="n">OMAP_TIMER_V2_IRQSTATUS</span><span class="p">;</span>
		<span class="n">timer</span><span class="o">-&gt;</span><span class="n">irq_ena</span> <span class="o">=</span> <span class="n">timer</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">+</span> <span class="n">OMAP_TIMER_V2_IRQENABLE_SET</span><span class="p">;</span>
		<span class="n">timer</span><span class="o">-&gt;</span><span class="n">irq_dis</span> <span class="o">=</span> <span class="n">timer</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">+</span> <span class="n">OMAP_TIMER_V2_IRQENABLE_CLR</span><span class="p">;</span>
		<span class="n">timer</span><span class="o">-&gt;</span><span class="n">pend</span> <span class="o">=</span> <span class="n">timer</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">+</span>
			<span class="n">_OMAP_TIMER_WRITE_PEND_OFFSET</span> <span class="o">+</span>
				<span class="n">OMAP_TIMER_V2_FUNC_OFFSET</span><span class="p">;</span>
		<span class="n">timer</span><span class="o">-&gt;</span><span class="n">func_base</span> <span class="o">=</span> <span class="n">timer</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">+</span> <span class="n">OMAP_TIMER_V2_FUNC_OFFSET</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Assumes the source clock has been set by caller */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__omap_dm_timer_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dm_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">autoidle</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wakeup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">+</span> <span class="n">OMAP_TIMER_OCP_CFG_OFFSET</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="mh">0x02</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>  <span class="cm">/* Set to smart-idle mode */</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="mh">0x2</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>   <span class="cm">/* Set clock activity to perserve f-clock on idle */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">autoidle</span><span class="p">)</span>
		<span class="n">l</span> <span class="o">|=</span> <span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wakeup</span><span class="p">)</span>
		<span class="n">l</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">timer</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">+</span> <span class="n">OMAP_TIMER_OCP_CFG_OFFSET</span><span class="p">);</span>

	<span class="cm">/* Match hardware reset default of posted mode */</span>
	<span class="n">__omap_dm_timer_write</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span> <span class="n">OMAP_TIMER_IF_CTRL_REG</span><span class="p">,</span>
					<span class="n">OMAP_TIMER_CTRL_POSTED</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">__omap_dm_timer_set_source</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">timer_fck</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">parent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">clk_disable</span><span class="p">(</span><span class="n">timer_fck</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">clk_set_parent</span><span class="p">(</span><span class="n">timer_fck</span><span class="p">,</span> <span class="n">parent</span><span class="p">);</span>
	<span class="n">clk_enable</span><span class="p">(</span><span class="n">timer_fck</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * When the functional clock disappears, too quick writes seem</span>
<span class="cm">	 * to cause an abort. XXX Is this still necessary?</span>
<span class="cm">	 */</span>
	<span class="n">__delay</span><span class="p">(</span><span class="mi">300000</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__omap_dm_timer_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dm_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">posted</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">l</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">__omap_dm_timer_read</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span> <span class="n">OMAP_TIMER_CTRL_REG</span><span class="p">,</span> <span class="n">posted</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&amp;</span> <span class="n">OMAP_TIMER_CTRL_ST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x1</span><span class="p">;</span>
		<span class="n">__omap_dm_timer_write</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span> <span class="n">OMAP_TIMER_CTRL_REG</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">posted</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ARCH_OMAP2PLUS</span>
		<span class="cm">/* Readback to make sure write has completed */</span>
		<span class="n">__omap_dm_timer_read</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span> <span class="n">OMAP_TIMER_CTRL_REG</span><span class="p">,</span> <span class="n">posted</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Wait for functional clock period x 3.5 to make sure that</span>
<span class="cm">		 * timer is stopped</span>
<span class="cm">		 */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">3500000</span> <span class="o">/</span> <span class="n">rate</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="cm">/* Ack possibly pending interrupt */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">OMAP_TIMER_INT_OVERFLOW</span><span class="p">,</span> <span class="n">timer</span><span class="o">-&gt;</span><span class="n">irq_stat</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__omap_dm_timer_load_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dm_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">,</span>
						<span class="n">u32</span> <span class="n">ctrl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">load</span><span class="p">,</span>
						<span class="kt">int</span> <span class="n">posted</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__omap_dm_timer_write</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span> <span class="n">OMAP_TIMER_COUNTER_REG</span><span class="p">,</span> <span class="n">load</span><span class="p">,</span> <span class="n">posted</span><span class="p">);</span>
	<span class="n">__omap_dm_timer_write</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span> <span class="n">OMAP_TIMER_CTRL_REG</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">posted</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__omap_dm_timer_int_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dm_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">,</span>
						<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">timer</span><span class="o">-&gt;</span><span class="n">irq_ena</span><span class="p">);</span>
	<span class="n">__omap_dm_timer_write</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span> <span class="n">OMAP_TIMER_WAKEUP_EN_REG</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">__omap_dm_timer_read_counter</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dm_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">posted</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__omap_dm_timer_read</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span> <span class="n">OMAP_TIMER_COUNTER_REG</span><span class="p">,</span> <span class="n">posted</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__omap_dm_timer_write_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_dm_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">,</span>
						<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">timer</span><span class="o">-&gt;</span><span class="n">irq_stat</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* __ASM_ARCH_DMTIMER_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
