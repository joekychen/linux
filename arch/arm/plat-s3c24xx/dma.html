<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › plat-s3c24xx › dma.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>dma.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* linux/arch/arm/plat-s3c24xx/dma.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2003-2006 Simtec Electronics</span>
<span class="cm"> *	Ben Dooks &lt;ben@simtec.co.uk&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * S3C2410 DMA core</span>
<span class="cm"> *</span>
<span class="cm"> * http://armlinux.simtec.co.uk/</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm">*/</span>


<span class="cp">#ifdef CONFIG_S3C2410_DMA_DEBUG</span>
<span class="cp">#define DEBUG</span>
<span class="cp">#endif</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/syscore_ops.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>

<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;mach/hardware.h&gt;</span>
<span class="cp">#include &lt;mach/dma.h&gt;</span>
<span class="cp">#include &lt;mach/map.h&gt;</span>

<span class="cp">#include &lt;plat/dma-s3c24xx.h&gt;</span>
<span class="cp">#include &lt;plat/regs-dma.h&gt;</span>

<span class="cm">/* io map for dma */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dma_base</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">dma_kmem</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">dma_channels</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">s3c24xx_dma_selection</span> <span class="n">dma_sel</span><span class="p">;</span>


<span class="cm">/* debugging functions */</span>

<span class="cp">#define BUF_MAGIC (0xcafebabe)</span>

<span class="cp">#define dmawarn(fmt...) printk(KERN_DEBUG fmt)</span>

<span class="cp">#define dma_regaddr(chan, reg) ((chan)-&gt;regs + (reg))</span>

<span class="cp">#if 1</span>
<span class="cp">#define dma_wrreg(chan, reg, val) writel((val), (chan)-&gt;regs + (reg))</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">dma_wrreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c2410_dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;writing %08x to register %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">val</span><span class="p">,</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">dma_regaddr</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">reg</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#define dma_rdreg(chan, reg) readl((chan)-&gt;regs + (reg))</span>

<span class="cm">/* captured register state for debug */</span>

<span class="k">struct</span> <span class="n">s3c2410_dma_regstate</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>         <span class="n">dcsrc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>         <span class="n">disrc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>         <span class="n">dstat</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>         <span class="n">dcon</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>         <span class="n">dmsktrig</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_S3C2410_DMA_DEBUG</span>

<span class="cm">/* dmadbg_showregs</span>
<span class="cm"> *</span>
<span class="cm"> * simple debug routine to print the current state of the dma registers</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dmadbg_capture</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c2410_dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s3c2410_dma_regstate</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">dcsrc</span>    <span class="o">=</span> <span class="n">dma_rdreg</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">S3C2410_DMA_DCSRC</span><span class="p">);</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">disrc</span>    <span class="o">=</span> <span class="n">dma_rdreg</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">S3C2410_DMA_DISRC</span><span class="p">);</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">dstat</span>    <span class="o">=</span> <span class="n">dma_rdreg</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">S3C2410_DMA_DSTAT</span><span class="p">);</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">dcon</span>     <span class="o">=</span> <span class="n">dma_rdreg</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">S3C2410_DMA_DCON</span><span class="p">);</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">dmsktrig</span> <span class="o">=</span> <span class="n">dma_rdreg</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">S3C2410_DMA_DMASKTRIG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dmadbg_dumpregs</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fname</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s3c2410_dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">s3c2410_dma_regstate</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;dma%d: %s:%d: DCSRC=%08lx, DISRC=%08lx, DSTAT=%08lx DMT=%02lx, DCON=%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">chan</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span>
	       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">dcsrc</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">disrc</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">dstat</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">dmsktrig</span><span class="p">,</span>
	       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">dcon</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dmadbg_showchan</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fname</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s3c2410_dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2410_dma_regstate</span> <span class="n">state</span><span class="p">;</span>

	<span class="n">dmadbg_capture</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;dma%d: %s:%d: ls=%d, cur=%p, %p %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">chan</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">load_state</span><span class="p">,</span>
	       <span class="n">chan</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">);</span>

	<span class="n">dmadbg_dumpregs</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dmadbg_showregs</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fname</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s3c2410_dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2410_dma_regstate</span> <span class="n">state</span><span class="p">;</span>

	<span class="n">dmadbg_capture</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">dmadbg_dumpregs</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define dbg_showregs(chan) dmadbg_showregs(__func__, __LINE__, (chan))</span>
<span class="cp">#define dbg_showchan(chan) dmadbg_showchan(__func__, __LINE__, (chan))</span>
<span class="cp">#else</span>
<span class="cp">#define dbg_showregs(chan) do { } while(0)</span>
<span class="cp">#define dbg_showchan(chan) do { } while(0)</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_S3C2410_DMA_DEBUG */</span><span class="cp"></span>

<span class="cm">/* s3c2410_dma_stats_timeout</span>
<span class="cm"> *</span>
<span class="cm"> * Update DMA stats from timeout info</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">s3c2410_dma_stats_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c2410_dma_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stats</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">timeout_longest</span><span class="p">)</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">timeout_longest</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">timeout_shortest</span><span class="p">)</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">timeout_shortest</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">timeout_avg</span> <span class="o">+=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* s3c2410_dma_waitforload</span>
<span class="cm"> *</span>
<span class="cm"> * wait for the DMA engine to load a buffer, and update the state accordingly</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">s3c2410_dma_waitforload</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c2410_dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">load_timeout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">took</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">load_state</span> <span class="o">!=</span> <span class="n">S3C2410_DMALOAD_1LOADED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dma%d: s3c2410_dma_waitforload() called in loadstate %d from line %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">load_state</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">stats</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">loads</span><span class="o">++</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dma_rdreg</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">S3C2410_DMA_DSTAT</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">32</span><span class="o">-</span><span class="mi">20</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">took</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">load_timeout</span> <span class="o">-</span> <span class="n">timeout</span><span class="p">;</span>

			<span class="n">s3c2410_dma_stats_timeout</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="n">took</span><span class="p">);</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">load_state</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">S3C2410_DMALOAD_1LOADED</span>:
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">load_state</span> <span class="o">=</span> <span class="n">S3C2410_DMALOAD_1RUNNING</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="nl">default:</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dma%d: unknown load_state in s3c2410_dma_waitforload() %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">load_state</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">stats</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">timeout_failed</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* s3c2410_dma_loadbuffer</span>
<span class="cm"> *</span>
<span class="cm"> * load a buffer, and update the channel state</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">s3c2410_dma_loadbuffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c2410_dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">s3c2410_dma_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reload</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmawarn</span><span class="p">(</span><span class="s">&quot;buffer is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;s3c2410_chan_loadbuffer: loading buff %p (0x%08lx,0x%06x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="cm">/* check the state of the channel before we do anything */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">load_state</span> <span class="o">==</span> <span class="n">S3C2410_DMALOAD_1LOADED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmawarn</span><span class="p">(</span><span class="s">&quot;load_state is S3C2410_DMALOAD_1LOADED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">load_state</span> <span class="o">==</span> <span class="n">S3C2410_DMALOAD_1LOADED_1RUNNING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmawarn</span><span class="p">(</span><span class="s">&quot;state is S3C2410_DMALOAD_1LOADED_1RUNNING</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* it would seem sensible if we are the last buffer to not bother</span>
<span class="cm">	 * with the auto-reload bit, so that the DMA engine will not try</span>
<span class="cm">	 * and load another transfer after this one has finished...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">load_state</span> <span class="o">==</span> <span class="n">S3C2410_DMALOAD_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;load_state is none, checking for noreload (next=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">buf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
		<span class="n">reload</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">?</span> <span class="n">S3C2410_DCON_NORELOAD</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>pr<em>debug("load</em>state is %d => autoreload\n", chan->load_state);</p></td><td class="code"><div class="highlight"><pre>		<span class="n">reload</span> <span class="o">=</span> <span class="n">S3C2410_DCON_AUTORELOAD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xf0000000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x30000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmawarn</span><span class="p">(</span><span class="s">&quot;dmaload: buffer is %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">addr_reg</span><span class="p">);</span>

	<span class="n">dma_wrreg</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">S3C2410_DMA_DCON</span><span class="p">,</span>
		  <span class="n">chan</span><span class="o">-&gt;</span><span class="n">dcon</span> <span class="o">|</span> <span class="n">reload</span> <span class="o">|</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">size</span><span class="o">/</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">xfer_unit</span><span class="p">));</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

	<span class="cm">/* update the state of the channel */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">load_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">S3C2410_DMALOAD_NONE</span>:
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">load_state</span> <span class="o">=</span> <span class="n">S3C2410_DMALOAD_1LOADED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">S3C2410_DMALOAD_1RUNNING</span>:
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">load_state</span> <span class="o">=</span> <span class="n">S3C2410_DMALOAD_1LOADED_1RUNNING</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dmawarn</span><span class="p">(</span><span class="s">&quot;dmaload: unknown state %d in loadbuffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">load_state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* s3c2410_dma_call_op</span>
<span class="cm"> *</span>
<span class="cm"> * small routine to call the op routine with the given op if it has been</span>
<span class="cm"> * registered</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">s3c2410_dma_call_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c2410_dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">enum</span> <span class="n">s3c2410_chan_op</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">op_fn</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">op_fn</span><span class="p">)(</span><span class="n">chan</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* s3c2410_dma_buffdone</span>
<span class="cm"> *</span>
<span class="cm"> * small wrapper to check if callback routine needs to be called, and</span>
<span class="cm"> * if so, call it</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">s3c2410_dma_buffdone</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c2410_dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s3c2410_dma_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		     <span class="k">enum</span> <span class="n">s3c2410_dma_buffresult</span> <span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	pr_debug(&quot;callback_fn=%p, buf=%p, id=%p, size=%d, result=%d\n&quot;,</span>
<span class="c">		 chan-&gt;callback_fn, buf, buf-&gt;id, buf-&gt;size, result);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">callback_fn</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">callback_fn</span><span class="p">)(</span><span class="n">chan</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* s3c2410_dma_start</span>
<span class="cm"> *</span>
<span class="cm"> * start a dma channel going</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c2410_dma_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c2410_dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;s3c2410_start_dma: channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">S3C2410_DMA_RUNNING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;s3c2410_start_dma: already running (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">S3C2410_DMA_RUNNING</span><span class="p">;</span>

	<span class="cm">/* check wether there is anything to load, and if not, see</span>
<span class="cm">	 * if we can find anything to load</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">load_state</span> <span class="o">==</span> <span class="n">S3C2410_DMALOAD_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dma%d: channel has nothing loaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">chan</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">S3C2410_DMA_IDLE</span><span class="p">;</span>
			<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">s3c2410_dma_loadbuffer</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dbg_showchan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="cm">/* enable the channel */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">irq_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">enable_irq</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">irq_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* start the channel going */</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">dma_rdreg</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">S3C2410_DMA_DMASKTRIG</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">S3C2410_DMASKTRIG_STOP</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">S3C2410_DMASKTRIG_ON</span><span class="p">;</span>
	<span class="n">dma_wrreg</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">S3C2410_DMA_DMASKTRIG</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dma%d: %08lx to DMASKTRIG</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* the dma buffer loads should take care of clearing the AUTO</span>
<span class="c">	 * reloading feature */</span>
<span class="c">	tmp = dma_rdreg(chan, S3C2410_DMA_DCON);</span>
<span class="c">	tmp &amp;= ~S3C2410_DCON_NORELOAD;</span>
<span class="c">	dma_wrreg(chan, S3C2410_DMA_DCON, tmp);</span>
<span class="cp">#endif</span>

	<span class="n">s3c2410_dma_call_op</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">S3C2410_DMAOP_START</span><span class="p">);</span>

	<span class="n">dbg_showchan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="cm">/* if we&#39;ve only loaded one buffer onto the channel, then chec</span>
<span class="cm">	 * to see if we have another, and if so, try and load it so when</span>
<span class="cm">	 * the first buffer is finished, the new one will be loaded onto</span>
<span class="cm">	 * the channel */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">load_state</span> <span class="o">==</span> <span class="n">S3C2410_DMALOAD_1LOADED</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">s3c2410_dma_waitforload</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: buff not yet loaded, no more todo</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">__func__</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">load_state</span> <span class="o">=</span> <span class="n">S3C2410_DMALOAD_1RUNNING</span><span class="p">;</span>
				<span class="n">s3c2410_dma_loadbuffer</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">load_state</span> <span class="o">==</span> <span class="n">S3C2410_DMALOAD_1RUNNING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s3c2410_dma_loadbuffer</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>


	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* s3c2410_dma_canload</span>
<span class="cm"> *</span>
<span class="cm"> * work out if we can queue another buffer into the DMA engine</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">s3c2410_dma_canload</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c2410_dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">load_state</span> <span class="o">==</span> <span class="n">S3C2410_DMALOAD_NONE</span> <span class="o">||</span>
	    <span class="n">chan</span><span class="o">-&gt;</span><span class="n">load_state</span> <span class="o">==</span> <span class="n">S3C2410_DMALOAD_1RUNNING</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* s3c2410_dma_enqueue</span>
<span class="cm"> *</span>
<span class="cm"> * queue an given buffer for dma transfer.</span>
<span class="cm"> *</span>
<span class="cm"> * id         the device driver&#39;s id information for this buffer</span>
<span class="cm"> * data       the physical address of the buffer data</span>
<span class="cm"> * size       the size of the buffer in bytes</span>
<span class="cm"> *</span>
<span class="cm"> * If the channel is not running, then the flag S3C2410_DMAF_AUTOSTART</span>
<span class="cm"> * is checked, and if set, the channel is started. If this flag isn&#39;t set,</span>
<span class="cm"> * then an error will be returned.</span>
<span class="cm"> *</span>
<span class="cm"> * It is possible to queue more than one DMA buffer onto a channel at</span>
<span class="cm"> * once, and the code will deal with the re-loading of the next buffer</span>
<span class="cm"> * when necessary.</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">s3c2410_dma_enqueue</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span>
			<span class="n">dma_addr_t</span> <span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2410_dma_chan</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">s3c_dma_lookup_channel</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s3c2410_dma_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: id=%p, data=%08x, size=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">__func__</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmem_cache_alloc</span><span class="p">(</span><span class="n">dma_kmem</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: out of memory (%ld alloc)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>pr<em>debug("%s: new buffer %p\n", <strong>func</strong>, buf);
dbg</em>showchan(chan);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">next</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">data</span>  <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">size</span>  <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">id</span>    <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">BUF_MAGIC</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">curr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we&#39;ve got nothing loaded... */</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: buffer %p queued onto empty channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">curr</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">end</span>  <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dma%d: %s: buffer %p queued onto non-empty channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">chan</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dma%d: %s: %p not empty, and chan-&gt;end==NULL?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">chan</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">end</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if necessary, update the next buffer field */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="cm">/* check to see if we can load a buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">S3C2410_DMA_RUNNING</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">load_state</span> <span class="o">==</span> <span class="n">S3C2410_DMALOAD_1LOADED</span> <span class="o">&amp;&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s3c2410_dma_waitforload</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dma%d: loadbuffer:&quot;</span>
				       <span class="s">&quot;timeout loading buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">chan</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
				<span class="n">dbg_showchan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
				<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">s3c2410_dma_canload</span><span class="p">(</span><span class="n">chan</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s3c2410_dma_loadbuffer</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">S3C2410_DMA_IDLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">S3C2410_DMAF_AUTOSTART</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s3c2410_dma_ctrl</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">|</span> <span class="n">DMACH_LOW_LEVEL</span><span class="p">,</span>
					 <span class="n">S3C2410_DMAOP_START</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">s3c2410_dma_enqueue</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">s3c2410_dma_freebuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c2410_dma_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">magicok</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">BUF_MAGIC</span><span class="p">);</span>

	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">magicok</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">dma_kmem</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;s3c2410_dma_freebuf: buff %p with bad magic</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* s3c2410_dma_lastxfer</span>
<span class="cm"> *</span>
<span class="cm"> * called when the system is out of buffers, to ensure that the channel</span>
<span class="cm"> * is prepared for shutdown.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">s3c2410_dma_lastxfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c2410_dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	pr_debug(&quot;dma%d: s3c2410_dma_lastxfer: load_state %d\n&quot;,</span>
<span class="c">		 chan-&gt;number, chan-&gt;load_state);</span>
<span class="cp">#endif</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">load_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">S3C2410_DMALOAD_NONE</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">S3C2410_DMALOAD_1LOADED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">s3c2410_dma_waitforload</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* flag error? */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dma%d: timeout waiting for load (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">chan</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">S3C2410_DMALOAD_1LOADED_1RUNNING</span>:
		<span class="cm">/* I believe in this case we do not have anything to do</span>
<span class="cm">		 * until the next buffer comes along, and we turn off the</span>
<span class="cm">		 * reload */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dma%d: lastxfer: unhandled load_state %d with no next</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">chan</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">load_state</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="cm">/* hopefully this&#39;ll shut the damned thing up after the transfer... */</span>
	<span class="n">dma_wrreg</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">S3C2410_DMA_DCON</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">dcon</span> <span class="o">|</span> <span class="n">S3C2410_DCON_NORELOAD</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#define dmadbg2(x...)</span>

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">s3c2410_dma_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">devpw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2410_dma_chan</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">s3c2410_dma_chan</span> <span class="o">*</span><span class="p">)</span><span class="n">devpw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c2410_dma_buf</span>  <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">;</span>

	<span class="n">dbg_showchan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="cm">/* modify the channel state */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">load_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">S3C2410_DMALOAD_1RUNNING</span>:
		<span class="cm">/* TODO - if we are running only one buffer, we probably</span>
<span class="cm">		 * want to reload here, and then worry about the buffer</span>
<span class="cm">		 * callback */</span>

		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">load_state</span> <span class="o">=</span> <span class="n">S3C2410_DMALOAD_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">S3C2410_DMALOAD_1LOADED</span>:
		<span class="cm">/* iirc, we should go back to NONE loaded here, we</span>
<span class="cm">		 * had a buffer, and it was never verified as being</span>
<span class="cm">		 * loaded.</span>
<span class="cm">		 */</span>

		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">load_state</span> <span class="o">=</span> <span class="n">S3C2410_DMALOAD_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">S3C2410_DMALOAD_1LOADED_1RUNNING</span>:
		<span class="cm">/* we&#39;ll worry about checking to see if another buffer is</span>
<span class="cm">		 * ready after we&#39;ve called back the owner. This should</span>
<span class="cm">		 * ensure we do not wait around too long for the DMA</span>
<span class="cm">		 * engine to start the next transfer</span>
<span class="cm">		 */</span>

		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">load_state</span> <span class="o">=</span> <span class="n">S3C2410_DMALOAD_1LOADED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">S3C2410_DMALOAD_NONE</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dma%d: IRQ with no loaded buffer?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">chan</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dma%d: IRQ in invalid load_state %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">chan</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">load_state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* update the chain to make sure that if we load any more</span>
<span class="cm">		 * buffers when we call the callback function, things should</span>
<span class="cm">		 * work properly */</span>

		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">curr</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">next</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">BUF_MAGIC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dma%d: %s: buf %p incorrect magic</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">chan</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">s3c2410_dma_buffdone</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">S3C2410_RES_OK</span><span class="p">);</span>

		<span class="cm">/* free resouces */</span>
		<span class="n">s3c2410_dma_freebuf</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="p">}</span>

	<span class="cm">/* only reload if the channel is still running... our buffer done</span>
<span class="cm">	 * routine may have altered the state by requesting the dma channel</span>
<span class="cm">	 * to stop or shutdown... */</span>

	<span class="cm">/* todo: check that when the channel is shut-down from inside this</span>
<span class="cm">	 * function, we cope with unsetting reload, etc */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">S3C2410_DMA_IDLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">load_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">S3C2410_DMALOAD_1RUNNING</span>:
			<span class="cm">/* don&#39;t need to do anything for this state */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">S3C2410_DMALOAD_NONE</span>:
			<span class="cm">/* can load buffer immediately */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">S3C2410_DMALOAD_1LOADED</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">s3c2410_dma_waitforload</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* flag error? */</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dma%d: timeout waiting for load (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">chan</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">S3C2410_DMALOAD_1LOADED_1RUNNING</span>:
			<span class="k">goto</span> <span class="n">no_load</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dma%d: unknown load_state in irq, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">chan</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">load_state</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">s3c2410_dma_loadbuffer</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">s3c2410_dma_lastxfer</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

		<span class="cm">/* see if we can stop this channel.. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">load_state</span> <span class="o">==</span> <span class="n">S3C2410_DMALOAD_NONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dma%d: end of transfer, stopping channel (%ld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">chan</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
			<span class="n">s3c2410_dma_ctrl</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">|</span> <span class="n">DMACH_LOW_LEVEL</span><span class="p">,</span>
					 <span class="n">S3C2410_DMAOP_STOP</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

 <span class="nl">no_load:</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">s3c2410_dma_chan</span> <span class="o">*</span><span class="n">s3c2410_dma_map_channel</span><span class="p">(</span><span class="kt">int</span> <span class="n">channel</span><span class="p">);</span>

<span class="cm">/* s3c2410_request_dma</span>
<span class="cm"> *</span>
<span class="cm"> * get control of an dma channel</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">s3c2410_dma_request</span><span class="p">(</span><span class="k">enum</span> <span class="n">dma_ch</span> <span class="n">channel</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">s3c2410_dma_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2410_dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dma%d: s3c2410_request_dma: client=%s, dev=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">channel</span><span class="p">,</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">s3c2410_dma_map_channel</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbg_showchan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">irq_claimed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dma%d: %s : requesting irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">channel</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">irq_claimed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">s3c2410_dma_irq</span><span class="p">,</span> <span class="n">IRQF_DISABLED</span><span class="p">,</span>
				  <span class="n">client</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">chan</span><span class="p">);</span>

		<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">irq_claimed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: cannot get IRQ %d for DMA %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">client</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">irq_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* need to setup */</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: channel initialised, %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">|</span> <span class="n">DMACH_LOW_LEVEL</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">s3c2410_dma_request</span><span class="p">);</span>

<span class="cm">/* s3c2410_dma_free</span>
<span class="cm"> *</span>
<span class="cm"> * release the given channel back to the system, will stop and flush</span>
<span class="cm"> * any outstanding transfers, and ensure the channel is ready for the</span>
<span class="cm"> * next claimant.</span>
<span class="cm"> *</span>
<span class="cm"> * Note, although a warning is currently printed if the freeing client</span>
<span class="cm"> * info is not the same as the registrant&#39;s client info, the free is still</span>
<span class="cm"> * allowed to go through.</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">s3c2410_dma_free</span><span class="p">(</span><span class="k">enum</span> <span class="n">dma_ch</span> <span class="n">channel</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s3c2410_dma_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2410_dma_chan</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">s3c_dma_lookup_channel</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">!=</span> <span class="n">client</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;dma%d: possible free from different client (channel %p, passed %p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">channel</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">client</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* sort out stopping and freeing the channel */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">S3C2410_DMA_IDLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: need to stop dma channel %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

		<span class="cm">/* possibly flush the channel */</span>
		<span class="n">s3c2410_dma_ctrl</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">S3C2410_DMAOP_STOP</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">irq_claimed</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">irq_claimed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="n">DMACH_LOW_LEVEL</span><span class="p">))</span>
		<span class="n">s3c_dma_chan_map</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">s3c2410_dma_free</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c2410_dma_dostop</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c2410_dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">dbg_showchan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">s3c2410_dma_call_op</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span>  <span class="n">S3C2410_DMAOP_STOP</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">dma_rdreg</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">S3C2410_DMA_DMASKTRIG</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">S3C2410_DMASKTRIG_STOP</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>tmp &amp;= ~S3C2410<em>DMASKTRIG</em>ON;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">dma_wrreg</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">S3C2410_DMA_DMASKTRIG</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* should also clear interrupts, according to WinCE BSP */</span>
<span class="c">	tmp = dma_rdreg(chan, S3C2410_DMA_DCON);</span>
<span class="c">	tmp |= S3C2410_DCON_NORELOAD;</span>
<span class="c">	dma_wrreg(chan, S3C2410_DMA_DCON, tmp);</span>
<span class="cp">#endif</span>

	<span class="cm">/* should stop do this, or should we wait for flush? */</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span>      <span class="o">=</span> <span class="n">S3C2410_DMA_IDLE</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">load_state</span> <span class="o">=</span> <span class="n">S3C2410_DMALOAD_NONE</span><span class="p">;</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c2410_dma_waitforstop</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c2410_dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">dma_rdreg</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">S3C2410_DMA_DMASKTRIG</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">S3C2410_DMASKTRIG_ON</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dma%d: failed to stop?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* s3c2410_dma_flush</span>
<span class="cm"> *</span>
<span class="cm"> * stop the channel, and remove all current and pending transfers</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c2410_dma_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c2410_dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2410_dma_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: chan %p (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="n">dbg_showchan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">S3C2410_DMA_IDLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: stopping channel...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
		<span class="n">s3c2410_dma_ctrl</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">S3C2410_DMAOP_STOP</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">curr</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">buf</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">next</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: free buffer %p, next %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>

			<span class="n">s3c2410_dma_buffdone</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">S3C2410_RES_ABORT</span><span class="p">);</span>
			<span class="n">s3c2410_dma_freebuf</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dbg_showregs</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">s3c2410_dma_waitforstop</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* should also clear interrupts, according to WinCE BSP */</span>
<span class="c">	{</span>
<span class="c">		unsigned long tmp;</span>

<span class="c">		tmp = dma_rdreg(chan, S3C2410_DMA_DCON);</span>
<span class="c">		tmp |= S3C2410_DCON_NORELOAD;</span>
<span class="c">		dma_wrreg(chan, S3C2410_DMA_DCON, tmp);</span>
<span class="c">	}</span>
<span class="cp">#endif</span>

	<span class="n">dbg_showregs</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c2410_dma_started</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c2410_dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">dbg_showchan</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="cm">/* if we&#39;ve only loaded one buffer onto the channel, then chec</span>
<span class="cm">	 * to see if we have another, and if so, try and load it so when</span>
<span class="cm">	 * the first buffer is finished, the new one will be loaded onto</span>
<span class="cm">	 * the channel */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">load_state</span> <span class="o">==</span> <span class="n">S3C2410_DMALOAD_1LOADED</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">s3c2410_dma_waitforload</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: buff not yet loaded, no more todo</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">__func__</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">load_state</span> <span class="o">=</span> <span class="n">S3C2410_DMALOAD_1RUNNING</span><span class="p">;</span>
				<span class="n">s3c2410_dma_loadbuffer</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">load_state</span> <span class="o">==</span> <span class="n">S3C2410_DMALOAD_1RUNNING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s3c2410_dma_loadbuffer</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>


	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">s3c2410_dma_ctrl</span><span class="p">(</span><span class="k">enum</span> <span class="n">dma_ch</span> <span class="n">channel</span><span class="p">,</span> <span class="k">enum</span> <span class="n">s3c2410_chan_op</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2410_dma_chan</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">s3c_dma_lookup_channel</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">S3C2410_DMAOP_START</span>:
		<span class="k">return</span> <span class="n">s3c2410_dma_start</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">S3C2410_DMAOP_STOP</span>:
		<span class="k">return</span> <span class="n">s3c2410_dma_dostop</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">S3C2410_DMAOP_PAUSE</span>:
	<span class="k">case</span> <span class="n">S3C2410_DMAOP_RESUME</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">S3C2410_DMAOP_FLUSH</span>:
		<span class="k">return</span> <span class="n">s3c2410_dma_flush</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">S3C2410_DMAOP_STARTED</span>:
		<span class="k">return</span> <span class="n">s3c2410_dma_started</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">S3C2410_DMAOP_TIMEOUT</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>      <span class="cm">/* unknown, don&#39;t bother */</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">s3c2410_dma_ctrl</span><span class="p">);</span>

<span class="cm">/* DMA configuration for each channel</span>
<span class="cm"> *</span>
<span class="cm"> * DISRCC -&gt; source of the DMA (AHB,APB)</span>
<span class="cm"> * DISRC  -&gt; source address of the DMA</span>
<span class="cm"> * DIDSTC -&gt; destination of the DMA (AHB,APD)</span>
<span class="cm"> * DIDST  -&gt; destination address of the DMA</span>
<span class="cm">*/</span>

<span class="cm">/* s3c2410_dma_config</span>
<span class="cm"> *</span>
<span class="cm"> * xfersize:     size of unit in bytes (1,2,4)</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">s3c2410_dma_config</span><span class="p">(</span><span class="k">enum</span> <span class="n">dma_ch</span> <span class="n">channel</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">xferunit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2410_dma_chan</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">s3c_dma_lookup_channel</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dcon</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: chan=%d, xfer_unit=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">xferunit</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dcon</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">dcon</span> <span class="o">&amp;</span> <span class="n">dma_sel</span><span class="p">.</span><span class="n">dcon_mask</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: dcon is %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dcon</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">req_ch</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DMACH_I2S_IN</span>:
	<span class="k">case</span> <span class="n">DMACH_I2S_OUT</span>:
	<span class="k">case</span> <span class="n">DMACH_PCM_IN</span>:
	<span class="k">case</span> <span class="n">DMACH_PCM_OUT</span>:
	<span class="k">case</span> <span class="n">DMACH_MIC_IN</span>:
	<span class="nl">default:</span>
		<span class="n">dcon</span> <span class="o">|=</span> <span class="n">S3C2410_DCON_HANDSHAKE</span><span class="p">;</span>
		<span class="n">dcon</span> <span class="o">|=</span> <span class="n">S3C2410_DCON_SYNC_PCLK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DMACH_SDI</span>:
		<span class="cm">/* note, ensure if need HANDSHAKE or not */</span>
		<span class="n">dcon</span> <span class="o">|=</span> <span class="n">S3C2410_DCON_SYNC_PCLK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DMACH_XD0</span>:
	<span class="k">case</span> <span class="n">DMACH_XD1</span>:
		<span class="n">dcon</span> <span class="o">|=</span> <span class="n">S3C2410_DCON_HANDSHAKE</span><span class="p">;</span>
		<span class="n">dcon</span> <span class="o">|=</span> <span class="n">S3C2410_DCON_SYNC_HCLK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">xferunit</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">dcon</span> <span class="o">|=</span> <span class="n">S3C2410_DCON_BYTE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">dcon</span> <span class="o">|=</span> <span class="n">S3C2410_DCON_HALFWORD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">dcon</span> <span class="o">|=</span> <span class="n">S3C2410_DCON_WORD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: bad transfer size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">xferunit</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dcon</span> <span class="o">|=</span> <span class="n">S3C2410_DCON_HWTRIG</span><span class="p">;</span>
	<span class="n">dcon</span> <span class="o">|=</span> <span class="n">S3C2410_DCON_INTREQ</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: dcon now %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dcon</span><span class="p">);</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">dcon</span> <span class="o">=</span> <span class="n">dcon</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">xfer_unit</span> <span class="o">=</span> <span class="n">xferunit</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">s3c2410_dma_config</span><span class="p">);</span>


<span class="cm">/* s3c2410_dma_devconfig</span>
<span class="cm"> *</span>
<span class="cm"> * configure the dma source/destination hardware type and address</span>
<span class="cm"> *</span>
<span class="cm"> * source:    DMA_FROM_DEVICE: source is hardware</span>
<span class="cm"> *            DMA_TO_DEVICE: source is memory</span>
<span class="cm"> *</span>
<span class="cm"> * devaddr:   physical address of the source</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">s3c2410_dma_devconfig</span><span class="p">(</span><span class="k">enum</span> <span class="n">dma_ch</span> <span class="n">channel</span><span class="p">,</span>
			  <span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">source</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">devaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2410_dma_chan</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">s3c_dma_lookup_channel</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hwcfg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: source=%d, devaddr=%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">source</span><span class="p">,</span> <span class="n">devaddr</span><span class="p">);</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">dev_addr</span> <span class="o">=</span> <span class="n">devaddr</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">req_ch</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DMACH_XD0</span>:
	<span class="k">case</span> <span class="n">DMACH_XD1</span>:
		<span class="n">hwcfg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* AHB */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">hwcfg</span> <span class="o">=</span> <span class="n">S3C2410_DISRCC_APB</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* always assume our peripheral desintation is a fixed</span>
<span class="cm">	 * address in memory. */</span>
	 <span class="n">hwcfg</span> <span class="o">|=</span> <span class="n">S3C2410_DISRCC_INC</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DMA_FROM_DEVICE</span>:
		<span class="cm">/* source is hardware */</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: hw source, devaddr=%08lx, hwcfg=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">devaddr</span><span class="p">,</span> <span class="n">hwcfg</span><span class="p">);</span>
		<span class="n">dma_wrreg</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">S3C2410_DMA_DISRCC</span><span class="p">,</span> <span class="n">hwcfg</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">dma_wrreg</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">S3C2410_DMA_DISRC</span><span class="p">,</span>  <span class="n">devaddr</span><span class="p">);</span>
		<span class="n">dma_wrreg</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">S3C2410_DMA_DIDSTC</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">));</span>

		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">addr_reg</span> <span class="o">=</span> <span class="n">dma_regaddr</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">S3C2410_DMA_DIDST</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DMA_TO_DEVICE</span>:
		<span class="cm">/* source is memory */</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: mem source, devaddr=%08lx, hwcfg=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">devaddr</span><span class="p">,</span> <span class="n">hwcfg</span><span class="p">);</span>
		<span class="n">dma_wrreg</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">S3C2410_DMA_DISRCC</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">));</span>
		<span class="n">dma_wrreg</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">S3C2410_DMA_DIDST</span><span class="p">,</span>  <span class="n">devaddr</span><span class="p">);</span>
		<span class="n">dma_wrreg</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">S3C2410_DMA_DIDSTC</span><span class="p">,</span> <span class="n">hwcfg</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>

		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">addr_reg</span> <span class="o">=</span> <span class="n">dma_regaddr</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">S3C2410_DMA_DISRC</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dma%d: invalid source type (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">channel</span><span class="p">,</span> <span class="n">source</span><span class="p">);</span>

		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma_sel</span><span class="p">.</span><span class="n">direction</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="p">(</span><span class="n">dma_sel</span><span class="p">.</span><span class="n">direction</span><span class="p">)(</span><span class="n">chan</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">,</span> <span class="n">source</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">s3c2410_dma_devconfig</span><span class="p">);</span>

<span class="cm">/* s3c2410_dma_getposition</span>
<span class="cm"> *</span>
<span class="cm"> * returns the current transfer points for the dma source and destination</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">s3c2410_dma_getposition</span><span class="p">(</span><span class="k">enum</span> <span class="n">dma_ch</span> <span class="n">channel</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2410_dma_chan</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">s3c_dma_lookup_channel</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">src</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
 		<span class="o">*</span><span class="n">src</span> <span class="o">=</span> <span class="n">dma_rdreg</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">S3C2410_DMA_DCSRC</span><span class="p">);</span>

 	<span class="k">if</span> <span class="p">(</span><span class="n">dst</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
 		<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">dma_rdreg</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">S3C2410_DMA_DCDST</span><span class="p">);</span>

 	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">s3c2410_dma_getposition</span><span class="p">);</span>

<span class="cm">/* system core operations */</span>

<span class="cp">#ifdef CONFIG_PM</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c2410_dma_suspend_chan</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c2410_dma_chan</span> <span class="o">*</span><span class="n">cp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;suspending dma channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma_rdreg</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">S3C2410_DMA_DMASKTRIG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">S3C2410_DMASKTRIG_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* the dma channel is still working, which is probably</span>
<span class="cm">		 * a bad thing to do over suspend/resume. We stop the</span>
<span class="cm">		 * channel and assume that the client is either going to</span>
<span class="cm">		 * retry after resume, or that it is broken.</span>
<span class="cm">		 */</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;dma: stopping channel %d due to suspend</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cp</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

		<span class="n">s3c2410_dma_dostop</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c2410_dma_suspend</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2410_dma_chan</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">s3c2410_chans</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">channel</span> <span class="o">&lt;</span> <span class="n">dma_channels</span><span class="p">;</span> <span class="n">cp</span><span class="o">++</span><span class="p">,</span> <span class="n">channel</span><span class="o">++</span><span class="p">)</span>
		<span class="n">s3c2410_dma_suspend_chan</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c2410_dma_resume_chan</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c2410_dma_chan</span> <span class="o">*</span><span class="n">cp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">no</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">|</span> <span class="n">DMACH_LOW_LEVEL</span><span class="p">;</span>

	<span class="cm">/* restore channel&#39;s hardware configuration */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">in_use</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;dma%d: restoring configuration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="n">s3c2410_dma_config</span><span class="p">(</span><span class="n">no</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">xfer_unit</span><span class="p">);</span>
	<span class="n">s3c2410_dma_devconfig</span><span class="p">(</span><span class="n">no</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="cm">/* re-select the dma source for this channel */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">map</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">dma_sel</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c2410_dma_resume</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2410_dma_chan</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">s3c2410_chans</span> <span class="o">+</span> <span class="n">dma_channels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">channel</span> <span class="o">=</span> <span class="n">dma_channels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">channel</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cp</span><span class="o">--</span><span class="p">,</span> <span class="n">channel</span><span class="o">--</span><span class="p">)</span>
		<span class="n">s3c2410_dma_resume_chan</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="cp">#define s3c2410_dma_suspend NULL</span>
<span class="cp">#define s3c2410_dma_resume  NULL</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">syscore_ops</span> <span class="n">dma_syscore_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">s3c2410_dma_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">s3c2410_dma_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* kmem cache implementation */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c2410_dma_cache_ctor</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c2410_dma_buf</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* initialisation code */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">s3c24xx_dma_syscore_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">register_syscore_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_syscore_ops</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">late_initcall</span><span class="p">(</span><span class="n">s3c24xx_dma_syscore_init</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">s3c24xx_dma_init</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channels</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stride</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2410_dma_chan</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;S3C24XX DMA Driver, Copyright 2003-2006 Simtec Electronics</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">dma_channels</span> <span class="o">=</span> <span class="n">channels</span><span class="p">;</span>

	<span class="n">dma_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">S3C24XX_PA_DMA</span><span class="p">,</span> <span class="n">stride</span> <span class="o">*</span> <span class="n">channels</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dma failed to remap register block</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dma_kmem</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span><span class="s">&quot;dma_desc&quot;</span><span class="p">,</span>
				     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c2410_dma_buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
				     <span class="n">SLAB_HWCACHE_ALIGN</span><span class="p">,</span>
				     <span class="n">s3c2410_dma_cache_ctor</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma_kmem</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dma failed to make kmem cache</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">channel</span> <span class="o">&lt;</span> <span class="n">channels</span><span class="p">;</span>  <span class="n">channel</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s3c2410_chans</span><span class="p">[</span><span class="n">channel</span><span class="p">];</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c2410_dma_chan</span><span class="p">));</span>

		<span class="cm">/* dma channel irqs are in order.. */</span>
		<span class="n">cp</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
		<span class="n">cp</span><span class="o">-&gt;</span><span class="n">irq</span>    <span class="o">=</span> <span class="n">channel</span> <span class="o">+</span> <span class="n">irq</span><span class="p">;</span>
		<span class="n">cp</span><span class="o">-&gt;</span><span class="n">regs</span>   <span class="o">=</span> <span class="n">dma_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">channel</span> <span class="o">*</span> <span class="n">stride</span><span class="p">);</span>

		<span class="cm">/* point current stats somewhere */</span>
		<span class="n">cp</span><span class="o">-&gt;</span><span class="n">stats</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">stats_store</span><span class="p">;</span>
		<span class="n">cp</span><span class="o">-&gt;</span><span class="n">stats_store</span><span class="p">.</span><span class="n">timeout_shortest</span> <span class="o">=</span> <span class="n">LONG_MAX</span><span class="p">;</span>

		<span class="cm">/* basic channel configuration */</span>

		<span class="n">cp</span><span class="o">-&gt;</span><span class="n">load_timeout</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">18</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;DMA channel %d at %p, irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cp</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err:</span>
	<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">dma_kmem</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">dma_base</span><span class="p">);</span>
	<span class="n">dma_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">s3c2410_dma_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">s3c24xx_dma_init</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">IRQ_DMA0</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_channel_valid</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="n">DMA_CH_VALID</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">s3c24xx_dma_order</span> <span class="o">*</span><span class="n">dma_order</span><span class="p">;</span>


<span class="cm">/* s3c2410_dma_map_channel()</span>
<span class="cm"> *</span>
<span class="cm"> * turn the virtual channel number into a real, and un-used hardware</span>
<span class="cm"> * channel.</span>
<span class="cm"> *</span>
<span class="cm"> * first, try the dma ordering given to us by either the relevant</span>
<span class="cm"> * dma code, or the board. Then just find the first usable free</span>
<span class="cm"> * channel</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">s3c2410_dma_chan</span> <span class="o">*</span><span class="nf">s3c2410_dma_map_channel</span><span class="p">(</span><span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c24xx_dma_order_ch</span> <span class="o">*</span><span class="n">ord</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c24xx_dma_map</span> <span class="o">*</span><span class="n">ch_map</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c2410_dma_chan</span> <span class="o">*</span><span class="n">dmach</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma_sel</span><span class="p">.</span><span class="n">map</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">channel</span> <span class="o">&gt;</span> <span class="n">dma_sel</span><span class="p">.</span><span class="n">map_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ch_map</span> <span class="o">=</span> <span class="n">dma_sel</span><span class="p">.</span><span class="n">map</span> <span class="o">+</span> <span class="n">channel</span><span class="p">;</span>

	<span class="cm">/* first, try the board mapping */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma_order</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ord</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dma_order</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">channel</span><span class="p">];</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="n">dma_channels</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_channel_valid</span><span class="p">(</span><span class="n">ord</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="n">ch</span><span class="p">]))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">tmp</span> <span class="o">=</span> <span class="n">ord</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DMA_CH_VALID</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s3c2410_chans</span><span class="p">[</span><span class="n">tmp</span><span class="p">].</span><span class="n">in_use</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ch</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ord</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_CH_NEVER</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* second, search the channel map for first free */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="n">dma_channels</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_channel_valid</span><span class="p">(</span><span class="n">ch_map</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">ch</span><span class="p">]))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">s3c2410_chans</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">in_use</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;mapped channel %d to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&gt;=</span> <span class="n">dma_channels</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* update our channel mapping */</span>

 <span class="nl">found:</span>
	<span class="n">dmach</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s3c2410_chans</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	<span class="n">dmach</span><span class="o">-&gt;</span><span class="n">map</span> <span class="o">=</span> <span class="n">ch_map</span><span class="p">;</span>
	<span class="n">dmach</span><span class="o">-&gt;</span><span class="n">req_ch</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
	<span class="n">s3c_dma_chan_map</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmach</span><span class="p">;</span>

	<span class="cm">/* select the channel */</span>

	<span class="p">(</span><span class="n">dma_sel</span><span class="p">.</span><span class="n">select</span><span class="p">)(</span><span class="n">dmach</span><span class="p">,</span> <span class="n">ch_map</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dmach</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c24xx_dma_check_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c24xx_dma_map</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">s3c24xx_dma_init_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c24xx_dma_selection</span> <span class="o">*</span><span class="n">sel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c24xx_dma_map</span> <span class="o">*</span><span class="n">nmap</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">map_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">nmap</span><span class="p">)</span> <span class="o">*</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">map_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ptr</span><span class="p">;</span>

	<span class="n">nmap</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">,</span> <span class="n">map_sz</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nmap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_sel</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sel</span><span class="p">));</span>

	<span class="n">dma_sel</span><span class="p">.</span><span class="n">map</span> <span class="o">=</span> <span class="n">nmap</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ptr</span> <span class="o">&lt;</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">map_size</span><span class="p">;</span> <span class="n">ptr</span><span class="o">++</span><span class="p">)</span>
		<span class="n">s3c24xx_dma_check_entry</span><span class="p">(</span><span class="n">nmap</span><span class="o">+</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">s3c24xx_dma_order_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c24xx_dma_order</span> <span class="o">*</span><span class="n">ord</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c24xx_dma_order</span> <span class="o">*</span><span class="n">nord</span> <span class="o">=</span> <span class="n">dma_order</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nord</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">nord</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c24xx_dma_order</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nord</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;no memory to store dma channel order</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dma_order</span> <span class="o">=</span> <span class="n">nord</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">nord</span><span class="p">,</span> <span class="n">ord</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c24xx_dma_order</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
