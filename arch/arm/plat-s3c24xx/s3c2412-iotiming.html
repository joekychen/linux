<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › arm › plat-s3c24xx › s3c2412-iotiming.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>s3c2412-iotiming.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* linux/arch/arm/plat-s3c24xx/s3c2412-iotiming.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2006-2008 Simtec Electronics</span>
<span class="cm"> *	http://armlinux.simtec.co.uk/</span>
<span class="cm"> *	Ben Dooks &lt;ben@simtec.co.uk&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * S3C2412/S3C2443 (PL093 based) IO timing support</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm">*/</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/cpufreq.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;linux/amba/pl093.h&gt;</span>

<span class="cp">#include &lt;asm/mach/arch.h&gt;</span>
<span class="cp">#include &lt;asm/mach/map.h&gt;</span>

<span class="cp">#include &lt;mach/regs-s3c2412-mem.h&gt;</span>

<span class="cp">#include &lt;plat/cpu.h&gt;</span>
<span class="cp">#include &lt;plat/cpu-freq-core.h&gt;</span>
<span class="cp">#include &lt;plat/clock.h&gt;</span>

<span class="cp">#define print_ns(x) ((x) / 10), ((x) % 10)</span>

<span class="cm">/**</span>
<span class="cm"> * s3c2412_print_timing - print timing infromation via printk.</span>
<span class="cm"> * @pfx: The prefix to print each line with.</span>
<span class="cm"> * @iot: The IO timing information</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c2412_print_timing</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pfx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s3c_iotimings</span> <span class="o">*</span><span class="n">iot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2412_iobank_timing</span> <span class="o">*</span><span class="n">bt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bank</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bank</span> <span class="o">&lt;</span> <span class="n">MAX_BANKS</span><span class="p">;</span> <span class="n">bank</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bt</span> <span class="o">=</span> <span class="n">iot</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">[</span><span class="n">bank</span><span class="p">].</span><span class="n">io_2412</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bt</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %d: idcy=%d.%d wstrd=%d.%d wstwr=%d,%d&quot;</span>
		       <span class="s">&quot;wstoen=%d.%d wstwen=%d.%d wstbrd=%d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pfx</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span>
		       <span class="n">print_ns</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">idcy</span><span class="p">),</span>
		       <span class="n">print_ns</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">wstrd</span><span class="p">),</span>
		       <span class="n">print_ns</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">wstwr</span><span class="p">),</span>
		       <span class="n">print_ns</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">wstoen</span><span class="p">),</span>
		       <span class="n">print_ns</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">wstwen</span><span class="p">),</span>
		       <span class="n">print_ns</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">wstbrd</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * to_div - turn a cycle length into a divisor setting.</span>
<span class="cm"> * @cyc_tns: The cycle time in 10ths of nanoseconds.</span>
<span class="cm"> * @clk_tns: The clock period in 10ths of nanoseconds.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">to_div</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cyc_tns</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clk_tns</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cyc_tns</span> <span class="o">?</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">cyc_tns</span><span class="p">,</span> <span class="n">clk_tns</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * calc_timing - calculate timing divisor value and check in range.</span>
<span class="cm"> * @hwtm: The hardware timing in 10ths of nanoseconds.</span>
<span class="cm"> * @clk_tns: The clock period in 10ths of nanoseconds.</span>
<span class="cm"> * @err: Pointer to err variable to update in event of failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">calc_timing</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hwtm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clk_tns</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">to_div</span><span class="p">(</span><span class="n">hwtm</span><span class="p">,</span> <span class="n">clk_tns</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mh">0xf</span><span class="p">)</span>
		<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c2412_calc_bank - calculate the bank divisor settings.</span>
<span class="cm"> * @cfg: The current frequency configuration.</span>
<span class="cm"> * @bt: The bank timing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s3c2412_calc_bank</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_cpufreq_config</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">s3c2412_iobank_timing</span> <span class="o">*</span><span class="n">bt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hclk</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">.</span><span class="n">hclk_tns</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">bt</span><span class="o">-&gt;</span><span class="n">smbidcyr</span> <span class="o">=</span> <span class="n">calc_timing</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">idcy</span><span class="p">,</span> <span class="n">hclk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="n">bt</span><span class="o">-&gt;</span><span class="n">smbwstrd</span> <span class="o">=</span> <span class="n">calc_timing</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">wstrd</span><span class="p">,</span> <span class="n">hclk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="n">bt</span><span class="o">-&gt;</span><span class="n">smbwstwr</span> <span class="o">=</span> <span class="n">calc_timing</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">wstwr</span><span class="p">,</span> <span class="n">hclk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="n">bt</span><span class="o">-&gt;</span><span class="n">smbwstoen</span> <span class="o">=</span> <span class="n">calc_timing</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">wstoen</span><span class="p">,</span> <span class="n">hclk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="n">bt</span><span class="o">-&gt;</span><span class="n">smbwstwen</span> <span class="o">=</span> <span class="n">calc_timing</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">wstwen</span><span class="p">,</span> <span class="n">hclk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="n">bt</span><span class="o">-&gt;</span><span class="n">smbwstbrd</span> <span class="o">=</span> <span class="n">calc_timing</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">wstbrd</span><span class="p">,</span> <span class="n">hclk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c2412_iotiming_debugfs - debugfs show io bank timing information</span>
<span class="cm"> * @seq: The seq_file to write output to using seq_printf().</span>
<span class="cm"> * @cfg: The current configuration.</span>
<span class="cm"> * @iob: The IO bank information to decode.</span>
<span class="cm">*/</span>
<span class="kt">void</span> <span class="nf">s3c2412_iotiming_debugfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">s3c_cpufreq_config</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span>
			      <span class="k">union</span> <span class="n">s3c_iobank</span> <span class="o">*</span><span class="n">iob</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2412_iobank_timing</span> <span class="o">*</span><span class="n">bt</span> <span class="o">=</span> <span class="n">iob</span><span class="o">-&gt;</span><span class="n">io_2412</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
		   <span class="s">&quot;</span><span class="se">\t</span><span class="s">Read: idcy=%d.%d wstrd=%d.%d wstwr=%d,%d&quot;</span>
		   <span class="s">&quot;wstoen=%d.%d wstwen=%d.%d wstbrd=%d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">print_ns</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">idcy</span><span class="p">),</span>
		   <span class="n">print_ns</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">wstrd</span><span class="p">),</span>
		   <span class="n">print_ns</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">wstwr</span><span class="p">),</span>
		   <span class="n">print_ns</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">wstoen</span><span class="p">),</span>
		   <span class="n">print_ns</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">wstwen</span><span class="p">),</span>
		   <span class="n">print_ns</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">wstbrd</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c2412_iotiming_calc - calculate all the bank divisor settings.</span>
<span class="cm"> * @cfg: The current frequency configuration.</span>
<span class="cm"> * @iot: The bank timing information.</span>
<span class="cm"> *</span>
<span class="cm"> * Calculate the timing information for all the banks that are</span>
<span class="cm"> * configured as IO, using s3c2412_calc_bank().</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">s3c2412_iotiming_calc</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_cpufreq_config</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">s3c_iotimings</span> <span class="o">*</span><span class="n">iot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2412_iobank_timing</span> <span class="o">*</span><span class="n">bt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bank</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bank</span> <span class="o">&lt;</span> <span class="n">MAX_BANKS</span><span class="p">;</span> <span class="n">bank</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bt</span> <span class="o">=</span> <span class="n">iot</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">[</span><span class="n">bank</span><span class="p">].</span><span class="n">io_2412</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bt</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">s3c2412_calc_bank</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">bt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: cannot calculate bank %d io</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">bank</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">err:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s3c2412_iotiming_set - set the timing information</span>
<span class="cm"> * @cfg: The current frequency configuration.</span>
<span class="cm"> * @iot: The bank timing information.</span>
<span class="cm"> *</span>
<span class="cm"> * Set the IO bank information from the details calculated earlier from</span>
<span class="cm"> * calling s3c2412_iotiming_calc().</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">s3c2412_iotiming_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_cpufreq_config</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">s3c_iotimings</span> <span class="o">*</span><span class="n">iot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2412_iobank_timing</span> <span class="o">*</span><span class="n">bt</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bank</span><span class="p">;</span>

	<span class="cm">/* set the io timings from the specifier */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bank</span> <span class="o">&lt;</span> <span class="n">MAX_BANKS</span><span class="p">;</span> <span class="n">bank</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bt</span> <span class="o">=</span> <span class="n">iot</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">[</span><span class="n">bank</span><span class="p">].</span><span class="n">io_2412</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bt</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">regs</span> <span class="o">=</span> <span class="n">S3C2412_SSMC_BANK</span><span class="p">(</span><span class="n">bank</span><span class="p">);</span>

		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">smbidcyr</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">SMBIDCYR</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">smbwstrd</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">SMBWSTRDR</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">smbwstwr</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">SMBWSTWRR</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">smbwstoen</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">SMBWSTOENR</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">smbwstwen</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">SMBWSTWENR</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">smbwstbrd</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">SMBWSTBRDR</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">s3c2412_decode_timing</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clock</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">*</span> <span class="n">clock</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s3c2412_iotiming_getbank</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_cpufreq_config</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">s3c2412_iobank_timing</span> <span class="o">*</span><span class="n">bt</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bank</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">clk</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">.</span><span class="n">hclk_tns</span><span class="p">;</span>  <span class="cm">/* ssmc clock??? */</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">S3C2412_SSMC_BANK</span><span class="p">(</span><span class="n">bank</span><span class="p">);</span>

	<span class="n">bt</span><span class="o">-&gt;</span><span class="n">idcy</span> <span class="o">=</span> <span class="n">s3c2412_decode_timing</span><span class="p">(</span><span class="n">clk</span><span class="p">,</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SMBIDCYR</span><span class="p">));</span>
	<span class="n">bt</span><span class="o">-&gt;</span><span class="n">wstrd</span> <span class="o">=</span> <span class="n">s3c2412_decode_timing</span><span class="p">(</span><span class="n">clk</span><span class="p">,</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SMBWSTRDR</span><span class="p">));</span>
	<span class="n">bt</span><span class="o">-&gt;</span><span class="n">wstoen</span> <span class="o">=</span> <span class="n">s3c2412_decode_timing</span><span class="p">(</span><span class="n">clk</span><span class="p">,</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SMBWSTOENR</span><span class="p">));</span>
	<span class="n">bt</span><span class="o">-&gt;</span><span class="n">wstwen</span> <span class="o">=</span> <span class="n">s3c2412_decode_timing</span><span class="p">(</span><span class="n">clk</span><span class="p">,</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SMBWSTWENR</span><span class="p">));</span>
	<span class="n">bt</span><span class="o">-&gt;</span><span class="n">wstbrd</span> <span class="o">=</span> <span class="n">s3c2412_decode_timing</span><span class="p">(</span><span class="n">clk</span><span class="p">,</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SMBWSTBRDR</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bank_is_io - return true if bank is (possibly) IO.</span>
<span class="cm"> * @bank: The bank number.</span>
<span class="cm"> * @bankcfg: The value of S3C2412_EBI_BANKCFG.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">bank_is_io</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bank</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bankcfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bank</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">bankcfg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bank</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">s3c2412_iotiming_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_cpufreq_config</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">s3c_iotimings</span> <span class="o">*</span><span class="n">timings</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c2412_iobank_timing</span> <span class="o">*</span><span class="n">bt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bankcfg</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">S3C2412_EBI_BANKCFG</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bank</span><span class="p">;</span>

	<span class="cm">/* look through all banks to see what is currently set. */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bank</span> <span class="o">&lt;</span> <span class="n">MAX_BANKS</span><span class="p">;</span> <span class="n">bank</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bank_is_io</span><span class="p">(</span><span class="n">bank</span><span class="p">,</span> <span class="n">bankcfg</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">bt</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c2412_iobank_timing</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: no memory for bank</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">timings</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">[</span><span class="n">bank</span><span class="p">].</span><span class="n">io_2412</span> <span class="o">=</span> <span class="n">bt</span><span class="p">;</span>
		<span class="n">s3c2412_iotiming_getbank</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">bt</span><span class="p">,</span> <span class="n">bank</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">s3c2412_print_timing</span><span class="p">(</span><span class="s">&quot;get&quot;</span><span class="p">,</span> <span class="n">timings</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* this is in here as it is so small, it doesn&#39;t currently warrant a file</span>
<span class="cm"> * to itself. We expect that any s3c24xx needing this is going to also</span>
<span class="cm"> * need the iotiming support.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">s3c2412_cpufreq_setrefresh</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_cpufreq_config</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_cpufreq_board</span> <span class="o">*</span><span class="n">board</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">refresh</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">board</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Reduce both the refresh time (in ns) and the frequency (in MHz)</span>
<span class="cm">	 * down to ensure that we do not overflow 32 bit numbers.</span>
<span class="cm">	 *</span>
<span class="cm">	 * This should work for HCLK up to 133MHz and refresh period up</span>
<span class="cm">	 * to 30usec.</span>
<span class="cm">	 */</span>

	<span class="n">refresh</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">.</span><span class="n">hclk</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">refresh</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">refresh</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">refresh</span><span class="p">,</span> <span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">));</span> <span class="cm">/* apply scale  */</span>
	<span class="n">refresh</span> <span class="o">&amp;=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">s3c_freq_dbg</span><span class="p">(</span><span class="s">&quot;%s: refresh value %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">refresh</span><span class="p">);</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">refresh</span><span class="p">,</span> <span class="n">S3C2412_REFRESH</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
