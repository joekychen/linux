<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › mips › kernel › perf_event_mipsxx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>perf_event_mipsxx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Linux performance counter support for MIPS.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2010 MIPS Technologies, Inc.</span>
<span class="cm"> * Copyright (C) 2011 Cavium Networks, Inc.</span>
<span class="cm"> * Author: Deng-Cheng Zhu</span>
<span class="cm"> *</span>
<span class="cm"> * This code is based on the implementation for ARM, which is in turn</span>
<span class="cm"> * based on the sparc64 perf event code and the x86 code. Performance</span>
<span class="cm"> * counter access is based on the MIPS Oprofile code. And the callchain</span>
<span class="cm"> * support references the code of MIPS stacktrace.c.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/cpumask.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/smp.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/perf_event.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>

<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/irq_regs.h&gt;</span>
<span class="cp">#include &lt;asm/stacktrace.h&gt;</span>
<span class="cp">#include &lt;asm/time.h&gt; </span><span class="cm">/* For perf_irq */</span><span class="cp"></span>

<span class="cp">#define MIPS_MAX_HWEVENTS 4</span>

<span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="p">{</span>
	<span class="cm">/* Array of events on this cpu. */</span>
	<span class="k">struct</span> <span class="n">perf_event</span>	<span class="o">*</span><span class="n">events</span><span class="p">[</span><span class="n">MIPS_MAX_HWEVENTS</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set the bit (indexed by the counter number) when the counter</span>
<span class="cm">	 * is used for an event.</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">used_mask</span><span class="p">[</span><span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">MIPS_MAX_HWEVENTS</span><span class="p">)];</span>

	<span class="cm">/*</span>
<span class="cm">	 * Software copy of the control register for each performance counter.</span>
<span class="cm">	 * MIPS CPUs vary in performance counters. They use this differently,</span>
<span class="cm">	 * and even may not use it.</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">saved_ctrl</span><span class="p">[</span><span class="n">MIPS_MAX_HWEVENTS</span><span class="p">];</span>
<span class="p">};</span>
<span class="n">DEFINE_PER_CPU</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpu_hw_events</span><span class="p">,</span> <span class="n">cpu_hw_events</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">saved_ctrl</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* The description of MIPS performance events. */</span>
<span class="k">struct</span> <span class="n">mips_perf_event</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">event_id</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * MIPS performance counters are indexed starting from 0.</span>
<span class="cm">	 * CNTR_EVEN indicates the indexes of the counters to be used are</span>
<span class="cm">	 * even numbers.</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cntr_mask</span><span class="p">;</span>
	<span class="cp">#define CNTR_EVEN	0x55555555</span>
	<span class="cp">#define CNTR_ODD	0xaaaaaaaa</span>
	<span class="cp">#define CNTR_ALL	0xffffffff</span>
<span class="cp">#ifdef CONFIG_MIPS_MT_SMP</span>
	<span class="k">enum</span> <span class="p">{</span>
		<span class="n">T</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">V</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="n">P</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">}</span> <span class="n">range</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="cp">#define T</span>
	<span class="cp">#define V</span>
	<span class="cp">#define P</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mips_perf_event</span> <span class="n">raw_event</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">raw_event_mutex</span><span class="p">);</span>

<span class="cp">#define UNSUPPORTED_PERF_EVENT_ID 0xffffffff</span>
<span class="cp">#define C(x) PERF_COUNT_HW_CACHE_##x</span>

<span class="k">struct</span> <span class="n">mips_pmu</span> <span class="p">{</span>
	<span class="n">u64</span>		<span class="n">max_period</span><span class="p">;</span>
	<span class="n">u64</span>		<span class="n">valid_count</span><span class="p">;</span>
	<span class="n">u64</span>		<span class="n">overflow</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span>	<span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">irq</span><span class="p">;</span>
	<span class="n">u64</span>		<span class="p">(</span><span class="o">*</span><span class="n">read_counter</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">);</span>
	<span class="kt">void</span>		<span class="p">(</span><span class="o">*</span><span class="n">write_counter</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">u64</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">mips_perf_event</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">map_raw_event</span><span class="p">)(</span><span class="n">u64</span> <span class="n">config</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">mips_perf_event</span> <span class="p">(</span><span class="o">*</span><span class="n">general_event_map</span><span class="p">)[</span><span class="n">PERF_COUNT_HW_MAX</span><span class="p">];</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">mips_perf_event</span> <span class="p">(</span><span class="o">*</span><span class="n">cache_event_map</span><span class="p">)</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_MAX</span><span class="p">]</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_OP_MAX</span><span class="p">]</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_RESULT_MAX</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">num_counters</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mips_pmu</span> <span class="n">mipspmu</span><span class="p">;</span>

<span class="cp">#define M_CONFIG1_PC	(1 &lt;&lt; 4)</span>

<span class="cp">#define M_PERFCTL_EXL			(1      &lt;&lt;  0)</span>
<span class="cp">#define M_PERFCTL_KERNEL		(1      &lt;&lt;  1)</span>
<span class="cp">#define M_PERFCTL_SUPERVISOR		(1      &lt;&lt;  2)</span>
<span class="cp">#define M_PERFCTL_USER			(1      &lt;&lt;  3)</span>
<span class="cp">#define M_PERFCTL_INTERRUPT_ENABLE	(1      &lt;&lt;  4)</span>
<span class="cp">#define M_PERFCTL_EVENT(event)		(((event) &amp; 0x3ff)  &lt;&lt; 5)</span>
<span class="cp">#define M_PERFCTL_VPEID(vpe)		((vpe)    &lt;&lt; 16)</span>
<span class="cp">#define M_PERFCTL_MT_EN(filter)		((filter) &lt;&lt; 20)</span>
<span class="cp">#define    M_TC_EN_ALL			M_PERFCTL_MT_EN(0)</span>
<span class="cp">#define    M_TC_EN_VPE			M_PERFCTL_MT_EN(1)</span>
<span class="cp">#define    M_TC_EN_TC			M_PERFCTL_MT_EN(2)</span>
<span class="cp">#define M_PERFCTL_TCID(tcid)		((tcid)   &lt;&lt; 22)</span>
<span class="cp">#define M_PERFCTL_WIDE			(1      &lt;&lt; 30)</span>
<span class="cp">#define M_PERFCTL_MORE			(1      &lt;&lt; 31)</span>

<span class="cp">#define M_PERFCTL_COUNT_EVENT_WHENEVER	(M_PERFCTL_EXL |		\</span>
<span class="cp">					M_PERFCTL_KERNEL |		\</span>
<span class="cp">					M_PERFCTL_USER |		\</span>
<span class="cp">					M_PERFCTL_SUPERVISOR |		\</span>
<span class="cp">					M_PERFCTL_INTERRUPT_ENABLE)</span>

<span class="cp">#ifdef CONFIG_MIPS_MT_SMP</span>
<span class="cp">#define M_PERFCTL_CONFIG_MASK		0x3fff801f</span>
<span class="cp">#else</span>
<span class="cp">#define M_PERFCTL_CONFIG_MASK		0x1f</span>
<span class="cp">#endif</span>
<span class="cp">#define M_PERFCTL_EVENT_MASK		0xfe0</span>


<span class="cp">#ifdef CONFIG_MIPS_MT_SMP</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cpu_has_mipsmt_pertccounters</span><span class="p">;</span>

<span class="k">static</span> <span class="n">DEFINE_RWLOCK</span><span class="p">(</span><span class="n">pmuint_rwlock</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * FIXME: For VSMP, vpe_id() is redefined for Perf-events, because</span>
<span class="cm"> * cpu_data[cpuid].vpe_id reports 0 for _both_ CPUs.</span>
<span class="cm"> */</span>
<span class="cp">#if defined(CONFIG_HW_PERF_EVENTS)</span>
<span class="cp">#define vpe_id()	(cpu_has_mipsmt_pertccounters ? \</span>
<span class="cp">			0 : smp_processor_id())</span>
<span class="cp">#else</span>
<span class="cp">#define vpe_id()	(cpu_has_mipsmt_pertccounters ? \</span>
<span class="cp">			0 : cpu_data[smp_processor_id()].vpe_id)</span>
<span class="cp">#endif</span>

<span class="cm">/* Copied from op_model_mipsxx.c */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">vpe_shift</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_possible_cpus</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">counters_total_to_per_cpu</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">counters</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">counters</span> <span class="o">&gt;&gt;</span> <span class="n">vpe_shift</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">counters_per_cpu_to_total</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">counters</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">counters</span> <span class="o">&lt;&lt;</span> <span class="n">vpe_shift</span><span class="p">();</span>
<span class="p">}</span>

<span class="cp">#else </span><span class="cm">/* !CONFIG_MIPS_MT_SMP */</span><span class="cp"></span>
<span class="cp">#define vpe_id()	0</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_MIPS_MT_SMP */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">resume_local_counters</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">pause_local_counters</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">mipsxx_pmu_handle_irq</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mipsxx_pmu_handle_shared_irq</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">mipsxx_pmu_swizzle_perf_idx</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vpe_id</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">mipsxx_pmu_read_counter</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">mipsxx_pmu_swizzle_perf_idx</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/*</span>
<span class="cm">		 * The counters are unsigned, we must cast to truncate</span>
<span class="cm">		 * off the high bits.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">read_c0_perfcntr0</span><span class="p">();</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">return</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">read_c0_perfcntr1</span><span class="p">();</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">return</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">read_c0_perfcntr2</span><span class="p">();</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="k">return</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">read_c0_perfcntr3</span><span class="p">();</span>
	<span class="nl">default:</span>
		<span class="n">WARN_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Invalid performance counter number (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">mipsxx_pmu_read_counter_64</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">mipsxx_pmu_swizzle_perf_idx</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">return</span> <span class="n">read_c0_perfcntr0_64</span><span class="p">();</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">return</span> <span class="n">read_c0_perfcntr1_64</span><span class="p">();</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">return</span> <span class="n">read_c0_perfcntr2_64</span><span class="p">();</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="k">return</span> <span class="n">read_c0_perfcntr3_64</span><span class="p">();</span>
	<span class="nl">default:</span>
		<span class="n">WARN_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Invalid performance counter number (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mipsxx_pmu_write_counter</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">u64</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">mipsxx_pmu_swizzle_perf_idx</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">write_c0_perfcntr0</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">write_c0_perfcntr1</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">write_c0_perfcntr2</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">write_c0_perfcntr3</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mipsxx_pmu_write_counter_64</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">u64</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">mipsxx_pmu_swizzle_perf_idx</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">write_c0_perfcntr0_64</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">write_c0_perfcntr1_64</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">write_c0_perfcntr2_64</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">write_c0_perfcntr3_64</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">mipsxx_pmu_read_control</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">mipsxx_pmu_swizzle_perf_idx</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">return</span> <span class="n">read_c0_perfctrl0</span><span class="p">();</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">return</span> <span class="n">read_c0_perfctrl1</span><span class="p">();</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">return</span> <span class="n">read_c0_perfctrl2</span><span class="p">();</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="k">return</span> <span class="n">read_c0_perfctrl3</span><span class="p">();</span>
	<span class="nl">default:</span>
		<span class="n">WARN_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Invalid performance counter number (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mipsxx_pmu_write_control</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">mipsxx_pmu_swizzle_perf_idx</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">write_c0_perfctrl0</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">write_c0_perfctrl1</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">write_c0_perfctrl2</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">write_c0_perfctrl3</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mipsxx_pmu_alloc_counter</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">hw_perf_event</span> <span class="o">*</span><span class="n">hwc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We only need to care the counter mask. The range has been</span>
<span class="cm">	 * checked definitely.</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cntr_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">event_base</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">mipspmu</span><span class="p">.</span><span class="n">num_counters</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Note that some MIPS perf events can be counted by both</span>
<span class="cm">		 * even and odd counters, wheresas many other are only by</span>
<span class="cm">		 * even _or_ odd counters. This introduces an issue that</span>
<span class="cm">		 * when the former kind of event takes the counter the</span>
<span class="cm">		 * latter kind of event wants to use, then the &quot;counter</span>
<span class="cm">		 * allocation&quot; for the latter event will fail. In fact if</span>
<span class="cm">		 * they can be dynamically swapped, they both feel happy.</span>
<span class="cm">		 * But here we leave this issue alone for now.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cntr_mask</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">used_mask</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mipsxx_pmu_enable_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw_perf_event</span> <span class="o">*</span><span class="n">evt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">cpu_hw_events</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">mipspmu</span><span class="p">.</span><span class="n">num_counters</span><span class="p">);</span>

	<span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">saved_ctrl</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">M_PERFCTL_EVENT</span><span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">event_base</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">config_base</span> <span class="o">&amp;</span> <span class="n">M_PERFCTL_CONFIG_MASK</span><span class="p">)</span> <span class="o">|</span>
		<span class="cm">/* Make sure interrupt enabled. */</span>
		<span class="n">M_PERFCTL_INTERRUPT_ENABLE</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * We do not actually let the counter run. Leave it until start().</span>
<span class="cm">	 */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mipsxx_pmu_disable_event</span><span class="p">(</span><span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">cpu_hw_events</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">mipspmu</span><span class="p">.</span><span class="n">num_counters</span><span class="p">);</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">saved_ctrl</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">mipsxx_pmu_read_control</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="o">~</span><span class="n">M_PERFCTL_COUNT_EVENT_WHENEVER</span><span class="p">;</span>
	<span class="n">mipsxx_pmu_write_control</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">saved_ctrl</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mipspmu_event_set_period</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">hw_perf_event</span> <span class="o">*</span><span class="n">hwc</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">left</span> <span class="o">=</span> <span class="n">local64_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">period_left</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">period</span> <span class="o">=</span> <span class="n">hwc</span><span class="o">-&gt;</span><span class="n">sample_period</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">left</span> <span class="o">+</span> <span class="n">period</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">63</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* left underflowed by more than period. */</span>
		<span class="n">left</span> <span class="o">=</span> <span class="n">period</span><span class="p">;</span>
		<span class="n">local64_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">period_left</span><span class="p">,</span> <span class="n">left</span><span class="p">);</span>
		<span class="n">hwc</span><span class="o">-&gt;</span><span class="n">last_period</span> <span class="o">=</span> <span class="n">period</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">left</span> <span class="o">+</span> <span class="n">period</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">period</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* left underflowed by less than period. */</span>
		<span class="n">left</span> <span class="o">+=</span> <span class="n">period</span><span class="p">;</span>
		<span class="n">local64_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">period_left</span><span class="p">,</span> <span class="n">left</span><span class="p">);</span>
		<span class="n">hwc</span><span class="o">-&gt;</span><span class="n">last_period</span> <span class="o">=</span> <span class="n">period</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">&gt;</span> <span class="n">mipspmu</span><span class="p">.</span><span class="n">max_period</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">left</span> <span class="o">=</span> <span class="n">mipspmu</span><span class="p">.</span><span class="n">max_period</span><span class="p">;</span>
		<span class="n">local64_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">period_left</span><span class="p">,</span> <span class="n">left</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">local64_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">prev_count</span><span class="p">,</span> <span class="n">mipspmu</span><span class="p">.</span><span class="n">overflow</span> <span class="o">-</span> <span class="n">left</span><span class="p">);</span>

	<span class="n">mipspmu</span><span class="p">.</span><span class="n">write_counter</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">mipspmu</span><span class="p">.</span><span class="n">overflow</span> <span class="o">-</span> <span class="n">left</span><span class="p">);</span>

	<span class="n">perf_event_update_userpage</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mipspmu_event_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">hw_perf_event</span> <span class="o">*</span><span class="n">hwc</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">prev_raw_count</span><span class="p">,</span> <span class="n">new_raw_count</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">delta</span><span class="p">;</span>

<span class="nl">again:</span>
	<span class="n">prev_raw_count</span> <span class="o">=</span> <span class="n">local64_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">prev_count</span><span class="p">);</span>
	<span class="n">new_raw_count</span> <span class="o">=</span> <span class="n">mipspmu</span><span class="p">.</span><span class="n">read_counter</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local64_cmpxchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">prev_count</span><span class="p">,</span> <span class="n">prev_raw_count</span><span class="p">,</span>
				<span class="n">new_raw_count</span><span class="p">)</span> <span class="o">!=</span> <span class="n">prev_raw_count</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>

	<span class="n">delta</span> <span class="o">=</span> <span class="n">new_raw_count</span> <span class="o">-</span> <span class="n">prev_raw_count</span><span class="p">;</span>

	<span class="n">local64_add</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
	<span class="n">local64_sub</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">period_left</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mipspmu_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw_perf_event</span> <span class="o">*</span><span class="n">hwc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PERF_EF_RELOAD</span><span class="p">)</span>
		<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">PERF_HES_UPTODATE</span><span class="p">));</span>

	<span class="n">hwc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Set the period for the event. */</span>
	<span class="n">mipspmu_event_set_period</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">hwc</span><span class="p">,</span> <span class="n">hwc</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>

	<span class="cm">/* Enable the event. */</span>
	<span class="n">mipsxx_pmu_enable_event</span><span class="p">(</span><span class="n">hwc</span><span class="p">,</span> <span class="n">hwc</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mipspmu_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw_perf_event</span> <span class="o">*</span><span class="n">hwc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">PERF_HES_STOPPED</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* We are working on a local event. */</span>
		<span class="n">mipsxx_pmu_disable_event</span><span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>
		<span class="n">barrier</span><span class="p">();</span>
		<span class="n">mipspmu_event_update</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">hwc</span><span class="p">,</span> <span class="n">hwc</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>
		<span class="n">hwc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">PERF_HES_STOPPED</span> <span class="o">|</span> <span class="n">PERF_HES_UPTODATE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mipspmu_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">cpu_hw_events</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hw_perf_event</span> <span class="o">*</span><span class="n">hwc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">perf_pmu_disable</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">pmu</span><span class="p">);</span>

	<span class="cm">/* To look for a free counter for this event. */</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">mipsxx_pmu_alloc_counter</span><span class="p">(</span><span class="n">cpuc</span><span class="p">,</span> <span class="n">hwc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If there is an event in the counter we are going to use then</span>
<span class="cm">	 * make sure it is disabled.</span>
<span class="cm">	 */</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">mipsxx_pmu_disable_event</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
	<span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="p">;</span>

	<span class="n">hwc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">PERF_HES_STOPPED</span> <span class="o">|</span> <span class="n">PERF_HES_UPTODATE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PERF_EF_START</span><span class="p">)</span>
		<span class="n">mipspmu_start</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">PERF_EF_RELOAD</span><span class="p">);</span>

	<span class="cm">/* Propagate our changes to the userspace mapping. */</span>
	<span class="n">perf_event_update_userpage</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">perf_pmu_enable</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">pmu</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mipspmu_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">cpu_hw_events</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hw_perf_event</span> <span class="o">*</span><span class="n">hwc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">hwc</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">mipspmu</span><span class="p">.</span><span class="n">num_counters</span><span class="p">);</span>

	<span class="n">mipspmu_stop</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">PERF_EF_UPDATE</span><span class="p">);</span>
	<span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">used_mask</span><span class="p">);</span>

	<span class="n">perf_event_update_userpage</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mipspmu_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw_perf_event</span> <span class="o">*</span><span class="n">hwc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="cm">/* Don&#39;t read disabled counters! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mipspmu_event_update</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">hwc</span><span class="p">,</span> <span class="n">hwc</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mipspmu_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmu</span> <span class="o">*</span><span class="n">pmu</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_MIPS_MT_SMP</span>
	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmuint_rwlock</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">resume_local_counters</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MIPS performance counters can be per-TC. The control registers can</span>
<span class="cm"> * not be directly accessed accross CPUs. Hence if we want to do global</span>
<span class="cm"> * control, we need cross CPU calls. on_each_cpu() can help us, but we</span>
<span class="cm"> * can not make sure this function is called with interrupts enabled. So</span>
<span class="cm"> * here we pause local counters and then grab a rwlock and leave the</span>
<span class="cm"> * counters on other CPUs alone. If any counter interrupt raises while</span>
<span class="cm"> * we own the write lock, simply pause local counters on that CPU and</span>
<span class="cm"> * spin in the handler. Also we know we won&#39;t be switched to another</span>
<span class="cm"> * CPU after pausing local counters and before grabbing the lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mipspmu_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmu</span> <span class="o">*</span><span class="n">pmu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pause_local_counters</span><span class="p">();</span>
<span class="cp">#ifdef CONFIG_MIPS_MT_SMP</span>
	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmuint_rwlock</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">atomic_t</span> <span class="n">active_events</span> <span class="o">=</span> <span class="n">ATOMIC_INIT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">pmu_reserve_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">save_perf_irq</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mipspmu_get_irq</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mipspmu</span><span class="p">.</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Request my own irq handler. */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">mipspmu</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">mipsxx_pmu_handle_irq</span><span class="p">,</span>
			<span class="n">IRQF_PERCPU</span> <span class="o">|</span> <span class="n">IRQF_NOBALANCING</span><span class="p">,</span>
			<span class="s">&quot;mips_perf_pmu&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Unable to request IRQ%d for MIPS &quot;</span>
			   <span class="s">&quot;performance counters!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mipspmu</span><span class="p">.</span><span class="n">irq</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cp0_perfcount_irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We are sharing the irq number with the timer interrupt.</span>
<span class="cm">		 */</span>
		<span class="n">save_perf_irq</span> <span class="o">=</span> <span class="n">perf_irq</span><span class="p">;</span>
		<span class="n">perf_irq</span> <span class="o">=</span> <span class="n">mipsxx_pmu_handle_shared_irq</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;The platform hasn&#39;t properly defined its &quot;</span>
			<span class="s">&quot;interrupt controller.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mipspmu_free_irq</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mipspmu</span><span class="p">.</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">mipspmu</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cp0_perfcount_irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">perf_irq</span> <span class="o">=</span> <span class="n">save_perf_irq</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * mipsxx/rm9000/loongson2 have different performance counters, they have</span>
<span class="cm"> * specific low-level init routines.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">reset_counters</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__hw_perf_event_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hw_perf_event_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">active_events</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">pmu_reserve_mutex</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We must not call the destroy function with interrupts</span>
<span class="cm">		 * disabled.</span>
<span class="cm">		 */</span>
		<span class="n">on_each_cpu</span><span class="p">(</span><span class="n">reset_counters</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">mipspmu</span><span class="p">.</span><span class="n">num_counters</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">mipspmu_free_irq</span><span class="p">();</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmu_reserve_mutex</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mipspmu_event_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* does not support taken branch sampling */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">has_branch_stack</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PERF_TYPE_RAW</span>:
	<span class="k">case</span> <span class="n">PERF_TYPE_HARDWARE</span>:
	<span class="k">case</span> <span class="n">PERF_TYPE_HW_CACHE</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">&gt;=</span> <span class="n">nr_cpumask_bits</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cpu_online</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_inc_not_zero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">active_events</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmu_reserve_mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">active_events</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">mipspmu_get_irq</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">active_events</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmu_reserve_mutex</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">__hw_perf_event_init</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pmu</span> <span class="n">pmu</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">pmu_enable</span>	<span class="o">=</span> <span class="n">mipspmu_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pmu_disable</span>	<span class="o">=</span> <span class="n">mipspmu_disable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">event_init</span>	<span class="o">=</span> <span class="n">mipspmu_event_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">add</span>		<span class="o">=</span> <span class="n">mipspmu_add</span><span class="p">,</span>
	<span class="p">.</span><span class="n">del</span>		<span class="o">=</span> <span class="n">mipspmu_del</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span>		<span class="o">=</span> <span class="n">mipspmu_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>		<span class="o">=</span> <span class="n">mipspmu_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">mipspmu_read</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">mipspmu_perf_event_encode</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">mips_perf_event</span> <span class="o">*</span><span class="n">pev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/*</span>
<span class="cm"> * Top 8 bits for range, next 16 bits for cntr_mask, lowest 8 bits for</span>
<span class="cm"> * event_id.</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_MIPS_MT_SMP</span>
	<span class="k">return</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">range</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">cntr_mask</span> <span class="o">&amp;</span> <span class="mh">0xffff00</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">event_id</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">cntr_mask</span> <span class="o">&amp;</span> <span class="mh">0xffff00</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">event_id</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mips_perf_event</span> <span class="o">*</span><span class="nf">mipspmu_map_general_event</span><span class="p">(</span><span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">mips_perf_event</span> <span class="o">*</span><span class="n">pev</span><span class="p">;</span>

	<span class="n">pev</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="n">mipspmu</span><span class="p">.</span><span class="n">general_event_map</span><span class="p">)[</span><span class="n">idx</span><span class="p">].</span><span class="n">event_id</span> <span class="o">==</span>
		<span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="o">?</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">)</span> <span class="o">:</span>
		<span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">mipspmu</span><span class="p">.</span><span class="n">general_event_map</span><span class="p">)[</span><span class="n">idx</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">pev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mips_perf_event</span> <span class="o">*</span><span class="nf">mipspmu_map_cache_event</span><span class="p">(</span><span class="n">u64</span> <span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cache_type</span><span class="p">,</span> <span class="n">cache_op</span><span class="p">,</span> <span class="n">cache_result</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">mips_perf_event</span> <span class="o">*</span><span class="n">pev</span><span class="p">;</span>

	<span class="n">cache_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">config</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cache_type</span> <span class="o">&gt;=</span> <span class="n">PERF_COUNT_HW_CACHE_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="n">cache_op</span> <span class="o">=</span> <span class="p">(</span><span class="n">config</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cache_op</span> <span class="o">&gt;=</span> <span class="n">PERF_COUNT_HW_CACHE_OP_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="n">cache_result</span> <span class="o">=</span> <span class="p">(</span><span class="n">config</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cache_result</span> <span class="o">&gt;=</span> <span class="n">PERF_COUNT_HW_CACHE_RESULT_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="n">pev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="o">*</span><span class="n">mipspmu</span><span class="p">.</span><span class="n">cache_event_map</span><span class="p">)</span>
					<span class="p">[</span><span class="n">cache_type</span><span class="p">]</span>
					<span class="p">[</span><span class="n">cache_op</span><span class="p">]</span>
					<span class="p">[</span><span class="n">cache_result</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">event_id</span> <span class="o">==</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pev</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">validate_group</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">sibling</span><span class="p">,</span> <span class="o">*</span><span class="n">leader</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">group_leader</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="n">fake_cpuc</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fake_cpuc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fake_cpuc</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mipsxx_pmu_alloc_counter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fake_cpuc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">leader</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sibling</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">leader</span><span class="o">-&gt;</span><span class="n">sibling_list</span><span class="p">,</span> <span class="n">group_entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mipsxx_pmu_alloc_counter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fake_cpuc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sibling</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mipsxx_pmu_alloc_counter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fake_cpuc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This is needed by specific irq handlers in perf_event_*.c */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_associated_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">perf_sample_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span> <span class="o">=</span> <span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">hw_perf_event</span> <span class="o">*</span><span class="n">hwc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">mipspmu_event_update</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">hwc</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">period</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">last_period</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mipspmu_event_set_period</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">hwc</span><span class="p">,</span> <span class="n">idx</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">perf_event_overflow</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">regs</span><span class="p">))</span>
		<span class="n">mipsxx_pmu_disable_event</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">__n_counters</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">read_c0_config1</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">M_CONFIG1_PC</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">read_c0_perfctrl0</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">M_PERFCTL_MORE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">read_c0_perfctrl1</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">M_PERFCTL_MORE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">read_c0_perfctrl2</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">M_PERFCTL_MORE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">n_counters</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">counters</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">current_cpu_type</span><span class="p">())</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CPU_R10000</span>:
		<span class="n">counters</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CPU_R12000</span>:
	<span class="k">case</span> <span class="n">CPU_R14000</span>:
		<span class="n">counters</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">counters</span> <span class="o">=</span> <span class="n">__n_counters</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">counters</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_counters</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">counters</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">counters</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">mipsxx_pmu_write_control</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">mipspmu</span><span class="p">.</span><span class="n">write_counter</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">mipsxx_pmu_write_control</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">mipspmu</span><span class="p">.</span><span class="n">write_counter</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">mipsxx_pmu_write_control</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">mipspmu</span><span class="p">.</span><span class="n">write_counter</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">mipsxx_pmu_write_control</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">mipspmu</span><span class="p">.</span><span class="n">write_counter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* 24K/34K/1004K cores can share the same event map. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mips_perf_event</span> <span class="n">mipsxxcore_event_map</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">PERF_COUNT_HW_CPU_CYCLES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">CNTR_EVEN</span> <span class="o">|</span> <span class="n">CNTR_ODD</span><span class="p">,</span> <span class="n">P</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">PERF_COUNT_HW_INSTRUCTIONS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">CNTR_EVEN</span> <span class="o">|</span> <span class="n">CNTR_ODD</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_REFERENCES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_MISSES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">PERF_COUNT_HW_BRANCH_INSTRUCTIONS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="n">CNTR_EVEN</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">PERF_COUNT_HW_BRANCH_MISSES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="n">CNTR_ODD</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">PERF_COUNT_HW_BUS_CYCLES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* 74K core has different branch event code. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mips_perf_event</span> <span class="n">mipsxx74Kcore_event_map</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">PERF_COUNT_HW_CPU_CYCLES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">CNTR_EVEN</span> <span class="o">|</span> <span class="n">CNTR_ODD</span><span class="p">,</span> <span class="n">P</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">PERF_COUNT_HW_INSTRUCTIONS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">CNTR_EVEN</span> <span class="o">|</span> <span class="n">CNTR_ODD</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_REFERENCES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_MISSES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">PERF_COUNT_HW_BRANCH_INSTRUCTIONS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x27</span><span class="p">,</span> <span class="n">CNTR_EVEN</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">PERF_COUNT_HW_BRANCH_MISSES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x27</span><span class="p">,</span> <span class="n">CNTR_ODD</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">PERF_COUNT_HW_BUS_CYCLES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mips_perf_event</span> <span class="n">octeon_event_map</span><span class="p">[</span><span class="n">PERF_COUNT_HW_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">PERF_COUNT_HW_CPU_CYCLES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">CNTR_ALL</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">PERF_COUNT_HW_INSTRUCTIONS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x03</span><span class="p">,</span> <span class="n">CNTR_ALL</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_REFERENCES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="n">CNTR_ALL</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_MISSES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="n">CNTR_ALL</span>  <span class="p">},</span>
	<span class="p">[</span><span class="n">PERF_COUNT_HW_BRANCH_INSTRUCTIONS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">CNTR_ALL</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">PERF_COUNT_HW_BRANCH_MISSES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x09</span><span class="p">,</span> <span class="n">CNTR_ALL</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">PERF_COUNT_HW_BUS_CYCLES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x25</span><span class="p">,</span> <span class="n">CNTR_ALL</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* 24K/34K/1004K cores can share the same cache event map. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mips_perf_event</span> <span class="n">mipsxxcore_cache_map</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_MAX</span><span class="p">]</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_OP_MAX</span><span class="p">]</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_RESULT_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">L1D</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Like some other architectures (e.g. ARM), the performance</span>
<span class="cm">	 * counters don&#39;t differentiate between read and write</span>
<span class="cm">	 * accesses/misses, so this isn&#39;t strictly correct, but it&#39;s the</span>
<span class="cm">	 * best we can do. Writes and reads get combined.</span>
<span class="cm">	 */</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="n">CNTR_EVEN</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="n">CNTR_EVEN</span> <span class="o">|</span> <span class="n">CNTR_ODD</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="n">CNTR_EVEN</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="n">CNTR_EVEN</span> <span class="o">|</span> <span class="n">CNTR_ODD</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">},</span>
<span class="p">},</span>
<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">L1I</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x09</span><span class="p">,</span> <span class="n">CNTR_EVEN</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x09</span><span class="p">,</span> <span class="n">CNTR_ODD</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x09</span><span class="p">,</span> <span class="n">CNTR_EVEN</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x09</span><span class="p">,</span> <span class="n">CNTR_ODD</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x14</span><span class="p">,</span> <span class="n">CNTR_EVEN</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
		<span class="cm">/*</span>
<span class="cm">		 * Note that MIPS has only &quot;hit&quot; events countable for</span>
<span class="cm">		 * the prefetch operation.</span>
<span class="cm">		 */</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">},</span>
<span class="p">},</span>
<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">LL</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x15</span><span class="p">,</span> <span class="n">CNTR_ODD</span><span class="p">,</span> <span class="n">P</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x16</span><span class="p">,</span> <span class="n">CNTR_EVEN</span><span class="p">,</span> <span class="n">P</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x15</span><span class="p">,</span> <span class="n">CNTR_ODD</span><span class="p">,</span> <span class="n">P</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x16</span><span class="p">,</span> <span class="n">CNTR_EVEN</span><span class="p">,</span> <span class="n">P</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">},</span>
<span class="p">},</span>
<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">DTLB</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="n">CNTR_EVEN</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="n">CNTR_ODD</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="n">CNTR_EVEN</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="n">CNTR_ODD</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">},</span>
<span class="p">},</span>
<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">ITLB</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x05</span><span class="p">,</span> <span class="n">CNTR_EVEN</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x05</span><span class="p">,</span> <span class="n">CNTR_ODD</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x05</span><span class="p">,</span> <span class="n">CNTR_EVEN</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x05</span><span class="p">,</span> <span class="n">CNTR_ODD</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">},</span>
<span class="p">},</span>
<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">BPU</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Using the same code for *HW_BRANCH* */</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="n">CNTR_EVEN</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="n">CNTR_ODD</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="n">CNTR_EVEN</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="n">CNTR_ODD</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">},</span>
<span class="p">},</span>
<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">NODE</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">},</span>
<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* 74K core has completely different cache event map. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mips_perf_event</span> <span class="n">mipsxx74Kcore_cache_map</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_MAX</span><span class="p">]</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_OP_MAX</span><span class="p">]</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_RESULT_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">L1D</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Like some other architectures (e.g. ARM), the performance</span>
<span class="cm">	 * counters don&#39;t differentiate between read and write</span>
<span class="cm">	 * accesses/misses, so this isn&#39;t strictly correct, but it&#39;s the</span>
<span class="cm">	 * best we can do. Writes and reads get combined.</span>
<span class="cm">	 */</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x17</span><span class="p">,</span> <span class="n">CNTR_ODD</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">CNTR_ODD</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x17</span><span class="p">,</span> <span class="n">CNTR_ODD</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">CNTR_ODD</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">},</span>
<span class="p">},</span>
<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">L1I</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="n">CNTR_EVEN</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="n">CNTR_ODD</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="n">CNTR_EVEN</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="n">CNTR_ODD</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x34</span><span class="p">,</span> <span class="n">CNTR_EVEN</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
		<span class="cm">/*</span>
<span class="cm">		 * Note that MIPS has only &quot;hit&quot; events countable for</span>
<span class="cm">		 * the prefetch operation.</span>
<span class="cm">		 */</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">},</span>
<span class="p">},</span>
<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">LL</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="n">CNTR_ODD</span><span class="p">,</span> <span class="n">P</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="n">CNTR_EVEN</span> <span class="o">|</span> <span class="n">CNTR_ODD</span><span class="p">,</span> <span class="n">P</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="n">CNTR_ODD</span><span class="p">,</span> <span class="n">P</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="n">CNTR_EVEN</span> <span class="o">|</span> <span class="n">CNTR_ODD</span><span class="p">,</span> <span class="n">P</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">},</span>
<span class="p">},</span>
<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">DTLB</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* 74K core does not have specific DTLB events. */</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">},</span>
<span class="p">},</span>
<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">ITLB</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="n">CNTR_EVEN</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="n">CNTR_ODD</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="n">CNTR_EVEN</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="n">CNTR_ODD</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">},</span>
<span class="p">},</span>
<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">BPU</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Using the same code for *HW_BRANCH* */</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x27</span><span class="p">,</span> <span class="n">CNTR_EVEN</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x27</span><span class="p">,</span> <span class="n">CNTR_ODD</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x27</span><span class="p">,</span> <span class="n">CNTR_EVEN</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x27</span><span class="p">,</span> <span class="n">CNTR_ODD</span><span class="p">,</span> <span class="n">T</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">},</span>
<span class="p">},</span>
<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">NODE</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">},</span>
<span class="p">},</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mips_perf_event</span> <span class="n">octeon_cache_map</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_MAX</span><span class="p">]</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_OP_MAX</span><span class="p">]</span>
				<span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_RESULT_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">L1D</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="n">CNTR_ALL</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="n">CNTR_ALL</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x30</span><span class="p">,</span> <span class="n">CNTR_ALL</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">},</span>
<span class="p">},</span>
<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">L1I</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">CNTR_ALL</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x19</span><span class="p">,</span> <span class="n">CNTR_ALL</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">},</span>
<span class="p">},</span>
<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">LL</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">},</span>
<span class="p">},</span>
<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">DTLB</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Only general DTLB misses are counted use the same event for</span>
<span class="cm">	 * read and write.</span>
<span class="cm">	 */</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x35</span><span class="p">,</span> <span class="n">CNTR_ALL</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x35</span><span class="p">,</span> <span class="n">CNTR_ALL</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">},</span>
<span class="p">},</span>
<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">ITLB</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x37</span><span class="p">,</span> <span class="n">CNTR_ALL</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">},</span>
<span class="p">},</span>
<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">BPU</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Using the same code for *HW_BRANCH* */</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_READ</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_WRITE</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">OP_PREFETCH</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_ACCESS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
		<span class="p">[</span><span class="n">C</span><span class="p">(</span><span class="n">RESULT_MISS</span><span class="p">)]</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">UNSUPPORTED_PERF_EVENT_ID</span> <span class="p">},</span>
	<span class="p">},</span>
<span class="p">},</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_MIPS_MT_SMP</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_and_calc_range</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
				 <span class="k">const</span> <span class="k">struct</span> <span class="n">mips_perf_event</span> <span class="o">*</span><span class="n">pev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw_perf_event</span> <span class="o">*</span><span class="n">hwc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pev</span><span class="o">-&gt;</span><span class="n">range</span> <span class="o">&gt;</span> <span class="n">V</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * The user selected an event that is processor</span>
<span class="cm">			 * wide, while expecting it to be VPE wide.</span>
<span class="cm">			 */</span>
			<span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config_base</span> <span class="o">|=</span> <span class="n">M_TC_EN_ALL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * FIXME: cpu_data[event-&gt;cpu].vpe_id reports 0</span>
<span class="cm">			 * for both CPUs.</span>
<span class="cm">			 */</span>
			<span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config_base</span> <span class="o">|=</span> <span class="n">M_PERFCTL_VPEID</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>
			<span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config_base</span> <span class="o">|=</span> <span class="n">M_TC_EN_VPE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config_base</span> <span class="o">|=</span> <span class="n">M_TC_EN_ALL</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_and_calc_range</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
				 <span class="k">const</span> <span class="k">struct</span> <span class="n">mips_perf_event</span> <span class="o">*</span><span class="n">pev</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__hw_perf_event_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">perf_event_attr</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hw_perf_event</span> <span class="o">*</span><span class="n">hwc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">mips_perf_event</span> <span class="o">*</span><span class="n">pev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Returning MIPS event descriptor for generic perf event. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PERF_TYPE_HARDWARE</span> <span class="o">==</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">config</span> <span class="o">&gt;=</span> <span class="n">PERF_COUNT_HW_MAX</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">pev</span> <span class="o">=</span> <span class="n">mipspmu_map_general_event</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">config</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">PERF_TYPE_HW_CACHE</span> <span class="o">==</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pev</span> <span class="o">=</span> <span class="n">mipspmu_map_cache_event</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">config</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">PERF_TYPE_RAW</span> <span class="o">==</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We are working on the global raw event. */</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">raw_event_mutex</span><span class="p">);</span>
		<span class="n">pev</span> <span class="o">=</span> <span class="n">mipspmu</span><span class="p">.</span><span class="n">map_raw_event</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">config</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* The event type is not (yet) supported. */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PERF_TYPE_RAW</span> <span class="o">==</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">type</span><span class="p">)</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">raw_event_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">pev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We allow max flexibility on how each individual counter shared</span>
<span class="cm">	 * by the single CPU operates (the mode exclusion and the range).</span>
<span class="cm">	 */</span>
	<span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config_base</span> <span class="o">=</span> <span class="n">M_PERFCTL_INTERRUPT_ENABLE</span><span class="p">;</span>

	<span class="cm">/* Calculate range bits and validate it. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_possible_cpus</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">check_and_calc_range</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">pev</span><span class="p">);</span>

	<span class="n">hwc</span><span class="o">-&gt;</span><span class="n">event_base</span> <span class="o">=</span> <span class="n">mipspmu_perf_event_encode</span><span class="p">(</span><span class="n">pev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PERF_TYPE_RAW</span> <span class="o">==</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">type</span><span class="p">)</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">raw_event_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">exclude_user</span><span class="p">)</span>
		<span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config_base</span> <span class="o">|=</span> <span class="n">M_PERFCTL_USER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">exclude_kernel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config_base</span> <span class="o">|=</span> <span class="n">M_PERFCTL_KERNEL</span><span class="p">;</span>
		<span class="cm">/* MIPS kernel mode: KSU == 00b || EXL == 1 || ERL == 1 */</span>
		<span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config_base</span> <span class="o">|=</span> <span class="n">M_PERFCTL_EXL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">exclude_hv</span><span class="p">)</span>
		<span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config_base</span> <span class="o">|=</span> <span class="n">M_PERFCTL_SUPERVISOR</span><span class="p">;</span>

	<span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config_base</span> <span class="o">&amp;=</span> <span class="n">M_PERFCTL_CONFIG_MASK</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * The event can belong to another cpu. We do not assign a local</span>
<span class="cm">	 * counter for it for now.</span>
<span class="cm">	 */</span>
	<span class="n">hwc</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">hwc</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">sample_period</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hwc</span><span class="o">-&gt;</span><span class="n">sample_period</span>  <span class="o">=</span> <span class="n">mipspmu</span><span class="p">.</span><span class="n">max_period</span><span class="p">;</span>
		<span class="n">hwc</span><span class="o">-&gt;</span><span class="n">last_period</span>    <span class="o">=</span> <span class="n">hwc</span><span class="o">-&gt;</span><span class="n">sample_period</span><span class="p">;</span>
		<span class="n">local64_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwc</span><span class="o">-&gt;</span><span class="n">period_left</span><span class="p">,</span> <span class="n">hwc</span><span class="o">-&gt;</span><span class="n">sample_period</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">group_leader</span> <span class="o">!=</span> <span class="n">event</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">validate_group</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>

	<span class="n">event</span><span class="o">-&gt;</span><span class="n">destroy</span> <span class="o">=</span> <span class="n">hw_perf_event_destroy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pause_local_counters</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">cpu_hw_events</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ctr</span> <span class="o">=</span> <span class="n">mipspmu</span><span class="p">.</span><span class="n">num_counters</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ctr</span><span class="o">--</span><span class="p">;</span>
		<span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">saved_ctrl</span><span class="p">[</span><span class="n">ctr</span><span class="p">]</span> <span class="o">=</span> <span class="n">mipsxx_pmu_read_control</span><span class="p">(</span><span class="n">ctr</span><span class="p">);</span>
		<span class="n">mipsxx_pmu_write_control</span><span class="p">(</span><span class="n">ctr</span><span class="p">,</span> <span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">saved_ctrl</span><span class="p">[</span><span class="n">ctr</span><span class="p">]</span> <span class="o">&amp;</span>
					 <span class="o">~</span><span class="n">M_PERFCTL_COUNT_EVENT_WHENEVER</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ctr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">resume_local_counters</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">cpu_hw_events</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ctr</span> <span class="o">=</span> <span class="n">mipspmu</span><span class="p">.</span><span class="n">num_counters</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ctr</span><span class="o">--</span><span class="p">;</span>
		<span class="n">mipsxx_pmu_write_control</span><span class="p">(</span><span class="n">ctr</span><span class="p">,</span> <span class="n">cpuc</span><span class="o">-&gt;</span><span class="n">saved_ctrl</span><span class="p">[</span><span class="n">ctr</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ctr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mipsxx_pmu_handle_shared_irq</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpu_hw_events</span> <span class="o">*</span><span class="n">cpuc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">cpu_hw_events</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">perf_sample_data</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">counters</span> <span class="o">=</span> <span class="n">mipspmu</span><span class="p">.</span><span class="n">num_counters</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">counter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_mips_r2</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">read_c0_cause</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">handled</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * First we pause the local counters, so that when we are locked</span>
<span class="cm">	 * here, the counters are all paused. When it gets locked due to</span>
<span class="cm">	 * perf_disable(), the timer interrupt handler will be delayed.</span>
<span class="cm">	 *</span>
<span class="cm">	 * See also mipsxx_pmu_start().</span>
<span class="cm">	 */</span>
	<span class="n">pause_local_counters</span><span class="p">();</span>
<span class="cp">#ifdef CONFIG_MIPS_MT_SMP</span>
	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmuint_rwlock</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">regs</span> <span class="o">=</span> <span class="n">get_irq_regs</span><span class="p">();</span>

	<span class="n">perf_sample_data_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">counters</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#define HANDLE_COUNTER(n)						\</span>
<span class="cp">	case n + 1:							\</span>
<span class="cp">		if (test_bit(n, cpuc-&gt;used_mask)) {			\</span>
<span class="cp">			counter = mipspmu.read_counter(n);		\</span>
<span class="cp">			if (counter &amp; mipspmu.overflow) {		\</span>
<span class="cp">				handle_associated_event(cpuc, n, &amp;data, regs); \</span>
<span class="cp">				handled = IRQ_HANDLED;			\</span>
<span class="cp">			}						\</span>
<span class="cp">		}</span>
	<span class="n">HANDLE_COUNTER</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
	<span class="n">HANDLE_COUNTER</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
	<span class="n">HANDLE_COUNTER</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
	<span class="n">HANDLE_COUNTER</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Do all the work for the pending perf events. We can do this</span>
<span class="cm">	 * in here because the performance counter interrupt is a regular</span>
<span class="cm">	 * interrupt, not NMI.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">handled</span> <span class="o">==</span> <span class="n">IRQ_HANDLED</span><span class="p">)</span>
		<span class="n">irq_work_run</span><span class="p">();</span>

<span class="cp">#ifdef CONFIG_MIPS_MT_SMP</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmuint_rwlock</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">resume_local_counters</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">handled</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">mipsxx_pmu_handle_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mipsxx_pmu_handle_shared_irq</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* 24K */</span>
<span class="cp">#define IS_BOTH_COUNTERS_24K_EVENT(b)					\</span>
<span class="cp">	((b) == 0 || (b) == 1 || (b) == 11)</span>

<span class="cm">/* 34K */</span>
<span class="cp">#define IS_BOTH_COUNTERS_34K_EVENT(b)					\</span>
<span class="cp">	((b) == 0 || (b) == 1 || (b) == 11)</span>
<span class="cp">#ifdef CONFIG_MIPS_MT_SMP</span>
<span class="cp">#define IS_RANGE_P_34K_EVENT(r, b)					\</span>
<span class="cp">	((b) == 0 || (r) == 18 || (b) == 21 || (b) == 22 ||		\</span>
<span class="cp">	 (b) == 25 || (b) == 39 || (r) == 44 || (r) == 174 ||		\</span>
<span class="cp">	 (r) == 176 || ((b) &gt;= 50 &amp;&amp; (b) &lt;= 55) ||			\</span>
<span class="cp">	 ((b) &gt;= 64 &amp;&amp; (b) &lt;= 67))</span>
<span class="cp">#define IS_RANGE_V_34K_EVENT(r)	((r) == 47)</span>
<span class="cp">#endif</span>

<span class="cm">/* 74K */</span>
<span class="cp">#define IS_BOTH_COUNTERS_74K_EVENT(b)					\</span>
<span class="cp">	((b) == 0 || (b) == 1)</span>

<span class="cm">/* 1004K */</span>
<span class="cp">#define IS_BOTH_COUNTERS_1004K_EVENT(b)					\</span>
<span class="cp">	((b) == 0 || (b) == 1 || (b) == 11)</span>
<span class="cp">#ifdef CONFIG_MIPS_MT_SMP</span>
<span class="cp">#define IS_RANGE_P_1004K_EVENT(r, b)					\</span>
<span class="cp">	((b) == 0 || (r) == 18 || (b) == 21 || (b) == 22 ||		\</span>
<span class="cp">	 (b) == 25 || (b) == 36 || (b) == 39 || (r) == 44 ||		\</span>
<span class="cp">	 (r) == 174 || (r) == 176 || ((b) &gt;= 50 &amp;&amp; (b) &lt;= 59) ||	\</span>
<span class="cp">	 (r) == 188 || (b) == 61 || (b) == 62 ||			\</span>
<span class="cp">	 ((b) &gt;= 64 &amp;&amp; (b) &lt;= 67))</span>
<span class="cp">#define IS_RANGE_V_1004K_EVENT(r)	((r) == 47)</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * User can use 0-255 raw events, where 0-127 for the events of even</span>
<span class="cm"> * counters, and 128-255 for odd counters. Note that bit 7 is used to</span>
<span class="cm"> * indicate the parity. So, for example, when user wants to take the</span>
<span class="cm"> * Event Num of 15 for odd counters (by referring to the user manual),</span>
<span class="cm"> * then 128 needs to be added to 15 as the input for the event config,</span>
<span class="cm"> * i.e., 143 (0x8F) to be used.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mips_perf_event</span> <span class="o">*</span><span class="nf">mipsxx_pmu_map_raw_event</span><span class="p">(</span><span class="n">u64</span> <span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">raw_id</span> <span class="o">=</span> <span class="n">config</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">base_id</span> <span class="o">=</span> <span class="n">raw_id</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>

	<span class="n">raw_event</span><span class="p">.</span><span class="n">event_id</span> <span class="o">=</span> <span class="n">base_id</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">current_cpu_type</span><span class="p">())</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CPU_24K</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_BOTH_COUNTERS_24K_EVENT</span><span class="p">(</span><span class="n">base_id</span><span class="p">))</span>
			<span class="n">raw_event</span><span class="p">.</span><span class="n">cntr_mask</span> <span class="o">=</span> <span class="n">CNTR_EVEN</span> <span class="o">|</span> <span class="n">CNTR_ODD</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">raw_event</span><span class="p">.</span><span class="n">cntr_mask</span> <span class="o">=</span>
				<span class="n">raw_id</span> <span class="o">&gt;</span> <span class="mi">127</span> <span class="o">?</span> <span class="n">CNTR_ODD</span> <span class="o">:</span> <span class="n">CNTR_EVEN</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_MIPS_MT_SMP</span>
		<span class="cm">/*</span>
<span class="cm">		 * This is actually doing nothing. Non-multithreading</span>
<span class="cm">		 * CPUs will not check and calculate the range.</span>
<span class="cm">		 */</span>
		<span class="n">raw_event</span><span class="p">.</span><span class="n">range</span> <span class="o">=</span> <span class="n">P</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPU_34K</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_BOTH_COUNTERS_34K_EVENT</span><span class="p">(</span><span class="n">base_id</span><span class="p">))</span>
			<span class="n">raw_event</span><span class="p">.</span><span class="n">cntr_mask</span> <span class="o">=</span> <span class="n">CNTR_EVEN</span> <span class="o">|</span> <span class="n">CNTR_ODD</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">raw_event</span><span class="p">.</span><span class="n">cntr_mask</span> <span class="o">=</span>
				<span class="n">raw_id</span> <span class="o">&gt;</span> <span class="mi">127</span> <span class="o">?</span> <span class="n">CNTR_ODD</span> <span class="o">:</span> <span class="n">CNTR_EVEN</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_MIPS_MT_SMP</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_RANGE_P_34K_EVENT</span><span class="p">(</span><span class="n">raw_id</span><span class="p">,</span> <span class="n">base_id</span><span class="p">))</span>
			<span class="n">raw_event</span><span class="p">.</span><span class="n">range</span> <span class="o">=</span> <span class="n">P</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">IS_RANGE_V_34K_EVENT</span><span class="p">(</span><span class="n">raw_id</span><span class="p">)))</span>
			<span class="n">raw_event</span><span class="p">.</span><span class="n">range</span> <span class="o">=</span> <span class="n">V</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">raw_event</span><span class="p">.</span><span class="n">range</span> <span class="o">=</span> <span class="n">T</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPU_74K</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_BOTH_COUNTERS_74K_EVENT</span><span class="p">(</span><span class="n">base_id</span><span class="p">))</span>
			<span class="n">raw_event</span><span class="p">.</span><span class="n">cntr_mask</span> <span class="o">=</span> <span class="n">CNTR_EVEN</span> <span class="o">|</span> <span class="n">CNTR_ODD</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">raw_event</span><span class="p">.</span><span class="n">cntr_mask</span> <span class="o">=</span>
				<span class="n">raw_id</span> <span class="o">&gt;</span> <span class="mi">127</span> <span class="o">?</span> <span class="n">CNTR_ODD</span> <span class="o">:</span> <span class="n">CNTR_EVEN</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_MIPS_MT_SMP</span>
		<span class="n">raw_event</span><span class="p">.</span><span class="n">range</span> <span class="o">=</span> <span class="n">P</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPU_1004K</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_BOTH_COUNTERS_1004K_EVENT</span><span class="p">(</span><span class="n">base_id</span><span class="p">))</span>
			<span class="n">raw_event</span><span class="p">.</span><span class="n">cntr_mask</span> <span class="o">=</span> <span class="n">CNTR_EVEN</span> <span class="o">|</span> <span class="n">CNTR_ODD</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">raw_event</span><span class="p">.</span><span class="n">cntr_mask</span> <span class="o">=</span>
				<span class="n">raw_id</span> <span class="o">&gt;</span> <span class="mi">127</span> <span class="o">?</span> <span class="n">CNTR_ODD</span> <span class="o">:</span> <span class="n">CNTR_EVEN</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_MIPS_MT_SMP</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_RANGE_P_1004K_EVENT</span><span class="p">(</span><span class="n">raw_id</span><span class="p">,</span> <span class="n">base_id</span><span class="p">))</span>
			<span class="n">raw_event</span><span class="p">.</span><span class="n">range</span> <span class="o">=</span> <span class="n">P</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">IS_RANGE_V_1004K_EVENT</span><span class="p">(</span><span class="n">raw_id</span><span class="p">)))</span>
			<span class="n">raw_event</span><span class="p">.</span><span class="n">range</span> <span class="o">=</span> <span class="n">V</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">raw_event</span><span class="p">.</span><span class="n">range</span> <span class="o">=</span> <span class="n">T</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">raw_event</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mips_perf_event</span> <span class="o">*</span><span class="nf">octeon_pmu_map_raw_event</span><span class="p">(</span><span class="n">u64</span> <span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">raw_id</span> <span class="o">=</span> <span class="n">config</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">base_id</span> <span class="o">=</span> <span class="n">raw_id</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>


	<span class="n">raw_event</span><span class="p">.</span><span class="n">cntr_mask</span> <span class="o">=</span> <span class="n">CNTR_ALL</span><span class="p">;</span>
	<span class="n">raw_event</span><span class="p">.</span><span class="n">event_id</span> <span class="o">=</span> <span class="n">base_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">current_cpu_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">CPU_CAVIUM_OCTEON2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">base_id</span> <span class="o">&gt;</span> <span class="mh">0x42</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">base_id</span> <span class="o">&gt;</span> <span class="mh">0x3a</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">base_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x00</span>:
	<span class="k">case</span> <span class="mh">0x0f</span>:
	<span class="k">case</span> <span class="mh">0x1e</span>:
	<span class="k">case</span> <span class="mh">0x1f</span>:
	<span class="k">case</span> <span class="mh">0x2f</span>:
	<span class="k">case</span> <span class="mh">0x34</span>:
	<span class="k">case</span> <span class="mh">0x3b</span> <span class="p">...</span> <span class="mh">0x3f</span>:
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">raw_event</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">init_hw_perf_events</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">counters</span><span class="p">,</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">counter_bits</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Performance counters: &quot;</span><span class="p">);</span>

	<span class="n">counters</span> <span class="o">=</span> <span class="n">n_counters</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">counters</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;No available PMU.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_MIPS_MT_SMP</span>
	<span class="n">cpu_has_mipsmt_pertccounters</span> <span class="o">=</span> <span class="n">read_c0_config7</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">19</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_has_mipsmt_pertccounters</span><span class="p">)</span>
		<span class="n">counters</span> <span class="o">=</span> <span class="n">counters_total_to_per_cpu</span><span class="p">(</span><span class="n">counters</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef MSC01E_INT_BASE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_veic</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Using platform specific interrupt controller defines.</span>
<span class="cm">		 */</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">MSC01E_INT_BASE</span> <span class="o">+</span> <span class="n">MSC01E_INT_PERFCTR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cp0_perfcount_irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">cp0_compare_irq</span> <span class="o">!=</span> <span class="n">cp0_perfcount_irq</span><span class="p">))</span>
			<span class="n">irq</span> <span class="o">=</span> <span class="n">MIPS_CPU_IRQ_BASE</span> <span class="o">+</span> <span class="n">cp0_perfcount_irq</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="cp">#ifdef MSC01E_INT_BASE</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">mipspmu</span><span class="p">.</span><span class="n">map_raw_event</span> <span class="o">=</span> <span class="n">mipsxx_pmu_map_raw_event</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">current_cpu_type</span><span class="p">())</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CPU_24K</span>:
		<span class="n">mipspmu</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;mips/24K&quot;</span><span class="p">;</span>
		<span class="n">mipspmu</span><span class="p">.</span><span class="n">general_event_map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mipsxxcore_event_map</span><span class="p">;</span>
		<span class="n">mipspmu</span><span class="p">.</span><span class="n">cache_event_map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mipsxxcore_cache_map</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPU_34K</span>:
		<span class="n">mipspmu</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;mips/34K&quot;</span><span class="p">;</span>
		<span class="n">mipspmu</span><span class="p">.</span><span class="n">general_event_map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mipsxxcore_event_map</span><span class="p">;</span>
		<span class="n">mipspmu</span><span class="p">.</span><span class="n">cache_event_map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mipsxxcore_cache_map</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPU_74K</span>:
		<span class="n">mipspmu</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;mips/74K&quot;</span><span class="p">;</span>
		<span class="n">mipspmu</span><span class="p">.</span><span class="n">general_event_map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mipsxx74Kcore_event_map</span><span class="p">;</span>
		<span class="n">mipspmu</span><span class="p">.</span><span class="n">cache_event_map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mipsxx74Kcore_cache_map</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPU_1004K</span>:
		<span class="n">mipspmu</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;mips/1004K&quot;</span><span class="p">;</span>
		<span class="n">mipspmu</span><span class="p">.</span><span class="n">general_event_map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mipsxxcore_event_map</span><span class="p">;</span>
		<span class="n">mipspmu</span><span class="p">.</span><span class="n">cache_event_map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mipsxxcore_cache_map</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPU_CAVIUM_OCTEON</span>:
	<span class="k">case</span> <span class="n">CPU_CAVIUM_OCTEON_PLUS</span>:
	<span class="k">case</span> <span class="n">CPU_CAVIUM_OCTEON2</span>:
		<span class="n">mipspmu</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;octeon&quot;</span><span class="p">;</span>
		<span class="n">mipspmu</span><span class="p">.</span><span class="n">general_event_map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">octeon_event_map</span><span class="p">;</span>
		<span class="n">mipspmu</span><span class="p">.</span><span class="n">cache_event_map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">octeon_cache_map</span><span class="p">;</span>
		<span class="n">mipspmu</span><span class="p">.</span><span class="n">map_raw_event</span> <span class="o">=</span> <span class="n">octeon_pmu_map_raw_event</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;Either hardware does not support performance &quot;</span>
			<span class="s">&quot;counters, or not yet implemented.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mipspmu</span><span class="p">.</span><span class="n">num_counters</span> <span class="o">=</span> <span class="n">counters</span><span class="p">;</span>
	<span class="n">mipspmu</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read_c0_perfctrl0</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">M_PERFCTL_WIDE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mipspmu</span><span class="p">.</span><span class="n">max_period</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">63</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mipspmu</span><span class="p">.</span><span class="n">valid_count</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">63</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mipspmu</span><span class="p">.</span><span class="n">overflow</span> <span class="o">=</span> <span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">63</span><span class="p">;</span>
		<span class="n">mipspmu</span><span class="p">.</span><span class="n">read_counter</span> <span class="o">=</span> <span class="n">mipsxx_pmu_read_counter_64</span><span class="p">;</span>
		<span class="n">mipspmu</span><span class="p">.</span><span class="n">write_counter</span> <span class="o">=</span> <span class="n">mipsxx_pmu_write_counter_64</span><span class="p">;</span>
		<span class="n">counter_bits</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mipspmu</span><span class="p">.</span><span class="n">max_period</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mipspmu</span><span class="p">.</span><span class="n">valid_count</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mipspmu</span><span class="p">.</span><span class="n">overflow</span> <span class="o">=</span> <span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">;</span>
		<span class="n">mipspmu</span><span class="p">.</span><span class="n">read_counter</span> <span class="o">=</span> <span class="n">mipsxx_pmu_read_counter</span><span class="p">;</span>
		<span class="n">mipspmu</span><span class="p">.</span><span class="n">write_counter</span> <span class="o">=</span> <span class="n">mipsxx_pmu_write_counter</span><span class="p">;</span>
		<span class="n">counter_bits</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">on_each_cpu</span><span class="p">(</span><span class="n">reset_counters</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">counters</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;%s PMU enabled, %d %d-bit counters available to each &quot;</span>
		<span class="s">&quot;CPU, irq %d%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mipspmu</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">counters</span><span class="p">,</span> <span class="n">counter_bits</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span>
		<span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="s">&quot; (share with timer interrupt)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">perf_pmu_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmu</span><span class="p">,</span> <span class="s">&quot;cpu&quot;</span><span class="p">,</span> <span class="n">PERF_TYPE_RAW</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">early_initcall</span><span class="p">(</span><span class="n">init_hw_perf_events</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
