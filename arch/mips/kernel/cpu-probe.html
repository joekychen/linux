<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › mips › kernel › cpu-probe.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>cpu-probe.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Processor capabilities determination functions.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) xxxx  the Anonymous</span>
<span class="cm"> * Copyright (C) 1994 - 2006 Ralf Baechle</span>
<span class="cm"> * Copyright (C) 2003, 2004  Maciej W. Rozycki</span>
<span class="cm"> * Copyright (C) 2001, 2004  MIPS Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version</span>
<span class="cm"> * 2 of the License, or (at your option) any later version.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/smp.h&gt;</span>
<span class="cp">#include &lt;linux/stddef.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>

<span class="cp">#include &lt;asm/bugs.h&gt;</span>
<span class="cp">#include &lt;asm/cpu.h&gt;</span>
<span class="cp">#include &lt;asm/fpu.h&gt;</span>
<span class="cp">#include &lt;asm/mipsregs.h&gt;</span>
<span class="cp">#include &lt;asm/watch.h&gt;</span>
<span class="cp">#include &lt;asm/elf.h&gt;</span>
<span class="cp">#include &lt;asm/spram.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * Not all of the MIPS CPUs have the &quot;wait&quot; instruction available. Moreover,</span>
<span class="cm"> * the implementation of the &quot;wait&quot; feature differs between CPU families. This</span>
<span class="cm"> * points to the function that implements CPU specific wait.</span>
<span class="cm"> * The wait instruction stops the pipeline and reduces the power consumption of</span>
<span class="cm"> * the CPU very much.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">cpu_wait</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cpu_wait</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r3081_wait</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cfg</span> <span class="o">=</span> <span class="n">read_c0_conf</span><span class="p">();</span>
	<span class="n">write_c0_conf</span><span class="p">(</span><span class="n">cfg</span> <span class="o">|</span> <span class="n">R30XX_CONF_HALT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r39xx_wait</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">local_irq_disable</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">need_resched</span><span class="p">())</span>
		<span class="n">write_c0_conf</span><span class="p">(</span><span class="n">read_c0_conf</span><span class="p">()</span> <span class="o">|</span> <span class="n">TX39_CONF_HALT</span><span class="p">);</span>
	<span class="n">local_irq_enable</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">r4k_wait</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * This variant is preferable as it allows testing need_resched and going to</span>
<span class="cm"> * sleep depending on the outcome atomically.  Unfortunately the &quot;It is</span>
<span class="cm"> * implementation-dependent whether the pipeline restarts when a non-enabled</span>
<span class="cm"> * interrupt is requested&quot; restriction in the MIPS32/MIPS64 architecture makes</span>
<span class="cm"> * using this version a gamble.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">r4k_wait_irqoff</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">local_irq_disable</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">need_resched</span><span class="p">())</span>
		<span class="n">__asm__</span><span class="p">(</span><span class="s">&quot;	.set	push		</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;	.set	mips3		</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;	wait			</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;	.set	pop		</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">local_irq_enable</span><span class="p">();</span>
	<span class="n">__asm__</span><span class="p">(</span><span class="s">&quot; 	.globl __pastwait	</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;__pastwait:			</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The RM7000 variant has to handle erratum 38.  The workaround is to not</span>
<span class="cm"> * have any pending stores when the WAIT instruction is executed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rm7k_wait_irqoff</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">local_irq_disable</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">need_resched</span><span class="p">())</span>
		<span class="n">__asm__</span><span class="p">(</span>
		<span class="s">&quot;	.set	push					</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.set	mips3					</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.set	noat					</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	mfc0	$1, $12					</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	sync						</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	mtc0	$1, $12		# stalls until W stage	</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	wait						</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	mtc0	$1, $12		# stalls until W stage	</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.set	pop					</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">local_irq_enable</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The Au1xxx wait is available only if using 32khz counter or</span>
<span class="cm"> * external timer source, but specifically not CP0 Counter.</span>
<span class="cm"> * alchemy/common/time.c may override cpu_wait!</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">au1k_wait</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__asm__</span><span class="p">(</span><span class="s">&quot;	.set	mips3			</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	cache	0x14, 0(%0)		</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	cache	0x14, 32(%0)		</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	sync				</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	nop				</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	wait				</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	nop				</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	nop				</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	nop				</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	nop				</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.set	mips0			</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="o">:</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">au1k_wait</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__initdata</span> <span class="n">nowait</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">wait_disable</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nowait</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;nowait&quot;</span><span class="p">,</span> <span class="n">wait_disable</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__cpuinitdata</span> <span class="n">mips_fpu_disabled</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">fpu_disable</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cpu_data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MIPS_CPU_FPU</span><span class="p">;</span>
	<span class="n">mips_fpu_disabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;nofpu&quot;</span><span class="p">,</span> <span class="n">fpu_disable</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">__cpuinitdata</span> <span class="n">mips_dsp_disabled</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">dsp_disable</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cpu_data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ases</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MIPS_ASE_DSP</span><span class="p">;</span>
	<span class="n">mips_dsp_disabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;nodsp&quot;</span><span class="p">,</span> <span class="n">dsp_disable</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">check_wait</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpuinfo_mips</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">current_cpu_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nowait</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Wait instruction disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CPU_R3081</span>:
	<span class="k">case</span> <span class="n">CPU_R3081E</span>:
		<span class="n">cpu_wait</span> <span class="o">=</span> <span class="n">r3081_wait</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPU_TX3927</span>:
		<span class="n">cpu_wait</span> <span class="o">=</span> <span class="n">r39xx_wait</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPU_R4200</span>:
<span class="cm">/*	case CPU_R4300: */</span>
	<span class="k">case</span> <span class="n">CPU_R4600</span>:
	<span class="k">case</span> <span class="n">CPU_R4640</span>:
	<span class="k">case</span> <span class="n">CPU_R4650</span>:
	<span class="k">case</span> <span class="n">CPU_R4700</span>:
	<span class="k">case</span> <span class="n">CPU_R5000</span>:
	<span class="k">case</span> <span class="n">CPU_R5500</span>:
	<span class="k">case</span> <span class="n">CPU_NEVADA</span>:
	<span class="k">case</span> <span class="n">CPU_4KC</span>:
	<span class="k">case</span> <span class="n">CPU_4KEC</span>:
	<span class="k">case</span> <span class="n">CPU_4KSC</span>:
	<span class="k">case</span> <span class="n">CPU_5KC</span>:
	<span class="k">case</span> <span class="n">CPU_25KF</span>:
	<span class="k">case</span> <span class="n">CPU_PR4450</span>:
	<span class="k">case</span> <span class="n">CPU_BMIPS3300</span>:
	<span class="k">case</span> <span class="n">CPU_BMIPS4350</span>:
	<span class="k">case</span> <span class="n">CPU_BMIPS4380</span>:
	<span class="k">case</span> <span class="n">CPU_BMIPS5000</span>:
	<span class="k">case</span> <span class="n">CPU_CAVIUM_OCTEON</span>:
	<span class="k">case</span> <span class="n">CPU_CAVIUM_OCTEON_PLUS</span>:
	<span class="k">case</span> <span class="n">CPU_CAVIUM_OCTEON2</span>:
	<span class="k">case</span> <span class="n">CPU_JZRISC</span>:
	<span class="k">case</span> <span class="n">CPU_XLR</span>:
	<span class="k">case</span> <span class="n">CPU_XLP</span>:
		<span class="n">cpu_wait</span> <span class="o">=</span> <span class="n">r4k_wait</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CPU_RM7000</span>:
		<span class="n">cpu_wait</span> <span class="o">=</span> <span class="n">rm7k_wait_irqoff</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CPU_24K</span>:
	<span class="k">case</span> <span class="n">CPU_34K</span>:
	<span class="k">case</span> <span class="n">CPU_1004K</span>:
		<span class="n">cpu_wait</span> <span class="o">=</span> <span class="n">r4k_wait</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">read_c0_config7</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">MIPS_CONF7_WII</span><span class="p">)</span>
			<span class="n">cpu_wait</span> <span class="o">=</span> <span class="n">r4k_wait_irqoff</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CPU_74K</span>:
		<span class="n">cpu_wait</span> <span class="o">=</span> <span class="n">r4k_wait</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">processor_id</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">PRID_REV_ENCODE_332</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">cpu_wait</span> <span class="o">=</span> <span class="n">r4k_wait_irqoff</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CPU_TX49XX</span>:
		<span class="n">cpu_wait</span> <span class="o">=</span> <span class="n">r4k_wait_irqoff</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPU_ALCHEMY</span>:
		<span class="n">cpu_wait</span> <span class="o">=</span> <span class="n">au1k_wait</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPU_20KC</span>:
		<span class="cm">/*</span>
<span class="cm">		 * WAIT on Rev1.0 has E1, E2, E3 and E16.</span>
<span class="cm">		 * WAIT on Rev2.0 and Rev3.0 has E16.</span>
<span class="cm">		 * Rev3.1 WAIT is nop, why bother</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">processor_id</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mh">0x64</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Another rev is incremeting c0_count at a reduced clock</span>
<span class="cm">		 * rate while in WAIT mode.  So we basically have the choice</span>
<span class="cm">		 * between using the cp0 timer as clocksource or avoiding</span>
<span class="cm">		 * the WAIT instruction.  Until more details are known,</span>
<span class="cm">		 * disable the use of WAIT for 20Kc entirely.</span>
<span class="cm">		   cpu_wait = r4k_wait;</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPU_RM9000</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">processor_id</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0x40</span><span class="p">)</span>
			<span class="n">cpu_wait</span> <span class="o">=</span> <span class="n">r4k_wait</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">check_errata</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpuinfo_mips</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">current_cpu_data</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CPU_34K</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Erratum &quot;RPS May Cause Incorrect Instruction Execution&quot;</span>
<span class="cm">		 * This code only handles VPE0, any SMP/SMTC/RTOS code</span>
<span class="cm">		 * making use of VPE1 will be responsable for that VPE.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">processor_id</span> <span class="o">&amp;</span> <span class="n">PRID_REV_MASK</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">PRID_REV_34K_V1_0_2</span><span class="p">)</span>
			<span class="n">write_c0_config7</span><span class="p">(</span><span class="n">read_c0_config7</span><span class="p">()</span> <span class="o">|</span> <span class="n">MIPS_CONF7_RPS</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">check_bugs32</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">check_errata</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Probe whether cpu has config register by trying to play with</span>
<span class="cm"> * alternate cache bit and see whether it matters.</span>
<span class="cm"> * It&#39;s used by cpu_probe to distinguish between R3000A and R3081.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">cpu_has_confreg</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_CPU_R3000</span>
	<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r3k_cache_size</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size1</span><span class="p">,</span> <span class="n">size2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cfg</span> <span class="o">=</span> <span class="n">read_c0_conf</span><span class="p">();</span>

	<span class="n">size1</span> <span class="o">=</span> <span class="n">r3k_cache_size</span><span class="p">(</span><span class="n">ST0_ISC</span><span class="p">);</span>
	<span class="n">write_c0_conf</span><span class="p">(</span><span class="n">cfg</span> <span class="o">^</span> <span class="n">R30XX_CONF_AC</span><span class="p">);</span>
	<span class="n">size2</span> <span class="o">=</span> <span class="n">r3k_cache_size</span><span class="p">(</span><span class="n">ST0_ISC</span><span class="p">);</span>
	<span class="n">write_c0_conf</span><span class="p">(</span><span class="n">cfg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">size1</span> <span class="o">!=</span> <span class="n">size2</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_elf_platform</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">plat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">__elf_platform</span> <span class="o">=</span> <span class="n">plat</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get the FPU Implementation/Revision.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">cpu_get_fpu_id</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">fpu_id</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">read_c0_status</span><span class="p">();</span>
	<span class="n">__enable_fpu</span><span class="p">();</span>
	<span class="n">fpu_id</span> <span class="o">=</span> <span class="n">read_32bit_cp1_register</span><span class="p">(</span><span class="n">CP1_REVISION</span><span class="p">);</span>
	<span class="n">write_c0_status</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">fpu_id</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check the CPU has an FPU the official way.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">__cpu_has_fpu</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">cpu_get_fpu_id</span><span class="p">()</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">!=</span> <span class="n">FPIR_IMP_NONE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cpu_probe_vmbits</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuinfo_mips</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef __NEED_VMBITS_PROBE</span>
	<span class="n">write_c0_entryhi</span><span class="p">(</span><span class="mh">0x3fffffffffffe000ULL</span><span class="p">);</span>
	<span class="n">back_to_back_c0_hazard</span><span class="p">();</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">vmbits</span> <span class="o">=</span> <span class="n">fls64</span><span class="p">(</span><span class="n">read_c0_entryhi</span><span class="p">()</span> <span class="o">&amp;</span> <span class="mh">0x3fffffffffffe000ULL</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cp">#define R4K_OPTS (MIPS_CPU_TLB | MIPS_CPU_4KEX | MIPS_CPU_4K_CACHE \</span>
<span class="cp">		| MIPS_CPU_COUNTER)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cpu_probe_legacy</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuinfo_mips</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">processor_id</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PRID_IMP_R2000</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_R2000</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;R2000&quot;</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">isa_level</span> <span class="o">=</span> <span class="n">MIPS_CPU_ISA_I</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">MIPS_CPU_TLB</span> <span class="o">|</span> <span class="n">MIPS_CPU_3K_CACHE</span> <span class="o">|</span>
			     <span class="n">MIPS_CPU_NOFPUEX</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__cpu_has_fpu</span><span class="p">())</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">MIPS_CPU_FPU</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">tlbsize</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_IMP_R3000</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">processor_id</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="n">PRID_REV_R3000A</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_confreg</span><span class="p">())</span> <span class="p">{</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_R3081E</span><span class="p">;</span>
				<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;R3081&quot;</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_R3000A</span><span class="p">;</span>
				<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;R3000A&quot;</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_R3000</span><span class="p">;</span>
			<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;R3000&quot;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">isa_level</span> <span class="o">=</span> <span class="n">MIPS_CPU_ISA_I</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">MIPS_CPU_TLB</span> <span class="o">|</span> <span class="n">MIPS_CPU_3K_CACHE</span> <span class="o">|</span>
			     <span class="n">MIPS_CPU_NOFPUEX</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__cpu_has_fpu</span><span class="p">())</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">MIPS_CPU_FPU</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">tlbsize</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_IMP_R4000</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">read_c0_config</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">CONF_SC</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">processor_id</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">PRID_REV_R4400</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_R4400PC</span><span class="p">;</span>
				<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;R4400PC&quot;</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_R4000PC</span><span class="p">;</span>
				<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;R4000PC&quot;</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">processor_id</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">PRID_REV_R4400</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_R4400SC</span><span class="p">;</span>
				<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;R4400SC&quot;</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_R4000SC</span><span class="p">;</span>
				<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;R4000SC&quot;</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">c</span><span class="o">-&gt;</span><span class="n">isa_level</span> <span class="o">=</span> <span class="n">MIPS_CPU_ISA_III</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">R4K_OPTS</span> <span class="o">|</span> <span class="n">MIPS_CPU_FPU</span> <span class="o">|</span> <span class="n">MIPS_CPU_32FPR</span> <span class="o">|</span>
			     <span class="n">MIPS_CPU_WATCH</span> <span class="o">|</span> <span class="n">MIPS_CPU_VCE</span> <span class="o">|</span>
			     <span class="n">MIPS_CPU_LLSC</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">tlbsize</span> <span class="o">=</span> <span class="mi">48</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_IMP_VR41XX</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">processor_id</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PRID_REV_VR4111</span>:
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_VR4111</span><span class="p">;</span>
			<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;NEC VR4111&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PRID_REV_VR4121</span>:
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_VR4121</span><span class="p">;</span>
			<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;NEC VR4121&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PRID_REV_VR4122</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">processor_id</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_VR4122</span><span class="p">;</span>
				<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;NEC VR4122&quot;</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_VR4181A</span><span class="p">;</span>
				<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;NEC VR4181A&quot;</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PRID_REV_VR4130</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">processor_id</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x4</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_VR4131</span><span class="p">;</span>
				<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;NEC VR4131&quot;</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_VR4133</span><span class="p">;</span>
				<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;NEC VR4133&quot;</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Unexpected CPU of NEC VR4100 series</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_VR41XX</span><span class="p">;</span>
			<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;NEC Vr41xx&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">isa_level</span> <span class="o">=</span> <span class="n">MIPS_CPU_ISA_III</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">R4K_OPTS</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">tlbsize</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_IMP_R4300</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_R4300</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;R4300&quot;</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">isa_level</span> <span class="o">=</span> <span class="n">MIPS_CPU_ISA_III</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">R4K_OPTS</span> <span class="o">|</span> <span class="n">MIPS_CPU_FPU</span> <span class="o">|</span> <span class="n">MIPS_CPU_32FPR</span> <span class="o">|</span>
			     <span class="n">MIPS_CPU_LLSC</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">tlbsize</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_IMP_R4600</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_R4600</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;R4600&quot;</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">isa_level</span> <span class="o">=</span> <span class="n">MIPS_CPU_ISA_III</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">R4K_OPTS</span> <span class="o">|</span> <span class="n">MIPS_CPU_FPU</span> <span class="o">|</span> <span class="n">MIPS_CPU_32FPR</span> <span class="o">|</span>
			     <span class="n">MIPS_CPU_LLSC</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">tlbsize</span> <span class="o">=</span> <span class="mi">48</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	case PRID_IMP_R4650:</span>
<span class="c">		/*</span>
<span class="c">		 * This processor doesn&#39;t have an MMU, so it&#39;s not</span>
<span class="c">		 * &quot;real easy&quot; to run Linux on it. It is left purely</span>
<span class="c">		 * for documentation.  Commented out because it shares</span>
<span class="c">		 * it&#39;s c0_prid id number with the TX3900.</span>
<span class="c">		 */</span>
<span class="c">		c-&gt;cputype = CPU_R4650;</span>
<span class="c">		__cpu_name[cpu] = &quot;R4650&quot;;</span>
<span class="c">		c-&gt;isa_level = MIPS_CPU_ISA_III;</span>
<span class="c">		c-&gt;options = R4K_OPTS | MIPS_CPU_FPU | MIPS_CPU_LLSC;</span>
<span class="c">		c-&gt;tlbsize = 48;</span>
<span class="c">		break;</span>
<span class="cp">	#endif</span>
	<span class="k">case</span> <span class="n">PRID_IMP_TX39</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">isa_level</span> <span class="o">=</span> <span class="n">MIPS_CPU_ISA_I</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">MIPS_CPU_TLB</span> <span class="o">|</span> <span class="n">MIPS_CPU_TX39_CACHE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">processor_id</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">PRID_REV_TX3927</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_TX3927</span><span class="p">;</span>
			<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;TX3927&quot;</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">tlbsize</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">processor_id</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">PRID_REV_TX3912</span>:
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_TX3912</span><span class="p">;</span>
				<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;TX3912&quot;</span><span class="p">;</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">tlbsize</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">PRID_REV_TX3922</span>:
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_TX3922</span><span class="p">;</span>
				<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;TX3922&quot;</span><span class="p">;</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">tlbsize</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_IMP_R4700</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_R4700</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;R4700&quot;</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">isa_level</span> <span class="o">=</span> <span class="n">MIPS_CPU_ISA_III</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">R4K_OPTS</span> <span class="o">|</span> <span class="n">MIPS_CPU_FPU</span> <span class="o">|</span> <span class="n">MIPS_CPU_32FPR</span> <span class="o">|</span>
			     <span class="n">MIPS_CPU_LLSC</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">tlbsize</span> <span class="o">=</span> <span class="mi">48</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_IMP_TX49</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_TX49XX</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;R49XX&quot;</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">isa_level</span> <span class="o">=</span> <span class="n">MIPS_CPU_ISA_III</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">R4K_OPTS</span> <span class="o">|</span> <span class="n">MIPS_CPU_LLSC</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">processor_id</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">))</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">MIPS_CPU_FPU</span> <span class="o">|</span> <span class="n">MIPS_CPU_32FPR</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">tlbsize</span> <span class="o">=</span> <span class="mi">48</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_IMP_R5000</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_R5000</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;R5000&quot;</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">isa_level</span> <span class="o">=</span> <span class="n">MIPS_CPU_ISA_IV</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">R4K_OPTS</span> <span class="o">|</span> <span class="n">MIPS_CPU_FPU</span> <span class="o">|</span> <span class="n">MIPS_CPU_32FPR</span> <span class="o">|</span>
			     <span class="n">MIPS_CPU_LLSC</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">tlbsize</span> <span class="o">=</span> <span class="mi">48</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_IMP_R5432</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_R5432</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;R5432&quot;</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">isa_level</span> <span class="o">=</span> <span class="n">MIPS_CPU_ISA_IV</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">R4K_OPTS</span> <span class="o">|</span> <span class="n">MIPS_CPU_FPU</span> <span class="o">|</span> <span class="n">MIPS_CPU_32FPR</span> <span class="o">|</span>
			     <span class="n">MIPS_CPU_WATCH</span> <span class="o">|</span> <span class="n">MIPS_CPU_LLSC</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">tlbsize</span> <span class="o">=</span> <span class="mi">48</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_IMP_R5500</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_R5500</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;R5500&quot;</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">isa_level</span> <span class="o">=</span> <span class="n">MIPS_CPU_ISA_IV</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">R4K_OPTS</span> <span class="o">|</span> <span class="n">MIPS_CPU_FPU</span> <span class="o">|</span> <span class="n">MIPS_CPU_32FPR</span> <span class="o">|</span>
			     <span class="n">MIPS_CPU_WATCH</span> <span class="o">|</span> <span class="n">MIPS_CPU_LLSC</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">tlbsize</span> <span class="o">=</span> <span class="mi">48</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_IMP_NEVADA</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_NEVADA</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Nevada&quot;</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">isa_level</span> <span class="o">=</span> <span class="n">MIPS_CPU_ISA_IV</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">R4K_OPTS</span> <span class="o">|</span> <span class="n">MIPS_CPU_FPU</span> <span class="o">|</span> <span class="n">MIPS_CPU_32FPR</span> <span class="o">|</span>
			     <span class="n">MIPS_CPU_DIVEC</span> <span class="o">|</span> <span class="n">MIPS_CPU_LLSC</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">tlbsize</span> <span class="o">=</span> <span class="mi">48</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_IMP_R6000</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_R6000</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;R6000&quot;</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">isa_level</span> <span class="o">=</span> <span class="n">MIPS_CPU_ISA_II</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">MIPS_CPU_TLB</span> <span class="o">|</span> <span class="n">MIPS_CPU_FPU</span> <span class="o">|</span>
			     <span class="n">MIPS_CPU_LLSC</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">tlbsize</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_IMP_R6000A</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_R6000A</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;R6000A&quot;</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">isa_level</span> <span class="o">=</span> <span class="n">MIPS_CPU_ISA_II</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">MIPS_CPU_TLB</span> <span class="o">|</span> <span class="n">MIPS_CPU_FPU</span> <span class="o">|</span>
			     <span class="n">MIPS_CPU_LLSC</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">tlbsize</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_IMP_RM7000</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_RM7000</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;RM7000&quot;</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">isa_level</span> <span class="o">=</span> <span class="n">MIPS_CPU_ISA_IV</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">R4K_OPTS</span> <span class="o">|</span> <span class="n">MIPS_CPU_FPU</span> <span class="o">|</span> <span class="n">MIPS_CPU_32FPR</span> <span class="o">|</span>
			     <span class="n">MIPS_CPU_LLSC</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Undocumented RM7000:  Bit 29 in the info register of</span>
<span class="cm">		 * the RM7000 v2.0 indicates if the TLB has 48 or 64</span>
<span class="cm">		 * entries.</span>
<span class="cm">		 *</span>
<span class="cm">		 * 29      1 =&gt;    64 entry JTLB</span>
<span class="cm">		 *         0 =&gt;    48 entry JTLB</span>
<span class="cm">		 */</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">tlbsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">read_c0_info</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">))</span> <span class="o">?</span> <span class="mi">64</span> <span class="o">:</span> <span class="mi">48</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_IMP_RM9000</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_RM9000</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;RM9000&quot;</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">isa_level</span> <span class="o">=</span> <span class="n">MIPS_CPU_ISA_IV</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">R4K_OPTS</span> <span class="o">|</span> <span class="n">MIPS_CPU_FPU</span> <span class="o">|</span> <span class="n">MIPS_CPU_32FPR</span> <span class="o">|</span>
			     <span class="n">MIPS_CPU_LLSC</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Bit 29 in the info register of the RM9000</span>
<span class="cm">		 * indicates if the TLB has 48 or 64 entries.</span>
<span class="cm">		 *</span>
<span class="cm">		 * 29      1 =&gt;    64 entry JTLB</span>
<span class="cm">		 *         0 =&gt;    48 entry JTLB</span>
<span class="cm">		 */</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">tlbsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">read_c0_info</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">))</span> <span class="o">?</span> <span class="mi">64</span> <span class="o">:</span> <span class="mi">48</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_IMP_R8000</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_R8000</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;RM8000&quot;</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">isa_level</span> <span class="o">=</span> <span class="n">MIPS_CPU_ISA_IV</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">MIPS_CPU_TLB</span> <span class="o">|</span> <span class="n">MIPS_CPU_4KEX</span> <span class="o">|</span>
			     <span class="n">MIPS_CPU_FPU</span> <span class="o">|</span> <span class="n">MIPS_CPU_32FPR</span> <span class="o">|</span>
			     <span class="n">MIPS_CPU_LLSC</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">tlbsize</span> <span class="o">=</span> <span class="mi">384</span><span class="p">;</span>      <span class="cm">/* has weird TLB: 3-way x 128 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_IMP_R10000</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_R10000</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;R10000&quot;</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">isa_level</span> <span class="o">=</span> <span class="n">MIPS_CPU_ISA_IV</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">MIPS_CPU_TLB</span> <span class="o">|</span> <span class="n">MIPS_CPU_4K_CACHE</span> <span class="o">|</span> <span class="n">MIPS_CPU_4KEX</span> <span class="o">|</span>
			     <span class="n">MIPS_CPU_FPU</span> <span class="o">|</span> <span class="n">MIPS_CPU_32FPR</span> <span class="o">|</span>
			     <span class="n">MIPS_CPU_COUNTER</span> <span class="o">|</span> <span class="n">MIPS_CPU_WATCH</span> <span class="o">|</span>
			     <span class="n">MIPS_CPU_LLSC</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">tlbsize</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_IMP_R12000</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_R12000</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;R12000&quot;</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">isa_level</span> <span class="o">=</span> <span class="n">MIPS_CPU_ISA_IV</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">MIPS_CPU_TLB</span> <span class="o">|</span> <span class="n">MIPS_CPU_4K_CACHE</span> <span class="o">|</span> <span class="n">MIPS_CPU_4KEX</span> <span class="o">|</span>
			     <span class="n">MIPS_CPU_FPU</span> <span class="o">|</span> <span class="n">MIPS_CPU_32FPR</span> <span class="o">|</span>
			     <span class="n">MIPS_CPU_COUNTER</span> <span class="o">|</span> <span class="n">MIPS_CPU_WATCH</span> <span class="o">|</span>
			     <span class="n">MIPS_CPU_LLSC</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">tlbsize</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_IMP_R14000</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_R14000</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;R14000&quot;</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">isa_level</span> <span class="o">=</span> <span class="n">MIPS_CPU_ISA_IV</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">MIPS_CPU_TLB</span> <span class="o">|</span> <span class="n">MIPS_CPU_4K_CACHE</span> <span class="o">|</span> <span class="n">MIPS_CPU_4KEX</span> <span class="o">|</span>
			     <span class="n">MIPS_CPU_FPU</span> <span class="o">|</span> <span class="n">MIPS_CPU_32FPR</span> <span class="o">|</span>
			     <span class="n">MIPS_CPU_COUNTER</span> <span class="o">|</span> <span class="n">MIPS_CPU_WATCH</span> <span class="o">|</span>
			     <span class="n">MIPS_CPU_LLSC</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">tlbsize</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_IMP_LOONGSON2</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_LOONGSON2</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;ICT Loongson-2&quot;</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">processor_id</span> <span class="o">&amp;</span> <span class="n">PRID_REV_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PRID_REV_LOONGSON2E</span>:
			<span class="n">set_elf_platform</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="s">&quot;loongson2e&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PRID_REV_LOONGSON2F</span>:
			<span class="n">set_elf_platform</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="s">&quot;loongson2f&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">c</span><span class="o">-&gt;</span><span class="n">isa_level</span> <span class="o">=</span> <span class="n">MIPS_CPU_ISA_III</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">R4K_OPTS</span> <span class="o">|</span>
			     <span class="n">MIPS_CPU_FPU</span> <span class="o">|</span> <span class="n">MIPS_CPU_LLSC</span> <span class="o">|</span>
			     <span class="n">MIPS_CPU_32FPR</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">tlbsize</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">unknown_isa</span><span class="p">[]</span> <span class="n">__cpuinitdata</span> <span class="o">=</span> <span class="n">KERN_ERR</span> \
	<span class="s">&quot;Unsupported ISA type, c0.config0: %d.&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">decode_config0</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuinfo_mips</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">config0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">isa</span><span class="p">;</span>

	<span class="n">config0</span> <span class="o">=</span> <span class="n">read_c0_config</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">config0</span> <span class="o">&amp;</span> <span class="n">MIPS_CONF_MT</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">MIPS_CPU_TLB</span><span class="p">;</span>
	<span class="n">isa</span> <span class="o">=</span> <span class="p">(</span><span class="n">config0</span> <span class="o">&amp;</span> <span class="n">MIPS_CONF_AT</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">isa</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">switch</span> <span class="p">((</span><span class="n">config0</span> <span class="o">&amp;</span> <span class="n">MIPS_CONF_AR</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">isa_level</span> <span class="o">=</span> <span class="n">MIPS_CPU_ISA_M32R1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">isa_level</span> <span class="o">=</span> <span class="n">MIPS_CPU_ISA_M32R2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">unknown</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">switch</span> <span class="p">((</span><span class="n">config0</span> <span class="o">&amp;</span> <span class="n">MIPS_CONF_AR</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">isa_level</span> <span class="o">=</span> <span class="n">MIPS_CPU_ISA_M64R1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">isa_level</span> <span class="o">=</span> <span class="n">MIPS_CPU_ISA_M64R2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">unknown</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">unknown</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">config0</span> <span class="o">&amp;</span> <span class="n">MIPS_CONF_M</span><span class="p">;</span>

<span class="nl">unknown:</span>
	<span class="n">panic</span><span class="p">(</span><span class="n">unknown_isa</span><span class="p">,</span> <span class="n">config0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">decode_config1</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuinfo_mips</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">config1</span><span class="p">;</span>

	<span class="n">config1</span> <span class="o">=</span> <span class="n">read_c0_config1</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">config1</span> <span class="o">&amp;</span> <span class="n">MIPS_CONF1_MD</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">ases</span> <span class="o">|=</span> <span class="n">MIPS_ASE_MDMX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">config1</span> <span class="o">&amp;</span> <span class="n">MIPS_CONF1_WR</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">MIPS_CPU_WATCH</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">config1</span> <span class="o">&amp;</span> <span class="n">MIPS_CONF1_CA</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">ases</span> <span class="o">|=</span> <span class="n">MIPS_ASE_MIPS16</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">config1</span> <span class="o">&amp;</span> <span class="n">MIPS_CONF1_EP</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">MIPS_CPU_EJTAG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">config1</span> <span class="o">&amp;</span> <span class="n">MIPS_CONF1_FP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">MIPS_CPU_FPU</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">MIPS_CPU_32FPR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_tlb</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">tlbsize</span> <span class="o">=</span> <span class="p">((</span><span class="n">config1</span> <span class="o">&amp;</span> <span class="n">MIPS_CONF1_TLBS</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">config1</span> <span class="o">&amp;</span> <span class="n">MIPS_CONF_M</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">decode_config2</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuinfo_mips</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">config2</span><span class="p">;</span>

	<span class="n">config2</span> <span class="o">=</span> <span class="n">read_c0_config2</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">config2</span> <span class="o">&amp;</span> <span class="n">MIPS_CONF2_SL</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">scache</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MIPS_CACHE_NOT_PRESENT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">config2</span> <span class="o">&amp;</span> <span class="n">MIPS_CONF_M</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">decode_config3</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuinfo_mips</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">config3</span><span class="p">;</span>

	<span class="n">config3</span> <span class="o">=</span> <span class="n">read_c0_config3</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">config3</span> <span class="o">&amp;</span> <span class="n">MIPS_CONF3_SM</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">ases</span> <span class="o">|=</span> <span class="n">MIPS_ASE_SMARTMIPS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">config3</span> <span class="o">&amp;</span> <span class="n">MIPS_CONF3_DSP</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">ases</span> <span class="o">|=</span> <span class="n">MIPS_ASE_DSP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">config3</span> <span class="o">&amp;</span> <span class="n">MIPS_CONF3_VINT</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">MIPS_CPU_VINT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">config3</span> <span class="o">&amp;</span> <span class="n">MIPS_CONF3_VEIC</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">MIPS_CPU_VEIC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">config3</span> <span class="o">&amp;</span> <span class="n">MIPS_CONF3_MT</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">ases</span> <span class="o">|=</span> <span class="n">MIPS_ASE_MIPSMT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">config3</span> <span class="o">&amp;</span> <span class="n">MIPS_CONF3_ULRI</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">MIPS_CPU_ULRI</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">config3</span> <span class="o">&amp;</span> <span class="n">MIPS_CONF_M</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">decode_config4</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuinfo_mips</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">config4</span><span class="p">;</span>

	<span class="n">config4</span> <span class="o">=</span> <span class="n">read_c0_config4</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">config4</span> <span class="o">&amp;</span> <span class="n">MIPS_CONF4_MMUEXTDEF</span><span class="p">)</span> <span class="o">==</span> <span class="n">MIPS_CONF4_MMUEXTDEF_MMUSIZEEXT</span>
	    <span class="o">&amp;&amp;</span> <span class="n">cpu_has_tlb</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">tlbsize</span> <span class="o">+=</span> <span class="p">(</span><span class="n">config4</span> <span class="o">&amp;</span> <span class="n">MIPS_CONF4_MMUSIZEEXT</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0x40</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">kscratch_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">config4</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">config4</span> <span class="o">&amp;</span> <span class="n">MIPS_CONF_M</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">decode_configs</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuinfo_mips</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ok</span><span class="p">;</span>

	<span class="cm">/* MIPS32 or MIPS64 compliant CPU.  */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">MIPS_CPU_4KEX</span> <span class="o">|</span> <span class="n">MIPS_CPU_4K_CACHE</span> <span class="o">|</span> <span class="n">MIPS_CPU_COUNTER</span> <span class="o">|</span>
		     <span class="n">MIPS_CPU_DIVEC</span> <span class="o">|</span> <span class="n">MIPS_CPU_LLSC</span> <span class="o">|</span> <span class="n">MIPS_CPU_MCHECK</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">scache</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MIPS_CACHE_NOT_PRESENT</span><span class="p">;</span>

	<span class="n">ok</span> <span class="o">=</span> <span class="n">decode_config0</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>			<span class="cm">/* Read Config registers.  */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">);</span>				<span class="cm">/* Arch spec violation!  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ok</span><span class="p">)</span>
		<span class="n">ok</span> <span class="o">=</span> <span class="n">decode_config1</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ok</span><span class="p">)</span>
		<span class="n">ok</span> <span class="o">=</span> <span class="n">decode_config2</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ok</span><span class="p">)</span>
		<span class="n">ok</span> <span class="o">=</span> <span class="n">decode_config3</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ok</span><span class="p">)</span>
		<span class="n">ok</span> <span class="o">=</span> <span class="n">decode_config4</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

	<span class="n">mips_probe_watch_registers</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_mips_r2</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">core</span> <span class="o">=</span> <span class="n">read_c0_ebase</span><span class="p">()</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cpu_probe_mips</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuinfo_mips</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">decode_configs</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">processor_id</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PRID_IMP_4KC</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_4KC</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;MIPS 4Kc&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_IMP_4KEC</span>:
	<span class="k">case</span> <span class="n">PRID_IMP_4KECR2</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_4KEC</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;MIPS 4KEc&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_IMP_4KSC</span>:
	<span class="k">case</span> <span class="n">PRID_IMP_4KSD</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_4KSC</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;MIPS 4KSc&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_IMP_5KC</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_5KC</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;MIPS 5Kc&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_IMP_20KC</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_20KC</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;MIPS 20Kc&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_IMP_24K</span>:
	<span class="k">case</span> <span class="n">PRID_IMP_24KE</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_24K</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;MIPS 24Kc&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_IMP_25KF</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_25KF</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;MIPS 25Kc&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_IMP_34K</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_34K</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;MIPS 34Kc&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_IMP_74K</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_74K</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;MIPS 74Kc&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_IMP_1004K</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_1004K</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;MIPS 1004Kc&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spram_config</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cpu_probe_alchemy</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuinfo_mips</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">decode_configs</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">processor_id</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PRID_IMP_AU1_REV1</span>:
	<span class="k">case</span> <span class="n">PRID_IMP_AU1_REV2</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_ALCHEMY</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">processor_id</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Au1000&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Au1500&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Au1100&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Au1550&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Au1200&quot;</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">processor_id</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Au1250&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">5</span>:
			<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Au1210&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Au1xxx&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cpu_probe_sibyte</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuinfo_mips</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">decode_configs</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">processor_id</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PRID_IMP_SB1</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_SB1</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;SiByte SB1&quot;</span><span class="p">;</span>
		<span class="cm">/* FPU in pass1 is known to have issues. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">processor_id</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x02</span><span class="p">)</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MIPS_CPU_FPU</span> <span class="o">|</span> <span class="n">MIPS_CPU_32FPR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_IMP_SB1A</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_SB1A</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;SiByte SB1A&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cpu_probe_sandcraft</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuinfo_mips</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">decode_configs</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">processor_id</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PRID_IMP_SR71000</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_SR71000</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Sandcraft SR71000&quot;</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">scache</span><span class="p">.</span><span class="n">ways</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">tlbsize</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cpu_probe_nxp</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuinfo_mips</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">decode_configs</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">processor_id</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PRID_IMP_PR4450</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_PR4450</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Philips PR4450&quot;</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">isa_level</span> <span class="o">=</span> <span class="n">MIPS_CPU_ISA_M32R1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cpu_probe_broadcom</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuinfo_mips</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">decode_configs</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">processor_id</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PRID_IMP_BMIPS32_REV4</span>:
	<span class="k">case</span> <span class="n">PRID_IMP_BMIPS32_REV8</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_BMIPS32</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Broadcom BMIPS32&quot;</span><span class="p">;</span>
		<span class="n">set_elf_platform</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="s">&quot;bmips32&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_IMP_BMIPS3300</span>:
	<span class="k">case</span> <span class="n">PRID_IMP_BMIPS3300_ALT</span>:
	<span class="k">case</span> <span class="n">PRID_IMP_BMIPS3300_BUG</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_BMIPS3300</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Broadcom BMIPS3300&quot;</span><span class="p">;</span>
		<span class="n">set_elf_platform</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="s">&quot;bmips3300&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_IMP_BMIPS43XX</span>: <span class="p">{</span>
		<span class="kt">int</span> <span class="n">rev</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">processor_id</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="n">PRID_REV_BMIPS4380_LO</span> <span class="o">&amp;&amp;</span>
				<span class="n">rev</span> <span class="o">&lt;=</span> <span class="n">PRID_REV_BMIPS4380_HI</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_BMIPS4380</span><span class="p">;</span>
			<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Broadcom BMIPS4380&quot;</span><span class="p">;</span>
			<span class="n">set_elf_platform</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="s">&quot;bmips4380&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_BMIPS4350</span><span class="p">;</span>
			<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Broadcom BMIPS4350&quot;</span><span class="p">;</span>
			<span class="n">set_elf_platform</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="s">&quot;bmips4350&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">PRID_IMP_BMIPS5000</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_BMIPS5000</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Broadcom BMIPS5000&quot;</span><span class="p">;</span>
		<span class="n">set_elf_platform</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="s">&quot;bmips5000&quot;</span><span class="p">);</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">MIPS_CPU_ULRI</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cpu_probe_cavium</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuinfo_mips</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">decode_configs</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">processor_id</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PRID_IMP_CAVIUM_CN38XX</span>:
	<span class="k">case</span> <span class="n">PRID_IMP_CAVIUM_CN31XX</span>:
	<span class="k">case</span> <span class="n">PRID_IMP_CAVIUM_CN30XX</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_CAVIUM_OCTEON</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Cavium Octeon&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">platform</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_IMP_CAVIUM_CN58XX</span>:
	<span class="k">case</span> <span class="n">PRID_IMP_CAVIUM_CN56XX</span>:
	<span class="k">case</span> <span class="n">PRID_IMP_CAVIUM_CN50XX</span>:
	<span class="k">case</span> <span class="n">PRID_IMP_CAVIUM_CN52XX</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_CAVIUM_OCTEON_PLUS</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Cavium Octeon+&quot;</span><span class="p">;</span>
<span class="nl">platform:</span>
		<span class="n">set_elf_platform</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="s">&quot;octeon&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_IMP_CAVIUM_CN61XX</span>:
	<span class="k">case</span> <span class="n">PRID_IMP_CAVIUM_CN63XX</span>:
	<span class="k">case</span> <span class="n">PRID_IMP_CAVIUM_CN66XX</span>:
	<span class="k">case</span> <span class="n">PRID_IMP_CAVIUM_CN68XX</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_CAVIUM_OCTEON2</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Cavium Octeon II&quot;</span><span class="p">;</span>
		<span class="n">set_elf_platform</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="s">&quot;octeon2&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Unknown Octeon chip!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_UNKNOWN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cpu_probe_ingenic</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuinfo_mips</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">decode_configs</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="cm">/* JZRISC does not implement the CP0 counter. */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MIPS_CPU_COUNTER</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">processor_id</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PRID_IMP_JZRISC</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_JZRISC</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Ingenic JZRISC&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Unknown Ingenic Processor ID!&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cpu_probe_netlogic</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuinfo_mips</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">decode_configs</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">processor_id</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">==</span> <span class="n">PRID_IMP_NETLOGIC_AU13XX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_ALCHEMY</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Au1300&quot;</span><span class="p">;</span>
		<span class="cm">/* following stuff is not for Alchemy */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="p">(</span><span class="n">MIPS_CPU_TLB</span>       <span class="o">|</span>
			<span class="n">MIPS_CPU_4KEX</span>    <span class="o">|</span>
			<span class="n">MIPS_CPU_COUNTER</span> <span class="o">|</span>
			<span class="n">MIPS_CPU_DIVEC</span>   <span class="o">|</span>
			<span class="n">MIPS_CPU_WATCH</span>   <span class="o">|</span>
			<span class="n">MIPS_CPU_EJTAG</span>   <span class="o">|</span>
			<span class="n">MIPS_CPU_LLSC</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">processor_id</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PRID_IMP_NETLOGIC_XLP8XX</span>:
	<span class="k">case</span> <span class="n">PRID_IMP_NETLOGIC_XLP3XX</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_XLP</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Netlogic XLP&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRID_IMP_NETLOGIC_XLR732</span>:
	<span class="k">case</span> <span class="n">PRID_IMP_NETLOGIC_XLR716</span>:
	<span class="k">case</span> <span class="n">PRID_IMP_NETLOGIC_XLR532</span>:
	<span class="k">case</span> <span class="n">PRID_IMP_NETLOGIC_XLR308</span>:
	<span class="k">case</span> <span class="n">PRID_IMP_NETLOGIC_XLR532C</span>:
	<span class="k">case</span> <span class="n">PRID_IMP_NETLOGIC_XLR516C</span>:
	<span class="k">case</span> <span class="n">PRID_IMP_NETLOGIC_XLR508C</span>:
	<span class="k">case</span> <span class="n">PRID_IMP_NETLOGIC_XLR308C</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_XLR</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Netlogic XLR&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRID_IMP_NETLOGIC_XLS608</span>:
	<span class="k">case</span> <span class="n">PRID_IMP_NETLOGIC_XLS408</span>:
	<span class="k">case</span> <span class="n">PRID_IMP_NETLOGIC_XLS404</span>:
	<span class="k">case</span> <span class="n">PRID_IMP_NETLOGIC_XLS208</span>:
	<span class="k">case</span> <span class="n">PRID_IMP_NETLOGIC_XLS204</span>:
	<span class="k">case</span> <span class="n">PRID_IMP_NETLOGIC_XLS108</span>:
	<span class="k">case</span> <span class="n">PRID_IMP_NETLOGIC_XLS104</span>:
	<span class="k">case</span> <span class="n">PRID_IMP_NETLOGIC_XLS616B</span>:
	<span class="k">case</span> <span class="n">PRID_IMP_NETLOGIC_XLS608B</span>:
	<span class="k">case</span> <span class="n">PRID_IMP_NETLOGIC_XLS416B</span>:
	<span class="k">case</span> <span class="n">PRID_IMP_NETLOGIC_XLS412B</span>:
	<span class="k">case</span> <span class="n">PRID_IMP_NETLOGIC_XLS408B</span>:
	<span class="k">case</span> <span class="n">PRID_IMP_NETLOGIC_XLS404B</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_XLR</span><span class="p">;</span>
		<span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Netlogic XLS&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Unknown Netlogic chip id [%02x]!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">c</span><span class="o">-&gt;</span><span class="n">processor_id</span><span class="p">);</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">=</span> <span class="n">CPU_XLR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">==</span> <span class="n">CPU_XLP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">isa_level</span> <span class="o">=</span> <span class="n">MIPS_CPU_ISA_M64R2</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MIPS_CPU_FPU</span> <span class="o">|</span> <span class="n">MIPS_CPU_ULRI</span> <span class="o">|</span> <span class="n">MIPS_CPU_MCHECK</span><span class="p">);</span>
		<span class="cm">/* This will be updated again after all threads are woken up */</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">tlbsize</span> <span class="o">=</span> <span class="p">((</span><span class="n">read_c0_config6</span><span class="p">()</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">isa_level</span> <span class="o">=</span> <span class="n">MIPS_CPU_ISA_M64R1</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">tlbsize</span> <span class="o">=</span> <span class="p">((</span><span class="n">read_c0_config1</span><span class="p">()</span> <span class="o">&gt;&gt;</span> <span class="mi">25</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_64BIT</span>
<span class="cm">/* For use by uaccess.h */</span>
<span class="n">u64</span> <span class="n">__ua_limit</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__ua_limit</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">__cpu_name</span><span class="p">[</span><span class="n">NR_CPUS</span><span class="p">];</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">__elf_platform</span><span class="p">;</span>

<span class="n">__cpuinit</span> <span class="kt">void</span> <span class="nf">cpu_probe</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpuinfo_mips</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">current_cpu_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">smp_processor_id</span><span class="p">();</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">processor_id</span>	<span class="o">=</span> <span class="n">PRID_IMP_UNKNOWN</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">fpu_id</span>	<span class="o">=</span> <span class="n">FPIR_IMP_NONE</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span>	<span class="o">=</span> <span class="n">CPU_UNKNOWN</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">processor_id</span> <span class="o">=</span> <span class="n">read_c0_prid</span><span class="p">();</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">processor_id</span> <span class="o">&amp;</span> <span class="mh">0xff0000</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PRID_COMP_LEGACY</span>:
		<span class="n">cpu_probe_legacy</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_COMP_MIPS</span>:
		<span class="n">cpu_probe_mips</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_COMP_ALCHEMY</span>:
		<span class="n">cpu_probe_alchemy</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_COMP_SIBYTE</span>:
		<span class="n">cpu_probe_sibyte</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_COMP_BROADCOM</span>:
		<span class="n">cpu_probe_broadcom</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_COMP_SANDCRAFT</span>:
		<span class="n">cpu_probe_sandcraft</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_COMP_NXP</span>:
		<span class="n">cpu_probe_nxp</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_COMP_CAVIUM</span>:
		<span class="n">cpu_probe_cavium</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_COMP_INGENIC</span>:
		<span class="n">cpu_probe_ingenic</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRID_COMP_NETLOGIC</span>:
		<span class="n">cpu_probe_netlogic</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">__cpu_name</span><span class="p">[</span><span class="n">cpu</span><span class="p">]);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span> <span class="o">==</span> <span class="n">CPU_UNKNOWN</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Platform code can force the cpu type to optimize code</span>
<span class="cm">	 * generation. In that case be sure the cpu type is correctly</span>
<span class="cm">	 * manually setup otherwise it could trigger some nasty bugs.</span>
<span class="cm">	 */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">current_cpu_type</span><span class="p">()</span> <span class="o">!=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">cputype</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mips_fpu_disabled</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MIPS_CPU_FPU</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mips_dsp_disabled</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">ases</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MIPS_ASE_DSP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MIPS_CPU_FPU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">fpu_id</span> <span class="o">=</span> <span class="n">cpu_get_fpu_id</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">isa_level</span> <span class="o">==</span> <span class="n">MIPS_CPU_ISA_M32R1</span> <span class="o">||</span>
		    <span class="n">c</span><span class="o">-&gt;</span><span class="n">isa_level</span> <span class="o">==</span> <span class="n">MIPS_CPU_ISA_M32R2</span> <span class="o">||</span>
		    <span class="n">c</span><span class="o">-&gt;</span><span class="n">isa_level</span> <span class="o">==</span> <span class="n">MIPS_CPU_ISA_M64R1</span> <span class="o">||</span>
		    <span class="n">c</span><span class="o">-&gt;</span><span class="n">isa_level</span> <span class="o">==</span> <span class="n">MIPS_CPU_ISA_M64R2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">fpu_id</span> <span class="o">&amp;</span> <span class="n">MIPS_FPIR_3D</span><span class="p">)</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">ases</span> <span class="o">|=</span> <span class="n">MIPS_ASE_MIPS3D</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_mips_r2</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">srsets</span> <span class="o">=</span> <span class="p">((</span><span class="n">read_c0_srsctl</span><span class="p">()</span> <span class="o">&gt;&gt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">srsets</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">cpu_probe_vmbits</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_64BIT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">__ua_limit</span> <span class="o">=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1ull</span> <span class="o">&lt;&lt;</span> <span class="n">cpu_vmbits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="n">__cpuinit</span> <span class="kt">void</span> <span class="nf">cpu_report</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpuinfo_mips</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">current_cpu_data</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;CPU revision is: %08x (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">c</span><span class="o">-&gt;</span><span class="n">processor_id</span><span class="p">,</span> <span class="n">cpu_name_string</span><span class="p">());</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MIPS_CPU_FPU</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;FPU revision is: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">fpu_id</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
