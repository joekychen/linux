<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › mips › math-emu › cp1emu.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>cp1emu.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * cp1emu.c: a MIPS coprocessor 1 (fpu) instruction emulator</span>
<span class="cm"> *</span>
<span class="cm"> * MIPS floating point support</span>
<span class="cm"> * Copyright (C) 1994-2000 Algorithmics Ltd.</span>
<span class="cm"> *</span>
<span class="cm"> * Kevin D. Kissell, kevink@mips.com and Carsten Langgaard, carstenl@mips.com</span>
<span class="cm"> * Copyright (C) 2000  MIPS Technologies, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can distribute it and/or modify it</span>
<span class="cm"> *  under the terms of the GNU General Public License (Version 2) as</span>
<span class="cm"> *  published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope it will be useful, but WITHOUT</span>
<span class="cm"> *  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> *  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License</span>
<span class="cm"> *  for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License along</span>
<span class="cm"> *  with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> *  59 Temple Place - Suite 330, Boston MA 02111-1307, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * A complete emulator for MIPS coprocessor 1 instructions.  This is</span>
<span class="cm"> * required for #float(switch) or #float(trap), where it catches all</span>
<span class="cm"> * COP1 instructions via the &quot;CoProcessor Unusable&quot; exception.</span>
<span class="cm"> *</span>
<span class="cm"> * More surprisingly it is also required for #float(ieee), to help out</span>
<span class="cm"> * the hardware fpu at the boundaries of the IEEE-754 representation</span>
<span class="cm"> * (denormalised values, infinities, underflow, etc).  It is made</span>
<span class="cm"> * quite nasty because emulation of some non-COP1 instructions is</span>
<span class="cm"> * required, e.g. in branch delay slots.</span>
<span class="cm"> *</span>
<span class="cm"> * Note if you know that you won&#39;t have an fpu, then you&#39;ll get much</span>
<span class="cm"> * better performance by compiling with -msoft-float!</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/perf_event.h&gt;</span>

<span class="cp">#include &lt;asm/inst.h&gt;</span>
<span class="cp">#include &lt;asm/bootinfo.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;</span>
<span class="cp">#include &lt;asm/ptrace.h&gt;</span>
<span class="cp">#include &lt;asm/signal.h&gt;</span>
<span class="cp">#include &lt;asm/mipsregs.h&gt;</span>
<span class="cp">#include &lt;asm/fpu_emulator.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/branch.h&gt;</span>

<span class="cp">#include &quot;ieee754.h&quot;</span>

<span class="cm">/* Strap kernel emulator for full MIPS IV emulation */</span>

<span class="cp">#ifdef __mips</span>
<span class="cp">#undef __mips</span>
<span class="cp">#endif</span>
<span class="cp">#define __mips 4</span>

<span class="cm">/* Function which emulates a floating point instruction. */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">fpu_emu</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mips_fpu_struct</span> <span class="o">*</span><span class="p">,</span>
	<span class="n">mips_instruction</span><span class="p">);</span>

<span class="cp">#if __mips &gt;= 4 &amp;&amp; __mips != 32</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fpux_emu</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">mips_fpu_struct</span> <span class="o">*</span><span class="p">,</span> <span class="n">mips_instruction</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__user</span> <span class="o">*</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/* Further private data for which no space exists in mips_fpu_struct */</span>

<span class="cp">#ifdef CONFIG_DEBUG_FS</span>
<span class="n">DEFINE_PER_CPU</span><span class="p">(</span><span class="k">struct</span> <span class="n">mips_fpu_emulator_stats</span><span class="p">,</span> <span class="n">fpuemustats</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/* Control registers */</span>

<span class="cp">#define FPCREG_RID	0	</span><span class="cm">/* $0  = revision id */</span><span class="cp"></span>
<span class="cp">#define FPCREG_CSR	31	</span><span class="cm">/* $31 = csr */</span><span class="cp"></span>

<span class="cm">/* Determine rounding mode from the RM bits of the FCSR */</span>
<span class="cp">#define modeindex(v) ((v) &amp; FPU_CSR_RM)</span>

<span class="cm">/* Convert Mips rounding mode (0..3) to IEEE library modes. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ieee_rm</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">FPU_CSR_RN</span><span class="p">]</span> <span class="o">=</span> <span class="n">IEEE754_RN</span><span class="p">,</span>
	<span class="p">[</span><span class="n">FPU_CSR_RZ</span><span class="p">]</span> <span class="o">=</span> <span class="n">IEEE754_RZ</span><span class="p">,</span>
	<span class="p">[</span><span class="n">FPU_CSR_RU</span><span class="p">]</span> <span class="o">=</span> <span class="n">IEEE754_RU</span><span class="p">,</span>
	<span class="p">[</span><span class="n">FPU_CSR_RD</span><span class="p">]</span> <span class="o">=</span> <span class="n">IEEE754_RD</span><span class="p">,</span>
<span class="p">};</span>
<span class="cm">/* Convert IEEE library modes to Mips rounding mode (0..3). */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mips_rm</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">IEEE754_RN</span><span class="p">]</span> <span class="o">=</span> <span class="n">FPU_CSR_RN</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IEEE754_RZ</span><span class="p">]</span> <span class="o">=</span> <span class="n">FPU_CSR_RZ</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IEEE754_RD</span><span class="p">]</span> <span class="o">=</span> <span class="n">FPU_CSR_RD</span><span class="p">,</span>
	<span class="p">[</span><span class="n">IEEE754_RU</span><span class="p">]</span> <span class="o">=</span> <span class="n">FPU_CSR_RU</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#if __mips &gt;= 4</span>
<span class="cm">/* convert condition code register number to csr bit */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fpucondbit</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">FPU_CSR_COND0</span><span class="p">,</span>
	<span class="n">FPU_CSR_COND1</span><span class="p">,</span>
	<span class="n">FPU_CSR_COND2</span><span class="p">,</span>
	<span class="n">FPU_CSR_COND3</span><span class="p">,</span>
	<span class="n">FPU_CSR_COND4</span><span class="p">,</span>
	<span class="n">FPU_CSR_COND5</span><span class="p">,</span>
	<span class="n">FPU_CSR_COND6</span><span class="p">,</span>
	<span class="n">FPU_CSR_COND7</span>
<span class="p">};</span>
<span class="cp">#endif</span>


<span class="cm">/*</span>
<span class="cm"> * Redundant with logic already in kernel/branch.c,</span>
<span class="cm"> * embedded in compute_return_epc.  At some point,</span>
<span class="cm"> * a single subroutine should be used across both</span>
<span class="cm"> * modules.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isBranchInstr</span><span class="p">(</span><span class="n">mips_instruction</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">MIPSInst_OPCODE</span><span class="p">(</span><span class="o">*</span><span class="n">i</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">spec_op</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">MIPSInst_FUNC</span><span class="p">(</span><span class="o">*</span><span class="n">i</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">jalr_op</span>:
		<span class="k">case</span> <span class="n">jr_op</span>:
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">bcond_op</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">MIPSInst_RT</span><span class="p">(</span><span class="o">*</span><span class="n">i</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">bltz_op</span>:
		<span class="k">case</span> <span class="n">bgez_op</span>:
		<span class="k">case</span> <span class="n">bltzl_op</span>:
		<span class="k">case</span> <span class="n">bgezl_op</span>:
		<span class="k">case</span> <span class="n">bltzal_op</span>:
		<span class="k">case</span> <span class="n">bgezal_op</span>:
		<span class="k">case</span> <span class="n">bltzall_op</span>:
		<span class="k">case</span> <span class="n">bgezall_op</span>:
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">j_op</span>:
	<span class="k">case</span> <span class="n">jal_op</span>:
	<span class="k">case</span> <span class="n">jalx_op</span>:
	<span class="k">case</span> <span class="n">beq_op</span>:
	<span class="k">case</span> <span class="n">bne_op</span>:
	<span class="k">case</span> <span class="n">blez_op</span>:
	<span class="k">case</span> <span class="n">bgtz_op</span>:
	<span class="k">case</span> <span class="n">beql_op</span>:
	<span class="k">case</span> <span class="n">bnel_op</span>:
	<span class="k">case</span> <span class="n">blezl_op</span>:
	<span class="k">case</span> <span class="n">bgtzl_op</span>:
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">cop0_op</span>:
	<span class="k">case</span> <span class="n">cop1_op</span>:
	<span class="k">case</span> <span class="n">cop2_op</span>:
	<span class="k">case</span> <span class="n">cop1x_op</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">MIPSInst_RS</span><span class="p">(</span><span class="o">*</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="n">bc_op</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * In the Linux kernel, we support selection of FPR format on the</span>
<span class="cm"> * basis of the Status.FR bit.  If an FPU is not present, the FR bit</span>
<span class="cm"> * is hardwired to zero, which would imply a 32-bit FPU even for</span>
<span class="cm"> * 64-bit CPUs.  For 64-bit kernels with no FPU we use TIF_32BIT_REGS</span>
<span class="cm"> * as a proxy for the FR bit so that a 64-bit FPU is emulated.  In any</span>
<span class="cm"> * case, for a 32-bit kernel which uses the O32 MIPS ABI, only the</span>
<span class="cm"> * even FPRs are used (Status.FR = 0).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">cop1_64bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">xcp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_fpu</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">xcp</span><span class="o">-&gt;</span><span class="n">cp0_status</span> <span class="o">&amp;</span> <span class="n">ST0_FR</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_64BIT</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">test_thread_flag</span><span class="p">(</span><span class="n">TIF_32BIT_REGS</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cp">#define SIFROMREG(si, x) ((si) = cop1_64bit(xcp) || !(x &amp; 1) ? \</span>
<span class="cp">			(int)ctx-&gt;fpr[x] : (int)(ctx-&gt;fpr[x &amp; ~1] &gt;&gt; 32))</span>

<span class="cp">#define SITOREG(si, x)	(ctx-&gt;fpr[x &amp; ~(cop1_64bit(xcp) == 0)] = \</span>
<span class="cp">			cop1_64bit(xcp) || !(x &amp; 1) ? \</span>
<span class="cp">			ctx-&gt;fpr[x &amp; ~1] &gt;&gt; 32 &lt;&lt; 32 | (u32)(si) : \</span>
<span class="cp">			ctx-&gt;fpr[x &amp; ~1] &lt;&lt; 32 &gt;&gt; 32 | (u64)(si) &lt;&lt; 32)</span>

<span class="cp">#define DIFROMREG(di, x) ((di) = ctx-&gt;fpr[x &amp; ~(cop1_64bit(xcp) == 0)])</span>
<span class="cp">#define DITOREG(di, x)	(ctx-&gt;fpr[x &amp; ~(cop1_64bit(xcp) == 0)] = (di))</span>

<span class="cp">#define SPFROMREG(sp, x) SIFROMREG((sp).bits, x)</span>
<span class="cp">#define SPTOREG(sp, x)	SITOREG((sp).bits, x)</span>
<span class="cp">#define DPFROMREG(dp, x)	DIFROMREG((dp).bits, x)</span>
<span class="cp">#define DPTOREG(dp, x)	DITOREG((dp).bits, x)</span>

<span class="cm">/*</span>
<span class="cm"> * Emulate the single floating point instruction pointed at by EPC.</span>
<span class="cm"> * Two instructions if the instruction is in a branch delay slot.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cop1Emulate</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">xcp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mips_fpu_struct</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
		       <span class="kt">void</span> <span class="o">*</span><span class="n">__user</span> <span class="o">*</span><span class="n">fault_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mips_instruction</span> <span class="n">ir</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">emulpc</span><span class="p">,</span> <span class="n">contpc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cond</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">xcp</span><span class="o">-&gt;</span><span class="n">cp0_epc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mips_instruction</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">MIPS_FPU_EMU_INC_STATS</span><span class="p">(</span><span class="n">errors</span><span class="p">);</span>
		<span class="o">*</span><span class="n">fault_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">mips_instruction</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">xcp</span><span class="o">-&gt;</span><span class="n">cp0_epc</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">SIGBUS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__get_user</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="p">(</span><span class="n">mips_instruction</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">xcp</span><span class="o">-&gt;</span><span class="n">cp0_epc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">MIPS_FPU_EMU_INC_STATS</span><span class="p">(</span><span class="n">errors</span><span class="p">);</span>
		<span class="o">*</span><span class="n">fault_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">mips_instruction</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">xcp</span><span class="o">-&gt;</span><span class="n">cp0_epc</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">SIGSEGV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* XXX NEC Vr54xx bug workaround */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">xcp</span><span class="o">-&gt;</span><span class="n">cp0_cause</span> <span class="o">&amp;</span> <span class="n">CAUSEF_BD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isBranchInstr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ir</span><span class="p">))</span>
		<span class="n">xcp</span><span class="o">-&gt;</span><span class="n">cp0_cause</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CAUSEF_BD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xcp</span><span class="o">-&gt;</span><span class="n">cp0_cause</span> <span class="o">&amp;</span> <span class="n">CAUSEF_BD</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The instruction to be emulated is in a branch delay slot</span>
<span class="cm">		 * which means that we have to  emulate the branch instruction</span>
<span class="cm">		 * BEFORE we do the cop1 instruction.</span>
<span class="cm">		 *</span>
<span class="cm">		 * This branch could be a COP1 branch, but in that case we</span>
<span class="cm">		 * would have had a trap for that instruction, and would not</span>
<span class="cm">		 * come through this route.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Linux MIPS branch emulator operates on context, updating the</span>
<span class="cm">		 * cp0_epc.</span>
<span class="cm">		 */</span>
		<span class="n">emulpc</span> <span class="o">=</span> <span class="n">xcp</span><span class="o">-&gt;</span><span class="n">cp0_epc</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* Snapshot emulation target */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">__compute_return_epc</span><span class="p">(</span><span class="n">xcp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CP1DBG</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;failed to emulate branch at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">xcp</span><span class="o">-&gt;</span><span class="n">cp0_epc</span><span class="p">));</span>
<span class="cp">#endif</span>
			<span class="k">return</span> <span class="n">SIGILL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">emulpc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mips_instruction</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">MIPS_FPU_EMU_INC_STATS</span><span class="p">(</span><span class="n">errors</span><span class="p">);</span>
			<span class="o">*</span><span class="n">fault_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">mips_instruction</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">emulpc</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">SIGBUS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__get_user</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="p">(</span><span class="n">mips_instruction</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">emulpc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">MIPS_FPU_EMU_INC_STATS</span><span class="p">(</span><span class="n">errors</span><span class="p">);</span>
			<span class="o">*</span><span class="n">fault_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">mips_instruction</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">emulpc</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">SIGSEGV</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* __compute_return_epc() will have updated cp0_epc */</span>
		<span class="n">contpc</span> <span class="o">=</span> <span class="n">xcp</span><span class="o">-&gt;</span><span class="n">cp0_epc</span><span class="p">;</span>
		<span class="cm">/* In order not to confuse ptrace() et al, tweak context */</span>
		<span class="n">xcp</span><span class="o">-&gt;</span><span class="n">cp0_epc</span> <span class="o">=</span> <span class="n">emulpc</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">emulpc</span> <span class="o">=</span> <span class="n">xcp</span><span class="o">-&gt;</span><span class="n">cp0_epc</span><span class="p">;</span>
		<span class="n">contpc</span> <span class="o">=</span> <span class="n">xcp</span><span class="o">-&gt;</span><span class="n">cp0_epc</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

      <span class="nl">emul:</span>
	<span class="n">perf_sw_event</span><span class="p">(</span><span class="n">PERF_COUNT_SW_EMULATION_FAULTS</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">xcp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">MIPS_FPU_EMU_INC_STATS</span><span class="p">(</span><span class="n">emulated</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">MIPSInst_OPCODE</span><span class="p">(</span><span class="n">ir</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ldc1_op</span>:<span class="p">{</span>
		<span class="n">u64</span> <span class="n">__user</span> <span class="o">*</span><span class="n">va</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">xcp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">MIPSInst_RS</span><span class="p">(</span><span class="n">ir</span><span class="p">)]</span> <span class="o">+</span>
			<span class="n">MIPSInst_SIMM</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
		<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">MIPS_FPU_EMU_INC_STATS</span><span class="p">(</span><span class="n">loads</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">MIPS_FPU_EMU_INC_STATS</span><span class="p">(</span><span class="n">errors</span><span class="p">);</span>
			<span class="o">*</span><span class="n">fault_addr</span> <span class="o">=</span> <span class="n">va</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">SIGBUS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">va</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">MIPS_FPU_EMU_INC_STATS</span><span class="p">(</span><span class="n">errors</span><span class="p">);</span>
			<span class="o">*</span><span class="n">fault_addr</span> <span class="o">=</span> <span class="n">va</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">SIGSEGV</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">DITOREG</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">MIPSInst_RT</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">sdc1_op</span>:<span class="p">{</span>
		<span class="n">u64</span> <span class="n">__user</span> <span class="o">*</span><span class="n">va</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">xcp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">MIPSInst_RS</span><span class="p">(</span><span class="n">ir</span><span class="p">)]</span> <span class="o">+</span>
			<span class="n">MIPSInst_SIMM</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
		<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">MIPS_FPU_EMU_INC_STATS</span><span class="p">(</span><span class="n">stores</span><span class="p">);</span>
		<span class="n">DIFROMREG</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">MIPSInst_RT</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">MIPS_FPU_EMU_INC_STATS</span><span class="p">(</span><span class="n">errors</span><span class="p">);</span>
			<span class="o">*</span><span class="n">fault_addr</span> <span class="o">=</span> <span class="n">va</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">SIGBUS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__put_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">va</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">MIPS_FPU_EMU_INC_STATS</span><span class="p">(</span><span class="n">errors</span><span class="p">);</span>
			<span class="o">*</span><span class="n">fault_addr</span> <span class="o">=</span> <span class="n">va</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">SIGSEGV</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">lwc1_op</span>:<span class="p">{</span>
		<span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">va</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">xcp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">MIPSInst_RS</span><span class="p">(</span><span class="n">ir</span><span class="p">)]</span> <span class="o">+</span>
			<span class="n">MIPSInst_SIMM</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">MIPS_FPU_EMU_INC_STATS</span><span class="p">(</span><span class="n">loads</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">MIPS_FPU_EMU_INC_STATS</span><span class="p">(</span><span class="n">errors</span><span class="p">);</span>
			<span class="o">*</span><span class="n">fault_addr</span> <span class="o">=</span> <span class="n">va</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">SIGBUS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">va</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">MIPS_FPU_EMU_INC_STATS</span><span class="p">(</span><span class="n">errors</span><span class="p">);</span>
			<span class="o">*</span><span class="n">fault_addr</span> <span class="o">=</span> <span class="n">va</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">SIGSEGV</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">SITOREG</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">MIPSInst_RT</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">swc1_op</span>:<span class="p">{</span>
		<span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">va</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">xcp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">MIPSInst_RS</span><span class="p">(</span><span class="n">ir</span><span class="p">)]</span> <span class="o">+</span>
			<span class="n">MIPSInst_SIMM</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">MIPS_FPU_EMU_INC_STATS</span><span class="p">(</span><span class="n">stores</span><span class="p">);</span>
		<span class="n">SIFROMREG</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">MIPSInst_RT</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">MIPS_FPU_EMU_INC_STATS</span><span class="p">(</span><span class="n">errors</span><span class="p">);</span>
			<span class="o">*</span><span class="n">fault_addr</span> <span class="o">=</span> <span class="n">va</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">SIGBUS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__put_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">va</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">MIPS_FPU_EMU_INC_STATS</span><span class="p">(</span><span class="n">errors</span><span class="p">);</span>
			<span class="o">*</span><span class="n">fault_addr</span> <span class="o">=</span> <span class="n">va</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">SIGSEGV</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">cop1_op</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">MIPSInst_RS</span><span class="p">(</span><span class="n">ir</span><span class="p">))</span> <span class="p">{</span>

<span class="cp">#if defined(__mips64)</span>
		<span class="k">case</span> <span class="n">dmfc_op</span>:
			<span class="cm">/* copregister fs -&gt; gpr[rt] */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">MIPSInst_RT</span><span class="p">(</span><span class="n">ir</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DIFROMREG</span><span class="p">(</span><span class="n">xcp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">MIPSInst_RT</span><span class="p">(</span><span class="n">ir</span><span class="p">)],</span>
					<span class="n">MIPSInst_RD</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">dmtc_op</span>:
			<span class="cm">/* copregister fs &lt;- rt */</span>
			<span class="n">DITOREG</span><span class="p">(</span><span class="n">xcp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">MIPSInst_RT</span><span class="p">(</span><span class="n">ir</span><span class="p">)],</span> <span class="n">MIPSInst_RD</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>

		<span class="k">case</span> <span class="n">mfc_op</span>:
			<span class="cm">/* copregister rd -&gt; gpr[rt] */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">MIPSInst_RT</span><span class="p">(</span><span class="n">ir</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">SIFROMREG</span><span class="p">(</span><span class="n">xcp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">MIPSInst_RT</span><span class="p">(</span><span class="n">ir</span><span class="p">)],</span>
					<span class="n">MIPSInst_RD</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">mtc_op</span>:
			<span class="cm">/* copregister rd &lt;- rt */</span>
			<span class="n">SITOREG</span><span class="p">(</span><span class="n">xcp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">MIPSInst_RT</span><span class="p">(</span><span class="n">ir</span><span class="p">)],</span> <span class="n">MIPSInst_RD</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">cfc_op</span>:<span class="p">{</span>
			<span class="cm">/* cop control register rd -&gt; gpr[rt] */</span>
			<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">MIPSInst_RD</span><span class="p">(</span><span class="n">ir</span><span class="p">)</span> <span class="o">==</span> <span class="n">FPCREG_CSR</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">value</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcr31</span><span class="p">;</span>
				<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FPU_CSR_RM</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">mips_rm</span><span class="p">[</span><span class="n">modeindex</span><span class="p">(</span><span class="n">value</span><span class="p">)];</span>
<span class="cp">#ifdef CSRTRACE</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%p gpr[%d]&lt;-csr=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">xcp</span><span class="o">-&gt;</span><span class="n">cp0_epc</span><span class="p">),</span>
					<span class="n">MIPSInst_RT</span><span class="p">(</span><span class="n">ir</span><span class="p">),</span> <span class="n">value</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">MIPSInst_RD</span><span class="p">(</span><span class="n">ir</span><span class="p">)</span> <span class="o">==</span> <span class="n">FPCREG_RID</span><span class="p">)</span>
				<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">MIPSInst_RT</span><span class="p">(</span><span class="n">ir</span><span class="p">))</span>
				<span class="n">xcp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">MIPSInst_RT</span><span class="p">(</span><span class="n">ir</span><span class="p">)]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">case</span> <span class="n">ctc_op</span>:<span class="p">{</span>
			<span class="cm">/* copregister rd &lt;- rt */</span>
			<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">MIPSInst_RT</span><span class="p">(</span><span class="n">ir</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">value</span> <span class="o">=</span> <span class="n">xcp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">MIPSInst_RT</span><span class="p">(</span><span class="n">ir</span><span class="p">)];</span>

			<span class="cm">/* we only have one writable control reg</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">MIPSInst_RD</span><span class="p">(</span><span class="n">ir</span><span class="p">)</span> <span class="o">==</span> <span class="n">FPCREG_CSR</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CSRTRACE</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%p gpr[%d]-&gt;csr=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">xcp</span><span class="o">-&gt;</span><span class="n">cp0_epc</span><span class="p">),</span>
					<span class="n">MIPSInst_RT</span><span class="p">(</span><span class="n">ir</span><span class="p">),</span> <span class="n">value</span><span class="p">);</span>
<span class="cp">#endif</span>

				<span class="cm">/*</span>
<span class="cm">				 * Don&#39;t write reserved bits,</span>
<span class="cm">				 * and convert to ieee library modes</span>
<span class="cm">				 */</span>
				<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcr31</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span>
						<span class="o">~</span><span class="p">(</span><span class="n">FPU_CSR_RSVD</span> <span class="o">|</span> <span class="n">FPU_CSR_RM</span><span class="p">))</span> <span class="o">|</span>
						<span class="n">ieee_rm</span><span class="p">[</span><span class="n">modeindex</span><span class="p">(</span><span class="n">value</span><span class="p">)];</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcr31</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcr31</span> <span class="o">&amp;</span> <span class="n">FPU_CSR_ALL_E</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span> <span class="n">SIGFPE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">case</span> <span class="n">bc_op</span>:<span class="p">{</span>
			<span class="kt">int</span> <span class="n">likely</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">xcp</span><span class="o">-&gt;</span><span class="n">cp0_cause</span> <span class="o">&amp;</span> <span class="n">CAUSEF_BD</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">SIGILL</span><span class="p">;</span>

<span class="cp">#if __mips &gt;= 4</span>
			<span class="n">cond</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcr31</span> <span class="o">&amp;</span> <span class="n">fpucondbit</span><span class="p">[</span><span class="n">MIPSInst_RT</span><span class="p">(</span><span class="n">ir</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">];</span>
<span class="cp">#else</span>
			<span class="n">cond</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcr31</span> <span class="o">&amp;</span> <span class="n">FPU_CSR_COND</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">MIPSInst_RT</span><span class="p">(</span><span class="n">ir</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">bcfl_op</span>:
				<span class="n">likely</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">bcf_op</span>:
				<span class="n">cond</span> <span class="o">=</span> <span class="o">!</span><span class="n">cond</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">bctl_op</span>:
				<span class="n">likely</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">bct_op</span>:
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="cm">/* thats an illegal instruction */</span>
				<span class="k">return</span> <span class="n">SIGILL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">xcp</span><span class="o">-&gt;</span><span class="n">cp0_cause</span> <span class="o">|=</span> <span class="n">CAUSEF_BD</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cond</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* branch taken: emulate dslot</span>
<span class="cm">				 * instruction</span>
<span class="cm">				 */</span>
				<span class="n">xcp</span><span class="o">-&gt;</span><span class="n">cp0_epc</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">contpc</span> <span class="o">=</span> <span class="p">(</span><span class="n">xcp</span><span class="o">-&gt;</span><span class="n">cp0_epc</span> <span class="o">+</span>
					<span class="p">(</span><span class="n">MIPSInst_SIMM</span><span class="p">(</span><span class="n">ir</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">xcp</span><span class="o">-&gt;</span><span class="n">cp0_epc</span><span class="p">,</span>
					       <span class="k">sizeof</span><span class="p">(</span><span class="n">mips_instruction</span><span class="p">)))</span> <span class="p">{</span>
					<span class="n">MIPS_FPU_EMU_INC_STATS</span><span class="p">(</span><span class="n">errors</span><span class="p">);</span>
					<span class="o">*</span><span class="n">fault_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">mips_instruction</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">xcp</span><span class="o">-&gt;</span><span class="n">cp0_epc</span><span class="p">;</span>
					<span class="k">return</span> <span class="n">SIGBUS</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">__get_user</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">mips_instruction</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">xcp</span><span class="o">-&gt;</span><span class="n">cp0_epc</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">MIPS_FPU_EMU_INC_STATS</span><span class="p">(</span><span class="n">errors</span><span class="p">);</span>
					<span class="o">*</span><span class="n">fault_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">mips_instruction</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">xcp</span><span class="o">-&gt;</span><span class="n">cp0_epc</span><span class="p">;</span>
					<span class="k">return</span> <span class="n">SIGSEGV</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">switch</span> <span class="p">(</span><span class="n">MIPSInst_OPCODE</span><span class="p">(</span><span class="n">ir</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">lwc1_op</span>:
				<span class="k">case</span> <span class="n">swc1_op</span>:
<span class="cp">#if (__mips &gt;= 2 || defined(__mips64))</span>
				<span class="k">case</span> <span class="n">ldc1_op</span>:
				<span class="k">case</span> <span class="n">sdc1_op</span>:
<span class="cp">#endif</span>
				<span class="k">case</span> <span class="n">cop1_op</span>:
<span class="cp">#if __mips &gt;= 4 &amp;&amp; __mips != 32</span>
				<span class="k">case</span> <span class="n">cop1x_op</span>:
<span class="cp">#endif</span>
					<span class="cm">/* its one of ours */</span>
					<span class="k">goto</span> <span class="n">emul</span><span class="p">;</span>
<span class="cp">#if __mips &gt;= 4</span>
				<span class="k">case</span> <span class="n">spec_op</span>:
					<span class="k">if</span> <span class="p">(</span><span class="n">MIPSInst_FUNC</span><span class="p">(</span><span class="n">ir</span><span class="p">)</span> <span class="o">==</span> <span class="n">movc_op</span><span class="p">)</span>
						<span class="k">goto</span> <span class="n">emul</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
				<span class="p">}</span>

				<span class="cm">/*</span>
<span class="cm">				 * Single step the non-cp1</span>
<span class="cm">				 * instruction in the dslot</span>
<span class="cm">				 */</span>
				<span class="k">return</span> <span class="n">mips_dsemul</span><span class="p">(</span><span class="n">xcp</span><span class="p">,</span> <span class="n">ir</span><span class="p">,</span> <span class="n">contpc</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* branch not taken */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/*</span>
<span class="cm">					 * branch likely nullifies</span>
<span class="cm">					 * dslot if not taken</span>
<span class="cm">					 */</span>
					<span class="n">xcp</span><span class="o">-&gt;</span><span class="n">cp0_epc</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
					<span class="n">contpc</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
					<span class="cm">/*</span>
<span class="cm">					 * else continue &amp; execute</span>
<span class="cm">					 * dslot as normal insn</span>
<span class="cm">					 */</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">MIPSInst_RS</span><span class="p">(</span><span class="n">ir</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">SIGILL</span><span class="p">;</span>
			<span class="p">{</span>
				<span class="kt">int</span> <span class="n">sig</span><span class="p">;</span>

				<span class="cm">/* a real fpu computation instruction */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">sig</span> <span class="o">=</span> <span class="n">fpu_emu</span><span class="p">(</span><span class="n">xcp</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">ir</span><span class="p">)))</span>
					<span class="k">return</span> <span class="n">sig</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cp">#if __mips &gt;= 4 &amp;&amp; __mips != 32</span>
	<span class="k">case</span> <span class="n">cop1x_op</span>:<span class="p">{</span>
		<span class="kt">int</span> <span class="n">sig</span> <span class="o">=</span> <span class="n">fpux_emu</span><span class="p">(</span><span class="n">xcp</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">ir</span><span class="p">,</span> <span class="n">fault_addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sig</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">sig</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#if __mips &gt;= 4</span>
	<span class="k">case</span> <span class="n">spec_op</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">MIPSInst_FUNC</span><span class="p">(</span><span class="n">ir</span><span class="p">)</span> <span class="o">!=</span> <span class="n">movc_op</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">SIGILL</span><span class="p">;</span>
		<span class="n">cond</span> <span class="o">=</span> <span class="n">fpucondbit</span><span class="p">[</span><span class="n">MIPSInst_RT</span><span class="p">(</span><span class="n">ir</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcr31</span> <span class="o">&amp;</span> <span class="n">cond</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="p">((</span><span class="n">MIPSInst_RT</span><span class="p">(</span><span class="n">ir</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">xcp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">MIPSInst_RD</span><span class="p">(</span><span class="n">ir</span><span class="p">)]</span> <span class="o">=</span>
				<span class="n">xcp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">MIPSInst_RS</span><span class="p">(</span><span class="n">ir</span><span class="p">)];</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">SIGILL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* we did it !! */</span>
	<span class="n">xcp</span><span class="o">-&gt;</span><span class="n">cp0_epc</span> <span class="o">=</span> <span class="n">contpc</span><span class="p">;</span>
	<span class="n">xcp</span><span class="o">-&gt;</span><span class="n">cp0_cause</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CAUSEF_BD</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Conversion table from MIPS compare ops 48-63</span>
<span class="cm"> * cond = ieee754dp_cmp(x,y,IEEE754_UN,sig);</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cmptab</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span>			<span class="cm">/* cmp_0 (sig) cmp_sf */</span>
	<span class="n">IEEE754_CUN</span><span class="p">,</span>		<span class="cm">/* cmp_un (sig) cmp_ngle */</span>
	<span class="n">IEEE754_CEQ</span><span class="p">,</span>		<span class="cm">/* cmp_eq (sig) cmp_seq */</span>
	<span class="n">IEEE754_CEQ</span> <span class="o">|</span> <span class="n">IEEE754_CUN</span><span class="p">,</span>	<span class="cm">/* cmp_ueq (sig) cmp_ngl  */</span>
	<span class="n">IEEE754_CLT</span><span class="p">,</span>		<span class="cm">/* cmp_olt (sig) cmp_lt */</span>
	<span class="n">IEEE754_CLT</span> <span class="o">|</span> <span class="n">IEEE754_CUN</span><span class="p">,</span>	<span class="cm">/* cmp_ult (sig) cmp_nge */</span>
	<span class="n">IEEE754_CLT</span> <span class="o">|</span> <span class="n">IEEE754_CEQ</span><span class="p">,</span>	<span class="cm">/* cmp_ole (sig) cmp_le */</span>
	<span class="n">IEEE754_CLT</span> <span class="o">|</span> <span class="n">IEEE754_CEQ</span> <span class="o">|</span> <span class="n">IEEE754_CUN</span><span class="p">,</span>	<span class="cm">/* cmp_ule (sig) cmp_ngt */</span>
<span class="p">};</span>


<span class="cp">#if __mips &gt;= 4 &amp;&amp; __mips != 32</span>

<span class="cm">/*</span>
<span class="cm"> * Additional MIPS4 instructions</span>
<span class="cm"> */</span>

<span class="cp">#define DEF3OP(name, p, f1, f2, f3) \</span>
<span class="cp">static ieee754##p fpemu_##p##_##name(ieee754##p r, ieee754##p s, \</span>
<span class="cp">    ieee754##p t) \</span>
<span class="cp">{ \</span>
<span class="cp">	struct _ieee754_csr ieee754_csr_save; \</span>
<span class="cp">	s = f1(s, t); \</span>
<span class="cp">	ieee754_csr_save = ieee754_csr; \</span>
<span class="cp">	s = f2(s, r); \</span>
<span class="cp">	ieee754_csr_save.cx |= ieee754_csr.cx; \</span>
<span class="cp">	ieee754_csr_save.sx |= ieee754_csr.sx; \</span>
<span class="cp">	s = f3(s); \</span>
<span class="cp">	ieee754_csr.cx |= ieee754_csr_save.cx; \</span>
<span class="cp">	ieee754_csr.sx |= ieee754_csr_save.sx; \</span>
<span class="cp">	return s; \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="n">ieee754dp</span> <span class="nf">fpemu_dp_recip</span><span class="p">(</span><span class="n">ieee754dp</span> <span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ieee754dp_div</span><span class="p">(</span><span class="n">ieee754dp_one</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">d</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ieee754dp</span> <span class="nf">fpemu_dp_rsqrt</span><span class="p">(</span><span class="n">ieee754dp</span> <span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ieee754dp_div</span><span class="p">(</span><span class="n">ieee754dp_one</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">ieee754dp_sqrt</span><span class="p">(</span><span class="n">d</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ieee754sp</span> <span class="nf">fpemu_sp_recip</span><span class="p">(</span><span class="n">ieee754sp</span> <span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ieee754sp_div</span><span class="p">(</span><span class="n">ieee754sp_one</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ieee754sp</span> <span class="nf">fpemu_sp_rsqrt</span><span class="p">(</span><span class="n">ieee754sp</span> <span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ieee754sp_div</span><span class="p">(</span><span class="n">ieee754sp_one</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">ieee754sp_sqrt</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
<span class="p">}</span>

<span class="n">DEF3OP</span><span class="p">(</span><span class="n">madd</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">ieee754sp_mul</span><span class="p">,</span> <span class="n">ieee754sp_add</span><span class="p">,</span> <span class="p">);</span>
<span class="n">DEF3OP</span><span class="p">(</span><span class="n">msub</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">ieee754sp_mul</span><span class="p">,</span> <span class="n">ieee754sp_sub</span><span class="p">,</span> <span class="p">);</span>
<span class="n">DEF3OP</span><span class="p">(</span><span class="n">nmadd</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">ieee754sp_mul</span><span class="p">,</span> <span class="n">ieee754sp_add</span><span class="p">,</span> <span class="n">ieee754sp_neg</span><span class="p">);</span>
<span class="n">DEF3OP</span><span class="p">(</span><span class="n">nmsub</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">ieee754sp_mul</span><span class="p">,</span> <span class="n">ieee754sp_sub</span><span class="p">,</span> <span class="n">ieee754sp_neg</span><span class="p">);</span>
<span class="n">DEF3OP</span><span class="p">(</span><span class="n">madd</span><span class="p">,</span> <span class="n">dp</span><span class="p">,</span> <span class="n">ieee754dp_mul</span><span class="p">,</span> <span class="n">ieee754dp_add</span><span class="p">,</span> <span class="p">);</span>
<span class="n">DEF3OP</span><span class="p">(</span><span class="n">msub</span><span class="p">,</span> <span class="n">dp</span><span class="p">,</span> <span class="n">ieee754dp_mul</span><span class="p">,</span> <span class="n">ieee754dp_sub</span><span class="p">,</span> <span class="p">);</span>
<span class="n">DEF3OP</span><span class="p">(</span><span class="n">nmadd</span><span class="p">,</span> <span class="n">dp</span><span class="p">,</span> <span class="n">ieee754dp_mul</span><span class="p">,</span> <span class="n">ieee754dp_add</span><span class="p">,</span> <span class="n">ieee754dp_neg</span><span class="p">);</span>
<span class="n">DEF3OP</span><span class="p">(</span><span class="n">nmsub</span><span class="p">,</span> <span class="n">dp</span><span class="p">,</span> <span class="n">ieee754dp_mul</span><span class="p">,</span> <span class="n">ieee754dp_sub</span><span class="p">,</span> <span class="n">ieee754dp_neg</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fpux_emu</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">xcp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mips_fpu_struct</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
	<span class="n">mips_instruction</span> <span class="n">ir</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__user</span> <span class="o">*</span><span class="n">fault_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">rcsr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* resulting csr */</span>

	<span class="n">MIPS_FPU_EMU_INC_STATS</span><span class="p">(</span><span class="n">cp1xops</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">MIPSInst_FMA_FFMT</span><span class="p">(</span><span class="n">ir</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">s_fmt</span>:<span class="p">{</span>		<span class="cm">/* 0 */</span>

		<span class="n">ieee754sp</span><span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)</span> <span class="p">(</span><span class="n">ieee754sp</span><span class="p">,</span> <span class="n">ieee754sp</span><span class="p">,</span> <span class="n">ieee754sp</span><span class="p">);</span>
		<span class="n">ieee754sp</span> <span class="n">fd</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">ft</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">va</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">MIPSInst_FUNC</span><span class="p">(</span><span class="n">ir</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">lwxc1_op</span>:
			<span class="n">va</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">xcp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">MIPSInst_FR</span><span class="p">(</span><span class="n">ir</span><span class="p">)]</span> <span class="o">+</span>
				<span class="n">xcp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">MIPSInst_FT</span><span class="p">(</span><span class="n">ir</span><span class="p">)]);</span>

			<span class="n">MIPS_FPU_EMU_INC_STATS</span><span class="p">(</span><span class="n">loads</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">MIPS_FPU_EMU_INC_STATS</span><span class="p">(</span><span class="n">errors</span><span class="p">);</span>
				<span class="o">*</span><span class="n">fault_addr</span> <span class="o">=</span> <span class="n">va</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">SIGBUS</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">__get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">va</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">MIPS_FPU_EMU_INC_STATS</span><span class="p">(</span><span class="n">errors</span><span class="p">);</span>
				<span class="o">*</span><span class="n">fault_addr</span> <span class="o">=</span> <span class="n">va</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">SIGSEGV</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">SITOREG</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">MIPSInst_FD</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">swxc1_op</span>:
			<span class="n">va</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">xcp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">MIPSInst_FR</span><span class="p">(</span><span class="n">ir</span><span class="p">)]</span> <span class="o">+</span>
				<span class="n">xcp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">MIPSInst_FT</span><span class="p">(</span><span class="n">ir</span><span class="p">)]);</span>

			<span class="n">MIPS_FPU_EMU_INC_STATS</span><span class="p">(</span><span class="n">stores</span><span class="p">);</span>

			<span class="n">SIFROMREG</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">MIPSInst_FS</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">MIPS_FPU_EMU_INC_STATS</span><span class="p">(</span><span class="n">errors</span><span class="p">);</span>
				<span class="o">*</span><span class="n">fault_addr</span> <span class="o">=</span> <span class="n">va</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">SIGBUS</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">va</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">MIPS_FPU_EMU_INC_STATS</span><span class="p">(</span><span class="n">errors</span><span class="p">);</span>
				<span class="o">*</span><span class="n">fault_addr</span> <span class="o">=</span> <span class="n">va</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">SIGSEGV</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">madd_s_op</span>:
			<span class="n">handler</span> <span class="o">=</span> <span class="n">fpemu_sp_madd</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">scoptop</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">msub_s_op</span>:
			<span class="n">handler</span> <span class="o">=</span> <span class="n">fpemu_sp_msub</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">scoptop</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">nmadd_s_op</span>:
			<span class="n">handler</span> <span class="o">=</span> <span class="n">fpemu_sp_nmadd</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">scoptop</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">nmsub_s_op</span>:
			<span class="n">handler</span> <span class="o">=</span> <span class="n">fpemu_sp_nmsub</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">scoptop</span><span class="p">;</span>

		      <span class="nl">scoptop:</span>
			<span class="n">SPFROMREG</span><span class="p">(</span><span class="n">fr</span><span class="p">,</span> <span class="n">MIPSInst_FR</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
			<span class="n">SPFROMREG</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">MIPSInst_FS</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
			<span class="n">SPFROMREG</span><span class="p">(</span><span class="n">ft</span><span class="p">,</span> <span class="n">MIPSInst_FT</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
			<span class="n">fd</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)</span> <span class="p">(</span><span class="n">fr</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">ft</span><span class="p">);</span>
			<span class="n">SPTOREG</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">MIPSInst_FD</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>

		      <span class="nl">copcsr:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ieee754_cxtest</span><span class="p">(</span><span class="n">IEEE754_INEXACT</span><span class="p">))</span>
				<span class="n">rcsr</span> <span class="o">|=</span> <span class="n">FPU_CSR_INE_X</span> <span class="o">|</span> <span class="n">FPU_CSR_INE_S</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ieee754_cxtest</span><span class="p">(</span><span class="n">IEEE754_UNDERFLOW</span><span class="p">))</span>
				<span class="n">rcsr</span> <span class="o">|=</span> <span class="n">FPU_CSR_UDF_X</span> <span class="o">|</span> <span class="n">FPU_CSR_UDF_S</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ieee754_cxtest</span><span class="p">(</span><span class="n">IEEE754_OVERFLOW</span><span class="p">))</span>
				<span class="n">rcsr</span> <span class="o">|=</span> <span class="n">FPU_CSR_OVF_X</span> <span class="o">|</span> <span class="n">FPU_CSR_OVF_S</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ieee754_cxtest</span><span class="p">(</span><span class="n">IEEE754_INVALID_OPERATION</span><span class="p">))</span>
				<span class="n">rcsr</span> <span class="o">|=</span> <span class="n">FPU_CSR_INV_X</span> <span class="o">|</span> <span class="n">FPU_CSR_INV_S</span><span class="p">;</span>

			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcr31</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcr31</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FPU_CSR_ALL_X</span><span class="p">)</span> <span class="o">|</span> <span class="n">rcsr</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcr31</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcr31</span> <span class="o">&amp;</span> <span class="n">FPU_CSR_ALL_E</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*printk (&quot;SIGFPE: fpu csr = %08x\n&quot;,</span>
<span class="cm">				   ctx-&gt;fcr31); */</span>
				<span class="k">return</span> <span class="n">SIGFPE</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">return</span> <span class="n">SIGILL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">d_fmt</span>:<span class="p">{</span>		<span class="cm">/* 1 */</span>
		<span class="n">ieee754dp</span><span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)</span> <span class="p">(</span><span class="n">ieee754dp</span><span class="p">,</span> <span class="n">ieee754dp</span><span class="p">,</span> <span class="n">ieee754dp</span><span class="p">);</span>
		<span class="n">ieee754dp</span> <span class="n">fd</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">ft</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">__user</span> <span class="o">*</span><span class="n">va</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">MIPSInst_FUNC</span><span class="p">(</span><span class="n">ir</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ldxc1_op</span>:
			<span class="n">va</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">xcp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">MIPSInst_FR</span><span class="p">(</span><span class="n">ir</span><span class="p">)]</span> <span class="o">+</span>
				<span class="n">xcp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">MIPSInst_FT</span><span class="p">(</span><span class="n">ir</span><span class="p">)]);</span>

			<span class="n">MIPS_FPU_EMU_INC_STATS</span><span class="p">(</span><span class="n">loads</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">MIPS_FPU_EMU_INC_STATS</span><span class="p">(</span><span class="n">errors</span><span class="p">);</span>
				<span class="o">*</span><span class="n">fault_addr</span> <span class="o">=</span> <span class="n">va</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">SIGBUS</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">__get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">va</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">MIPS_FPU_EMU_INC_STATS</span><span class="p">(</span><span class="n">errors</span><span class="p">);</span>
				<span class="o">*</span><span class="n">fault_addr</span> <span class="o">=</span> <span class="n">va</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">SIGSEGV</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">DITOREG</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">MIPSInst_FD</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">sdxc1_op</span>:
			<span class="n">va</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">xcp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">MIPSInst_FR</span><span class="p">(</span><span class="n">ir</span><span class="p">)]</span> <span class="o">+</span>
				<span class="n">xcp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">MIPSInst_FT</span><span class="p">(</span><span class="n">ir</span><span class="p">)]);</span>

			<span class="n">MIPS_FPU_EMU_INC_STATS</span><span class="p">(</span><span class="n">stores</span><span class="p">);</span>
			<span class="n">DIFROMREG</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">MIPSInst_FS</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">MIPS_FPU_EMU_INC_STATS</span><span class="p">(</span><span class="n">errors</span><span class="p">);</span>
				<span class="o">*</span><span class="n">fault_addr</span> <span class="o">=</span> <span class="n">va</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">SIGBUS</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">__put_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">va</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">MIPS_FPU_EMU_INC_STATS</span><span class="p">(</span><span class="n">errors</span><span class="p">);</span>
				<span class="o">*</span><span class="n">fault_addr</span> <span class="o">=</span> <span class="n">va</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">SIGSEGV</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">madd_d_op</span>:
			<span class="n">handler</span> <span class="o">=</span> <span class="n">fpemu_dp_madd</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">dcoptop</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">msub_d_op</span>:
			<span class="n">handler</span> <span class="o">=</span> <span class="n">fpemu_dp_msub</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">dcoptop</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">nmadd_d_op</span>:
			<span class="n">handler</span> <span class="o">=</span> <span class="n">fpemu_dp_nmadd</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">dcoptop</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">nmsub_d_op</span>:
			<span class="n">handler</span> <span class="o">=</span> <span class="n">fpemu_dp_nmsub</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">dcoptop</span><span class="p">;</span>

		      <span class="nl">dcoptop:</span>
			<span class="n">DPFROMREG</span><span class="p">(</span><span class="n">fr</span><span class="p">,</span> <span class="n">MIPSInst_FR</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
			<span class="n">DPFROMREG</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">MIPSInst_FS</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
			<span class="n">DPFROMREG</span><span class="p">(</span><span class="n">ft</span><span class="p">,</span> <span class="n">MIPSInst_FT</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
			<span class="n">fd</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)</span> <span class="p">(</span><span class="n">fr</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">ft</span><span class="p">);</span>
			<span class="n">DPTOREG</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">MIPSInst_FD</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">copcsr</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">return</span> <span class="n">SIGILL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="mh">0x7</span>:		<span class="cm">/* 7 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">MIPSInst_FUNC</span><span class="p">(</span><span class="n">ir</span><span class="p">)</span> <span class="o">!=</span> <span class="n">pfetch_op</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">SIGILL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* ignore prefx operation */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">SIGILL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>



<span class="cm">/*</span>
<span class="cm"> * Emulate a single COP1 arithmetic instruction.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fpu_emu</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">xcp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mips_fpu_struct</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
	<span class="n">mips_instruction</span> <span class="n">ir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rfmt</span><span class="p">;</span>		<span class="cm">/* resulting format */</span>
	<span class="kt">unsigned</span> <span class="n">rcsr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* resulting csr */</span>
	<span class="kt">unsigned</span> <span class="n">cond</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="n">ieee754dp</span> <span class="n">d</span><span class="p">;</span>
		<span class="n">ieee754sp</span> <span class="n">s</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">w</span><span class="p">;</span>
<span class="cp">#ifdef __mips64</span>
		<span class="n">s64</span> <span class="n">l</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="n">rv</span><span class="p">;</span>			<span class="cm">/* resulting value */</span>

	<span class="n">MIPS_FPU_EMU_INC_STATS</span><span class="p">(</span><span class="n">cp1ops</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rfmt</span> <span class="o">=</span> <span class="p">(</span><span class="n">MIPSInst_FFMT</span><span class="p">(</span><span class="n">ir</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">s_fmt</span>:<span class="p">{</span>		<span class="cm">/* 0 */</span>
		<span class="k">union</span> <span class="p">{</span>
			<span class="n">ieee754sp</span><span class="p">(</span><span class="o">*</span><span class="n">b</span><span class="p">)</span> <span class="p">(</span><span class="n">ieee754sp</span><span class="p">,</span> <span class="n">ieee754sp</span><span class="p">);</span>
			<span class="n">ieee754sp</span><span class="p">(</span><span class="o">*</span><span class="n">u</span><span class="p">)</span> <span class="p">(</span><span class="n">ieee754sp</span><span class="p">);</span>
		<span class="p">}</span> <span class="n">handler</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">MIPSInst_FUNC</span><span class="p">(</span><span class="n">ir</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* binary ops */</span>
		<span class="k">case</span> <span class="n">fadd_op</span>:
			<span class="n">handler</span><span class="p">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">ieee754sp_add</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">scopbop</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">fsub_op</span>:
			<span class="n">handler</span><span class="p">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">ieee754sp_sub</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">scopbop</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">fmul_op</span>:
			<span class="n">handler</span><span class="p">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">ieee754sp_mul</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">scopbop</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">fdiv_op</span>:
			<span class="n">handler</span><span class="p">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">ieee754sp_div</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">scopbop</span><span class="p">;</span>

			<span class="cm">/* unary  ops */</span>
<span class="cp">#if __mips &gt;= 2 || defined(__mips64)</span>
		<span class="k">case</span> <span class="n">fsqrt_op</span>:
			<span class="n">handler</span><span class="p">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">ieee754sp_sqrt</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">scopuop</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if __mips &gt;= 4 &amp;&amp; __mips != 32</span>
		<span class="k">case</span> <span class="n">frsqrt_op</span>:
			<span class="n">handler</span><span class="p">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">fpemu_sp_rsqrt</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">scopuop</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">frecip_op</span>:
			<span class="n">handler</span><span class="p">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">fpemu_sp_recip</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">scopuop</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if __mips &gt;= 4</span>
		<span class="k">case</span> <span class="n">fmovc_op</span>:
			<span class="n">cond</span> <span class="o">=</span> <span class="n">fpucondbit</span><span class="p">[</span><span class="n">MIPSInst_FT</span><span class="p">(</span><span class="n">ir</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcr31</span> <span class="o">&amp;</span> <span class="n">cond</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span>
				<span class="p">((</span><span class="n">MIPSInst_FT</span><span class="p">(</span><span class="n">ir</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">SPFROMREG</span><span class="p">(</span><span class="n">rv</span><span class="p">.</span><span class="n">s</span><span class="p">,</span> <span class="n">MIPSInst_FS</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">fmovz_op</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">xcp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">MIPSInst_FT</span><span class="p">(</span><span class="n">ir</span><span class="p">)]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">SPFROMREG</span><span class="p">(</span><span class="n">rv</span><span class="p">.</span><span class="n">s</span><span class="p">,</span> <span class="n">MIPSInst_FS</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">fmovn_op</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">xcp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">MIPSInst_FT</span><span class="p">(</span><span class="n">ir</span><span class="p">)]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">SPFROMREG</span><span class="p">(</span><span class="n">rv</span><span class="p">.</span><span class="n">s</span><span class="p">,</span> <span class="n">MIPSInst_FS</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">case</span> <span class="n">fabs_op</span>:
			<span class="n">handler</span><span class="p">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">ieee754sp_abs</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">scopuop</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">fneg_op</span>:
			<span class="n">handler</span><span class="p">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">ieee754sp_neg</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">scopuop</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">fmov_op</span>:
			<span class="cm">/* an easy one */</span>
			<span class="n">SPFROMREG</span><span class="p">(</span><span class="n">rv</span><span class="p">.</span><span class="n">s</span><span class="p">,</span> <span class="n">MIPSInst_FS</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">copcsr</span><span class="p">;</span>

			<span class="cm">/* binary op on handler */</span>
		      <span class="nl">scopbop:</span>
			<span class="p">{</span>
				<span class="n">ieee754sp</span> <span class="n">fs</span><span class="p">,</span> <span class="n">ft</span><span class="p">;</span>

				<span class="n">SPFROMREG</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">MIPSInst_FS</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
				<span class="n">SPFROMREG</span><span class="p">(</span><span class="n">ft</span><span class="p">,</span> <span class="n">MIPSInst_FT</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>

				<span class="n">rv</span><span class="p">.</span><span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">.</span><span class="n">b</span><span class="p">)</span> <span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">ft</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">copcsr</span><span class="p">;</span>
			<span class="p">}</span>
		      <span class="nl">scopuop:</span>
			<span class="p">{</span>
				<span class="n">ieee754sp</span> <span class="n">fs</span><span class="p">;</span>

				<span class="n">SPFROMREG</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">MIPSInst_FS</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
				<span class="n">rv</span><span class="p">.</span><span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">.</span><span class="n">u</span><span class="p">)</span> <span class="p">(</span><span class="n">fs</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">copcsr</span><span class="p">;</span>
			<span class="p">}</span>
		      <span class="nl">copcsr:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ieee754_cxtest</span><span class="p">(</span><span class="n">IEEE754_INEXACT</span><span class="p">))</span>
				<span class="n">rcsr</span> <span class="o">|=</span> <span class="n">FPU_CSR_INE_X</span> <span class="o">|</span> <span class="n">FPU_CSR_INE_S</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ieee754_cxtest</span><span class="p">(</span><span class="n">IEEE754_UNDERFLOW</span><span class="p">))</span>
				<span class="n">rcsr</span> <span class="o">|=</span> <span class="n">FPU_CSR_UDF_X</span> <span class="o">|</span> <span class="n">FPU_CSR_UDF_S</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ieee754_cxtest</span><span class="p">(</span><span class="n">IEEE754_OVERFLOW</span><span class="p">))</span>
				<span class="n">rcsr</span> <span class="o">|=</span> <span class="n">FPU_CSR_OVF_X</span> <span class="o">|</span> <span class="n">FPU_CSR_OVF_S</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ieee754_cxtest</span><span class="p">(</span><span class="n">IEEE754_ZERO_DIVIDE</span><span class="p">))</span>
				<span class="n">rcsr</span> <span class="o">|=</span> <span class="n">FPU_CSR_DIV_X</span> <span class="o">|</span> <span class="n">FPU_CSR_DIV_S</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ieee754_cxtest</span><span class="p">(</span><span class="n">IEEE754_INVALID_OPERATION</span><span class="p">))</span>
				<span class="n">rcsr</span> <span class="o">|=</span> <span class="n">FPU_CSR_INV_X</span> <span class="o">|</span> <span class="n">FPU_CSR_INV_S</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* unary conv ops */</span>
		<span class="k">case</span> <span class="n">fcvts_op</span>:
			<span class="k">return</span> <span class="n">SIGILL</span><span class="p">;</span>	<span class="cm">/* not defined */</span>
		<span class="k">case</span> <span class="n">fcvtd_op</span>:<span class="p">{</span>
			<span class="n">ieee754sp</span> <span class="n">fs</span><span class="p">;</span>

			<span class="n">SPFROMREG</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">MIPSInst_FS</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
			<span class="n">rv</span><span class="p">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">ieee754dp_fsp</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
			<span class="n">rfmt</span> <span class="o">=</span> <span class="n">d_fmt</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">copcsr</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">fcvtw_op</span>:<span class="p">{</span>
			<span class="n">ieee754sp</span> <span class="n">fs</span><span class="p">;</span>

			<span class="n">SPFROMREG</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">MIPSInst_FS</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
			<span class="n">rv</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">ieee754sp_tint</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
			<span class="n">rfmt</span> <span class="o">=</span> <span class="n">w_fmt</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">copcsr</span><span class="p">;</span>
		<span class="p">}</span>

<span class="cp">#if __mips &gt;= 2 || defined(__mips64)</span>
		<span class="k">case</span> <span class="n">fround_op</span>:
		<span class="k">case</span> <span class="n">ftrunc_op</span>:
		<span class="k">case</span> <span class="n">fceil_op</span>:
		<span class="k">case</span> <span class="n">ffloor_op</span>:<span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">oldrm</span> <span class="o">=</span> <span class="n">ieee754_csr</span><span class="p">.</span><span class="n">rm</span><span class="p">;</span>
			<span class="n">ieee754sp</span> <span class="n">fs</span><span class="p">;</span>

			<span class="n">SPFROMREG</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">MIPSInst_FS</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
			<span class="n">ieee754_csr</span><span class="p">.</span><span class="n">rm</span> <span class="o">=</span> <span class="n">ieee_rm</span><span class="p">[</span><span class="n">modeindex</span><span class="p">(</span><span class="n">MIPSInst_FUNC</span><span class="p">(</span><span class="n">ir</span><span class="p">))];</span>
			<span class="n">rv</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">ieee754sp_tint</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
			<span class="n">ieee754_csr</span><span class="p">.</span><span class="n">rm</span> <span class="o">=</span> <span class="n">oldrm</span><span class="p">;</span>
			<span class="n">rfmt</span> <span class="o">=</span> <span class="n">w_fmt</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">copcsr</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* __mips &gt;= 2 */</span><span class="cp"></span>

<span class="cp">#if defined(__mips64)</span>
		<span class="k">case</span> <span class="n">fcvtl_op</span>:<span class="p">{</span>
			<span class="n">ieee754sp</span> <span class="n">fs</span><span class="p">;</span>

			<span class="n">SPFROMREG</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">MIPSInst_FS</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
			<span class="n">rv</span><span class="p">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">ieee754sp_tlong</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
			<span class="n">rfmt</span> <span class="o">=</span> <span class="n">l_fmt</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">copcsr</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">case</span> <span class="n">froundl_op</span>:
		<span class="k">case</span> <span class="n">ftruncl_op</span>:
		<span class="k">case</span> <span class="n">fceill_op</span>:
		<span class="k">case</span> <span class="n">ffloorl_op</span>:<span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">oldrm</span> <span class="o">=</span> <span class="n">ieee754_csr</span><span class="p">.</span><span class="n">rm</span><span class="p">;</span>
			<span class="n">ieee754sp</span> <span class="n">fs</span><span class="p">;</span>

			<span class="n">SPFROMREG</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">MIPSInst_FS</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
			<span class="n">ieee754_csr</span><span class="p">.</span><span class="n">rm</span> <span class="o">=</span> <span class="n">ieee_rm</span><span class="p">[</span><span class="n">modeindex</span><span class="p">(</span><span class="n">MIPSInst_FUNC</span><span class="p">(</span><span class="n">ir</span><span class="p">))];</span>
			<span class="n">rv</span><span class="p">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">ieee754sp_tlong</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
			<span class="n">ieee754_csr</span><span class="p">.</span><span class="n">rm</span> <span class="o">=</span> <span class="n">oldrm</span><span class="p">;</span>
			<span class="n">rfmt</span> <span class="o">=</span> <span class="n">l_fmt</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">copcsr</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* defined(__mips64) */</span><span class="cp"></span>

		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">MIPSInst_FUNC</span><span class="p">(</span><span class="n">ir</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">fcmp_op</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="n">cmpop</span> <span class="o">=</span> <span class="n">MIPSInst_FUNC</span><span class="p">(</span><span class="n">ir</span><span class="p">)</span> <span class="o">-</span> <span class="n">fcmp_op</span><span class="p">;</span>
				<span class="n">ieee754sp</span> <span class="n">fs</span><span class="p">,</span> <span class="n">ft</span><span class="p">;</span>

				<span class="n">SPFROMREG</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">MIPSInst_FS</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
				<span class="n">SPFROMREG</span><span class="p">(</span><span class="n">ft</span><span class="p">,</span> <span class="n">MIPSInst_FT</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
				<span class="n">rv</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">ieee754sp_cmp</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">ft</span><span class="p">,</span>
					<span class="n">cmptab</span><span class="p">[</span><span class="n">cmpop</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">],</span> <span class="n">cmpop</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="p">);</span>
				<span class="n">rfmt</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">cmpop</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ieee754_cxtest</span>
					<span class="p">(</span><span class="n">IEEE754_INVALID_OPERATION</span><span class="p">))</span>
					<span class="n">rcsr</span> <span class="o">=</span> <span class="n">FPU_CSR_INV_X</span> <span class="o">|</span> <span class="n">FPU_CSR_INV_S</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="k">goto</span> <span class="n">copcsr</span><span class="p">;</span>

			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="k">return</span> <span class="n">SIGILL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">d_fmt</span>:<span class="p">{</span>
		<span class="k">union</span> <span class="p">{</span>
			<span class="n">ieee754dp</span><span class="p">(</span><span class="o">*</span><span class="n">b</span><span class="p">)</span> <span class="p">(</span><span class="n">ieee754dp</span><span class="p">,</span> <span class="n">ieee754dp</span><span class="p">);</span>
			<span class="n">ieee754dp</span><span class="p">(</span><span class="o">*</span><span class="n">u</span><span class="p">)</span> <span class="p">(</span><span class="n">ieee754dp</span><span class="p">);</span>
		<span class="p">}</span> <span class="n">handler</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">MIPSInst_FUNC</span><span class="p">(</span><span class="n">ir</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* binary ops */</span>
		<span class="k">case</span> <span class="n">fadd_op</span>:
			<span class="n">handler</span><span class="p">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">ieee754dp_add</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">dcopbop</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">fsub_op</span>:
			<span class="n">handler</span><span class="p">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">ieee754dp_sub</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">dcopbop</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">fmul_op</span>:
			<span class="n">handler</span><span class="p">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">ieee754dp_mul</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">dcopbop</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">fdiv_op</span>:
			<span class="n">handler</span><span class="p">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">ieee754dp_div</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">dcopbop</span><span class="p">;</span>

			<span class="cm">/* unary  ops */</span>
<span class="cp">#if __mips &gt;= 2 || defined(__mips64)</span>
		<span class="k">case</span> <span class="n">fsqrt_op</span>:
			<span class="n">handler</span><span class="p">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">ieee754dp_sqrt</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">dcopuop</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if __mips &gt;= 4 &amp;&amp; __mips != 32</span>
		<span class="k">case</span> <span class="n">frsqrt_op</span>:
			<span class="n">handler</span><span class="p">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">fpemu_dp_rsqrt</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">dcopuop</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">frecip_op</span>:
			<span class="n">handler</span><span class="p">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">fpemu_dp_recip</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">dcopuop</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if __mips &gt;= 4</span>
		<span class="k">case</span> <span class="n">fmovc_op</span>:
			<span class="n">cond</span> <span class="o">=</span> <span class="n">fpucondbit</span><span class="p">[</span><span class="n">MIPSInst_FT</span><span class="p">(</span><span class="n">ir</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcr31</span> <span class="o">&amp;</span> <span class="n">cond</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span>
				<span class="p">((</span><span class="n">MIPSInst_FT</span><span class="p">(</span><span class="n">ir</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">DPFROMREG</span><span class="p">(</span><span class="n">rv</span><span class="p">.</span><span class="n">d</span><span class="p">,</span> <span class="n">MIPSInst_FS</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">fmovz_op</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">xcp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">MIPSInst_FT</span><span class="p">(</span><span class="n">ir</span><span class="p">)]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">DPFROMREG</span><span class="p">(</span><span class="n">rv</span><span class="p">.</span><span class="n">d</span><span class="p">,</span> <span class="n">MIPSInst_FS</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">fmovn_op</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">xcp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">MIPSInst_FT</span><span class="p">(</span><span class="n">ir</span><span class="p">)]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">DPFROMREG</span><span class="p">(</span><span class="n">rv</span><span class="p">.</span><span class="n">d</span><span class="p">,</span> <span class="n">MIPSInst_FS</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">case</span> <span class="n">fabs_op</span>:
			<span class="n">handler</span><span class="p">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">ieee754dp_abs</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">dcopuop</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">fneg_op</span>:
			<span class="n">handler</span><span class="p">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">ieee754dp_neg</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">dcopuop</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">fmov_op</span>:
			<span class="cm">/* an easy one */</span>
			<span class="n">DPFROMREG</span><span class="p">(</span><span class="n">rv</span><span class="p">.</span><span class="n">d</span><span class="p">,</span> <span class="n">MIPSInst_FS</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">copcsr</span><span class="p">;</span>

			<span class="cm">/* binary op on handler */</span>
		      <span class="nl">dcopbop:</span><span class="p">{</span>
				<span class="n">ieee754dp</span> <span class="n">fs</span><span class="p">,</span> <span class="n">ft</span><span class="p">;</span>

				<span class="n">DPFROMREG</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">MIPSInst_FS</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
				<span class="n">DPFROMREG</span><span class="p">(</span><span class="n">ft</span><span class="p">,</span> <span class="n">MIPSInst_FT</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>

				<span class="n">rv</span><span class="p">.</span><span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">.</span><span class="n">b</span><span class="p">)</span> <span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">ft</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">copcsr</span><span class="p">;</span>
			<span class="p">}</span>
		      <span class="nl">dcopuop:</span><span class="p">{</span>
				<span class="n">ieee754dp</span> <span class="n">fs</span><span class="p">;</span>

				<span class="n">DPFROMREG</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">MIPSInst_FS</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
				<span class="n">rv</span><span class="p">.</span><span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">.</span><span class="n">u</span><span class="p">)</span> <span class="p">(</span><span class="n">fs</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">copcsr</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* unary conv ops */</span>
		<span class="k">case</span> <span class="n">fcvts_op</span>:<span class="p">{</span>
			<span class="n">ieee754dp</span> <span class="n">fs</span><span class="p">;</span>

			<span class="n">DPFROMREG</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">MIPSInst_FS</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
			<span class="n">rv</span><span class="p">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">ieee754sp_fdp</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
			<span class="n">rfmt</span> <span class="o">=</span> <span class="n">s_fmt</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">copcsr</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">fcvtd_op</span>:
			<span class="k">return</span> <span class="n">SIGILL</span><span class="p">;</span>	<span class="cm">/* not defined */</span>

		<span class="k">case</span> <span class="n">fcvtw_op</span>:<span class="p">{</span>
			<span class="n">ieee754dp</span> <span class="n">fs</span><span class="p">;</span>

			<span class="n">DPFROMREG</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">MIPSInst_FS</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
			<span class="n">rv</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">ieee754dp_tint</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>	<span class="cm">/* wrong */</span>
			<span class="n">rfmt</span> <span class="o">=</span> <span class="n">w_fmt</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">copcsr</span><span class="p">;</span>
		<span class="p">}</span>

<span class="cp">#if __mips &gt;= 2 || defined(__mips64)</span>
		<span class="k">case</span> <span class="n">fround_op</span>:
		<span class="k">case</span> <span class="n">ftrunc_op</span>:
		<span class="k">case</span> <span class="n">fceil_op</span>:
		<span class="k">case</span> <span class="n">ffloor_op</span>:<span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">oldrm</span> <span class="o">=</span> <span class="n">ieee754_csr</span><span class="p">.</span><span class="n">rm</span><span class="p">;</span>
			<span class="n">ieee754dp</span> <span class="n">fs</span><span class="p">;</span>

			<span class="n">DPFROMREG</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">MIPSInst_FS</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
			<span class="n">ieee754_csr</span><span class="p">.</span><span class="n">rm</span> <span class="o">=</span> <span class="n">ieee_rm</span><span class="p">[</span><span class="n">modeindex</span><span class="p">(</span><span class="n">MIPSInst_FUNC</span><span class="p">(</span><span class="n">ir</span><span class="p">))];</span>
			<span class="n">rv</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">ieee754dp_tint</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
			<span class="n">ieee754_csr</span><span class="p">.</span><span class="n">rm</span> <span class="o">=</span> <span class="n">oldrm</span><span class="p">;</span>
			<span class="n">rfmt</span> <span class="o">=</span> <span class="n">w_fmt</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">copcsr</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(__mips64)</span>
		<span class="k">case</span> <span class="n">fcvtl_op</span>:<span class="p">{</span>
			<span class="n">ieee754dp</span> <span class="n">fs</span><span class="p">;</span>

			<span class="n">DPFROMREG</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">MIPSInst_FS</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
			<span class="n">rv</span><span class="p">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">ieee754dp_tlong</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
			<span class="n">rfmt</span> <span class="o">=</span> <span class="n">l_fmt</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">copcsr</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">case</span> <span class="n">froundl_op</span>:
		<span class="k">case</span> <span class="n">ftruncl_op</span>:
		<span class="k">case</span> <span class="n">fceill_op</span>:
		<span class="k">case</span> <span class="n">ffloorl_op</span>:<span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">oldrm</span> <span class="o">=</span> <span class="n">ieee754_csr</span><span class="p">.</span><span class="n">rm</span><span class="p">;</span>
			<span class="n">ieee754dp</span> <span class="n">fs</span><span class="p">;</span>

			<span class="n">DPFROMREG</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">MIPSInst_FS</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
			<span class="n">ieee754_csr</span><span class="p">.</span><span class="n">rm</span> <span class="o">=</span> <span class="n">ieee_rm</span><span class="p">[</span><span class="n">modeindex</span><span class="p">(</span><span class="n">MIPSInst_FUNC</span><span class="p">(</span><span class="n">ir</span><span class="p">))];</span>
			<span class="n">rv</span><span class="p">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">ieee754dp_tlong</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
			<span class="n">ieee754_csr</span><span class="p">.</span><span class="n">rm</span> <span class="o">=</span> <span class="n">oldrm</span><span class="p">;</span>
			<span class="n">rfmt</span> <span class="o">=</span> <span class="n">l_fmt</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">copcsr</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* __mips &gt;= 3 */</span><span class="cp"></span>

		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">MIPSInst_FUNC</span><span class="p">(</span><span class="n">ir</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">fcmp_op</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="n">cmpop</span> <span class="o">=</span> <span class="n">MIPSInst_FUNC</span><span class="p">(</span><span class="n">ir</span><span class="p">)</span> <span class="o">-</span> <span class="n">fcmp_op</span><span class="p">;</span>
				<span class="n">ieee754dp</span> <span class="n">fs</span><span class="p">,</span> <span class="n">ft</span><span class="p">;</span>

				<span class="n">DPFROMREG</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">MIPSInst_FS</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
				<span class="n">DPFROMREG</span><span class="p">(</span><span class="n">ft</span><span class="p">,</span> <span class="n">MIPSInst_FT</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
				<span class="n">rv</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">ieee754dp_cmp</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">ft</span><span class="p">,</span>
					<span class="n">cmptab</span><span class="p">[</span><span class="n">cmpop</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">],</span> <span class="n">cmpop</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="p">);</span>
				<span class="n">rfmt</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">cmpop</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="p">)</span>
					<span class="o">&amp;&amp;</span>
					<span class="n">ieee754_cxtest</span>
					<span class="p">(</span><span class="n">IEEE754_INVALID_OPERATION</span><span class="p">))</span>
					<span class="n">rcsr</span> <span class="o">=</span> <span class="n">FPU_CSR_INV_X</span> <span class="o">|</span> <span class="n">FPU_CSR_INV_S</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="k">goto</span> <span class="n">copcsr</span><span class="p">;</span>

			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="k">return</span> <span class="n">SIGILL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">w_fmt</span>:<span class="p">{</span>
		<span class="n">ieee754sp</span> <span class="n">fs</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">MIPSInst_FUNC</span><span class="p">(</span><span class="n">ir</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">fcvts_op</span>:
			<span class="cm">/* convert word to single precision real */</span>
			<span class="n">SPFROMREG</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">MIPSInst_FS</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
			<span class="n">rv</span><span class="p">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">ieee754sp_fint</span><span class="p">(</span><span class="n">fs</span><span class="p">.</span><span class="n">bits</span><span class="p">);</span>
			<span class="n">rfmt</span> <span class="o">=</span> <span class="n">s_fmt</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">copcsr</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">fcvtd_op</span>:
			<span class="cm">/* convert word to double precision real */</span>
			<span class="n">SPFROMREG</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">MIPSInst_FS</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
			<span class="n">rv</span><span class="p">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">ieee754dp_fint</span><span class="p">(</span><span class="n">fs</span><span class="p">.</span><span class="n">bits</span><span class="p">);</span>
			<span class="n">rfmt</span> <span class="o">=</span> <span class="n">d_fmt</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">copcsr</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="n">SIGILL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if defined(__mips64)</span>
	<span class="k">case</span> <span class="n">l_fmt</span>:<span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">MIPSInst_FUNC</span><span class="p">(</span><span class="n">ir</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">fcvts_op</span>:
			<span class="cm">/* convert long to single precision real */</span>
			<span class="n">rv</span><span class="p">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">ieee754sp_flong</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fpr</span><span class="p">[</span><span class="n">MIPSInst_FS</span><span class="p">(</span><span class="n">ir</span><span class="p">)]);</span>
			<span class="n">rfmt</span> <span class="o">=</span> <span class="n">s_fmt</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">copcsr</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">fcvtd_op</span>:
			<span class="cm">/* convert long to double precision real */</span>
			<span class="n">rv</span><span class="p">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">ieee754dp_flong</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fpr</span><span class="p">[</span><span class="n">MIPSInst_FS</span><span class="p">(</span><span class="n">ir</span><span class="p">)]);</span>
			<span class="n">rfmt</span> <span class="o">=</span> <span class="n">d_fmt</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">copcsr</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="n">SIGILL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">SIGILL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update the fpu CSR register for this operation.</span>
<span class="cm">	 * If an exception is required, generate a tidy SIGFPE exception,</span>
<span class="cm">	 * without updating the result register.</span>
<span class="cm">	 * Note: cause exception bits do not accumulate, they are rewritten</span>
<span class="cm">	 * for each op; only the flag/sticky bits accumulate.</span>
<span class="cm">	 */</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcr31</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcr31</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FPU_CSR_ALL_X</span><span class="p">)</span> <span class="o">|</span> <span class="n">rcsr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcr31</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcr31</span> <span class="o">&amp;</span> <span class="n">FPU_CSR_ALL_E</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*printk (&quot;SIGFPE: fpu csr = %08x\n&quot;,ctx-&gt;fcr31); */</span>
		<span class="k">return</span> <span class="n">SIGFPE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now we can safely write the result back to the register file.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rfmt</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">-</span><span class="mi">1</span>:<span class="p">{</span>
<span class="cp">#if __mips &gt;= 4</span>
		<span class="n">cond</span> <span class="o">=</span> <span class="n">fpucondbit</span><span class="p">[</span><span class="n">MIPSInst_FD</span><span class="p">(</span><span class="n">ir</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">];</span>
<span class="cp">#else</span>
		<span class="n">cond</span> <span class="o">=</span> <span class="n">FPU_CSR_COND</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">.</span><span class="n">w</span><span class="p">)</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcr31</span> <span class="o">|=</span> <span class="n">cond</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcr31</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">cond</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">d_fmt</span>:
		<span class="n">DPTOREG</span><span class="p">(</span><span class="n">rv</span><span class="p">.</span><span class="n">d</span><span class="p">,</span> <span class="n">MIPSInst_FD</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">s_fmt</span>:
		<span class="n">SPTOREG</span><span class="p">(</span><span class="n">rv</span><span class="p">.</span><span class="n">s</span><span class="p">,</span> <span class="n">MIPSInst_FD</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">w_fmt</span>:
		<span class="n">SITOREG</span><span class="p">(</span><span class="n">rv</span><span class="p">.</span><span class="n">w</span><span class="p">,</span> <span class="n">MIPSInst_FD</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#if defined(__mips64)</span>
	<span class="k">case</span> <span class="n">l_fmt</span>:
		<span class="n">DITOREG</span><span class="p">(</span><span class="n">rv</span><span class="p">.</span><span class="n">l</span><span class="p">,</span> <span class="n">MIPSInst_FD</span><span class="p">(</span><span class="n">ir</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">SIGILL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">fpu_emulator_cop1Handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">xcp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mips_fpu_struct</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">has_fpu</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__user</span> <span class="o">*</span><span class="n">fault_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">oldepc</span><span class="p">,</span> <span class="n">prevepc</span><span class="p">;</span>
	<span class="n">mips_instruction</span> <span class="n">insn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sig</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">oldepc</span> <span class="o">=</span> <span class="n">xcp</span><span class="o">-&gt;</span><span class="n">cp0_epc</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">prevepc</span> <span class="o">=</span> <span class="n">xcp</span><span class="o">-&gt;</span><span class="n">cp0_epc</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">xcp</span><span class="o">-&gt;</span><span class="n">cp0_epc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mips_instruction</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">MIPS_FPU_EMU_INC_STATS</span><span class="p">(</span><span class="n">errors</span><span class="p">);</span>
			<span class="o">*</span><span class="n">fault_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">mips_instruction</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">xcp</span><span class="o">-&gt;</span><span class="n">cp0_epc</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">SIGBUS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__get_user</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="p">(</span><span class="n">mips_instruction</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">xcp</span><span class="o">-&gt;</span><span class="n">cp0_epc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">MIPS_FPU_EMU_INC_STATS</span><span class="p">(</span><span class="n">errors</span><span class="p">);</span>
			<span class="o">*</span><span class="n">fault_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">mips_instruction</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">xcp</span><span class="o">-&gt;</span><span class="n">cp0_epc</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">SIGSEGV</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">insn</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">xcp</span><span class="o">-&gt;</span><span class="n">cp0_epc</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* skip nops */</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * The &#39;ieee754_csr&#39; is an alias of</span>
<span class="cm">			 * ctx-&gt;fcr31.  No need to copy ctx-&gt;fcr31 to</span>
<span class="cm">			 * ieee754_csr.  But ieee754_csr.rm is ieee</span>
<span class="cm">			 * library modes. (not mips rounding mode)</span>
<span class="cm">			 */</span>
			<span class="cm">/* convert to ieee library modes */</span>
			<span class="n">ieee754_csr</span><span class="p">.</span><span class="n">rm</span> <span class="o">=</span> <span class="n">ieee_rm</span><span class="p">[</span><span class="n">ieee754_csr</span><span class="p">.</span><span class="n">rm</span><span class="p">];</span>
			<span class="n">sig</span> <span class="o">=</span> <span class="n">cop1Emulate</span><span class="p">(</span><span class="n">xcp</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">fault_addr</span><span class="p">);</span>
			<span class="cm">/* revert to mips rounding mode */</span>
			<span class="n">ieee754_csr</span><span class="p">.</span><span class="n">rm</span> <span class="o">=</span> <span class="n">mips_rm</span><span class="p">[</span><span class="n">ieee754_csr</span><span class="p">.</span><span class="n">rm</span><span class="p">];</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">has_fpu</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sig</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">cond_resched</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">xcp</span><span class="o">-&gt;</span><span class="n">cp0_epc</span> <span class="o">&gt;</span> <span class="n">prevepc</span><span class="p">);</span>

	<span class="cm">/* SIGILL indicates a non-fpu instruction */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sig</span> <span class="o">==</span> <span class="n">SIGILL</span> <span class="o">&amp;&amp;</span> <span class="n">xcp</span><span class="o">-&gt;</span><span class="n">cp0_epc</span> <span class="o">!=</span> <span class="n">oldepc</span><span class="p">)</span>
		<span class="cm">/* but if epc has advanced, then ignore it */</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sig</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_DEBUG_FS</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fpuemu_stat_get</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">for_each_online_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mips_fpu_emulator_stats</span> <span class="o">*</span><span class="n">ps</span><span class="p">;</span>
		<span class="n">local_t</span> <span class="o">*</span><span class="n">pv</span><span class="p">;</span>
		<span class="n">ps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">fpuemustats</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
		<span class="n">pv</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ps</span> <span class="o">+</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="n">local_read</span><span class="p">(</span><span class="n">pv</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">sum</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">DEFINE_SIMPLE_ATTRIBUTE</span><span class="p">(</span><span class="n">fops_fpuemu_stat</span><span class="p">,</span> <span class="n">fpuemu_stat_get</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">mips_debugfs_dir</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">debugfs_fpuemu</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="o">*</span><span class="n">dir</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mips_debugfs_dir</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">dir</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="s">&quot;fpuemustats&quot;</span><span class="p">,</span> <span class="n">mips_debugfs_dir</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dir</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

<span class="cp">#define FPU_STAT_CREATE(M)						\</span>
<span class="cp">	do {								\</span>
<span class="cp">		d = debugfs_create_file(#M , S_IRUGO, dir,		\</span>
<span class="cp">			(void *)offsetof(struct mips_fpu_emulator_stats, M), \</span>
<span class="cp">			&amp;fops_fpuemu_stat);				\</span>
<span class="cp">		if (!d)							\</span>
<span class="cp">			return -ENOMEM;					\</span>
<span class="cp">	} while (0)</span>

	<span class="n">FPU_STAT_CREATE</span><span class="p">(</span><span class="n">emulated</span><span class="p">);</span>
	<span class="n">FPU_STAT_CREATE</span><span class="p">(</span><span class="n">loads</span><span class="p">);</span>
	<span class="n">FPU_STAT_CREATE</span><span class="p">(</span><span class="n">stores</span><span class="p">);</span>
	<span class="n">FPU_STAT_CREATE</span><span class="p">(</span><span class="n">cp1ops</span><span class="p">);</span>
	<span class="n">FPU_STAT_CREATE</span><span class="p">(</span><span class="n">cp1xops</span><span class="p">);</span>
	<span class="n">FPU_STAT_CREATE</span><span class="p">(</span><span class="n">errors</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">__initcall</span><span class="p">(</span><span class="n">debugfs_fpuemu</span><span class="p">);</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
