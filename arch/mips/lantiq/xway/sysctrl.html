<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › mips › lantiq › xway › sysctrl.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>sysctrl.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> *  under the terms of the GNU General Public License version 2 as published</span>
<span class="cm"> *  by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2011-2012 John Crispin &lt;blogic@openwrt.org&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/clkdev.h&gt;</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>
<span class="cp">#include &lt;linux/of_platform.h&gt;</span>
<span class="cp">#include &lt;linux/of_address.h&gt;</span>

<span class="cp">#include &lt;lantiq_soc.h&gt;</span>

<span class="cp">#include &quot;../clk.h&quot;</span>
<span class="cp">#include &quot;../prom.h&quot;</span>

<span class="cm">/* clock control register */</span>
<span class="cp">#define CGU_IFCCR	0x0018</span>
<span class="cm">/* system clock register */</span>
<span class="cp">#define CGU_SYS		0x0010</span>
<span class="cm">/* pci control register */</span>
<span class="cp">#define CGU_PCICR	0x0034</span>
<span class="cm">/* ephy configuration register */</span>
<span class="cp">#define CGU_EPHY	0x10</span>
<span class="cm">/* power control register */</span>
<span class="cp">#define PMU_PWDCR	0x1C</span>
<span class="cm">/* power status register */</span>
<span class="cp">#define PMU_PWDSR	0x20</span>
<span class="cm">/* power control register */</span>
<span class="cp">#define PMU_PWDCR1	0x24</span>
<span class="cm">/* power status register */</span>
<span class="cp">#define PMU_PWDSR1	0x28</span>
<span class="cm">/* power control register */</span>
<span class="cp">#define PWDCR(x) ((x) ? (PMU_PWDCR1) : (PMU_PWDCR))</span>
<span class="cm">/* power status register */</span>
<span class="cp">#define PWDSR(x) ((x) ? (PMU_PWDSR1) : (PMU_PWDSR))</span>

<span class="cm">/* clock gates that we can en/disable */</span>
<span class="cp">#define PMU_USB0_P	BIT(0)</span>
<span class="cp">#define PMU_PCI		BIT(4)</span>
<span class="cp">#define PMU_DMA		BIT(5)</span>
<span class="cp">#define PMU_USB0	BIT(6)</span>
<span class="cp">#define PMU_ASC0	BIT(7)</span>
<span class="cp">#define PMU_EPHY	BIT(7)	</span><span class="cm">/* ase */</span><span class="cp"></span>
<span class="cp">#define PMU_SPI		BIT(8)</span>
<span class="cp">#define PMU_DFE		BIT(9)</span>
<span class="cp">#define PMU_EBU		BIT(10)</span>
<span class="cp">#define PMU_STP		BIT(11)</span>
<span class="cp">#define PMU_GPT		BIT(12)</span>
<span class="cp">#define PMU_AHBS	BIT(13) </span><span class="cm">/* vr9 */</span><span class="cp"></span>
<span class="cp">#define PMU_FPI		BIT(14)</span>
<span class="cp">#define PMU_AHBM	BIT(15)</span>
<span class="cp">#define PMU_ASC1	BIT(17)</span>
<span class="cp">#define PMU_PPE_QSB	BIT(18)</span>
<span class="cp">#define PMU_PPE_SLL01	BIT(19)</span>
<span class="cp">#define PMU_PPE_TC	BIT(21)</span>
<span class="cp">#define PMU_PPE_EMA	BIT(22)</span>
<span class="cp">#define PMU_PPE_DPLUM	BIT(23)</span>
<span class="cp">#define PMU_PPE_DPLUS	BIT(24)</span>
<span class="cp">#define PMU_USB1_P	BIT(26)</span>
<span class="cp">#define PMU_USB1	BIT(27)</span>
<span class="cp">#define PMU_SWITCH	BIT(28)</span>
<span class="cp">#define PMU_PPE_TOP	BIT(29)</span>
<span class="cp">#define PMU_GPHY	BIT(30)</span>
<span class="cp">#define PMU_PCIE_CLK	BIT(31)</span>

<span class="cp">#define PMU1_PCIE_PHY	BIT(0)</span>
<span class="cp">#define PMU1_PCIE_CTL	BIT(1)</span>
<span class="cp">#define PMU1_PCIE_PDI	BIT(4)</span>
<span class="cp">#define PMU1_PCIE_MSI	BIT(5)</span>

<span class="cp">#define pmu_w32(x, y)	ltq_w32((x), pmu_membase + (y))</span>
<span class="cp">#define pmu_r32(x)	ltq_r32(pmu_membase + (x))</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pmu_membase</span><span class="p">;</span>
<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ltq_cgu_membase</span><span class="p">;</span>
<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ltq_ebu_membase</span><span class="p">;</span>

<span class="cm">/* legacy function kept alive to ease clkdev transition */</span>
<span class="kt">void</span> <span class="nf">ltq_pmu_enable</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">module</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">1000000</span><span class="p">;</span>

	<span class="n">pmu_w32</span><span class="p">(</span><span class="n">pmu_r32</span><span class="p">(</span><span class="n">PMU_PWDCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">module</span><span class="p">,</span> <span class="n">PMU_PWDCR</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pmu_r32</span><span class="p">(</span><span class="n">PMU_PWDSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">module</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;activating PMU module failed!&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ltq_pmu_enable</span><span class="p">);</span>

<span class="cm">/* legacy function kept alive to ease clkdev transition */</span>
<span class="kt">void</span> <span class="nf">ltq_pmu_disable</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">module</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pmu_w32</span><span class="p">(</span><span class="n">pmu_r32</span><span class="p">(</span><span class="n">PMU_PWDCR</span><span class="p">)</span> <span class="o">|</span> <span class="n">module</span><span class="p">,</span> <span class="n">PMU_PWDCR</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ltq_pmu_disable</span><span class="p">);</span>

<span class="cm">/* enable a hw clock */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cgu_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ltq_cgu_w32</span><span class="p">(</span><span class="n">ltq_cgu_r32</span><span class="p">(</span><span class="n">CGU_IFCCR</span><span class="p">)</span> <span class="o">|</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">bits</span><span class="p">,</span> <span class="n">CGU_IFCCR</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* disable a hw clock */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cgu_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ltq_cgu_w32</span><span class="p">(</span><span class="n">ltq_cgu_r32</span><span class="p">(</span><span class="n">CGU_IFCCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">bits</span><span class="p">,</span> <span class="n">CGU_IFCCR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* enable a clock gate */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmu_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retry</span> <span class="o">=</span> <span class="mi">1000000</span><span class="p">;</span>

	<span class="n">pmu_w32</span><span class="p">(</span><span class="n">pmu_r32</span><span class="p">(</span><span class="n">PWDCR</span><span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">bits</span><span class="p">,</span>
		<span class="n">PWDCR</span><span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">));</span>
	<span class="k">do</span> <span class="p">{}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">retry</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pmu_r32</span><span class="p">(</span><span class="n">PWDSR</span><span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">bits</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retry</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;activating PMU module failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* disable a clock gate */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pmu_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pmu_w32</span><span class="p">(</span><span class="n">pmu_r32</span><span class="p">(</span><span class="n">PWDCR</span><span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">))</span> <span class="o">|</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">bits</span><span class="p">,</span>
		<span class="n">PWDCR</span><span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* the pci enable helper */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ifccr</span> <span class="o">=</span> <span class="n">ltq_cgu_r32</span><span class="p">(</span><span class="n">CGU_IFCCR</span><span class="p">);</span>
	<span class="cm">/* set bus clock speed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;lantiq,ar9&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ifccr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x1f00000</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">==</span> <span class="n">CLOCK_33M</span><span class="p">)</span>
			<span class="n">ifccr</span> <span class="o">|=</span> <span class="mh">0xe00000</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ifccr</span> <span class="o">|=</span> <span class="mh">0x700000</span><span class="p">;</span> <span class="cm">/* 62.5M */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ifccr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xf00000</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">==</span> <span class="n">CLOCK_33M</span><span class="p">)</span>
			<span class="n">ifccr</span> <span class="o">|=</span> <span class="mh">0x800000</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ifccr</span> <span class="o">|=</span> <span class="mh">0x400000</span><span class="p">;</span> <span class="cm">/* 62.5M */</span>
	<span class="p">}</span>
	<span class="n">ltq_cgu_w32</span><span class="p">(</span><span class="n">ifccr</span><span class="p">,</span> <span class="n">CGU_IFCCR</span><span class="p">);</span>
	<span class="n">pmu_enable</span><span class="p">(</span><span class="n">clk</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* enable the external clock as a source */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pci_ext_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ltq_cgu_w32</span><span class="p">(</span><span class="n">ltq_cgu_r32</span><span class="p">(</span><span class="n">CGU_IFCCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">),</span>
		<span class="n">CGU_IFCCR</span><span class="p">);</span>
	<span class="n">ltq_cgu_w32</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">),</span> <span class="n">CGU_PCICR</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* disable the external clock as a source */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci_ext_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ltq_cgu_w32</span><span class="p">(</span><span class="n">ltq_cgu_r32</span><span class="p">(</span><span class="n">CGU_IFCCR</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">),</span>
		<span class="n">CGU_IFCCR</span><span class="p">);</span>
	<span class="n">ltq_cgu_w32</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">),</span> <span class="n">CGU_PCICR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* enable a clockout source */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">clkout_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* get the correct rate */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="mi">14</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">);</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ifccr</span> <span class="o">=</span> <span class="n">ltq_cgu_r32</span><span class="p">(</span><span class="n">CGU_IFCCR</span><span class="p">);</span>

			<span class="n">ifccr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>
			<span class="n">ifccr</span> <span class="o">|=</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>
			<span class="n">ltq_cgu_w32</span><span class="p">(</span><span class="n">ifccr</span><span class="p">,</span> <span class="n">CGU_IFCCR</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* manage the clock gates via PMU */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">clkdev_add_pmu</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">con</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">module</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="n">clk</span><span class="o">-&gt;</span><span class="n">cl</span><span class="p">.</span><span class="n">dev_id</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">clk</span><span class="o">-&gt;</span><span class="n">cl</span><span class="p">.</span><span class="n">con_id</span> <span class="o">=</span> <span class="n">con</span><span class="p">;</span>
	<span class="n">clk</span><span class="o">-&gt;</span><span class="n">cl</span><span class="p">.</span><span class="n">clk</span> <span class="o">=</span> <span class="n">clk</span><span class="p">;</span>
	<span class="n">clk</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">=</span> <span class="n">pmu_enable</span><span class="p">;</span>
	<span class="n">clk</span><span class="o">-&gt;</span><span class="n">disable</span> <span class="o">=</span> <span class="n">pmu_disable</span><span class="p">;</span>
	<span class="n">clk</span><span class="o">-&gt;</span><span class="n">module</span> <span class="o">=</span> <span class="n">module</span><span class="p">;</span>
	<span class="n">clk</span><span class="o">-&gt;</span><span class="n">bits</span> <span class="o">=</span> <span class="n">bits</span><span class="p">;</span>
	<span class="n">clkdev_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">cl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* manage the clock generator */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">clkdev_add_cgu</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">con</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="n">clk</span><span class="o">-&gt;</span><span class="n">cl</span><span class="p">.</span><span class="n">dev_id</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">clk</span><span class="o">-&gt;</span><span class="n">cl</span><span class="p">.</span><span class="n">con_id</span> <span class="o">=</span> <span class="n">con</span><span class="p">;</span>
	<span class="n">clk</span><span class="o">-&gt;</span><span class="n">cl</span><span class="p">.</span><span class="n">clk</span> <span class="o">=</span> <span class="n">clk</span><span class="p">;</span>
	<span class="n">clk</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">=</span> <span class="n">cgu_enable</span><span class="p">;</span>
	<span class="n">clk</span><span class="o">-&gt;</span><span class="n">disable</span> <span class="o">=</span> <span class="n">cgu_disable</span><span class="p">;</span>
	<span class="n">clk</span><span class="o">-&gt;</span><span class="n">bits</span> <span class="o">=</span> <span class="n">bits</span><span class="p">;</span>
	<span class="n">clkdev_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">cl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* pci needs its own enable function as the setup is a bit more complex */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">valid_pci_rates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">CLOCK_33M</span><span class="p">,</span> <span class="n">CLOCK_62_5M</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">clkdev_add_pci</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk_ext</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="cm">/* main pci clock */</span>
	<span class="n">clk</span><span class="o">-&gt;</span><span class="n">cl</span><span class="p">.</span><span class="n">dev_id</span> <span class="o">=</span> <span class="s">&quot;17000000.pci&quot;</span><span class="p">;</span>
	<span class="n">clk</span><span class="o">-&gt;</span><span class="n">cl</span><span class="p">.</span><span class="n">con_id</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">clk</span><span class="o">-&gt;</span><span class="n">cl</span><span class="p">.</span><span class="n">clk</span> <span class="o">=</span> <span class="n">clk</span><span class="p">;</span>
	<span class="n">clk</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="n">CLOCK_33M</span><span class="p">;</span>
	<span class="n">clk</span><span class="o">-&gt;</span><span class="n">rates</span> <span class="o">=</span> <span class="n">valid_pci_rates</span><span class="p">;</span>
	<span class="n">clk</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">=</span> <span class="n">pci_enable</span><span class="p">;</span>
	<span class="n">clk</span><span class="o">-&gt;</span><span class="n">disable</span> <span class="o">=</span> <span class="n">pmu_disable</span><span class="p">;</span>
	<span class="n">clk</span><span class="o">-&gt;</span><span class="n">module</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clk</span><span class="o">-&gt;</span><span class="n">bits</span> <span class="o">=</span> <span class="n">PMU_PCI</span><span class="p">;</span>
	<span class="n">clkdev_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">cl</span><span class="p">);</span>

	<span class="cm">/* use internal/external bus clock */</span>
	<span class="n">clk_ext</span><span class="o">-&gt;</span><span class="n">cl</span><span class="p">.</span><span class="n">dev_id</span> <span class="o">=</span> <span class="s">&quot;17000000.pci&quot;</span><span class="p">;</span>
	<span class="n">clk_ext</span><span class="o">-&gt;</span><span class="n">cl</span><span class="p">.</span><span class="n">con_id</span> <span class="o">=</span> <span class="s">&quot;external&quot;</span><span class="p">;</span>
	<span class="n">clk_ext</span><span class="o">-&gt;</span><span class="n">cl</span><span class="p">.</span><span class="n">clk</span> <span class="o">=</span> <span class="n">clk_ext</span><span class="p">;</span>
	<span class="n">clk_ext</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">=</span> <span class="n">pci_ext_enable</span><span class="p">;</span>
	<span class="n">clk_ext</span><span class="o">-&gt;</span><span class="n">disable</span> <span class="o">=</span> <span class="n">pci_ext_disable</span><span class="p">;</span>
	<span class="n">clkdev_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clk_ext</span><span class="o">-&gt;</span><span class="n">cl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* xway socs can generate clocks on gpio pins */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">valid_clkout_rates</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">CLOCK_32_768K</span><span class="p">,</span> <span class="n">CLOCK_1_536M</span><span class="p">,</span> <span class="n">CLOCK_2_5M</span><span class="p">,</span> <span class="n">CLOCK_12M</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">CLOCK_40M</span><span class="p">,</span> <span class="n">CLOCK_12M</span><span class="p">,</span> <span class="n">CLOCK_24M</span><span class="p">,</span> <span class="n">CLOCK_48M</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">CLOCK_25M</span><span class="p">,</span> <span class="n">CLOCK_40M</span><span class="p">,</span> <span class="n">CLOCK_30M</span><span class="p">,</span> <span class="n">CLOCK_60M</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">CLOCK_12M</span><span class="p">,</span> <span class="n">CLOCK_50M</span><span class="p">,</span> <span class="n">CLOCK_32_768K</span><span class="p">,</span> <span class="n">CLOCK_25M</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">clkdev_add_clkout</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

		<span class="n">name</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="s">&quot;clkout0&quot;</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;clkout%d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="n">clk</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">clk</span><span class="o">-&gt;</span><span class="n">cl</span><span class="p">.</span><span class="n">dev_id</span> <span class="o">=</span> <span class="s">&quot;1f103000.cgu&quot;</span><span class="p">;</span>
		<span class="n">clk</span><span class="o">-&gt;</span><span class="n">cl</span><span class="p">.</span><span class="n">con_id</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
		<span class="n">clk</span><span class="o">-&gt;</span><span class="n">cl</span><span class="p">.</span><span class="n">clk</span> <span class="o">=</span> <span class="n">clk</span><span class="p">;</span>
		<span class="n">clk</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">clk</span><span class="o">-&gt;</span><span class="n">rates</span> <span class="o">=</span> <span class="n">valid_clkout_rates</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">clk</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">=</span> <span class="n">clkout_enable</span><span class="p">;</span>
		<span class="n">clk</span><span class="o">-&gt;</span><span class="n">module</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">clkdev_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">cl</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* bring up all register ranges that we need for basic system control */</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">ltq_soc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">res_pmu</span><span class="p">,</span> <span class="n">res_cgu</span><span class="p">,</span> <span class="n">res_ebu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np_pmu</span> <span class="o">=</span>
			<span class="n">of_find_compatible_node</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;lantiq,pmu-xway&quot;</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np_cgu</span> <span class="o">=</span>
			<span class="n">of_find_compatible_node</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;lantiq,cgu-xway&quot;</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np_ebu</span> <span class="o">=</span>
			<span class="n">of_find_compatible_node</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;lantiq,ebu-xway&quot;</span><span class="p">);</span>

	<span class="cm">/* check if all the core register ranges are available */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np_pmu</span> <span class="o">||</span> <span class="o">!</span><span class="n">np_cgu</span> <span class="o">||</span> <span class="o">!</span><span class="n">np_ebu</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Failed to load core nodess from devicetree&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">of_address_to_resource</span><span class="p">(</span><span class="n">np_pmu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res_pmu</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">of_address_to_resource</span><span class="p">(</span><span class="n">np_cgu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res_cgu</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">of_address_to_resource</span><span class="p">(</span><span class="n">np_ebu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res_ebu</span><span class="p">))</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Failed to get core resources&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">res_pmu</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res_pmu</span><span class="p">),</span>
				<span class="n">res_pmu</span><span class="p">.</span><span class="n">name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">res_cgu</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res_cgu</span><span class="p">),</span>
				<span class="n">res_cgu</span><span class="p">.</span><span class="n">name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">res_ebu</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res_ebu</span><span class="p">),</span>
				<span class="n">res_ebu</span><span class="p">.</span><span class="n">name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to request core reources&quot;</span><span class="p">);</span>

	<span class="n">pmu_membase</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">res_pmu</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res_pmu</span><span class="p">));</span>
	<span class="n">ltq_cgu_membase</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">res_cgu</span><span class="p">.</span><span class="n">start</span><span class="p">,</span>
						<span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res_cgu</span><span class="p">));</span>
	<span class="n">ltq_ebu_membase</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">res_ebu</span><span class="p">.</span><span class="n">start</span><span class="p">,</span>
						<span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res_ebu</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmu_membase</span> <span class="o">||</span> <span class="o">!</span><span class="n">ltq_cgu_membase</span> <span class="o">||</span> <span class="o">!</span><span class="n">ltq_ebu_membase</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Failed to remap core resources&quot;</span><span class="p">);</span>

	<span class="cm">/* make sure to unprotect the memory region where flash is located */</span>
	<span class="n">ltq_ebu_w32</span><span class="p">(</span><span class="n">ltq_ebu_r32</span><span class="p">(</span><span class="n">LTQ_EBU_BUSCON0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EBU_WRDIS</span><span class="p">,</span> <span class="n">LTQ_EBU_BUSCON0</span><span class="p">);</span>

	<span class="cm">/* add our generic xway clocks */</span>
	<span class="n">clkdev_add_pmu</span><span class="p">(</span><span class="s">&quot;10000000.fpi&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PMU_FPI</span><span class="p">);</span>
	<span class="n">clkdev_add_pmu</span><span class="p">(</span><span class="s">&quot;1e100400.serial&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PMU_ASC0</span><span class="p">);</span>
	<span class="n">clkdev_add_pmu</span><span class="p">(</span><span class="s">&quot;1e100a00.gptu&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PMU_GPT</span><span class="p">);</span>
	<span class="n">clkdev_add_pmu</span><span class="p">(</span><span class="s">&quot;1e100bb0.stp&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PMU_STP</span><span class="p">);</span>
	<span class="n">clkdev_add_pmu</span><span class="p">(</span><span class="s">&quot;1e104100.dma&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PMU_DMA</span><span class="p">);</span>
	<span class="n">clkdev_add_pmu</span><span class="p">(</span><span class="s">&quot;1e100800.spi&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PMU_SPI</span><span class="p">);</span>
	<span class="n">clkdev_add_pmu</span><span class="p">(</span><span class="s">&quot;1e105300.ebu&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PMU_EBU</span><span class="p">);</span>
	<span class="n">clkdev_add_clkout</span><span class="p">();</span>

	<span class="cm">/* add the soc dependent clocks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;lantiq,vr9&quot;</span><span class="p">))</span>
		<span class="n">clkdev_add_pmu</span><span class="p">(</span><span class="s">&quot;1e180000.etop&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PMU_PPE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;lantiq,ase&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">clkdev_add_pmu</span><span class="p">(</span><span class="s">&quot;1e100c00.serial&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PMU_ASC1</span><span class="p">);</span>
		<span class="n">clkdev_add_pci</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;lantiq,ase&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ltq_cgu_r32</span><span class="p">(</span><span class="n">CGU_SYS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">))</span>
			<span class="n">clkdev_add_static</span><span class="p">(</span><span class="n">CLOCK_266M</span><span class="p">,</span> <span class="n">CLOCK_133M</span><span class="p">,</span> <span class="n">CLOCK_133M</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">clkdev_add_static</span><span class="p">(</span><span class="n">CLOCK_133M</span><span class="p">,</span> <span class="n">CLOCK_133M</span><span class="p">,</span> <span class="n">CLOCK_133M</span><span class="p">);</span>
		<span class="n">clkdev_add_cgu</span><span class="p">(</span><span class="s">&quot;1e180000.etop&quot;</span><span class="p">,</span> <span class="s">&quot;ephycgu&quot;</span><span class="p">,</span> <span class="n">CGU_EPHY</span><span class="p">),</span>
		<span class="n">clkdev_add_pmu</span><span class="p">(</span><span class="s">&quot;1e180000.etop&quot;</span><span class="p">,</span> <span class="s">&quot;ephy&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PMU_EPHY</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;lantiq,vr9&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">clkdev_add_static</span><span class="p">(</span><span class="n">ltq_vr9_cpu_hz</span><span class="p">(),</span> <span class="n">ltq_vr9_fpi_hz</span><span class="p">(),</span>
				<span class="n">ltq_vr9_fpi_hz</span><span class="p">());</span>
		<span class="n">clkdev_add_pmu</span><span class="p">(</span><span class="s">&quot;1d900000.pcie&quot;</span><span class="p">,</span> <span class="s">&quot;phy&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PMU1_PCIE_PHY</span><span class="p">);</span>
		<span class="n">clkdev_add_pmu</span><span class="p">(</span><span class="s">&quot;1d900000.pcie&quot;</span><span class="p">,</span> <span class="s">&quot;bus&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PMU_PCIE_CLK</span><span class="p">);</span>
		<span class="n">clkdev_add_pmu</span><span class="p">(</span><span class="s">&quot;1d900000.pcie&quot;</span><span class="p">,</span> <span class="s">&quot;msi&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PMU1_PCIE_MSI</span><span class="p">);</span>
		<span class="n">clkdev_add_pmu</span><span class="p">(</span><span class="s">&quot;1d900000.pcie&quot;</span><span class="p">,</span> <span class="s">&quot;pdi&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PMU1_PCIE_PDI</span><span class="p">);</span>
		<span class="n">clkdev_add_pmu</span><span class="p">(</span><span class="s">&quot;1d900000.pcie&quot;</span><span class="p">,</span> <span class="s">&quot;ctl&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PMU1_PCIE_CTL</span><span class="p">);</span>
		<span class="n">clkdev_add_pmu</span><span class="p">(</span><span class="s">&quot;1d900000.pcie&quot;</span><span class="p">,</span> <span class="s">&quot;ahb&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PMU_AHBM</span> <span class="o">|</span> <span class="n">PMU_AHBS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;lantiq,ar9&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">clkdev_add_static</span><span class="p">(</span><span class="n">ltq_ar9_cpu_hz</span><span class="p">(),</span> <span class="n">ltq_ar9_fpi_hz</span><span class="p">(),</span>
				<span class="n">ltq_ar9_fpi_hz</span><span class="p">());</span>
		<span class="n">clkdev_add_pmu</span><span class="p">(</span><span class="s">&quot;1e180000.etop&quot;</span><span class="p">,</span> <span class="s">&quot;switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PMU_SWITCH</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">clkdev_add_static</span><span class="p">(</span><span class="n">ltq_danube_cpu_hz</span><span class="p">(),</span> <span class="n">ltq_danube_fpi_hz</span><span class="p">(),</span>
				<span class="n">ltq_danube_fpi_hz</span><span class="p">());</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
