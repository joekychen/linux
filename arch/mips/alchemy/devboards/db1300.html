<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › mips › alchemy › devboards › db1300.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>db1300.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * DBAu1300 init and platform device setup.</span>
<span class="cm"> *</span>
<span class="cm"> * (c) 2009 Manuel Lauss &lt;manuel.lauss@googlemail.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/gpio_keys.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;	</span><span class="cm">/* KEY_* codes */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/leds.h&gt;</span>
<span class="cp">#include &lt;linux/ata_platform.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/host.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/mtd.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/nand.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/partitions.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/smsc911x.h&gt;</span>

<span class="cp">#include &lt;asm/mach-au1x00/au1000.h&gt;</span>
<span class="cp">#include &lt;asm/mach-au1x00/au1100_mmc.h&gt;</span>
<span class="cp">#include &lt;asm/mach-au1x00/au1200fb.h&gt;</span>
<span class="cp">#include &lt;asm/mach-au1x00/au1xxx_dbdma.h&gt;</span>
<span class="cp">#include &lt;asm/mach-au1x00/au1xxx_psc.h&gt;</span>
<span class="cp">#include &lt;asm/mach-db1x00/db1300.h&gt;</span>
<span class="cp">#include &lt;asm/mach-db1x00/bcsr.h&gt;</span>
<span class="cp">#include &lt;asm/mach-au1x00/prom.h&gt;</span>

<span class="cp">#include &quot;platform.h&quot;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">db1300_i2c_devs</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;wm8731&quot;</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">),</span> <span class="p">},</span>	<span class="cm">/* I2S audio codec */</span>
	<span class="p">{</span> <span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;ne1619&quot;</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">),</span> <span class="p">},</span>	<span class="cm">/* adm1025-compat hwmon */</span>
<span class="p">};</span>

<span class="cm">/* multifunction pins to assign to GPIO controller */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">db1300_gpio_pins</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AU1300_PIN_LCDPWM0</span><span class="p">,</span> <span class="n">AU1300_PIN_PSC2SYNC1</span><span class="p">,</span> <span class="n">AU1300_PIN_WAKE1</span><span class="p">,</span>
	<span class="n">AU1300_PIN_WAKE2</span><span class="p">,</span> <span class="n">AU1300_PIN_WAKE3</span><span class="p">,</span> <span class="n">AU1300_PIN_FG3AUX</span><span class="p">,</span>
	<span class="n">AU1300_PIN_EXTCLK1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="cm">/* terminator */</span>
<span class="p">};</span>

<span class="cm">/* multifunction pins to assign to device functions */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">db1300_dev_pins</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* wake-from-str pins 0-3 */</span>
	<span class="n">AU1300_PIN_WAKE0</span><span class="p">,</span>
	<span class="cm">/* external clock sources for PSC0 */</span>
	<span class="n">AU1300_PIN_EXTCLK0</span><span class="p">,</span>
	<span class="cm">/* 8bit MMC interface on SD0: 6-9 */</span>
	<span class="n">AU1300_PIN_SD0DAT4</span><span class="p">,</span> <span class="n">AU1300_PIN_SD0DAT5</span><span class="p">,</span> <span class="n">AU1300_PIN_SD0DAT6</span><span class="p">,</span>
	<span class="n">AU1300_PIN_SD0DAT7</span><span class="p">,</span>
	<span class="cm">/* UART1 pins: 11-18 */</span>
	<span class="n">AU1300_PIN_U1RI</span><span class="p">,</span> <span class="n">AU1300_PIN_U1DCD</span><span class="p">,</span> <span class="n">AU1300_PIN_U1DSR</span><span class="p">,</span>
	<span class="n">AU1300_PIN_U1CTS</span><span class="p">,</span> <span class="n">AU1300_PIN_U1RTS</span><span class="p">,</span> <span class="n">AU1300_PIN_U1DTR</span><span class="p">,</span>
	<span class="n">AU1300_PIN_U1RX</span><span class="p">,</span> <span class="n">AU1300_PIN_U1TX</span><span class="p">,</span>
	<span class="cm">/* UART0 pins: 19-24 */</span>
	<span class="n">AU1300_PIN_U0RI</span><span class="p">,</span> <span class="n">AU1300_PIN_U0DCD</span><span class="p">,</span> <span class="n">AU1300_PIN_U0DSR</span><span class="p">,</span>
	<span class="n">AU1300_PIN_U0CTS</span><span class="p">,</span> <span class="n">AU1300_PIN_U0RTS</span><span class="p">,</span> <span class="n">AU1300_PIN_U0DTR</span><span class="p">,</span>
	<span class="cm">/* UART2: 25-26 */</span>
	<span class="n">AU1300_PIN_U2RX</span><span class="p">,</span> <span class="n">AU1300_PIN_U2TX</span><span class="p">,</span>
	<span class="cm">/* UART3: 27-28 */</span>
	<span class="n">AU1300_PIN_U3RX</span><span class="p">,</span> <span class="n">AU1300_PIN_U3TX</span><span class="p">,</span>
	<span class="cm">/* LCD controller PWMs, ext pixclock: 30-31 */</span>
	<span class="n">AU1300_PIN_LCDPWM1</span><span class="p">,</span> <span class="n">AU1300_PIN_LCDCLKIN</span><span class="p">,</span>
	<span class="cm">/* SD1 interface: 32-37 */</span>
	<span class="n">AU1300_PIN_SD1DAT0</span><span class="p">,</span> <span class="n">AU1300_PIN_SD1DAT1</span><span class="p">,</span> <span class="n">AU1300_PIN_SD1DAT2</span><span class="p">,</span>
	<span class="n">AU1300_PIN_SD1DAT3</span><span class="p">,</span> <span class="n">AU1300_PIN_SD1CMD</span><span class="p">,</span> <span class="n">AU1300_PIN_SD1CLK</span><span class="p">,</span>
	<span class="cm">/* SD2 interface: 38-43 */</span>
	<span class="n">AU1300_PIN_SD2DAT0</span><span class="p">,</span> <span class="n">AU1300_PIN_SD2DAT1</span><span class="p">,</span> <span class="n">AU1300_PIN_SD2DAT2</span><span class="p">,</span>
	<span class="n">AU1300_PIN_SD2DAT3</span><span class="p">,</span> <span class="n">AU1300_PIN_SD2CMD</span><span class="p">,</span> <span class="n">AU1300_PIN_SD2CLK</span><span class="p">,</span>
	<span class="cm">/* PSC0/1 clocks: 44-45 */</span>
	<span class="n">AU1300_PIN_PSC0CLK</span><span class="p">,</span> <span class="n">AU1300_PIN_PSC1CLK</span><span class="p">,</span>
	<span class="cm">/* PSCs: 46-49/50-53/54-57/58-61 */</span>
	<span class="n">AU1300_PIN_PSC0SYNC0</span><span class="p">,</span> <span class="n">AU1300_PIN_PSC0SYNC1</span><span class="p">,</span> <span class="n">AU1300_PIN_PSC0D0</span><span class="p">,</span>
	<span class="n">AU1300_PIN_PSC0D1</span><span class="p">,</span>
	<span class="n">AU1300_PIN_PSC1SYNC0</span><span class="p">,</span> <span class="n">AU1300_PIN_PSC1SYNC1</span><span class="p">,</span> <span class="n">AU1300_PIN_PSC1D0</span><span class="p">,</span>
	<span class="n">AU1300_PIN_PSC1D1</span><span class="p">,</span>
	<span class="n">AU1300_PIN_PSC2SYNC0</span><span class="p">,</span>                       <span class="n">AU1300_PIN_PSC2D0</span><span class="p">,</span>
	<span class="n">AU1300_PIN_PSC2D1</span><span class="p">,</span>
	<span class="n">AU1300_PIN_PSC3SYNC0</span><span class="p">,</span> <span class="n">AU1300_PIN_PSC3SYNC1</span><span class="p">,</span> <span class="n">AU1300_PIN_PSC3D0</span><span class="p">,</span>
	<span class="n">AU1300_PIN_PSC3D1</span><span class="p">,</span>
	<span class="cm">/* PCMCIA interface: 62-70 */</span>
	<span class="n">AU1300_PIN_PCE2</span><span class="p">,</span> <span class="n">AU1300_PIN_PCE1</span><span class="p">,</span> <span class="n">AU1300_PIN_PIOS16</span><span class="p">,</span>
	<span class="n">AU1300_PIN_PIOR</span><span class="p">,</span> <span class="n">AU1300_PIN_PWE</span><span class="p">,</span> <span class="n">AU1300_PIN_PWAIT</span><span class="p">,</span>
	<span class="n">AU1300_PIN_PREG</span><span class="p">,</span> <span class="n">AU1300_PIN_POE</span><span class="p">,</span> <span class="n">AU1300_PIN_PIOW</span><span class="p">,</span>
	<span class="cm">/* camera interface H/V sync inputs: 71-72 */</span>
	<span class="n">AU1300_PIN_CIMLS</span><span class="p">,</span> <span class="n">AU1300_PIN_CIMFS</span><span class="p">,</span>
	<span class="cm">/* PSC2/3 clocks: 73-74 */</span>
	<span class="n">AU1300_PIN_PSC2CLK</span><span class="p">,</span> <span class="n">AU1300_PIN_PSC3CLK</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="cm">/* terminator */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">db1300_gpio_config</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">i</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">db1300_dev_pins</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">i</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">au1300_pinfunc_to_dev</span><span class="p">(</span><span class="o">*</span><span class="n">i</span><span class="o">++</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">db1300_gpio_pins</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">i</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">au1300_gpio_direction_input</span><span class="p">(</span><span class="o">*</span><span class="n">i</span><span class="o">++</span><span class="p">);</span><span class="cm">/* implies pin_to_gpio */</span>

	<span class="n">au1300_set_dbdma_gpio</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">AU1300_PIN_FG3AUX</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">char</span> <span class="o">*</span><span class="nf">get_system_type</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="s">&quot;DB1300&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**********************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">au1300_nand_cmd_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nand_chip</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">IO_ADDR_W</span><span class="p">;</span>

	<span class="n">ioaddr</span> <span class="o">&amp;=</span> <span class="mh">0xffffff00</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">NAND_CLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioaddr</span> <span class="o">+=</span> <span class="n">MEM_STNAND_CMD</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">NAND_ALE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioaddr</span> <span class="o">+=</span> <span class="n">MEM_STNAND_ADDR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* assume we want to r/w real data  by default */</span>
		<span class="n">ioaddr</span> <span class="o">+=</span> <span class="n">MEM_STNAND_DATA</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">IO_ADDR_R</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">IO_ADDR_W</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">NAND_CMD_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__raw_writeb</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">IO_ADDR_W</span><span class="p">);</span>
		<span class="n">wmb</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">au1300_nand_device_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">mtd_info</span> <span class="o">*</span><span class="n">mtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__raw_readl</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">MEM_STSTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mtd_partition</span> <span class="n">db1300_nand_parts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;NAND FS 0&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;NAND FS 1&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="n">MTDPART_OFS_APPEND</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="n">MTDPART_SIZ_FULL</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">platform_nand_data</span> <span class="n">db1300_nand_platdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">chip</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">nr_chips</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chip_offset</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">nr_partitions</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">db1300_nand_parts</span><span class="p">),</span>
		<span class="p">.</span><span class="n">partitions</span>	<span class="o">=</span> <span class="n">db1300_nand_parts</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chip_delay</span>	<span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">ctrl</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dev_ready</span>	<span class="o">=</span> <span class="n">au1300_nand_device_ready</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cmd_ctrl</span>	<span class="o">=</span> <span class="n">au1300_nand_cmd_ctrl</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">db1300_nand_res</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">DB1300_NAND_PHYS_ADDR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">DB1300_NAND_PHYS_ADDR</span> <span class="o">+</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">db1300_nand_dev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;gen_nand&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">db1300_nand_res</span><span class="p">),</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">db1300_nand_res</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">db1300_nand_platdata</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/**********************************************************************/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">db1300_eth_res</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>		<span class="o">=</span> <span class="n">DB1300_ETH_PHYS_ADDR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>		<span class="o">=</span> <span class="n">DB1300_ETH_PHYS_END</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>		<span class="o">=</span> <span class="n">DB1300_ETH_INT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>		<span class="o">=</span> <span class="n">DB1300_ETH_INT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">smsc911x_platform_config</span> <span class="n">db1300_eth_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">phy_interface</span>		<span class="o">=</span> <span class="n">PHY_INTERFACE_MODE_MII</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_polarity</span>		<span class="o">=</span> <span class="n">SMSC911X_IRQ_POLARITY_ACTIVE_LOW</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_type</span>		<span class="o">=</span> <span class="n">SMSC911X_IRQ_TYPE_PUSH_PULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>			<span class="o">=</span> <span class="n">SMSC911X_USE_32BIT</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">db1300_eth_dev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;smsc911x&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>			<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>		<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">db1300_eth_res</span><span class="p">),</span>
	<span class="p">.</span><span class="n">resource</span>		<span class="o">=</span> <span class="n">db1300_eth_res</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">db1300_eth_config</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/**********************************************************************/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">au1300_psc1_res</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AU1300_PSC1_PHYS_ADDR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AU1300_PSC1_PHYS_ADDR</span> <span class="o">+</span> <span class="mh">0x0fff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AU1300_PSC1_INT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AU1300_PSC1_INT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AU1300_DSCR_CMD0_PSC1_TX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AU1300_DSCR_CMD0_PSC1_TX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_DMA</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AU1300_DSCR_CMD0_PSC1_RX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AU1300_DSCR_CMD0_PSC1_RX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_DMA</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">db1300_ac97_dev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;au1xpsc_ac97&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/* PSC ID. match with AC97 codec ID! */</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">au1300_psc1_res</span><span class="p">),</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">au1300_psc1_res</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**********************************************************************/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">au1300_psc2_res</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AU1300_PSC2_PHYS_ADDR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AU1300_PSC2_PHYS_ADDR</span> <span class="o">+</span> <span class="mh">0x0fff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AU1300_PSC2_INT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AU1300_PSC2_INT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AU1300_DSCR_CMD0_PSC2_TX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AU1300_DSCR_CMD0_PSC2_TX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_DMA</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AU1300_DSCR_CMD0_PSC2_RX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AU1300_DSCR_CMD0_PSC2_RX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_DMA</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">db1300_i2s_dev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;au1xpsc_i2s&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>	<span class="cm">/* PSC ID */</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">au1300_psc2_res</span><span class="p">),</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">au1300_psc2_res</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**********************************************************************/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">au1300_psc3_res</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AU1300_PSC3_PHYS_ADDR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AU1300_PSC3_PHYS_ADDR</span> <span class="o">+</span> <span class="mh">0x0fff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AU1300_PSC3_INT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AU1300_PSC3_INT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AU1300_DSCR_CMD0_PSC3_TX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AU1300_DSCR_CMD0_PSC3_TX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_DMA</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AU1300_DSCR_CMD0_PSC3_RX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AU1300_DSCR_CMD0_PSC3_RX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_DMA</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">db1300_i2c_dev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;au1xpsc_smbus&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* bus number */</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">au1300_psc3_res</span><span class="p">),</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">au1300_psc3_res</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**********************************************************************/</span>

<span class="cm">/* proper key assignments when facing the LCD panel.  For key assignments</span>
<span class="cm"> * according to the schematics swap up with down and left with right.</span>
<span class="cm"> * I chose to use it to emulate the arrow keys of a keyboard.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio_keys_button</span> <span class="n">db1300_5waysw_arrowkeys</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">code</span>			<span class="o">=</span> <span class="n">KEY_DOWN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span>			<span class="o">=</span> <span class="n">AU1300_PIN_LCDPWM0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>			<span class="o">=</span> <span class="n">EV_KEY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">debounce_interval</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">active_low</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">desc</span>			<span class="o">=</span> <span class="s">&quot;5waysw-down&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">code</span>			<span class="o">=</span> <span class="n">KEY_UP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span>			<span class="o">=</span> <span class="n">AU1300_PIN_PSC2SYNC1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>			<span class="o">=</span> <span class="n">EV_KEY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">debounce_interval</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">active_low</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">desc</span>			<span class="o">=</span> <span class="s">&quot;5waysw-up&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">code</span>			<span class="o">=</span> <span class="n">KEY_RIGHT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span>			<span class="o">=</span> <span class="n">AU1300_PIN_WAKE3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>			<span class="o">=</span> <span class="n">EV_KEY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">debounce_interval</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">active_low</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">desc</span>			<span class="o">=</span> <span class="s">&quot;5waysw-right&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">code</span>			<span class="o">=</span> <span class="n">KEY_LEFT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span>			<span class="o">=</span> <span class="n">AU1300_PIN_WAKE2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>			<span class="o">=</span> <span class="n">EV_KEY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">debounce_interval</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">active_low</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">desc</span>			<span class="o">=</span> <span class="s">&quot;5waysw-left&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">code</span>			<span class="o">=</span> <span class="n">KEY_ENTER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span>			<span class="o">=</span> <span class="n">AU1300_PIN_WAKE1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>			<span class="o">=</span> <span class="n">EV_KEY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">debounce_interval</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">active_low</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">desc</span>			<span class="o">=</span> <span class="s">&quot;5waysw-push&quot;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio_keys_platform_data</span> <span class="n">db1300_5waysw_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">buttons</span>	<span class="o">=</span> <span class="n">db1300_5waysw_arrowkeys</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nbuttons</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">db1300_5waysw_arrowkeys</span><span class="p">),</span>
	<span class="p">.</span><span class="n">rep</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;db1300-5wayswitch&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">db1300_5waysw_dev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;gpio-keys&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">db1300_5waysw_data</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/**********************************************************************/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pata_platform_info</span> <span class="n">db1300_ide_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ioport_shift</span>	<span class="o">=</span> <span class="n">DB1300_IDE_REG_SHIFT</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define IDE_ALT_START	(14 &lt;&lt; DB1300_IDE_REG_SHIFT)</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">db1300_ide_res</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">DB1300_IDE_PHYS_ADDR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">DB1300_IDE_PHYS_ADDR</span> <span class="o">+</span> <span class="n">IDE_ALT_START</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">DB1300_IDE_PHYS_ADDR</span> <span class="o">+</span> <span class="n">IDE_ALT_START</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">DB1300_IDE_PHYS_ADDR</span> <span class="o">+</span> <span class="n">DB1300_IDE_PHYS_LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">DB1300_IDE_INT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">DB1300_IDE_INT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">db1300_ide_dev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dev</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">db1300_ide_info</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;pata_platform&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">db1300_ide_res</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">db1300_ide_res</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/**********************************************************************/</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">db1300_mmc_cd</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="n">mmc_cd</span><span class="p">)(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>

	<span class="cm">/* disable the one currently screaming. No other way to shut it up */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">==</span> <span class="n">DB1300_SD1_INSERT_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">disable_irq_nosync</span><span class="p">(</span><span class="n">DB1300_SD1_INSERT_INT</span><span class="p">);</span>
		<span class="n">enable_irq</span><span class="p">(</span><span class="n">DB1300_SD1_EJECT_INT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">disable_irq_nosync</span><span class="p">(</span><span class="n">DB1300_SD1_EJECT_INT</span><span class="p">);</span>
		<span class="n">enable_irq</span><span class="p">(</span><span class="n">DB1300_SD1_INSERT_INT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* link against CONFIG_MMC=m.  We can only be called once MMC core has</span>
<span class="cm">	 * initialized the controller, so symbol_get() should always succeed.</span>
<span class="cm">	 */</span>
	<span class="n">mmc_cd</span> <span class="o">=</span> <span class="n">symbol_get</span><span class="p">(</span><span class="n">mmc_detect_change</span><span class="p">);</span>
	<span class="n">mmc_cd</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">500</span><span class="p">));</span>
	<span class="n">symbol_put</span><span class="p">(</span><span class="n">mmc_detect_change</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">db1300_mmc_card_readonly</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">mmc_host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* it uses SD1 interface, but the DB1200&#39;s SD0 bit in the CPLD */</span>
	<span class="k">return</span> <span class="n">bcsr_read</span><span class="p">(</span><span class="n">BCSR_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BCSR_STATUS_SD0WP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">db1300_mmc_card_inserted</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">mmc_host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">bcsr_read</span><span class="p">(</span><span class="n">BCSR_SIGSTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span> <span class="cm">/* insertion irq signal */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">db1300_mmc_cd_setup</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">mmc_host</span><span class="p">,</span> <span class="kt">int</span> <span class="n">en</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">en</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">DB1300_SD1_INSERT_INT</span><span class="p">,</span> <span class="n">db1300_mmc_cd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="s">&quot;sd_insert&quot;</span><span class="p">,</span> <span class="n">mmc_host</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">DB1300_SD1_EJECT_INT</span><span class="p">,</span> <span class="n">db1300_mmc_cd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="s">&quot;sd_eject&quot;</span><span class="p">,</span> <span class="n">mmc_host</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">DB1300_SD1_INSERT_INT</span><span class="p">,</span> <span class="n">mmc_host</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">db1300_mmc_card_inserted</span><span class="p">(</span><span class="n">mmc_host</span><span class="p">))</span>
			<span class="n">enable_irq</span><span class="p">(</span><span class="n">DB1300_SD1_EJECT_INT</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">enable_irq</span><span class="p">(</span><span class="n">DB1300_SD1_INSERT_INT</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">DB1300_SD1_INSERT_INT</span><span class="p">,</span> <span class="n">mmc_host</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">DB1300_SD1_EJECT_INT</span><span class="p">,</span> <span class="n">mmc_host</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">db1300_mmcled_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">led</span><span class="p">,</span>
			      <span class="k">enum</span> <span class="n">led_brightness</span> <span class="n">brightness</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">brightness</span> <span class="o">!=</span> <span class="n">LED_OFF</span><span class="p">)</span>
		<span class="n">bcsr_mod</span><span class="p">(</span><span class="n">BCSR_LEDS</span><span class="p">,</span> <span class="n">BCSR_LEDS_LED0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bcsr_mod</span><span class="p">(</span><span class="n">BCSR_LEDS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BCSR_LEDS_LED0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">led_classdev</span> <span class="n">db1300_mmc_led</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">brightness_set</span>	<span class="o">=</span> <span class="n">db1300_mmcled_set</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">au1xmmc_platform_data</span> <span class="n">db1300_sd1_platdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">cd_setup</span>	<span class="o">=</span> <span class="n">db1300_mmc_cd_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">card_inserted</span>	<span class="o">=</span> <span class="n">db1300_mmc_card_inserted</span><span class="p">,</span>
	<span class="p">.</span><span class="n">card_readonly</span>	<span class="o">=</span> <span class="n">db1300_mmc_card_readonly</span><span class="p">,</span>
	<span class="p">.</span><span class="n">led</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">db1300_mmc_led</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">au1300_sd1_res</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AU1300_SD1_PHYS_ADDR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AU1300_SD1_PHYS_ADDR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AU1300_SD1_INT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AU1300_SD1_INT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AU1300_DSCR_CMD0_SDMS_TX1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AU1300_DSCR_CMD0_SDMS_TX1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_DMA</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AU1300_DSCR_CMD0_SDMS_RX1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AU1300_DSCR_CMD0_SDMS_RX1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_DMA</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">db1300_sd1_dev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">db1300_sd1_platdata</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;au1xxx-mmc&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">au1300_sd1_res</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">au1300_sd1_res</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/**********************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">db1300_movinand_inserted</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">mmc_host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* disable for now, it doesn&#39;t work yet */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">db1300_movinand_readonly</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">mmc_host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">db1300_movinand_led_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">led</span><span class="p">,</span>
				    <span class="k">enum</span> <span class="n">led_brightness</span> <span class="n">brightness</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">brightness</span> <span class="o">!=</span> <span class="n">LED_OFF</span><span class="p">)</span>
		<span class="n">bcsr_mod</span><span class="p">(</span><span class="n">BCSR_LEDS</span><span class="p">,</span> <span class="n">BCSR_LEDS_LED1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bcsr_mod</span><span class="p">(</span><span class="n">BCSR_LEDS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BCSR_LEDS_LED1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">led_classdev</span> <span class="n">db1300_movinand_led</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">brightness_set</span>		<span class="o">=</span> <span class="n">db1300_movinand_led_set</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">au1xmmc_platform_data</span> <span class="n">db1300_sd0_platdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">card_inserted</span>		<span class="o">=</span> <span class="n">db1300_movinand_inserted</span><span class="p">,</span>
	<span class="p">.</span><span class="n">card_readonly</span>		<span class="o">=</span> <span class="n">db1300_movinand_readonly</span><span class="p">,</span>
	<span class="p">.</span><span class="n">led</span>			<span class="o">=</span> <span class="o">&amp;</span><span class="n">db1300_movinand_led</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mask_host_caps</span>		<span class="o">=</span> <span class="n">MMC_CAP_NEEDS_POLL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">au1300_sd0_res</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AU1100_SD0_PHYS_ADDR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AU1100_SD0_PHYS_ADDR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AU1300_SD0_INT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AU1300_SD0_INT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AU1300_DSCR_CMD0_SDMS_TX0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AU1300_DSCR_CMD0_SDMS_TX0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_DMA</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AU1300_DSCR_CMD0_SDMS_RX0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AU1300_DSCR_CMD0_SDMS_RX0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_DMA</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">db1300_sd0_dev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">db1300_sd0_platdata</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;au1xxx-mmc&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">au1300_sd0_res</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">au1300_sd0_res</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/**********************************************************************/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">db1300_wm9715_dev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;wm9712-codec&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/* ID of PSC for AC97 audio, see asoc glue! */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">db1300_ac97dma_dev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;au1xpsc-pcm&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/* PSC ID */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">db1300_i2sdma_dev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;au1xpsc-pcm&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>	<span class="cm">/* PSC ID */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">db1300_sndac97_dev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;db1300-ac97&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">db1300_sndi2s_dev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;db1300-i2s&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**********************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">db1300fb_panel_index</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">9</span><span class="p">;</span>	<span class="cm">/* DB1300_800x480 */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">db1300fb_panel_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Apply power (Vee/Vdd logic is inverted on Panel DB1300_800x480) */</span>
	<span class="n">bcsr_mod</span><span class="p">(</span><span class="n">BCSR_BOARD</span><span class="p">,</span> <span class="n">BCSR_BOARD_LCDVEE</span> <span class="o">|</span> <span class="n">BCSR_BOARD_LCDVDD</span><span class="p">,</span>
			     <span class="n">BCSR_BOARD_LCDBL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">db1300fb_panel_shutdown</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Remove power (Vee/Vdd logic is inverted on Panel DB1300_800x480) */</span>
	<span class="n">bcsr_mod</span><span class="p">(</span><span class="n">BCSR_BOARD</span><span class="p">,</span> <span class="n">BCSR_BOARD_LCDBL</span><span class="p">,</span>
			     <span class="n">BCSR_BOARD_LCDVEE</span> <span class="o">|</span> <span class="n">BCSR_BOARD_LCDVDD</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">au1200fb_platdata</span> <span class="n">db1300fb_pd</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">panel_index</span>	<span class="o">=</span> <span class="n">db1300fb_panel_index</span><span class="p">,</span>
	<span class="p">.</span><span class="n">panel_init</span>	<span class="o">=</span> <span class="n">db1300fb_panel_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">panel_shutdown</span>	<span class="o">=</span> <span class="n">db1300fb_panel_shutdown</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">au1300_lcd_res</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AU1200_LCD_PHYS_ADDR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AU1200_LCD_PHYS_ADDR</span> <span class="o">+</span> <span class="mh">0x800</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AU1300_LCD_INT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AU1300_LCD_INT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u64</span> <span class="n">au1300_lcd_dmamask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">db1300_lcd_dev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;au1200-lcd&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dma_mask</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">au1300_lcd_dmamask</span><span class="p">,</span>
		<span class="p">.</span><span class="n">coherent_dma_mask</span>	<span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
		<span class="p">.</span><span class="n">platform_data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">db1300fb_pd</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">au1300_lcd_res</span><span class="p">),</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">au1300_lcd_res</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**********************************************************************/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">db1300_dev</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">db1300_eth_dev</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">db1300_i2c_dev</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">db1300_5waysw_dev</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">db1300_nand_dev</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">db1300_ide_dev</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">db1300_sd0_dev</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">db1300_sd1_dev</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">db1300_lcd_dev</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">db1300_ac97_dev</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">db1300_i2s_dev</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">db1300_wm9715_dev</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">db1300_ac97dma_dev</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">db1300_i2sdma_dev</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">db1300_sndac97_dev</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">db1300_sndi2s_dev</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">db1300_device_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">swapped</span><span class="p">,</span> <span class="n">cpldirq</span><span class="p">;</span>

	<span class="cm">/* setup CPLD IRQ muxer */</span>
	<span class="n">cpldirq</span> <span class="o">=</span> <span class="n">au1300_gpio_to_irq</span><span class="p">(</span><span class="n">AU1300_PIN_EXTCLK1</span><span class="p">);</span>
	<span class="n">irq_set_irq_type</span><span class="p">(</span><span class="n">cpldirq</span><span class="p">,</span> <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">);</span>
	<span class="n">bcsr_init_irq</span><span class="p">(</span><span class="n">DB1300_FIRST_INT</span><span class="p">,</span> <span class="n">DB1300_LAST_INT</span><span class="p">,</span> <span class="n">cpldirq</span><span class="p">);</span>

	<span class="cm">/* insert/eject IRQs: one always triggers so don&#39;t enable them</span>
<span class="cm">	 * when doing request_irq() on them.  DB1200 has this bug too.</span>
<span class="cm">	 */</span>
	<span class="n">irq_set_status_flags</span><span class="p">(</span><span class="n">DB1300_SD1_INSERT_INT</span><span class="p">,</span> <span class="n">IRQ_NOAUTOEN</span><span class="p">);</span>
	<span class="n">irq_set_status_flags</span><span class="p">(</span><span class="n">DB1300_SD1_EJECT_INT</span><span class="p">,</span> <span class="n">IRQ_NOAUTOEN</span><span class="p">);</span>
	<span class="n">irq_set_status_flags</span><span class="p">(</span><span class="n">DB1300_CF_INSERT_INT</span><span class="p">,</span> <span class="n">IRQ_NOAUTOEN</span><span class="p">);</span>
	<span class="n">irq_set_status_flags</span><span class="p">(</span><span class="n">DB1300_CF_EJECT_INT</span><span class="p">,</span> <span class="n">IRQ_NOAUTOEN</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * setup board</span>
<span class="cm">	 */</span>
	<span class="n">prom_get_ethernet_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db1300_eth_config</span><span class="p">.</span><span class="n">mac</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">i2c_register_board_info</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">db1300_i2c_devs</span><span class="p">,</span>
				<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">db1300_i2c_devs</span><span class="p">));</span>

	<span class="cm">/* Audio PSC clock is supplied by codecs (PSC1, 2) */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">PSC_SEL_CLK_SERCLK</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">KSEG1ADDR</span><span class="p">(</span><span class="n">AU1300_PSC1_PHYS_ADDR</span><span class="p">)</span> <span class="o">+</span> <span class="n">PSC_SEL_OFFSET</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">PSC_SEL_CLK_SERCLK</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">KSEG1ADDR</span><span class="p">(</span><span class="n">AU1300_PSC2_PHYS_ADDR</span><span class="p">)</span> <span class="o">+</span> <span class="n">PSC_SEL_OFFSET</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="cm">/* I2C uses internal 48MHz EXTCLK1 */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">PSC_SEL_CLK_INTCLK</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">KSEG1ADDR</span><span class="p">(</span><span class="n">AU1300_PSC3_PHYS_ADDR</span><span class="p">)</span> <span class="o">+</span> <span class="n">PSC_SEL_OFFSET</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="cm">/* enable power to USB ports */</span>
	<span class="n">bcsr_mod</span><span class="p">(</span><span class="n">BCSR_RESETS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BCSR_RESETS_USBHPWR</span> <span class="o">|</span> <span class="n">BCSR_RESETS_OTGPWR</span><span class="p">);</span>

	<span class="cm">/* although it is socket #0, it uses the CPLD bits which previous boards</span>
<span class="cm">	 * have used for socket #1.</span>
<span class="cm">	 */</span>
	<span class="n">db1x_register_pcmcia_socket</span><span class="p">(</span>
		<span class="n">AU1000_PCMCIA_ATTR_PHYS_ADDR</span><span class="p">,</span>
		<span class="n">AU1000_PCMCIA_ATTR_PHYS_ADDR</span> <span class="o">+</span> <span class="mh">0x00400000</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="n">AU1000_PCMCIA_MEM_PHYS_ADDR</span><span class="p">,</span>
		<span class="n">AU1000_PCMCIA_MEM_PHYS_ADDR</span>  <span class="o">+</span> <span class="mh">0x00400000</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="n">AU1000_PCMCIA_IO_PHYS_ADDR</span><span class="p">,</span>
		<span class="n">AU1000_PCMCIA_IO_PHYS_ADDR</span>   <span class="o">+</span> <span class="mh">0x00010000</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="n">DB1300_CF_INT</span><span class="p">,</span> <span class="n">DB1300_CF_INSERT_INT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DB1300_CF_EJECT_INT</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">swapped</span> <span class="o">=</span> <span class="n">bcsr_read</span><span class="p">(</span><span class="n">BCSR_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BCSR_STATUS_DB1200_SWAPBOOT</span><span class="p">;</span>
	<span class="n">db1x_register_norflash</span><span class="p">(</span><span class="mi">64</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">swapped</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">platform_add_devices</span><span class="p">(</span><span class="n">db1300_dev</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">db1300_dev</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">device_initcall</span><span class="p">(</span><span class="n">db1300_device_init</span><span class="p">);</span>


<span class="kt">void</span> <span class="n">__init</span> <span class="nf">board_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">whoami</span><span class="p">;</span>

	<span class="n">db1300_gpio_config</span><span class="p">();</span>
	<span class="n">bcsr_init</span><span class="p">(</span><span class="n">DB1300_BCSR_PHYS_ADDR</span><span class="p">,</span>
		  <span class="n">DB1300_BCSR_PHYS_ADDR</span> <span class="o">+</span> <span class="n">DB1300_BCSR_HEXLED_OFS</span><span class="p">);</span>

	<span class="n">whoami</span> <span class="o">=</span> <span class="n">bcsr_read</span><span class="p">(</span><span class="n">BCSR_WHOAMI</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;NetLogic DBAu1300 Development Platform.</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;BoardID %d   CPLD Rev %d   DaughtercardID %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">BCSR_WHOAMI_BOARD</span><span class="p">(</span><span class="n">whoami</span><span class="p">),</span> <span class="n">BCSR_WHOAMI_CPLD</span><span class="p">(</span><span class="n">whoami</span><span class="p">),</span>
		<span class="n">BCSR_WHOAMI_DCID</span><span class="p">(</span><span class="n">whoami</span><span class="p">));</span>

	<span class="cm">/* enable UARTs, YAMON only enables #2 */</span>
	<span class="n">alchemy_uart_enable</span><span class="p">(</span><span class="n">AU1300_UART0_PHYS_ADDR</span><span class="p">);</span>
	<span class="n">alchemy_uart_enable</span><span class="p">(</span><span class="n">AU1300_UART1_PHYS_ADDR</span><span class="p">);</span>
	<span class="n">alchemy_uart_enable</span><span class="p">(</span><span class="n">AU1300_UART3_PHYS_ADDR</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
