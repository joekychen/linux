<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › mips › alchemy › common › irq.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>irq.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 2001, 2007-2008 MontaVista Software Inc.</span>
<span class="cm"> * Author: MontaVista Software, Inc. &lt;source@mvista.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007 Ralf Baechle (ralf@linux-mips.org)</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute	 it and/or modify it</span>
<span class="cm"> *  under  the terms of	 the GNU General  Public License as published by the</span>
<span class="cm"> *  Free Software Foundation;  either version 2 of the	License, or (at your</span>
<span class="cm"> *  option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  THIS  SOFTWARE  IS PROVIDED	  ``AS	IS&#39;&#39; AND   ANY	EXPRESS OR IMPLIED</span>
<span class="cm"> *  WARRANTIES,	  INCLUDING, BUT NOT  LIMITED  TO, THE IMPLIED WARRANTIES OF</span>
<span class="cm"> *  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN</span>
<span class="cm"> *  NO	EVENT  SHALL   THE AUTHOR  BE	 LIABLE FOR ANY	  DIRECT, INDIRECT,</span>
<span class="cm"> *  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT</span>
<span class="cm"> *  NOT LIMITED	  TO, PROCUREMENT OF  SUBSTITUTE GOODS	OR SERVICES; LOSS OF</span>
<span class="cm"> *  USE, DATA,	OR PROFITS; OR	BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON</span>
<span class="cm"> *  ANY THEORY OF LIABILITY, WHETHER IN	 CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="cm"> *  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF</span>
<span class="cm"> *  THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the  GNU General Public License along</span>
<span class="cm"> *  with this program; if not, write  to the Free Software Foundation, Inc.,</span>
<span class="cm"> *  675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/syscore_ops.h&gt;</span>

<span class="cp">#include &lt;asm/irq_cpu.h&gt;</span>
<span class="cp">#include &lt;asm/mach-au1x00/au1000.h&gt;</span>
<span class="cp">#include &lt;asm/mach-au1x00/gpio-au1300.h&gt;</span>

<span class="cm">/* Interrupt Controller register offsets */</span>
<span class="cp">#define IC_CFG0RD	0x40</span>
<span class="cp">#define IC_CFG0SET	0x40</span>
<span class="cp">#define IC_CFG0CLR	0x44</span>
<span class="cp">#define IC_CFG1RD	0x48</span>
<span class="cp">#define IC_CFG1SET	0x48</span>
<span class="cp">#define IC_CFG1CLR	0x4C</span>
<span class="cp">#define IC_CFG2RD	0x50</span>
<span class="cp">#define IC_CFG2SET	0x50</span>
<span class="cp">#define IC_CFG2CLR	0x54</span>
<span class="cp">#define IC_REQ0INT	0x54</span>
<span class="cp">#define IC_SRCRD	0x58</span>
<span class="cp">#define IC_SRCSET	0x58</span>
<span class="cp">#define IC_SRCCLR	0x5C</span>
<span class="cp">#define IC_REQ1INT	0x5C</span>
<span class="cp">#define IC_ASSIGNRD	0x60</span>
<span class="cp">#define IC_ASSIGNSET	0x60</span>
<span class="cp">#define IC_ASSIGNCLR	0x64</span>
<span class="cp">#define IC_WAKERD	0x68</span>
<span class="cp">#define IC_WAKESET	0x68</span>
<span class="cp">#define IC_WAKECLR	0x6C</span>
<span class="cp">#define IC_MASKRD	0x70</span>
<span class="cp">#define IC_MASKSET	0x70</span>
<span class="cp">#define IC_MASKCLR	0x74</span>
<span class="cp">#define IC_RISINGRD	0x78</span>
<span class="cp">#define IC_RISINGCLR	0x78</span>
<span class="cp">#define IC_FALLINGRD	0x7C</span>
<span class="cp">#define IC_FALLINGCLR	0x7C</span>
<span class="cp">#define IC_TESTBIT	0x80</span>

<span class="cm">/* per-processor fixed function irqs */</span>
<span class="k">struct</span> <span class="n">alchemy_irqmap</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>	<span class="cm">/* linux IRQ number */</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>	<span class="cm">/* IRQ_TYPE_ */</span>
	<span class="kt">int</span> <span class="n">prio</span><span class="p">;</span>	<span class="cm">/* irq priority, 0 highest, 3 lowest */</span>
	<span class="kt">int</span> <span class="n">internal</span><span class="p">;</span>	<span class="cm">/* GPIC: internal source (no ext. pin)? */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">au1x_ic_settype</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">au1300_gpic_settype</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">);</span>


<span class="cm">/* NOTE on interrupt priorities: The original writers of this code said:</span>
<span class="cm"> *</span>
<span class="cm"> * Because of the tight timing of SETUP token to reply transactions,</span>
<span class="cm"> * the USB devices-side packet complete interrupt (USB_DEV_REQ_INT)</span>
<span class="cm"> * needs the highest priority.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">alchemy_irqmap</span> <span class="n">au1000_irqmap</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">AU1000_UART0_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1000_UART1_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1000_UART2_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1000_UART3_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1000_SSI0_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1000_SSI1_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1000_DMA_INT_BASE</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1000_DMA_INT_BASE</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1000_DMA_INT_BASE</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span>  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1000_DMA_INT_BASE</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span>  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1000_DMA_INT_BASE</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span>  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1000_DMA_INT_BASE</span><span class="o">+</span><span class="mi">5</span><span class="p">,</span>  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1000_DMA_INT_BASE</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span>  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1000_DMA_INT_BASE</span><span class="o">+</span><span class="mi">7</span><span class="p">,</span>  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1000_TOY_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1000_TOY_MATCH0_INT</span><span class="p">,</span>  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1000_TOY_MATCH1_INT</span><span class="p">,</span>  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1000_TOY_MATCH2_INT</span><span class="p">,</span>  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1000_RTC_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1000_RTC_MATCH0_INT</span><span class="p">,</span>  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1000_RTC_MATCH1_INT</span><span class="p">,</span>  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1000_RTC_MATCH2_INT</span><span class="p">,</span>  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1000_IRDA_TX_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1000_IRDA_RX_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1000_USB_DEV_REQ_INT</span><span class="p">,</span> <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1000_USB_DEV_SUS_INT</span><span class="p">,</span> <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1000_USB_HOST_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_LOW</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1000_ACSYNC_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1000_MAC0_DMA_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1000_MAC1_DMA_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1000_AC97C_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">alchemy_irqmap</span> <span class="n">au1500_irqmap</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">AU1500_UART0_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1500_PCI_INTA</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_LOW</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1500_PCI_INTB</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_LOW</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1500_UART3_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1500_PCI_INTC</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_LOW</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1500_PCI_INTD</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_LOW</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1500_DMA_INT_BASE</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1500_DMA_INT_BASE</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1500_DMA_INT_BASE</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span>  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1500_DMA_INT_BASE</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span>  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1500_DMA_INT_BASE</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span>  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1500_DMA_INT_BASE</span><span class="o">+</span><span class="mi">5</span><span class="p">,</span>  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1500_DMA_INT_BASE</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span>  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1500_DMA_INT_BASE</span><span class="o">+</span><span class="mi">7</span><span class="p">,</span>  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1500_TOY_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1500_TOY_MATCH0_INT</span><span class="p">,</span>  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1500_TOY_MATCH1_INT</span><span class="p">,</span>  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1500_TOY_MATCH2_INT</span><span class="p">,</span>  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1500_RTC_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1500_RTC_MATCH0_INT</span><span class="p">,</span>  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1500_RTC_MATCH1_INT</span><span class="p">,</span>  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1500_RTC_MATCH2_INT</span><span class="p">,</span>  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1500_USB_DEV_REQ_INT</span><span class="p">,</span> <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1500_USB_DEV_SUS_INT</span><span class="p">,</span> <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1500_USB_HOST_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_LOW</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1500_ACSYNC_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1500_MAC0_DMA_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1500_MAC1_DMA_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1500_AC97C_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">alchemy_irqmap</span> <span class="n">au1100_irqmap</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">AU1100_UART0_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1100_UART1_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1100_SD_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1100_UART3_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1100_SSI0_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1100_SSI1_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1100_DMA_INT_BASE</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1100_DMA_INT_BASE</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1100_DMA_INT_BASE</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span>  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1100_DMA_INT_BASE</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span>  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1100_DMA_INT_BASE</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span>  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1100_DMA_INT_BASE</span><span class="o">+</span><span class="mi">5</span><span class="p">,</span>  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1100_DMA_INT_BASE</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span>  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1100_DMA_INT_BASE</span><span class="o">+</span><span class="mi">7</span><span class="p">,</span>  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1100_TOY_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1100_TOY_MATCH0_INT</span><span class="p">,</span>  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1100_TOY_MATCH1_INT</span><span class="p">,</span>  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1100_TOY_MATCH2_INT</span><span class="p">,</span>  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1100_RTC_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1100_RTC_MATCH0_INT</span><span class="p">,</span>  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1100_RTC_MATCH1_INT</span><span class="p">,</span>  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1100_RTC_MATCH2_INT</span><span class="p">,</span>  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1100_IRDA_TX_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1100_IRDA_RX_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1100_USB_DEV_REQ_INT</span><span class="p">,</span> <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1100_USB_DEV_SUS_INT</span><span class="p">,</span> <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1100_USB_HOST_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_LOW</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1100_ACSYNC_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1100_MAC0_DMA_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1100_LCD_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1100_AC97C_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">alchemy_irqmap</span> <span class="n">au1550_irqmap</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">AU1550_UART0_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_PCI_INTA</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_LOW</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_PCI_INTB</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_LOW</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_DDMA_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_CRYPTO_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_PCI_INTC</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_LOW</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_PCI_INTD</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_LOW</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_PCI_RST_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_LOW</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_UART1_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_UART3_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_PSC0_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_PSC1_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_PSC2_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_PSC3_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_TOY_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_TOY_MATCH0_INT</span><span class="p">,</span>  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_TOY_MATCH1_INT</span><span class="p">,</span>  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_TOY_MATCH2_INT</span><span class="p">,</span>  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_RTC_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_RTC_MATCH0_INT</span><span class="p">,</span>  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_RTC_MATCH1_INT</span><span class="p">,</span>  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_RTC_MATCH2_INT</span><span class="p">,</span>  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_NAND_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_USB_DEV_REQ_INT</span><span class="p">,</span> <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_USB_DEV_SUS_INT</span><span class="p">,</span> <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_USB_HOST_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_LOW</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_MAC0_DMA_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_MAC1_DMA_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">alchemy_irqmap</span> <span class="n">au1200_irqmap</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">AU1200_UART0_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_SWT_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_SD_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_DDMA_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_MAE_BE_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_UART1_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_MAE_FE_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_PSC0_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_PSC1_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_AES_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_CAMERA_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_TOY_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_TOY_MATCH0_INT</span><span class="p">,</span>  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_TOY_MATCH1_INT</span><span class="p">,</span>  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_TOY_MATCH2_INT</span><span class="p">,</span>  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_RTC_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_RTC_MATCH0_INT</span><span class="p">,</span>  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_RTC_MATCH1_INT</span><span class="p">,</span>  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_RTC_MATCH2_INT</span><span class="p">,</span>  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_NAND_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_USB_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_LCD_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_MAE_BOTH_INT</span><span class="p">,</span>	  <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">alchemy_irqmap</span> <span class="n">au1300_irqmap</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* multifunction: gpio pin or device */</span>
	<span class="p">{</span> <span class="n">AU1300_UART1_INT</span><span class="p">,</span>	 <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_UART2_INT</span><span class="p">,</span>	 <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_UART3_INT</span><span class="p">,</span>	 <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_SD1_INT</span><span class="p">,</span>	 <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_SD2_INT</span><span class="p">,</span>	 <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_PSC0_INT</span><span class="p">,</span>	 <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_PSC1_INT</span><span class="p">,</span>	 <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_PSC2_INT</span><span class="p">,</span>	 <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_PSC3_INT</span><span class="p">,</span>	 <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_NAND_INT</span><span class="p">,</span>	 <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
	<span class="cm">/* au1300 internal */</span>
	<span class="p">{</span> <span class="n">AU1300_DDMA_INT</span><span class="p">,</span>	 <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_MMU_INT</span><span class="p">,</span>	 <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_MPU_INT</span><span class="p">,</span>	 <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_GPU_INT</span><span class="p">,</span>	 <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_UDMA_INT</span><span class="p">,</span>	 <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_TOY_INT</span><span class="p">,</span>	 <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_TOY_MATCH0_INT</span><span class="p">,</span> <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_TOY_MATCH1_INT</span><span class="p">,</span> <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_TOY_MATCH2_INT</span><span class="p">,</span> <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_RTC_INT</span><span class="p">,</span>	 <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_RTC_MATCH0_INT</span><span class="p">,</span> <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_RTC_MATCH1_INT</span><span class="p">,</span> <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_RTC_MATCH2_INT</span><span class="p">,</span> <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_UART0_INT</span><span class="p">,</span>	 <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_SD0_INT</span><span class="p">,</span>	 <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_USB_INT</span><span class="p">,</span>	 <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_LCD_INT</span><span class="p">,</span>	 <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_BSA_INT</span><span class="p">,</span>	 <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_MPE_INT</span><span class="p">,</span>	 <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_ITE_INT</span><span class="p">,</span>	 <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_AES_INT</span><span class="p">,</span>	 <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_CIM_INT</span><span class="p">,</span>	 <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">},</span>	<span class="cm">/* terminator */</span>
<span class="p">};</span>

<span class="cm">/******************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">au1x_ic0_unmask</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">AU1000_INTC0_INT_BASE</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">KSEG1ADDR</span><span class="p">(</span><span class="n">AU1000_IC0_PHYS_ADDR</span><span class="p">);</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_MASKSET</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_WAKESET</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">au1x_ic1_unmask</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">AU1000_INTC1_INT_BASE</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">KSEG1ADDR</span><span class="p">(</span><span class="n">AU1000_IC1_PHYS_ADDR</span><span class="p">);</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_MASKSET</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_WAKESET</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">au1x_ic0_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">AU1000_INTC0_INT_BASE</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">KSEG1ADDR</span><span class="p">(</span><span class="n">AU1000_IC0_PHYS_ADDR</span><span class="p">);</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_MASKCLR</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_WAKECLR</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">au1x_ic1_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">AU1000_INTC1_INT_BASE</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">KSEG1ADDR</span><span class="p">(</span><span class="n">AU1000_IC1_PHYS_ADDR</span><span class="p">);</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_MASKCLR</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_WAKECLR</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">au1x_ic0_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">AU1000_INTC0_INT_BASE</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">KSEG1ADDR</span><span class="p">(</span><span class="n">AU1000_IC0_PHYS_ADDR</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * This may assume that we don&#39;t get interrupts from</span>
<span class="cm">	 * both edges at once, or if we do, that we don&#39;t care.</span>
<span class="cm">	 */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_FALLINGCLR</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_RISINGCLR</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">au1x_ic1_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">AU1000_INTC1_INT_BASE</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">KSEG1ADDR</span><span class="p">(</span><span class="n">AU1000_IC1_PHYS_ADDR</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * This may assume that we don&#39;t get interrupts from</span>
<span class="cm">	 * both edges at once, or if we do, that we don&#39;t care.</span>
<span class="cm">	 */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_FALLINGCLR</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_RISINGCLR</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">au1x_ic0_maskack</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">AU1000_INTC0_INT_BASE</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">KSEG1ADDR</span><span class="p">(</span><span class="n">AU1000_IC0_PHYS_ADDR</span><span class="p">);</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_WAKECLR</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_MASKCLR</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_RISINGCLR</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_FALLINGCLR</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">au1x_ic1_maskack</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">AU1000_INTC1_INT_BASE</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">KSEG1ADDR</span><span class="p">(</span><span class="n">AU1000_IC1_PHYS_ADDR</span><span class="p">);</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_WAKECLR</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_MASKCLR</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_RISINGCLR</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_FALLINGCLR</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">au1x_ic1_setwake</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bit</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">AU1000_INTC1_INT_BASE</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">wakemsk</span><span class="p">,</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* only GPIO 0-7 can act as wakeup source.  Fortunately these</span>
<span class="cm">	 * are wired up identically on all supported variants.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bit</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">bit</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">wakemsk</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">SYS_WAKEMSK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">wakemsk</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">wakemsk</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">wakemsk</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">SYS_WAKEMSK</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * irq_chips for both ICs; this way the mask handlers can be</span>
<span class="cm"> * as short as possible.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">au1x_ic0_chip</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;Alchemy-IC0&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_ack</span>	<span class="o">=</span> <span class="n">au1x_ic0_ack</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask</span>	<span class="o">=</span> <span class="n">au1x_ic0_mask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask_ack</span>	<span class="o">=</span> <span class="n">au1x_ic0_maskack</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span>	<span class="o">=</span> <span class="n">au1x_ic0_unmask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_set_type</span>	<span class="o">=</span> <span class="n">au1x_ic_settype</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">au1x_ic1_chip</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;Alchemy-IC1&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_ack</span>	<span class="o">=</span> <span class="n">au1x_ic1_ack</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask</span>	<span class="o">=</span> <span class="n">au1x_ic1_mask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask_ack</span>	<span class="o">=</span> <span class="n">au1x_ic1_maskack</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span>	<span class="o">=</span> <span class="n">au1x_ic1_unmask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_set_type</span>	<span class="o">=</span> <span class="n">au1x_ic_settype</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_set_wake</span>	<span class="o">=</span> <span class="n">au1x_ic1_setwake</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">au1x_ic_settype</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flow_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">irq_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">,</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">irq_flow_handler_t</span> <span class="n">handler</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="n">AU1000_INTC1_INT_BASE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bit</span> <span class="o">=</span> <span class="n">irq</span> <span class="o">-</span> <span class="n">AU1000_INTC1_INT_BASE</span><span class="p">;</span>
		<span class="n">chip</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">au1x_ic1_chip</span><span class="p">;</span>
		<span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">KSEG1ADDR</span><span class="p">(</span><span class="n">AU1000_IC1_PHYS_ADDR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bit</span> <span class="o">=</span> <span class="n">irq</span> <span class="o">-</span> <span class="n">AU1000_INTC0_INT_BASE</span><span class="p">;</span>
		<span class="n">chip</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">au1x_ic0_chip</span><span class="p">;</span>
		<span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">KSEG1ADDR</span><span class="p">(</span><span class="n">AU1000_IC0_PHYS_ADDR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bit</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">flow_type</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* cfgregs 2:1:0 */</span>
	<span class="k">case</span> <span class="n">IRQ_TYPE_EDGE_RISING</span>:	<span class="cm">/* 0:0:1 */</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_CFG2CLR</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_CFG1CLR</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_CFG0SET</span><span class="p">);</span>
		<span class="n">handler</span> <span class="o">=</span> <span class="n">handle_edge_irq</span><span class="p">;</span>
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;riseedge&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IRQ_TYPE_EDGE_FALLING</span>:	<span class="cm">/* 0:1:0 */</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_CFG2CLR</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_CFG1SET</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_CFG0CLR</span><span class="p">);</span>
		<span class="n">handler</span> <span class="o">=</span> <span class="n">handle_edge_irq</span><span class="p">;</span>
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;falledge&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IRQ_TYPE_EDGE_BOTH</span>:	<span class="cm">/* 0:1:1 */</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_CFG2CLR</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_CFG1SET</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_CFG0SET</span><span class="p">);</span>
		<span class="n">handler</span> <span class="o">=</span> <span class="n">handle_edge_irq</span><span class="p">;</span>
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;bothedge&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IRQ_TYPE_LEVEL_HIGH</span>:	<span class="cm">/* 1:0:1 */</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_CFG2SET</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_CFG1CLR</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_CFG0SET</span><span class="p">);</span>
		<span class="n">handler</span> <span class="o">=</span> <span class="n">handle_level_irq</span><span class="p">;</span>
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;hilevel&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IRQ_TYPE_LEVEL_LOW</span>:	<span class="cm">/* 1:1:0 */</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_CFG2SET</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_CFG1SET</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_CFG0CLR</span><span class="p">);</span>
		<span class="n">handler</span> <span class="o">=</span> <span class="n">handle_level_irq</span><span class="p">;</span>
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;lowlevel&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IRQ_TYPE_NONE</span>:		<span class="cm">/* 0:0:0 */</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_CFG2CLR</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_CFG1CLR</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_CFG0CLR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">__irq_set_chip_handler_name_locked</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="n">wmb</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * au1300_gpic_chgcfg - change PIN configuration.</span>
<span class="cm"> * @gpio:	pin to change (0-based GPIO number from datasheet).</span>
<span class="cm"> * @clr:	clear all bits set in &#39;clr&#39;.</span>
<span class="cm"> * @set:	set these bits.</span>
<span class="cm"> *</span>
<span class="cm"> * modifies a pins&#39; configuration register, bits set in @clr will</span>
<span class="cm"> * be cleared in the register, bits in @set will be set.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">au1300_gpic_chgcfg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gpio</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">clr</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">AU1300_GPIC_ADDR</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">l</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">+=</span> <span class="n">gpio</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* offset into pin config array */</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">AU1300_GPIC_PINCFG</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">clr</span><span class="p">;</span>
	<span class="n">l</span> <span class="o">|=</span> <span class="n">set</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="o">+</span> <span class="n">AU1300_GPIC_PINCFG</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * au1300_pinfunc_to_gpio - assign a pin as GPIO input (GPIO ctrl).</span>
<span class="cm"> * @pin:	pin (0-based GPIO number from datasheet).</span>
<span class="cm"> *</span>
<span class="cm"> * Assigns a GPIO pin to the GPIO controller, so its level can either</span>
<span class="cm"> * be read or set through the generic GPIO functions.</span>
<span class="cm"> * If you need a GPOUT, use au1300_gpio_set_value(pin, 0/1).</span>
<span class="cm"> * REVISIT: is this function really necessary?</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">au1300_pinfunc_to_gpio</span><span class="p">(</span><span class="k">enum</span> <span class="n">au1300_multifunc_pins</span> <span class="n">gpio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">au1300_gpio_direction_input</span><span class="p">(</span><span class="n">gpio</span> <span class="o">+</span> <span class="n">AU1300_GPIO_BASE</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">au1300_pinfunc_to_gpio</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * au1300_pinfunc_to_dev - assign a pin to the device function.</span>
<span class="cm"> * @pin:	pin (0-based GPIO number from datasheet).</span>
<span class="cm"> *</span>
<span class="cm"> * Assigns a GPIO pin to its associated device function; the pin will be</span>
<span class="cm"> * driven by the device and not through GPIO functions.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">au1300_pinfunc_to_dev</span><span class="p">(</span><span class="k">enum</span> <span class="n">au1300_multifunc_pins</span> <span class="n">gpio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">AU1300_GPIC_ADDR</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bit</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">+=</span> <span class="n">GPIC_GPIO_BANKOFF</span><span class="p">(</span><span class="n">gpio</span><span class="p">);</span>
	<span class="n">bit</span> <span class="o">=</span> <span class="n">GPIC_GPIO_TO_BIT</span><span class="p">(</span><span class="n">gpio</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">bit</span><span class="p">,</span> <span class="n">r</span> <span class="o">+</span> <span class="n">AU1300_GPIC_DEVSEL</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">au1300_pinfunc_to_dev</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * au1300_set_irq_priority -  set internal priority of IRQ.</span>
<span class="cm"> * @irq:	irq to set priority (linux irq number).</span>
<span class="cm"> * @p:		priority (0 = highest, 3 = lowest).</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">au1300_set_irq_priority</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">irq</span> <span class="o">-=</span> <span class="n">ALCHEMY_GPIC_INT_BASE</span><span class="p">;</span>
	<span class="n">au1300_gpic_chgcfg</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">GPIC_CFG_IL_MASK</span><span class="p">,</span> <span class="n">GPIC_CFG_IL_SET</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">au1300_set_irq_priority</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * au1300_set_dbdma_gpio - assign a gpio to one of the DBDMA triggers.</span>
<span class="cm"> * @dchan:	dbdma trigger select (0, 1).</span>
<span class="cm"> * @gpio:	pin to assign as trigger.</span>
<span class="cm"> *</span>
<span class="cm"> * DBDMA controller has 2 external trigger sources; this function</span>
<span class="cm"> * assigns a GPIO to the selected trigger.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">au1300_set_dbdma_gpio</span><span class="p">(</span><span class="kt">int</span> <span class="n">dchan</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gpio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dchan</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dchan</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">AU1300_GPIC_ADDR</span> <span class="o">+</span> <span class="n">AU1300_GPIC_DMASEL</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xff</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">dchan</span><span class="p">));</span>
		<span class="n">r</span> <span class="o">|=</span> <span class="p">(</span><span class="n">gpio</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">dchan</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">AU1300_GPIC_ADDR</span> <span class="o">+</span> <span class="n">AU1300_GPIC_DMASEL</span><span class="p">);</span>
		<span class="n">wmb</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gpic_pin_set_idlewake</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gpio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">allow</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">au1300_gpic_chgcfg</span><span class="p">(</span><span class="n">gpio</span><span class="p">,</span> <span class="n">GPIC_CFG_IDLEWAKE</span><span class="p">,</span>
			   <span class="n">allow</span> <span class="o">?</span> <span class="n">GPIC_CFG_IDLEWAKE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">au1300_gpic_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">AU1300_GPIC_ADDR</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bit</span><span class="p">,</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">irq</span> <span class="o">-=</span> <span class="n">ALCHEMY_GPIC_INT_BASE</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">+=</span> <span class="n">GPIC_GPIO_BANKOFF</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">bit</span> <span class="o">=</span> <span class="n">GPIC_GPIO_TO_BIT</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">bit</span><span class="p">,</span> <span class="n">r</span> <span class="o">+</span> <span class="n">AU1300_GPIC_IDIS</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="n">gpic_pin_set_idlewake</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">au1300_gpic_unmask</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">AU1300_GPIC_ADDR</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bit</span><span class="p">,</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">irq</span> <span class="o">-=</span> <span class="n">ALCHEMY_GPIC_INT_BASE</span><span class="p">;</span>

	<span class="n">gpic_pin_set_idlewake</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">+=</span> <span class="n">GPIC_GPIO_BANKOFF</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">bit</span> <span class="o">=</span> <span class="n">GPIC_GPIO_TO_BIT</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">bit</span><span class="p">,</span> <span class="n">r</span> <span class="o">+</span> <span class="n">AU1300_GPIC_IEN</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">au1300_gpic_maskack</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">AU1300_GPIC_ADDR</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bit</span><span class="p">,</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">irq</span> <span class="o">-=</span> <span class="n">ALCHEMY_GPIC_INT_BASE</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">+=</span> <span class="n">GPIC_GPIO_BANKOFF</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">bit</span> <span class="o">=</span> <span class="n">GPIC_GPIO_TO_BIT</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">bit</span><span class="p">,</span> <span class="n">r</span> <span class="o">+</span> <span class="n">AU1300_GPIC_IPEND</span><span class="p">);</span>	<span class="cm">/* ack */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">bit</span><span class="p">,</span> <span class="n">r</span> <span class="o">+</span> <span class="n">AU1300_GPIC_IDIS</span><span class="p">);</span>	<span class="cm">/* mask */</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="n">gpic_pin_set_idlewake</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">au1300_gpic_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">AU1300_GPIC_ADDR</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bit</span><span class="p">,</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">irq</span> <span class="o">-=</span> <span class="n">ALCHEMY_GPIC_INT_BASE</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">+=</span> <span class="n">GPIC_GPIO_BANKOFF</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">bit</span> <span class="o">=</span> <span class="n">GPIC_GPIO_TO_BIT</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">bit</span><span class="p">,</span> <span class="n">r</span> <span class="o">+</span> <span class="n">AU1300_GPIC_IPEND</span><span class="p">);</span>	<span class="cm">/* ack */</span>
	<span class="n">wmb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">au1300_gpic</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;GPIOINT&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_ack</span>	<span class="o">=</span> <span class="n">au1300_gpic_ack</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask</span>	<span class="o">=</span> <span class="n">au1300_gpic_mask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask_ack</span>	<span class="o">=</span> <span class="n">au1300_gpic_maskack</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span>	<span class="o">=</span> <span class="n">au1300_gpic_unmask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_set_type</span>	<span class="o">=</span> <span class="n">au1300_gpic_settype</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">au1300_gpic_settype</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">s</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">irq_flow_handler_t</span> <span class="n">hdl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IRQ_TYPE_LEVEL_HIGH</span>:
		<span class="n">s</span> <span class="o">=</span> <span class="n">GPIC_CFG_IC_LEVEL_HIGH</span><span class="p">;</span>
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;high&quot;</span><span class="p">;</span>
		<span class="n">hdl</span> <span class="o">=</span> <span class="n">handle_level_irq</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IRQ_TYPE_LEVEL_LOW</span>:
		<span class="n">s</span> <span class="o">=</span> <span class="n">GPIC_CFG_IC_LEVEL_LOW</span><span class="p">;</span>
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;low&quot;</span><span class="p">;</span>
		<span class="n">hdl</span> <span class="o">=</span> <span class="n">handle_level_irq</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IRQ_TYPE_EDGE_RISING</span>:
		<span class="n">s</span> <span class="o">=</span> <span class="n">GPIC_CFG_IC_EDGE_RISE</span><span class="p">;</span>
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;posedge&quot;</span><span class="p">;</span>
		<span class="n">hdl</span> <span class="o">=</span> <span class="n">handle_edge_irq</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IRQ_TYPE_EDGE_FALLING</span>:
		<span class="n">s</span> <span class="o">=</span> <span class="n">GPIC_CFG_IC_EDGE_FALL</span><span class="p">;</span>
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;negedge&quot;</span><span class="p">;</span>
		<span class="n">hdl</span> <span class="o">=</span> <span class="n">handle_edge_irq</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IRQ_TYPE_EDGE_BOTH</span>:
		<span class="n">s</span> <span class="o">=</span> <span class="n">GPIC_CFG_IC_EDGE_BOTH</span><span class="p">;</span>
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;bothedge&quot;</span><span class="p">;</span>
		<span class="n">hdl</span> <span class="o">=</span> <span class="n">handle_edge_irq</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IRQ_TYPE_NONE</span>:
		<span class="n">s</span> <span class="o">=</span> <span class="n">GPIC_CFG_IC_OFF</span><span class="p">;</span>
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;disabled&quot;</span><span class="p">;</span>
		<span class="n">hdl</span> <span class="o">=</span> <span class="n">handle_level_irq</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">__irq_set_chip_handler_name_locked</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">au1300_gpic</span><span class="p">,</span> <span class="n">hdl</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="n">au1300_gpic_chgcfg</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">ALCHEMY_GPIC_INT_BASE</span><span class="p">,</span> <span class="n">GPIC_CFG_IC_MASK</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ic_init</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* initialize interrupt controller to a safe state */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_CFG0CLR</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_CFG1CLR</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_CFG2CLR</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_MASKCLR</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_ASSIGNCLR</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_WAKECLR</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_SRCSET</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_FALLINGCLR</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_RISINGCLR</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_TESTBIT</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">alchemy_gpic_pmdata</span><span class="p">[</span><span class="n">ALCHEMY_GPIC_INT_NUM</span> <span class="o">+</span> <span class="mi">6</span><span class="p">];</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">alchemy_ic_suspend_one</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">IC_CFG0RD</span><span class="p">);</span>
	<span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">IC_CFG1RD</span><span class="p">);</span>
	<span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">IC_CFG2RD</span><span class="p">);</span>
	<span class="n">d</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">IC_SRCRD</span><span class="p">);</span>
	<span class="n">d</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">IC_ASSIGNRD</span><span class="p">);</span>
	<span class="n">d</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">IC_WAKERD</span><span class="p">);</span>
	<span class="n">d</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">IC_MASKRD</span><span class="p">);</span>
	<span class="n">ic_init</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>		<span class="cm">/* shut it up too while at it */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">alchemy_ic_resume_one</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ic_init</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_CFG0SET</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_CFG1SET</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_CFG2SET</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_SRCSET</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_ASSIGNSET</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_WAKESET</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_MASKSET</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alchemy_ic_suspend</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">alchemy_ic_suspend_one</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">KSEG1ADDR</span><span class="p">(</span><span class="n">AU1000_IC0_PHYS_ADDR</span><span class="p">),</span>
			       <span class="n">alchemy_gpic_pmdata</span><span class="p">);</span>
	<span class="n">alchemy_ic_suspend_one</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">KSEG1ADDR</span><span class="p">(</span><span class="n">AU1000_IC1_PHYS_ADDR</span><span class="p">),</span>
			       <span class="o">&amp;</span><span class="n">alchemy_gpic_pmdata</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">alchemy_ic_resume</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">alchemy_ic_resume_one</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">KSEG1ADDR</span><span class="p">(</span><span class="n">AU1000_IC1_PHYS_ADDR</span><span class="p">),</span>
			      <span class="o">&amp;</span><span class="n">alchemy_gpic_pmdata</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
	<span class="n">alchemy_ic_resume_one</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">KSEG1ADDR</span><span class="p">(</span><span class="n">AU1000_IC0_PHYS_ADDR</span><span class="p">),</span>
			      <span class="n">alchemy_gpic_pmdata</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alchemy_gpic_suspend</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">KSEG1ADDR</span><span class="p">(</span><span class="n">AU1300_GPIC_PHYS_ADDR</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* save 4 interrupt mask status registers */</span>
	<span class="n">alchemy_gpic_pmdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">AU1300_GPIC_IEN</span> <span class="o">+</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">alchemy_gpic_pmdata</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">AU1300_GPIC_IEN</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">);</span>
	<span class="n">alchemy_gpic_pmdata</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">AU1300_GPIC_IEN</span> <span class="o">+</span> <span class="mh">0x8</span><span class="p">);</span>
	<span class="n">alchemy_gpic_pmdata</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">AU1300_GPIC_IEN</span> <span class="o">+</span> <span class="mh">0xc</span><span class="p">);</span>

	<span class="cm">/* save misc register(s) */</span>
	<span class="n">alchemy_gpic_pmdata</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">AU1300_GPIC_DMASEL</span><span class="p">);</span>

	<span class="cm">/* molto silenzioso */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="o">~</span><span class="mi">0UL</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">AU1300_GPIC_IDIS</span> <span class="o">+</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="o">~</span><span class="mi">0UL</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">AU1300_GPIC_IDIS</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="o">~</span><span class="mi">0UL</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">AU1300_GPIC_IDIS</span> <span class="o">+</span> <span class="mh">0x8</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="o">~</span><span class="mi">0UL</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">AU1300_GPIC_IDIS</span> <span class="o">+</span> <span class="mh">0xc</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="cm">/* save pin/int-type configuration */</span>
	<span class="n">base</span> <span class="o">+=</span> <span class="n">AU1300_GPIC_PINCFG</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ALCHEMY_GPIC_INT_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">alchemy_gpic_pmdata</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>

	<span class="n">wmb</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">alchemy_gpic_resume</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">KSEG1ADDR</span><span class="p">(</span><span class="n">AU1300_GPIC_PHYS_ADDR</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* disable all first */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="o">~</span><span class="mi">0UL</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">AU1300_GPIC_IDIS</span> <span class="o">+</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="o">~</span><span class="mi">0UL</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">AU1300_GPIC_IDIS</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="o">~</span><span class="mi">0UL</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">AU1300_GPIC_IDIS</span> <span class="o">+</span> <span class="mh">0x8</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="o">~</span><span class="mi">0UL</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">AU1300_GPIC_IDIS</span> <span class="o">+</span> <span class="mh">0xc</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="cm">/* restore pin/int-type configurations */</span>
	<span class="n">base</span> <span class="o">+=</span> <span class="n">AU1300_GPIC_PINCFG</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ALCHEMY_GPIC_INT_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">alchemy_gpic_pmdata</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">5</span><span class="p">],</span> <span class="n">base</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="cm">/* restore misc register(s) */</span>
	<span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">KSEG1ADDR</span><span class="p">(</span><span class="n">AU1300_GPIC_PHYS_ADDR</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">alchemy_gpic_pmdata</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">base</span> <span class="o">+</span> <span class="n">AU1300_GPIC_DMASEL</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="cm">/* finally restore masks */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">alchemy_gpic_pmdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">base</span> <span class="o">+</span> <span class="n">AU1300_GPIC_IEN</span> <span class="o">+</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">alchemy_gpic_pmdata</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">base</span> <span class="o">+</span> <span class="n">AU1300_GPIC_IEN</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">alchemy_gpic_pmdata</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">base</span> <span class="o">+</span> <span class="n">AU1300_GPIC_IEN</span> <span class="o">+</span> <span class="mh">0x8</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">alchemy_gpic_pmdata</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">base</span> <span class="o">+</span> <span class="n">AU1300_GPIC_IEN</span> <span class="o">+</span> <span class="mh">0xc</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">syscore_ops</span> <span class="n">alchemy_ic_pmops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">alchemy_ic_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">alchemy_ic_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">syscore_ops</span> <span class="n">alchemy_gpic_pmops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">alchemy_gpic_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">alchemy_gpic_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/******************************************************************************/</span>

<span class="cm">/* create chained handlers for the 4 IC requests to the MIPS IRQ ctrl */</span>
<span class="cp">#define DISP(name, base, addr)						      \</span>
<span class="cp">static void au1000_##name##_dispatch(unsigned int irq, struct irq_desc *d)    \</span>
<span class="cp">{									      \</span>
<span class="cp">	unsigned long r = __raw_readl((void __iomem *)KSEG1ADDR(addr));	      \</span>
<span class="cp">	if (likely(r))							      \</span>
<span class="cp">		generic_handle_irq(base + __ffs(r));			      \</span>
<span class="cp">	else								      \</span>
<span class="cp">		spurious_interrupt();					      \</span>
<span class="cp">}</span>

<span class="n">DISP</span><span class="p">(</span><span class="n">ic0r0</span><span class="p">,</span> <span class="n">AU1000_INTC0_INT_BASE</span><span class="p">,</span> <span class="n">AU1000_IC0_PHYS_ADDR</span> <span class="o">+</span> <span class="n">IC_REQ0INT</span><span class="p">)</span>
<span class="n">DISP</span><span class="p">(</span><span class="n">ic0r1</span><span class="p">,</span> <span class="n">AU1000_INTC0_INT_BASE</span><span class="p">,</span> <span class="n">AU1000_IC0_PHYS_ADDR</span> <span class="o">+</span> <span class="n">IC_REQ1INT</span><span class="p">)</span>
<span class="n">DISP</span><span class="p">(</span><span class="n">ic1r0</span><span class="p">,</span> <span class="n">AU1000_INTC1_INT_BASE</span><span class="p">,</span> <span class="n">AU1000_IC1_PHYS_ADDR</span> <span class="o">+</span> <span class="n">IC_REQ0INT</span><span class="p">)</span>
<span class="n">DISP</span><span class="p">(</span><span class="n">ic1r1</span><span class="p">,</span> <span class="n">AU1000_INTC1_INT_BASE</span><span class="p">,</span> <span class="n">AU1000_IC1_PHYS_ADDR</span> <span class="o">+</span> <span class="n">IC_REQ1INT</span><span class="p">)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">alchemy_gpic_dispatch</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">AU1300_GPIC_ADDR</span> <span class="o">+</span> <span class="n">AU1300_GPIC_PRIENC</span><span class="p">);</span>
	<span class="n">generic_handle_irq</span><span class="p">(</span><span class="n">ALCHEMY_GPIC_INT_BASE</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="n">au1000_init_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">alchemy_irqmap</span> <span class="o">*</span><span class="n">map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">,</span> <span class="n">irq_nr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>

	<span class="n">ic_init</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">KSEG1ADDR</span><span class="p">(</span><span class="n">AU1000_IC0_PHYS_ADDR</span><span class="p">));</span>
	<span class="n">ic_init</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">KSEG1ADDR</span><span class="p">(</span><span class="n">AU1000_IC1_PHYS_ADDR</span><span class="p">));</span>
	<span class="n">register_syscore_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">alchemy_ic_pmops</span><span class="p">);</span>
	<span class="n">mips_cpu_irq_init</span><span class="p">();</span>

	<span class="cm">/* register all 64 possible IC0+IC1 irq sources as type &quot;none&quot;.</span>
<span class="cm">	 * Use set_irq_type() to set edge/level behaviour at runtime.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">irq_nr</span> <span class="o">=</span> <span class="n">AU1000_INTC0_INT_BASE</span><span class="p">;</span>
	     <span class="p">(</span><span class="n">irq_nr</span> <span class="o">&lt;</span> <span class="n">AU1000_INTC0_INT_BASE</span> <span class="o">+</span> <span class="mi">32</span><span class="p">);</span> <span class="n">irq_nr</span><span class="o">++</span><span class="p">)</span>
		<span class="n">au1x_ic_settype</span><span class="p">(</span><span class="n">irq_get_irq_data</span><span class="p">(</span><span class="n">irq_nr</span><span class="p">),</span> <span class="n">IRQ_TYPE_NONE</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">irq_nr</span> <span class="o">=</span> <span class="n">AU1000_INTC1_INT_BASE</span><span class="p">;</span>
	     <span class="p">(</span><span class="n">irq_nr</span> <span class="o">&lt;</span> <span class="n">AU1000_INTC1_INT_BASE</span> <span class="o">+</span> <span class="mi">32</span><span class="p">);</span> <span class="n">irq_nr</span><span class="o">++</span><span class="p">)</span>
		<span class="n">au1x_ic_settype</span><span class="p">(</span><span class="n">irq_get_irq_data</span><span class="p">(</span><span class="n">irq_nr</span><span class="p">),</span> <span class="n">IRQ_TYPE_NONE</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize IC0, which is fixed per processor.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq_nr</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">irq_nr</span> <span class="o">&gt;=</span> <span class="n">AU1000_INTC1_INT_BASE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bit</span> <span class="o">=</span> <span class="n">irq_nr</span> <span class="o">-</span> <span class="n">AU1000_INTC1_INT_BASE</span><span class="p">;</span>
			<span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">KSEG1ADDR</span><span class="p">(</span><span class="n">AU1000_IC1_PHYS_ADDR</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bit</span> <span class="o">=</span> <span class="n">irq_nr</span> <span class="o">-</span> <span class="n">AU1000_INTC0_INT_BASE</span><span class="p">;</span>
			<span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">KSEG1ADDR</span><span class="p">(</span><span class="n">AU1000_IC0_PHYS_ADDR</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">prio</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">IC_ASSIGNSET</span><span class="p">);</span>

		<span class="n">au1x_ic_settype</span><span class="p">(</span><span class="n">irq_get_irq_data</span><span class="p">(</span><span class="n">irq_nr</span><span class="p">),</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="o">++</span><span class="n">map</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">irq_set_chained_handler</span><span class="p">(</span><span class="n">MIPS_CPU_IRQ_BASE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">au1000_ic0r0_dispatch</span><span class="p">);</span>
	<span class="n">irq_set_chained_handler</span><span class="p">(</span><span class="n">MIPS_CPU_IRQ_BASE</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">au1000_ic0r1_dispatch</span><span class="p">);</span>
	<span class="n">irq_set_chained_handler</span><span class="p">(</span><span class="n">MIPS_CPU_IRQ_BASE</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">au1000_ic1r0_dispatch</span><span class="p">);</span>
	<span class="n">irq_set_chained_handler</span><span class="p">(</span><span class="n">MIPS_CPU_IRQ_BASE</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="n">au1000_ic1r1_dispatch</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="n">alchemy_gpic_init_irq</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">alchemy_irqmap</span> <span class="o">*</span><span class="n">dints</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bank_base</span><span class="p">;</span>

	<span class="n">register_syscore_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">alchemy_gpic_pmops</span><span class="p">);</span>
	<span class="n">mips_cpu_irq_init</span><span class="p">();</span>

	<span class="cm">/* disable &amp; ack all possible interrupt sources */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bank_base</span> <span class="o">=</span> <span class="n">AU1300_GPIC_ADDR</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="o">~</span><span class="mi">0UL</span><span class="p">,</span> <span class="n">bank_base</span> <span class="o">+</span> <span class="n">AU1300_GPIC_IDIS</span><span class="p">);</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="o">~</span><span class="mi">0UL</span><span class="p">,</span> <span class="n">bank_base</span> <span class="o">+</span> <span class="n">AU1300_GPIC_IPEND</span><span class="p">);</span>
		<span class="n">wmb</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/* register an irq_chip for them, with 2nd highest priority */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ALCHEMY_GPIC_INT_BASE</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">ALCHEMY_GPIC_INT_LAST</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">au1300_set_irq_priority</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">au1300_gpic_settype</span><span class="p">(</span><span class="n">irq_get_irq_data</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">IRQ_TYPE_NONE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* setup known on-chip sources */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">dints</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">au1300_gpic_settype</span><span class="p">(</span><span class="n">irq_get_irq_data</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">dints</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">au1300_set_irq_priority</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dints</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dints</span><span class="o">-&gt;</span><span class="n">internal</span><span class="p">)</span>
			<span class="n">au1300_pinfunc_to_dev</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">ALCHEMY_GPIC_INT_BASE</span><span class="p">);</span>

		<span class="n">dints</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">irq_set_chained_handler</span><span class="p">(</span><span class="n">MIPS_CPU_IRQ_BASE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">alchemy_gpic_dispatch</span><span class="p">);</span>
	<span class="n">irq_set_chained_handler</span><span class="p">(</span><span class="n">MIPS_CPU_IRQ_BASE</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">alchemy_gpic_dispatch</span><span class="p">);</span>
	<span class="n">irq_set_chained_handler</span><span class="p">(</span><span class="n">MIPS_CPU_IRQ_BASE</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">alchemy_gpic_dispatch</span><span class="p">);</span>
	<span class="n">irq_set_chained_handler</span><span class="p">(</span><span class="n">MIPS_CPU_IRQ_BASE</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="n">alchemy_gpic_dispatch</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************/</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="n">arch_init_irq</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">alchemy_get_cputype</span><span class="p">())</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ALCHEMY_CPU_AU1000</span>:
		<span class="n">au1000_init_irq</span><span class="p">(</span><span class="n">au1000_irqmap</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ALCHEMY_CPU_AU1500</span>:
		<span class="n">au1000_init_irq</span><span class="p">(</span><span class="n">au1500_irqmap</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ALCHEMY_CPU_AU1100</span>:
		<span class="n">au1000_init_irq</span><span class="p">(</span><span class="n">au1100_irqmap</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ALCHEMY_CPU_AU1550</span>:
		<span class="n">au1000_init_irq</span><span class="p">(</span><span class="n">au1550_irqmap</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ALCHEMY_CPU_AU1200</span>:
		<span class="n">au1000_init_irq</span><span class="p">(</span><span class="n">au1200_irqmap</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ALCHEMY_CPU_AU1300</span>:
		<span class="n">alchemy_gpic_init_irq</span><span class="p">(</span><span class="n">au1300_irqmap</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;unknown Alchemy IRQ core</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">asmlinkage</span> <span class="kt">void</span> <span class="n">plat_irq_dispatch</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">read_c0_status</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">read_c0_cause</span><span class="p">())</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">do_IRQ</span><span class="p">(</span><span class="n">MIPS_CPU_IRQ_BASE</span> <span class="o">+</span> <span class="n">__ffs</span><span class="p">(</span><span class="n">r</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
