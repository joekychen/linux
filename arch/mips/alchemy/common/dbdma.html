<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › mips › alchemy › common › dbdma.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>dbdma.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * BRIEF MODULE DESCRIPTION</span>
<span class="cm"> *      The Descriptor Based DMA channel manager that first appeared</span>
<span class="cm"> *	on the Au1550.  I started with dma.c, but I think all that is</span>
<span class="cm"> *	left is this initial comment :-)</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2004 Embedded Edge, LLC</span>
<span class="cm"> *	dan@embeddededge.com</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute  it and/or modify it</span>
<span class="cm"> *  under  the terms of  the GNU General  Public License as published by the</span>
<span class="cm"> *  Free Software Foundation;  either version 2 of the  License, or (at your</span>
<span class="cm"> *  option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  THIS  SOFTWARE  IS PROVIDED   ``AS  IS&#39;&#39; AND   ANY  EXPRESS OR IMPLIED</span>
<span class="cm"> *  WARRANTIES,   INCLUDING, BUT NOT  LIMITED  TO, THE IMPLIED WARRANTIES OF</span>
<span class="cm"> *  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN</span>
<span class="cm"> *  NO  EVENT  SHALL   THE AUTHOR  BE    LIABLE FOR ANY   DIRECT, INDIRECT,</span>
<span class="cm"> *  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT</span>
<span class="cm"> *  NOT LIMITED   TO, PROCUREMENT OF  SUBSTITUTE GOODS  OR SERVICES; LOSS OF</span>
<span class="cm"> *  USE, DATA,  OR PROFITS; OR  BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON</span>
<span class="cm"> *  ANY THEORY OF LIABILITY, WHETHER IN  CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="cm"> *  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF</span>
<span class="cm"> *  THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the  GNU General Public License along</span>
<span class="cm"> *  with this program; if not, write  to the Free Software Foundation, Inc.,</span>
<span class="cm"> *  675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/syscore_ops.h&gt;</span>
<span class="cp">#include &lt;asm/mach-au1x00/au1000.h&gt;</span>
<span class="cp">#include &lt;asm/mach-au1x00/au1xxx_dbdma.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * The Descriptor Based DMA supports up to 16 channels.</span>
<span class="cm"> *</span>
<span class="cm"> * There are 32 devices defined. We keep an internal structure</span>
<span class="cm"> * of devices using these channels, along with additional</span>
<span class="cm"> * information.</span>
<span class="cm"> *</span>
<span class="cm"> * We allocate the descriptors and allow access to them through various</span>
<span class="cm"> * functions.  The drivers allocate the data buffers and assign them</span>
<span class="cm"> * to the descriptors.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">au1xxx_dbdma_spin_lock</span><span class="p">);</span>

<span class="cm">/* I couldn&#39;t find a macro that did this... */</span>
<span class="cp">#define ALIGN_ADDR(x, a)	((((u32)(x)) + (a-1)) &amp; ~(a-1))</span>

<span class="k">static</span> <span class="n">dbdma_global_t</span> <span class="o">*</span><span class="n">dbdma_gptr</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">dbdma_global_t</span> <span class="o">*</span><span class="p">)</span><span class="n">KSEG1ADDR</span><span class="p">(</span><span class="n">AU1550_DBDMA_CONF_PHYS_ADDR</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dbdma_initialized</span><span class="p">;</span>

<span class="k">static</span> <span class="n">dbdev_tab_t</span> <span class="o">*</span><span class="n">dbdev_tab</span><span class="p">;</span>

<span class="k">static</span> <span class="n">dbdev_tab_t</span> <span class="n">au1550_dbdev_tab</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* UARTS */</span>
	<span class="p">{</span> <span class="n">AU1550_DSCR_CMD0_UART0_TX</span><span class="p">,</span> <span class="n">DEV_FLAGS_OUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x11100004</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_DSCR_CMD0_UART0_RX</span><span class="p">,</span> <span class="n">DEV_FLAGS_IN</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x11100000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_DSCR_CMD0_UART3_TX</span><span class="p">,</span> <span class="n">DEV_FLAGS_OUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x11400004</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_DSCR_CMD0_UART3_RX</span><span class="p">,</span> <span class="n">DEV_FLAGS_IN</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x11400000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>

	<span class="cm">/* EXT DMA */</span>
	<span class="p">{</span> <span class="n">AU1550_DSCR_CMD0_DMA_REQ0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_DSCR_CMD0_DMA_REQ1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_DSCR_CMD0_DMA_REQ2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_DSCR_CMD0_DMA_REQ3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>

	<span class="cm">/* USB DEV */</span>
	<span class="p">{</span> <span class="n">AU1550_DSCR_CMD0_USBDEV_RX0</span><span class="p">,</span> <span class="n">DEV_FLAGS_IN</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x10200000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_DSCR_CMD0_USBDEV_TX0</span><span class="p">,</span> <span class="n">DEV_FLAGS_OUT</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x10200004</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_DSCR_CMD0_USBDEV_TX1</span><span class="p">,</span> <span class="n">DEV_FLAGS_OUT</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x10200008</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_DSCR_CMD0_USBDEV_TX2</span><span class="p">,</span> <span class="n">DEV_FLAGS_OUT</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x1020000c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_DSCR_CMD0_USBDEV_RX3</span><span class="p">,</span> <span class="n">DEV_FLAGS_IN</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x10200010</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_DSCR_CMD0_USBDEV_RX4</span><span class="p">,</span> <span class="n">DEV_FLAGS_IN</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x10200014</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>

	<span class="cm">/* PSCs */</span>
	<span class="p">{</span> <span class="n">AU1550_DSCR_CMD0_PSC0_TX</span><span class="p">,</span> <span class="n">DEV_FLAGS_OUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x11a0001c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_DSCR_CMD0_PSC0_RX</span><span class="p">,</span> <span class="n">DEV_FLAGS_IN</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x11a0001c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_DSCR_CMD0_PSC1_TX</span><span class="p">,</span> <span class="n">DEV_FLAGS_OUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x11b0001c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_DSCR_CMD0_PSC1_RX</span><span class="p">,</span> <span class="n">DEV_FLAGS_IN</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x11b0001c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_DSCR_CMD0_PSC2_TX</span><span class="p">,</span> <span class="n">DEV_FLAGS_OUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x10a0001c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_DSCR_CMD0_PSC2_RX</span><span class="p">,</span> <span class="n">DEV_FLAGS_IN</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x10a0001c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_DSCR_CMD0_PSC3_TX</span><span class="p">,</span> <span class="n">DEV_FLAGS_OUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x10b0001c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_DSCR_CMD0_PSC3_RX</span><span class="p">,</span> <span class="n">DEV_FLAGS_IN</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x10b0001c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">AU1550_DSCR_CMD0_PCI_WRITE</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>  <span class="cm">/* PCI */</span>
	<span class="p">{</span> <span class="n">AU1550_DSCR_CMD0_NAND_FLASH</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* NAND */</span>

	<span class="cm">/* MAC 0 */</span>
	<span class="p">{</span> <span class="n">AU1550_DSCR_CMD0_MAC0_RX</span><span class="p">,</span> <span class="n">DEV_FLAGS_IN</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_DSCR_CMD0_MAC0_TX</span><span class="p">,</span> <span class="n">DEV_FLAGS_OUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>

	<span class="cm">/* MAC 1 */</span>
	<span class="p">{</span> <span class="n">AU1550_DSCR_CMD0_MAC1_RX</span><span class="p">,</span> <span class="n">DEV_FLAGS_IN</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1550_DSCR_CMD0_MAC1_TX</span><span class="p">,</span> <span class="n">DEV_FLAGS_OUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">DSCR_CMD0_THROTTLE</span><span class="p">,</span> <span class="n">DEV_FLAGS_ANYUSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DSCR_CMD0_ALWAYS</span><span class="p">,</span>   <span class="n">DEV_FLAGS_ANYUSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">dbdev_tab_t</span> <span class="n">au1200_dbdev_tab</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">AU1200_DSCR_CMD0_UART0_TX</span><span class="p">,</span> <span class="n">DEV_FLAGS_OUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x11100004</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_DSCR_CMD0_UART0_RX</span><span class="p">,</span> <span class="n">DEV_FLAGS_IN</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x11100000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_DSCR_CMD0_UART1_TX</span><span class="p">,</span> <span class="n">DEV_FLAGS_OUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x11200004</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_DSCR_CMD0_UART1_RX</span><span class="p">,</span> <span class="n">DEV_FLAGS_IN</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x11200000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">AU1200_DSCR_CMD0_DMA_REQ0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_DSCR_CMD0_DMA_REQ1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">AU1200_DSCR_CMD0_MAE_BE</span><span class="p">,</span> <span class="n">DEV_FLAGS_ANYUSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_DSCR_CMD0_MAE_FE</span><span class="p">,</span> <span class="n">DEV_FLAGS_ANYUSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_DSCR_CMD0_MAE_BOTH</span><span class="p">,</span> <span class="n">DEV_FLAGS_ANYUSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_DSCR_CMD0_LCD</span><span class="p">,</span> <span class="n">DEV_FLAGS_ANYUSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">AU1200_DSCR_CMD0_SDMS_TX0</span><span class="p">,</span> <span class="n">DEV_FLAGS_OUT</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x10600000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_DSCR_CMD0_SDMS_RX0</span><span class="p">,</span> <span class="n">DEV_FLAGS_IN</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x10600004</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_DSCR_CMD0_SDMS_TX1</span><span class="p">,</span> <span class="n">DEV_FLAGS_OUT</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x10680000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_DSCR_CMD0_SDMS_RX1</span><span class="p">,</span> <span class="n">DEV_FLAGS_IN</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x10680004</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">AU1200_DSCR_CMD0_AES_RX</span><span class="p">,</span> <span class="n">DEV_FLAGS_IN</span> <span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mh">0x10300008</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_DSCR_CMD0_AES_TX</span><span class="p">,</span> <span class="n">DEV_FLAGS_OUT</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mh">0x10300004</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">AU1200_DSCR_CMD0_PSC0_TX</span><span class="p">,</span>   <span class="n">DEV_FLAGS_OUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0x11a0001c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_DSCR_CMD0_PSC0_RX</span><span class="p">,</span>   <span class="n">DEV_FLAGS_IN</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0x11a0001c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_DSCR_CMD0_PSC0_SYNC</span><span class="p">,</span> <span class="n">DEV_FLAGS_ANYUSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_DSCR_CMD0_PSC1_TX</span><span class="p">,</span>   <span class="n">DEV_FLAGS_OUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0x11b0001c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_DSCR_CMD0_PSC1_RX</span><span class="p">,</span>   <span class="n">DEV_FLAGS_IN</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0x11b0001c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_DSCR_CMD0_PSC1_SYNC</span><span class="p">,</span> <span class="n">DEV_FLAGS_ANYUSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">AU1200_DSCR_CMD0_CIM_RXA</span><span class="p">,</span>  <span class="n">DEV_FLAGS_IN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mh">0x14004020</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_DSCR_CMD0_CIM_RXB</span><span class="p">,</span>  <span class="n">DEV_FLAGS_IN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mh">0x14004040</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_DSCR_CMD0_CIM_RXC</span><span class="p">,</span>  <span class="n">DEV_FLAGS_IN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mh">0x14004060</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1200_DSCR_CMD0_CIM_SYNC</span><span class="p">,</span> <span class="n">DEV_FLAGS_ANYUSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">AU1200_DSCR_CMD0_NAND_FLASH</span><span class="p">,</span> <span class="n">DEV_FLAGS_IN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">DSCR_CMD0_THROTTLE</span><span class="p">,</span> <span class="n">DEV_FLAGS_ANYUSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DSCR_CMD0_ALWAYS</span><span class="p">,</span>   <span class="n">DEV_FLAGS_ANYUSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">dbdev_tab_t</span> <span class="n">au1300_dbdev_tab</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">AU1300_DSCR_CMD0_UART0_TX</span><span class="p">,</span> <span class="n">DEV_FLAGS_OUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>  <span class="mh">0x10100004</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_DSCR_CMD0_UART0_RX</span><span class="p">,</span> <span class="n">DEV_FLAGS_IN</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>  <span class="mh">0x10100000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_DSCR_CMD0_UART1_TX</span><span class="p">,</span> <span class="n">DEV_FLAGS_OUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>  <span class="mh">0x10101004</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_DSCR_CMD0_UART1_RX</span><span class="p">,</span> <span class="n">DEV_FLAGS_IN</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>  <span class="mh">0x10101000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_DSCR_CMD0_UART2_TX</span><span class="p">,</span> <span class="n">DEV_FLAGS_OUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>  <span class="mh">0x10102004</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_DSCR_CMD0_UART2_RX</span><span class="p">,</span> <span class="n">DEV_FLAGS_IN</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>  <span class="mh">0x10102000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_DSCR_CMD0_UART3_TX</span><span class="p">,</span> <span class="n">DEV_FLAGS_OUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>  <span class="mh">0x10103004</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_DSCR_CMD0_UART3_RX</span><span class="p">,</span> <span class="n">DEV_FLAGS_IN</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>  <span class="mh">0x10103000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">AU1300_DSCR_CMD0_SDMS_TX0</span><span class="p">,</span> <span class="n">DEV_FLAGS_OUT</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>  <span class="mh">0x10600000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_DSCR_CMD0_SDMS_RX0</span><span class="p">,</span> <span class="n">DEV_FLAGS_IN</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>  <span class="mh">0x10600004</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_DSCR_CMD0_SDMS_TX1</span><span class="p">,</span> <span class="n">DEV_FLAGS_OUT</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>  <span class="mh">0x10601000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_DSCR_CMD0_SDMS_RX1</span><span class="p">,</span> <span class="n">DEV_FLAGS_IN</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>  <span class="mh">0x10601004</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">AU1300_DSCR_CMD0_AES_RX</span><span class="p">,</span> <span class="n">DEV_FLAGS_IN</span> <span class="p">,</span>   <span class="mi">4</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mh">0x10300008</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_DSCR_CMD0_AES_TX</span><span class="p">,</span> <span class="n">DEV_FLAGS_OUT</span><span class="p">,</span>   <span class="mi">4</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mh">0x10300004</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">AU1300_DSCR_CMD0_PSC0_TX</span><span class="p">,</span> <span class="n">DEV_FLAGS_OUT</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0x10a0001c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_DSCR_CMD0_PSC0_RX</span><span class="p">,</span> <span class="n">DEV_FLAGS_IN</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0x10a0001c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_DSCR_CMD0_PSC1_TX</span><span class="p">,</span> <span class="n">DEV_FLAGS_OUT</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0x10a0101c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_DSCR_CMD0_PSC1_RX</span><span class="p">,</span> <span class="n">DEV_FLAGS_IN</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0x10a0101c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_DSCR_CMD0_PSC2_TX</span><span class="p">,</span> <span class="n">DEV_FLAGS_OUT</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0x10a0201c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_DSCR_CMD0_PSC2_RX</span><span class="p">,</span> <span class="n">DEV_FLAGS_IN</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0x10a0201c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_DSCR_CMD0_PSC3_TX</span><span class="p">,</span> <span class="n">DEV_FLAGS_OUT</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0x10a0301c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_DSCR_CMD0_PSC3_RX</span><span class="p">,</span> <span class="n">DEV_FLAGS_IN</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0x10a0301c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">AU1300_DSCR_CMD0_LCD</span><span class="p">,</span> <span class="n">DEV_FLAGS_ANYUSE</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mh">0x00000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_DSCR_CMD0_NAND_FLASH</span><span class="p">,</span> <span class="n">DEV_FLAGS_IN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">AU1300_DSCR_CMD0_SDMS_TX2</span><span class="p">,</span> <span class="n">DEV_FLAGS_OUT</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>  <span class="mh">0x10602000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_DSCR_CMD0_SDMS_RX2</span><span class="p">,</span> <span class="n">DEV_FLAGS_IN</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>  <span class="mh">0x10602004</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">AU1300_DSCR_CMD0_CIM_SYNC</span><span class="p">,</span> <span class="n">DEV_FLAGS_ANYUSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">AU1300_DSCR_CMD0_UDMA</span><span class="p">,</span> <span class="n">DEV_FLAGS_ANYUSE</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mh">0x14001810</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">AU1300_DSCR_CMD0_DMA_REQ0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AU1300_DSCR_CMD0_DMA_REQ1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">DSCR_CMD0_THROTTLE</span><span class="p">,</span> <span class="n">DEV_FLAGS_ANYUSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DSCR_CMD0_ALWAYS</span><span class="p">,</span>   <span class="n">DEV_FLAGS_ANYUSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* 32 predefined plus 32 custom */</span>
<span class="cp">#define DBDEV_TAB_SIZE		64</span>

<span class="k">static</span> <span class="n">chan_tab_t</span> <span class="o">*</span><span class="n">chan_tab_ptr</span><span class="p">[</span><span class="n">NUM_DBDMA_CHANS</span><span class="p">];</span>

<span class="k">static</span> <span class="n">dbdev_tab_t</span> <span class="o">*</span><span class="nf">find_dbdev_id</span><span class="p">(</span><span class="n">u32</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">dbdev_tab_t</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DBDEV_TAB_SIZE</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dbdev_tab</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev_id</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="o">*</span><span class="nf">au1xxx_ddma_get_nextptr_virt</span><span class="p">(</span><span class="n">au1x_ddma_desc_t</span> <span class="o">*</span><span class="n">dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">DSCR_GET_NXTPTR</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_nxtptr</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">au1xxx_ddma_get_nextptr_virt</span><span class="p">);</span>

<span class="n">u32</span> <span class="nf">au1xxx_ddma_add_device</span><span class="p">(</span><span class="n">dbdev_tab_t</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dbdev_tab_t</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u16</span> <span class="n">new_id</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">find_dbdev_id</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dbdev_tab_t</span><span class="p">));</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dev_id</span> <span class="o">=</span> <span class="n">DSCR_DEV2CUSTOM_ID</span><span class="p">(</span><span class="n">new_id</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">;</span>
		<span class="n">new_id</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		printk(KERN_DEBUG &quot;add_device: id:%x flags:%x padd:%x\n&quot;,</span>
<span class="c">				  p-&gt;dev_id, p-&gt;dev_flags, p-&gt;dev_physaddr);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">au1xxx_ddma_add_device</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">au1xxx_ddma_del_device</span><span class="p">(</span><span class="n">u32</span> <span class="n">devid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dbdev_tab_t</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">find_dbdev_id</span><span class="p">(</span><span class="n">devid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dbdev_tab_t</span><span class="p">));</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dev_id</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">au1xxx_ddma_del_device</span><span class="p">);</span>

<span class="cm">/* Allocate a channel and return a non-zero descriptor if successful. */</span>
<span class="n">u32</span> <span class="nf">au1xxx_dbdma_chan_alloc</span><span class="p">(</span><span class="n">u32</span> <span class="n">srcid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">destid</span><span class="p">,</span>
       <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">callparam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">used</span><span class="p">,</span> <span class="n">chan</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">dcp</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">i</span><span class="p">;</span>
	<span class="n">dbdev_tab_t</span>	<span class="o">*</span><span class="n">stp</span><span class="p">,</span> <span class="o">*</span><span class="n">dtp</span><span class="p">;</span>
	<span class="n">chan_tab_t</span>	<span class="o">*</span><span class="n">ctp</span><span class="p">;</span>
	<span class="n">au1x_dma_chan_t</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We do the intialization on the first channel allocation.</span>
<span class="cm">	 * We have to wait because of the interrupt handler initialization</span>
<span class="cm">	 * which can&#39;t be done successfully during board set up.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dbdma_initialized</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">stp</span> <span class="o">=</span> <span class="n">find_dbdev_id</span><span class="p">(</span><span class="n">srcid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dtp</span> <span class="o">=</span> <span class="n">find_dbdev_id</span><span class="p">(</span><span class="n">destid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dtp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Check to see if we can get both channels. */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">au1xxx_dbdma_spin_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">DEV_FLAGS_INUSE</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">DEV_FLAGS_ANYUSE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Got source */</span>
		<span class="n">stp</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">DEV_FLAGS_INUSE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dtp</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">DEV_FLAGS_INUSE</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">dtp</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">DEV_FLAGS_ANYUSE</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Got destination */</span>
			<span class="n">dtp</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">DEV_FLAGS_INUSE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Can&#39;t get dest.  Release src. */</span>
			<span class="n">stp</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DEV_FLAGS_INUSE</span><span class="p">;</span>
			<span class="n">used</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">used</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">au1xxx_dbdma_spin_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">used</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Let&#39;s see if we can allocate a channel for it. */</span>
	<span class="n">ctp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">au1xxx_dbdma_spin_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_DBDMA_CHANS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan_tab_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * If kmalloc fails, it is caught below same</span>
<span class="cm">			 * as a channel not available.</span>
<span class="cm">			 */</span>
			<span class="n">ctp</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">chan_tab_t</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="n">chan_tab_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctp</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">au1xxx_dbdma_spin_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">ctp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">chan_tab_t</span><span class="p">));</span>
		<span class="n">ctp</span><span class="o">-&gt;</span><span class="n">chan_index</span> <span class="o">=</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">dcp</span> <span class="o">=</span> <span class="n">KSEG1ADDR</span><span class="p">(</span><span class="n">AU1550_DBDMA_PHYS_ADDR</span><span class="p">);</span>
		<span class="n">dcp</span> <span class="o">+=</span> <span class="p">(</span><span class="mh">0x0100</span> <span class="o">*</span> <span class="n">chan</span><span class="p">);</span>
		<span class="n">ctp</span><span class="o">-&gt;</span><span class="n">chan_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">au1x_dma_chan_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dcp</span><span class="p">;</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="p">(</span><span class="n">au1x_dma_chan_t</span> <span class="o">*</span><span class="p">)</span><span class="n">dcp</span><span class="p">;</span>
		<span class="n">ctp</span><span class="o">-&gt;</span><span class="n">chan_src</span> <span class="o">=</span> <span class="n">stp</span><span class="p">;</span>
		<span class="n">ctp</span><span class="o">-&gt;</span><span class="n">chan_dest</span> <span class="o">=</span> <span class="n">dtp</span><span class="p">;</span>
		<span class="n">ctp</span><span class="o">-&gt;</span><span class="n">chan_callback</span> <span class="o">=</span> <span class="n">callback</span><span class="p">;</span>
		<span class="n">ctp</span><span class="o">-&gt;</span><span class="n">chan_callparam</span> <span class="o">=</span> <span class="n">callparam</span><span class="p">;</span>

		<span class="cm">/* Initialize channel configuration. */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">dev_intlevel</span><span class="p">)</span>
			<span class="n">i</span> <span class="o">|=</span> <span class="n">DDMA_CFG_SED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">dev_intpolarity</span><span class="p">)</span>
			<span class="n">i</span> <span class="o">|=</span> <span class="n">DDMA_CFG_SP</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dtp</span><span class="o">-&gt;</span><span class="n">dev_intlevel</span><span class="p">)</span>
			<span class="n">i</span> <span class="o">|=</span> <span class="n">DDMA_CFG_DED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dtp</span><span class="o">-&gt;</span><span class="n">dev_intpolarity</span><span class="p">)</span>
			<span class="n">i</span> <span class="o">|=</span> <span class="n">DDMA_CFG_DP</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">DEV_FLAGS_SYNC</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">dtp</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">DEV_FLAGS_SYNC</span><span class="p">))</span>
				<span class="n">i</span> <span class="o">|=</span> <span class="n">DDMA_CFG_SYNC</span><span class="p">;</span>
		<span class="n">cp</span><span class="o">-&gt;</span><span class="n">ddma_cfg</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">au_sync</span><span class="p">();</span>

		<span class="cm">/*</span>
<span class="cm">		 * Return a non-zero value that can be used to find the channel</span>
<span class="cm">		 * information in subsequent operations.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">chan_tab_ptr</span><span class="p">[</span><span class="n">chan</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* Release devices */</span>
	<span class="n">stp</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DEV_FLAGS_INUSE</span><span class="p">;</span>
	<span class="n">dtp</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DEV_FLAGS_INUSE</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">au1xxx_dbdma_chan_alloc</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Set the device width if source or destination is a FIFO.</span>
<span class="cm"> * Should be 8, 16, or 32 bits.</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">au1xxx_dbdma_set_devwidth</span><span class="p">(</span><span class="n">u32</span> <span class="n">chanid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>		<span class="n">rv</span><span class="p">;</span>
	<span class="n">chan_tab_t</span>	<span class="o">*</span><span class="n">ctp</span><span class="p">;</span>
	<span class="n">dbdev_tab_t</span>	<span class="o">*</span><span class="n">stp</span><span class="p">,</span> <span class="o">*</span><span class="n">dtp</span><span class="p">;</span>

	<span class="n">ctp</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">chan_tab_t</span> <span class="o">**</span><span class="p">)</span><span class="n">chanid</span><span class="p">);</span>
	<span class="n">stp</span> <span class="o">=</span> <span class="n">ctp</span><span class="o">-&gt;</span><span class="n">chan_src</span><span class="p">;</span>
	<span class="n">dtp</span> <span class="o">=</span> <span class="n">ctp</span><span class="o">-&gt;</span><span class="n">chan_dest</span><span class="p">;</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">DEV_FLAGS_IN</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Source in fifo */</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">stp</span><span class="o">-&gt;</span><span class="n">dev_devwidth</span><span class="p">;</span>
		<span class="n">stp</span><span class="o">-&gt;</span><span class="n">dev_devwidth</span> <span class="o">=</span> <span class="n">bits</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dtp</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">DEV_FLAGS_OUT</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Destination out fifo */</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">dtp</span><span class="o">-&gt;</span><span class="n">dev_devwidth</span><span class="p">;</span>
		<span class="n">dtp</span><span class="o">-&gt;</span><span class="n">dev_devwidth</span> <span class="o">=</span> <span class="n">bits</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">au1xxx_dbdma_set_devwidth</span><span class="p">);</span>

<span class="cm">/* Allocate a descriptor ring, initializing as much as possible. */</span>
<span class="n">u32</span> <span class="nf">au1xxx_dbdma_ring_alloc</span><span class="p">(</span><span class="n">u32</span> <span class="n">chanid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">entries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">desc_base</span><span class="p">,</span> <span class="n">srcid</span><span class="p">,</span> <span class="n">destid</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">cmd0</span><span class="p">,</span> <span class="n">cmd1</span><span class="p">,</span> <span class="n">src1</span><span class="p">,</span> <span class="n">dest1</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">src0</span><span class="p">,</span> <span class="n">dest0</span><span class="p">;</span>
	<span class="n">chan_tab_t</span>		<span class="o">*</span><span class="n">ctp</span><span class="p">;</span>
	<span class="n">dbdev_tab_t</span>		<span class="o">*</span><span class="n">stp</span><span class="p">,</span> <span class="o">*</span><span class="n">dtp</span><span class="p">;</span>
	<span class="n">au1x_ddma_desc_t</span>	<span class="o">*</span><span class="n">dp</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * I guess we could check this to be within the</span>
<span class="cm">	 * range of the table......</span>
<span class="cm">	 */</span>
	<span class="n">ctp</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">chan_tab_t</span> <span class="o">**</span><span class="p">)</span><span class="n">chanid</span><span class="p">);</span>
	<span class="n">stp</span> <span class="o">=</span> <span class="n">ctp</span><span class="o">-&gt;</span><span class="n">chan_src</span><span class="p">;</span>
	<span class="n">dtp</span> <span class="o">=</span> <span class="n">ctp</span><span class="o">-&gt;</span><span class="n">chan_dest</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The descriptors must be 32-byte aligned.  There is a</span>
<span class="cm">	 * possibility the allocation will give us such an address,</span>
<span class="cm">	 * and if we try that first we are likely to not waste larger</span>
<span class="cm">	 * slabs of memory.</span>
<span class="cm">	 */</span>
	<span class="n">desc_base</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">kmalloc</span><span class="p">(</span><span class="n">entries</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">au1x_ddma_desc_t</span><span class="p">),</span>
				 <span class="n">GFP_KERNEL</span><span class="o">|</span><span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc_base</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">desc_base</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Lost....do it again, allocate extra, and round</span>
<span class="cm">		 * the address base.</span>
<span class="cm">		 */</span>
		<span class="n">kfree</span><span class="p">((</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">desc_base</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">entries</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">au1x_ddma_desc_t</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">au1x_ddma_desc_t</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">desc_base</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">kmalloc</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="o">|</span><span class="n">GFP_DMA</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">desc_base</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ctp</span><span class="o">-&gt;</span><span class="n">cdb_membase</span> <span class="o">=</span> <span class="n">desc_base</span><span class="p">;</span>
		<span class="n">desc_base</span> <span class="o">=</span> <span class="n">ALIGN_ADDR</span><span class="p">(</span><span class="n">desc_base</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">au1x_ddma_desc_t</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ctp</span><span class="o">-&gt;</span><span class="n">cdb_membase</span> <span class="o">=</span> <span class="n">desc_base</span><span class="p">;</span>

	<span class="n">dp</span> <span class="o">=</span> <span class="p">(</span><span class="n">au1x_ddma_desc_t</span> <span class="o">*</span><span class="p">)</span><span class="n">desc_base</span><span class="p">;</span>

	<span class="cm">/* Keep track of the base descriptor. */</span>
	<span class="n">ctp</span><span class="o">-&gt;</span><span class="n">chan_desc_base</span> <span class="o">=</span> <span class="n">dp</span><span class="p">;</span>

	<span class="cm">/* Initialize the rings with as much information as we know. */</span>
	<span class="n">srcid</span> <span class="o">=</span> <span class="n">stp</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">;</span>
	<span class="n">destid</span> <span class="o">=</span> <span class="n">dtp</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">;</span>

	<span class="n">cmd0</span> <span class="o">=</span> <span class="n">cmd1</span> <span class="o">=</span> <span class="n">src1</span> <span class="o">=</span> <span class="n">dest1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">src0</span> <span class="o">=</span> <span class="n">dest0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cmd0</span> <span class="o">|=</span> <span class="n">DSCR_CMD0_SID</span><span class="p">(</span><span class="n">srcid</span><span class="p">);</span>
	<span class="n">cmd0</span> <span class="o">|=</span> <span class="n">DSCR_CMD0_DID</span><span class="p">(</span><span class="n">destid</span><span class="p">);</span>
	<span class="n">cmd0</span> <span class="o">|=</span> <span class="n">DSCR_CMD0_IE</span> <span class="o">|</span> <span class="n">DSCR_CMD0_CV</span><span class="p">;</span>
	<span class="n">cmd0</span> <span class="o">|=</span> <span class="n">DSCR_CMD0_ST</span><span class="p">(</span><span class="n">DSCR_CMD0_ST_NOCHANGE</span><span class="p">);</span>

	<span class="cm">/* Is it mem to mem transfer? */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">DSCR_CUSTOM2DEV_ID</span><span class="p">(</span><span class="n">srcid</span><span class="p">)</span> <span class="o">==</span> <span class="n">DSCR_CMD0_THROTTLE</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">DSCR_CUSTOM2DEV_ID</span><span class="p">(</span><span class="n">srcid</span><span class="p">)</span> <span class="o">==</span> <span class="n">DSCR_CMD0_ALWAYS</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">DSCR_CUSTOM2DEV_ID</span><span class="p">(</span><span class="n">destid</span><span class="p">)</span> <span class="o">==</span> <span class="n">DSCR_CMD0_THROTTLE</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">DSCR_CUSTOM2DEV_ID</span><span class="p">(</span><span class="n">destid</span><span class="p">)</span> <span class="o">==</span> <span class="n">DSCR_CMD0_ALWAYS</span><span class="p">)))</span>
		<span class="n">cmd0</span> <span class="o">|=</span> <span class="n">DSCR_CMD0_MEM</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">dev_devwidth</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">cmd0</span> <span class="o">|=</span> <span class="n">DSCR_CMD0_SW</span><span class="p">(</span><span class="n">DSCR_CMD0_BYTE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">cmd0</span> <span class="o">|=</span> <span class="n">DSCR_CMD0_SW</span><span class="p">(</span><span class="n">DSCR_CMD0_HALFWORD</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
	<span class="nl">default:</span>
		<span class="n">cmd0</span> <span class="o">|=</span> <span class="n">DSCR_CMD0_SW</span><span class="p">(</span><span class="n">DSCR_CMD0_WORD</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dtp</span><span class="o">-&gt;</span><span class="n">dev_devwidth</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">cmd0</span> <span class="o">|=</span> <span class="n">DSCR_CMD0_DW</span><span class="p">(</span><span class="n">DSCR_CMD0_BYTE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">cmd0</span> <span class="o">|=</span> <span class="n">DSCR_CMD0_DW</span><span class="p">(</span><span class="n">DSCR_CMD0_HALFWORD</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
	<span class="nl">default:</span>
		<span class="n">cmd0</span> <span class="o">|=</span> <span class="n">DSCR_CMD0_DW</span><span class="p">(</span><span class="n">DSCR_CMD0_WORD</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the device is marked as an in/out FIFO, ensure it is</span>
<span class="cm">	 * set non-coherent.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">DEV_FLAGS_IN</span><span class="p">)</span>
		<span class="n">cmd0</span> <span class="o">|=</span> <span class="n">DSCR_CMD0_SN</span><span class="p">;</span>		<span class="cm">/* Source in FIFO */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dtp</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">DEV_FLAGS_OUT</span><span class="p">)</span>
		<span class="n">cmd0</span> <span class="o">|=</span> <span class="n">DSCR_CMD0_DN</span><span class="p">;</span>		<span class="cm">/* Destination out FIFO */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up source1.  For now, assume no stride and increment.</span>
<span class="cm">	 * A channel attribute update can change this later.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">dev_tsize</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">src1</span> <span class="o">|=</span> <span class="n">DSCR_SRC1_STS</span><span class="p">(</span><span class="n">DSCR_xTS_SIZE1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">src1</span> <span class="o">|=</span> <span class="n">DSCR_SRC1_STS</span><span class="p">(</span><span class="n">DSCR_xTS_SIZE2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">src1</span> <span class="o">|=</span> <span class="n">DSCR_SRC1_STS</span><span class="p">(</span><span class="n">DSCR_xTS_SIZE4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
	<span class="nl">default:</span>
		<span class="n">src1</span> <span class="o">|=</span> <span class="n">DSCR_SRC1_STS</span><span class="p">(</span><span class="n">DSCR_xTS_SIZE8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If source input is FIFO, set static address.	*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">DEV_FLAGS_IN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">DEV_FLAGS_BURSTABLE</span><span class="p">)</span>
			<span class="n">src1</span> <span class="o">|=</span> <span class="n">DSCR_SRC1_SAM</span><span class="p">(</span><span class="n">DSCR_xAM_BURST</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">src1</span> <span class="o">|=</span> <span class="n">DSCR_SRC1_SAM</span><span class="p">(</span><span class="n">DSCR_xAM_STATIC</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stp</span><span class="o">-&gt;</span><span class="n">dev_physaddr</span><span class="p">)</span>
		<span class="n">src0</span> <span class="o">=</span> <span class="n">stp</span><span class="o">-&gt;</span><span class="n">dev_physaddr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up dest1.  For now, assume no stride and increment.</span>
<span class="cm">	 * A channel attribute update can change this later.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dtp</span><span class="o">-&gt;</span><span class="n">dev_tsize</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">dest1</span> <span class="o">|=</span> <span class="n">DSCR_DEST1_DTS</span><span class="p">(</span><span class="n">DSCR_xTS_SIZE1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">dest1</span> <span class="o">|=</span> <span class="n">DSCR_DEST1_DTS</span><span class="p">(</span><span class="n">DSCR_xTS_SIZE2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">dest1</span> <span class="o">|=</span> <span class="n">DSCR_DEST1_DTS</span><span class="p">(</span><span class="n">DSCR_xTS_SIZE4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
	<span class="nl">default:</span>
		<span class="n">dest1</span> <span class="o">|=</span> <span class="n">DSCR_DEST1_DTS</span><span class="p">(</span><span class="n">DSCR_xTS_SIZE8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If destination output is FIFO, set static address. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dtp</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">DEV_FLAGS_OUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dtp</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">DEV_FLAGS_BURSTABLE</span><span class="p">)</span>
			<span class="n">dest1</span> <span class="o">|=</span> <span class="n">DSCR_DEST1_DAM</span><span class="p">(</span><span class="n">DSCR_xAM_BURST</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dest1</span> <span class="o">|=</span> <span class="n">DSCR_DEST1_DAM</span><span class="p">(</span><span class="n">DSCR_xAM_STATIC</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dtp</span><span class="o">-&gt;</span><span class="n">dev_physaddr</span><span class="p">)</span>
		<span class="n">dest0</span> <span class="o">=</span> <span class="n">dtp</span><span class="o">-&gt;</span><span class="n">dev_physaddr</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		printk(KERN_DEBUG &quot;did:%x sid:%x cmd0:%x cmd1:%x source0:%x &quot;</span>
<span class="c">				  &quot;source1:%x dest0:%x dest1:%x\n&quot;,</span>
<span class="c">				  dtp-&gt;dev_id, stp-&gt;dev_id, cmd0, cmd1, src0,</span>
<span class="c">				  src1, dest0, dest1);</span>
<span class="cp">#endif</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_cmd0</span> <span class="o">=</span> <span class="n">cmd0</span><span class="p">;</span>
		<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_cmd1</span> <span class="o">=</span> <span class="n">cmd1</span><span class="p">;</span>
		<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_source0</span> <span class="o">=</span> <span class="n">src0</span><span class="p">;</span>
		<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_source1</span> <span class="o">=</span> <span class="n">src1</span><span class="p">;</span>
		<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_dest0</span> <span class="o">=</span> <span class="n">dest0</span><span class="p">;</span>
		<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_dest1</span> <span class="o">=</span> <span class="n">dest1</span><span class="p">;</span>
		<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dp</span><span class="o">-&gt;</span><span class="n">sw_context</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dp</span><span class="o">-&gt;</span><span class="n">sw_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_nxtptr</span> <span class="o">=</span> <span class="n">DSCR_NXTPTR</span><span class="p">(</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="n">dp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">dp</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Make last descrptor point to the first. */</span>
	<span class="n">dp</span><span class="o">--</span><span class="p">;</span>
	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_nxtptr</span> <span class="o">=</span> <span class="n">DSCR_NXTPTR</span><span class="p">(</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="n">ctp</span><span class="o">-&gt;</span><span class="n">chan_desc_base</span><span class="p">));</span>
	<span class="n">ctp</span><span class="o">-&gt;</span><span class="n">get_ptr</span> <span class="o">=</span> <span class="n">ctp</span><span class="o">-&gt;</span><span class="n">put_ptr</span> <span class="o">=</span> <span class="n">ctp</span><span class="o">-&gt;</span><span class="n">cur_ptr</span> <span class="o">=</span> <span class="n">ctp</span><span class="o">-&gt;</span><span class="n">chan_desc_base</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">ctp</span><span class="o">-&gt;</span><span class="n">chan_desc_base</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">au1xxx_dbdma_ring_alloc</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Put a source buffer into the DMA ring.</span>
<span class="cm"> * This updates the source pointer and byte count.  Normally used</span>
<span class="cm"> * for memory to fifo transfers.</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">au1xxx_dbdma_put_source</span><span class="p">(</span><span class="n">u32</span> <span class="n">chanid</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chan_tab_t</span>		<span class="o">*</span><span class="n">ctp</span><span class="p">;</span>
	<span class="n">au1x_ddma_desc_t</span>	<span class="o">*</span><span class="n">dp</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * I guess we could check this to be within the</span>
<span class="cm">	 * range of the table......</span>
<span class="cm">	 */</span>
	<span class="n">ctp</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">chan_tab_t</span> <span class="o">**</span><span class="p">)</span><span class="n">chanid</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We should have multiple callers for a particular channel,</span>
<span class="cm">	 * an interrupt doesn&#39;t affect this pointer nor the descriptor,</span>
<span class="cm">	 * so no locking should be needed.</span>
<span class="cm">	 */</span>
	<span class="n">dp</span> <span class="o">=</span> <span class="n">ctp</span><span class="o">-&gt;</span><span class="n">put_ptr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the descriptor is valid, we are way ahead of the DMA</span>
<span class="cm">	 * engine, so just return an error condition.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_cmd0</span> <span class="o">&amp;</span> <span class="n">DSCR_CMD0_V</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Load up buffer address and byte count. */</span>
	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_source0</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">0UL</span><span class="p">;</span>
	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_cmd1</span> <span class="o">=</span> <span class="n">nbytes</span><span class="p">;</span>
	<span class="cm">/* Check flags */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DDMA_FLAGS_IE</span><span class="p">)</span>
		<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_cmd0</span> <span class="o">|=</span> <span class="n">DSCR_CMD0_IE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DDMA_FLAGS_NOIE</span><span class="p">)</span>
		<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_cmd0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DSCR_CMD0_IE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * There is an errata on the Au1200/Au1550 parts that could result</span>
<span class="cm">	 * in &quot;stale&quot; data being DMA&#39;ed. It has to do with the snoop logic on</span>
<span class="cm">	 * the cache eviction buffer.  DMA_NONCOHERENT is on by default for</span>
<span class="cm">	 * these parts. If it is fixed in the future, these dma_cache_inv will</span>
<span class="cm">	 * just be nothing more than empty macros. See io.h.</span>
<span class="cm">	 */</span>
	<span class="n">dma_cache_wback_inv</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">);</span>
	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_cmd0</span> <span class="o">|=</span> <span class="n">DSCR_CMD0_V</span><span class="p">;</span>	<span class="cm">/* Let it rip */</span>
	<span class="n">au_sync</span><span class="p">();</span>
	<span class="n">dma_cache_wback_inv</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dp</span><span class="p">));</span>
	<span class="n">ctp</span><span class="o">-&gt;</span><span class="n">chan_ptr</span><span class="o">-&gt;</span><span class="n">ddma_dbell</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Get next descriptor pointer.	*/</span>
	<span class="n">ctp</span><span class="o">-&gt;</span><span class="n">put_ptr</span> <span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">DSCR_GET_NXTPTR</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_nxtptr</span><span class="p">));</span>

	<span class="cm">/* Return something non-zero. */</span>
	<span class="k">return</span> <span class="n">nbytes</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">au1xxx_dbdma_put_source</span><span class="p">);</span>

<span class="cm">/* Put a destination buffer into the DMA ring.</span>
<span class="cm"> * This updates the destination pointer and byte count.  Normally used</span>
<span class="cm"> * to place an empty buffer into the ring for fifo to memory transfers.</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">au1xxx_dbdma_put_dest</span><span class="p">(</span><span class="n">u32</span> <span class="n">chanid</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chan_tab_t</span>		<span class="o">*</span><span class="n">ctp</span><span class="p">;</span>
	<span class="n">au1x_ddma_desc_t</span>	<span class="o">*</span><span class="n">dp</span><span class="p">;</span>

	<span class="cm">/* I guess we could check this to be within the</span>
<span class="cm">	 * range of the table......</span>
<span class="cm">	 */</span>
	<span class="n">ctp</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">chan_tab_t</span> <span class="o">**</span><span class="p">)</span><span class="n">chanid</span><span class="p">);</span>

	<span class="cm">/* We should have multiple callers for a particular channel,</span>
<span class="cm">	 * an interrupt doesn&#39;t affect this pointer nor the descriptor,</span>
<span class="cm">	 * so no locking should be needed.</span>
<span class="cm">	 */</span>
	<span class="n">dp</span> <span class="o">=</span> <span class="n">ctp</span><span class="o">-&gt;</span><span class="n">put_ptr</span><span class="p">;</span>

	<span class="cm">/* If the descriptor is valid, we are way ahead of the DMA</span>
<span class="cm">	 * engine, so just return an error condition.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_cmd0</span> <span class="o">&amp;</span> <span class="n">DSCR_CMD0_V</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Load up buffer address and byte count */</span>

	<span class="cm">/* Check flags  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DDMA_FLAGS_IE</span><span class="p">)</span>
		<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_cmd0</span> <span class="o">|=</span> <span class="n">DSCR_CMD0_IE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DDMA_FLAGS_NOIE</span><span class="p">)</span>
		<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_cmd0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DSCR_CMD0_IE</span><span class="p">;</span>

	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_dest0</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">0UL</span><span class="p">;</span>
	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_cmd1</span> <span class="o">=</span> <span class="n">nbytes</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	printk(KERN_DEBUG &quot;cmd0:%x cmd1:%x source0:%x source1:%x dest0:%x dest1:%x\n&quot;,</span>
<span class="c">			  dp-&gt;dscr_cmd0, dp-&gt;dscr_cmd1, dp-&gt;dscr_source0,</span>
<span class="c">			  dp-&gt;dscr_source1, dp-&gt;dscr_dest0, dp-&gt;dscr_dest1);</span>
<span class="cp">#endif</span>
	<span class="cm">/*</span>
<span class="cm">	 * There is an errata on the Au1200/Au1550 parts that could result in</span>
<span class="cm">	 * &quot;stale&quot; data being DMA&#39;ed. It has to do with the snoop logic on the</span>
<span class="cm">	 * cache eviction buffer.  DMA_NONCOHERENT is on by default for these</span>
<span class="cm">	 * parts. If it is fixed in the future, these dma_cache_inv will just</span>
<span class="cm">	 * be nothing more than empty macros. See io.h.</span>
<span class="cm">	 */</span>
	<span class="n">dma_cache_inv</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">);</span>
	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_cmd0</span> <span class="o">|=</span> <span class="n">DSCR_CMD0_V</span><span class="p">;</span>	<span class="cm">/* Let it rip */</span>
	<span class="n">au_sync</span><span class="p">();</span>
	<span class="n">dma_cache_wback_inv</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dp</span><span class="p">));</span>
	<span class="n">ctp</span><span class="o">-&gt;</span><span class="n">chan_ptr</span><span class="o">-&gt;</span><span class="n">ddma_dbell</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Get next descriptor pointer.	*/</span>
	<span class="n">ctp</span><span class="o">-&gt;</span><span class="n">put_ptr</span> <span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">DSCR_GET_NXTPTR</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_nxtptr</span><span class="p">));</span>

	<span class="cm">/* Return something non-zero. */</span>
	<span class="k">return</span> <span class="n">nbytes</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">au1xxx_dbdma_put_dest</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Get a destination buffer into the DMA ring.</span>
<span class="cm"> * Normally used to get a full buffer from the ring during fifo</span>
<span class="cm"> * to memory transfers.  This does not set the valid bit, you will</span>
<span class="cm"> * have to put another destination buffer to keep the DMA going.</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">au1xxx_dbdma_get_dest</span><span class="p">(</span><span class="n">u32</span> <span class="n">chanid</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">nbytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chan_tab_t</span>		<span class="o">*</span><span class="n">ctp</span><span class="p">;</span>
	<span class="n">au1x_ddma_desc_t</span>	<span class="o">*</span><span class="n">dp</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">rv</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * I guess we could check this to be within the</span>
<span class="cm">	 * range of the table......</span>
<span class="cm">	 */</span>
	<span class="n">ctp</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">chan_tab_t</span> <span class="o">**</span><span class="p">)</span><span class="n">chanid</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We should have multiple callers for a particular channel,</span>
<span class="cm">	 * an interrupt doesn&#39;t affect this pointer nor the descriptor,</span>
<span class="cm">	 * so no locking should be needed.</span>
<span class="cm">	 */</span>
	<span class="n">dp</span> <span class="o">=</span> <span class="n">ctp</span><span class="o">-&gt;</span><span class="n">get_ptr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the descriptor is valid, we are way ahead of the DMA</span>
<span class="cm">	 * engine, so just return an error condition.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_cmd0</span> <span class="o">&amp;</span> <span class="n">DSCR_CMD0_V</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Return buffer address and byte count. */</span>
	<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">phys_to_virt</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_dest0</span><span class="p">));</span>
	<span class="o">*</span><span class="n">nbytes</span> <span class="o">=</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_cmd1</span><span class="p">;</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_stat</span><span class="p">;</span>

	<span class="cm">/* Get next descriptor pointer.	*/</span>
	<span class="n">ctp</span><span class="o">-&gt;</span><span class="n">get_ptr</span> <span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">DSCR_GET_NXTPTR</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_nxtptr</span><span class="p">));</span>

	<span class="cm">/* Return something non-zero. */</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">au1xxx_dbdma_get_dest</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">au1xxx_dbdma_stop</span><span class="p">(</span><span class="n">u32</span> <span class="n">chanid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chan_tab_t</span>	<span class="o">*</span><span class="n">ctp</span><span class="p">;</span>
	<span class="n">au1x_dma_chan_t</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">halt_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ctp</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">chan_tab_t</span> <span class="o">**</span><span class="p">)</span><span class="n">chanid</span><span class="p">);</span>

	<span class="n">cp</span> <span class="o">=</span> <span class="n">ctp</span><span class="o">-&gt;</span><span class="n">chan_ptr</span><span class="p">;</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">ddma_cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DDMA_CFG_EN</span><span class="p">;</span>	<span class="cm">/* Disable channel */</span>
	<span class="n">au_sync</span><span class="p">();</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">ddma_stat</span> <span class="o">&amp;</span> <span class="n">DDMA_STAT_H</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">halt_timeout</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">halt_timeout</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;warning: DMA channel won&#39;t halt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* clear current desc valid and doorbell */</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">ddma_stat</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DDMA_STAT_DB</span> <span class="o">|</span> <span class="n">DDMA_STAT_V</span><span class="p">);</span>
	<span class="n">au_sync</span><span class="p">();</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">au1xxx_dbdma_stop</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Start using the current descriptor pointer.  If the DBDMA encounters</span>
<span class="cm"> * a non-valid descriptor, it will stop.  In this case, we can just</span>
<span class="cm"> * continue by adding a buffer to the list and starting again.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">au1xxx_dbdma_start</span><span class="p">(</span><span class="n">u32</span> <span class="n">chanid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chan_tab_t</span>	<span class="o">*</span><span class="n">ctp</span><span class="p">;</span>
	<span class="n">au1x_dma_chan_t</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>

	<span class="n">ctp</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">chan_tab_t</span> <span class="o">**</span><span class="p">)</span><span class="n">chanid</span><span class="p">);</span>
	<span class="n">cp</span> <span class="o">=</span> <span class="n">ctp</span><span class="o">-&gt;</span><span class="n">chan_ptr</span><span class="p">;</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">ddma_desptr</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">ctp</span><span class="o">-&gt;</span><span class="n">cur_ptr</span><span class="p">);</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">ddma_cfg</span> <span class="o">|=</span> <span class="n">DDMA_CFG_EN</span><span class="p">;</span>	<span class="cm">/* Enable channel */</span>
	<span class="n">au_sync</span><span class="p">();</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">ddma_dbell</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">au_sync</span><span class="p">();</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">au1xxx_dbdma_start</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">au1xxx_dbdma_reset</span><span class="p">(</span><span class="n">u32</span> <span class="n">chanid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chan_tab_t</span>		<span class="o">*</span><span class="n">ctp</span><span class="p">;</span>
	<span class="n">au1x_ddma_desc_t</span>	<span class="o">*</span><span class="n">dp</span><span class="p">;</span>

	<span class="n">au1xxx_dbdma_stop</span><span class="p">(</span><span class="n">chanid</span><span class="p">);</span>

	<span class="n">ctp</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">chan_tab_t</span> <span class="o">**</span><span class="p">)</span><span class="n">chanid</span><span class="p">);</span>
	<span class="n">ctp</span><span class="o">-&gt;</span><span class="n">get_ptr</span> <span class="o">=</span> <span class="n">ctp</span><span class="o">-&gt;</span><span class="n">put_ptr</span> <span class="o">=</span> <span class="n">ctp</span><span class="o">-&gt;</span><span class="n">cur_ptr</span> <span class="o">=</span> <span class="n">ctp</span><span class="o">-&gt;</span><span class="n">chan_desc_base</span><span class="p">;</span>

	<span class="cm">/* Run through the descriptors and reset the valid indicator. */</span>
	<span class="n">dp</span> <span class="o">=</span> <span class="n">ctp</span><span class="o">-&gt;</span><span class="n">chan_desc_base</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_cmd0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DSCR_CMD0_V</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Reset our software status -- this is used to determine</span>
<span class="cm">		 * if a descriptor is in use by upper level software. Since</span>
<span class="cm">		 * posting can reset &#39;V&#39; bit.</span>
<span class="cm">		 */</span>
		<span class="n">dp</span><span class="o">-&gt;</span><span class="n">sw_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dp</span> <span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">DSCR_GET_NXTPTR</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_nxtptr</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">dp</span> <span class="o">!=</span> <span class="n">ctp</span><span class="o">-&gt;</span><span class="n">chan_desc_base</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">au1xxx_dbdma_reset</span><span class="p">);</span>

<span class="n">u32</span> <span class="nf">au1xxx_get_dma_residue</span><span class="p">(</span><span class="n">u32</span> <span class="n">chanid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chan_tab_t</span>	<span class="o">*</span><span class="n">ctp</span><span class="p">;</span>
	<span class="n">au1x_dma_chan_t</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">rv</span><span class="p">;</span>

	<span class="n">ctp</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">chan_tab_t</span> <span class="o">**</span><span class="p">)</span><span class="n">chanid</span><span class="p">);</span>
	<span class="n">cp</span> <span class="o">=</span> <span class="n">ctp</span><span class="o">-&gt;</span><span class="n">chan_ptr</span><span class="p">;</span>

	<span class="cm">/* This is only valid if the channel is stopped. */</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">ddma_bytecnt</span><span class="p">;</span>
	<span class="n">au_sync</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">au1xxx_get_dma_residue</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">au1xxx_dbdma_chan_free</span><span class="p">(</span><span class="n">u32</span> <span class="n">chanid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chan_tab_t</span>	<span class="o">*</span><span class="n">ctp</span><span class="p">;</span>
	<span class="n">dbdev_tab_t</span>	<span class="o">*</span><span class="n">stp</span><span class="p">,</span> <span class="o">*</span><span class="n">dtp</span><span class="p">;</span>

	<span class="n">ctp</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">chan_tab_t</span> <span class="o">**</span><span class="p">)</span><span class="n">chanid</span><span class="p">);</span>
	<span class="n">stp</span> <span class="o">=</span> <span class="n">ctp</span><span class="o">-&gt;</span><span class="n">chan_src</span><span class="p">;</span>
	<span class="n">dtp</span> <span class="o">=</span> <span class="n">ctp</span><span class="o">-&gt;</span><span class="n">chan_dest</span><span class="p">;</span>

	<span class="n">au1xxx_dbdma_stop</span><span class="p">(</span><span class="n">chanid</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ctp</span><span class="o">-&gt;</span><span class="n">cdb_membase</span><span class="p">);</span>

	<span class="n">stp</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DEV_FLAGS_INUSE</span><span class="p">;</span>
	<span class="n">dtp</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DEV_FLAGS_INUSE</span><span class="p">;</span>
	<span class="n">chan_tab_ptr</span><span class="p">[</span><span class="n">ctp</span><span class="o">-&gt;</span><span class="n">chan_index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ctp</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">au1xxx_dbdma_chan_free</span><span class="p">);</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">dbdma_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">intstat</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">chan_index</span><span class="p">;</span>
	<span class="n">chan_tab_t</span>		<span class="o">*</span><span class="n">ctp</span><span class="p">;</span>
	<span class="n">au1x_ddma_desc_t</span>	<span class="o">*</span><span class="n">dp</span><span class="p">;</span>
	<span class="n">au1x_dma_chan_t</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>

	<span class="n">intstat</span> <span class="o">=</span> <span class="n">dbdma_gptr</span><span class="o">-&gt;</span><span class="n">ddma_intstat</span><span class="p">;</span>
	<span class="n">au_sync</span><span class="p">();</span>
	<span class="n">chan_index</span> <span class="o">=</span> <span class="n">__ffs</span><span class="p">(</span><span class="n">intstat</span><span class="p">);</span>

	<span class="n">ctp</span> <span class="o">=</span> <span class="n">chan_tab_ptr</span><span class="p">[</span><span class="n">chan_index</span><span class="p">];</span>
	<span class="n">cp</span> <span class="o">=</span> <span class="n">ctp</span><span class="o">-&gt;</span><span class="n">chan_ptr</span><span class="p">;</span>
	<span class="n">dp</span> <span class="o">=</span> <span class="n">ctp</span><span class="o">-&gt;</span><span class="n">cur_ptr</span><span class="p">;</span>

	<span class="cm">/* Reset interrupt. */</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">ddma_irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">au_sync</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctp</span><span class="o">-&gt;</span><span class="n">chan_callback</span><span class="p">)</span>
		<span class="n">ctp</span><span class="o">-&gt;</span><span class="n">chan_callback</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">ctp</span><span class="o">-&gt;</span><span class="n">chan_callparam</span><span class="p">);</span>

	<span class="n">ctp</span><span class="o">-&gt;</span><span class="n">cur_ptr</span> <span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">DSCR_GET_NXTPTR</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_nxtptr</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">au1xxx_dbdma_dump</span><span class="p">(</span><span class="n">u32</span> <span class="n">chanid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chan_tab_t</span>	 <span class="o">*</span><span class="n">ctp</span><span class="p">;</span>
	<span class="n">au1x_ddma_desc_t</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>
	<span class="n">dbdev_tab_t</span>	 <span class="o">*</span><span class="n">stp</span><span class="p">,</span> <span class="o">*</span><span class="n">dtp</span><span class="p">;</span>
	<span class="n">au1x_dma_chan_t</span>  <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span>		 <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ctp</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">chan_tab_t</span> <span class="o">**</span><span class="p">)</span><span class="n">chanid</span><span class="p">);</span>
	<span class="n">stp</span> <span class="o">=</span> <span class="n">ctp</span><span class="o">-&gt;</span><span class="n">chan_src</span><span class="p">;</span>
	<span class="n">dtp</span> <span class="o">=</span> <span class="n">ctp</span><span class="o">-&gt;</span><span class="n">chan_dest</span><span class="p">;</span>
	<span class="n">cp</span> <span class="o">=</span> <span class="n">ctp</span><span class="o">-&gt;</span><span class="n">chan_ptr</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Chan %x, stp %x (dev %d)  dtp %x (dev %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">ctp</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">stp</span><span class="p">,</span> <span class="n">stp</span> <span class="o">-</span> <span class="n">dbdev_tab</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">dtp</span><span class="p">,</span>
			  <span class="n">dtp</span> <span class="o">-</span> <span class="n">dbdev_tab</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;desc base %x, get %x, put %x, cur %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">ctp</span><span class="o">-&gt;</span><span class="n">chan_desc_base</span><span class="p">),</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">ctp</span><span class="o">-&gt;</span><span class="n">get_ptr</span><span class="p">),</span>
			  <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">ctp</span><span class="o">-&gt;</span><span class="n">put_ptr</span><span class="p">),</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">ctp</span><span class="o">-&gt;</span><span class="n">cur_ptr</span><span class="p">));</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;dbdma chan %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cp</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cfg %08x, desptr %08x, statptr %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">cp</span><span class="o">-&gt;</span><span class="n">ddma_cfg</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">ddma_desptr</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">ddma_statptr</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;dbell %08x, irq %08x, stat %08x, bytecnt %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">cp</span><span class="o">-&gt;</span><span class="n">ddma_dbell</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">ddma_irq</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">ddma_stat</span><span class="p">,</span>
			  <span class="n">cp</span><span class="o">-&gt;</span><span class="n">ddma_bytecnt</span><span class="p">);</span>

	<span class="cm">/* Run through the descriptors */</span>
	<span class="n">dp</span> <span class="o">=</span> <span class="n">ctp</span><span class="o">-&gt;</span><span class="n">chan_desc_base</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Dp[%d]= %08x, cmd0 %08x, cmd1 %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">dp</span><span class="p">,</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_cmd0</span><span class="p">,</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_cmd1</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;src0 %08x, src1 %08x, dest0 %08x, dest1 %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_source0</span><span class="p">,</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_source1</span><span class="p">,</span>
				  <span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_dest0</span><span class="p">,</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_dest1</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;stat %08x, nxtptr %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_stat</span><span class="p">,</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_nxtptr</span><span class="p">);</span>
		<span class="n">dp</span> <span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">DSCR_GET_NXTPTR</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_nxtptr</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">dp</span> <span class="o">!=</span> <span class="n">ctp</span><span class="o">-&gt;</span><span class="n">chan_desc_base</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Put a descriptor into the DMA ring.</span>
<span class="cm"> * This updates the source/destination pointers and byte count.</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">au1xxx_dbdma_put_dscr</span><span class="p">(</span><span class="n">u32</span> <span class="n">chanid</span><span class="p">,</span> <span class="n">au1x_ddma_desc_t</span> <span class="o">*</span><span class="n">dscr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chan_tab_t</span> <span class="o">*</span><span class="n">ctp</span><span class="p">;</span>
	<span class="n">au1x_ddma_desc_t</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nbytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * I guess we could check this to be within the</span>
<span class="cm">	 * range of the table......</span>
<span class="cm">	 */</span>
	<span class="n">ctp</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">chan_tab_t</span> <span class="o">**</span><span class="p">)</span><span class="n">chanid</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We should have multiple callers for a particular channel,</span>
<span class="cm">	 * an interrupt doesn&#39;t affect this pointer nor the descriptor,</span>
<span class="cm">	 * so no locking should be needed.</span>
<span class="cm">	 */</span>
	<span class="n">dp</span> <span class="o">=</span> <span class="n">ctp</span><span class="o">-&gt;</span><span class="n">put_ptr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the descriptor is valid, we are way ahead of the DMA</span>
<span class="cm">	 * engine, so just return an error condition.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_cmd0</span> <span class="o">&amp;</span> <span class="n">DSCR_CMD0_V</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Load up buffer addresses and byte count. */</span>
	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_dest0</span> <span class="o">=</span> <span class="n">dscr</span><span class="o">-&gt;</span><span class="n">dscr_dest0</span><span class="p">;</span>
	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_source0</span> <span class="o">=</span> <span class="n">dscr</span><span class="o">-&gt;</span><span class="n">dscr_source0</span><span class="p">;</span>
	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_dest1</span> <span class="o">=</span> <span class="n">dscr</span><span class="o">-&gt;</span><span class="n">dscr_dest1</span><span class="p">;</span>
	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_source1</span> <span class="o">=</span> <span class="n">dscr</span><span class="o">-&gt;</span><span class="n">dscr_source1</span><span class="p">;</span>
	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_cmd1</span> <span class="o">=</span> <span class="n">dscr</span><span class="o">-&gt;</span><span class="n">dscr_cmd1</span><span class="p">;</span>
	<span class="n">nbytes</span> <span class="o">=</span> <span class="n">dscr</span><span class="o">-&gt;</span><span class="n">dscr_cmd1</span><span class="p">;</span>
	<span class="cm">/* Allow the caller to specifiy if an interrupt is generated */</span>
	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_cmd0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DSCR_CMD0_IE</span><span class="p">;</span>
	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_cmd0</span> <span class="o">|=</span> <span class="n">dscr</span><span class="o">-&gt;</span><span class="n">dscr_cmd0</span> <span class="o">|</span> <span class="n">DSCR_CMD0_V</span><span class="p">;</span>
	<span class="n">ctp</span><span class="o">-&gt;</span><span class="n">chan_ptr</span><span class="o">-&gt;</span><span class="n">ddma_dbell</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Get next descriptor pointer.	*/</span>
	<span class="n">ctp</span><span class="o">-&gt;</span><span class="n">put_ptr</span> <span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">DSCR_GET_NXTPTR</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">dscr_nxtptr</span><span class="p">));</span>

	<span class="cm">/* Return something non-zero. */</span>
	<span class="k">return</span> <span class="n">nbytes</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">alchemy_dbdma_pm_data</span><span class="p">[</span><span class="n">NUM_DBDMA_CHANS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">6</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alchemy_dbdma_suspend</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">KSEG1ADDR</span><span class="p">(</span><span class="n">AU1550_DBDMA_CONF_PHYS_ADDR</span><span class="p">);</span>
	<span class="n">alchemy_dbdma_pm_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">alchemy_dbdma_pm_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0x04</span><span class="p">);</span>
	<span class="n">alchemy_dbdma_pm_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0x08</span><span class="p">);</span>
	<span class="n">alchemy_dbdma_pm_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0x0c</span><span class="p">);</span>

	<span class="cm">/* save channel configurations */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">KSEG1ADDR</span><span class="p">(</span><span class="n">AU1550_DBDMA_PHYS_ADDR</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">NUM_DBDMA_CHANS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">alchemy_dbdma_pm_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">alchemy_dbdma_pm_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0x04</span><span class="p">);</span>
		<span class="n">alchemy_dbdma_pm_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0x08</span><span class="p">);</span>
		<span class="n">alchemy_dbdma_pm_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0x0c</span><span class="p">);</span>
		<span class="n">alchemy_dbdma_pm_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">);</span>
		<span class="n">alchemy_dbdma_pm_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0x14</span><span class="p">);</span>

		<span class="cm">/* halt channel */</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">alchemy_dbdma_pm_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0x14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">wmb</span><span class="p">();</span>

		<span class="n">addr</span> <span class="o">+=</span> <span class="mh">0x100</span><span class="p">;</span>	<span class="cm">/* next channel base */</span>
	<span class="p">}</span>
	<span class="cm">/* disable channel interrupts */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">KSEG1ADDR</span><span class="p">(</span><span class="n">AU1550_DBDMA_CONF_PHYS_ADDR</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="mh">0x0c</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">alchemy_dbdma_resume</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">KSEG1ADDR</span><span class="p">(</span><span class="n">AU1550_DBDMA_CONF_PHYS_ADDR</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">alchemy_dbdma_pm_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">addr</span> <span class="o">+</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">alchemy_dbdma_pm_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">addr</span> <span class="o">+</span> <span class="mh">0x04</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">alchemy_dbdma_pm_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">addr</span> <span class="o">+</span> <span class="mh">0x08</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">alchemy_dbdma_pm_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="n">addr</span> <span class="o">+</span> <span class="mh">0x0c</span><span class="p">);</span>

	<span class="cm">/* restore channel configurations */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">KSEG1ADDR</span><span class="p">(</span><span class="n">AU1550_DBDMA_PHYS_ADDR</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">NUM_DBDMA_CHANS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">alchemy_dbdma_pm_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">addr</span> <span class="o">+</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">alchemy_dbdma_pm_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">addr</span> <span class="o">+</span> <span class="mh">0x04</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">alchemy_dbdma_pm_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">addr</span> <span class="o">+</span> <span class="mh">0x08</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">alchemy_dbdma_pm_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="n">addr</span> <span class="o">+</span> <span class="mh">0x0c</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">alchemy_dbdma_pm_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span> <span class="n">addr</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">alchemy_dbdma_pm_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span> <span class="n">addr</span> <span class="o">+</span> <span class="mh">0x14</span><span class="p">);</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="mh">0x100</span><span class="p">;</span>	<span class="cm">/* next channel base */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">syscore_ops</span> <span class="n">alchemy_dbdma_syscore_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">alchemy_dbdma_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">alchemy_dbdma_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">dbdma_setup</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="n">dbdev_tab_t</span> <span class="o">*</span><span class="n">idtable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dbdev_tab</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">dbdev_tab_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">DBDEV_TAB_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dbdev_tab</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dbdev_tab</span><span class="p">,</span> <span class="n">idtable</span><span class="p">,</span> <span class="mi">32</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dbdev_tab_t</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ret</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="n">DBDEV_TAB_SIZE</span><span class="p">;</span> <span class="n">ret</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dbdev_tab</span><span class="p">[</span><span class="n">ret</span><span class="p">].</span><span class="n">dev_id</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>

	<span class="n">dbdma_gptr</span><span class="o">-&gt;</span><span class="n">ddma_config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dbdma_gptr</span><span class="o">-&gt;</span><span class="n">ddma_throttle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dbdma_gptr</span><span class="o">-&gt;</span><span class="n">ddma_inten</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">au_sync</span><span class="p">();</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">dbdma_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;dbdma&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dbdma_gptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Cannot grab DBDMA interrupt!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">dbdma_initialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">register_syscore_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">alchemy_dbdma_syscore_ops</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">alchemy_dbdma_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">alchemy_get_cputype</span><span class="p">())</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ALCHEMY_CPU_AU1550</span>:
		<span class="k">return</span> <span class="n">dbdma_setup</span><span class="p">(</span><span class="n">AU1550_DDMA_INT</span><span class="p">,</span> <span class="n">au1550_dbdev_tab</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">ALCHEMY_CPU_AU1200</span>:
		<span class="k">return</span> <span class="n">dbdma_setup</span><span class="p">(</span><span class="n">AU1200_DDMA_INT</span><span class="p">,</span> <span class="n">au1200_dbdev_tab</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">ALCHEMY_CPU_AU1300</span>:
		<span class="k">return</span> <span class="n">dbdma_setup</span><span class="p">(</span><span class="n">AU1300_DDMA_INT</span><span class="p">,</span> <span class="n">au1300_dbdev_tab</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">alchemy_dbdma_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
