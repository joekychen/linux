<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › mips › boot › elf2ecoff.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>elf2ecoff.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 1995</span>
<span class="cm"> *	Ted Lemon (hereinafter referred to as the author)</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions</span>
<span class="cm"> * are met:</span>
<span class="cm"> * 1. Redistributions of source code must retain the above copyright</span>
<span class="cm"> *    notice, this list of conditions and the following disclaimer.</span>
<span class="cm"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<span class="cm"> *    notice, this list of conditions and the following disclaimer in the</span>
<span class="cm"> *    documentation and/or other materials provided with the distribution.</span>
<span class="cm"> * 3. The name of the author may not be used to endorse or promote products</span>
<span class="cm"> *    derived from this software without specific prior written permission.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS&#39;&#39; AND</span>
<span class="cm"> * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="cm"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="cm"> * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR BE LIABLE</span>
<span class="cm"> * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<span class="cm"> * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</span>
<span class="cm"> * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
<span class="cm"> * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
<span class="cm"> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
<span class="cm"> * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
<span class="cm"> * SUCH DAMAGE.</span>
<span class="cm"> */</span>

<span class="cm">/* elf2ecoff.c</span>

<span class="cm">   This program converts an elf executable to an ECOFF executable.</span>
<span class="cm">   No symbol table is retained.   This is useful primarily in building</span>
<span class="cm">   net-bootable kernels for machines (e.g., DECstation and Alpha) which</span>
<span class="cm">   only support the ECOFF object file format. */</span>

<span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>
<span class="cp">#include &lt;errno.h&gt;</span>
<span class="cp">#include &lt;sys/types.h&gt;</span>
<span class="cp">#include &lt;fcntl.h&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;elf.h&gt;</span>
<span class="cp">#include &lt;limits.h&gt;</span>
<span class="cp">#include &lt;netinet/in.h&gt;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>

<span class="cp">#include &quot;ecoff.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Some extra ELF definitions</span>
<span class="cm"> */</span>
<span class="cp">#define PT_MIPS_REGINFO 0x70000000	</span><span class="cm">/* Register usage information */</span><span class="cp"></span>

<span class="cm">/* -------------------------------------------------------------------- */</span>

<span class="k">struct</span> <span class="n">sect</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vaddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="o">*</span><span class="n">symTypeTable</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">must_convert_endian</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">format_bigendian</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">copy</span><span class="p">(</span><span class="kt">int</span> <span class="n">out</span><span class="p">,</span> <span class="kt">int</span> <span class="n">in</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">ibuf</span><span class="p">[</span><span class="mi">4096</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">remaining</span><span class="p">,</span> <span class="n">cur</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>

	<span class="cm">/* Go to the start of the ELF symbol table... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lseek</span><span class="p">(</span><span class="n">in</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">perror</span><span class="p">(</span><span class="s">&quot;copy: lseek&quot;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">remaining</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">remaining</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cur</span> <span class="o">=</span> <span class="n">remaining</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">&gt;</span> <span class="k">sizeof</span> <span class="n">ibuf</span><span class="p">)</span>
			<span class="n">cur</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">ibuf</span><span class="p">;</span>
		<span class="n">remaining</span> <span class="o">-=</span> <span class="n">cur</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">in</span><span class="p">,</span> <span class="n">ibuf</span><span class="p">,</span> <span class="n">cur</span><span class="p">))</span> <span class="o">!=</span> <span class="n">cur</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;copy: read: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">count</span> <span class="o">?</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">)</span> <span class="o">:</span>
				<span class="s">&quot;premature end of file&quot;</span><span class="p">);</span>
			<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">ibuf</span><span class="p">,</span> <span class="n">cur</span><span class="p">))</span> <span class="o">!=</span> <span class="n">cur</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">perror</span><span class="p">(</span><span class="s">&quot;copy: write&quot;</span><span class="p">);</span>
			<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Combine two segments, which must be contiguous.   If pad is true, it&#39;s</span>
<span class="cm"> * okay for there to be padding between.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">combine</span><span class="p">(</span><span class="k">struct</span> <span class="n">sect</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sect</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pad</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
		<span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">vaddr</span> <span class="o">+</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pad</span><span class="p">)</span>
				<span class="n">base</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">vaddr</span> <span class="o">-</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
					<span class="s">&quot;Non-contiguous data can&#39;t be converted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">base</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">phcmp</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v1</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">Elf32_Phdr</span> <span class="o">*</span><span class="n">h1</span> <span class="o">=</span> <span class="n">v1</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">Elf32_Phdr</span> <span class="o">*</span><span class="n">h2</span> <span class="o">=</span> <span class="n">v2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">h1</span><span class="o">-&gt;</span><span class="n">p_vaddr</span> <span class="o">&gt;</span> <span class="n">h2</span><span class="o">-&gt;</span><span class="n">p_vaddr</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">h1</span><span class="o">-&gt;</span><span class="n">p_vaddr</span> <span class="o">&lt;</span> <span class="n">h2</span><span class="o">-&gt;</span><span class="n">p_vaddr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">saveRead</span><span class="p">(</span><span class="kt">int</span> <span class="n">file</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">off_t</span> <span class="n">off</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">off</span> <span class="o">=</span> <span class="n">lseek</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s: fseek: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="n">len</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s: Can&#39;t allocate %ld bytes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
			<span class="n">len</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s: read: %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">name</span><span class="p">,</span>
			<span class="n">count</span> <span class="o">?</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;End of file reached&quot;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define swab16(x) \</span>
<span class="cp">	((unsigned short)( \</span>
<span class="cp">		(((unsigned short)(x) &amp; (unsigned short)0x00ffU) &lt;&lt; 8) | \</span>
<span class="cp">		(((unsigned short)(x) &amp; (unsigned short)0xff00U) &gt;&gt; 8) ))</span>

<span class="cp">#define swab32(x) \</span>
<span class="cp">	((unsigned int)( \</span>
<span class="cp">		(((unsigned int)(x) &amp; (unsigned int)0x000000ffUL) &lt;&lt; 24) | \</span>
<span class="cp">		(((unsigned int)(x) &amp; (unsigned int)0x0000ff00UL) &lt;&lt;  8) | \</span>
<span class="cp">		(((unsigned int)(x) &amp; (unsigned int)0x00ff0000UL) &gt;&gt;  8) | \</span>
<span class="cp">		(((unsigned int)(x) &amp; (unsigned int)0xff000000UL) &gt;&gt; 24) ))</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">convert_elf_hdr</span><span class="p">(</span><span class="n">Elf32_Ehdr</span> <span class="o">*</span> <span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">e_type</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">e_type</span><span class="p">);</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">e_machine</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">e_machine</span><span class="p">);</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">e_version</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">e_version</span><span class="p">);</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">e_entry</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">e_entry</span><span class="p">);</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">e_phoff</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">e_phoff</span><span class="p">);</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">e_shoff</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">e_shoff</span><span class="p">);</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">e_flags</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">e_flags</span><span class="p">);</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">e_ehsize</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">e_ehsize</span><span class="p">);</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">e_phentsize</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">e_phentsize</span><span class="p">);</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">e_phnum</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">e_phnum</span><span class="p">);</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">e_shentsize</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">e_shentsize</span><span class="p">);</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">e_shnum</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">e_shnum</span><span class="p">);</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">e_shstrndx</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">e_shstrndx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">convert_elf_phdrs</span><span class="p">(</span><span class="n">Elf32_Phdr</span> <span class="o">*</span> <span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">p_type</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_type</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">p_offset</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_offset</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">p_vaddr</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_vaddr</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">p_paddr</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_paddr</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">p_filesz</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_filesz</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">p_memsz</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_memsz</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">p_flags</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_flags</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">p_align</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">p_align</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">convert_elf_shdrs</span><span class="p">(</span><span class="n">Elf32_Shdr</span> <span class="o">*</span> <span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">s</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">sh_name</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sh_name</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">sh_type</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sh_type</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">sh_flags</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sh_flags</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">sh_addr</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sh_addr</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">sh_offset</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sh_offset</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">sh_size</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sh_size</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">sh_link</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sh_link</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">sh_info</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sh_info</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">sh_addralign</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sh_addralign</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">sh_entsize</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sh_entsize</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">convert_ecoff_filehdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">filehdr</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">f_magic</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">f_magic</span><span class="p">);</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">f_nscns</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">f_nscns</span><span class="p">);</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">f_timdat</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">f_timdat</span><span class="p">);</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">f_symptr</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">f_symptr</span><span class="p">);</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">f_nsyms</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">f_nsyms</span><span class="p">);</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">f_opthdr</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">f_opthdr</span><span class="p">);</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">f_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">convert_ecoff_aouthdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">aouthdr</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">);</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">vstamp</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">vstamp</span><span class="p">);</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">tsize</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">tsize</span><span class="p">);</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">dsize</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">dsize</span><span class="p">);</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">bsize</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">bsize</span><span class="p">);</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">entry</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">text_start</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">text_start</span><span class="p">);</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">data_start</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">data_start</span><span class="p">);</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">bss_start</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">bss_start</span><span class="p">);</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">gprmask</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">gprmask</span><span class="p">);</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">cprmask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">cprmask</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">cprmask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">cprmask</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">cprmask</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">cprmask</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">cprmask</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">cprmask</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">gp_value</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">gp_value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">convert_ecoff_esecs</span><span class="p">(</span><span class="k">struct</span> <span class="n">scnhdr</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">s</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_paddr</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_paddr</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_vaddr</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_vaddr</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_size</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_size</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_scnptr</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_scnptr</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_relptr</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_relptr</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_lnnoptr</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_lnnoptr</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_nreloc</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_nreloc</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_nlnno</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_nlnno</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="n">Elf32_Ehdr</span> <span class="n">ex</span><span class="p">;</span>
	<span class="n">Elf32_Phdr</span> <span class="o">*</span><span class="n">ph</span><span class="p">;</span>
	<span class="n">Elf32_Shdr</span> <span class="o">*</span><span class="n">sh</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">shstrtab</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">pad</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sect</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">bss</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">filehdr</span> <span class="n">efh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aouthdr</span> <span class="n">eah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scnhdr</span> <span class="n">esecs</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">infile</span><span class="p">,</span> <span class="n">outfile</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cur_vma</span> <span class="o">=</span> <span class="n">ULONG_MAX</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">addflag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nosecs</span><span class="p">;</span>

	<span class="n">text</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">bss</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">text</span><span class="p">.</span><span class="n">vaddr</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">vaddr</span> <span class="o">=</span> <span class="n">bss</span><span class="p">.</span><span class="n">vaddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Check args... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	      <span class="nl">usage:</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
			<span class="s">&quot;usage: elf2ecoff &lt;elf executable&gt; &lt;ecoff executable&gt; [-a]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s">&quot;-a&quot;</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">usage</span><span class="p">;</span>
		<span class="n">addflag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Try the input file... */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">infile</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">O_RDONLY</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Can&#39;t open %s for read: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Read the header, which is at the beginning of the file... */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ex</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">ex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="k">sizeof</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;ex: %s: %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			<span class="n">i</span> <span class="o">?</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;End of file reached&quot;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="n">e_ident</span><span class="p">[</span><span class="n">EI_DATA</span><span class="p">]</span> <span class="o">==</span> <span class="n">ELFDATA2MSB</span><span class="p">)</span>
		<span class="n">format_bigendian</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="mh">0xaa55</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xaa55</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">format_bigendian</span><span class="p">)</span>
			<span class="n">must_convert_endian</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">format_bigendian</span><span class="p">)</span>
			<span class="n">must_convert_endian</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">must_convert_endian</span><span class="p">)</span>
		<span class="n">convert_elf_hdr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ex</span><span class="p">);</span>

	<span class="cm">/* Read the program headers... */</span>
	<span class="n">ph</span> <span class="o">=</span> <span class="p">(</span><span class="n">Elf32_Phdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">saveRead</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="n">e_phoff</span><span class="p">,</span>
				     <span class="n">ex</span><span class="p">.</span><span class="n">e_phnum</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Elf32_Phdr</span><span class="p">),</span>
				     <span class="s">&quot;ph&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">must_convert_endian</span><span class="p">)</span>
		<span class="n">convert_elf_phdrs</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="n">e_phnum</span><span class="p">);</span>
	<span class="cm">/* Read the section headers... */</span>
	<span class="n">sh</span> <span class="o">=</span> <span class="p">(</span><span class="n">Elf32_Shdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">saveRead</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="n">e_shoff</span><span class="p">,</span>
				     <span class="n">ex</span><span class="p">.</span><span class="n">e_shnum</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Elf32_Shdr</span><span class="p">),</span>
				     <span class="s">&quot;sh&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">must_convert_endian</span><span class="p">)</span>
		<span class="n">convert_elf_shdrs</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="n">e_shnum</span><span class="p">);</span>
	<span class="cm">/* Read in the section string table. */</span>
	<span class="n">shstrtab</span> <span class="o">=</span> <span class="n">saveRead</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">sh</span><span class="p">[</span><span class="n">ex</span><span class="p">.</span><span class="n">e_shstrndx</span><span class="p">].</span><span class="n">sh_offset</span><span class="p">,</span>
			    <span class="n">sh</span><span class="p">[</span><span class="n">ex</span><span class="p">.</span><span class="n">e_shstrndx</span><span class="p">].</span><span class="n">sh_size</span><span class="p">,</span> <span class="s">&quot;shstrtab&quot;</span><span class="p">);</span>

	<span class="cm">/* Figure out if we can cram the program header into an ECOFF</span>
<span class="cm">	   header...  Basically, we can&#39;t handle anything but loadable</span>
<span class="cm">	   segments, but we can ignore some kinds of segments.  We can&#39;t</span>
<span class="cm">	   handle holes in the address space.  Segments may be out of order,</span>
<span class="cm">	   so we sort them first. */</span>

	<span class="n">qsort</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="n">e_phnum</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Elf32_Phdr</span><span class="p">),</span> <span class="n">phcmp</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ex</span><span class="p">.</span><span class="n">e_phnum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Section types we can ignore... */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ph</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_type</span> <span class="o">==</span> <span class="n">PT_NULL</span> <span class="o">||</span> <span class="n">ph</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_type</span> <span class="o">==</span> <span class="n">PT_NOTE</span> <span class="o">||</span>
		    <span class="n">ph</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_type</span> <span class="o">==</span> <span class="n">PT_PHDR</span>
		    <span class="o">||</span> <span class="n">ph</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_type</span> <span class="o">==</span> <span class="n">PT_MIPS_REGINFO</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* Section types we can&#39;t handle... */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ph</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_type</span> <span class="o">!=</span> <span class="n">PT_LOAD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
				<span class="s">&quot;Program header %d type %d can&#39;t be converted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ex</span><span class="p">.</span><span class="n">e_phnum</span><span class="p">,</span> <span class="n">ph</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_type</span><span class="p">);</span>
			<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Writable (data) segment? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ph</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_flags</span> <span class="o">&amp;</span> <span class="n">PF_W</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sect</span> <span class="n">ndata</span><span class="p">,</span> <span class="n">nbss</span><span class="p">;</span>

			<span class="n">ndata</span><span class="p">.</span><span class="n">vaddr</span> <span class="o">=</span> <span class="n">ph</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_vaddr</span><span class="p">;</span>
			<span class="n">ndata</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">ph</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_filesz</span><span class="p">;</span>
			<span class="n">nbss</span><span class="p">.</span><span class="n">vaddr</span> <span class="o">=</span> <span class="n">ph</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_vaddr</span> <span class="o">+</span> <span class="n">ph</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_filesz</span><span class="p">;</span>
			<span class="n">nbss</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">ph</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_memsz</span> <span class="o">-</span> <span class="n">ph</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_filesz</span><span class="p">;</span>

			<span class="n">combine</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ndata</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">combine</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bss</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nbss</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sect</span> <span class="n">ntxt</span><span class="p">;</span>

			<span class="n">ntxt</span><span class="p">.</span><span class="n">vaddr</span> <span class="o">=</span> <span class="n">ph</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_vaddr</span><span class="p">;</span>
			<span class="n">ntxt</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">ph</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_filesz</span><span class="p">;</span>

			<span class="n">combine</span><span class="p">(</span><span class="o">&amp;</span><span class="n">text</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ntxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Remember the lowest segment start address. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ph</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_vaddr</span> <span class="o">&lt;</span> <span class="n">cur_vma</span><span class="p">)</span>
			<span class="n">cur_vma</span> <span class="o">=</span> <span class="n">ph</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_vaddr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Sections must be in order to be converted... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">text</span><span class="p">.</span><span class="n">vaddr</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">.</span><span class="n">vaddr</span> <span class="o">||</span> <span class="n">data</span><span class="p">.</span><span class="n">vaddr</span> <span class="o">&gt;</span> <span class="n">bss</span><span class="p">.</span><span class="n">vaddr</span> <span class="o">||</span>
	    <span class="n">text</span><span class="p">.</span><span class="n">vaddr</span> <span class="o">+</span> <span class="n">text</span><span class="p">.</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">.</span><span class="n">vaddr</span>
	    <span class="o">||</span> <span class="n">data</span><span class="p">.</span><span class="n">vaddr</span> <span class="o">+</span> <span class="n">data</span><span class="p">.</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">bss</span><span class="p">.</span><span class="n">vaddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
			<span class="s">&quot;Sections ordering prevents a.out conversion.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* If there&#39;s a data section but no text section, then the loader</span>
<span class="cm">	   combined everything into one section.   That needs to be the</span>
<span class="cm">	   text section, so just make the data section zero length following</span>
<span class="cm">	   text. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">text</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">text</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="n">data</span><span class="p">.</span><span class="n">vaddr</span> <span class="o">=</span> <span class="n">text</span><span class="p">.</span><span class="n">vaddr</span> <span class="o">+</span> <span class="n">text</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
		<span class="n">data</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If there is a gap between text and data, we&#39;ll fill it when we copy</span>
<span class="cm">	   the data, so update the length of the text segment as represented in</span>
<span class="cm">	   a.out to reflect that, since a.out doesn&#39;t allow gaps in the program</span>
<span class="cm">	   address space. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">text</span><span class="p">.</span><span class="n">vaddr</span> <span class="o">+</span> <span class="n">text</span><span class="p">.</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">data</span><span class="p">.</span><span class="n">vaddr</span><span class="p">)</span>
		<span class="n">text</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">vaddr</span> <span class="o">-</span> <span class="n">text</span><span class="p">.</span><span class="n">vaddr</span><span class="p">;</span>

	<span class="cm">/* We now have enough information to cons up an a.out header... */</span>
	<span class="n">eah</span><span class="p">.</span><span class="n">magic</span> <span class="o">=</span> <span class="n">OMAGIC</span><span class="p">;</span>
	<span class="n">eah</span><span class="p">.</span><span class="n">vstamp</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
	<span class="n">eah</span><span class="p">.</span><span class="n">tsize</span> <span class="o">=</span> <span class="n">text</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
	<span class="n">eah</span><span class="p">.</span><span class="n">dsize</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
	<span class="n">eah</span><span class="p">.</span><span class="n">bsize</span> <span class="o">=</span> <span class="n">bss</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
	<span class="n">eah</span><span class="p">.</span><span class="n">entry</span> <span class="o">=</span> <span class="n">ex</span><span class="p">.</span><span class="n">e_entry</span><span class="p">;</span>
	<span class="n">eah</span><span class="p">.</span><span class="n">text_start</span> <span class="o">=</span> <span class="n">text</span><span class="p">.</span><span class="n">vaddr</span><span class="p">;</span>
	<span class="n">eah</span><span class="p">.</span><span class="n">data_start</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">vaddr</span><span class="p">;</span>
	<span class="n">eah</span><span class="p">.</span><span class="n">bss_start</span> <span class="o">=</span> <span class="n">bss</span><span class="p">.</span><span class="n">vaddr</span><span class="p">;</span>
	<span class="n">eah</span><span class="p">.</span><span class="n">gprmask</span> <span class="o">=</span> <span class="mh">0xf3fffffe</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eah</span><span class="p">.</span><span class="n">cprmask</span><span class="p">,</span> <span class="sc">&#39;\0&#39;</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">eah</span><span class="p">.</span><span class="n">cprmask</span><span class="p">);</span>
	<span class="n">eah</span><span class="p">.</span><span class="n">gp_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* unused. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">format_bigendian</span><span class="p">)</span>
		<span class="n">efh</span><span class="p">.</span><span class="n">f_magic</span> <span class="o">=</span> <span class="n">MIPSEBMAGIC</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">efh</span><span class="p">.</span><span class="n">f_magic</span> <span class="o">=</span> <span class="n">MIPSELMAGIC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addflag</span><span class="p">)</span>
		<span class="n">nosecs</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">nosecs</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">efh</span><span class="p">.</span><span class="n">f_nscns</span> <span class="o">=</span> <span class="n">nosecs</span><span class="p">;</span>
	<span class="n">efh</span><span class="p">.</span><span class="n">f_timdat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* bogus */</span>
	<span class="n">efh</span><span class="p">.</span><span class="n">f_symptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">efh</span><span class="p">.</span><span class="n">f_nsyms</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">efh</span><span class="p">.</span><span class="n">f_opthdr</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">eah</span><span class="p">;</span>
	<span class="n">efh</span><span class="p">.</span><span class="n">f_flags</span> <span class="o">=</span> <span class="mh">0x100f</span><span class="p">;</span>	<span class="cm">/* Stripped, not sharable. */</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">esecs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">esecs</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">esecs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">s_name</span><span class="p">,</span> <span class="s">&quot;.text&quot;</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">esecs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">s_name</span><span class="p">,</span> <span class="s">&quot;.data&quot;</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">esecs</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">s_name</span><span class="p">,</span> <span class="s">&quot;.bss&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addflag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">esecs</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">s_name</span><span class="p">,</span> <span class="s">&quot;.rdata&quot;</span><span class="p">);</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">esecs</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">s_name</span><span class="p">,</span> <span class="s">&quot;.sdata&quot;</span><span class="p">);</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">esecs</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">s_name</span><span class="p">,</span> <span class="s">&quot;.sbss&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">esecs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">s_paddr</span> <span class="o">=</span> <span class="n">esecs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">s_vaddr</span> <span class="o">=</span> <span class="n">eah</span><span class="p">.</span><span class="n">text_start</span><span class="p">;</span>
	<span class="n">esecs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">s_paddr</span> <span class="o">=</span> <span class="n">esecs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">s_vaddr</span> <span class="o">=</span> <span class="n">eah</span><span class="p">.</span><span class="n">data_start</span><span class="p">;</span>
	<span class="n">esecs</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">s_paddr</span> <span class="o">=</span> <span class="n">esecs</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">s_vaddr</span> <span class="o">=</span> <span class="n">eah</span><span class="p">.</span><span class="n">bss_start</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addflag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">esecs</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">s_paddr</span> <span class="o">=</span> <span class="n">esecs</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">s_vaddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">esecs</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">s_paddr</span> <span class="o">=</span> <span class="n">esecs</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">s_vaddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">esecs</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">s_paddr</span> <span class="o">=</span> <span class="n">esecs</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">s_vaddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">esecs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">s_size</span> <span class="o">=</span> <span class="n">eah</span><span class="p">.</span><span class="n">tsize</span><span class="p">;</span>
	<span class="n">esecs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">s_size</span> <span class="o">=</span> <span class="n">eah</span><span class="p">.</span><span class="n">dsize</span><span class="p">;</span>
	<span class="n">esecs</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">s_size</span> <span class="o">=</span> <span class="n">eah</span><span class="p">.</span><span class="n">bsize</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addflag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">esecs</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">s_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">esecs</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">s_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">esecs</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">s_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">esecs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">s_scnptr</span> <span class="o">=</span> <span class="n">N_TXTOFF</span><span class="p">(</span><span class="n">efh</span><span class="p">,</span> <span class="n">eah</span><span class="p">);</span>
	<span class="n">esecs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">s_scnptr</span> <span class="o">=</span> <span class="n">N_DATOFF</span><span class="p">(</span><span class="n">efh</span><span class="p">,</span> <span class="n">eah</span><span class="p">);</span>
<span class="cp">#define ECOFF_SEGMENT_ALIGNMENT(a) 0x10</span>
<span class="cp">#define ECOFF_ROUND(s, a) (((s)+(a)-1)&amp;~((a)-1))</span>
	<span class="n">esecs</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">s_scnptr</span> <span class="o">=</span> <span class="n">esecs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">s_scnptr</span> <span class="o">+</span>
	    <span class="n">ECOFF_ROUND</span><span class="p">(</span><span class="n">esecs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">s_size</span><span class="p">,</span> <span class="n">ECOFF_SEGMENT_ALIGNMENT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eah</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addflag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">esecs</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">s_scnptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">esecs</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">s_scnptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">esecs</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">s_scnptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">esecs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">s_relptr</span> <span class="o">=</span> <span class="n">esecs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">s_relptr</span> <span class="o">=</span> <span class="n">esecs</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">s_relptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">esecs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">s_lnnoptr</span> <span class="o">=</span> <span class="n">esecs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">s_lnnoptr</span> <span class="o">=</span> <span class="n">esecs</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">s_lnnoptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">esecs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">s_nreloc</span> <span class="o">=</span> <span class="n">esecs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">s_nreloc</span> <span class="o">=</span> <span class="n">esecs</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">s_nreloc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">esecs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">s_nlnno</span> <span class="o">=</span> <span class="n">esecs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">s_nlnno</span> <span class="o">=</span> <span class="n">esecs</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">s_nlnno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addflag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">esecs</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">s_relptr</span> <span class="o">=</span> <span class="n">esecs</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">s_relptr</span>
		    <span class="o">=</span> <span class="n">esecs</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">s_relptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">esecs</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">s_lnnoptr</span> <span class="o">=</span> <span class="n">esecs</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">s_lnnoptr</span>
		    <span class="o">=</span> <span class="n">esecs</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">s_lnnoptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">esecs</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">s_nreloc</span> <span class="o">=</span> <span class="n">esecs</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">s_nreloc</span> <span class="o">=</span> <span class="n">esecs</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">s_nreloc</span> <span class="o">=</span>
		    <span class="mi">0</span><span class="p">;</span>
		<span class="n">esecs</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">s_nlnno</span> <span class="o">=</span> <span class="n">esecs</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">s_nlnno</span> <span class="o">=</span> <span class="n">esecs</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">s_nlnno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">esecs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">s_flags</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">esecs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">s_flags</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">esecs</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">s_flags</span> <span class="o">=</span> <span class="mh">0x82</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addflag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">esecs</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">s_flags</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">;</span>
		<span class="n">esecs</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">s_flags</span> <span class="o">=</span> <span class="mh">0x200</span><span class="p">;</span>
		<span class="n">esecs</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">s_flags</span> <span class="o">=</span> <span class="mh">0x400</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Make the output file... */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">outfile</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">O_CREAT</span><span class="p">,</span> <span class="mo">0777</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Unable to create %s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
			<span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">must_convert_endian</span><span class="p">)</span>
		<span class="n">convert_ecoff_filehdr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">efh</span><span class="p">);</span>
	<span class="cm">/* Write the headers... */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">efh</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">efh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="k">sizeof</span> <span class="n">efh</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">perror</span><span class="p">(</span><span class="s">&quot;efh: write&quot;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nosecs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span>
			    <span class="p">(</span><span class="s">&quot;Section %d: %s phys %lx  size %lx  file offset %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">i</span><span class="p">,</span> <span class="n">esecs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">s_name</span><span class="p">,</span> <span class="n">esecs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">s_paddr</span><span class="p">,</span>
			     <span class="n">esecs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">s_size</span><span class="p">,</span> <span class="n">esecs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">s_scnptr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;wrote %d byte file header.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">must_convert_endian</span><span class="p">)</span>
		<span class="n">convert_ecoff_aouthdr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eah</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eah</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">eah</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="k">sizeof</span> <span class="n">eah</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">perror</span><span class="p">(</span><span class="s">&quot;eah: write&quot;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;wrote %d byte a.out header.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">must_convert_endian</span><span class="p">)</span>
		<span class="n">convert_ecoff_esecs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">esecs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nosecs</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">esecs</span><span class="p">,</span> <span class="n">nosecs</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scnhdr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">nosecs</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scnhdr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">perror</span><span class="p">(</span><span class="s">&quot;esecs: write&quot;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;wrote %d bytes of section headers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">pad</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">efh</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">eah</span><span class="p">)</span> <span class="o">+</span> <span class="n">nosecs</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scnhdr</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pad</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pad</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">-</span> <span class="n">pad</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\0\0\0\0\0\0\0\0\0\0\0\0\0\0</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">perror</span><span class="p">(</span><span class="s">&quot;ipad: write&quot;</span><span class="p">);</span>
			<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;wrote %d byte pad.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Copy the loadable sections.   Zero-fill any gaps less than 64k;</span>
<span class="cm">	 * complain about any zero-filling, and die if we&#39;re asked to zero-fill</span>
<span class="cm">	 * more than 64k.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ex</span><span class="p">.</span><span class="n">e_phnum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Unprocessable sections were handled above, so just verify that</span>
<span class="cm">		   the section can be loaded before copying. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ph</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_type</span> <span class="o">==</span> <span class="n">PT_LOAD</span> <span class="o">&amp;&amp;</span> <span class="n">ph</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_filesz</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cur_vma</span> <span class="o">!=</span> <span class="n">ph</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_vaddr</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">gap</span> <span class="o">=</span>
				    <span class="n">ph</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_vaddr</span> <span class="o">-</span> <span class="n">cur_vma</span><span class="p">;</span>
				<span class="kt">char</span> <span class="n">obuf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">gap</span> <span class="o">&gt;</span> <span class="mi">65536</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
						<span class="s">&quot;Intersegment gap (%ld bytes) too large.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">gap</span><span class="p">);</span>
					<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
					<span class="s">&quot;Warning: %ld byte intersegment gap.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">gap</span><span class="p">);</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">obuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">obuf</span><span class="p">);</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">gap</span><span class="p">)</span> <span class="p">{</span>
					<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span>
					    <span class="n">write</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">obuf</span><span class="p">,</span>
						  <span class="p">(</span><span class="n">gap</span> <span class="o">&gt;</span>
						   <span class="k">sizeof</span> <span class="n">obuf</span> <span class="o">?</span> <span class="k">sizeof</span>
						   <span class="n">obuf</span> <span class="o">:</span> <span class="n">gap</span><span class="p">));</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
							<span class="s">&quot;Error writing gap: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
						<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="n">gap</span> <span class="o">-=</span> <span class="n">count</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;writing %d bytes...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ph</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_filesz</span><span class="p">);</span>
			<span class="n">copy</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">infile</span><span class="p">,</span> <span class="n">ph</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_offset</span><span class="p">,</span>
			     <span class="n">ph</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_filesz</span><span class="p">);</span>
			<span class="n">cur_vma</span> <span class="o">=</span> <span class="n">ph</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_vaddr</span> <span class="o">+</span> <span class="n">ph</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_filesz</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Write a page of padding for boot PROMS that read entire pages.</span>
<span class="cm">	 * Without this, they may attempt to read past the end of the</span>
<span class="cm">	 * data section, incur an error, and refuse to boot.</span>
<span class="cm">	 */</span>
	<span class="p">{</span>
		<span class="kt">char</span> <span class="n">obuf</span><span class="p">[</span><span class="mi">4096</span><span class="p">];</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">obuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">obuf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">obuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">obuf</span><span class="p">))</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">obuf</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Error writing PROM padding: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
			<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Looks like we won... */</span>
	<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
