<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › mips › sgi-ip32 › ip32-irq.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ip32-irq.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Code to handle IP32 IRQs</span>
<span class="cm"> *</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License.  See the file &quot;COPYING&quot; in the main directory of this archive</span>
<span class="cm"> * for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2000 Harald Koerfgen</span>
<span class="cm"> * Copyright (C) 2001 Keith M Wesolowski</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel_stat.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>

<span class="cp">#include &lt;asm/irq_cpu.h&gt;</span>
<span class="cp">#include &lt;asm/mipsregs.h&gt;</span>
<span class="cp">#include &lt;asm/signal.h&gt;</span>
<span class="cp">#include &lt;asm/time.h&gt;</span>
<span class="cp">#include &lt;asm/ip32/crime.h&gt;</span>
<span class="cp">#include &lt;asm/ip32/mace.h&gt;</span>
<span class="cp">#include &lt;asm/ip32/ip32_ints.h&gt;</span>

<span class="cm">/* issue a PIO read to make sure no PIO writes are pending */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="kr">inline</span> <span class="nf">flush_crime_bus</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">crime</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="kr">inline</span> <span class="nf">flush_mace_bus</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mace</span><span class="o">-&gt;</span><span class="n">perif</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">misc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * O2 irq map</span>
<span class="cm"> *</span>
<span class="cm"> * IP0 -&gt; software (ignored)</span>
<span class="cm"> * IP1 -&gt; software (ignored)</span>
<span class="cm"> * IP2 -&gt; (irq0) C crime 1.1 all interrupts; crime 1.5 ???</span>
<span class="cm"> * IP3 -&gt; (irq1) X unknown</span>
<span class="cm"> * IP4 -&gt; (irq2) X unknown</span>
<span class="cm"> * IP5 -&gt; (irq3) X unknown</span>
<span class="cm"> * IP6 -&gt; (irq4) X unknown</span>
<span class="cm"> * IP7 -&gt; (irq5) 7 CPU count/compare timer (system timer)</span>
<span class="cm"> *</span>
<span class="cm"> * crime: (C)</span>
<span class="cm"> *</span>
<span class="cm"> * CRIME_INT_STAT 31:0:</span>
<span class="cm"> *</span>
<span class="cm"> * 0  -&gt;  8  Video in 1</span>
<span class="cm"> * 1  -&gt;  9 Video in 2</span>
<span class="cm"> * 2  -&gt; 10  Video out</span>
<span class="cm"> * 3  -&gt; 11  Mace ethernet</span>
<span class="cm"> * 4  -&gt; S  SuperIO sub-interrupt</span>
<span class="cm"> * 5  -&gt; M  Miscellaneous sub-interrupt</span>
<span class="cm"> * 6  -&gt; A  Audio sub-interrupt</span>
<span class="cm"> * 7  -&gt; 15  PCI bridge errors</span>
<span class="cm"> * 8  -&gt; 16  PCI SCSI aic7xxx 0</span>
<span class="cm"> * 9  -&gt; 17 PCI SCSI aic7xxx 1</span>
<span class="cm"> * 10 -&gt; 18 PCI slot 0</span>
<span class="cm"> * 11 -&gt; 19 unused (PCI slot 1)</span>
<span class="cm"> * 12 -&gt; 20 unused (PCI slot 2)</span>
<span class="cm"> * 13 -&gt; 21 unused (PCI shared 0)</span>
<span class="cm"> * 14 -&gt; 22 unused (PCI shared 1)</span>
<span class="cm"> * 15 -&gt; 23 unused (PCI shared 2)</span>
<span class="cm"> * 16 -&gt; 24 GBE0 (E)</span>
<span class="cm"> * 17 -&gt; 25 GBE1 (E)</span>
<span class="cm"> * 18 -&gt; 26 GBE2 (E)</span>
<span class="cm"> * 19 -&gt; 27 GBE3 (E)</span>
<span class="cm"> * 20 -&gt; 28 CPU errors</span>
<span class="cm"> * 21 -&gt; 29 Memory errors</span>
<span class="cm"> * 22 -&gt; 30 RE empty edge (E)</span>
<span class="cm"> * 23 -&gt; 31 RE full edge (E)</span>
<span class="cm"> * 24 -&gt; 32 RE idle edge (E)</span>
<span class="cm"> * 25 -&gt; 33 RE empty level</span>
<span class="cm"> * 26 -&gt; 34 RE full level</span>
<span class="cm"> * 27 -&gt; 35 RE idle level</span>
<span class="cm"> * 28 -&gt; 36 unused (software 0) (E)</span>
<span class="cm"> * 29 -&gt; 37 unused (software 1) (E)</span>
<span class="cm"> * 30 -&gt; 38 unused (software 2) - crime 1.5 CPU SysCorError (E)</span>
<span class="cm"> * 31 -&gt; 39 VICE</span>
<span class="cm"> *</span>
<span class="cm"> * S, M, A: Use the MACE ISA interrupt register</span>
<span class="cm"> * MACE_ISA_INT_STAT 31:0</span>
<span class="cm"> *</span>
<span class="cm"> * 0-7 -&gt; 40-47 Audio</span>
<span class="cm"> * 8 -&gt; 48 RTC</span>
<span class="cm"> * 9 -&gt; 49 Keyboard</span>
<span class="cm"> * 10 -&gt; X Keyboard polled</span>
<span class="cm"> * 11 -&gt; 51 Mouse</span>
<span class="cm"> * 12 -&gt; X Mouse polled</span>
<span class="cm"> * 13-15 -&gt; 53-55 Count/compare timers</span>
<span class="cm"> * 16-19 -&gt; 56-59 Parallel (16 E)</span>
<span class="cm"> * 20-25 -&gt; 60-62 Serial 1 (22 E)</span>
<span class="cm"> * 26-31 -&gt; 66-71 Serial 2 (28 E)</span>
<span class="cm"> *</span>
<span class="cm"> * Note that this means IRQs 12-14, 50, and 52 do not exist.  This is a</span>
<span class="cm"> * different IRQ map than IRIX uses, but that&#39;s OK as Linux irq handling</span>
<span class="cm"> * is quite different anyway.</span>
<span class="cm"> */</span>

<span class="cm">/* Some initial interrupts to set up */</span>
<span class="k">extern</span> <span class="n">irqreturn_t</span> <span class="n">crime_memerr_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">extern</span> <span class="n">irqreturn_t</span> <span class="n">crime_cpuerr_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irqaction</span> <span class="n">memerr_irq</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">crime_memerr_intr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;CRIME memory error&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irqaction</span> <span class="n">cpuerr_irq</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">crime_cpuerr_intr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;CRIME CPU error&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * This is for pure CRIME interrupts - ie not MACE.  The advantage?</span>
<span class="cm"> * We get to split the register in half and do faster lookups.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">uint64_t</span> <span class="n">crime_mask</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">crime_enable_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">CRIME_IRQ_BASE</span><span class="p">;</span>

	<span class="n">crime_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">;</span>
	<span class="n">crime</span><span class="o">-&gt;</span><span class="n">imask</span> <span class="o">=</span> <span class="n">crime_mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">crime_disable_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">CRIME_IRQ_BASE</span><span class="p">;</span>

	<span class="n">crime_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">);</span>
	<span class="n">crime</span><span class="o">-&gt;</span><span class="n">imask</span> <span class="o">=</span> <span class="n">crime_mask</span><span class="p">;</span>
	<span class="n">flush_crime_bus</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">crime_level_interrupt</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;IP32 CRIME&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask</span>	<span class="o">=</span> <span class="n">crime_disable_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span>	<span class="o">=</span> <span class="n">crime_enable_irq</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">crime_edge_mask_and_ack_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">CRIME_IRQ_BASE</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">crime_int</span><span class="p">;</span>

	<span class="cm">/* Edge triggered interrupts must be cleared. */</span>
	<span class="n">crime_int</span> <span class="o">=</span> <span class="n">crime</span><span class="o">-&gt;</span><span class="n">hard_int</span><span class="p">;</span>
	<span class="n">crime_int</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">);</span>
	<span class="n">crime</span><span class="o">-&gt;</span><span class="n">hard_int</span> <span class="o">=</span> <span class="n">crime_int</span><span class="p">;</span>

	<span class="n">crime_disable_irq</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">crime_edge_interrupt</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;IP32 CRIME&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_ack</span>	<span class="o">=</span> <span class="n">crime_edge_mask_and_ack_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask</span>	<span class="o">=</span> <span class="n">crime_disable_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask_ack</span>	<span class="o">=</span> <span class="n">crime_edge_mask_and_ack_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span>	<span class="o">=</span> <span class="n">crime_enable_irq</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * This is for MACE PCI interrupts.  We can decrease bus traffic by masking</span>
<span class="cm"> * as close to the source as possible.  This also means we can take the</span>
<span class="cm"> * next chunk of the CRIME register in one piece.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">macepci_mask</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">enable_macepci_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">macepci_mask</span> <span class="o">|=</span> <span class="n">MACEPCI_CONTROL_INT</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">MACEPCI_SCSI0_IRQ</span><span class="p">);</span>
	<span class="n">mace</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">.</span><span class="n">control</span> <span class="o">=</span> <span class="n">macepci_mask</span><span class="p">;</span>
	<span class="n">crime_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">CRIME_IRQ_BASE</span><span class="p">);</span>
	<span class="n">crime</span><span class="o">-&gt;</span><span class="n">imask</span> <span class="o">=</span> <span class="n">crime_mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">disable_macepci_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">crime_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">CRIME_IRQ_BASE</span><span class="p">));</span>
	<span class="n">crime</span><span class="o">-&gt;</span><span class="n">imask</span> <span class="o">=</span> <span class="n">crime_mask</span><span class="p">;</span>
	<span class="n">flush_crime_bus</span><span class="p">();</span>
	<span class="n">macepci_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MACEPCI_CONTROL_INT</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">MACEPCI_SCSI0_IRQ</span><span class="p">);</span>
	<span class="n">mace</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">.</span><span class="n">control</span> <span class="o">=</span> <span class="n">macepci_mask</span><span class="p">;</span>
	<span class="n">flush_mace_bus</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">ip32_macepci_interrupt</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;IP32 MACE PCI&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask</span> <span class="o">=</span> <span class="n">disable_macepci_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span> <span class="o">=</span> <span class="n">enable_macepci_irq</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* This is used for MACE ISA interrupts.  That means bits 4-6 in the</span>
<span class="cm"> * CRIME register.</span>
<span class="cm"> */</span>

<span class="cp">#define MACEISA_AUDIO_INT	(MACEISA_AUDIO_SW_INT |		\</span>
<span class="cp">				 MACEISA_AUDIO_SC_INT |		\</span>
<span class="cp">				 MACEISA_AUDIO1_DMAT_INT |	\</span>
<span class="cp">				 MACEISA_AUDIO1_OF_INT |	\</span>
<span class="cp">				 MACEISA_AUDIO2_DMAT_INT |	\</span>
<span class="cp">				 MACEISA_AUDIO2_MERR_INT |	\</span>
<span class="cp">				 MACEISA_AUDIO3_DMAT_INT |	\</span>
<span class="cp">				 MACEISA_AUDIO3_MERR_INT)</span>
<span class="cp">#define MACEISA_MISC_INT	(MACEISA_RTC_INT |		\</span>
<span class="cp">				 MACEISA_KEYB_INT |		\</span>
<span class="cp">				 MACEISA_KEYB_POLL_INT |	\</span>
<span class="cp">				 MACEISA_MOUSE_INT |		\</span>
<span class="cp">				 MACEISA_MOUSE_POLL_INT |	\</span>
<span class="cp">				 MACEISA_TIMER0_INT |		\</span>
<span class="cp">				 MACEISA_TIMER1_INT |		\</span>
<span class="cp">				 MACEISA_TIMER2_INT)</span>
<span class="cp">#define MACEISA_SUPERIO_INT	(MACEISA_PARALLEL_INT |		\</span>
<span class="cp">				 MACEISA_PAR_CTXA_INT |		\</span>
<span class="cp">				 MACEISA_PAR_CTXB_INT |		\</span>
<span class="cp">				 MACEISA_PAR_MERR_INT |		\</span>
<span class="cp">				 MACEISA_SERIAL1_INT |		\</span>
<span class="cp">				 MACEISA_SERIAL1_TDMAT_INT |	\</span>
<span class="cp">				 MACEISA_SERIAL1_TDMAPR_INT |	\</span>
<span class="cp">				 MACEISA_SERIAL1_TDMAME_INT |	\</span>
<span class="cp">				 MACEISA_SERIAL1_RDMAT_INT |	\</span>
<span class="cp">				 MACEISA_SERIAL1_RDMAOR_INT |	\</span>
<span class="cp">				 MACEISA_SERIAL2_INT |		\</span>
<span class="cp">				 MACEISA_SERIAL2_TDMAT_INT |	\</span>
<span class="cp">				 MACEISA_SERIAL2_TDMAPR_INT |	\</span>
<span class="cp">				 MACEISA_SERIAL2_TDMAME_INT |	\</span>
<span class="cp">				 MACEISA_SERIAL2_RDMAT_INT |	\</span>
<span class="cp">				 MACEISA_SERIAL2_RDMAOR_INT)</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">maceisa_mask</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">enable_maceisa_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">crime_int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;maceisa enable: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MACEISA_AUDIO_SW_IRQ</span> <span class="p">...</span> <span class="n">MACEISA_AUDIO3_MERR_IRQ</span>:
		<span class="n">crime_int</span> <span class="o">=</span> <span class="n">MACE_AUDIO_INT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MACEISA_RTC_IRQ</span> <span class="p">...</span> <span class="n">MACEISA_TIMER2_IRQ</span>:
		<span class="n">crime_int</span> <span class="o">=</span> <span class="n">MACE_MISC_INT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MACEISA_PARALLEL_IRQ</span> <span class="p">...</span> <span class="n">MACEISA_SERIAL2_RDMAOR_IRQ</span>:
		<span class="n">crime_int</span> <span class="o">=</span> <span class="n">MACE_SUPERIO_INT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;crime_int %08x enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">crime_int</span><span class="p">);</span>
	<span class="n">crime_mask</span> <span class="o">|=</span> <span class="n">crime_int</span><span class="p">;</span>
	<span class="n">crime</span><span class="o">-&gt;</span><span class="n">imask</span> <span class="o">=</span> <span class="n">crime_mask</span><span class="p">;</span>
	<span class="n">maceisa_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">MACEISA_AUDIO_SW_IRQ</span><span class="p">);</span>
	<span class="n">mace</span><span class="o">-&gt;</span><span class="n">perif</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">imask</span> <span class="o">=</span> <span class="n">maceisa_mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">disable_maceisa_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">crime_int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">maceisa_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">MACEISA_AUDIO_SW_IRQ</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">maceisa_mask</span> <span class="o">&amp;</span> <span class="n">MACEISA_AUDIO_INT</span><span class="p">))</span>
		<span class="n">crime_int</span> <span class="o">|=</span> <span class="n">MACE_AUDIO_INT</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">maceisa_mask</span> <span class="o">&amp;</span> <span class="n">MACEISA_MISC_INT</span><span class="p">))</span>
		<span class="n">crime_int</span> <span class="o">|=</span> <span class="n">MACE_MISC_INT</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">maceisa_mask</span> <span class="o">&amp;</span> <span class="n">MACEISA_SUPERIO_INT</span><span class="p">))</span>
		<span class="n">crime_int</span> <span class="o">|=</span> <span class="n">MACE_SUPERIO_INT</span><span class="p">;</span>
	<span class="n">crime_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">crime_int</span><span class="p">;</span>
	<span class="n">crime</span><span class="o">-&gt;</span><span class="n">imask</span> <span class="o">=</span> <span class="n">crime_mask</span><span class="p">;</span>
	<span class="n">flush_crime_bus</span><span class="p">();</span>
	<span class="n">mace</span><span class="o">-&gt;</span><span class="n">perif</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">imask</span> <span class="o">=</span> <span class="n">maceisa_mask</span><span class="p">;</span>
	<span class="n">flush_mace_bus</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mask_and_ack_maceisa_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mace_int</span><span class="p">;</span>

	<span class="cm">/* edge triggered */</span>
	<span class="n">mace_int</span> <span class="o">=</span> <span class="n">mace</span><span class="o">-&gt;</span><span class="n">perif</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">istat</span><span class="p">;</span>
	<span class="n">mace_int</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">MACEISA_AUDIO_SW_IRQ</span><span class="p">));</span>
	<span class="n">mace</span><span class="o">-&gt;</span><span class="n">perif</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">istat</span> <span class="o">=</span> <span class="n">mace_int</span><span class="p">;</span>

	<span class="n">disable_maceisa_irq</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">ip32_maceisa_level_interrupt</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;IP32 MACE ISA&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask</span>	<span class="o">=</span> <span class="n">disable_maceisa_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span>	<span class="o">=</span> <span class="n">enable_maceisa_irq</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">ip32_maceisa_edge_interrupt</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;IP32 MACE ISA&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_ack</span>	<span class="o">=</span> <span class="n">mask_and_ack_maceisa_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask</span>	<span class="o">=</span> <span class="n">disable_maceisa_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask_ack</span>	<span class="o">=</span> <span class="n">mask_and_ack_maceisa_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span>	<span class="o">=</span> <span class="n">enable_maceisa_irq</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* This is used for regular non-ISA, non-PCI MACE interrupts.  That means</span>
<span class="cm"> * bits 0-3 and 7 in the CRIME register.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">enable_mace_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">CRIME_IRQ_BASE</span><span class="p">;</span>

	<span class="n">crime_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">);</span>
	<span class="n">crime</span><span class="o">-&gt;</span><span class="n">imask</span> <span class="o">=</span> <span class="n">crime_mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">disable_mace_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">CRIME_IRQ_BASE</span><span class="p">;</span>

	<span class="n">crime_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">);</span>
	<span class="n">crime</span><span class="o">-&gt;</span><span class="n">imask</span> <span class="o">=</span> <span class="n">crime_mask</span><span class="p">;</span>
	<span class="n">flush_crime_bus</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">ip32_mace_interrupt</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;IP32 MACE&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask</span> <span class="o">=</span> <span class="n">disable_mace_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span> <span class="o">=</span> <span class="n">enable_mace_irq</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ip32_unknown_interrupt</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Unknown interrupt occurred!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;cp0_status: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">read_c0_status</span><span class="p">());</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;cp0_cause: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">read_c0_cause</span><span class="p">());</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;CRIME intr mask: %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">crime</span><span class="o">-&gt;</span><span class="n">imask</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;CRIME intr status: %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">crime</span><span class="o">-&gt;</span><span class="n">istat</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;CRIME hardware intr register: %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">crime</span><span class="o">-&gt;</span><span class="n">hard_int</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;MACE ISA intr mask: %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mace</span><span class="o">-&gt;</span><span class="n">perif</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">imask</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;MACE ISA intr status: %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mace</span><span class="o">-&gt;</span><span class="n">perif</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">istat</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;MACE PCI control register: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mace</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">.</span><span class="n">control</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Register dump:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">show_regs</span><span class="p">(</span><span class="n">get_irq_regs</span><span class="p">());</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Please mail this report to linux-mips@linux-mips.org</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Spinning...&quot;</span><span class="p">);</span>
	<span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* CRIME 1.1 appears to deliver all interrupts to this one pin. */</span>
<span class="cm">/* change this to loop over all edge-triggered irqs, exception masked out ones */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ip32_irq0</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint64_t</span> <span class="n">crime_int</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Sanity check interrupt numbering enum.</span>
<span class="cm">	 * MACE got 32 interrupts and there are 32 MACE ISA interrupts daisy</span>
<span class="cm">	 * chained.</span>
<span class="cm">	 */</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">CRIME_VICE_IRQ</span> <span class="o">-</span> <span class="n">MACE_VID_IN1_IRQ</span> <span class="o">!=</span> <span class="mi">31</span><span class="p">);</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">MACEISA_SERIAL2_RDMAOR_IRQ</span> <span class="o">-</span> <span class="n">MACEISA_AUDIO_SW_IRQ</span> <span class="o">!=</span> <span class="mi">31</span><span class="p">);</span>

	<span class="n">crime_int</span> <span class="o">=</span> <span class="n">crime</span><span class="o">-&gt;</span><span class="n">istat</span> <span class="o">&amp;</span> <span class="n">crime_mask</span><span class="p">;</span>

	<span class="cm">/* crime sometime delivers spurious interrupts, ignore them */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">crime_int</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">MACE_VID_IN1_IRQ</span> <span class="o">+</span> <span class="n">__ffs</span><span class="p">(</span><span class="n">crime_int</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crime_int</span> <span class="o">&amp;</span> <span class="n">CRIME_MACEISA_INT_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mace_int</span> <span class="o">=</span> <span class="n">mace</span><span class="o">-&gt;</span><span class="n">perif</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">istat</span><span class="p">;</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">__ffs</span><span class="p">(</span><span class="n">mace_int</span> <span class="o">&amp;</span> <span class="n">maceisa_mask</span><span class="p">)</span> <span class="o">+</span> <span class="n">MACEISA_AUDIO_SW_IRQ</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;*irq %u*</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
	<span class="n">do_IRQ</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ip32_irq1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ip32_unknown_interrupt</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ip32_irq2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ip32_unknown_interrupt</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ip32_irq3</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ip32_unknown_interrupt</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ip32_irq4</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ip32_unknown_interrupt</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ip32_irq5</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">do_IRQ</span><span class="p">(</span><span class="n">MIPS_CPU_IRQ_BASE</span> <span class="o">+</span> <span class="mi">7</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">plat_irq_dispatch</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pending</span> <span class="o">=</span> <span class="n">read_c0_status</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">read_c0_cause</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">pending</span> <span class="o">&amp;</span> <span class="n">IE_IRQ0</span><span class="p">))</span>
		<span class="n">ip32_irq0</span><span class="p">();</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pending</span> <span class="o">&amp;</span> <span class="n">IE_IRQ1</span><span class="p">))</span>
		<span class="n">ip32_irq1</span><span class="p">();</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pending</span> <span class="o">&amp;</span> <span class="n">IE_IRQ2</span><span class="p">))</span>
		<span class="n">ip32_irq2</span><span class="p">();</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pending</span> <span class="o">&amp;</span> <span class="n">IE_IRQ3</span><span class="p">))</span>
		<span class="n">ip32_irq3</span><span class="p">();</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pending</span> <span class="o">&amp;</span> <span class="n">IE_IRQ4</span><span class="p">))</span>
		<span class="n">ip32_irq4</span><span class="p">();</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">pending</span> <span class="o">&amp;</span> <span class="n">IE_IRQ5</span><span class="p">))</span>
		<span class="n">ip32_irq5</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">arch_init_irq</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="cm">/* Install our interrupt handler, then clear and disable all</span>
<span class="cm">	 * CRIME and MACE interrupts. */</span>
	<span class="n">crime</span><span class="o">-&gt;</span><span class="n">imask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">crime</span><span class="o">-&gt;</span><span class="n">hard_int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">crime</span><span class="o">-&gt;</span><span class="n">soft_int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mace</span><span class="o">-&gt;</span><span class="n">perif</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">istat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mace</span><span class="o">-&gt;</span><span class="n">perif</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">imask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mips_cpu_irq_init</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">irq</span> <span class="o">=</span> <span class="n">CRIME_IRQ_BASE</span><span class="p">;</span> <span class="n">irq</span> <span class="o">&lt;=</span> <span class="n">IP32_IRQ_MAX</span><span class="p">;</span> <span class="n">irq</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MACE_VID_IN1_IRQ</span> <span class="p">...</span> <span class="n">MACE_PCI_BRIDGE_IRQ</span>:
			<span class="n">irq_set_chip_and_handler_name</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">ip32_mace_interrupt</span><span class="p">,</span>
						      <span class="n">handle_level_irq</span><span class="p">,</span>
						      <span class="s">&quot;level&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MACEPCI_SCSI0_IRQ</span> <span class="p">...</span>  <span class="n">MACEPCI_SHARED2_IRQ</span>:
			<span class="n">irq_set_chip_and_handler_name</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">ip32_macepci_interrupt</span><span class="p">,</span>
						      <span class="n">handle_level_irq</span><span class="p">,</span>
						      <span class="s">&quot;level&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">CRIME_CPUERR_IRQ</span>:
		<span class="k">case</span> <span class="n">CRIME_MEMERR_IRQ</span>:
			<span class="n">irq_set_chip_and_handler_name</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">crime_level_interrupt</span><span class="p">,</span>
						      <span class="n">handle_level_irq</span><span class="p">,</span>
						      <span class="s">&quot;level&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">CRIME_GBE0_IRQ</span> <span class="p">...</span> <span class="n">CRIME_GBE3_IRQ</span>:
		<span class="k">case</span> <span class="n">CRIME_RE_EMPTY_E_IRQ</span> <span class="p">...</span> <span class="n">CRIME_RE_IDLE_E_IRQ</span>:
		<span class="k">case</span> <span class="n">CRIME_SOFT0_IRQ</span> <span class="p">...</span> <span class="n">CRIME_SOFT2_IRQ</span>:
		<span class="k">case</span> <span class="n">CRIME_VICE_IRQ</span>:
			<span class="n">irq_set_chip_and_handler_name</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">crime_edge_interrupt</span><span class="p">,</span>
						      <span class="n">handle_edge_irq</span><span class="p">,</span>
						      <span class="s">&quot;edge&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MACEISA_PARALLEL_IRQ</span>:
		<span class="k">case</span> <span class="n">MACEISA_SERIAL1_TDMAPR_IRQ</span>:
		<span class="k">case</span> <span class="n">MACEISA_SERIAL2_TDMAPR_IRQ</span>:
			<span class="n">irq_set_chip_and_handler_name</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">ip32_maceisa_edge_interrupt</span><span class="p">,</span>
						      <span class="n">handle_edge_irq</span><span class="p">,</span>
						      <span class="s">&quot;edge&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">irq_set_chip_and_handler_name</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">ip32_maceisa_level_interrupt</span><span class="p">,</span>
						      <span class="n">handle_level_irq</span><span class="p">,</span>
						      <span class="s">&quot;level&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">setup_irq</span><span class="p">(</span><span class="n">CRIME_MEMERR_IRQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">memerr_irq</span><span class="p">);</span>
	<span class="n">setup_irq</span><span class="p">(</span><span class="n">CRIME_CPUERR_IRQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cpuerr_irq</span><span class="p">);</span>

<span class="cp">#define ALLINTS (IE_IRQ0 | IE_IRQ1 | IE_IRQ2 | IE_IRQ3 | IE_IRQ4 | IE_IRQ5)</span>
	<span class="n">change_c0_status</span><span class="p">(</span><span class="n">ST0_IM</span><span class="p">,</span> <span class="n">ALLINTS</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
