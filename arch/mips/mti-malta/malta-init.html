<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › mips › mti-malta › malta-init.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>malta-init.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 1999, 2000, 2004, 2005  MIPS Technologies, Inc.</span>
<span class="cm"> *	All rights reserved.</span>
<span class="cm"> *	Authors: Carsten Langgaard &lt;carstenl@mips.com&gt;</span>
<span class="cm"> *		 Maciej W. Rozycki &lt;macro@mips.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can distribute it and/or modify it</span>
<span class="cm"> *  under the terms of the GNU General Public License (Version 2) as</span>
<span class="cm"> *  published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope it will be useful, but WITHOUT</span>
<span class="cm"> *  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> *  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License</span>
<span class="cm"> *  for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License along</span>
<span class="cm"> *  with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> *  59 Temple Place - Suite 330, Boston MA 02111-1307, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * PROM library initialisation code.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>

<span class="cp">#include &lt;asm/bootinfo.h&gt;</span>
<span class="cp">#include &lt;asm/gt64120.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/cacheflush.h&gt;</span>
<span class="cp">#include &lt;asm/smp-ops.h&gt;</span>
<span class="cp">#include &lt;asm/traps.h&gt;</span>

<span class="cp">#include &lt;asm/gcmpregs.h&gt;</span>
<span class="cp">#include &lt;asm/mips-boards/prom.h&gt;</span>
<span class="cp">#include &lt;asm/mips-boards/generic.h&gt;</span>
<span class="cp">#include &lt;asm/mips-boards/bonito64.h&gt;</span>
<span class="cp">#include &lt;asm/mips-boards/msc01_pci.h&gt;</span>

<span class="cp">#include &lt;asm/mips-boards/malta.h&gt;</span>

<span class="kt">int</span> <span class="n">prom_argc</span><span class="p">;</span>
<span class="kt">int</span> <span class="o">*</span><span class="n">_prom_argv</span><span class="p">,</span> <span class="o">*</span><span class="n">_prom_envp</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * YAMON (32-bit PROM) pass arguments and environment as 32-bit pointer.</span>
<span class="cm"> * This macro take care of sign extension, if running in 64-bit mode.</span>
<span class="cm"> */</span>
<span class="cp">#define prom_envp(index) ((char *)(long)_prom_envp[(index)])</span>

<span class="kt">int</span> <span class="n">init_debug</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">mips_revision_corid</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">mips_revision_sconid</span><span class="p">;</span>

<span class="cm">/* Bonito64 system controller register base. */</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">_pcictrl_bonito</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">_pcictrl_bonito_pcicfg</span><span class="p">;</span>

<span class="cm">/* GT64120 system controller register base */</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">_pcictrl_gt64120</span><span class="p">;</span>

<span class="cm">/* MIPS System controller register base */</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">_pcictrl_msc</span><span class="p">;</span>

<span class="kt">char</span> <span class="o">*</span><span class="nf">prom_getenv</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">envname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Return a pointer to the given environment variable.</span>
<span class="cm">	 * In 64-bit mode: we&#39;re using 64-bit pointers, but all pointers</span>
<span class="cm">	 * in the PROM structures are only 32-bit, so we need some</span>
<span class="cm">	 * workarounds, if we are running in 64-bit mode.</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">envname</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">prom_envp</span><span class="p">(</span><span class="n">index</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">envname</span><span class="p">,</span> <span class="n">prom_envp</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span><span class="p">(</span><span class="n">prom_envp</span><span class="p">(</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">index</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">str2hexnum</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">c</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="sc">&#39;a&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">&#39;f&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">c</span> <span class="o">-</span> <span class="sc">&#39;a&#39;</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* foo */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">str2eaddr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ea</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">num</span><span class="p">;</span>

		<span class="k">if</span><span class="p">((</span><span class="o">*</span><span class="n">str</span> <span class="o">==</span> <span class="sc">&#39;.&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span> <span class="o">==</span> <span class="sc">&#39;:&#39;</span><span class="p">))</span>
			<span class="n">str</span><span class="o">++</span><span class="p">;</span>
		<span class="n">num</span> <span class="o">=</span> <span class="n">str2hexnum</span><span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="o">++</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">num</span> <span class="o">|=</span> <span class="p">(</span><span class="n">str2hexnum</span><span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="o">++</span><span class="p">));</span>
		<span class="n">ea</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">num</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">get_ethernet_addr</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">ethernet_addr</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">ethaddr_str</span><span class="p">;</span>

        <span class="n">ethaddr_str</span> <span class="o">=</span> <span class="n">prom_getenv</span><span class="p">(</span><span class="s">&quot;ethaddr&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ethaddr_str</span><span class="p">)</span> <span class="p">{</span>
	        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;ethaddr not set in boot prom</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">str2eaddr</span><span class="p">(</span><span class="n">ethernet_addr</span><span class="p">,</span> <span class="n">ethaddr_str</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">init_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	        <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;get_ethernet_addr: &quot;</span><span class="p">);</span>
	        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x:&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ethernet_addr</span><span class="o">+</span><span class="n">i</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">ethernet_addr</span><span class="o">+</span><span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SERIAL_8250_CONSOLE</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">console_config</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">console_string</span><span class="p">[</span><span class="mi">40</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">baud</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">parity</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">,</span> <span class="n">bits</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">,</span> <span class="n">flow</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">strstr</span><span class="p">(</span><span class="n">prom_getcmdline</span><span class="p">(),</span> <span class="s">&quot;console=&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">prom_getenv</span><span class="p">(</span><span class="s">&quot;modetty0&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">s</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">)</span>
				<span class="n">baud</span> <span class="o">=</span> <span class="n">baud</span><span class="o">*</span><span class="mi">10</span> <span class="o">+</span> <span class="o">*</span><span class="n">s</span><span class="o">++</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span> <span class="n">s</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">)</span> <span class="n">parity</span> <span class="o">=</span> <span class="o">*</span><span class="n">s</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span> <span class="n">s</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">)</span> <span class="n">bits</span> <span class="o">=</span> <span class="o">*</span><span class="n">s</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span> <span class="n">s</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">==</span> <span class="sc">&#39;h&#39;</span><span class="p">)</span> <span class="n">flow</span> <span class="o">=</span> <span class="sc">&#39;r&#39;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">baud</span> <span class="o">=</span> <span class="mi">38400</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">parity</span> <span class="o">!=</span> <span class="sc">&#39;n&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">parity</span> <span class="o">!=</span> <span class="sc">&#39;o&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">parity</span> <span class="o">!=</span> <span class="sc">&#39;e&#39;</span><span class="p">)</span>
			<span class="n">parity</span> <span class="o">=</span> <span class="sc">&#39;n&#39;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">!=</span> <span class="sc">&#39;7&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">bits</span> <span class="o">!=</span> <span class="sc">&#39;8&#39;</span><span class="p">)</span>
			<span class="n">bits</span> <span class="o">=</span> <span class="sc">&#39;8&#39;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flow</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
			<span class="n">flow</span> <span class="o">=</span> <span class="sc">&#39;r&#39;</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">console_string</span><span class="p">,</span> <span class="s">&quot; console=ttyS0,%d%c%c%c&quot;</span><span class="p">,</span> <span class="n">baud</span><span class="p">,</span> <span class="n">parity</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">flow</span><span class="p">);</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">prom_getcmdline</span><span class="p">(),</span> <span class="n">console_string</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Config serial console:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">console_string</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">mips_nmi_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="k">extern</span> <span class="kt">char</span> <span class="n">except_vec_nmi</span><span class="p">;</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">cpu_has_veic</span> <span class="o">?</span>
		<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">CAC_BASE</span> <span class="o">+</span> <span class="mh">0xa80</span><span class="p">)</span> <span class="o">:</span>
		<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">CAC_BASE</span> <span class="o">+</span> <span class="mh">0x380</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">except_vec_nmi</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">flush_icache_range</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">base</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">mips_ejtag_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="k">extern</span> <span class="kt">char</span> <span class="n">except_vec_ejtag_debug</span><span class="p">;</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">cpu_has_veic</span> <span class="o">?</span>
		<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">CAC_BASE</span> <span class="o">+</span> <span class="mh">0xa00</span><span class="p">)</span> <span class="o">:</span>
		<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">CAC_BASE</span> <span class="o">+</span> <span class="mh">0x300</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">except_vec_ejtag_debug</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">flush_icache_range</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">base</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">plat_smp_ops</span> <span class="n">msmtc_smp_ops</span><span class="p">;</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">prom_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">prom_argc</span> <span class="o">=</span> <span class="n">fw_arg0</span><span class="p">;</span>
	<span class="n">_prom_argv</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">fw_arg1</span><span class="p">;</span>
	<span class="n">_prom_envp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">fw_arg2</span><span class="p">;</span>

	<span class="n">mips_display_message</span><span class="p">(</span><span class="s">&quot;LINUX&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * early setup of _pcictrl_bonito so that we can determine</span>
<span class="cm">	 * the system controller on a CORE_EMUL board</span>
<span class="cm">	 */</span>
	<span class="n">_pcictrl_bonito</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ioremap</span><span class="p">(</span><span class="n">BONITO_REG_BASE</span><span class="p">,</span> <span class="n">BONITO_REG_SIZE</span><span class="p">);</span>

	<span class="n">mips_revision_corid</span> <span class="o">=</span> <span class="n">MIPS_REVISION_CORID</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mips_revision_corid</span> <span class="o">==</span> <span class="n">MIPS_REVISION_CORID_CORE_EMUL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BONITO_PCIDID</span> <span class="o">==</span> <span class="mh">0x0001df53</span> <span class="o">||</span>
		    <span class="n">BONITO_PCIDID</span> <span class="o">==</span> <span class="mh">0x0003df53</span><span class="p">)</span>
			<span class="n">mips_revision_corid</span> <span class="o">=</span> <span class="n">MIPS_REVISION_CORID_CORE_EMUL_BON</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mips_revision_corid</span> <span class="o">=</span> <span class="n">MIPS_REVISION_CORID_CORE_EMUL_MSC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mips_revision_sconid</span> <span class="o">=</span> <span class="n">MIPS_REVISION_SCONID</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mips_revision_sconid</span> <span class="o">==</span> <span class="n">MIPS_REVISION_SCON_OTHER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">mips_revision_corid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MIPS_REVISION_CORID_QED_RM5261</span>:
		<span class="k">case</span> <span class="n">MIPS_REVISION_CORID_CORE_LV</span>:
		<span class="k">case</span> <span class="n">MIPS_REVISION_CORID_CORE_FPGA</span>:
		<span class="k">case</span> <span class="n">MIPS_REVISION_CORID_CORE_FPGAR2</span>:
			<span class="n">mips_revision_sconid</span> <span class="o">=</span> <span class="n">MIPS_REVISION_SCON_GT64120</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MIPS_REVISION_CORID_CORE_EMUL_BON</span>:
		<span class="k">case</span> <span class="n">MIPS_REVISION_CORID_BONITO64</span>:
		<span class="k">case</span> <span class="n">MIPS_REVISION_CORID_CORE_20K</span>:
			<span class="n">mips_revision_sconid</span> <span class="o">=</span> <span class="n">MIPS_REVISION_SCON_BONITO</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MIPS_REVISION_CORID_CORE_MSC</span>:
		<span class="k">case</span> <span class="n">MIPS_REVISION_CORID_CORE_FPGA2</span>:
		<span class="k">case</span> <span class="n">MIPS_REVISION_CORID_CORE_24K</span>:
			<span class="cm">/*</span>
<span class="cm">			 * SOCit/ROCit support is essentially identical</span>
<span class="cm">			 * but make an attempt to distinguish them</span>
<span class="cm">			 */</span>
			<span class="n">mips_revision_sconid</span> <span class="o">=</span> <span class="n">MIPS_REVISION_SCON_SOCIT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MIPS_REVISION_CORID_CORE_FPGA3</span>:
		<span class="k">case</span> <span class="n">MIPS_REVISION_CORID_CORE_FPGA4</span>:
		<span class="k">case</span> <span class="n">MIPS_REVISION_CORID_CORE_FPGA5</span>:
		<span class="k">case</span> <span class="n">MIPS_REVISION_CORID_CORE_EMUL_MSC</span>:
		<span class="nl">default:</span>
			<span class="cm">/* See above */</span>
			<span class="n">mips_revision_sconid</span> <span class="o">=</span> <span class="n">MIPS_REVISION_SCON_ROCIT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mips_revision_sconid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">start</span><span class="p">,</span> <span class="n">map</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MIPS_REVISION_SCON_GT64120</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Setup the North bridge to do Master byte-lane swapping</span>
<span class="cm">		 * when running in bigendian.</span>
<span class="cm">		 */</span>
		<span class="n">_pcictrl_gt64120</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ioremap</span><span class="p">(</span><span class="n">MIPS_GT_BASE</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_CPU_LITTLE_ENDIAN</span>
		<span class="n">GT_WRITE</span><span class="p">(</span><span class="n">GT_PCI0_CMD_OFS</span><span class="p">,</span> <span class="n">GT_PCI0_CMD_MBYTESWAP_BIT</span> <span class="o">|</span>
			 <span class="n">GT_PCI0_CMD_SBYTESWAP_BIT</span><span class="p">);</span>
<span class="cp">#else</span>
		<span class="n">GT_WRITE</span><span class="p">(</span><span class="n">GT_PCI0_CMD_OFS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="cm">/* Fix up PCI I/O mapping if necessary (for Atlas).  */</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">GT_READ</span><span class="p">(</span><span class="n">GT_PCI0IOLD_OFS</span><span class="p">);</span>
		<span class="n">map</span> <span class="o">=</span> <span class="n">GT_READ</span><span class="p">(</span><span class="n">GT_PCI0IOREMAP_OFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">start</span> <span class="o">&amp;</span> <span class="n">map</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">map</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">start</span><span class="p">;</span>
			<span class="n">GT_WRITE</span><span class="p">(</span><span class="n">GT_PCI0IOREMAP_OFS</span><span class="p">,</span> <span class="n">map</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">set_io_port_base</span><span class="p">(</span><span class="n">MALTA_GT_PORT_BASE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MIPS_REVISION_SCON_BONITO</span>:
		<span class="n">_pcictrl_bonito_pcicfg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ioremap</span><span class="p">(</span><span class="n">BONITO_PCICFG_BASE</span><span class="p">,</span> <span class="n">BONITO_PCICFG_SIZE</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Disable Bonito IOBC.</span>
<span class="cm">		 */</span>
		<span class="n">BONITO_PCIMEMBASECFG</span> <span class="o">=</span> <span class="n">BONITO_PCIMEMBASECFG</span> <span class="o">&amp;</span>
			<span class="o">~</span><span class="p">(</span><span class="n">BONITO_PCIMEMBASECFG_MEMBASE0_CACHED</span> <span class="o">|</span>
			  <span class="n">BONITO_PCIMEMBASECFG_MEMBASE1_CACHED</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Setup the North bridge to do Master byte-lane swapping</span>
<span class="cm">		 * when running in bigendian.</span>
<span class="cm">		 */</span>
<span class="cp">#ifdef CONFIG_CPU_LITTLE_ENDIAN</span>
		<span class="n">BONITO_BONGENCFG</span> <span class="o">=</span> <span class="n">BONITO_BONGENCFG</span> <span class="o">&amp;</span>
			<span class="o">~</span><span class="p">(</span><span class="n">BONITO_BONGENCFG_MSTRBYTESWAP</span> <span class="o">|</span>
			  <span class="n">BONITO_BONGENCFG_BYTESWAP</span><span class="p">);</span>
<span class="cp">#else</span>
		<span class="n">BONITO_BONGENCFG</span> <span class="o">=</span> <span class="n">BONITO_BONGENCFG</span> <span class="o">|</span>
			<span class="n">BONITO_BONGENCFG_MSTRBYTESWAP</span> <span class="o">|</span>
			<span class="n">BONITO_BONGENCFG_BYTESWAP</span><span class="p">;</span>
<span class="cp">#endif</span>

		<span class="n">set_io_port_base</span><span class="p">(</span><span class="n">MALTA_BONITO_PORT_BASE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MIPS_REVISION_SCON_SOCIT</span>:
	<span class="k">case</span> <span class="n">MIPS_REVISION_SCON_ROCIT</span>:
		<span class="n">_pcictrl_msc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ioremap</span><span class="p">(</span><span class="n">MIPS_MSC01_PCI_REG_BASE</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">);</span>
	<span class="nl">mips_pci_controller:</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="n">MSC_READ</span><span class="p">(</span><span class="n">MSC01_PCI_CFG</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="n">MSC_WRITE</span><span class="p">(</span><span class="n">MSC01_PCI_CFG</span><span class="p">,</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MSC01_PCI_CFG_EN_BIT</span><span class="p">);</span>
		<span class="n">wmb</span><span class="p">();</span>

		<span class="cm">/* Fix up lane swapping.  */</span>
<span class="cp">#ifdef CONFIG_CPU_LITTLE_ENDIAN</span>
		<span class="n">MSC_WRITE</span><span class="p">(</span><span class="n">MSC01_PCI_SWAP</span><span class="p">,</span> <span class="n">MSC01_PCI_SWAP_NOSWAP</span><span class="p">);</span>
<span class="cp">#else</span>
		<span class="n">MSC_WRITE</span><span class="p">(</span><span class="n">MSC01_PCI_SWAP</span><span class="p">,</span>
			  <span class="n">MSC01_PCI_SWAP_BYTESWAP</span> <span class="o">&lt;&lt;</span> <span class="n">MSC01_PCI_SWAP_IO_SHF</span> <span class="o">|</span>
			  <span class="n">MSC01_PCI_SWAP_BYTESWAP</span> <span class="o">&lt;&lt;</span> <span class="n">MSC01_PCI_SWAP_MEM_SHF</span> <span class="o">|</span>
			  <span class="n">MSC01_PCI_SWAP_BYTESWAP</span> <span class="o">&lt;&lt;</span> <span class="n">MSC01_PCI_SWAP_BAR0_SHF</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="cm">/* Fix up target memory mapping.  */</span>
		<span class="n">MSC_READ</span><span class="p">(</span><span class="n">MSC01_PCI_BAR0</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
		<span class="n">MSC_WRITE</span><span class="p">(</span><span class="n">MSC01_PCI_P2SCMSKL</span><span class="p">,</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">MSC01_PCI_BAR0_SIZE_MSK</span><span class="p">);</span>

		<span class="cm">/* Don&#39;t handle target retries indefinitely.  */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">MSC01_PCI_CFG_MAXRTRY_MSK</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">MSC01_PCI_CFG_MAXRTRY_MSK</span><span class="p">)</span>
			<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">MSC01_PCI_CFG_MAXRTRY_MSK</span> <span class="o">&lt;&lt;</span>
					 <span class="n">MSC01_PCI_CFG_MAXRTRY_SHF</span><span class="p">))</span> <span class="o">|</span>
			       <span class="p">((</span><span class="n">MSC01_PCI_CFG_MAXRTRY_MSK</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
				<span class="n">MSC01_PCI_CFG_MAXRTRY_SHF</span><span class="p">);</span>

		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">MSC_WRITE</span><span class="p">(</span><span class="n">MSC01_PCI_CFG</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="n">mb</span><span class="p">();</span>

		<span class="n">set_io_port_base</span><span class="p">(</span><span class="n">MALTA_MSC_PORT_BASE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MIPS_REVISION_SCON_SOCITSC</span>:
	<span class="k">case</span> <span class="n">MIPS_REVISION_SCON_SOCITSCP</span>:
		<span class="n">_pcictrl_msc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ioremap</span><span class="p">(</span><span class="n">MIPS_SOCITSC_PCI_REG_BASE</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">mips_pci_controller</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* Unknown system controller */</span>
		<span class="n">mips_display_message</span><span class="p">(</span><span class="s">&quot;SC Error&quot;</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>   <span class="cm">/* We die here... */</span>
	<span class="p">}</span>
	<span class="n">board_nmi_handler_setup</span> <span class="o">=</span> <span class="n">mips_nmi_setup</span><span class="p">;</span>
	<span class="n">board_ejtag_handler_setup</span> <span class="o">=</span> <span class="n">mips_ejtag_setup</span><span class="p">;</span>

	<span class="n">prom_init_cmdline</span><span class="p">();</span>
	<span class="n">prom_meminit</span><span class="p">();</span>
<span class="cp">#ifdef CONFIG_SERIAL_8250_CONSOLE</span>
	<span class="n">console_config</span><span class="p">();</span>
<span class="cp">#endif</span>
	<span class="cm">/* Early detection of CMP support */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gcmp_probe</span><span class="p">(</span><span class="n">GCMP_BASE_ADDR</span><span class="p">,</span> <span class="n">GCMP_ADDRSPACE_SZ</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">register_cmp_smp_ops</span><span class="p">())</span>
			<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">register_vsmp_smp_ops</span><span class="p">())</span>
		<span class="k">return</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_MIPS_MT_SMTC</span>
	<span class="n">register_smp_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msmtc_smp_ops</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
