<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › mips › mti-malta › malta-int.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>malta-int.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Carsten Langgaard, carstenl@mips.com</span>
<span class="cm"> * Copyright (C) 2000, 2001, 2004 MIPS Technologies, Inc.</span>
<span class="cm"> * Copyright (C) 2001 Ralf Baechle</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can distribute it and/or modify it</span>
<span class="cm"> *  under the terms of the GNU General Public License (Version 2) as</span>
<span class="cm"> *  published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope it will be useful, but WITHOUT</span>
<span class="cm"> *  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> *  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License</span>
<span class="cm"> *  for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License along</span>
<span class="cm"> *  with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> *  59 Temple Place - Suite 330, Boston MA 02111-1307, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Routines for generic manipulation of the interrupts found on the MIPS</span>
<span class="cm"> * Malta board.</span>
<span class="cm"> * The interrupt controller is located in the South Bridge a PIIX4 device</span>
<span class="cm"> * with two internal 82C95 interrupt controllers.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/smp.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/kernel_stat.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>

<span class="cp">#include &lt;asm/traps.h&gt;</span>
<span class="cp">#include &lt;asm/i8259.h&gt;</span>
<span class="cp">#include &lt;asm/irq_cpu.h&gt;</span>
<span class="cp">#include &lt;asm/irq_regs.h&gt;</span>
<span class="cp">#include &lt;asm/mips-boards/malta.h&gt;</span>
<span class="cp">#include &lt;asm/mips-boards/maltaint.h&gt;</span>
<span class="cp">#include &lt;asm/mips-boards/piix4.h&gt;</span>
<span class="cp">#include &lt;asm/gt64120.h&gt;</span>
<span class="cp">#include &lt;asm/mips-boards/generic.h&gt;</span>
<span class="cp">#include &lt;asm/mips-boards/msc01_pci.h&gt;</span>
<span class="cp">#include &lt;asm/msc01_ic.h&gt;</span>
<span class="cp">#include &lt;asm/gic.h&gt;</span>
<span class="cp">#include &lt;asm/gcmpregs.h&gt;</span>
<span class="cp">#include &lt;asm/setup.h&gt;</span>

<span class="kt">int</span> <span class="n">gcmp_present</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">gic_present</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">_msc01_biu_base</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">_gcmp_base</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ipi_map</span><span class="p">[</span><span class="n">NR_CPUS</span><span class="p">];</span>

<span class="k">static</span> <span class="n">DEFINE_RAW_SPINLOCK</span><span class="p">(</span><span class="n">mips_irq_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">mips_pcibios_iack</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Determine highest priority pending interrupt by performing</span>
<span class="cm">	 * a PCI Interrupt Acknowledge cycle.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mips_revision_sconid</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MIPS_REVISION_SCON_SOCIT</span>:
	<span class="k">case</span> <span class="n">MIPS_REVISION_SCON_ROCIT</span>:
	<span class="k">case</span> <span class="n">MIPS_REVISION_SCON_SOCITSC</span>:
	<span class="k">case</span> <span class="n">MIPS_REVISION_SCON_SOCITSCP</span>:
		<span class="n">MSC_READ</span><span class="p">(</span><span class="n">MSC01_PCI_IACK</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
		<span class="n">irq</span> <span class="o">&amp;=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MIPS_REVISION_SCON_GT64120</span>:
		<span class="n">irq</span> <span class="o">=</span> <span class="n">GT_READ</span><span class="p">(</span><span class="n">GT_PCI0_IACK_OFS</span><span class="p">);</span>
		<span class="n">irq</span> <span class="o">&amp;=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MIPS_REVISION_SCON_BONITO</span>:
		<span class="cm">/* The following will generate a PCI IACK cycle on the</span>
<span class="cm">		 * Bonito controller. It&#39;s a little bit kludgy, but it</span>
<span class="cm">		 * was the easiest way to implement it in hardware at</span>
<span class="cm">		 * the given time.</span>
<span class="cm">		 */</span>
		<span class="n">BONITO_PCIMAP_CFG</span> <span class="o">=</span> <span class="mh">0x20000</span><span class="p">;</span>

		<span class="cm">/* Flush Bonito register block */</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">BONITO_PCIMAP_CFG</span><span class="p">;</span>
		<span class="n">iob</span><span class="p">();</span>    <span class="cm">/* sync */</span>

		<span class="n">irq</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">_pcictrl_bonito_pcicfg</span><span class="p">);</span>
		<span class="n">iob</span><span class="p">();</span>    <span class="cm">/* sync */</span>
		<span class="n">irq</span> <span class="o">&amp;=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">BONITO_PCIMAP_CFG</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Unknown system controller.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">irq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">get_int</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">raw_spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mips_irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">mips_pcibios_iack</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * The only way we can decide if an interrupt is spurious</span>
<span class="cm">	 * is by checking the 8259 registers.  This needs a spinlock</span>
<span class="cm">	 * on an SMP system,  so leave it up to the generic code...</span>
<span class="cm">	 */</span>

	<span class="n">raw_spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mips_irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">irq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">malta_hw0_irqdispatch</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">get_int</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* interrupt has already been cleared */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">do_IRQ</span><span class="p">(</span><span class="n">MALTA_INT_BASE</span> <span class="o">+</span> <span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">malta_ipi_irqdispatch</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">gic_get_int</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>  <span class="cm">/* interrupt has already been cleared */</span>

	<span class="n">do_IRQ</span><span class="p">(</span><span class="n">MIPS_GIC_IRQ_BASE</span> <span class="o">+</span> <span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">corehi_irqdispatch</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">intedge</span><span class="p">,</span> <span class="n">intsteer</span><span class="p">,</span> <span class="n">pcicmd</span><span class="p">,</span> <span class="n">pcibadaddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pcimstat</span><span class="p">,</span> <span class="n">intisr</span><span class="p">,</span> <span class="n">inten</span><span class="p">,</span> <span class="n">intpol</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">intrcause</span><span class="p">,</span> <span class="n">datalo</span><span class="p">,</span> <span class="n">datahi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">get_irq_regs</span><span class="p">();</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;CoreHI interrupt, shouldn&#39;t happen, we die here!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;epc   : %08lx</span><span class="se">\n</span><span class="s">Status: %08lx</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;Cause : %08lx</span><span class="se">\n</span><span class="s">badVaddr : %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">cp0_epc</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">cp0_status</span><span class="p">,</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">cp0_cause</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">cp0_badvaddr</span><span class="p">);</span>

	<span class="cm">/* Read all the registers and then print them as there is a</span>
<span class="cm">	   problem with interspersed printk&#39;s upsetting the Bonito controller.</span>
<span class="cm">	   Do it for the others too.</span>
<span class="cm">	*/</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mips_revision_sconid</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MIPS_REVISION_SCON_SOCIT</span>:
	<span class="k">case</span> <span class="n">MIPS_REVISION_SCON_ROCIT</span>:
	<span class="k">case</span> <span class="n">MIPS_REVISION_SCON_SOCITSC</span>:
	<span class="k">case</span> <span class="n">MIPS_REVISION_SCON_SOCITSCP</span>:
		<span class="n">ll_msc_irq</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MIPS_REVISION_SCON_GT64120</span>:
		<span class="n">intrcause</span> <span class="o">=</span> <span class="n">GT_READ</span><span class="p">(</span><span class="n">GT_INTRCAUSE_OFS</span><span class="p">);</span>
		<span class="n">datalo</span> <span class="o">=</span> <span class="n">GT_READ</span><span class="p">(</span><span class="n">GT_CPUERR_ADDRLO_OFS</span><span class="p">);</span>
		<span class="n">datahi</span> <span class="o">=</span> <span class="n">GT_READ</span><span class="p">(</span><span class="n">GT_CPUERR_ADDRHI_OFS</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;GT_INTRCAUSE = %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">intrcause</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;GT_CPUERR_ADDR = %02x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">datahi</span><span class="p">,</span> <span class="n">datalo</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MIPS_REVISION_SCON_BONITO</span>:
		<span class="n">pcibadaddr</span> <span class="o">=</span> <span class="n">BONITO_PCIBADADDR</span><span class="p">;</span>
		<span class="n">pcimstat</span> <span class="o">=</span> <span class="n">BONITO_PCIMSTAT</span><span class="p">;</span>
		<span class="n">intisr</span> <span class="o">=</span> <span class="n">BONITO_INTISR</span><span class="p">;</span>
		<span class="n">inten</span> <span class="o">=</span> <span class="n">BONITO_INTEN</span><span class="p">;</span>
		<span class="n">intpol</span> <span class="o">=</span> <span class="n">BONITO_INTPOL</span><span class="p">;</span>
		<span class="n">intedge</span> <span class="o">=</span> <span class="n">BONITO_INTEDGE</span><span class="p">;</span>
		<span class="n">intsteer</span> <span class="o">=</span> <span class="n">BONITO_INTSTEER</span><span class="p">;</span>
		<span class="n">pcicmd</span> <span class="o">=</span> <span class="n">BONITO_PCICMD</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;BONITO_INTISR = %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">intisr</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;BONITO_INTEN = %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inten</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;BONITO_INTPOL = %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">intpol</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;BONITO_INTEDGE = %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">intedge</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;BONITO_INTSTEER = %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">intsteer</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;BONITO_PCICMD = %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pcicmd</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;BONITO_PCIBADADDR = %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pcibadaddr</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;BONITO_PCIMSTAT = %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pcimstat</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">die</span><span class="p">(</span><span class="s">&quot;CoreHi interrupt&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">clz</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__asm__</span><span class="p">(</span>
	<span class="s">&quot;	.set	push					</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;	.set	mips32					</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;	clz	%0, %1					</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;	.set	pop					</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span>
	<span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">x</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">x</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Version of ffs that only looks at bits 12..15.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">irq_ffs</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pending</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_CPU_MIPS32) || defined(CONFIG_CPU_MIPS64)</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">clz</span><span class="p">(</span><span class="n">pending</span><span class="p">)</span> <span class="o">+</span> <span class="mi">31</span> <span class="o">-</span> <span class="n">CAUSEB_IP</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">a0</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">t0</span><span class="p">;</span>

	<span class="n">t0</span> <span class="o">=</span> <span class="n">pending</span> <span class="o">&amp;</span> <span class="mh">0xf000</span><span class="p">;</span>
	<span class="n">t0</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">t0</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">a0</span> <span class="o">=</span> <span class="n">a0</span> <span class="o">-</span> <span class="n">t0</span><span class="p">;</span>
	<span class="n">pending</span> <span class="o">=</span> <span class="n">pending</span> <span class="o">&lt;&lt;</span> <span class="n">t0</span><span class="p">;</span>

	<span class="n">t0</span> <span class="o">=</span> <span class="n">pending</span> <span class="o">&amp;</span> <span class="mh">0xc000</span><span class="p">;</span>
	<span class="n">t0</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">t0</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">a0</span> <span class="o">=</span> <span class="n">a0</span> <span class="o">-</span> <span class="n">t0</span><span class="p">;</span>
	<span class="n">pending</span> <span class="o">=</span> <span class="n">pending</span> <span class="o">&lt;&lt;</span> <span class="n">t0</span><span class="p">;</span>

	<span class="n">t0</span> <span class="o">=</span> <span class="n">pending</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">;</span>
	<span class="n">t0</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* t0 = t0 &lt;&lt; 2; */</span>
	<span class="n">a0</span> <span class="o">=</span> <span class="n">a0</span> <span class="o">-</span> <span class="n">t0</span><span class="p">;</span>
	<span class="cm">/* pending = pending &lt;&lt; t0; */</span>

	<span class="k">return</span> <span class="n">a0</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * IRQs on the Malta board look basically (barring software IRQs which we</span>
<span class="cm"> * don&#39;t use at all and all external interrupt sources are combined together</span>
<span class="cm"> * on hardware interrupt 0 (MIPS IRQ 2)) like:</span>
<span class="cm"> *</span>
<span class="cm"> *	MIPS IRQ	Source</span>
<span class="cm"> *      --------        ------</span>
<span class="cm"> *             0	Software (ignored)</span>
<span class="cm"> *             1        Software (ignored)</span>
<span class="cm"> *             2        Combined hardware interrupt (hw0)</span>
<span class="cm"> *             3        Hardware (ignored)</span>
<span class="cm"> *             4        Hardware (ignored)</span>
<span class="cm"> *             5        Hardware (ignored)</span>
<span class="cm"> *             6        Hardware (ignored)</span>
<span class="cm"> *             7        R4k timer (what we use)</span>
<span class="cm"> *</span>
<span class="cm"> * We handle the IRQ according to _our_ priority which is:</span>
<span class="cm"> *</span>
<span class="cm"> * Highest ----     R4k Timer</span>
<span class="cm"> * Lowest  ----     Combined hardware interrupt</span>
<span class="cm"> *</span>
<span class="cm"> * then we just return, if multiple IRQs are pending then we will just take</span>
<span class="cm"> * another exception, big deal.</span>
<span class="cm"> */</span>

<span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">plat_irq_dispatch</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pending</span> <span class="o">=</span> <span class="n">read_c0_cause</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">read_c0_status</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">ST0_IM</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">irq_ffs</span><span class="p">(</span><span class="n">pending</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">==</span> <span class="n">MIPSCPU_INT_I8259A</span><span class="p">)</span>
		<span class="n">malta_hw0_irqdispatch</span><span class="p">();</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">gic_present</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">irq</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ipi_map</span><span class="p">[</span><span class="n">smp_processor_id</span><span class="p">()]))</span>
		<span class="n">malta_ipi_irqdispatch</span><span class="p">();</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">do_IRQ</span><span class="p">(</span><span class="n">MIPS_CPU_IRQ_BASE</span> <span class="o">+</span> <span class="n">irq</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">spurious_interrupt</span><span class="p">();</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_MIPS_MT_SMP</span>


<span class="cp">#define GIC_MIPS_CPU_IPI_RESCHED_IRQ	3</span>
<span class="cp">#define GIC_MIPS_CPU_IPI_CALL_IRQ	4</span>

<span class="cp">#define MIPS_CPU_IPI_RESCHED_IRQ 0	</span><span class="cm">/* SW int 0 for resched */</span><span class="cp"></span>
<span class="cp">#define C_RESCHED C_SW0</span>
<span class="cp">#define MIPS_CPU_IPI_CALL_IRQ 1		</span><span class="cm">/* SW int 1 for resched */</span><span class="cp"></span>
<span class="cp">#define C_CALL C_SW1</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cpu_ipi_resched_irq</span><span class="p">,</span> <span class="n">cpu_ipi_call_irq</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipi_resched_dispatch</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">do_IRQ</span><span class="p">(</span><span class="n">MIPS_CPU_IRQ_BASE</span> <span class="o">+</span> <span class="n">MIPS_CPU_IPI_RESCHED_IRQ</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ipi_call_dispatch</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">do_IRQ</span><span class="p">(</span><span class="n">MIPS_CPU_IRQ_BASE</span> <span class="o">+</span> <span class="n">MIPS_CPU_IPI_CALL_IRQ</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ipi_resched_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scheduler_ipi</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ipi_call_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">smp_call_function_interrupt</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irqaction</span> <span class="n">irq_resched</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">handler</span>	<span class="o">=</span> <span class="n">ipi_resched_interrupt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IRQF_PERCPU</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;IPI_resched&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irqaction</span> <span class="n">irq_call</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">handler</span>	<span class="o">=</span> <span class="n">ipi_call_interrupt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IRQF_PERCPU</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;IPI_call&quot;</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MIPS_MT_SMP */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">gic_resched_int_base</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gic_call_int_base</span><span class="p">;</span>
<span class="cp">#define GIC_RESCHED_INT(cpu) (gic_resched_int_base+(cpu))</span>
<span class="cp">#define GIC_CALL_INT(cpu) (gic_call_int_base+(cpu))</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">plat_ipi_call_int_xlate</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">GIC_CALL_INT</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">plat_ipi_resched_int_xlate</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">GIC_RESCHED_INT</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irqaction</span> <span class="n">i8259irq</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">no_action</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;XT-PIC cascade&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IRQF_NO_THREAD</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irqaction</span> <span class="n">corehi_irqaction</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">no_action</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;CoreHi&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IRQF_NO_THREAD</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">msc_irqmap_t</span> <span class="n">__initdata</span> <span class="n">msc_irqmap</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">MSC01C_INT_TMR</span><span class="p">,</span>		<span class="n">MSC01_IRQ_EDGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">MSC01C_INT_PCI</span><span class="p">,</span>		<span class="n">MSC01_IRQ_LEVEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__initdata</span> <span class="n">msc_nr_irqs</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">msc_irqmap</span><span class="p">);</span>

<span class="k">static</span> <span class="n">msc_irqmap_t</span> <span class="n">__initdata</span> <span class="n">msc_eicirqmap</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">MSC01E_INT_SW0</span><span class="p">,</span>		<span class="n">MSC01_IRQ_LEVEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">MSC01E_INT_SW1</span><span class="p">,</span>		<span class="n">MSC01_IRQ_LEVEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">MSC01E_INT_I8259A</span><span class="p">,</span>		<span class="n">MSC01_IRQ_LEVEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">MSC01E_INT_SMI</span><span class="p">,</span>		<span class="n">MSC01_IRQ_LEVEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">MSC01E_INT_COREHI</span><span class="p">,</span>		<span class="n">MSC01_IRQ_LEVEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">MSC01E_INT_CORELO</span><span class="p">,</span>		<span class="n">MSC01_IRQ_LEVEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">MSC01E_INT_TMR</span><span class="p">,</span>		<span class="n">MSC01_IRQ_EDGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">MSC01E_INT_PCI</span><span class="p">,</span>		<span class="n">MSC01_IRQ_LEVEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">MSC01E_INT_PERFCTR</span><span class="p">,</span>		<span class="n">MSC01_IRQ_LEVEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">MSC01E_INT_CPUCTR</span><span class="p">,</span>		<span class="n">MSC01_IRQ_LEVEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__initdata</span> <span class="n">msc_nr_eicirqs</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">msc_eicirqmap</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * This GIC specific tabular array defines the association between External</span>
<span class="cm"> * Interrupts and CPUs/Core Interrupts. The nature of the External</span>
<span class="cm"> * Interrupts is also defined here - polarity/trigger.</span>
<span class="cm"> */</span>

<span class="cp">#define GIC_CPU_NMI GIC_MAP_TO_NMI_MSK</span>
<span class="cp">#define X GIC_UNUSED</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gic_intr_map</span> <span class="n">gic_intr_map</span><span class="p">[</span><span class="n">GIC_NUM_INTRS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">X</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span>		   <span class="n">X</span><span class="p">,</span>		<span class="n">X</span><span class="p">,</span>		<span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">X</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span>		   <span class="n">X</span><span class="p">,</span>	 	<span class="n">X</span><span class="p">,</span>		<span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">X</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span>		   <span class="n">X</span><span class="p">,</span>		<span class="n">X</span><span class="p">,</span>		<span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GIC_CPU_INT0</span><span class="p">,</span> <span class="n">GIC_POL_POS</span><span class="p">,</span> <span class="n">GIC_TRIG_LEVEL</span><span class="p">,</span> <span class="n">GIC_FLAG_TRANSPARENT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GIC_CPU_INT1</span><span class="p">,</span> <span class="n">GIC_POL_POS</span><span class="p">,</span> <span class="n">GIC_TRIG_LEVEL</span><span class="p">,</span> <span class="n">GIC_FLAG_TRANSPARENT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GIC_CPU_INT2</span><span class="p">,</span> <span class="n">GIC_POL_POS</span><span class="p">,</span> <span class="n">GIC_TRIG_LEVEL</span><span class="p">,</span> <span class="n">GIC_FLAG_TRANSPARENT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GIC_CPU_INT3</span><span class="p">,</span> <span class="n">GIC_POL_POS</span><span class="p">,</span> <span class="n">GIC_TRIG_LEVEL</span><span class="p">,</span> <span class="n">GIC_FLAG_TRANSPARENT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GIC_CPU_INT4</span><span class="p">,</span> <span class="n">GIC_POL_POS</span><span class="p">,</span> <span class="n">GIC_TRIG_LEVEL</span><span class="p">,</span> <span class="n">GIC_FLAG_TRANSPARENT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GIC_CPU_INT3</span><span class="p">,</span> <span class="n">GIC_POL_POS</span><span class="p">,</span> <span class="n">GIC_TRIG_LEVEL</span><span class="p">,</span> <span class="n">GIC_FLAG_TRANSPARENT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GIC_CPU_INT3</span><span class="p">,</span> <span class="n">GIC_POL_POS</span><span class="p">,</span> <span class="n">GIC_TRIG_LEVEL</span><span class="p">,</span> <span class="n">GIC_FLAG_TRANSPARENT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">X</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span>		   <span class="n">X</span><span class="p">,</span>		<span class="n">X</span><span class="p">,</span>		<span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">X</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span>		   <span class="n">X</span><span class="p">,</span>		<span class="n">X</span><span class="p">,</span>		<span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GIC_CPU_INT3</span><span class="p">,</span> <span class="n">GIC_POL_POS</span><span class="p">,</span> <span class="n">GIC_TRIG_LEVEL</span><span class="p">,</span> <span class="n">GIC_FLAG_TRANSPARENT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GIC_CPU_NMI</span><span class="p">,</span>  <span class="n">GIC_POL_POS</span><span class="p">,</span> <span class="n">GIC_TRIG_LEVEL</span><span class="p">,</span> <span class="n">GIC_FLAG_TRANSPARENT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GIC_CPU_NMI</span><span class="p">,</span>  <span class="n">GIC_POL_POS</span><span class="p">,</span> <span class="n">GIC_TRIG_LEVEL</span><span class="p">,</span> <span class="n">GIC_FLAG_TRANSPARENT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">X</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span>		   <span class="n">X</span><span class="p">,</span>		<span class="n">X</span><span class="p">,</span>	        <span class="mi">0</span> <span class="p">},</span>
	<span class="cm">/* The remainder of this table is initialised by fill_ipi_map */</span>
<span class="p">};</span>
<span class="cp">#undef X</span>

<span class="cm">/*</span>
<span class="cm"> * GCMP needs to be detected before any SMP initialisation</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">__init</span> <span class="nf">gcmp_probe</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mips_revision_sconid</span> <span class="o">!=</span> <span class="n">MIPS_REVISION_SCON_ROCIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gcmp_present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">gcmp_present</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gcmp_present</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">gcmp_present</span><span class="p">;</span>

	<span class="n">_gcmp_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">GCMP_BASE_ADDR</span><span class="p">,</span> <span class="n">GCMP_ADDRSPACE_SZ</span><span class="p">);</span>
	<span class="n">_msc01_biu_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">MSC01_BIU_REG_BASE</span><span class="p">,</span> <span class="n">MSC01_BIU_ADDRSPACE_SZ</span><span class="p">);</span>
	<span class="n">gcmp_present</span> <span class="o">=</span> <span class="p">(</span><span class="n">GCMPGCB</span><span class="p">(</span><span class="n">GCMPB</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">GCMP_GCB_GCMPB_GCMPBASE_MSK</span><span class="p">)</span> <span class="o">==</span> <span class="n">GCMP_BASE_ADDR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gcmp_present</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;GCMP present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">gcmp_present</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Return the number of IOCU&#39;s present */</span>
<span class="kt">int</span> <span class="n">__init</span> <span class="nf">gcmp_niocu</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">gcmp_present</span> <span class="o">?</span>
    <span class="p">(</span><span class="n">GCMPGCB</span><span class="p">(</span><span class="n">GC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">GCMP_GCB_GC_NUMIOCU_MSK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">GCMP_GCB_GC_NUMIOCU_SHF</span> <span class="o">:</span>
    <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Set GCMP region attributes */</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">gcmp_setregion</span><span class="p">(</span><span class="kt">int</span> <span class="n">region</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">GCMPGCBn</span><span class="p">(</span><span class="n">CMxBASE</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">GCMPGCBn</span><span class="p">(</span><span class="n">CMxMASK</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="n">type</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_MIPS_MT_SMP)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">fill_ipi_map1</span><span class="p">(</span><span class="kt">int</span> <span class="n">baseintr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpupin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">intr</span> <span class="o">=</span> <span class="n">baseintr</span> <span class="o">+</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="n">gic_intr_map</span><span class="p">[</span><span class="n">intr</span><span class="p">].</span><span class="n">cpunum</span> <span class="o">=</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="n">gic_intr_map</span><span class="p">[</span><span class="n">intr</span><span class="p">].</span><span class="n">pin</span> <span class="o">=</span> <span class="n">cpupin</span><span class="p">;</span>
	<span class="n">gic_intr_map</span><span class="p">[</span><span class="n">intr</span><span class="p">].</span><span class="n">polarity</span> <span class="o">=</span> <span class="n">GIC_POL_POS</span><span class="p">;</span>
	<span class="n">gic_intr_map</span><span class="p">[</span><span class="n">intr</span><span class="p">].</span><span class="n">trigtype</span> <span class="o">=</span> <span class="n">GIC_TRIG_EDGE</span><span class="p">;</span>
	<span class="n">gic_intr_map</span><span class="p">[</span><span class="n">intr</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">GIC_FLAG_IPI</span><span class="p">;</span>
	<span class="n">ipi_map</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">cpupin</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">fill_ipi_map</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cpu</span> <span class="o">&lt;</span> <span class="n">NR_CPUS</span><span class="p">;</span> <span class="n">cpu</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fill_ipi_map1</span><span class="p">(</span><span class="n">gic_resched_int_base</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">GIC_CPU_INT1</span><span class="p">);</span>
		<span class="n">fill_ipi_map1</span><span class="p">(</span><span class="n">gic_call_int_base</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">GIC_CPU_INT2</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">arch_init_ipiirq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irqaction</span> <span class="o">*</span><span class="n">action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">setup_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">action</span><span class="p">);</span>
	<span class="n">irq_set_handler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">handle_percpu_irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">arch_init_irq</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">init_i8259_irqs</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_has_veic</span><span class="p">)</span>
		<span class="n">mips_cpu_irq_init</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gcmp_present</span><span class="p">)</span>  <span class="p">{</span>
		<span class="n">GCMPGCB</span><span class="p">(</span><span class="n">GICBA</span><span class="p">)</span> <span class="o">=</span> <span class="n">GIC_BASE_ADDR</span> <span class="o">|</span> <span class="n">GCMP_GCB_GICBA_EN_MSK</span><span class="p">;</span>
		<span class="n">gic_present</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mips_revision_sconid</span> <span class="o">==</span> <span class="n">MIPS_REVISION_SCON_ROCIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">_msc01_biu_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span>
					<span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">MSC01_BIU_REG_BASE</span><span class="p">,</span>
						<span class="n">MSC01_BIU_ADDRSPACE_SZ</span><span class="p">);</span>
			<span class="n">gic_present</span> <span class="o">=</span> <span class="p">(</span><span class="n">REG</span><span class="p">(</span><span class="n">_msc01_biu_base</span><span class="p">,</span> <span class="n">MSC01_SC_CFG</span><span class="p">)</span> <span class="o">&amp;</span>
					<span class="n">MSC01_SC_CFG_GICPRES_MSK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
					<span class="n">MSC01_SC_CFG_GICPRES_SHF</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gic_present</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;GIC present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mips_revision_sconid</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MIPS_REVISION_SCON_SOCIT</span>:
	<span class="k">case</span> <span class="n">MIPS_REVISION_SCON_ROCIT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_veic</span><span class="p">)</span>
			<span class="n">init_msc_irqs</span><span class="p">(</span><span class="n">MIPS_MSC01_IC_REG_BASE</span><span class="p">,</span>
					<span class="n">MSC01E_INT_BASE</span><span class="p">,</span> <span class="n">msc_eicirqmap</span><span class="p">,</span>
					<span class="n">msc_nr_eicirqs</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">init_msc_irqs</span><span class="p">(</span><span class="n">MIPS_MSC01_IC_REG_BASE</span><span class="p">,</span>
					<span class="n">MSC01C_INT_BASE</span><span class="p">,</span> <span class="n">msc_irqmap</span><span class="p">,</span>
					<span class="n">msc_nr_irqs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MIPS_REVISION_SCON_SOCITSC</span>:
	<span class="k">case</span> <span class="n">MIPS_REVISION_SCON_SOCITSCP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_veic</span><span class="p">)</span>
			<span class="n">init_msc_irqs</span><span class="p">(</span><span class="n">MIPS_SOCITSC_IC_REG_BASE</span><span class="p">,</span>
					<span class="n">MSC01E_INT_BASE</span><span class="p">,</span> <span class="n">msc_eicirqmap</span><span class="p">,</span>
					<span class="n">msc_nr_eicirqs</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">init_msc_irqs</span><span class="p">(</span><span class="n">MIPS_SOCITSC_IC_REG_BASE</span><span class="p">,</span>
					<span class="n">MSC01C_INT_BASE</span><span class="p">,</span> <span class="n">msc_irqmap</span><span class="p">,</span>
					<span class="n">msc_nr_irqs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_veic</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_vi_handler</span><span class="p">(</span><span class="n">MSC01E_INT_I8259A</span><span class="p">,</span> <span class="n">malta_hw0_irqdispatch</span><span class="p">);</span>
		<span class="n">set_vi_handler</span><span class="p">(</span><span class="n">MSC01E_INT_COREHI</span><span class="p">,</span> <span class="n">corehi_irqdispatch</span><span class="p">);</span>
		<span class="n">setup_irq</span><span class="p">(</span><span class="n">MSC01E_INT_BASE</span><span class="o">+</span><span class="n">MSC01E_INT_I8259A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i8259irq</span><span class="p">);</span>
		<span class="n">setup_irq</span><span class="p">(</span><span class="n">MSC01E_INT_BASE</span><span class="o">+</span><span class="n">MSC01E_INT_COREHI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">corehi_irqaction</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_vint</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_vi_handler</span><span class="p">(</span><span class="n">MIPSCPU_INT_I8259A</span><span class="p">,</span> <span class="n">malta_hw0_irqdispatch</span><span class="p">);</span>
		<span class="n">set_vi_handler</span><span class="p">(</span><span class="n">MIPSCPU_INT_COREHI</span><span class="p">,</span> <span class="n">corehi_irqdispatch</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_MIPS_MT_SMTC</span>
		<span class="n">setup_irq_smtc</span><span class="p">(</span><span class="n">MIPS_CPU_IRQ_BASE</span><span class="o">+</span><span class="n">MIPSCPU_INT_I8259A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i8259irq</span><span class="p">,</span>
			<span class="p">(</span><span class="mh">0x100</span> <span class="o">&lt;&lt;</span> <span class="n">MIPSCPU_INT_I8259A</span><span class="p">));</span>
		<span class="n">setup_irq_smtc</span><span class="p">(</span><span class="n">MIPS_CPU_IRQ_BASE</span><span class="o">+</span><span class="n">MIPSCPU_INT_COREHI</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">corehi_irqaction</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x100</span> <span class="o">&lt;&lt;</span> <span class="n">MIPSCPU_INT_COREHI</span><span class="p">));</span>
		<span class="cm">/*</span>
<span class="cm">		 * Temporary hack to ensure that the subsidiary device</span>
<span class="cm">		 * interrupts coing in via the i8259A, but associated</span>
<span class="cm">		 * with low IRQ numbers, will restore the Status.IM</span>
<span class="cm">		 * value associated with the i8259A.</span>
<span class="cm">		 */</span>
		<span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">irq_hwmask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x100</span> <span class="o">&lt;&lt;</span> <span class="n">MIPSCPU_INT_I8259A</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#else </span><span class="cm">/* Not SMTC */</span><span class="cp"></span>
		<span class="n">setup_irq</span><span class="p">(</span><span class="n">MIPS_CPU_IRQ_BASE</span><span class="o">+</span><span class="n">MIPSCPU_INT_I8259A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i8259irq</span><span class="p">);</span>
		<span class="n">setup_irq</span><span class="p">(</span><span class="n">MIPS_CPU_IRQ_BASE</span><span class="o">+</span><span class="n">MIPSCPU_INT_COREHI</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">corehi_irqaction</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MIPS_MT_SMTC */</span><span class="cp"></span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">setup_irq</span><span class="p">(</span><span class="n">MIPS_CPU_IRQ_BASE</span><span class="o">+</span><span class="n">MIPSCPU_INT_I8259A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i8259irq</span><span class="p">);</span>
		<span class="n">setup_irq</span><span class="p">(</span><span class="n">MIPS_CPU_IRQ_BASE</span><span class="o">+</span><span class="n">MIPSCPU_INT_COREHI</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">corehi_irqaction</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gic_present</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* FIXME */</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#if defined(CONFIG_MIPS_MT_SMP)</span>
		<span class="n">gic_call_int_base</span> <span class="o">=</span> <span class="n">GIC_NUM_INTRS</span> <span class="o">-</span> <span class="n">NR_CPUS</span><span class="p">;</span>
		<span class="n">gic_resched_int_base</span> <span class="o">=</span> <span class="n">gic_call_int_base</span> <span class="o">-</span> <span class="n">NR_CPUS</span><span class="p">;</span>
		<span class="n">fill_ipi_map</span><span class="p">();</span>
<span class="cp">#endif</span>
		<span class="n">gic_init</span><span class="p">(</span><span class="n">GIC_BASE_ADDR</span><span class="p">,</span> <span class="n">GIC_ADDRSPACE_SZ</span><span class="p">,</span> <span class="n">gic_intr_map</span><span class="p">,</span>
				<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">gic_intr_map</span><span class="p">),</span> <span class="n">MIPS_GIC_IRQ_BASE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gcmp_present</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Enable the GIC */</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">REG</span><span class="p">(</span><span class="n">_msc01_biu_base</span><span class="p">,</span> <span class="n">MSC01_SC_CFG</span><span class="p">);</span>
			<span class="n">REG</span><span class="p">(</span><span class="n">_msc01_biu_base</span><span class="p">,</span> <span class="n">MSC01_SC_CFG</span><span class="p">)</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">i</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">MSC01_SC_CFG_GICENA_SHF</span><span class="p">));</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;GIC Enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#if defined(CONFIG_MIPS_MT_SMP)</span>
		<span class="cm">/* set up ipi interrupts */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_vint</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_vi_handler</span><span class="p">(</span><span class="n">MIPSCPU_INT_IPI0</span><span class="p">,</span> <span class="n">malta_ipi_irqdispatch</span><span class="p">);</span>
			<span class="n">set_vi_handler</span><span class="p">(</span><span class="n">MIPSCPU_INT_IPI1</span><span class="p">,</span> <span class="n">malta_ipi_irqdispatch</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Argh.. this really needs sorting out.. */</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;CPU%d: status register was %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">(),</span> <span class="n">read_c0_status</span><span class="p">());</span>
		<span class="n">write_c0_status</span><span class="p">(</span><span class="n">read_c0_status</span><span class="p">()</span> <span class="o">|</span> <span class="n">STATUSF_IP3</span> <span class="o">|</span> <span class="n">STATUSF_IP4</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;CPU%d: status register now %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">(),</span> <span class="n">read_c0_status</span><span class="p">());</span>
		<span class="n">write_c0_status</span><span class="p">(</span><span class="mh">0x1100dc00</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;CPU%d: status register frc %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">(),</span> <span class="n">read_c0_status</span><span class="p">());</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_CPUS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">arch_init_ipiirq</span><span class="p">(</span><span class="n">MIPS_GIC_IRQ_BASE</span> <span class="o">+</span>
					 <span class="n">GIC_RESCHED_INT</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">irq_resched</span><span class="p">);</span>
			<span class="n">arch_init_ipiirq</span><span class="p">(</span><span class="n">MIPS_GIC_IRQ_BASE</span> <span class="o">+</span>
					 <span class="n">GIC_CALL_INT</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">irq_call</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#if defined(CONFIG_MIPS_MT_SMP)</span>
		<span class="cm">/* set up ipi interrupts */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_veic</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_vi_handler</span> <span class="p">(</span><span class="n">MSC01E_INT_SW0</span><span class="p">,</span> <span class="n">ipi_resched_dispatch</span><span class="p">);</span>
			<span class="n">set_vi_handler</span> <span class="p">(</span><span class="n">MSC01E_INT_SW1</span><span class="p">,</span> <span class="n">ipi_call_dispatch</span><span class="p">);</span>
			<span class="n">cpu_ipi_resched_irq</span> <span class="o">=</span> <span class="n">MSC01E_INT_SW0</span><span class="p">;</span>
			<span class="n">cpu_ipi_call_irq</span> <span class="o">=</span> <span class="n">MSC01E_INT_SW1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_vint</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">set_vi_handler</span> <span class="p">(</span><span class="n">MIPS_CPU_IPI_RESCHED_IRQ</span><span class="p">,</span> <span class="n">ipi_resched_dispatch</span><span class="p">);</span>
				<span class="n">set_vi_handler</span> <span class="p">(</span><span class="n">MIPS_CPU_IPI_CALL_IRQ</span><span class="p">,</span> <span class="n">ipi_call_dispatch</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">cpu_ipi_resched_irq</span> <span class="o">=</span> <span class="n">MIPS_CPU_IRQ_BASE</span> <span class="o">+</span> <span class="n">MIPS_CPU_IPI_RESCHED_IRQ</span><span class="p">;</span>
			<span class="n">cpu_ipi_call_irq</span> <span class="o">=</span> <span class="n">MIPS_CPU_IRQ_BASE</span> <span class="o">+</span> <span class="n">MIPS_CPU_IPI_CALL_IRQ</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">arch_init_ipiirq</span><span class="p">(</span><span class="n">cpu_ipi_resched_irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irq_resched</span><span class="p">);</span>
		<span class="n">arch_init_ipiirq</span><span class="p">(</span><span class="n">cpu_ipi_call_irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irq_call</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">malta_be_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gcmp_present</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Could change CM error mask register */</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tr</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;mem&quot;</span><span class="p">,</span>	<span class="s">&quot;gcr&quot;</span><span class="p">,</span>	<span class="s">&quot;gic&quot;</span><span class="p">,</span>	<span class="s">&quot;mmio&quot;</span><span class="p">,</span>
	<span class="s">&quot;0x04&quot;</span><span class="p">,</span>	<span class="s">&quot;0x05&quot;</span><span class="p">,</span>	<span class="s">&quot;0x06&quot;</span><span class="p">,</span>	<span class="s">&quot;0x07&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mcmd</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mh">0x00</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;0x00&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x01</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Legacy Write&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x02</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Legacy Read&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x03</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;0x03&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x04</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;0x04&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x05</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;0x05&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x06</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;0x06&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x07</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;0x07&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x08</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Coherent Read Own&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x09</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Coherent Read Share&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x0a</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Coherent Read Discard&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x0b</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Coherent Ready Share Always&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x0c</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Coherent Upgrade&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x0d</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Coherent Writeback&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x0e</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;0x0e&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x0f</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;0x0f&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Coherent Copyback&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x11</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Coherent Copyback Invalidate&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x12</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Coherent Invalidate&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x13</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Coherent Write Invalidate&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x14</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Coherent Completion Sync&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x15</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;0x15&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x16</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;0x16&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x17</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;0x17&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x18</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;0x18&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x19</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;0x19&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x1a</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;0x1a&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x1b</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;0x1b&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x1c</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;0x1c&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x1d</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;0x1d&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x1e</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;0x1e&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x1f</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;0x1f&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">core</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Invalid/OK&quot;</span><span class="p">,</span> 	<span class="s">&quot;Invalid/Data&quot;</span><span class="p">,</span>
	<span class="s">&quot;Shared/OK&quot;</span><span class="p">,</span>	<span class="s">&quot;Shared/Data&quot;</span><span class="p">,</span>
	<span class="s">&quot;Modified/OK&quot;</span><span class="p">,</span>	<span class="s">&quot;Modified/Data&quot;</span><span class="p">,</span>
	<span class="s">&quot;Exclusive/OK&quot;</span><span class="p">,</span>	<span class="s">&quot;Exclusive/Data&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">causes</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;None&quot;</span><span class="p">,</span> <span class="s">&quot;GC_WR_ERR&quot;</span><span class="p">,</span> <span class="s">&quot;GC_RD_ERR&quot;</span><span class="p">,</span> <span class="s">&quot;COH_WR_ERR&quot;</span><span class="p">,</span>
	<span class="s">&quot;COH_RD_ERR&quot;</span><span class="p">,</span> <span class="s">&quot;MMIO_WR_ERR&quot;</span><span class="p">,</span> <span class="s">&quot;MMIO_RD_ERR&quot;</span><span class="p">,</span> <span class="s">&quot;0x07&quot;</span><span class="p">,</span>
	<span class="s">&quot;0x08&quot;</span><span class="p">,</span> <span class="s">&quot;0x09&quot;</span><span class="p">,</span> <span class="s">&quot;0x0a&quot;</span><span class="p">,</span> <span class="s">&quot;0x0b&quot;</span><span class="p">,</span>
	<span class="s">&quot;0x0c&quot;</span><span class="p">,</span> <span class="s">&quot;0x0d&quot;</span><span class="p">,</span> <span class="s">&quot;0x0e&quot;</span><span class="p">,</span> <span class="s">&quot;0x0f&quot;</span><span class="p">,</span>
	<span class="s">&quot;0x10&quot;</span><span class="p">,</span> <span class="s">&quot;0x11&quot;</span><span class="p">,</span> <span class="s">&quot;0x12&quot;</span><span class="p">,</span> <span class="s">&quot;0x13&quot;</span><span class="p">,</span>
	<span class="s">&quot;0x14&quot;</span><span class="p">,</span> <span class="s">&quot;0x15&quot;</span><span class="p">,</span> <span class="s">&quot;0x16&quot;</span><span class="p">,</span> <span class="s">&quot;INTVN_WR_ERR&quot;</span><span class="p">,</span>
	<span class="s">&quot;INTVN_RD_ERR&quot;</span><span class="p">,</span> <span class="s">&quot;0x19&quot;</span><span class="p">,</span> <span class="s">&quot;0x1a&quot;</span><span class="p">,</span> <span class="s">&quot;0x1b&quot;</span><span class="p">,</span>
	<span class="s">&quot;0x1c&quot;</span><span class="p">,</span> <span class="s">&quot;0x1d&quot;</span><span class="p">,</span> <span class="s">&quot;0x1e&quot;</span><span class="p">,</span> <span class="s">&quot;0x1f&quot;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">malta_be_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_fixup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* This duplicates the handling in do_be which seems wrong */</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">is_fixup</span> <span class="o">?</span> <span class="n">MIPS_BE_FIXUP</span> <span class="o">:</span> <span class="n">MIPS_BE_FATAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gcmp_present</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cm_error</span> <span class="o">=</span> <span class="n">GCMPGCB</span><span class="p">(</span><span class="n">GCMEC</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cm_addr</span> <span class="o">=</span> <span class="n">GCMPGCB</span><span class="p">(</span><span class="n">GCMEA</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cm_other</span> <span class="o">=</span> <span class="n">GCMPGCB</span><span class="p">(</span><span class="n">GCMEO</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cause</span><span class="p">,</span> <span class="n">ocause</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

		<span class="n">cause</span> <span class="o">=</span> <span class="p">(</span><span class="n">cm_error</span> <span class="o">&amp;</span> <span class="n">GCMP_GCB_GMEC_ERROR_TYPE_MSK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cause</span> <span class="o">&gt;&gt;=</span> <span class="n">GCMP_GCB_GMEC_ERROR_TYPE_SHF</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cca_bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">cm_error</span> <span class="o">&gt;&gt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tr_bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">cm_error</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mcmd_bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">cm_error</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stag_bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">cm_error</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">;</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sport_bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">cm_error</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>

				<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span>
					 <span class="s">&quot;CCA=%lu TR=%s MCmd=%s STag=%lu &quot;</span>
					 <span class="s">&quot;SPort=%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">cca_bits</span><span class="p">,</span> <span class="n">tr</span><span class="p">[</span><span class="n">tr_bits</span><span class="p">],</span> <span class="n">mcmd</span><span class="p">[</span><span class="n">mcmd_bits</span><span class="p">],</span>
					 <span class="n">stag_bits</span><span class="p">,</span> <span class="n">sport_bits</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* glob state &amp; sresp together */</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">c3_bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">cm_error</span> <span class="o">&gt;&gt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">c2_bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">cm_error</span> <span class="o">&gt;&gt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">c1_bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">cm_error</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">c0_bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">cm_error</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sc_bit</span> <span class="o">=</span> <span class="p">(</span><span class="n">cm_error</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mcmd_bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">cm_error</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sport_bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">cm_error</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
				<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span>
					 <span class="s">&quot;C3=%s C2=%s C1=%s C0=%s SC=%s &quot;</span>
					 <span class="s">&quot;MCmd=%s SPort=%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">core</span><span class="p">[</span><span class="n">c3_bits</span><span class="p">],</span> <span class="n">core</span><span class="p">[</span><span class="n">c2_bits</span><span class="p">],</span>
					 <span class="n">core</span><span class="p">[</span><span class="n">c1_bits</span><span class="p">],</span> <span class="n">core</span><span class="p">[</span><span class="n">c0_bits</span><span class="p">],</span>
					 <span class="n">sc_bit</span> <span class="o">?</span> <span class="s">&quot;True&quot;</span> <span class="o">:</span> <span class="s">&quot;False&quot;</span><span class="p">,</span>
					 <span class="n">mcmd</span><span class="p">[</span><span class="n">mcmd_bits</span><span class="p">],</span> <span class="n">sport_bits</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">ocause</span> <span class="o">=</span> <span class="p">(</span><span class="n">cm_other</span> <span class="o">&amp;</span> <span class="n">GCMP_GCB_GMEO_ERROR_2ND_MSK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				 <span class="n">GCMP_GCB_GMEO_ERROR_2ND_SHF</span><span class="p">;</span>

			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;CM_ERROR=%08lx %s &lt;%s&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cm_error</span><span class="p">,</span>
			       <span class="n">causes</span><span class="p">[</span><span class="n">cause</span><span class="p">],</span> <span class="n">buf</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;CM_ADDR =%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cm_addr</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;CM_OTHER=%08lx %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cm_other</span><span class="p">,</span> <span class="n">causes</span><span class="p">[</span><span class="n">ocause</span><span class="p">]);</span>

			<span class="cm">/* reprime cause register */</span>
			<span class="n">GCMPGCB</span><span class="p">(</span><span class="n">GCMEC</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
