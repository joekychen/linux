<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › mips › mm › cerr-sb1.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>cerr-sb1.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2001,2002,2003 Broadcom Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version 2</span>
<span class="cm"> * of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;asm/mipsregs.h&gt;</span>
<span class="cp">#include &lt;asm/sibyte/sb1250.h&gt;</span>
<span class="cp">#include &lt;asm/sibyte/sb1250_regs.h&gt;</span>

<span class="cp">#if !defined(CONFIG_SIBYTE_BUS_WATCHER) || defined(CONFIG_SIBYTE_BW_TRACE)</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/sibyte/sb1250_scd.h&gt;</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * We&#39;d like to dump the L2_ECC_TAG register on errors, but errata make</span>
<span class="cm"> * that unsafe... So for now we don&#39;t.  (BCM1250/BCM112x erratum SOC-48.)</span>
<span class="cm"> */</span>
<span class="cp">#undef DUMP_L2_ECC_TAG_ON_ERROR</span>

<span class="cm">/* SB1 definitions */</span>

<span class="cm">/* XXX should come from config1 XXX */</span>
<span class="cp">#define SB1_CACHE_INDEX_MASK   0x1fe0</span>

<span class="cp">#define CP0_ERRCTL_RECOVERABLE (1 &lt;&lt; 31)</span>
<span class="cp">#define CP0_ERRCTL_DCACHE      (1 &lt;&lt; 30)</span>
<span class="cp">#define CP0_ERRCTL_ICACHE      (1 &lt;&lt; 29)</span>
<span class="cp">#define CP0_ERRCTL_MULTIBUS    (1 &lt;&lt; 23)</span>
<span class="cp">#define CP0_ERRCTL_MC_TLB      (1 &lt;&lt; 15)</span>
<span class="cp">#define CP0_ERRCTL_MC_TIMEOUT  (1 &lt;&lt; 14)</span>

<span class="cp">#define CP0_CERRI_TAG_PARITY   (1 &lt;&lt; 29)</span>
<span class="cp">#define CP0_CERRI_DATA_PARITY  (1 &lt;&lt; 28)</span>
<span class="cp">#define CP0_CERRI_EXTERNAL     (1 &lt;&lt; 26)</span>

<span class="cp">#define CP0_CERRI_IDX_VALID(c) (!((c) &amp; CP0_CERRI_EXTERNAL))</span>
<span class="cp">#define CP0_CERRI_DATA         (CP0_CERRI_DATA_PARITY)</span>

<span class="cp">#define CP0_CERRD_MULTIPLE     (1 &lt;&lt; 31)</span>
<span class="cp">#define CP0_CERRD_TAG_STATE    (1 &lt;&lt; 30)</span>
<span class="cp">#define CP0_CERRD_TAG_ADDRESS  (1 &lt;&lt; 29)</span>
<span class="cp">#define CP0_CERRD_DATA_SBE     (1 &lt;&lt; 28)</span>
<span class="cp">#define CP0_CERRD_DATA_DBE     (1 &lt;&lt; 27)</span>
<span class="cp">#define CP0_CERRD_EXTERNAL     (1 &lt;&lt; 26)</span>
<span class="cp">#define CP0_CERRD_LOAD         (1 &lt;&lt; 25)</span>
<span class="cp">#define CP0_CERRD_STORE        (1 &lt;&lt; 24)</span>
<span class="cp">#define CP0_CERRD_FILLWB       (1 &lt;&lt; 23)</span>
<span class="cp">#define CP0_CERRD_COHERENCY    (1 &lt;&lt; 22)</span>
<span class="cp">#define CP0_CERRD_DUPTAG       (1 &lt;&lt; 21)</span>

<span class="cp">#define CP0_CERRD_DPA_VALID(c) (!((c) &amp; CP0_CERRD_EXTERNAL))</span>
<span class="cp">#define CP0_CERRD_IDX_VALID(c) \</span>
<span class="cp">   (((c) &amp; (CP0_CERRD_LOAD | CP0_CERRD_STORE)) ? (!((c) &amp; CP0_CERRD_EXTERNAL)) : 0)</span>
<span class="cp">#define CP0_CERRD_CAUSES \</span>
<span class="cp">   (CP0_CERRD_LOAD | CP0_CERRD_STORE | CP0_CERRD_FILLWB | CP0_CERRD_COHERENCY | CP0_CERRD_DUPTAG)</span>
<span class="cp">#define CP0_CERRD_TYPES \</span>
<span class="cp">   (CP0_CERRD_TAG_STATE | CP0_CERRD_TAG_ADDRESS | CP0_CERRD_DATA_SBE | CP0_CERRD_DATA_DBE | CP0_CERRD_EXTERNAL)</span>
<span class="cp">#define CP0_CERRD_DATA         (CP0_CERRD_DATA_SBE | CP0_CERRD_DATA_DBE)</span>

<span class="k">static</span> <span class="kt">uint32_t</span>	<span class="n">extract_ic</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">uint32_t</span>	<span class="n">extract_dc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">breakout_errctl</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">CP0_ERRCTL_RECOVERABLE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; recoverable&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">CP0_ERRCTL_DCACHE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; dcache&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">CP0_ERRCTL_ICACHE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; icache&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">CP0_ERRCTL_MULTIBUS</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; multiple-buserr&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">breakout_cerri</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">CP0_CERRI_TAG_PARITY</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; tag-parity&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">CP0_CERRI_DATA_PARITY</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; data-parity&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">CP0_CERRI_EXTERNAL</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; external&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">breakout_cerrd</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">CP0_CERRD_CAUSES</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CP0_CERRD_LOAD</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; load,&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CP0_CERRD_STORE</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; store,&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CP0_CERRD_FILLWB</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; fill/wb,&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CP0_CERRD_COHERENCY</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; coherency,&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CP0_CERRD_DUPTAG</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; duptags,&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; NO CAUSE,&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">CP0_CERRD_TYPES</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; NO TYPE&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">CP0_CERRD_MULTIPLE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; multi-err&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">CP0_CERRD_TAG_STATE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; tag-state&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">CP0_CERRD_TAG_ADDRESS</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; tag-address&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">CP0_CERRD_DATA_SBE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; data-SBE&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">CP0_CERRD_DATA_DBE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; data-DBE&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">CP0_CERRD_EXTERNAL</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; external&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifndef CONFIG_SIBYTE_BUS_WATCHER</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_bus_watcher</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">status</span><span class="p">,</span> <span class="n">l2_err</span><span class="p">,</span> <span class="n">memio_err</span><span class="p">;</span>
<span class="cp">#ifdef DUMP_L2_ECC_TAG_ON_ERROR</span>
	<span class="kt">uint64_t</span> <span class="n">l2_tag</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* Destructive read, clears register and interrupt */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">csr_in32</span><span class="p">(</span><span class="n">IOADDR</span><span class="p">(</span><span class="n">A_SCD_BUS_ERR_STATUS</span><span class="p">));</span>
	<span class="cm">/* Bit 31 is always on, but there&#39;s no #define for that */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">l2_err</span> <span class="o">=</span> <span class="n">csr_in32</span><span class="p">(</span><span class="n">IOADDR</span><span class="p">(</span><span class="n">A_BUS_L2_ERRORS</span><span class="p">));</span>
<span class="cp">#ifdef DUMP_L2_ECC_TAG_ON_ERROR</span>
		<span class="n">l2_tag</span> <span class="o">=</span> <span class="n">in64</span><span class="p">(</span><span class="n">IOADDR</span><span class="p">(</span><span class="n">A_L2_ECC_TAG</span><span class="p">));</span>
<span class="cp">#endif</span>
		<span class="n">memio_err</span> <span class="o">=</span> <span class="n">csr_in32</span><span class="p">(</span><span class="n">IOADDR</span><span class="p">(</span><span class="n">A_BUS_MEM_IO_ERRORS</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Bus watcher error counters: %08x %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">l2_err</span><span class="p">,</span> <span class="n">memio_err</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Last recorded signature:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Request %02x from %d, answered by %d with Dcode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">G_SCD_BERR_TID</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">),</span>
		       <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">G_SCD_BERR_TID</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">),</span>
		       <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">G_SCD_BERR_RID</span><span class="p">(</span><span class="n">status</span><span class="p">),</span>
		       <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">G_SCD_BERR_DCODE</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
<span class="cp">#ifdef DUMP_L2_ECC_TAG_ON_ERROR</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Last L2 tag w/ bad ECC: %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">l2_tag</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Bus watcher indicates no error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">check_bus_watcher</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">sb1_cache_error</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">errctl</span><span class="p">,</span> <span class="n">cerr_i</span><span class="p">,</span> <span class="n">cerr_d</span><span class="p">,</span> <span class="n">dpalo</span><span class="p">,</span> <span class="n">dpahi</span><span class="p">,</span> <span class="n">eepc</span><span class="p">,</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">cerr_dpa</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SIBYTE_BW_TRACE</span>
	<span class="cm">/* Freeze the trace buffer now */</span>
<span class="cp">#if defined(CONFIG_SIBYTE_BCM1x55) || defined(CONFIG_SIBYTE_BCM1x80)</span>
	<span class="n">csr_out32</span><span class="p">(</span><span class="n">M_BCM1480_SCD_TRACE_CFG_FREEZE</span><span class="p">,</span> <span class="n">IOADDR</span><span class="p">(</span><span class="n">A_SCD_TRACE_CFG</span><span class="p">));</span>
<span class="cp">#else</span>
	<span class="n">csr_out32</span><span class="p">(</span><span class="n">M_SCD_TRACE_CFG_FREEZE</span><span class="p">,</span> <span class="n">IOADDR</span><span class="p">(</span><span class="n">A_SCD_TRACE_CFG</span><span class="p">));</span>
<span class="cp">#endif</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Trace buffer frozen</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Cache error exception on CPU %x:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">read_c0_prid</span><span class="p">()</span> <span class="o">&gt;&gt;</span> <span class="mi">25</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">);</span>

	<span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span>
	<span class="s">&quot;	.set	push</span><span class="se">\n\t</span><span class="s">&quot;</span>
	<span class="s">&quot;	.set	mips64</span><span class="se">\n\t</span><span class="s">&quot;</span>
	<span class="s">&quot;	.set	noat</span><span class="se">\n\t</span><span class="s">&quot;</span>
	<span class="s">&quot;	mfc0	%0, $26</span><span class="se">\n\t</span><span class="s">&quot;</span>
	<span class="s">&quot;	mfc0	%1, $27</span><span class="se">\n\t</span><span class="s">&quot;</span>
	<span class="s">&quot;	mfc0	%2, $27, 1</span><span class="se">\n\t</span><span class="s">&quot;</span>
	<span class="s">&quot;	dmfc0	$1, $27, 3</span><span class="se">\n\t</span><span class="s">&quot;</span>
	<span class="s">&quot;	dsrl32	%3, $1, 0 </span><span class="se">\n\t</span><span class="s">&quot;</span>
	<span class="s">&quot;	sll	%4, $1, 0 </span><span class="se">\n\t</span><span class="s">&quot;</span>
	<span class="s">&quot;	mfc0	%5, $30</span><span class="se">\n\t</span><span class="s">&quot;</span>
	<span class="s">&quot;	.set	pop&quot;</span>
	<span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">errctl</span><span class="p">),</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">cerr_i</span><span class="p">),</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">cerr_d</span><span class="p">),</span>
	  <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">dpahi</span><span class="p">),</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">dpalo</span><span class="p">),</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">eepc</span><span class="p">));</span>

	<span class="n">cerr_dpa</span> <span class="o">=</span> <span class="p">(((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">dpahi</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">dpalo</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot; c0_errorepc ==   %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eepc</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot; c0_errctl   ==   %08x&quot;</span><span class="p">,</span> <span class="n">errctl</span><span class="p">);</span>
	<span class="n">breakout_errctl</span><span class="p">(</span><span class="n">errctl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">errctl</span> <span class="o">&amp;</span> <span class="n">CP0_ERRCTL_ICACHE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; c0_cerr_i   ==   %08x&quot;</span><span class="p">,</span> <span class="n">cerr_i</span><span class="p">);</span>
		<span class="n">breakout_cerri</span><span class="p">(</span><span class="n">cerr_i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CP0_CERRI_IDX_VALID</span><span class="p">(</span><span class="n">cerr_i</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Check index of EPC, allowing for delay slot */</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">eepc</span> <span class="o">&amp;</span> <span class="n">SB1_CACHE_INDEX_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">cerr_i</span> <span class="o">&amp;</span> <span class="n">SB1_CACHE_INDEX_MASK</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			    <span class="p">((</span><span class="n">eepc</span> <span class="o">&amp;</span> <span class="n">SB1_CACHE_INDEX_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="p">((</span><span class="n">cerr_i</span> <span class="o">&amp;</span> <span class="n">SB1_CACHE_INDEX_MASK</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)))</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; cerr_i idx doesn&#39;t match eepc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">extract_ic</span><span class="p">(</span><span class="n">cerr_i</span> <span class="o">&amp;</span> <span class="n">SB1_CACHE_INDEX_MASK</span><span class="p">,</span>
						 <span class="p">(</span><span class="n">cerr_i</span> <span class="o">&amp;</span> <span class="n">CP0_CERRI_DATA</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">res</span> <span class="o">&amp;</span> <span class="n">cerr_i</span><span class="p">))</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;...didn&#39;t see indicated icache problem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">errctl</span> <span class="o">&amp;</span> <span class="n">CP0_ERRCTL_DCACHE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; c0_cerr_d   ==   %08x&quot;</span><span class="p">,</span> <span class="n">cerr_d</span><span class="p">);</span>
		<span class="n">breakout_cerrd</span><span class="p">(</span><span class="n">cerr_d</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CP0_CERRD_DPA_VALID</span><span class="p">(</span><span class="n">cerr_d</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; c0_cerr_dpa == %010llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cerr_dpa</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CP0_CERRD_IDX_VALID</span><span class="p">(</span><span class="n">cerr_d</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">extract_dc</span><span class="p">(</span><span class="n">cerr_dpa</span> <span class="o">&amp;</span> <span class="n">SB1_CACHE_INDEX_MASK</span><span class="p">,</span>
						 <span class="p">(</span><span class="n">cerr_d</span> <span class="o">&amp;</span> <span class="n">CP0_CERRD_DATA</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">res</span> <span class="o">&amp;</span> <span class="n">cerr_d</span><span class="p">))</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;...didn&#39;t see indicated dcache problem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">cerr_dpa</span> <span class="o">&amp;</span> <span class="n">SB1_CACHE_INDEX_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">cerr_d</span> <span class="o">&amp;</span> <span class="n">SB1_CACHE_INDEX_MASK</span><span class="p">))</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot; cerr_d idx doesn&#39;t match cerr_dpa</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="n">res</span> <span class="o">=</span> <span class="n">extract_dc</span><span class="p">(</span><span class="n">cerr_d</span> <span class="o">&amp;</span> <span class="n">SB1_CACHE_INDEX_MASK</span><span class="p">,</span>
							 <span class="p">(</span><span class="n">cerr_d</span> <span class="o">&amp;</span> <span class="n">CP0_CERRD_DATA</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">res</span> <span class="o">&amp;</span> <span class="n">cerr_d</span><span class="p">))</span>
						<span class="n">printk</span><span class="p">(</span><span class="s">&quot;...didn&#39;t see indicated problem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">check_bus_watcher</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Calling panic() when a fatal cache error occurs scrambles the</span>
<span class="cm">	 * state of the system (and the cache), making it difficult to</span>
<span class="cm">	 * investigate after the fact.  However, if you just stall the CPU,</span>
<span class="cm">	 * the other CPU may keep on running, which is typically very</span>
<span class="cm">	 * undesirable.</span>
<span class="cm">	 */</span>
<span class="cp">#ifdef CONFIG_SB1_CERR_STALL</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
		<span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">panic</span><span class="p">(</span><span class="s">&quot;unhandled cache error&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>


<span class="cm">/* Parity lookup table. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">parity</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>
<span class="p">};</span>

<span class="cm">/* Masks to select bits for Hamming parity, mask_72_64[i] for bit[i] */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">mask_72_64</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x0738C808099264FFULL</span><span class="p">,</span>
	<span class="mh">0x38C808099264FF07ULL</span><span class="p">,</span>
	<span class="mh">0xC808099264FF0738ULL</span><span class="p">,</span>
	<span class="mh">0x08099264FF0738C8ULL</span><span class="p">,</span>
	<span class="mh">0x099264FF0738C808ULL</span><span class="p">,</span>
	<span class="mh">0x9264FF0738C80809ULL</span><span class="p">,</span>
	<span class="mh">0x64FF0738C8080992ULL</span><span class="p">,</span>
	<span class="mh">0xFF0738C808099264ULL</span>
<span class="p">};</span>

<span class="cm">/* Calculate the parity on a range of bits */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="nf">range_parity</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">dword</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max</span><span class="p">,</span> <span class="kt">int</span> <span class="n">min</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">parity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">dword</span> <span class="o">&gt;&gt;=</span> <span class="n">min</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">max</span><span class="o">-</span><span class="n">min</span><span class="p">;</span> <span class="n">i</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dword</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="n">parity</span> <span class="o">=</span> <span class="o">!</span><span class="n">parity</span><span class="p">;</span>
		<span class="n">dword</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">parity</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Calculate the 4-bit even byte-parity for an instruction */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">inst_parity</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">word</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">parity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">byte_parity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">word</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span>
				<span class="n">byte_parity</span> <span class="o">=</span> <span class="o">!</span><span class="n">byte_parity</span><span class="p">;</span>
			<span class="n">word</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">parity</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">parity</span> <span class="o">|=</span> <span class="n">byte_parity</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">parity</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span> <span class="nf">extract_ic</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">way</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">valid</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">taghi</span><span class="p">,</span> <span class="n">taglolo</span><span class="p">,</span> <span class="n">taglohi</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">taglo</span><span class="p">,</span> <span class="n">va</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">tlo_tmp</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">lru</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Icache index 0x%04x  &quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">way</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">way</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">way</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Index-load-tag-I */</span>
		<span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span>
		<span class="s">&quot;	.set	push		</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;	.set	noreorder	</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;	.set	mips64		</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;	.set	noat		</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;	cache	4, 0(%3)	</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;	mfc0	%0, $29		</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;	dmfc0	$1, $28		</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;	dsrl32	%1, $1, 0	</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;	sll	%2, $1, 0	</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;	.set	pop&quot;</span>
		<span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">taghi</span><span class="p">),</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">taglohi</span><span class="p">),</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">taglolo</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">((</span><span class="n">way</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="n">addr</span><span class="p">));</span>

		<span class="n">taglo</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">taglohi</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">taglolo</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">way</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lru</span> <span class="o">=</span> <span class="p">(</span><span class="n">taghi</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[Bank %d Set 0x%02x]  LRU &gt; %d %d %d %d &gt; MRU</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="p">((</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">),</span> <span class="cm">/* bank */</span>
				    <span class="p">((</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">),</span> <span class="cm">/* index */</span>
				    <span class="p">(</span><span class="n">lru</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">),</span>
				    <span class="p">((</span><span class="n">lru</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">),</span>
				    <span class="p">((</span><span class="n">lru</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">),</span>
				    <span class="p">((</span><span class="n">lru</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">va</span> <span class="o">=</span> <span class="p">(</span><span class="n">taglo</span> <span class="o">&amp;</span> <span class="mh">0xC0000FFFFFFFE000ULL</span><span class="p">)</span> <span class="o">|</span> <span class="n">addr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">taglo</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(((</span><span class="n">taglo</span> <span class="o">&gt;&gt;</span> <span class="mi">62</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">))</span>
			<span class="n">va</span> <span class="o">|=</span> <span class="mh">0x3FFFF00000000000ULL</span><span class="p">;</span>
		<span class="n">valid</span> <span class="o">=</span> <span class="p">((</span><span class="n">taghi</span> <span class="o">&gt;&gt;</span> <span class="mi">29</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tlo_tmp</span> <span class="o">=</span> <span class="n">taglo</span> <span class="o">&amp;</span> <span class="mh">0xfff3ff</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">taglo</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="n">range_parity</span><span class="p">(</span><span class="n">tlo_tmp</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;   ** bad parity in VTag0/G/ASID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">res</span> <span class="o">|=</span> <span class="n">CP0_CERRI_TAG_PARITY</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">taglo</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="n">range_parity</span><span class="p">(</span><span class="n">taglo</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">24</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;   ** bad parity in R/VTag1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">res</span> <span class="o">|=</span> <span class="n">CP0_CERRI_TAG_PARITY</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">valid</span> <span class="o">^</span> <span class="p">((</span><span class="n">taghi</span> <span class="o">&gt;&gt;</span> <span class="mi">27</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;   ** bad parity for valid bit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">res</span> <span class="o">|=</span> <span class="n">CP0_CERRI_TAG_PARITY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %d  [VA %016llx]  [Vld? %d]  raw tags: %08X-%016llX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">way</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">valid</span><span class="p">,</span> <span class="n">taghi</span><span class="p">,</span> <span class="n">taglo</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">uint32_t</span> <span class="n">datahi</span><span class="p">,</span> <span class="n">insta</span><span class="p">,</span> <span class="n">instb</span><span class="p">;</span>
			<span class="kt">uint8_t</span> <span class="n">predecode</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>

			<span class="cm">/* (hit all banks and ways) */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">offset</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Index-load-data-I */</span>
				<span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span>
				<span class="s">&quot;	.set	push</span><span class="se">\n\t</span><span class="s">&quot;</span>
				<span class="s">&quot;	.set	noreorder</span><span class="se">\n\t</span><span class="s">&quot;</span>
				<span class="s">&quot;	.set	mips64</span><span class="se">\n\t</span><span class="s">&quot;</span>
				<span class="s">&quot;	.set	noat</span><span class="se">\n\t</span><span class="s">&quot;</span>
				<span class="s">&quot;	cache	6, 0(%3)  </span><span class="se">\n\t</span><span class="s">&quot;</span>
				<span class="s">&quot;	mfc0	%0, $29, 1</span><span class="se">\n\t</span><span class="s">&quot;</span>
				<span class="s">&quot;	dmfc0  $1, $28, 1</span><span class="se">\n\t</span><span class="s">&quot;</span>
				<span class="s">&quot;	dsrl32 %1, $1, 0 </span><span class="se">\n\t</span><span class="s">&quot;</span>
				<span class="s">&quot;	sll    %2, $1, 0 </span><span class="se">\n\t</span><span class="s">&quot;</span>
				<span class="s">&quot;	.set	pop         </span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">datahi</span><span class="p">),</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">insta</span><span class="p">),</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">instb</span><span class="p">)</span>
				<span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">((</span><span class="n">way</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="n">addr</span> <span class="o">|</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)));</span>
				<span class="n">predecode</span> <span class="o">=</span> <span class="p">(</span><span class="n">datahi</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(((</span><span class="n">datahi</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">range_parity</span><span class="p">(</span><span class="n">predecode</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;   ** bad parity in predecode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">res</span> <span class="o">|=</span> <span class="n">CP0_CERRI_DATA_PARITY</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* XXXKW should/could check predecode bits themselves */</span>
				<span class="k">if</span> <span class="p">(((</span><span class="n">datahi</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">^</span> <span class="n">inst_parity</span><span class="p">(</span><span class="n">insta</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;   ** bad parity in instruction a</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">res</span> <span class="o">|=</span> <span class="n">CP0_CERRI_DATA_PARITY</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">datahi</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">^</span> <span class="n">inst_parity</span><span class="p">(</span><span class="n">instb</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;   ** bad parity in instruction b</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">res</span> <span class="o">|=</span> <span class="n">CP0_CERRI_DATA_PARITY</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  %05X-%08X%08X&quot;</span><span class="p">,</span> <span class="n">datahi</span><span class="p">,</span> <span class="n">insta</span><span class="p">,</span> <span class="n">instb</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Compute the ECC for a data doubleword */</span>
<span class="k">static</span> <span class="kt">uint8_t</span> <span class="nf">dc_ecc</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">dword</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint64_t</span> <span class="n">t</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">w</span><span class="p">;</span>
	<span class="kt">uint8_t</span>  <span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span>      <span class="n">i</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">p</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">dword</span> <span class="o">&amp;</span> <span class="n">mask_72_64</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)(</span><span class="n">t</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">^=</span> <span class="p">(</span><span class="n">parity</span><span class="p">[</span><span class="n">w</span><span class="o">&gt;&gt;</span><span class="mi">24</span><span class="p">]</span> <span class="o">^</span> <span class="n">parity</span><span class="p">[(</span><span class="n">w</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">]</span>
		      <span class="o">^</span> <span class="n">parity</span><span class="p">[(</span><span class="n">w</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">]</span> <span class="o">^</span> <span class="n">parity</span><span class="p">[</span><span class="n">w</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">]);</span>
		<span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)(</span><span class="n">t</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">^=</span> <span class="p">(</span><span class="n">parity</span><span class="p">[</span><span class="n">w</span><span class="o">&gt;&gt;</span><span class="mi">24</span><span class="p">]</span> <span class="o">^</span> <span class="n">parity</span><span class="p">[(</span><span class="n">w</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">]</span>
		      <span class="o">^</span> <span class="n">parity</span><span class="p">[(</span><span class="n">w</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">]</span> <span class="o">^</span> <span class="n">parity</span><span class="p">[</span><span class="n">w</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">dc_state</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dc_state</span> <span class="n">dc_states</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="s">&quot;INVALID&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="s">&quot;COH-SHD&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x13</span><span class="p">,</span> <span class="s">&quot;NCO-E-C&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x19</span><span class="p">,</span> <span class="s">&quot;NCO-E-D&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x16</span><span class="p">,</span> <span class="s">&quot;COH-E-C&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="s">&quot;COH-E-D&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xff</span><span class="p">,</span> <span class="s">&quot;*ERROR*&quot;</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cp">#define DC_TAG_VALID(state) \</span>
<span class="cp">    (((state) == 0x0) || ((state) == 0xf) || ((state) == 0x13) || \</span>
<span class="cp">     ((state) == 0x19) || ((state) == 0x16) || ((state) == 0x1c))</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">dc_state_str</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dc_state</span> <span class="o">*</span><span class="n">dsc</span> <span class="o">=</span> <span class="n">dc_states</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">dsc</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsc</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">==</span> <span class="n">state</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">dsc</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">dsc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span> <span class="nf">extract_dc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">valid</span><span class="p">,</span> <span class="n">way</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">state</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">taghi</span><span class="p">,</span> <span class="n">taglolo</span><span class="p">,</span> <span class="n">taglohi</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">taglo</span><span class="p">,</span> <span class="n">pa</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">ecc</span><span class="p">,</span> <span class="n">lru</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Dcache index 0x%04x  &quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">way</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">way</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">way</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span>
		<span class="s">&quot;	.set	push</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;	.set	noreorder</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;	.set	mips64</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;	.set	noat</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;	cache	5, 0(%3)</span><span class="se">\n\t</span><span class="s">&quot;</span>	<span class="cm">/* Index-load-tag-D */</span>
		<span class="s">&quot;	mfc0	%0, $29, 2</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;	dmfc0	$1, $28, 2</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;	dsrl32	%1, $1, 0</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;	sll	%2, $1, 0</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;	.set	pop&quot;</span>
		<span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">taghi</span><span class="p">),</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">taglohi</span><span class="p">),</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">taglolo</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">((</span><span class="n">way</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="n">addr</span><span class="p">));</span>

		<span class="n">taglo</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">taglohi</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">taglolo</span><span class="p">;</span>
		<span class="n">pa</span> <span class="o">=</span> <span class="p">(</span><span class="n">taglo</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFE000ULL</span><span class="p">)</span> <span class="o">|</span> <span class="n">addr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">way</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lru</span> <span class="o">=</span> <span class="p">(</span><span class="n">taghi</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[Bank %d Set 0x%02x]  LRU &gt; %d %d %d %d &gt; MRU</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="p">((</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">),</span> <span class="cm">/* bank */</span>
				    <span class="p">((</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">),</span> <span class="cm">/* index */</span>
				    <span class="p">(</span><span class="n">lru</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">),</span>
				    <span class="p">((</span><span class="n">lru</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">),</span>
				    <span class="p">((</span><span class="n">lru</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">),</span>
				    <span class="p">((</span><span class="n">lru</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="n">taghi</span> <span class="o">&gt;&gt;</span> <span class="mi">25</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
		<span class="n">valid</span> <span class="o">=</span> <span class="n">DC_TAG_VALID</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %d  [PA %010llx]  [state %s (%02x)]  raw tags: %08X-%016llX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">way</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">dc_state_str</span><span class="p">(</span><span class="n">state</span><span class="p">),</span> <span class="n">state</span><span class="p">,</span> <span class="n">taghi</span><span class="p">,</span> <span class="n">taglo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">taglo</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="n">range_parity</span><span class="p">(</span><span class="n">taglo</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">26</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;   ** bad parity in PTag1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">res</span> <span class="o">|=</span> <span class="n">CP0_CERRD_TAG_ADDRESS</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">taglo</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="n">range_parity</span><span class="p">(</span><span class="n">taglo</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">13</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;   ** bad parity in PTag0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">res</span> <span class="o">|=</span> <span class="n">CP0_CERRD_TAG_ADDRESS</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">|=</span> <span class="n">CP0_CERRD_TAG_STATE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">uint32_t</span> <span class="n">datalohi</span><span class="p">,</span> <span class="n">datalolo</span><span class="p">,</span> <span class="n">datahi</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">datalo</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
			<span class="kt">char</span> <span class="n">bad_ecc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">offset</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Index-load-data-D */</span>
				<span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span>
				<span class="s">&quot;	.set	push</span><span class="se">\n\t</span><span class="s">&quot;</span>
				<span class="s">&quot;	.set	noreorder</span><span class="se">\n\t</span><span class="s">&quot;</span>
				<span class="s">&quot;	.set	mips64</span><span class="se">\n\t</span><span class="s">&quot;</span>
				<span class="s">&quot;	.set	noat</span><span class="se">\n\t</span><span class="s">&quot;</span>
				<span class="s">&quot;	cache	7, 0(%3)</span><span class="se">\n\t</span><span class="s">&quot;</span> <span class="cm">/* Index-load-data-D */</span>
				<span class="s">&quot;	mfc0	%0, $29, 3</span><span class="se">\n\t</span><span class="s">&quot;</span>
				<span class="s">&quot;	dmfc0	$1, $28, 3</span><span class="se">\n\t</span><span class="s">&quot;</span>
				<span class="s">&quot;	dsrl32	%1, $1, 0 </span><span class="se">\n\t</span><span class="s">&quot;</span>
				<span class="s">&quot;	sll	%2, $1, 0 </span><span class="se">\n\t</span><span class="s">&quot;</span>
				<span class="s">&quot;	.set	pop&quot;</span>
				<span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">datahi</span><span class="p">),</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">datalohi</span><span class="p">),</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">datalolo</span><span class="p">)</span>
				<span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">((</span><span class="n">way</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="n">addr</span> <span class="o">|</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)));</span>
				<span class="n">datalo</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">datalohi</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">datalolo</span><span class="p">;</span>
				<span class="n">ecc</span> <span class="o">=</span> <span class="n">dc_ecc</span><span class="p">(</span><span class="n">datalo</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ecc</span> <span class="o">!=</span> <span class="n">datahi</span><span class="p">)</span> <span class="p">{</span>
					<span class="kt">int</span> <span class="n">bits</span><span class="p">;</span>
					<span class="n">bad_ecc</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="o">-</span><span class="n">offset</span><span class="p">);</span>
					<span class="n">ecc</span> <span class="o">^=</span> <span class="n">datahi</span><span class="p">;</span>
					<span class="n">bits</span> <span class="o">=</span> <span class="n">hweight8</span><span class="p">(</span><span class="n">ecc</span><span class="p">);</span>
					<span class="n">res</span> <span class="o">|=</span> <span class="p">(</span><span class="n">bits</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">CP0_CERRD_DATA_SBE</span> <span class="o">:</span> <span class="n">CP0_CERRD_DATA_DBE</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  %02X-%016llX&quot;</span><span class="p">,</span> <span class="n">datahi</span><span class="p">,</span> <span class="n">datalo</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bad_ecc</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  dwords w/ bad ECC: %d %d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="o">!!</span><span class="p">(</span><span class="n">bad_ecc</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">),</span> <span class="o">!!</span><span class="p">(</span><span class="n">bad_ecc</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">),</span>
				       <span class="o">!!</span><span class="p">(</span><span class="n">bad_ecc</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">),</span> <span class="o">!!</span><span class="p">(</span><span class="n">bad_ecc</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
