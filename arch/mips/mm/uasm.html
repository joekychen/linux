<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › mips › mm › uasm.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>uasm.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License.  See the file &quot;COPYING&quot; in the main directory of this archive</span>
<span class="cm"> * for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * A small micro-assembler. It is intentionally kept simple, does only</span>
<span class="cm"> * support a subset of instructions, and does not try to hide pipeline</span>
<span class="cm"> * effects like branch delay slots.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2004, 2005, 2006, 2008  Thiemo Seufer</span>
<span class="cm"> * Copyright (C) 2005, 2007  Maciej W. Rozycki</span>
<span class="cm"> * Copyright (C) 2006  Ralf Baechle (ralf@linux-mips.org)</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>

<span class="cp">#include &lt;asm/inst.h&gt;</span>
<span class="cp">#include &lt;asm/elf.h&gt;</span>
<span class="cp">#include &lt;asm/bugs.h&gt;</span>
<span class="cp">#include &lt;asm/uasm.h&gt;</span>

<span class="k">enum</span> <span class="n">fields</span> <span class="p">{</span>
	<span class="n">RS</span> <span class="o">=</span> <span class="mh">0x001</span><span class="p">,</span>
	<span class="n">RT</span> <span class="o">=</span> <span class="mh">0x002</span><span class="p">,</span>
	<span class="n">RD</span> <span class="o">=</span> <span class="mh">0x004</span><span class="p">,</span>
	<span class="n">RE</span> <span class="o">=</span> <span class="mh">0x008</span><span class="p">,</span>
	<span class="n">SIMM</span> <span class="o">=</span> <span class="mh">0x010</span><span class="p">,</span>
	<span class="n">UIMM</span> <span class="o">=</span> <span class="mh">0x020</span><span class="p">,</span>
	<span class="n">BIMM</span> <span class="o">=</span> <span class="mh">0x040</span><span class="p">,</span>
	<span class="n">JIMM</span> <span class="o">=</span> <span class="mh">0x080</span><span class="p">,</span>
	<span class="n">FUNC</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">,</span>
	<span class="n">SET</span> <span class="o">=</span> <span class="mh">0x200</span><span class="p">,</span>
	<span class="n">SCIMM</span> <span class="o">=</span> <span class="mh">0x400</span>
<span class="p">};</span>

<span class="cp">#define OP_MASK		0x3f</span>
<span class="cp">#define OP_SH		26</span>
<span class="cp">#define RS_MASK		0x1f</span>
<span class="cp">#define RS_SH		21</span>
<span class="cp">#define RT_MASK		0x1f</span>
<span class="cp">#define RT_SH		16</span>
<span class="cp">#define RD_MASK		0x1f</span>
<span class="cp">#define RD_SH		11</span>
<span class="cp">#define RE_MASK		0x1f</span>
<span class="cp">#define RE_SH		6</span>
<span class="cp">#define IMM_MASK	0xffff</span>
<span class="cp">#define IMM_SH		0</span>
<span class="cp">#define JIMM_MASK	0x3ffffff</span>
<span class="cp">#define JIMM_SH		0</span>
<span class="cp">#define FUNC_MASK	0x3f</span>
<span class="cp">#define FUNC_SH		0</span>
<span class="cp">#define SET_MASK	0x7</span>
<span class="cp">#define SET_SH		0</span>
<span class="cp">#define SCIMM_MASK	0xfffff</span>
<span class="cp">#define SCIMM_SH	6</span>

<span class="k">enum</span> <span class="n">opcode</span> <span class="p">{</span>
	<span class="n">insn_invalid</span><span class="p">,</span>
	<span class="n">insn_addu</span><span class="p">,</span> <span class="n">insn_addiu</span><span class="p">,</span> <span class="n">insn_and</span><span class="p">,</span> <span class="n">insn_andi</span><span class="p">,</span> <span class="n">insn_beq</span><span class="p">,</span>
	<span class="n">insn_beql</span><span class="p">,</span> <span class="n">insn_bgez</span><span class="p">,</span> <span class="n">insn_bgezl</span><span class="p">,</span> <span class="n">insn_bltz</span><span class="p">,</span> <span class="n">insn_bltzl</span><span class="p">,</span>
	<span class="n">insn_bne</span><span class="p">,</span> <span class="n">insn_cache</span><span class="p">,</span> <span class="n">insn_daddu</span><span class="p">,</span> <span class="n">insn_daddiu</span><span class="p">,</span> <span class="n">insn_dmfc0</span><span class="p">,</span>
	<span class="n">insn_dmtc0</span><span class="p">,</span> <span class="n">insn_dsll</span><span class="p">,</span> <span class="n">insn_dsll32</span><span class="p">,</span> <span class="n">insn_dsra</span><span class="p">,</span> <span class="n">insn_dsrl</span><span class="p">,</span>
	<span class="n">insn_dsrl32</span><span class="p">,</span> <span class="n">insn_drotr</span><span class="p">,</span> <span class="n">insn_drotr32</span><span class="p">,</span> <span class="n">insn_dsubu</span><span class="p">,</span> <span class="n">insn_eret</span><span class="p">,</span>
	<span class="n">insn_j</span><span class="p">,</span> <span class="n">insn_jal</span><span class="p">,</span> <span class="n">insn_jr</span><span class="p">,</span> <span class="n">insn_ld</span><span class="p">,</span> <span class="n">insn_ll</span><span class="p">,</span> <span class="n">insn_lld</span><span class="p">,</span>
	<span class="n">insn_lui</span><span class="p">,</span> <span class="n">insn_lw</span><span class="p">,</span> <span class="n">insn_mfc0</span><span class="p">,</span> <span class="n">insn_mtc0</span><span class="p">,</span> <span class="n">insn_or</span><span class="p">,</span> <span class="n">insn_ori</span><span class="p">,</span>
	<span class="n">insn_pref</span><span class="p">,</span> <span class="n">insn_rfe</span><span class="p">,</span> <span class="n">insn_sc</span><span class="p">,</span> <span class="n">insn_scd</span><span class="p">,</span> <span class="n">insn_sd</span><span class="p">,</span> <span class="n">insn_sll</span><span class="p">,</span>
	<span class="n">insn_sra</span><span class="p">,</span> <span class="n">insn_srl</span><span class="p">,</span> <span class="n">insn_rotr</span><span class="p">,</span> <span class="n">insn_subu</span><span class="p">,</span> <span class="n">insn_sw</span><span class="p">,</span> <span class="n">insn_tlbp</span><span class="p">,</span>
	<span class="n">insn_tlbr</span><span class="p">,</span> <span class="n">insn_tlbwi</span><span class="p">,</span> <span class="n">insn_tlbwr</span><span class="p">,</span> <span class="n">insn_xor</span><span class="p">,</span> <span class="n">insn_xori</span><span class="p">,</span>
	<span class="n">insn_dins</span><span class="p">,</span> <span class="n">insn_dinsm</span><span class="p">,</span> <span class="n">insn_syscall</span><span class="p">,</span> <span class="n">insn_bbit0</span><span class="p">,</span> <span class="n">insn_bbit1</span><span class="p">,</span>
	<span class="n">insn_lwx</span><span class="p">,</span> <span class="n">insn_ldx</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">insn</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="n">opcode</span> <span class="n">opcode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">match</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">fields</span> <span class="n">fields</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* This macro sets the non-variable bits of an instruction. */</span>
<span class="cp">#define M(a, b, c, d, e, f)					\</span>
<span class="cp">	((a) &lt;&lt; OP_SH						\</span>
<span class="cp">	 | (b) &lt;&lt; RS_SH						\</span>
<span class="cp">	 | (c) &lt;&lt; RT_SH						\</span>
<span class="cp">	 | (d) &lt;&lt; RD_SH						\</span>
<span class="cp">	 | (e) &lt;&lt; RE_SH						\</span>
<span class="cp">	 | (f) &lt;&lt; FUNC_SH)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">insn</span> <span class="n">insn_table</span><span class="p">[]</span> <span class="n">__uasminitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">insn_addiu</span><span class="p">,</span> <span class="n">M</span><span class="p">(</span><span class="n">addiu_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">RS</span> <span class="o">|</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">SIMM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_addu</span><span class="p">,</span> <span class="n">M</span><span class="p">(</span><span class="n">spec_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">addu_op</span><span class="p">),</span> <span class="n">RS</span> <span class="o">|</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">RD</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_and</span><span class="p">,</span> <span class="n">M</span><span class="p">(</span><span class="n">spec_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">and_op</span><span class="p">),</span> <span class="n">RS</span> <span class="o">|</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">RD</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_andi</span><span class="p">,</span> <span class="n">M</span><span class="p">(</span><span class="n">andi_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">RS</span> <span class="o">|</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">UIMM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_beq</span><span class="p">,</span> <span class="n">M</span><span class="p">(</span><span class="n">beq_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">RS</span> <span class="o">|</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">BIMM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_beql</span><span class="p">,</span> <span class="n">M</span><span class="p">(</span><span class="n">beql_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">RS</span> <span class="o">|</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">BIMM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_bgez</span><span class="p">,</span> <span class="n">M</span><span class="p">(</span><span class="n">bcond_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bgez_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">RS</span> <span class="o">|</span> <span class="n">BIMM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_bgezl</span><span class="p">,</span> <span class="n">M</span><span class="p">(</span><span class="n">bcond_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bgezl_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">RS</span> <span class="o">|</span> <span class="n">BIMM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_bltz</span><span class="p">,</span> <span class="n">M</span><span class="p">(</span><span class="n">bcond_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bltz_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">RS</span> <span class="o">|</span> <span class="n">BIMM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_bltzl</span><span class="p">,</span> <span class="n">M</span><span class="p">(</span><span class="n">bcond_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bltzl_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">RS</span> <span class="o">|</span> <span class="n">BIMM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_bne</span><span class="p">,</span> <span class="n">M</span><span class="p">(</span><span class="n">bne_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">RS</span> <span class="o">|</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">BIMM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_cache</span><span class="p">,</span>  <span class="n">M</span><span class="p">(</span><span class="n">cache_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="n">RS</span> <span class="o">|</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">SIMM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_daddiu</span><span class="p">,</span> <span class="n">M</span><span class="p">(</span><span class="n">daddiu_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">RS</span> <span class="o">|</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">SIMM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_daddu</span><span class="p">,</span> <span class="n">M</span><span class="p">(</span><span class="n">spec_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">daddu_op</span><span class="p">),</span> <span class="n">RS</span> <span class="o">|</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">RD</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_dmfc0</span><span class="p">,</span> <span class="n">M</span><span class="p">(</span><span class="n">cop0_op</span><span class="p">,</span> <span class="n">dmfc_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">RD</span> <span class="o">|</span> <span class="n">SET</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_dmtc0</span><span class="p">,</span> <span class="n">M</span><span class="p">(</span><span class="n">cop0_op</span><span class="p">,</span> <span class="n">dmtc_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">RD</span> <span class="o">|</span> <span class="n">SET</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_dsll</span><span class="p">,</span> <span class="n">M</span><span class="p">(</span><span class="n">spec_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dsll_op</span><span class="p">),</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">RD</span> <span class="o">|</span> <span class="n">RE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_dsll32</span><span class="p">,</span> <span class="n">M</span><span class="p">(</span><span class="n">spec_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dsll32_op</span><span class="p">),</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">RD</span> <span class="o">|</span> <span class="n">RE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_dsra</span><span class="p">,</span> <span class="n">M</span><span class="p">(</span><span class="n">spec_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dsra_op</span><span class="p">),</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">RD</span> <span class="o">|</span> <span class="n">RE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_dsrl</span><span class="p">,</span> <span class="n">M</span><span class="p">(</span><span class="n">spec_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dsrl_op</span><span class="p">),</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">RD</span> <span class="o">|</span> <span class="n">RE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_dsrl32</span><span class="p">,</span> <span class="n">M</span><span class="p">(</span><span class="n">spec_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dsrl32_op</span><span class="p">),</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">RD</span> <span class="o">|</span> <span class="n">RE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_drotr</span><span class="p">,</span> <span class="n">M</span><span class="p">(</span><span class="n">spec_op</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dsrl_op</span><span class="p">),</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">RD</span> <span class="o">|</span> <span class="n">RE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_drotr32</span><span class="p">,</span> <span class="n">M</span><span class="p">(</span><span class="n">spec_op</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dsrl32_op</span><span class="p">),</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">RD</span> <span class="o">|</span> <span class="n">RE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_dsubu</span><span class="p">,</span> <span class="n">M</span><span class="p">(</span><span class="n">spec_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dsubu_op</span><span class="p">),</span> <span class="n">RS</span> <span class="o">|</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">RD</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_eret</span><span class="p">,</span>  <span class="n">M</span><span class="p">(</span><span class="n">cop0_op</span><span class="p">,</span> <span class="n">cop_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">eret_op</span><span class="p">),</span>  <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_j</span><span class="p">,</span>  <span class="n">M</span><span class="p">(</span><span class="n">j_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="n">JIMM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_jal</span><span class="p">,</span>  <span class="n">M</span><span class="p">(</span><span class="n">jal_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="n">JIMM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_jr</span><span class="p">,</span>  <span class="n">M</span><span class="p">(</span><span class="n">spec_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">jr_op</span><span class="p">),</span>  <span class="n">RS</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_ld</span><span class="p">,</span>  <span class="n">M</span><span class="p">(</span><span class="n">ld_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="n">RS</span> <span class="o">|</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">SIMM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_ll</span><span class="p">,</span>  <span class="n">M</span><span class="p">(</span><span class="n">ll_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="n">RS</span> <span class="o">|</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">SIMM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_lld</span><span class="p">,</span>  <span class="n">M</span><span class="p">(</span><span class="n">lld_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="n">RS</span> <span class="o">|</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">SIMM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_lui</span><span class="p">,</span>  <span class="n">M</span><span class="p">(</span><span class="n">lui_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="n">RT</span> <span class="o">|</span> <span class="n">SIMM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_lw</span><span class="p">,</span>  <span class="n">M</span><span class="p">(</span><span class="n">lw_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="n">RS</span> <span class="o">|</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">SIMM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_mfc0</span><span class="p">,</span>  <span class="n">M</span><span class="p">(</span><span class="n">cop0_op</span><span class="p">,</span> <span class="n">mfc_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="n">RT</span> <span class="o">|</span> <span class="n">RD</span> <span class="o">|</span> <span class="n">SET</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_mtc0</span><span class="p">,</span>  <span class="n">M</span><span class="p">(</span><span class="n">cop0_op</span><span class="p">,</span> <span class="n">mtc_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="n">RT</span> <span class="o">|</span> <span class="n">RD</span> <span class="o">|</span> <span class="n">SET</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_or</span><span class="p">,</span>  <span class="n">M</span><span class="p">(</span><span class="n">spec_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">or_op</span><span class="p">),</span>  <span class="n">RS</span> <span class="o">|</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">RD</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_ori</span><span class="p">,</span>  <span class="n">M</span><span class="p">(</span><span class="n">ori_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="n">RS</span> <span class="o">|</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">UIMM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_pref</span><span class="p">,</span>  <span class="n">M</span><span class="p">(</span><span class="n">pref_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="n">RS</span> <span class="o">|</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">SIMM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_rfe</span><span class="p">,</span>  <span class="n">M</span><span class="p">(</span><span class="n">cop0_op</span><span class="p">,</span> <span class="n">cop_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rfe_op</span><span class="p">),</span>  <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_sc</span><span class="p">,</span>  <span class="n">M</span><span class="p">(</span><span class="n">sc_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="n">RS</span> <span class="o">|</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">SIMM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_scd</span><span class="p">,</span>  <span class="n">M</span><span class="p">(</span><span class="n">scd_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="n">RS</span> <span class="o">|</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">SIMM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_sd</span><span class="p">,</span>  <span class="n">M</span><span class="p">(</span><span class="n">sd_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="n">RS</span> <span class="o">|</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">SIMM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_sll</span><span class="p">,</span>  <span class="n">M</span><span class="p">(</span><span class="n">spec_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sll_op</span><span class="p">),</span>  <span class="n">RT</span> <span class="o">|</span> <span class="n">RD</span> <span class="o">|</span> <span class="n">RE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_sra</span><span class="p">,</span>  <span class="n">M</span><span class="p">(</span><span class="n">spec_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sra_op</span><span class="p">),</span>  <span class="n">RT</span> <span class="o">|</span> <span class="n">RD</span> <span class="o">|</span> <span class="n">RE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_srl</span><span class="p">,</span>  <span class="n">M</span><span class="p">(</span><span class="n">spec_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">srl_op</span><span class="p">),</span>  <span class="n">RT</span> <span class="o">|</span> <span class="n">RD</span> <span class="o">|</span> <span class="n">RE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_rotr</span><span class="p">,</span>  <span class="n">M</span><span class="p">(</span><span class="n">spec_op</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">srl_op</span><span class="p">),</span>  <span class="n">RT</span> <span class="o">|</span> <span class="n">RD</span> <span class="o">|</span> <span class="n">RE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_subu</span><span class="p">,</span>  <span class="n">M</span><span class="p">(</span><span class="n">spec_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">subu_op</span><span class="p">),</span>  <span class="n">RS</span> <span class="o">|</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">RD</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_sw</span><span class="p">,</span>  <span class="n">M</span><span class="p">(</span><span class="n">sw_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="n">RS</span> <span class="o">|</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">SIMM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_tlbp</span><span class="p">,</span>  <span class="n">M</span><span class="p">(</span><span class="n">cop0_op</span><span class="p">,</span> <span class="n">cop_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tlbp_op</span><span class="p">),</span>  <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_tlbr</span><span class="p">,</span>  <span class="n">M</span><span class="p">(</span><span class="n">cop0_op</span><span class="p">,</span> <span class="n">cop_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tlbr_op</span><span class="p">),</span>  <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_tlbwi</span><span class="p">,</span>  <span class="n">M</span><span class="p">(</span><span class="n">cop0_op</span><span class="p">,</span> <span class="n">cop_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tlbwi_op</span><span class="p">),</span>  <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_tlbwr</span><span class="p">,</span>  <span class="n">M</span><span class="p">(</span><span class="n">cop0_op</span><span class="p">,</span> <span class="n">cop_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tlbwr_op</span><span class="p">),</span>  <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_xor</span><span class="p">,</span>  <span class="n">M</span><span class="p">(</span><span class="n">spec_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xor_op</span><span class="p">),</span>  <span class="n">RS</span> <span class="o">|</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">RD</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_xori</span><span class="p">,</span>  <span class="n">M</span><span class="p">(</span><span class="n">xori_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="n">RS</span> <span class="o">|</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">UIMM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_dins</span><span class="p">,</span> <span class="n">M</span><span class="p">(</span><span class="n">spec3_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dins_op</span><span class="p">),</span> <span class="n">RS</span> <span class="o">|</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">RD</span> <span class="o">|</span> <span class="n">RE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_dinsm</span><span class="p">,</span> <span class="n">M</span><span class="p">(</span><span class="n">spec3_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dinsm_op</span><span class="p">),</span> <span class="n">RS</span> <span class="o">|</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">RD</span> <span class="o">|</span> <span class="n">RE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_syscall</span><span class="p">,</span> <span class="n">M</span><span class="p">(</span><span class="n">spec_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">syscall_op</span><span class="p">),</span> <span class="n">SCIMM</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_bbit0</span><span class="p">,</span> <span class="n">M</span><span class="p">(</span><span class="n">lwc2_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">RS</span> <span class="o">|</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">BIMM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_bbit1</span><span class="p">,</span> <span class="n">M</span><span class="p">(</span><span class="n">swc2_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">RS</span> <span class="o">|</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">BIMM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_lwx</span><span class="p">,</span> <span class="n">M</span><span class="p">(</span><span class="n">spec3_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lwx_op</span><span class="p">,</span> <span class="n">lx_op</span><span class="p">),</span> <span class="n">RS</span> <span class="o">|</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">RD</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_ldx</span><span class="p">,</span> <span class="n">M</span><span class="p">(</span><span class="n">spec3_op</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ldx_op</span><span class="p">,</span> <span class="n">lx_op</span><span class="p">),</span> <span class="n">RS</span> <span class="o">|</span> <span class="n">RT</span> <span class="o">|</span> <span class="n">RD</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">insn_invalid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cp">#undef M</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__uasminit</span> <span class="n">u32</span> <span class="nf">build_rs</span><span class="p">(</span><span class="n">u32</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN</span><span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RS_MASK</span><span class="p">,</span> <span class="n">KERN_WARNING</span> <span class="s">&quot;Micro-assembler field overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">RS_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">RS_SH</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__uasminit</span> <span class="n">u32</span> <span class="nf">build_rt</span><span class="p">(</span><span class="n">u32</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN</span><span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RT_MASK</span><span class="p">,</span> <span class="n">KERN_WARNING</span> <span class="s">&quot;Micro-assembler field overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">RT_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">RT_SH</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__uasminit</span> <span class="n">u32</span> <span class="nf">build_rd</span><span class="p">(</span><span class="n">u32</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN</span><span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RD_MASK</span><span class="p">,</span> <span class="n">KERN_WARNING</span> <span class="s">&quot;Micro-assembler field overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">RD_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">RD_SH</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__uasminit</span> <span class="n">u32</span> <span class="nf">build_re</span><span class="p">(</span><span class="n">u32</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN</span><span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RE_MASK</span><span class="p">,</span> <span class="n">KERN_WARNING</span> <span class="s">&quot;Micro-assembler field overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">RE_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">RE_SH</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__uasminit</span> <span class="n">u32</span> <span class="nf">build_simm</span><span class="p">(</span><span class="n">s32</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN</span><span class="p">(</span><span class="n">arg</span> <span class="o">&gt;</span> <span class="mh">0x7fff</span> <span class="o">||</span> <span class="n">arg</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mh">0x8000</span><span class="p">,</span>
	     <span class="n">KERN_WARNING</span> <span class="s">&quot;Micro-assembler field overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">arg</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__uasminit</span> <span class="n">u32</span> <span class="nf">build_uimm</span><span class="p">(</span><span class="n">u32</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN</span><span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IMM_MASK</span><span class="p">,</span> <span class="n">KERN_WARNING</span> <span class="s">&quot;Micro-assembler field overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">arg</span> <span class="o">&amp;</span> <span class="n">IMM_MASK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__uasminit</span> <span class="n">u32</span> <span class="nf">build_bimm</span><span class="p">(</span><span class="n">s32</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN</span><span class="p">(</span><span class="n">arg</span> <span class="o">&gt;</span> <span class="mh">0x1ffff</span> <span class="o">||</span> <span class="n">arg</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mh">0x20000</span><span class="p">,</span>
	     <span class="n">KERN_WARNING</span> <span class="s">&quot;Micro-assembler field overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">WARN</span><span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">,</span> <span class="n">KERN_WARNING</span> <span class="s">&quot;Invalid micro-assembler branch target</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">((</span><span class="n">arg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__uasminit</span> <span class="n">u32</span> <span class="nf">build_jimm</span><span class="p">(</span><span class="n">u32</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN</span><span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">JIMM_MASK</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
	     <span class="n">KERN_WARNING</span> <span class="s">&quot;Micro-assembler field overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">JIMM_MASK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__uasminit</span> <span class="n">u32</span> <span class="nf">build_scimm</span><span class="p">(</span><span class="n">u32</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN</span><span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SCIMM_MASK</span><span class="p">,</span>
	     <span class="n">KERN_WARNING</span> <span class="s">&quot;Micro-assembler field overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">SCIMM_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">SCIMM_SH</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__uasminit</span> <span class="n">u32</span> <span class="nf">build_func</span><span class="p">(</span><span class="n">u32</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN</span><span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FUNC_MASK</span><span class="p">,</span> <span class="n">KERN_WARNING</span> <span class="s">&quot;Micro-assembler field overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">arg</span> <span class="o">&amp;</span> <span class="n">FUNC_MASK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__uasminit</span> <span class="n">u32</span> <span class="nf">build_set</span><span class="p">(</span><span class="n">u32</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN</span><span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SET_MASK</span><span class="p">,</span> <span class="n">KERN_WARNING</span> <span class="s">&quot;Micro-assembler field overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">arg</span> <span class="o">&amp;</span> <span class="n">SET_MASK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The order of opcode arguments is implicitly left to right,</span>
<span class="cm"> * starting with RS and ending with FUNC or IMM.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__uasminit</span> <span class="nf">build_insn</span><span class="p">(</span><span class="n">u32</span> <span class="o">**</span><span class="n">buf</span><span class="p">,</span> <span class="k">enum</span> <span class="n">opcode</span> <span class="n">opc</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">insn</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">va_list</span> <span class="n">ap</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">op</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">insn_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">opcode</span> <span class="o">!=</span> <span class="n">insn_invalid</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">insn_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">opc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ip</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">insn_table</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ip</span> <span class="o">||</span> <span class="p">(</span><span class="n">opc</span> <span class="o">==</span> <span class="n">insn_daddiu</span> <span class="o">&amp;&amp;</span> <span class="n">r4k_daddiu_bug</span><span class="p">()))</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Unsupported Micro-assembler instruction %d&quot;</span><span class="p">,</span> <span class="n">opc</span><span class="p">);</span>

	<span class="n">op</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">match</span><span class="p">;</span>
	<span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">opc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">fields</span> <span class="o">&amp;</span> <span class="n">RS</span><span class="p">)</span>
		<span class="n">op</span> <span class="o">|=</span> <span class="n">build_rs</span><span class="p">(</span><span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">u32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">fields</span> <span class="o">&amp;</span> <span class="n">RT</span><span class="p">)</span>
		<span class="n">op</span> <span class="o">|=</span> <span class="n">build_rt</span><span class="p">(</span><span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">u32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">fields</span> <span class="o">&amp;</span> <span class="n">RD</span><span class="p">)</span>
		<span class="n">op</span> <span class="o">|=</span> <span class="n">build_rd</span><span class="p">(</span><span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">u32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">fields</span> <span class="o">&amp;</span> <span class="n">RE</span><span class="p">)</span>
		<span class="n">op</span> <span class="o">|=</span> <span class="n">build_re</span><span class="p">(</span><span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">u32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">fields</span> <span class="o">&amp;</span> <span class="n">SIMM</span><span class="p">)</span>
		<span class="n">op</span> <span class="o">|=</span> <span class="n">build_simm</span><span class="p">(</span><span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">s32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">fields</span> <span class="o">&amp;</span> <span class="n">UIMM</span><span class="p">)</span>
		<span class="n">op</span> <span class="o">|=</span> <span class="n">build_uimm</span><span class="p">(</span><span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">u32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">fields</span> <span class="o">&amp;</span> <span class="n">BIMM</span><span class="p">)</span>
		<span class="n">op</span> <span class="o">|=</span> <span class="n">build_bimm</span><span class="p">(</span><span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">s32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">fields</span> <span class="o">&amp;</span> <span class="n">JIMM</span><span class="p">)</span>
		<span class="n">op</span> <span class="o">|=</span> <span class="n">build_jimm</span><span class="p">(</span><span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">u32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">fields</span> <span class="o">&amp;</span> <span class="n">FUNC</span><span class="p">)</span>
		<span class="n">op</span> <span class="o">|=</span> <span class="n">build_func</span><span class="p">(</span><span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">u32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">fields</span> <span class="o">&amp;</span> <span class="n">SET</span><span class="p">)</span>
		<span class="n">op</span> <span class="o">|=</span> <span class="n">build_set</span><span class="p">(</span><span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">u32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">fields</span> <span class="o">&amp;</span> <span class="n">SCIMM</span><span class="p">)</span>
		<span class="n">op</span> <span class="o">|=</span> <span class="n">build_scimm</span><span class="p">(</span><span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">u32</span><span class="p">));</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="o">**</span><span class="n">buf</span> <span class="o">=</span> <span class="n">op</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define I_u1u2u3(op)					\</span>
<span class="cp">Ip_u1u2u3(op)						\</span>
<span class="cp">{							\</span>
<span class="cp">	build_insn(buf, insn##op, a, b, c);		\</span>
<span class="cp">}							\</span>
<span class="cp">UASM_EXPORT_SYMBOL(uasm_i##op);</span>

<span class="cp">#define I_u2u1u3(op)					\</span>
<span class="cp">Ip_u2u1u3(op)						\</span>
<span class="cp">{							\</span>
<span class="cp">	build_insn(buf, insn##op, b, a, c);		\</span>
<span class="cp">}							\</span>
<span class="cp">UASM_EXPORT_SYMBOL(uasm_i##op);</span>

<span class="cp">#define I_u3u1u2(op)					\</span>
<span class="cp">Ip_u3u1u2(op)						\</span>
<span class="cp">{							\</span>
<span class="cp">	build_insn(buf, insn##op, b, c, a);		\</span>
<span class="cp">}							\</span>
<span class="cp">UASM_EXPORT_SYMBOL(uasm_i##op);</span>

<span class="cp">#define I_u1u2s3(op)					\</span>
<span class="cp">Ip_u1u2s3(op)						\</span>
<span class="cp">{							\</span>
<span class="cp">	build_insn(buf, insn##op, a, b, c);		\</span>
<span class="cp">}							\</span>
<span class="cp">UASM_EXPORT_SYMBOL(uasm_i##op);</span>

<span class="cp">#define I_u2s3u1(op)					\</span>
<span class="cp">Ip_u2s3u1(op)						\</span>
<span class="cp">{							\</span>
<span class="cp">	build_insn(buf, insn##op, c, a, b);		\</span>
<span class="cp">}							\</span>
<span class="cp">UASM_EXPORT_SYMBOL(uasm_i##op);</span>

<span class="cp">#define I_u2u1s3(op)					\</span>
<span class="cp">Ip_u2u1s3(op)						\</span>
<span class="cp">{							\</span>
<span class="cp">	build_insn(buf, insn##op, b, a, c);		\</span>
<span class="cp">}							\</span>
<span class="cp">UASM_EXPORT_SYMBOL(uasm_i##op);</span>

<span class="cp">#define I_u2u1msbu3(op)					\</span>
<span class="cp">Ip_u2u1msbu3(op)					\</span>
<span class="cp">{							\</span>
<span class="cp">	build_insn(buf, insn##op, b, a, c+d-1, c);	\</span>
<span class="cp">}							\</span>
<span class="cp">UASM_EXPORT_SYMBOL(uasm_i##op);</span>

<span class="cp">#define I_u2u1msb32u3(op)				\</span>
<span class="cp">Ip_u2u1msbu3(op)					\</span>
<span class="cp">{							\</span>
<span class="cp">	build_insn(buf, insn##op, b, a, c+d-33, c);	\</span>
<span class="cp">}							\</span>
<span class="cp">UASM_EXPORT_SYMBOL(uasm_i##op);</span>

<span class="cp">#define I_u1u2(op)					\</span>
<span class="cp">Ip_u1u2(op)						\</span>
<span class="cp">{							\</span>
<span class="cp">	build_insn(buf, insn##op, a, b);		\</span>
<span class="cp">}							\</span>
<span class="cp">UASM_EXPORT_SYMBOL(uasm_i##op);</span>

<span class="cp">#define I_u1s2(op)					\</span>
<span class="cp">Ip_u1s2(op)						\</span>
<span class="cp">{							\</span>
<span class="cp">	build_insn(buf, insn##op, a, b);		\</span>
<span class="cp">}							\</span>
<span class="cp">UASM_EXPORT_SYMBOL(uasm_i##op);</span>

<span class="cp">#define I_u1(op)					\</span>
<span class="cp">Ip_u1(op)						\</span>
<span class="cp">{							\</span>
<span class="cp">	build_insn(buf, insn##op, a);			\</span>
<span class="cp">}							\</span>
<span class="cp">UASM_EXPORT_SYMBOL(uasm_i##op);</span>

<span class="cp">#define I_0(op)						\</span>
<span class="cp">Ip_0(op)						\</span>
<span class="cp">{							\</span>
<span class="cp">	build_insn(buf, insn##op);			\</span>
<span class="cp">}							\</span>
<span class="cp">UASM_EXPORT_SYMBOL(uasm_i##op);</span>

<span class="n">I_u2u1s3</span><span class="p">(</span><span class="n">_addiu</span><span class="p">)</span>
<span class="n">I_u3u1u2</span><span class="p">(</span><span class="n">_addu</span><span class="p">)</span>
<span class="n">I_u2u1u3</span><span class="p">(</span><span class="n">_andi</span><span class="p">)</span>
<span class="n">I_u3u1u2</span><span class="p">(</span><span class="n">_and</span><span class="p">)</span>
<span class="n">I_u1u2s3</span><span class="p">(</span><span class="n">_beq</span><span class="p">)</span>
<span class="n">I_u1u2s3</span><span class="p">(</span><span class="n">_beql</span><span class="p">)</span>
<span class="n">I_u1s2</span><span class="p">(</span><span class="n">_bgez</span><span class="p">)</span>
<span class="n">I_u1s2</span><span class="p">(</span><span class="n">_bgezl</span><span class="p">)</span>
<span class="n">I_u1s2</span><span class="p">(</span><span class="n">_bltz</span><span class="p">)</span>
<span class="n">I_u1s2</span><span class="p">(</span><span class="n">_bltzl</span><span class="p">)</span>
<span class="n">I_u1u2s3</span><span class="p">(</span><span class="n">_bne</span><span class="p">)</span>
<span class="n">I_u2s3u1</span><span class="p">(</span><span class="n">_cache</span><span class="p">)</span>
<span class="n">I_u1u2u3</span><span class="p">(</span><span class="n">_dmfc0</span><span class="p">)</span>
<span class="n">I_u1u2u3</span><span class="p">(</span><span class="n">_dmtc0</span><span class="p">)</span>
<span class="n">I_u2u1s3</span><span class="p">(</span><span class="n">_daddiu</span><span class="p">)</span>
<span class="n">I_u3u1u2</span><span class="p">(</span><span class="n">_daddu</span><span class="p">)</span>
<span class="n">I_u2u1u3</span><span class="p">(</span><span class="n">_dsll</span><span class="p">)</span>
<span class="n">I_u2u1u3</span><span class="p">(</span><span class="n">_dsll32</span><span class="p">)</span>
<span class="n">I_u2u1u3</span><span class="p">(</span><span class="n">_dsra</span><span class="p">)</span>
<span class="n">I_u2u1u3</span><span class="p">(</span><span class="n">_dsrl</span><span class="p">)</span>
<span class="n">I_u2u1u3</span><span class="p">(</span><span class="n">_dsrl32</span><span class="p">)</span>
<span class="n">I_u2u1u3</span><span class="p">(</span><span class="n">_drotr</span><span class="p">)</span>
<span class="n">I_u2u1u3</span><span class="p">(</span><span class="n">_drotr32</span><span class="p">)</span>
<span class="n">I_u3u1u2</span><span class="p">(</span><span class="n">_dsubu</span><span class="p">)</span>
<span class="n">I_0</span><span class="p">(</span><span class="n">_eret</span><span class="p">)</span>
<span class="n">I_u1</span><span class="p">(</span><span class="n">_j</span><span class="p">)</span>
<span class="n">I_u1</span><span class="p">(</span><span class="n">_jal</span><span class="p">)</span>
<span class="n">I_u1</span><span class="p">(</span><span class="n">_jr</span><span class="p">)</span>
<span class="n">I_u2s3u1</span><span class="p">(</span><span class="n">_ld</span><span class="p">)</span>
<span class="n">I_u2s3u1</span><span class="p">(</span><span class="n">_ll</span><span class="p">)</span>
<span class="n">I_u2s3u1</span><span class="p">(</span><span class="n">_lld</span><span class="p">)</span>
<span class="n">I_u1s2</span><span class="p">(</span><span class="n">_lui</span><span class="p">)</span>
<span class="n">I_u2s3u1</span><span class="p">(</span><span class="n">_lw</span><span class="p">)</span>
<span class="n">I_u1u2u3</span><span class="p">(</span><span class="n">_mfc0</span><span class="p">)</span>
<span class="n">I_u1u2u3</span><span class="p">(</span><span class="n">_mtc0</span><span class="p">)</span>
<span class="n">I_u2u1u3</span><span class="p">(</span><span class="n">_ori</span><span class="p">)</span>
<span class="n">I_u3u1u2</span><span class="p">(</span><span class="n">_or</span><span class="p">)</span>
<span class="n">I_0</span><span class="p">(</span><span class="n">_rfe</span><span class="p">)</span>
<span class="n">I_u2s3u1</span><span class="p">(</span><span class="n">_sc</span><span class="p">)</span>
<span class="n">I_u2s3u1</span><span class="p">(</span><span class="n">_scd</span><span class="p">)</span>
<span class="n">I_u2s3u1</span><span class="p">(</span><span class="n">_sd</span><span class="p">)</span>
<span class="n">I_u2u1u3</span><span class="p">(</span><span class="n">_sll</span><span class="p">)</span>
<span class="n">I_u2u1u3</span><span class="p">(</span><span class="n">_sra</span><span class="p">)</span>
<span class="n">I_u2u1u3</span><span class="p">(</span><span class="n">_srl</span><span class="p">)</span>
<span class="n">I_u2u1u3</span><span class="p">(</span><span class="n">_rotr</span><span class="p">)</span>
<span class="n">I_u3u1u2</span><span class="p">(</span><span class="n">_subu</span><span class="p">)</span>
<span class="n">I_u2s3u1</span><span class="p">(</span><span class="n">_sw</span><span class="p">)</span>
<span class="n">I_0</span><span class="p">(</span><span class="n">_tlbp</span><span class="p">)</span>
<span class="n">I_0</span><span class="p">(</span><span class="n">_tlbr</span><span class="p">)</span>
<span class="n">I_0</span><span class="p">(</span><span class="n">_tlbwi</span><span class="p">)</span>
<span class="n">I_0</span><span class="p">(</span><span class="n">_tlbwr</span><span class="p">)</span>
<span class="n">I_u3u1u2</span><span class="p">(</span><span class="n">_xor</span><span class="p">)</span>
<span class="n">I_u2u1u3</span><span class="p">(</span><span class="n">_xori</span><span class="p">)</span>
<span class="n">I_u2u1msbu3</span><span class="p">(</span><span class="n">_dins</span><span class="p">);</span>
<span class="n">I_u2u1msb32u3</span><span class="p">(</span><span class="n">_dinsm</span><span class="p">);</span>
<span class="n">I_u1</span><span class="p">(</span><span class="n">_syscall</span><span class="p">);</span>
<span class="n">I_u1u2s3</span><span class="p">(</span><span class="n">_bbit0</span><span class="p">);</span>
<span class="n">I_u1u2s3</span><span class="p">(</span><span class="n">_bbit1</span><span class="p">);</span>
<span class="n">I_u3u1u2</span><span class="p">(</span><span class="n">_lwx</span><span class="p">)</span>
<span class="n">I_u3u1u2</span><span class="p">(</span><span class="n">_ldx</span><span class="p">)</span>

<span class="cp">#ifdef CONFIG_CPU_CAVIUM_OCTEON</span>
<span class="cp">#include &lt;asm/octeon/octeon.h&gt;</span>
<span class="kt">void</span> <span class="n">__uasminit</span> <span class="n">uasm_i_pref</span><span class="p">(</span><span class="n">u32</span> <span class="o">**</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">signed</span> <span class="kt">int</span> <span class="n">b</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">OCTEON_IS_MODEL</span><span class="p">(</span><span class="n">OCTEON_CN63XX_PASS1_X</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">a</span> <span class="o">&lt;=</span> <span class="mi">24</span> <span class="o">&amp;&amp;</span> <span class="n">a</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * As per erratum Core-14449, replace prefetches 0-4,</span>
<span class="cm">		 * 6-24 with &#39;pref 28&#39;.</span>
<span class="cm">		 */</span>
		<span class="n">build_insn</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">insn_pref</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">build_insn</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">insn_pref</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">UASM_EXPORT_SYMBOL</span><span class="p">(</span><span class="n">uasm_i_pref</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="n">I_u2s3u1</span><span class="p">(</span><span class="n">_pref</span><span class="p">)</span>
<span class="cp">#endif</span>

<span class="cm">/* Handle labels. */</span>
<span class="kt">void</span> <span class="n">__uasminit</span> <span class="n">uasm_build_label</span><span class="p">(</span><span class="k">struct</span> <span class="n">uasm_label</span> <span class="o">**</span><span class="n">lab</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">(</span><span class="o">*</span><span class="n">lab</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">lab</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">lab</span> <span class="o">=</span> <span class="n">lid</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">lab</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">UASM_EXPORT_SYMBOL</span><span class="p">(</span><span class="n">uasm_build_label</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">__uasminit</span> <span class="nf">uasm_in_compat_space_p</span><span class="p">(</span><span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Is this address in 32bit compat space? */</span>
<span class="cp">#ifdef CONFIG_64BIT</span>
	<span class="k">return</span> <span class="p">(((</span><span class="n">addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff00000000L</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xffffffff00000000L</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>
<span class="n">UASM_EXPORT_SYMBOL</span><span class="p">(</span><span class="n">uasm_in_compat_space_p</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__uasminit</span> <span class="nf">uasm_rel_highest</span><span class="p">(</span><span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_64BIT</span>
	<span class="k">return</span> <span class="p">((((</span><span class="n">val</span> <span class="o">+</span> <span class="mh">0x800080008000L</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">48</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x8000</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__uasminit</span> <span class="nf">uasm_rel_higher</span><span class="p">(</span><span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_64BIT</span>
	<span class="k">return</span> <span class="p">((((</span><span class="n">val</span> <span class="o">+</span> <span class="mh">0x80008000L</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x8000</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__uasminit</span> <span class="nf">uasm_rel_hi</span><span class="p">(</span><span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((((</span><span class="n">val</span> <span class="o">+</span> <span class="mh">0x8000L</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x8000</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">UASM_EXPORT_SYMBOL</span><span class="p">(</span><span class="n">uasm_rel_hi</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">__uasminit</span> <span class="nf">uasm_rel_lo</span><span class="p">(</span><span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x8000</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">UASM_EXPORT_SYMBOL</span><span class="p">(</span><span class="n">uasm_rel_lo</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">__uasminit</span> <span class="nf">UASM_i_LA_mostly</span><span class="p">(</span><span class="n">u32</span> <span class="o">**</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rs</span><span class="p">,</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uasm_in_compat_space_p</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">uasm_i_lui</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">uasm_rel_highest</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uasm_rel_higher</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
			<span class="n">uasm_i_daddiu</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">uasm_rel_higher</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uasm_rel_hi</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">uasm_i_dsll</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">uasm_i_daddiu</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">uasm_rel_hi</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
			<span class="n">uasm_i_dsll</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">uasm_i_dsll32</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">uasm_i_lui</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">uasm_rel_hi</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">UASM_EXPORT_SYMBOL</span><span class="p">(</span><span class="n">UASM_i_LA_mostly</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">__uasminit</span> <span class="nf">UASM_i_LA</span><span class="p">(</span><span class="n">u32</span> <span class="o">**</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rs</span><span class="p">,</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">UASM_i_LA_mostly</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uasm_rel_lo</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uasm_in_compat_space_p</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
			<span class="n">uasm_i_daddiu</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">uasm_rel_lo</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">uasm_i_addiu</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">uasm_rel_lo</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">UASM_EXPORT_SYMBOL</span><span class="p">(</span><span class="n">UASM_i_LA</span><span class="p">);</span>

<span class="cm">/* Handle relocations. */</span>
<span class="kt">void</span> <span class="n">__uasminit</span>
<span class="nf">uasm_r_mips_pc16</span><span class="p">(</span><span class="k">struct</span> <span class="n">uasm_reloc</span> <span class="o">**</span><span class="n">rel</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">(</span><span class="o">*</span><span class="n">rel</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">rel</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">R_MIPS_PC16</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">rel</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">lab</span> <span class="o">=</span> <span class="n">lid</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">rel</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">UASM_EXPORT_SYMBOL</span><span class="p">(</span><span class="n">uasm_r_mips_pc16</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">__uasminit</span>
<span class="nf">__resolve_relocs</span><span class="p">(</span><span class="k">struct</span> <span class="n">uasm_reloc</span> <span class="o">*</span><span class="n">rel</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uasm_label</span> <span class="o">*</span><span class="n">lab</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">laddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">lab</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">raddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">rel</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rel</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">R_MIPS_PC16</span>:
		<span class="o">*</span><span class="n">rel</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">|=</span> <span class="n">build_bimm</span><span class="p">(</span><span class="n">laddr</span> <span class="o">-</span> <span class="p">(</span><span class="n">raddr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Unsupported Micro-assembler relocation %d&quot;</span><span class="p">,</span>
		      <span class="n">rel</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__uasminit</span>
<span class="nf">uasm_resolve_relocs</span><span class="p">(</span><span class="k">struct</span> <span class="n">uasm_reloc</span> <span class="o">*</span><span class="n">rel</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uasm_label</span> <span class="o">*</span><span class="n">lab</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uasm_label</span> <span class="o">*</span><span class="n">l</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">rel</span><span class="o">-&gt;</span><span class="n">lab</span> <span class="o">!=</span> <span class="n">UASM_LABEL_INVALID</span><span class="p">;</span> <span class="n">rel</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">l</span> <span class="o">=</span> <span class="n">lab</span><span class="p">;</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">lab</span> <span class="o">!=</span> <span class="n">UASM_LABEL_INVALID</span><span class="p">;</span> <span class="n">l</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rel</span><span class="o">-&gt;</span><span class="n">lab</span> <span class="o">==</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">lab</span><span class="p">)</span>
				<span class="n">__resolve_relocs</span><span class="p">(</span><span class="n">rel</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">UASM_EXPORT_SYMBOL</span><span class="p">(</span><span class="n">uasm_resolve_relocs</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">__uasminit</span>
<span class="nf">uasm_move_relocs</span><span class="p">(</span><span class="k">struct</span> <span class="n">uasm_reloc</span> <span class="o">*</span><span class="n">rel</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">first</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span> <span class="kt">long</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">rel</span><span class="o">-&gt;</span><span class="n">lab</span> <span class="o">!=</span> <span class="n">UASM_LABEL_INVALID</span><span class="p">;</span> <span class="n">rel</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rel</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">first</span> <span class="o">&amp;&amp;</span> <span class="n">rel</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
			<span class="n">rel</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+=</span> <span class="n">off</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">UASM_EXPORT_SYMBOL</span><span class="p">(</span><span class="n">uasm_move_relocs</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">__uasminit</span>
<span class="nf">uasm_move_labels</span><span class="p">(</span><span class="k">struct</span> <span class="n">uasm_label</span> <span class="o">*</span><span class="n">lab</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">first</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span> <span class="kt">long</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">lab</span><span class="o">-&gt;</span><span class="n">lab</span> <span class="o">!=</span> <span class="n">UASM_LABEL_INVALID</span><span class="p">;</span> <span class="n">lab</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lab</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">first</span> <span class="o">&amp;&amp;</span> <span class="n">lab</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
			<span class="n">lab</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+=</span> <span class="n">off</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">UASM_EXPORT_SYMBOL</span><span class="p">(</span><span class="n">uasm_move_labels</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">__uasminit</span>
<span class="nf">uasm_copy_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">uasm_reloc</span> <span class="o">*</span><span class="n">rel</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uasm_label</span> <span class="o">*</span><span class="n">lab</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">first</span><span class="p">,</span>
		  <span class="n">u32</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">off</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="n">target</span> <span class="o">-</span> <span class="n">first</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">first</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>

	<span class="n">uasm_move_relocs</span><span class="p">(</span><span class="n">rel</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
	<span class="n">uasm_move_labels</span><span class="p">(</span><span class="n">lab</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">UASM_EXPORT_SYMBOL</span><span class="p">(</span><span class="n">uasm_copy_handler</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">__uasminit</span> <span class="nf">uasm_insn_has_bdelay</span><span class="p">(</span><span class="k">struct</span> <span class="n">uasm_reloc</span> <span class="o">*</span><span class="n">rel</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">rel</span><span class="o">-&gt;</span><span class="n">lab</span> <span class="o">!=</span> <span class="n">UASM_LABEL_INVALID</span><span class="p">;</span> <span class="n">rel</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rel</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">==</span> <span class="n">addr</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rel</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">R_MIPS_PC16</span>
			<span class="o">||</span> <span class="n">rel</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">R_MIPS_26</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">UASM_EXPORT_SYMBOL</span><span class="p">(</span><span class="n">uasm_insn_has_bdelay</span><span class="p">);</span>

<span class="cm">/* Convenience functions for labeled branches. */</span>
<span class="kt">void</span> <span class="n">__uasminit</span>
<span class="nf">uasm_il_bltz</span><span class="p">(</span><span class="n">u32</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uasm_reloc</span> <span class="o">**</span><span class="n">r</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uasm_r_mips_pc16</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">lid</span><span class="p">);</span>
	<span class="n">uasm_i_bltz</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">UASM_EXPORT_SYMBOL</span><span class="p">(</span><span class="n">uasm_il_bltz</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">__uasminit</span>
<span class="nf">uasm_il_b</span><span class="p">(</span><span class="n">u32</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uasm_reloc</span> <span class="o">**</span><span class="n">r</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uasm_r_mips_pc16</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">lid</span><span class="p">);</span>
	<span class="n">uasm_i_b</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">UASM_EXPORT_SYMBOL</span><span class="p">(</span><span class="n">uasm_il_b</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">__uasminit</span>
<span class="nf">uasm_il_beqz</span><span class="p">(</span><span class="n">u32</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uasm_reloc</span> <span class="o">**</span><span class="n">r</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uasm_r_mips_pc16</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">lid</span><span class="p">);</span>
	<span class="n">uasm_i_beqz</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">UASM_EXPORT_SYMBOL</span><span class="p">(</span><span class="n">uasm_il_beqz</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">__uasminit</span>
<span class="nf">uasm_il_beqzl</span><span class="p">(</span><span class="n">u32</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uasm_reloc</span> <span class="o">**</span><span class="n">r</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uasm_r_mips_pc16</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">lid</span><span class="p">);</span>
	<span class="n">uasm_i_beqzl</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">UASM_EXPORT_SYMBOL</span><span class="p">(</span><span class="n">uasm_il_beqzl</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">__uasminit</span>
<span class="nf">uasm_il_bne</span><span class="p">(</span><span class="n">u32</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uasm_reloc</span> <span class="o">**</span><span class="n">r</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg1</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uasm_r_mips_pc16</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">lid</span><span class="p">);</span>
	<span class="n">uasm_i_bne</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">reg1</span><span class="p">,</span> <span class="n">reg2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">UASM_EXPORT_SYMBOL</span><span class="p">(</span><span class="n">uasm_il_bne</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">__uasminit</span>
<span class="nf">uasm_il_bnez</span><span class="p">(</span><span class="n">u32</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uasm_reloc</span> <span class="o">**</span><span class="n">r</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uasm_r_mips_pc16</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">lid</span><span class="p">);</span>
	<span class="n">uasm_i_bnez</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">UASM_EXPORT_SYMBOL</span><span class="p">(</span><span class="n">uasm_il_bnez</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">__uasminit</span>
<span class="nf">uasm_il_bgezl</span><span class="p">(</span><span class="n">u32</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uasm_reloc</span> <span class="o">**</span><span class="n">r</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uasm_r_mips_pc16</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">lid</span><span class="p">);</span>
	<span class="n">uasm_i_bgezl</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">UASM_EXPORT_SYMBOL</span><span class="p">(</span><span class="n">uasm_il_bgezl</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">__uasminit</span>
<span class="nf">uasm_il_bgez</span><span class="p">(</span><span class="n">u32</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uasm_reloc</span> <span class="o">**</span><span class="n">r</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uasm_r_mips_pc16</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">lid</span><span class="p">);</span>
	<span class="n">uasm_i_bgez</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">UASM_EXPORT_SYMBOL</span><span class="p">(</span><span class="n">uasm_il_bgez</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">__uasminit</span>
<span class="nf">uasm_il_bbit0</span><span class="p">(</span><span class="n">u32</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uasm_reloc</span> <span class="o">**</span><span class="n">r</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
	      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uasm_r_mips_pc16</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">lid</span><span class="p">);</span>
	<span class="n">uasm_i_bbit0</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">UASM_EXPORT_SYMBOL</span><span class="p">(</span><span class="n">uasm_il_bbit0</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">__uasminit</span>
<span class="nf">uasm_il_bbit1</span><span class="p">(</span><span class="n">u32</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uasm_reloc</span> <span class="o">**</span><span class="n">r</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
	      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uasm_r_mips_pc16</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">lid</span><span class="p">);</span>
	<span class="n">uasm_i_bbit1</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">UASM_EXPORT_SYMBOL</span><span class="p">(</span><span class="n">uasm_il_bbit1</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
