<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › mips › txx9 › rbtx4939 › setup.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>setup.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Toshiba RBTX4939 setup routines.</span>
<span class="cm"> * Based on linux/arch/mips/txx9/rbtx4938/setup.c,</span>
<span class="cm"> *	    and RBTX49xx patch from CELF patch archive.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2000-2001,2005-2007 Toshiba Corporation</span>
<span class="cm"> * 2003-2005 (c) MontaVista Software, Inc. This file is licensed under the</span>
<span class="cm"> * terms of the GNU General Public License version 2. This program is</span>
<span class="cm"> * licensed &quot;as is&quot; without any warranty of any kind, whether express</span>
<span class="cm"> * or implied.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/leds.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/smc91x.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/mtd.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/partitions.h&gt;</span>
<span class="cp">#include &lt;linux/mtd/map.h&gt;</span>
<span class="cp">#include &lt;asm/reboot.h&gt;</span>
<span class="cp">#include &lt;asm/txx9/generic.h&gt;</span>
<span class="cp">#include &lt;asm/txx9/pci.h&gt;</span>
<span class="cp">#include &lt;asm/txx9/rbtx4939.h&gt;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rbtx4939_machine_restart</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">command</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">local_irq_disable</span><span class="p">();</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">rbtx4939_reseten_addr</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">rbtx4939_softreset_addr</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
		<span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">rbtx4939_time_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tx4939_time_init</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if defined(__BIG_ENDIAN) &amp;&amp; \</span>
<span class="cp">	(defined(CONFIG_SMC91X) || defined(CONFIG_SMC91X_MODULE))</span>
<span class="cp">#define HAVE_RBTX4939_IOSWAB</span>
<span class="cp">#define IS_CE1_ADDR(addr) \</span>
<span class="cp">	((((unsigned long)(addr) - IO_BASE) &amp; 0xfff00000) == TXX9_CE(1))</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">rbtx4939_ioswabw</span><span class="p">(</span><span class="k">volatile</span> <span class="n">u16</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">u16</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">IS_CE1_ADDR</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">?</span> <span class="n">x</span> <span class="o">:</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">rbtx4939_mem_ioswabw</span><span class="p">(</span><span class="k">volatile</span> <span class="n">u16</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">u16</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">IS_CE1_ADDR</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">?</span> <span class="n">x</span> <span class="o">:</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* __BIG_ENDIAN &amp;&amp; CONFIG_SMC91X */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">rbtx4939_pci_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="kt">int</span> <span class="n">extarb</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">__raw_readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx4939_ccfgptr</span><span class="o">-&gt;</span><span class="n">ccfg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TX4939_CCFG_PCIARB</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txx9_primary_pcic</span><span class="p">;</span>

	<span class="n">register_pci_controller</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

	<span class="n">tx4939_report_pciclk</span><span class="p">();</span>
	<span class="n">tx4927_pcic_setup</span><span class="p">(</span><span class="n">tx4939_pcicptr</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">extarb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">__raw_readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx4939_ccfgptr</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TX4939_PCFG_ATA1MODE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">__raw_readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx4939_ccfgptr</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">)</span> <span class="o">&amp;</span>
	     <span class="p">(</span><span class="n">TX4939_PCFG_ET0MODE</span> <span class="o">|</span> <span class="n">TX4939_PCFG_ET1MODE</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">tx4939_report_pci1clk</span><span class="p">();</span>

		<span class="cm">/* mem:64K(max), io:64K(max) (enough for ETH0,ETH1) */</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">txx9_alloc_pci_controller</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x10000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x10000</span><span class="p">);</span>
		<span class="n">register_pci_controller</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="n">tx4927_pcic_setup</span><span class="p">(</span><span class="n">tx4939_pcic1ptr</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tx4939_setup_pcierr_irq</span><span class="p">();</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI */</span><span class="cp"></span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">default_ebccr</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x01c0000000007608ULL</span><span class="p">,</span> <span class="cm">/* 64M ROM */</span>
	<span class="mh">0x017f000000007049ULL</span><span class="p">,</span> <span class="cm">/* 1M IOC */</span>
	<span class="mh">0x0180000000408608ULL</span><span class="p">,</span> <span class="cm">/* ISA */</span>
	<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">rbtx4939_ebusc_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sp</span><span class="p">;</span>

	<span class="cm">/* use user-configured speed */</span>
	<span class="n">sp</span> <span class="o">=</span> <span class="n">TX4939_EBUSC_CR</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">;</span>
	<span class="n">default_ebccr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">sp</span><span class="p">;</span>
	<span class="n">default_ebccr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">sp</span><span class="p">;</span>
	<span class="n">default_ebccr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">sp</span><span class="p">;</span>
	<span class="cm">/* initialise by myself */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">default_ebccr</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">default_ebccr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">____raw_writeq</span><span class="p">(</span><span class="n">default_ebccr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				       <span class="o">&amp;</span><span class="n">tx4939_ebuscptr</span><span class="o">-&gt;</span><span class="n">cr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">else</span>
			<span class="n">____raw_writeq</span><span class="p">(</span><span class="n">____raw_readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx4939_ebuscptr</span><span class="o">-&gt;</span><span class="n">cr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				       <span class="o">&amp;</span> <span class="o">~</span><span class="mi">8</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">tx4939_ebuscptr</span><span class="o">-&gt;</span><span class="n">cr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">rbtx4939_update_ioc_pen</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u64</span> <span class="n">pcfg</span> <span class="o">=</span> <span class="n">____raw_readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx4939_ccfgptr</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">);</span>
	<span class="n">__u64</span> <span class="n">ccfg</span> <span class="o">=</span> <span class="n">____raw_readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx4939_ccfgptr</span><span class="o">-&gt;</span><span class="n">ccfg</span><span class="p">);</span>
	<span class="n">__u8</span> <span class="n">pe1</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">rbtx4939_pe1_addr</span><span class="p">);</span>
	<span class="n">__u8</span> <span class="n">pe2</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">rbtx4939_pe2_addr</span><span class="p">);</span>
	<span class="n">__u8</span> <span class="n">pe3</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">rbtx4939_pe3_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcfg</span> <span class="o">&amp;</span> <span class="n">TX4939_PCFG_ATA0MODE</span><span class="p">)</span>
		<span class="n">pe1</span> <span class="o">|=</span> <span class="n">RBTX4939_PE1_ATA</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pe1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RBTX4939_PE1_ATA</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcfg</span> <span class="o">&amp;</span> <span class="n">TX4939_PCFG_ATA1MODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pe1</span> <span class="o">|=</span> <span class="n">RBTX4939_PE1_ATA</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">pe1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RBTX4939_PE1_RMII</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">RBTX4939_PE1_RMII</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pe1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RBTX4939_PE1_ATA</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pcfg</span> <span class="o">&amp;</span> <span class="n">TX4939_PCFG_ET0MODE</span><span class="p">)</span>
			<span class="n">pe1</span> <span class="o">|=</span> <span class="n">RBTX4939_PE1_RMII</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">pe1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RBTX4939_PE1_RMII</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pcfg</span> <span class="o">&amp;</span> <span class="n">TX4939_PCFG_ET1MODE</span><span class="p">)</span>
			<span class="n">pe1</span> <span class="o">|=</span> <span class="n">RBTX4939_PE1_RMII</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">pe1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RBTX4939_PE1_RMII</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ccfg</span> <span class="o">&amp;</span> <span class="n">TX4939_CCFG_PTSEL</span><span class="p">)</span>
		<span class="n">pe3</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RBTX4939_PE3_VP</span> <span class="o">|</span> <span class="n">RBTX4939_PE3_VP_P</span> <span class="o">|</span>
			 <span class="n">RBTX4939_PE3_VP_S</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">__u64</span> <span class="n">vmode</span> <span class="o">=</span> <span class="n">pcfg</span> <span class="o">&amp;</span>
			<span class="p">(</span><span class="n">TX4939_PCFG_VSSMODE</span> <span class="o">|</span> <span class="n">TX4939_PCFG_VPSMODE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vmode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pe3</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RBTX4939_PE3_VP</span> <span class="o">|</span> <span class="n">RBTX4939_PE3_VP_P</span> <span class="o">|</span>
				 <span class="n">RBTX4939_PE3_VP_S</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vmode</span> <span class="o">==</span> <span class="n">TX4939_PCFG_VPSMODE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pe3</span> <span class="o">|=</span> <span class="n">RBTX4939_PE3_VP_P</span><span class="p">;</span>
			<span class="n">pe3</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RBTX4939_PE3_VP</span> <span class="o">|</span> <span class="n">RBTX4939_PE3_VP_S</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vmode</span> <span class="o">==</span> <span class="n">TX4939_PCFG_VSSMODE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pe3</span> <span class="o">|=</span> <span class="n">RBTX4939_PE3_VP</span> <span class="o">|</span> <span class="n">RBTX4939_PE3_VP_S</span><span class="p">;</span>
			<span class="n">pe3</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RBTX4939_PE3_VP_P</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pe3</span> <span class="o">|=</span> <span class="n">RBTX4939_PE3_VP</span> <span class="o">|</span> <span class="n">RBTX4939_PE3_VP_P</span><span class="p">;</span>
			<span class="n">pe3</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RBTX4939_PE3_VP_S</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcfg</span> <span class="o">&amp;</span> <span class="n">TX4939_PCFG_SPIMODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pcfg</span> <span class="o">&amp;</span> <span class="n">TX4939_PCFG_SIO2MODE_GPIO</span><span class="p">)</span>
			<span class="n">pe2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RBTX4939_PE2_SIO2</span> <span class="o">|</span> <span class="n">RBTX4939_PE2_SIO0</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pcfg</span> <span class="o">&amp;</span> <span class="n">TX4939_PCFG_SIO2MODE_SIO2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pe2</span> <span class="o">|=</span> <span class="n">RBTX4939_PE2_SIO2</span><span class="p">;</span>
				<span class="n">pe2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RBTX4939_PE2_SIO0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">pe2</span> <span class="o">|=</span> <span class="n">RBTX4939_PE2_SIO0</span><span class="p">;</span>
				<span class="n">pe2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RBTX4939_PE2_SIO2</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pcfg</span> <span class="o">&amp;</span> <span class="n">TX4939_PCFG_SIO3MODE</span><span class="p">)</span>
			<span class="n">pe2</span> <span class="o">|=</span> <span class="n">RBTX4939_PE2_SIO3</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pe2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RBTX4939_PE2_SIO3</span><span class="p">;</span>
		<span class="n">pe2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RBTX4939_PE2_SPI</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pe2</span> <span class="o">|=</span> <span class="n">RBTX4939_PE2_SPI</span><span class="p">;</span>
		<span class="n">pe2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RBTX4939_PE2_SIO3</span> <span class="o">|</span> <span class="n">RBTX4939_PE2_SIO2</span> <span class="o">|</span>
			 <span class="n">RBTX4939_PE2_SIO0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pcfg</span> <span class="o">&amp;</span> <span class="n">TX4939_PCFG_I2SMODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">TX4939_PCFG_I2SMODE_GPIO</span><span class="p">)</span>
		<span class="n">pe2</span> <span class="o">|=</span> <span class="n">RBTX4939_PE2_GPIO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pe2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RBTX4939_PE2_GPIO</span><span class="p">;</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">pe1</span><span class="p">,</span> <span class="n">rbtx4939_pe1_addr</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">pe2</span><span class="p">,</span> <span class="n">rbtx4939_pe2_addr</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">pe3</span><span class="p">,</span> <span class="n">rbtx4939_pe3_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define RBTX4939_MAX_7SEGLEDS	8</span>

<span class="cp">#if defined(CONFIG_LEDS_CLASS) || defined(CONFIG_LEDS_CLASS_MODULE)</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">led_val</span><span class="p">[</span><span class="n">RBTX4939_MAX_7SEGLEDS</span><span class="p">];</span>
<span class="k">struct</span> <span class="n">rbtx4939_led_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">led_classdev</span> <span class="n">cdev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Use &quot;dot&quot; in 7seg LEDs */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rbtx4939_led_brightness_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">led_cdev</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">led_brightness</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rbtx4939_led_data</span> <span class="o">*</span><span class="n">led_dat</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">led_cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rbtx4939_led_data</span><span class="p">,</span> <span class="n">cdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">led_dat</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">led_val</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">led_val</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">value</span> <span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">led_val</span><span class="p">[</span><span class="n">num</span><span class="p">],</span> <span class="n">rbtx4939_7seg_addr</span><span class="p">(</span><span class="n">num</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">num</span> <span class="o">%</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">rbtx4939_led_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rbtx4939_led_data</span> <span class="o">*</span><span class="n">leds_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">default_triggers</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;heartbeat&quot;</span><span class="p">,</span>
		<span class="s">&quot;ide-disk&quot;</span><span class="p">,</span>
		<span class="s">&quot;nand-disk&quot;</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">leds_data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">leds_data</span><span class="p">)</span> <span class="o">*</span> <span class="n">RBTX4939_MAX_7SEGLEDS</span><span class="p">,</span>
			    <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">leds_data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RBTX4939_MAX_7SEGLEDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rbtx4939_led_data</span> <span class="o">*</span><span class="n">led_dat</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">leds_data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">led_dat</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">led_dat</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">.</span><span class="n">brightness_set</span> <span class="o">=</span> <span class="n">rbtx4939_led_brightness_set</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">led_dat</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;rbtx4939:amber:%u&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">led_dat</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">led_dat</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">default_triggers</span><span class="p">))</span>
			<span class="n">led_dat</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">.</span><span class="n">default_trigger</span> <span class="o">=</span> <span class="n">default_triggers</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">led_classdev_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">led_dat</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="n">led_dat</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">.</span><span class="n">brightness_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led_dat</span><span class="o">-&gt;</span><span class="n">cdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">rbtx4939_led_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span>  <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;rbtx4939-led&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">rbtx4939_led_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_device_register_simple</span><span class="p">(</span><span class="s">&quot;rbtx4939-led&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">platform_driver_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbtx4939_led_driver</span><span class="p">,</span> <span class="n">rbtx4939_led_probe</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">rbtx4939_led_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__rbtx4939_7segled_putc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_LEDS_CLASS) || defined(CONFIG_LEDS_CLASS_MODULE)</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* bit7: reserved for LED class */</span>
	<span class="n">led_val</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">led_val</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">led_val</span><span class="p">[</span><span class="n">pos</span><span class="p">];</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">rbtx4939_7seg_addr</span><span class="p">(</span><span class="n">pos</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">pos</span> <span class="o">%</span> <span class="mi">4</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rbtx4939_7segled_putc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* convert from map_to_seg7() notation */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x88</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">__rbtx4939_7segled_putc</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_MTD_RBTX4939) || defined(CONFIG_MTD_RBTX4939_MODULE)</span>
<span class="cm">/* special mapping for boot rom */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">rbtx4939_flash_fixup_ofs</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ofs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">bdipsw</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">rbtx4939_bdipsw_addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">shift</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bdipsw</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* BOOT Mode: USER ROM1 / USER ROM2 */</span>
		<span class="n">shift</span> <span class="o">=</span> <span class="n">bdipsw</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="cm">/* rotate A[23:22] */</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ofs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xc00000</span><span class="p">)</span> <span class="o">|</span> <span class="p">((((</span><span class="n">ofs</span> <span class="o">&gt;&gt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">+</span> <span class="n">shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#ifdef __BIG_ENDIAN</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bdipsw</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/* BOOT Mode: Monitor ROM */</span>
		<span class="n">ofs</span> <span class="o">^=</span> <span class="mh">0x400000</span><span class="p">;</span>	<span class="cm">/* swap A[22] */</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">ofs</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">map_word</span> <span class="nf">rbtx4939_flash_read16</span><span class="p">(</span><span class="k">struct</span> <span class="n">map_info</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ofs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">map_word</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">ofs</span> <span class="o">=</span> <span class="n">rbtx4939_flash_fixup_ofs</span><span class="p">(</span><span class="n">ofs</span><span class="p">);</span>
	<span class="n">r</span><span class="p">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">__raw_readw</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">virt</span> <span class="o">+</span> <span class="n">ofs</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rbtx4939_flash_write16</span><span class="p">(</span><span class="k">struct</span> <span class="n">map_info</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="k">const</span> <span class="n">map_word</span> <span class="n">datum</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ofs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ofs</span> <span class="o">=</span> <span class="n">rbtx4939_flash_fixup_ofs</span><span class="p">(</span><span class="n">ofs</span><span class="p">);</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="n">datum</span><span class="p">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">virt</span> <span class="o">+</span> <span class="n">ofs</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>	<span class="cm">/* see inline_map_write() in mtd/map.h */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rbtx4939_flash_copy_from</span><span class="p">(</span><span class="k">struct</span> <span class="n">map_info</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">to</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">from</span><span class="p">,</span> <span class="kt">ssize_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">bdipsw</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">rbtx4939_bdipsw_addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">shift</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">curlen</span><span class="p">;</span>

	<span class="n">from</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">virt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bdipsw</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* BOOT Mode: USER ROM1 / USER ROM2 */</span>
		<span class="n">shift</span> <span class="o">=</span> <span class="n">bdipsw</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">curlen</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
				     <span class="mh">0x400000</span> <span class="o">-</span>	<span class="p">(</span><span class="n">from</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x400000</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)));</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">to</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)((</span><span class="n">from</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xc00000</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((((</span><span class="n">from</span> <span class="o">&gt;&gt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">+</span> <span class="n">shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)),</span>
			       <span class="n">curlen</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">-=</span> <span class="n">curlen</span><span class="p">;</span>
			<span class="n">from</span> <span class="o">+=</span> <span class="n">curlen</span><span class="p">;</span>
			<span class="n">to</span> <span class="o">+=</span> <span class="n">curlen</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef __BIG_ENDIAN</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bdipsw</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* BOOT Mode: Monitor ROM */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">curlen</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
				     <span class="mh">0x400000</span> <span class="o">-</span> <span class="p">(</span><span class="n">from</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x400000</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)));</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">from</span> <span class="o">^</span> <span class="mh">0x400000</span><span class="p">),</span> <span class="n">curlen</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">-=</span> <span class="n">curlen</span><span class="p">;</span>
			<span class="n">from</span> <span class="o">+=</span> <span class="n">curlen</span><span class="p">;</span>
			<span class="n">to</span> <span class="o">+=</span> <span class="n">curlen</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">from</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rbtx4939_flash_map_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">map_info</span> <span class="o">*</span><span class="n">map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">rbtx4939_flash_read16</span><span class="p">;</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="n">rbtx4939_flash_write16</span><span class="p">;</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">copy_from</span> <span class="o">=</span> <span class="n">rbtx4939_flash_copy_from</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">rbtx4939_mtd_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">platform_device</span> <span class="n">dev</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">resource</span> <span class="n">res</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rbtx4939_flash_data</span> <span class="n">data</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">pdevs</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">names</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">8</span><span class="p">];</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">mtd_partition</span> <span class="n">parts</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">rbtx4939_flash_data</span> <span class="o">*</span><span class="n">boot_pdata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdevs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bdipsw</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">rbtx4939_bdipsw_addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bdipsw</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* BOOT Mode: USER ROM1 / USER ROM2 */</span>
		<span class="n">boot_pdata</span><span class="o">-&gt;</span><span class="n">nr_parts</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">boot_pdata</span><span class="o">-&gt;</span><span class="n">nr_parts</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">&quot;img%d&quot;</span><span class="p">,</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="mh">0x400000</span><span class="p">;</span>
			<span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">MTDPART_OFS_NXTBLK</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bdipsw</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* BOOT Mode: Monitor ROM */</span>
		<span class="n">boot_pdata</span><span class="o">-&gt;</span><span class="n">nr_parts</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;big&quot;</span><span class="p">);</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;little&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">boot_pdata</span><span class="o">-&gt;</span><span class="n">nr_parts</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="mh">0x400000</span><span class="p">;</span>
			<span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">MTDPART_OFS_NXTBLK</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* BOOT Mode: ROM Emulator */</span>
		<span class="n">boot_pdata</span><span class="o">-&gt;</span><span class="n">nr_parts</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;boot&quot;</span><span class="p">;</span>
		<span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="mh">0xc00000</span><span class="p">;</span>
		<span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="mh">0x400000</span><span class="p">;</span>
		<span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;user&quot;</span><span class="p">;</span>
		<span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="mh">0xc00000</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">boot_pdata</span><span class="o">-&gt;</span><span class="n">parts</span> <span class="o">=</span> <span class="n">parts</span><span class="p">;</span>
	<span class="n">boot_pdata</span><span class="o">-&gt;</span><span class="n">map_init</span> <span class="o">=</span> <span class="n">rbtx4939_flash_map_init</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pdevs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdevs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">res</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdevs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="p">;</span>

		<span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0x1f000000</span> <span class="o">-</span> <span class="n">i</span> <span class="o">*</span> <span class="mh">0x1000000</span><span class="p">;</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="mh">0x1000000</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">;</span>
		<span class="n">pdevs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_resources</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;rbtx4939-flash&quot;</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdevs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">;</span>
		<span class="n">platform_device_register</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">rbtx4939_mtd_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">rbtx4939_arch_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rbtx4939_pci_setup</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">rbtx4939_device_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">smc_addr</span> <span class="o">=</span> <span class="n">RBTX4939_ETHER_ADDR</span> <span class="o">-</span> <span class="n">IO_BASE</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">smc_res</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">smc_addr</span><span class="p">,</span>
			<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">smc_addr</span> <span class="o">+</span> <span class="mh">0x10</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
		<span class="p">},</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">RBTX4939_IRQ_ETHER</span><span class="p">,</span>
			<span class="cm">/* override default irq flag defined in smc91x.h */</span>
			<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span> <span class="o">|</span> <span class="n">IRQF_TRIGGER_LOW</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">smc91x_platdata</span> <span class="n">smc_pdata</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SMC91X_USE_16BIT</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
<span class="cp">#if defined(CONFIG_TC35815) || defined(CONFIG_TC35815_MODULE)</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ethaddr</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">bdipsw</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">rbtx4939_bdipsw_addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">area</span> <span class="o">=</span> <span class="n">CKSEG1</span> <span class="o">+</span> <span class="mh">0x1fff0000</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mh">0x10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bdipsw</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">ethaddr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">area</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bdipsw</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span>
				<span class="n">area</span> <span class="o">-=</span> <span class="mh">0x03000000</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">area</span> <span class="o">-=</span> <span class="mh">0x01000000</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">le16_to_cpup</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">area</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">2</span><span class="p">));</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">ethaddr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">tx4939_ethaddr_init</span><span class="p">(</span><span class="n">ethaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ethaddr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="cp">#endif</span>
	<span class="n">pdev</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="s">&quot;smc91x&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span> <span class="o">||</span>
	    <span class="n">platform_device_add_resources</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">smc_res</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">smc_res</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">platform_device_add_data</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smc_pdata</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">smc_pdata</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">platform_device_add</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span>
		<span class="n">platform_device_put</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">rbtx4939_mtd_init</span><span class="p">();</span>
	<span class="cm">/* TC58DVM82A1FT: tDH=10ns, tWP=tRP=tREADID=35ns */</span>
	<span class="n">tx4939_ndfmc_init</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span>
			  <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
			  <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span> <span class="cm">/* ch1:8bit, ch2:16bit */</span>
	<span class="n">rbtx4939_led_setup</span><span class="p">();</span>
	<span class="n">tx4939_wdt_init</span><span class="p">();</span>
	<span class="n">tx4939_ata_init</span><span class="p">();</span>
	<span class="n">tx4939_rtc_init</span><span class="p">();</span>
	<span class="n">tx4939_dmac_init</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">tx4939_aclc_init</span><span class="p">();</span>
	<span class="n">platform_device_register_simple</span><span class="p">(</span><span class="s">&quot;txx9aclc-generic&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">tx4939_sramc_init</span><span class="p">();</span>
	<span class="n">tx4939_rng_init</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">rbtx4939_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">rbtx4939_ebusc_setup</span><span class="p">();</span>
	<span class="cm">/* always enable ATA0 */</span>
	<span class="n">txx9_set64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx4939_ccfgptr</span><span class="o">-&gt;</span><span class="n">pcfg</span><span class="p">,</span> <span class="n">TX4939_PCFG_ATA0MODE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txx9_master_clock</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">txx9_master_clock</span> <span class="o">=</span> <span class="mi">20000000</span><span class="p">;</span>
	<span class="n">tx4939_setup</span><span class="p">();</span>
	<span class="n">rbtx4939_update_ioc_pen</span><span class="p">();</span>
<span class="cp">#ifdef HAVE_RBTX4939_IOSWAB</span>
	<span class="n">ioswabw</span> <span class="o">=</span> <span class="n">rbtx4939_ioswabw</span><span class="p">;</span>
	<span class="n">__mem_ioswabw</span> <span class="o">=</span> <span class="n">rbtx4939_mem_ioswabw</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">_machine_restart</span> <span class="o">=</span> <span class="n">rbtx4939_machine_restart</span><span class="p">;</span>

	<span class="n">txx9_7segled_init</span><span class="p">(</span><span class="n">RBTX4939_MAX_7SEGLEDS</span><span class="p">,</span> <span class="n">rbtx4939_7segled_putc</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RBTX4939_MAX_7SEGLEDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">txx9_7segled_putc</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="sc">&#39;-&#39;</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;RBTX4939 (Rev %02x) --- FPGA(Rev %02x) DIPSW:%02x,%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">readb</span><span class="p">(</span><span class="n">rbtx4939_board_rev_addr</span><span class="p">),</span> <span class="n">readb</span><span class="p">(</span><span class="n">rbtx4939_ioc_rev_addr</span><span class="p">),</span>
		<span class="n">readb</span><span class="p">(</span><span class="n">rbtx4939_udipsw_addr</span><span class="p">),</span> <span class="n">readb</span><span class="p">(</span><span class="n">rbtx4939_bdipsw_addr</span><span class="p">));</span>

<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="n">txx9_alloc_pci_controller</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txx9_primary_pcic</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">txx9_board_pcibios_setup</span> <span class="o">=</span> <span class="n">tx4927_pcibios_setup</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">set_io_port_base</span><span class="p">(</span><span class="n">RBTX4939_ETHER_BASE</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">tx4939_sio_init</span><span class="p">(</span><span class="n">TX4939_SCLK0</span><span class="p">(</span><span class="n">txx9_master_clock</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">txx9_board_vec</span> <span class="n">rbtx4939_vec</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">system</span> <span class="o">=</span> <span class="s">&quot;Toshiba RBTX4939&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prom_init</span> <span class="o">=</span> <span class="n">rbtx4939_prom_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mem_setup</span> <span class="o">=</span> <span class="n">rbtx4939_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_setup</span> <span class="o">=</span> <span class="n">rbtx4939_irq_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">time_init</span> <span class="o">=</span> <span class="n">rbtx4939_time_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">device_init</span> <span class="o">=</span> <span class="n">rbtx4939_device_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">arch_init</span> <span class="o">=</span> <span class="n">rbtx4939_arch_init</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="p">.</span><span class="n">pci_map_irq</span> <span class="o">=</span> <span class="n">tx4939_pci_map_irq</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
