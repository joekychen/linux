<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › mips › include › asm › cmpxchg.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>cmpxchg.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License.  See the file &quot;COPYING&quot; in the main directory of this archive</span>
<span class="cm"> * for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2003, 06, 07 by Ralf Baechle (ralf@linux-mips.org)</span>
<span class="cm"> */</span>
<span class="cp">#ifndef __ASM_CMPXCHG_H</span>
<span class="cp">#define __ASM_CMPXCHG_H</span>

<span class="cp">#include &lt;linux/irqflags.h&gt;</span>
<span class="cp">#include &lt;asm/war.h&gt;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">__xchg_u32</span><span class="p">(</span><span class="k">volatile</span> <span class="kt">int</span> <span class="o">*</span> <span class="n">m</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u32</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">smp_mb__before_llsc</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kernel_uses_llsc</span> <span class="o">&amp;&amp;</span> <span class="n">R10000_LLSC_WAR</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dummy</span><span class="p">;</span>

		<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span>
		<span class="s">&quot;	.set	mips3					</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;1:	ll	%0, %3			# xchg_u32	</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.set	mips0					</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	move	%2, %z4					</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.set	mips3					</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	sc	%2, %1					</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	beqzl	%2, 1b					</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.set	mips0					</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="o">:</span> <span class="s">&quot;=&amp;r&quot;</span> <span class="p">(</span><span class="n">retval</span><span class="p">),</span> <span class="s">&quot;=m&quot;</span> <span class="p">(</span><span class="o">*</span><span class="n">m</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span> <span class="p">(</span><span class="n">dummy</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;R&quot;</span> <span class="p">(</span><span class="o">*</span><span class="n">m</span><span class="p">),</span> <span class="s">&quot;Jr&quot;</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;memory&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">kernel_uses_llsc</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dummy</span><span class="p">;</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span>
			<span class="s">&quot;	.set	mips3				</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;	ll	%0, %3		# xchg_u32	</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;	.set	mips0				</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;	move	%2, %z4				</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;	.set	mips3				</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;	sc	%2, %1				</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;	.set	mips0				</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="o">:</span> <span class="s">&quot;=&amp;r&quot;</span> <span class="p">(</span><span class="n">retval</span><span class="p">),</span> <span class="s">&quot;=m&quot;</span> <span class="p">(</span><span class="o">*</span><span class="n">m</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span> <span class="p">(</span><span class="n">dummy</span><span class="p">)</span>
			<span class="o">:</span> <span class="s">&quot;R&quot;</span> <span class="p">(</span><span class="o">*</span><span class="n">m</span><span class="p">),</span> <span class="s">&quot;Jr&quot;</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
			<span class="o">:</span> <span class="s">&quot;memory&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">dummy</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

		<span class="n">raw_local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
		<span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">raw_local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>	<span class="cm">/* implies memory barrier  */</span>
	<span class="p">}</span>

	<span class="n">smp_llsc_mb</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_64BIT</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">__u64</span> <span class="nf">__xchg_u64</span><span class="p">(</span><span class="k">volatile</span> <span class="n">__u64</span> <span class="o">*</span> <span class="n">m</span><span class="p">,</span> <span class="n">__u64</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u64</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">smp_mb__before_llsc</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kernel_uses_llsc</span> <span class="o">&amp;&amp;</span> <span class="n">R10000_LLSC_WAR</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dummy</span><span class="p">;</span>

		<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span>
		<span class="s">&quot;	.set	mips3					</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;1:	lld	%0, %3			# xchg_u64	</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	move	%2, %z4					</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	scd	%2, %1					</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	beqzl	%2, 1b					</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.set	mips0					</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="o">:</span> <span class="s">&quot;=&amp;r&quot;</span> <span class="p">(</span><span class="n">retval</span><span class="p">),</span> <span class="s">&quot;=m&quot;</span> <span class="p">(</span><span class="o">*</span><span class="n">m</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span> <span class="p">(</span><span class="n">dummy</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;R&quot;</span> <span class="p">(</span><span class="o">*</span><span class="n">m</span><span class="p">),</span> <span class="s">&quot;Jr&quot;</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;memory&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">kernel_uses_llsc</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dummy</span><span class="p">;</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span>
			<span class="s">&quot;	.set	mips3				</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;	lld	%0, %3		# xchg_u64	</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;	move	%2, %z4				</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;	scd	%2, %1				</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;	.set	mips0				</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="o">:</span> <span class="s">&quot;=&amp;r&quot;</span> <span class="p">(</span><span class="n">retval</span><span class="p">),</span> <span class="s">&quot;=m&quot;</span> <span class="p">(</span><span class="o">*</span><span class="n">m</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span> <span class="p">(</span><span class="n">dummy</span><span class="p">)</span>
			<span class="o">:</span> <span class="s">&quot;R&quot;</span> <span class="p">(</span><span class="o">*</span><span class="n">m</span><span class="p">),</span> <span class="s">&quot;Jr&quot;</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
			<span class="o">:</span> <span class="s">&quot;memory&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">dummy</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

		<span class="n">raw_local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
		<span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">raw_local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>	<span class="cm">/* implies memory barrier  */</span>
	<span class="p">}</span>

	<span class="n">smp_llsc_mb</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">extern</span> <span class="n">__u64</span> <span class="n">__xchg_u64_unsupported_on_32bit_kernels</span><span class="p">(</span><span class="k">volatile</span> <span class="n">__u64</span> <span class="o">*</span> <span class="n">m</span><span class="p">,</span> <span class="n">__u64</span> <span class="n">val</span><span class="p">);</span>
<span class="cp">#define __xchg_u64 __xchg_u64_unsupported_on_32bit_kernels</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">__xchg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">x</span><span class="p">,</span> <span class="k">volatile</span> <span class="kt">void</span> <span class="o">*</span> <span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">return</span> <span class="n">__xchg_u32</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="k">return</span> <span class="n">__xchg_u64</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">x</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define xchg(ptr, x)							\</span>
<span class="cp">({									\</span>
<span class="cp">	BUILD_BUG_ON(sizeof(*(ptr)) &amp; ~0xc);				\</span>
<span class="cp">									\</span>
<span class="cp">	((__typeof__(*(ptr)))						\</span>
<span class="cp">		__xchg((unsigned long)(x), (ptr), sizeof(*(ptr))));	\</span>
<span class="cp">})</span>

<span class="cp">#define __HAVE_ARCH_CMPXCHG 1</span>

<span class="cp">#define __cmpxchg_asm(ld, st, m, old, new)				\</span>
<span class="cp">({									\</span>
<span class="cp">	__typeof(*(m)) __ret;						\</span>
<span class="cp">									\</span>
<span class="cp">	if (kernel_uses_llsc &amp;&amp; R10000_LLSC_WAR) {			\</span>
<span class="cp">		__asm__ __volatile__(					\</span>
<span class="cp">		&quot;	.set	push				\n&quot;	\</span>
<span class="cp">		&quot;	.set	noat				\n&quot;	\</span>
<span class="cp">		&quot;	.set	mips3				\n&quot;	\</span>
<span class="cp">		&quot;1:	&quot; ld &quot;	%0, %2		# __cmpxchg_asm	\n&quot;	\</span>
<span class="cp">		&quot;	bne	%0, %z3, 2f			\n&quot;	\</span>
<span class="cp">		&quot;	.set	mips0				\n&quot;	\</span>
<span class="cp">		&quot;	move	$1, %z4				\n&quot;	\</span>
<span class="cp">		&quot;	.set	mips3				\n&quot;	\</span>
<span class="cp">		&quot;	&quot; st &quot;	$1, %1				\n&quot;	\</span>
<span class="cp">		&quot;	beqzl	$1, 1b				\n&quot;	\</span>
<span class="cp">		&quot;2:						\n&quot;	\</span>
<span class="cp">		&quot;	.set	pop				\n&quot;	\</span>
<span class="cp">		: &quot;=&amp;r&quot; (__ret), &quot;=R&quot; (*m)				\</span>
<span class="cp">		: &quot;R&quot; (*m), &quot;Jr&quot; (old), &quot;Jr&quot; (new)			\</span>
<span class="cp">		: &quot;memory&quot;);						\</span>
<span class="cp">	} else if (kernel_uses_llsc) {					\</span>
<span class="cp">		__asm__ __volatile__(					\</span>
<span class="cp">		&quot;	.set	push				\n&quot;	\</span>
<span class="cp">		&quot;	.set	noat				\n&quot;	\</span>
<span class="cp">		&quot;	.set	mips3				\n&quot;	\</span>
<span class="cp">		&quot;1:	&quot; ld &quot;	%0, %2		# __cmpxchg_asm	\n&quot;	\</span>
<span class="cp">		&quot;	bne	%0, %z3, 2f			\n&quot;	\</span>
<span class="cp">		&quot;	.set	mips0				\n&quot;	\</span>
<span class="cp">		&quot;	move	$1, %z4				\n&quot;	\</span>
<span class="cp">		&quot;	.set	mips3				\n&quot;	\</span>
<span class="cp">		&quot;	&quot; st &quot;	$1, %1				\n&quot;	\</span>
<span class="cp">		&quot;	beqz	$1, 1b				\n&quot;	\</span>
<span class="cp">		&quot;	.set	pop				\n&quot;	\</span>
<span class="cp">		&quot;2:						\n&quot;	\</span>
<span class="cp">		: &quot;=&amp;r&quot; (__ret), &quot;=R&quot; (*m)				\</span>
<span class="cp">		: &quot;R&quot; (*m), &quot;Jr&quot; (old), &quot;Jr&quot; (new)			\</span>
<span class="cp">		: &quot;memory&quot;);						\</span>
<span class="cp">	} else {							\</span>
<span class="cp">		unsigned long __flags;					\</span>
<span class="cp">									\</span>
<span class="cp">		raw_local_irq_save(__flags);				\</span>
<span class="cp">		__ret = *m;						\</span>
<span class="cp">		if (__ret == old)					\</span>
<span class="cp">			*m = new;					\</span>
<span class="cp">		raw_local_irq_restore(__flags);				\</span>
<span class="cp">	}								\</span>
<span class="cp">									\</span>
<span class="cp">	__ret;								\</span>
<span class="cp">})</span>

<span class="cm">/*</span>
<span class="cm"> * This function doesn&#39;t exist, so you&#39;ll get a linker error</span>
<span class="cm"> * if something tries to do an invalid cmpxchg().</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">__cmpxchg_called_with_bad_pointer</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cp">#define __cmpxchg(ptr, old, new, pre_barrier, post_barrier)		\</span>
<span class="cp">({									\</span>
<span class="cp">	__typeof__(ptr) __ptr = (ptr);					\</span>
<span class="cp">	__typeof__(*(ptr)) __old = (old);				\</span>
<span class="cp">	__typeof__(*(ptr)) __new = (new);				\</span>
<span class="cp">	__typeof__(*(ptr)) __res = 0;					\</span>
<span class="cp">									\</span>
<span class="cp">	pre_barrier;							\</span>
<span class="cp">									\</span>
<span class="cp">	switch (sizeof(*(__ptr))) {					\</span>
<span class="cp">	case 4:								\</span>
<span class="cp">		__res = __cmpxchg_asm(&quot;ll&quot;, &quot;sc&quot;, __ptr, __old, __new);	\</span>
<span class="cp">		break;							\</span>
<span class="cp">	case 8:								\</span>
<span class="cp">		if (sizeof(long) == 8) {				\</span>
<span class="cp">			__res = __cmpxchg_asm(&quot;lld&quot;, &quot;scd&quot;, __ptr,	\</span>
<span class="cp">					   __old, __new);		\</span>
<span class="cp">			break;						\</span>
<span class="cp">		}							\</span>
<span class="cp">	default:							\</span>
<span class="cp">		__cmpxchg_called_with_bad_pointer();			\</span>
<span class="cp">		break;							\</span>
<span class="cp">	}								\</span>
<span class="cp">									\</span>
<span class="cp">	post_barrier;							\</span>
<span class="cp">									\</span>
<span class="cp">	__res;								\</span>
<span class="cp">})</span>

<span class="cp">#define cmpxchg(ptr, old, new)		__cmpxchg(ptr, old, new, smp_mb__before_llsc(), smp_llsc_mb())</span>
<span class="cp">#define cmpxchg_local(ptr, old, new)	__cmpxchg(ptr, old, new, , )</span>

<span class="cp">#define cmpxchg64(ptr, o, n)						\</span>
<span class="cp">  ({									\</span>
<span class="cp">	BUILD_BUG_ON(sizeof(*(ptr)) != 8);				\</span>
<span class="cp">	cmpxchg((ptr), (o), (n));					\</span>
<span class="cp">  })</span>

<span class="cp">#ifdef CONFIG_64BIT</span>
<span class="cp">#define cmpxchg64_local(ptr, o, n)					\</span>
<span class="cp">  ({									\</span>
<span class="cp">	BUILD_BUG_ON(sizeof(*(ptr)) != 8);				\</span>
<span class="cp">	cmpxchg_local((ptr), (o), (n));					\</span>
<span class="cp">  })</span>
<span class="cp">#else</span>
<span class="cp">#include &lt;asm-generic/cmpxchg-local.h&gt;</span>
<span class="cp">#define cmpxchg64_local(ptr, o, n) __cmpxchg64_local_generic((ptr), (o), (n))</span>
<span class="cp">#endif</span>

<span class="cp">#endif </span><span class="cm">/* __ASM_CMPXCHG_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
