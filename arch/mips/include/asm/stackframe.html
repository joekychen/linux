<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › mips › include › asm › stackframe.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>stackframe.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License.  See the file &quot;COPYING&quot; in the main directory of this archive</span>
<span class="cm"> * for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1994, 95, 96, 99, 2001 Ralf Baechle</span>
<span class="cm"> * Copyright (C) 1994, 1995, 1996 Paul M. Antoine.</span>
<span class="cm"> * Copyright (C) 1999 Silicon Graphics, Inc.</span>
<span class="cm"> * Copyright (C) 2007  Maciej W. Rozycki</span>
<span class="cm"> */</span>
<span class="cp">#ifndef _ASM_STACKFRAME_H</span>
<span class="cp">#define _ASM_STACKFRAME_H</span>

<span class="cp">#include &lt;linux/threads.h&gt;</span>

<span class="cp">#include &lt;asm/asm.h&gt;</span>
<span class="cp">#include &lt;asm/asmmacro.h&gt;</span>
<span class="cp">#include &lt;asm/mipsregs.h&gt;</span>
<span class="cp">#include &lt;asm/asm-offsets.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * For SMTC kernel, global IE should be left set, and interrupts</span>
<span class="cm"> * controlled exclusively via IXMT.</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_MIPS_MT_SMTC</span>
<span class="cp">#define STATMASK 0x1e</span>
<span class="cp">#elif defined(CONFIG_CPU_R3000) || defined(CONFIG_CPU_TX39XX)</span>
<span class="cp">#define STATMASK 0x3f</span>
<span class="cp">#else</span>
<span class="cp">#define STATMASK 0x1f</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_MIPS_MT_SMTC</span>
<span class="cp">#include &lt;asm/mipsmtregs.h&gt;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MIPS_MT_SMTC */</span><span class="cp"></span>

		<span class="p">.</span><span class="n">macro</span>	<span class="n">SAVE_AT</span>
		<span class="p">.</span><span class="n">set</span>	<span class="n">push</span>
		<span class="p">.</span><span class="n">set</span>	<span class="n">noat</span>
		<span class="n">LONG_S</span>	<span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="n">PT_R1</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="p">.</span><span class="n">set</span>	<span class="n">pop</span>
		<span class="p">.</span><span class="n">endm</span>

		<span class="p">.</span><span class="n">macro</span>	<span class="n">SAVE_TEMP</span>
<span class="cp">#ifdef CONFIG_CPU_HAS_SMARTMIPS</span>
		<span class="n">mflhxu</span>	<span class="n">v1</span>
		<span class="n">LONG_S</span>	<span class="n">v1</span><span class="p">,</span> <span class="n">PT_LO</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">mflhxu</span>	<span class="n">v1</span>
		<span class="n">LONG_S</span>	<span class="n">v1</span><span class="p">,</span> <span class="n">PT_HI</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">mflhxu</span>	<span class="n">v1</span>
		<span class="n">LONG_S</span>	<span class="n">v1</span><span class="p">,</span> <span class="n">PT_ACX</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="cp">#else</span>
		<span class="n">mfhi</span>	<span class="n">v1</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_32BIT</span>
		<span class="n">LONG_S</span>	<span class="err">$</span><span class="mi">8</span><span class="p">,</span> <span class="n">PT_R8</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_S</span>	<span class="err">$</span><span class="mi">9</span><span class="p">,</span> <span class="n">PT_R9</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="cp">#endif</span>
		<span class="n">LONG_S</span>	<span class="err">$</span><span class="mi">10</span><span class="p">,</span> <span class="n">PT_R10</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_S</span>	<span class="err">$</span><span class="mi">11</span><span class="p">,</span> <span class="n">PT_R11</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_S</span>	<span class="err">$</span><span class="mi">12</span><span class="p">,</span> <span class="n">PT_R12</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="cp">#ifndef CONFIG_CPU_HAS_SMARTMIPS</span>
		<span class="n">LONG_S</span>	<span class="n">v1</span><span class="p">,</span> <span class="n">PT_HI</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">mflo</span>	<span class="n">v1</span>
<span class="cp">#endif</span>
		<span class="n">LONG_S</span>	<span class="err">$</span><span class="mi">13</span><span class="p">,</span> <span class="n">PT_R13</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_S</span>	<span class="err">$</span><span class="mi">14</span><span class="p">,</span> <span class="n">PT_R14</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_S</span>	<span class="err">$</span><span class="mi">15</span><span class="p">,</span> <span class="n">PT_R15</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_S</span>	<span class="err">$</span><span class="mi">24</span><span class="p">,</span> <span class="n">PT_R24</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="cp">#ifndef CONFIG_CPU_HAS_SMARTMIPS</span>
		<span class="n">LONG_S</span>	<span class="n">v1</span><span class="p">,</span> <span class="n">PT_LO</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="cp">#endif</span>
		<span class="p">.</span><span class="n">endm</span>

		<span class="p">.</span><span class="n">macro</span>	<span class="n">SAVE_STATIC</span>
		<span class="n">LONG_S</span>	<span class="err">$</span><span class="mi">16</span><span class="p">,</span> <span class="n">PT_R16</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_S</span>	<span class="err">$</span><span class="mi">17</span><span class="p">,</span> <span class="n">PT_R17</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_S</span>	<span class="err">$</span><span class="mi">18</span><span class="p">,</span> <span class="n">PT_R18</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_S</span>	<span class="err">$</span><span class="mi">19</span><span class="p">,</span> <span class="n">PT_R19</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_S</span>	<span class="err">$</span><span class="mi">20</span><span class="p">,</span> <span class="n">PT_R20</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_S</span>	<span class="err">$</span><span class="mi">21</span><span class="p">,</span> <span class="n">PT_R21</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_S</span>	<span class="err">$</span><span class="mi">22</span><span class="p">,</span> <span class="n">PT_R22</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_S</span>	<span class="err">$</span><span class="mi">23</span><span class="p">,</span> <span class="n">PT_R23</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_S</span>	<span class="err">$</span><span class="mi">30</span><span class="p">,</span> <span class="n">PT_R30</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="p">.</span><span class="n">endm</span>

<span class="cp">#ifdef CONFIG_SMP</span>
<span class="cp">#ifdef CONFIG_MIPS_MT_SMTC</span>
<span class="cp">#define PTEBASE_SHIFT	19	</span><span class="cm">/* TCBIND */</span><span class="cp"></span>
<span class="cp">#define CPU_ID_REG CP0_TCBIND</span>
<span class="cp">#define CPU_ID_MFC0 mfc0</span>
<span class="cp">#elif defined(CONFIG_MIPS_PGD_C0_CONTEXT)</span>
<span class="cp">#define PTEBASE_SHIFT	48	</span><span class="cm">/* XCONTEXT */</span><span class="cp"></span>
<span class="cp">#define CPU_ID_REG CP0_XCONTEXT</span>
<span class="cp">#define CPU_ID_MFC0 MFC0</span>
<span class="cp">#else</span>
<span class="cp">#define PTEBASE_SHIFT	23	</span><span class="cm">/* CONTEXT */</span><span class="cp"></span>
<span class="cp">#define CPU_ID_REG CP0_CONTEXT</span>
<span class="cp">#define CPU_ID_MFC0 MFC0</span>
<span class="cp">#endif</span>
		<span class="p">.</span><span class="n">macro</span>	<span class="n">get_saved_sp</span>	<span class="cm">/* SMP variation */</span>
		<span class="n">CPU_ID_MFC0</span>	<span class="n">k0</span><span class="p">,</span> <span class="n">CPU_ID_REG</span>
<span class="cp">#if defined(CONFIG_32BIT) || defined(KBUILD_64BIT_SYM32)</span>
		<span class="n">lui</span>	<span class="n">k1</span><span class="p">,</span> <span class="o">%</span><span class="n">hi</span><span class="p">(</span><span class="n">kernelsp</span><span class="p">)</span>
<span class="cp">#else</span>
		<span class="n">lui</span>	<span class="n">k1</span><span class="p">,</span> <span class="o">%</span><span class="n">highest</span><span class="p">(</span><span class="n">kernelsp</span><span class="p">)</span>
		<span class="n">daddiu</span>	<span class="n">k1</span><span class="p">,</span> <span class="o">%</span><span class="n">higher</span><span class="p">(</span><span class="n">kernelsp</span><span class="p">)</span>
		<span class="n">dsll</span>	<span class="n">k1</span><span class="p">,</span> <span class="mi">16</span>
		<span class="n">daddiu</span>	<span class="n">k1</span><span class="p">,</span> <span class="o">%</span><span class="n">hi</span><span class="p">(</span><span class="n">kernelsp</span><span class="p">)</span>
		<span class="n">dsll</span>	<span class="n">k1</span><span class="p">,</span> <span class="mi">16</span>
<span class="cp">#endif</span>
		<span class="n">LONG_SRL</span>	<span class="n">k0</span><span class="p">,</span> <span class="n">PTEBASE_SHIFT</span>
		<span class="n">LONG_ADDU</span>	<span class="n">k1</span><span class="p">,</span> <span class="n">k0</span>
		<span class="n">LONG_L</span>	<span class="n">k1</span><span class="p">,</span> <span class="o">%</span><span class="n">lo</span><span class="p">(</span><span class="n">kernelsp</span><span class="p">)(</span><span class="n">k1</span><span class="p">)</span>
		<span class="p">.</span><span class="n">endm</span>

		<span class="p">.</span><span class="n">macro</span>	<span class="n">set_saved_sp</span> <span class="n">stackp</span> <span class="n">temp</span> <span class="n">temp2</span>
		<span class="n">CPU_ID_MFC0</span>	<span class="err">\</span><span class="n">temp</span><span class="p">,</span> <span class="n">CPU_ID_REG</span>
		<span class="n">LONG_SRL</span>	<span class="err">\</span><span class="n">temp</span><span class="p">,</span> <span class="n">PTEBASE_SHIFT</span>
		<span class="n">LONG_S</span>	<span class="err">\</span><span class="n">stackp</span><span class="p">,</span> <span class="n">kernelsp</span><span class="p">(</span><span class="err">\</span><span class="n">temp</span><span class="p">)</span>
		<span class="p">.</span><span class="n">endm</span>
<span class="cp">#else</span>
		<span class="p">.</span><span class="n">macro</span>	<span class="n">get_saved_sp</span>	<span class="cm">/* Uniprocessor variation */</span>
<span class="cp">#ifdef CONFIG_CPU_JUMP_WORKAROUNDS</span>
		<span class="cm">/*</span>
<span class="cm">		 * Clear BTB (branch target buffer), forbid RAS (return address</span>
<span class="cm">		 * stack) to workaround the Out-of-order Issue in Loongson2F</span>
<span class="cm">		 * via its diagnostic register.</span>
<span class="cm">		 */</span>
		<span class="n">move</span>	<span class="n">k0</span><span class="p">,</span> <span class="n">ra</span>
		<span class="n">jal</span>	<span class="mf">1f</span>
		 <span class="n">nop</span>
<span class="mi">1</span><span class="o">:</span>		<span class="n">jal</span>	<span class="mf">1f</span>
		 <span class="n">nop</span>
<span class="mi">1</span><span class="o">:</span>		<span class="n">jal</span>	<span class="mf">1f</span>
		 <span class="n">nop</span>
<span class="mi">1</span><span class="o">:</span>		<span class="n">jal</span>	<span class="mf">1f</span>
		 <span class="n">nop</span>
<span class="mi">1</span><span class="o">:</span>		<span class="n">move</span>	<span class="n">ra</span><span class="p">,</span> <span class="n">k0</span>
		<span class="n">li</span>	<span class="n">k0</span><span class="p">,</span> <span class="mi">3</span>
		<span class="n">mtc0</span>	<span class="n">k0</span><span class="p">,</span> <span class="err">$</span><span class="mi">22</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_CPU_LOONGSON2F */</span><span class="cp"></span>
<span class="cp">#if defined(CONFIG_32BIT) || defined(KBUILD_64BIT_SYM32)</span>
		<span class="n">lui</span>	<span class="n">k1</span><span class="p">,</span> <span class="o">%</span><span class="n">hi</span><span class="p">(</span><span class="n">kernelsp</span><span class="p">)</span>
<span class="cp">#else</span>
		<span class="n">lui</span>	<span class="n">k1</span><span class="p">,</span> <span class="o">%</span><span class="n">highest</span><span class="p">(</span><span class="n">kernelsp</span><span class="p">)</span>
		<span class="n">daddiu</span>	<span class="n">k1</span><span class="p">,</span> <span class="o">%</span><span class="n">higher</span><span class="p">(</span><span class="n">kernelsp</span><span class="p">)</span>
		<span class="n">dsll</span>	<span class="n">k1</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="mi">16</span>
		<span class="n">daddiu</span>	<span class="n">k1</span><span class="p">,</span> <span class="o">%</span><span class="n">hi</span><span class="p">(</span><span class="n">kernelsp</span><span class="p">)</span>
		<span class="n">dsll</span>	<span class="n">k1</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="mi">16</span>
<span class="cp">#endif</span>
		<span class="n">LONG_L</span>	<span class="n">k1</span><span class="p">,</span> <span class="o">%</span><span class="n">lo</span><span class="p">(</span><span class="n">kernelsp</span><span class="p">)(</span><span class="n">k1</span><span class="p">)</span>
		<span class="p">.</span><span class="n">endm</span>

		<span class="p">.</span><span class="n">macro</span>	<span class="n">set_saved_sp</span> <span class="n">stackp</span> <span class="n">temp</span> <span class="n">temp2</span>
		<span class="n">LONG_S</span>	<span class="err">\</span><span class="n">stackp</span><span class="p">,</span> <span class="n">kernelsp</span>
		<span class="p">.</span><span class="n">endm</span>
<span class="cp">#endif</span>

		<span class="p">.</span><span class="n">macro</span>	<span class="n">SAVE_SOME</span>
		<span class="p">.</span><span class="n">set</span>	<span class="n">push</span>
		<span class="p">.</span><span class="n">set</span>	<span class="n">noat</span>
		<span class="p">.</span><span class="n">set</span>	<span class="n">reorder</span>
		<span class="n">mfc0</span>	<span class="n">k0</span><span class="p">,</span> <span class="n">CP0_STATUS</span>
		<span class="n">sll</span>	<span class="n">k0</span><span class="p">,</span> <span class="mi">3</span>		<span class="cm">/* extract cu0 bit */</span>
		<span class="p">.</span><span class="n">set</span>	<span class="n">noreorder</span>
		<span class="n">bltz</span>	<span class="n">k0</span><span class="p">,</span> <span class="mf">8f</span>
		 <span class="n">move</span>	<span class="n">k1</span><span class="p">,</span> <span class="n">sp</span>
		<span class="p">.</span><span class="n">set</span>	<span class="n">reorder</span>
		<span class="cm">/* Called from user mode, new stack. */</span>
		<span class="n">get_saved_sp</span>
<span class="cp">#ifndef CONFIG_CPU_DADDI_WORKAROUNDS</span>
<span class="mi">8</span><span class="o">:</span>		<span class="n">move</span>	<span class="n">k0</span><span class="p">,</span> <span class="n">sp</span>
		<span class="n">PTR_SUBU</span> <span class="n">sp</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">PT_SIZE</span>
<span class="cp">#else</span>
		<span class="p">.</span><span class="n">set</span>	<span class="n">at</span><span class="o">=</span><span class="n">k0</span>
<span class="mi">8</span><span class="o">:</span>		<span class="n">PTR_SUBU</span> <span class="n">k1</span><span class="p">,</span> <span class="n">PT_SIZE</span>
		<span class="p">.</span><span class="n">set</span>	<span class="n">noat</span>
		<span class="n">move</span>	<span class="n">k0</span><span class="p">,</span> <span class="n">sp</span>
		<span class="n">move</span>	<span class="n">sp</span><span class="p">,</span> <span class="n">k1</span>
<span class="cp">#endif</span>
		<span class="n">LONG_S</span>	<span class="n">k0</span><span class="p">,</span> <span class="n">PT_R29</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_S</span>	<span class="err">$</span><span class="mi">3</span><span class="p">,</span> <span class="n">PT_R3</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * You might think that you don&#39;t need to save $0,</span>
<span class="cm">		 * but the FPU emulator and gdb remote debug stub</span>
<span class="cm">		 * need it to operate correctly</span>
<span class="cm">		 */</span>
		<span class="n">LONG_S</span>	<span class="err">$</span><span class="mi">0</span><span class="p">,</span> <span class="n">PT_R0</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">mfc0</span>	<span class="n">v1</span><span class="p">,</span> <span class="n">CP0_STATUS</span>
		<span class="n">LONG_S</span>	<span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="n">PT_R2</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="cp">#ifdef CONFIG_MIPS_MT_SMTC</span>
		<span class="cm">/*</span>
<span class="cm">		 * Ideally, these instructions would be shuffled in</span>
<span class="cm">		 * to cover the pipeline delay.</span>
<span class="cm">		 */</span>
		<span class="p">.</span><span class="n">set</span>	<span class="n">mips32</span>
		<span class="n">mfc0</span>	<span class="n">k0</span><span class="p">,</span> <span class="n">CP0_TCSTATUS</span>
		<span class="p">.</span><span class="n">set</span>	<span class="n">mips0</span>
		<span class="n">LONG_S</span>	<span class="n">k0</span><span class="p">,</span> <span class="n">PT_TCSTATUS</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MIPS_MT_SMTC */</span><span class="cp"></span>
		<span class="n">LONG_S</span>	<span class="err">$</span><span class="mi">4</span><span class="p">,</span> <span class="n">PT_R4</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_S</span>	<span class="err">$</span><span class="mi">5</span><span class="p">,</span> <span class="n">PT_R5</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_S</span>	<span class="n">v1</span><span class="p">,</span> <span class="n">PT_STATUS</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">mfc0</span>	<span class="n">v1</span><span class="p">,</span> <span class="n">CP0_CAUSE</span>
		<span class="n">LONG_S</span>	<span class="err">$</span><span class="mi">6</span><span class="p">,</span> <span class="n">PT_R6</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_S</span>	<span class="err">$</span><span class="mi">7</span><span class="p">,</span> <span class="n">PT_R7</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_S</span>	<span class="n">v1</span><span class="p">,</span> <span class="n">PT_CAUSE</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">MFC0</span>	<span class="n">v1</span><span class="p">,</span> <span class="n">CP0_EPC</span>
<span class="cp">#ifdef CONFIG_64BIT</span>
		<span class="n">LONG_S</span>	<span class="err">$</span><span class="mi">8</span><span class="p">,</span> <span class="n">PT_R8</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_S</span>	<span class="err">$</span><span class="mi">9</span><span class="p">,</span> <span class="n">PT_R9</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="cp">#endif</span>
		<span class="n">LONG_S</span>	<span class="err">$</span><span class="mi">25</span><span class="p">,</span> <span class="n">PT_R25</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_S</span>	<span class="err">$</span><span class="mi">28</span><span class="p">,</span> <span class="n">PT_R28</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_S</span>	<span class="err">$</span><span class="mi">31</span><span class="p">,</span> <span class="n">PT_R31</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_S</span>	<span class="n">v1</span><span class="p">,</span> <span class="n">PT_EPC</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">ori</span>	<span class="err">$</span><span class="mi">28</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">_THREAD_MASK</span>
		<span class="n">xori</span>	<span class="err">$</span><span class="mi">28</span><span class="p">,</span> <span class="n">_THREAD_MASK</span>
<span class="cp">#ifdef CONFIG_CPU_CAVIUM_OCTEON</span>
		<span class="p">.</span><span class="n">set</span>    <span class="n">mips64</span>
		<span class="n">pref</span>    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="err">$</span><span class="mi">28</span><span class="p">)</span>       <span class="cm">/* Prefetch the current pointer */</span>
		<span class="n">pref</span>    <span class="mi">0</span><span class="p">,</span> <span class="n">PT_R31</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>   <span class="cm">/* Prefetch the $31(ra) */</span>
		<span class="cm">/* The Octeon multiplier state is affected by general multiply</span>
<span class="cm">		    instructions. It must be saved before and kernel code might</span>
<span class="cm">		    corrupt it */</span>
		<span class="n">jal</span>     <span class="n">octeon_mult_save</span>
		<span class="n">LONG_L</span>  <span class="n">v1</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="err">$</span><span class="mi">28</span><span class="p">)</span>  <span class="cm">/* Load the current pointer */</span>
			 <span class="cm">/* Restore $31(ra) that was changed by the jal */</span>
		<span class="n">LONG_L</span>  <span class="n">ra</span><span class="p">,</span> <span class="n">PT_R31</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">pref</span>    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>    <span class="cm">/* Prefetch the current thread */</span>
<span class="cp">#endif</span>
		<span class="p">.</span><span class="n">set</span>	<span class="n">pop</span>
		<span class="p">.</span><span class="n">endm</span>

		<span class="p">.</span><span class="n">macro</span>	<span class="n">SAVE_ALL</span>
		<span class="n">SAVE_SOME</span>
		<span class="n">SAVE_AT</span>
		<span class="n">SAVE_TEMP</span>
		<span class="n">SAVE_STATIC</span>
		<span class="p">.</span><span class="n">endm</span>

		<span class="p">.</span><span class="n">macro</span>	<span class="n">RESTORE_AT</span>
		<span class="p">.</span><span class="n">set</span>	<span class="n">push</span>
		<span class="p">.</span><span class="n">set</span>	<span class="n">noat</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">1</span><span class="p">,</span>  <span class="n">PT_R1</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="p">.</span><span class="n">set</span>	<span class="n">pop</span>
		<span class="p">.</span><span class="n">endm</span>

		<span class="p">.</span><span class="n">macro</span>	<span class="n">RESTORE_TEMP</span>
<span class="cp">#ifdef CONFIG_CPU_HAS_SMARTMIPS</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">24</span><span class="p">,</span> <span class="n">PT_ACX</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">mtlhx</span>	<span class="err">$</span><span class="mi">24</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">24</span><span class="p">,</span> <span class="n">PT_HI</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">mtlhx</span>	<span class="err">$</span><span class="mi">24</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">24</span><span class="p">,</span> <span class="n">PT_LO</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">mtlhx</span>	<span class="err">$</span><span class="mi">24</span>
<span class="cp">#else</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">24</span><span class="p">,</span> <span class="n">PT_LO</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">mtlo</span>	<span class="err">$</span><span class="mi">24</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">24</span><span class="p">,</span> <span class="n">PT_HI</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">mthi</span>	<span class="err">$</span><span class="mi">24</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_32BIT</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">8</span><span class="p">,</span> <span class="n">PT_R8</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">9</span><span class="p">,</span> <span class="n">PT_R9</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="cp">#endif</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">10</span><span class="p">,</span> <span class="n">PT_R10</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">11</span><span class="p">,</span> <span class="n">PT_R11</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">12</span><span class="p">,</span> <span class="n">PT_R12</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">13</span><span class="p">,</span> <span class="n">PT_R13</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">14</span><span class="p">,</span> <span class="n">PT_R14</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">15</span><span class="p">,</span> <span class="n">PT_R15</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">24</span><span class="p">,</span> <span class="n">PT_R24</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="p">.</span><span class="n">endm</span>

		<span class="p">.</span><span class="n">macro</span>	<span class="n">RESTORE_STATIC</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">16</span><span class="p">,</span> <span class="n">PT_R16</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">17</span><span class="p">,</span> <span class="n">PT_R17</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">18</span><span class="p">,</span> <span class="n">PT_R18</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">19</span><span class="p">,</span> <span class="n">PT_R19</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">20</span><span class="p">,</span> <span class="n">PT_R20</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">21</span><span class="p">,</span> <span class="n">PT_R21</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">22</span><span class="p">,</span> <span class="n">PT_R22</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">23</span><span class="p">,</span> <span class="n">PT_R23</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">30</span><span class="p">,</span> <span class="n">PT_R30</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="p">.</span><span class="n">endm</span>

<span class="cp">#if defined(CONFIG_CPU_R3000) || defined(CONFIG_CPU_TX39XX)</span>

		<span class="p">.</span><span class="n">macro</span>	<span class="n">RESTORE_SOME</span>
		<span class="p">.</span><span class="n">set</span>	<span class="n">push</span>
		<span class="p">.</span><span class="n">set</span>	<span class="n">reorder</span>
		<span class="p">.</span><span class="n">set</span>	<span class="n">noat</span>
		<span class="n">mfc0</span>	<span class="n">a0</span><span class="p">,</span> <span class="n">CP0_STATUS</span>
		<span class="n">li</span>	<span class="n">v1</span><span class="p">,</span> <span class="mh">0xff00</span>
		<span class="n">ori</span>	<span class="n">a0</span><span class="p">,</span> <span class="n">STATMASK</span>
		<span class="n">xori</span>	<span class="n">a0</span><span class="p">,</span> <span class="n">STATMASK</span>
		<span class="n">mtc0</span>	<span class="n">a0</span><span class="p">,</span> <span class="n">CP0_STATUS</span>
		<span class="n">and</span>	<span class="n">a0</span><span class="p">,</span> <span class="n">v1</span>
		<span class="n">LONG_L</span>	<span class="n">v0</span><span class="p">,</span> <span class="n">PT_STATUS</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">nor</span>	<span class="n">v1</span><span class="p">,</span> <span class="err">$</span><span class="mi">0</span><span class="p">,</span> <span class="n">v1</span>
		<span class="n">and</span>	<span class="n">v0</span><span class="p">,</span> <span class="n">v1</span>
		<span class="n">or</span>	<span class="n">v0</span><span class="p">,</span> <span class="n">a0</span>
		<span class="n">mtc0</span>	<span class="n">v0</span><span class="p">,</span> <span class="n">CP0_STATUS</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">31</span><span class="p">,</span> <span class="n">PT_R31</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">28</span><span class="p">,</span> <span class="n">PT_R28</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">25</span><span class="p">,</span> <span class="n">PT_R25</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">7</span><span class="p">,</span>  <span class="n">PT_R7</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">6</span><span class="p">,</span>  <span class="n">PT_R6</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">5</span><span class="p">,</span>  <span class="n">PT_R5</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">4</span><span class="p">,</span>  <span class="n">PT_R4</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">3</span><span class="p">,</span>  <span class="n">PT_R3</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">2</span><span class="p">,</span>  <span class="n">PT_R2</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="p">.</span><span class="n">set</span>	<span class="n">pop</span>
		<span class="p">.</span><span class="n">endm</span>

		<span class="p">.</span><span class="n">macro</span>	<span class="n">RESTORE_SP_AND_RET</span>
		<span class="p">.</span><span class="n">set</span>	<span class="n">push</span>
		<span class="p">.</span><span class="n">set</span>	<span class="n">noreorder</span>
		<span class="n">LONG_L</span>	<span class="n">k0</span><span class="p">,</span> <span class="n">PT_EPC</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_L</span>	<span class="n">sp</span><span class="p">,</span> <span class="n">PT_R29</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">jr</span>	<span class="n">k0</span>
		 <span class="n">rfe</span>
		<span class="p">.</span><span class="n">set</span>	<span class="n">pop</span>
		<span class="p">.</span><span class="n">endm</span>

<span class="cp">#else</span>
		<span class="p">.</span><span class="n">macro</span>	<span class="n">RESTORE_SOME</span>
		<span class="p">.</span><span class="n">set</span>	<span class="n">push</span>
		<span class="p">.</span><span class="n">set</span>	<span class="n">reorder</span>
		<span class="p">.</span><span class="n">set</span>	<span class="n">noat</span>
<span class="cp">#ifdef CONFIG_MIPS_MT_SMTC</span>
		<span class="p">.</span><span class="n">set</span>	<span class="n">mips32r2</span>
		<span class="cm">/*</span>
<span class="cm">		 * We need to make sure the read-modify-write</span>
<span class="cm">		 * of Status below isn&#39;t perturbed by an interrupt</span>
<span class="cm">		 * or cross-TC access, so we need to do at least a DMT,</span>
<span class="cm">		 * protected by an interrupt-inhibit. But setting IXMT</span>
<span class="cm">		 * also creates a few-cycle window where an IPI could</span>
<span class="cm">		 * be queued and not be detected before potentially</span>
<span class="cm">		 * returning to a WAIT or user-mode loop. It must be</span>
<span class="cm">		 * replayed.</span>
<span class="cm">		 *</span>
<span class="cm">		 * We&#39;re in the middle of a context switch, and</span>
<span class="cm">		 * we can&#39;t dispatch it directly without trashing</span>
<span class="cm">		 * some registers, so we&#39;ll try to detect this unlikely</span>
<span class="cm">		 * case and program a software interrupt in the VPE,</span>
<span class="cm">		 * as would be done for a cross-VPE IPI.  To accommodate</span>
<span class="cm">		 * the handling of that case, we&#39;re doing a DVPE instead</span>
<span class="cm">		 * of just a DMT here to protect against other threads.</span>
<span class="cm">		 * This is a lot of cruft to cover a tiny window.</span>
<span class="cm">		 * If you can find a better design, implement it!</span>
<span class="cm">		 *</span>
<span class="cm">		 */</span>
		<span class="n">mfc0</span>	<span class="n">v0</span><span class="p">,</span> <span class="n">CP0_TCSTATUS</span>
		<span class="n">ori</span>	<span class="n">v0</span><span class="p">,</span> <span class="n">TCSTATUS_IXMT</span>
		<span class="n">mtc0</span>	<span class="n">v0</span><span class="p">,</span> <span class="n">CP0_TCSTATUS</span>
		<span class="n">_ehb</span>
		<span class="n">DVPE</span>	<span class="mi">5</span>				<span class="err">#</span> <span class="n">dvpe</span> <span class="n">a1</span>
		<span class="n">jal</span>	<span class="n">mips_ihb</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MIPS_MT_SMTC */</span><span class="cp"></span>
<span class="cp">#ifdef CONFIG_CPU_CAVIUM_OCTEON</span>
		<span class="cm">/* Restore the Octeon multiplier state */</span>
		<span class="n">jal</span>	<span class="n">octeon_mult_restore</span>
<span class="cp">#endif</span>
		<span class="n">mfc0</span>	<span class="n">a0</span><span class="p">,</span> <span class="n">CP0_STATUS</span>
		<span class="n">ori</span>	<span class="n">a0</span><span class="p">,</span> <span class="n">STATMASK</span>
		<span class="n">xori</span>	<span class="n">a0</span><span class="p">,</span> <span class="n">STATMASK</span>
		<span class="n">mtc0</span>	<span class="n">a0</span><span class="p">,</span> <span class="n">CP0_STATUS</span>
		<span class="n">li</span>	<span class="n">v1</span><span class="p">,</span> <span class="mh">0xff00</span>
		<span class="n">and</span>	<span class="n">a0</span><span class="p">,</span> <span class="n">v1</span>
		<span class="n">LONG_L</span>	<span class="n">v0</span><span class="p">,</span> <span class="n">PT_STATUS</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">nor</span>	<span class="n">v1</span><span class="p">,</span> <span class="err">$</span><span class="mi">0</span><span class="p">,</span> <span class="n">v1</span>
		<span class="n">and</span>	<span class="n">v0</span><span class="p">,</span> <span class="n">v1</span>
		<span class="n">or</span>	<span class="n">v0</span><span class="p">,</span> <span class="n">a0</span>
		<span class="n">mtc0</span>	<span class="n">v0</span><span class="p">,</span> <span class="n">CP0_STATUS</span>
<span class="cp">#ifdef CONFIG_MIPS_MT_SMTC</span>
<span class="cm">/*</span>
<span class="cm"> * Only after EXL/ERL have been restored to status can we</span>
<span class="cm"> * restore TCStatus.IXMT.</span>
<span class="cm"> */</span>
		<span class="n">LONG_L</span>	<span class="n">v1</span><span class="p">,</span> <span class="n">PT_TCSTATUS</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">_ehb</span>
		<span class="n">mfc0</span>	<span class="n">a0</span><span class="p">,</span> <span class="n">CP0_TCSTATUS</span>
		<span class="n">andi</span>	<span class="n">v1</span><span class="p">,</span> <span class="n">TCSTATUS_IXMT</span>
		<span class="n">bnez</span>	<span class="n">v1</span><span class="p">,</span> <span class="mf">0f</span>

<span class="cm">/*</span>
<span class="cm"> * We&#39;d like to detect any IPIs queued in the tiny window</span>
<span class="cm"> * above and request an software interrupt to service them</span>
<span class="cm"> * when we ERET.</span>
<span class="cm"> *</span>
<span class="cm"> * Computing the offset into the IPIQ array of the executing</span>
<span class="cm"> * TC&#39;s IPI queue in-line would be tedious.  We use part of</span>
<span class="cm"> * the TCContext register to hold 16 bits of offset that we</span>
<span class="cm"> * can add in-line to find the queue head.</span>
<span class="cm"> */</span>
		<span class="n">mfc0</span>	<span class="n">v0</span><span class="p">,</span> <span class="n">CP0_TCCONTEXT</span>
		<span class="n">la</span>	<span class="n">a2</span><span class="p">,</span> <span class="n">IPIQ</span>
		<span class="n">srl</span>	<span class="n">v0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="mi">16</span>
		<span class="n">addu</span>	<span class="n">a2</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">v0</span>
		<span class="n">LONG_L</span>	<span class="n">v0</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>
		<span class="n">beqz</span>	<span class="n">v0</span><span class="p">,</span> <span class="mf">0f</span>
<span class="cm">/*</span>
<span class="cm"> * If we have a queue, provoke dispatch within the VPE by setting C_SW1</span>
<span class="cm"> */</span>
		<span class="n">mfc0</span>	<span class="n">v0</span><span class="p">,</span> <span class="n">CP0_CAUSE</span>
		<span class="n">ori</span>	<span class="n">v0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">C_SW1</span>
		<span class="n">mtc0</span>	<span class="n">v0</span><span class="p">,</span> <span class="n">CP0_CAUSE</span>
<span class="mi">0</span><span class="o">:</span>
		<span class="cm">/*</span>
<span class="cm">		 * This test should really never branch but</span>
<span class="cm">		 * let&#39;s be prudent here.  Having atomized</span>
<span class="cm">		 * the shared register modifications, we can</span>
<span class="cm">		 * now EVPE, and must do so before interrupts</span>
<span class="cm">		 * are potentially re-enabled.</span>
<span class="cm">		 */</span>
		<span class="n">andi</span>	<span class="n">a1</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">MVPCONTROL_EVP</span>
		<span class="n">beqz</span>	<span class="n">a1</span><span class="p">,</span> <span class="mf">1f</span>
		<span class="n">evpe</span>
<span class="mi">1</span><span class="o">:</span>
		<span class="cm">/* We know that TCStatua.IXMT should be set from above */</span>
		<span class="n">xori</span>	<span class="n">a0</span><span class="p">,</span> <span class="n">a0</span><span class="p">,</span> <span class="n">TCSTATUS_IXMT</span>
		<span class="n">or</span>	<span class="n">a0</span><span class="p">,</span> <span class="n">a0</span><span class="p">,</span> <span class="n">v1</span>
		<span class="n">mtc0</span>	<span class="n">a0</span><span class="p">,</span> <span class="n">CP0_TCSTATUS</span>
		<span class="n">_ehb</span>

		<span class="p">.</span><span class="n">set</span>	<span class="n">mips0</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MIPS_MT_SMTC */</span><span class="cp"></span>
		<span class="n">LONG_L</span>	<span class="n">v1</span><span class="p">,</span> <span class="n">PT_EPC</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">MTC0</span>	<span class="n">v1</span><span class="p">,</span> <span class="n">CP0_EPC</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">31</span><span class="p">,</span> <span class="n">PT_R31</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">28</span><span class="p">,</span> <span class="n">PT_R28</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">25</span><span class="p">,</span> <span class="n">PT_R25</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="cp">#ifdef CONFIG_64BIT</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">8</span><span class="p">,</span> <span class="n">PT_R8</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">9</span><span class="p">,</span> <span class="n">PT_R9</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="cp">#endif</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">7</span><span class="p">,</span>  <span class="n">PT_R7</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">6</span><span class="p">,</span>  <span class="n">PT_R6</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">5</span><span class="p">,</span>  <span class="n">PT_R5</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">4</span><span class="p">,</span>  <span class="n">PT_R4</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">3</span><span class="p">,</span>  <span class="n">PT_R3</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">LONG_L</span>	<span class="err">$</span><span class="mi">2</span><span class="p">,</span>  <span class="n">PT_R2</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="p">.</span><span class="n">set</span>	<span class="n">pop</span>
		<span class="p">.</span><span class="n">endm</span>

		<span class="p">.</span><span class="n">macro</span>	<span class="n">RESTORE_SP_AND_RET</span>
		<span class="n">LONG_L</span>	<span class="n">sp</span><span class="p">,</span> <span class="n">PT_R29</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="p">.</span><span class="n">set</span>	<span class="n">mips3</span>
		<span class="n">eret</span>
		<span class="p">.</span><span class="n">set</span>	<span class="n">mips0</span>
		<span class="p">.</span><span class="n">endm</span>

<span class="cp">#endif</span>

		<span class="p">.</span><span class="n">macro</span>	<span class="n">RESTORE_SP</span>
		<span class="n">LONG_L</span>	<span class="n">sp</span><span class="p">,</span> <span class="n">PT_R29</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="p">.</span><span class="n">endm</span>

		<span class="p">.</span><span class="n">macro</span>	<span class="n">RESTORE_ALL</span>
		<span class="n">RESTORE_TEMP</span>
		<span class="n">RESTORE_STATIC</span>
		<span class="n">RESTORE_AT</span>
		<span class="n">RESTORE_SOME</span>
		<span class="n">RESTORE_SP</span>
		<span class="p">.</span><span class="n">endm</span>

		<span class="p">.</span><span class="n">macro</span>	<span class="n">RESTORE_ALL_AND_RET</span>
		<span class="n">RESTORE_TEMP</span>
		<span class="n">RESTORE_STATIC</span>
		<span class="n">RESTORE_AT</span>
		<span class="n">RESTORE_SOME</span>
		<span class="n">RESTORE_SP_AND_RET</span>
		<span class="p">.</span><span class="n">endm</span>

<span class="cm">/*</span>
<span class="cm"> * Move to kernel mode and disable interrupts.</span>
<span class="cm"> * Set cp0 enable bit as sign that we&#39;re running on the kernel stack</span>
<span class="cm"> */</span>
		<span class="p">.</span><span class="n">macro</span>	<span class="n">CLI</span>
<span class="cp">#if !defined(CONFIG_MIPS_MT_SMTC)</span>
		<span class="n">mfc0</span>	<span class="n">t0</span><span class="p">,</span> <span class="n">CP0_STATUS</span>
		<span class="n">li</span>	<span class="n">t1</span><span class="p">,</span> <span class="n">ST0_CU0</span> <span class="o">|</span> <span class="n">STATMASK</span>
		<span class="n">or</span>	<span class="n">t0</span><span class="p">,</span> <span class="n">t1</span>
		<span class="n">xori</span>	<span class="n">t0</span><span class="p">,</span> <span class="n">STATMASK</span>
		<span class="n">mtc0</span>	<span class="n">t0</span><span class="p">,</span> <span class="n">CP0_STATUS</span>
<span class="cp">#else </span><span class="cm">/* CONFIG_MIPS_MT_SMTC */</span><span class="cp"></span>
		<span class="cm">/*</span>
<span class="cm">		 * For SMTC, we need to set privilege</span>
<span class="cm">		 * and disable interrupts only for the</span>
<span class="cm">		 * current TC, using the TCStatus register.</span>
<span class="cm">		 */</span>
		<span class="n">mfc0</span>	<span class="n">t0</span><span class="p">,</span> <span class="n">CP0_TCSTATUS</span>
		<span class="cm">/* Fortunately CU 0 is in the same place in both registers */</span>
		<span class="cm">/* Set TCU0, TMX, TKSU (for later inversion) and IXMT */</span>
		<span class="n">li</span>	<span class="n">t1</span><span class="p">,</span> <span class="n">ST0_CU0</span> <span class="o">|</span> <span class="mh">0x08001c00</span>
		<span class="n">or</span>	<span class="n">t0</span><span class="p">,</span> <span class="n">t1</span>
		<span class="cm">/* Clear TKSU, leave IXMT */</span>
		<span class="n">xori</span>	<span class="n">t0</span><span class="p">,</span> <span class="mh">0x00001800</span>
		<span class="n">mtc0</span>	<span class="n">t0</span><span class="p">,</span> <span class="n">CP0_TCSTATUS</span>
		<span class="n">_ehb</span>
		<span class="cm">/* We need to leave the global IE bit set, but clear EXL...*/</span>
		<span class="n">mfc0</span>	<span class="n">t0</span><span class="p">,</span> <span class="n">CP0_STATUS</span>
		<span class="n">ori</span>	<span class="n">t0</span><span class="p">,</span> <span class="n">ST0_EXL</span> <span class="o">|</span> <span class="n">ST0_ERL</span>
		<span class="n">xori</span>	<span class="n">t0</span><span class="p">,</span> <span class="n">ST0_EXL</span> <span class="o">|</span> <span class="n">ST0_ERL</span>
		<span class="n">mtc0</span>	<span class="n">t0</span><span class="p">,</span> <span class="n">CP0_STATUS</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MIPS_MT_SMTC */</span><span class="cp"></span>
		<span class="n">irq_disable_hazard</span>
		<span class="p">.</span><span class="n">endm</span>

<span class="cm">/*</span>
<span class="cm"> * Move to kernel mode and enable interrupts.</span>
<span class="cm"> * Set cp0 enable bit as sign that we&#39;re running on the kernel stack</span>
<span class="cm"> */</span>
		<span class="p">.</span><span class="n">macro</span>	<span class="n">STI</span>
<span class="cp">#if !defined(CONFIG_MIPS_MT_SMTC)</span>
		<span class="n">mfc0</span>	<span class="n">t0</span><span class="p">,</span> <span class="n">CP0_STATUS</span>
		<span class="n">li</span>	<span class="n">t1</span><span class="p">,</span> <span class="n">ST0_CU0</span> <span class="o">|</span> <span class="n">STATMASK</span>
		<span class="n">or</span>	<span class="n">t0</span><span class="p">,</span> <span class="n">t1</span>
		<span class="n">xori</span>	<span class="n">t0</span><span class="p">,</span> <span class="n">STATMASK</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span>
		<span class="n">mtc0</span>	<span class="n">t0</span><span class="p">,</span> <span class="n">CP0_STATUS</span>
<span class="cp">#else </span><span class="cm">/* CONFIG_MIPS_MT_SMTC */</span><span class="cp"></span>
		<span class="cm">/*</span>
<span class="cm">		 * For SMTC, we need to set privilege</span>
<span class="cm">		 * and enable interrupts only for the</span>
<span class="cm">		 * current TC, using the TCStatus register.</span>
<span class="cm">		 */</span>
		<span class="n">_ehb</span>
		<span class="n">mfc0</span>	<span class="n">t0</span><span class="p">,</span> <span class="n">CP0_TCSTATUS</span>
		<span class="cm">/* Fortunately CU 0 is in the same place in both registers */</span>
		<span class="cm">/* Set TCU0, TKSU (for later inversion) and IXMT */</span>
		<span class="n">li</span>	<span class="n">t1</span><span class="p">,</span> <span class="n">ST0_CU0</span> <span class="o">|</span> <span class="mh">0x08001c00</span>
		<span class="n">or</span>	<span class="n">t0</span><span class="p">,</span> <span class="n">t1</span>
		<span class="cm">/* Clear TKSU *and* IXMT */</span>
		<span class="n">xori</span>	<span class="n">t0</span><span class="p">,</span> <span class="mh">0x00001c00</span>
		<span class="n">mtc0</span>	<span class="n">t0</span><span class="p">,</span> <span class="n">CP0_TCSTATUS</span>
		<span class="n">_ehb</span>
		<span class="cm">/* We need to leave the global IE bit set, but clear EXL...*/</span>
		<span class="n">mfc0</span>	<span class="n">t0</span><span class="p">,</span> <span class="n">CP0_STATUS</span>
		<span class="n">ori</span>	<span class="n">t0</span><span class="p">,</span> <span class="n">ST0_EXL</span>
		<span class="n">xori</span>	<span class="n">t0</span><span class="p">,</span> <span class="n">ST0_EXL</span>
		<span class="n">mtc0</span>	<span class="n">t0</span><span class="p">,</span> <span class="n">CP0_STATUS</span>
		<span class="cm">/* irq_enable_hazard below should expand to EHB for 24K/34K cpus */</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MIPS_MT_SMTC */</span><span class="cp"></span>
		<span class="n">irq_enable_hazard</span>
		<span class="p">.</span><span class="n">endm</span>

<span class="cm">/*</span>
<span class="cm"> * Just move to kernel mode and leave interrupts as they are.  Note</span>
<span class="cm"> * for the R3000 this means copying the previous enable from IEp.</span>
<span class="cm"> * Set cp0 enable bit as sign that we&#39;re running on the kernel stack</span>
<span class="cm"> */</span>
		<span class="p">.</span><span class="n">macro</span>	<span class="n">KMODE</span>
<span class="cp">#ifdef CONFIG_MIPS_MT_SMTC</span>
		<span class="cm">/*</span>
<span class="cm">		 * This gets baroque in SMTC.  We want to</span>
<span class="cm">		 * protect the non-atomic clearing of EXL</span>
<span class="cm">		 * with DMT/EMT, but we don&#39;t want to take</span>
<span class="cm">		 * an interrupt while DMT is still in effect.</span>
<span class="cm">		 */</span>

		<span class="cm">/* KMODE gets invoked from both reorder and noreorder code */</span>
		<span class="p">.</span><span class="n">set</span>	<span class="n">push</span>
		<span class="p">.</span><span class="n">set</span>	<span class="n">mips32r2</span>
		<span class="p">.</span><span class="n">set</span>	<span class="n">noreorder</span>
		<span class="n">mfc0</span>	<span class="n">v0</span><span class="p">,</span> <span class="n">CP0_TCSTATUS</span>
		<span class="n">andi</span>	<span class="n">v1</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">TCSTATUS_IXMT</span>
		<span class="n">ori</span>	<span class="n">v0</span><span class="p">,</span> <span class="n">TCSTATUS_IXMT</span>
		<span class="n">mtc0</span>	<span class="n">v0</span><span class="p">,</span> <span class="n">CP0_TCSTATUS</span>
		<span class="n">_ehb</span>
		<span class="n">DMT</span>	<span class="mi">2</span>				<span class="err">#</span> <span class="n">dmt</span>	<span class="n">v0</span>
		<span class="cm">/*</span>
<span class="cm">		 * We don&#39;t know a priori if ra is &quot;live&quot;</span>
<span class="cm">		 */</span>
		<span class="n">move</span>	<span class="n">t0</span><span class="p">,</span> <span class="n">ra</span>
		<span class="n">jal</span>	<span class="n">mips_ihb</span>
		<span class="n">nop</span>	<span class="cm">/* delay slot */</span>
		<span class="n">move</span>	<span class="n">ra</span><span class="p">,</span> <span class="n">t0</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MIPS_MT_SMTC */</span><span class="cp"></span>
		<span class="n">mfc0</span>	<span class="n">t0</span><span class="p">,</span> <span class="n">CP0_STATUS</span>
		<span class="n">li</span>	<span class="n">t1</span><span class="p">,</span> <span class="n">ST0_CU0</span> <span class="o">|</span> <span class="p">(</span><span class="n">STATMASK</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">)</span>
<span class="cp">#if defined(CONFIG_CPU_R3000) || defined(CONFIG_CPU_TX39XX)</span>
		<span class="n">andi</span>	<span class="n">t2</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">ST0_IEP</span>
		<span class="n">srl</span>	<span class="n">t2</span><span class="p">,</span> <span class="mi">2</span>
		<span class="n">or</span>	<span class="n">t0</span><span class="p">,</span> <span class="n">t2</span>
<span class="cp">#endif</span>
		<span class="n">or</span>	<span class="n">t0</span><span class="p">,</span> <span class="n">t1</span>
		<span class="n">xori</span>	<span class="n">t0</span><span class="p">,</span> <span class="n">STATMASK</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span>
		<span class="n">mtc0</span>	<span class="n">t0</span><span class="p">,</span> <span class="n">CP0_STATUS</span>
<span class="cp">#ifdef CONFIG_MIPS_MT_SMTC</span>
		<span class="n">_ehb</span>
		<span class="n">andi</span>	<span class="n">v0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">VPECONTROL_TE</span>
		<span class="n">beqz</span>	<span class="n">v0</span><span class="p">,</span> <span class="mf">2f</span>
		<span class="n">nop</span>	<span class="cm">/* delay slot */</span>
		<span class="n">emt</span>
<span class="mi">2</span><span class="o">:</span>
		<span class="n">mfc0</span>	<span class="n">v0</span><span class="p">,</span> <span class="n">CP0_TCSTATUS</span>
		<span class="cm">/* Clear IXMT, then OR in previous value */</span>
		<span class="n">ori</span>	<span class="n">v0</span><span class="p">,</span> <span class="n">TCSTATUS_IXMT</span>
		<span class="n">xori</span>	<span class="n">v0</span><span class="p">,</span> <span class="n">TCSTATUS_IXMT</span>
		<span class="n">or</span>	<span class="n">v0</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v0</span>
		<span class="n">mtc0</span>	<span class="n">v0</span><span class="p">,</span> <span class="n">CP0_TCSTATUS</span>
		<span class="cm">/*</span>
<span class="cm">		 * irq_disable_hazard below should expand to EHB</span>
<span class="cm">		 * on 24K/34K CPUS</span>
<span class="cm">		 */</span>
		<span class="p">.</span><span class="n">set</span> <span class="n">pop</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MIPS_MT_SMTC */</span><span class="cp"></span>
		<span class="n">irq_disable_hazard</span>
		<span class="p">.</span><span class="n">endm</span>

<span class="cp">#endif </span><span class="cm">/* _ASM_STACKFRAME_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
