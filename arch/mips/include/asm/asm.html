<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › mips › include › asm › asm.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>asm.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License.  See the file &quot;COPYING&quot; in the main directory of this archive</span>
<span class="cm"> * for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1995, 1996, 1997, 1999, 2001 by Ralf Baechle</span>
<span class="cm"> * Copyright (C) 1999 by Silicon Graphics, Inc.</span>
<span class="cm"> * Copyright (C) 2001 MIPS Technologies, Inc.</span>
<span class="cm"> * Copyright (C) 2002  Maciej W. Rozycki</span>
<span class="cm"> *</span>
<span class="cm"> * Some useful macros for MIPS assembler code</span>
<span class="cm"> *</span>
<span class="cm"> * Some of the routines below contain useless nops that will be optimized</span>
<span class="cm"> * away by gas in -O mode. These nops are however required to fill delay</span>
<span class="cm"> * slots in noreorder mode.</span>
<span class="cm"> */</span>
<span class="cp">#ifndef __ASM_ASM_H</span>
<span class="cp">#define __ASM_ASM_H</span>

<span class="cp">#include &lt;asm/sgidefs.h&gt;</span>

<span class="cp">#ifndef CAT</span>
<span class="cp">#ifdef __STDC__</span>
<span class="cp">#define __CAT(str1, str2) str1##str2</span>
<span class="cp">#else</span>
<span class="cp">#define __CAT(str1, str2) str1</span><span class="cm">/**/</span><span class="cp">str2</span>
<span class="cp">#endif</span>
<span class="cp">#define CAT(str1, str2) __CAT(str1, str2)</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * PIC specific declarations</span>
<span class="cm"> * Not used for the kernel but here seems to be the right place.</span>
<span class="cm"> */</span>
<span class="cp">#ifdef __PIC__</span>
<span class="cp">#define CPRESTORE(register)                             \</span>
<span class="cp">		.cprestore register</span>
<span class="cp">#define CPADD(register)                                 \</span>
<span class="cp">		.cpadd	register</span>
<span class="cp">#define CPLOAD(register)                                \</span>
<span class="cp">		.cpload	register</span>
<span class="cp">#else</span>
<span class="cp">#define CPRESTORE(register)</span>
<span class="cp">#define CPADD(register)</span>
<span class="cp">#define CPLOAD(register)</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * LEAF - declare leaf routine</span>
<span class="cm"> */</span>
<span class="cp">#define	LEAF(symbol)                                    \</span>
<span class="cp">		.globl	symbol;                         \</span>
<span class="cp">		.align	2;                              \</span>
<span class="cp">		.type	symbol, @function;              \</span>
<span class="cp">		.ent	symbol, 0;                      \</span>
<span class="cp">symbol:		.frame	sp, 0, ra</span>

<span class="cm">/*</span>
<span class="cm"> * NESTED - declare nested routine entry point</span>
<span class="cm"> */</span>
<span class="cp">#define	NESTED(symbol, framesize, rpc)                  \</span>
<span class="cp">		.globl	symbol;                         \</span>
<span class="cp">		.align	2;                              \</span>
<span class="cp">		.type	symbol, @function;              \</span>
<span class="cp">		.ent	symbol, 0;                       \</span>
<span class="cp">symbol:		.frame	sp, framesize, rpc</span>

<span class="cm">/*</span>
<span class="cm"> * END - mark end of function</span>
<span class="cm"> */</span>
<span class="cp">#define	END(function)                                   \</span>
<span class="cp">		.end	function;		        \</span>
<span class="cp">		.size	function, .-function</span>

<span class="cm">/*</span>
<span class="cm"> * EXPORT - export definition of symbol</span>
<span class="cm"> */</span>
<span class="cp">#define EXPORT(symbol)					\</span>
<span class="cp">		.globl	symbol;                         \</span>
<span class="cp">symbol:</span>

<span class="cm">/*</span>
<span class="cm"> * FEXPORT - export definition of a function symbol</span>
<span class="cm"> */</span>
<span class="cp">#define FEXPORT(symbol)					\</span>
<span class="cp">		.globl	symbol;				\</span>
<span class="cp">		.type	symbol, @function;		\</span>
<span class="cp">symbol:</span>

<span class="cm">/*</span>
<span class="cm"> * ABS - export absolute symbol</span>
<span class="cm"> */</span>
<span class="cp">#define	ABS(symbol,value)                               \</span>
<span class="cp">		.globl	symbol;                         \</span>
<span class="cp">symbol		=	value</span>

<span class="cp">#define	PANIC(msg)                                      \</span>
<span class="cp">		.set	push;				\</span>
<span class="cp">		.set	reorder;                        \</span>
<span class="cp">		PTR_LA	a0, 8f;                          \</span>
<span class="cp">		jal	panic;                          \</span>
<span class="cp">9:		b	9b;                             \</span>
<span class="cp">		.set	pop;				\</span>
<span class="cp">		TEXT(msg)</span>

<span class="cm">/*</span>
<span class="cm"> * Print formatted string</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_PRINTK</span>
<span class="cp">#define PRINT(string)                                   \</span>
<span class="cp">		.set	push;				\</span>
<span class="cp">		.set	reorder;                        \</span>
<span class="cp">		PTR_LA	a0, 8f;                          \</span>
<span class="cp">		jal	printk;                         \</span>
<span class="cp">		.set	pop;				\</span>
<span class="cp">		TEXT(string)</span>
<span class="cp">#else</span>
<span class="cp">#define PRINT(string)</span>
<span class="cp">#endif</span>

<span class="cp">#define	TEXT(msg)                                       \</span>
<span class="cp">		.pushsection .data;			\</span>
<span class="cp">8:		.asciiz	msg;                            \</span>
<span class="cp">		.popsection;</span>

<span class="cm">/*</span>
<span class="cm"> * Build text tables</span>
<span class="cm"> */</span>
<span class="cp">#define TTABLE(string)                                  \</span>
<span class="cp">		.pushsection .text;			\</span>
<span class="cp">		.word	1f;                             \</span>
<span class="cp">		.popsection				\</span>
<span class="cp">		.pushsection .data;			\</span>
<span class="cp">1:		.asciiz	string;                         \</span>
<span class="cp">		.popsection</span>

<span class="cm">/*</span>
<span class="cm"> * MIPS IV pref instruction.</span>
<span class="cm"> * Use with .set noreorder only!</span>
<span class="cm"> *</span>
<span class="cm"> * MIPS IV implementations are free to treat this as a nop.  The R5000</span>
<span class="cm"> * is one of them.  So we should have an option not to use this instruction.</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_CPU_HAS_PREFETCH</span>

<span class="cp">#define PREF(hint,addr)                                 \</span>
<span class="cp">		.set	push;				\</span>
<span class="cp">		.set	mips4;				\</span>
<span class="cp">		pref	hint, addr;			\</span>
<span class="cp">		.set	pop</span>

<span class="cp">#define PREFX(hint,addr)                                \</span>
<span class="cp">		.set	push;				\</span>
<span class="cp">		.set	mips4;				\</span>
<span class="cp">		prefx	hint, addr;			\</span>
<span class="cp">		.set	pop</span>

<span class="cp">#else </span><span class="cm">/* !CONFIG_CPU_HAS_PREFETCH */</span><span class="cp"></span>

<span class="cp">#define PREF(hint, addr)</span>
<span class="cp">#define PREFX(hint, addr)</span>

<span class="cp">#endif </span><span class="cm">/* !CONFIG_CPU_HAS_PREFETCH */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * MIPS ISA IV/V movn/movz instructions and equivalents for older CPUs.</span>
<span class="cm"> */</span>
<span class="cp">#if (_MIPS_ISA == _MIPS_ISA_MIPS1)</span>
<span class="cp">#define MOVN(rd, rs, rt)                                \</span>
<span class="cp">		.set	push;				\</span>
<span class="cp">		.set	reorder;			\</span>
<span class="cp">		beqz	rt, 9f;                         \</span>
<span class="cp">		move	rd, rs;                         \</span>
<span class="cp">		.set	pop;				\</span>
<span class="cp">9:</span>
<span class="cp">#define MOVZ(rd, rs, rt)                                \</span>
<span class="cp">		.set	push;				\</span>
<span class="cp">		.set	reorder;			\</span>
<span class="cp">		bnez	rt, 9f;                         \</span>
<span class="cp">		move	rd, rs;                         \</span>
<span class="cp">		.set	pop;				\</span>
<span class="cp">9:</span>
<span class="cp">#endif </span><span class="cm">/* _MIPS_ISA == _MIPS_ISA_MIPS1 */</span><span class="cp"></span>
<span class="cp">#if (_MIPS_ISA == _MIPS_ISA_MIPS2) || (_MIPS_ISA == _MIPS_ISA_MIPS3)</span>
<span class="cp">#define MOVN(rd, rs, rt)                                \</span>
<span class="cp">		.set	push;				\</span>
<span class="cp">		.set	noreorder;			\</span>
<span class="cp">		bnezl	rt, 9f;                         \</span>
<span class="cp">		 move	rd, rs;                         \</span>
<span class="cp">		.set	pop;				\</span>
<span class="cp">9:</span>
<span class="cp">#define MOVZ(rd, rs, rt)                                \</span>
<span class="cp">		.set	push;				\</span>
<span class="cp">		.set	noreorder;			\</span>
<span class="cp">		beqzl	rt, 9f;                         \</span>
<span class="cp">		 move	rd, rs;                         \</span>
<span class="cp">		.set	pop;				\</span>
<span class="cp">9:</span>
<span class="cp">#endif </span><span class="cm">/* (_MIPS_ISA == _MIPS_ISA_MIPS2) || (_MIPS_ISA == _MIPS_ISA_MIPS3) */</span><span class="cp"></span>
<span class="cp">#if (_MIPS_ISA == _MIPS_ISA_MIPS4 ) || (_MIPS_ISA == _MIPS_ISA_MIPS5) || \</span>
<span class="cp">    (_MIPS_ISA == _MIPS_ISA_MIPS32) || (_MIPS_ISA == _MIPS_ISA_MIPS64)</span>
<span class="cp">#define MOVN(rd, rs, rt)                                \</span>
<span class="cp">		movn	rd, rs, rt</span>
<span class="cp">#define MOVZ(rd, rs, rt)                                \</span>
<span class="cp">		movz	rd, rs, rt</span>
<span class="cp">#endif </span><span class="cm">/* MIPS IV, MIPS V, MIPS32 or MIPS64 */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Stack alignment</span>
<span class="cm"> */</span>
<span class="cp">#if (_MIPS_SIM == _MIPS_SIM_ABI32)</span>
<span class="cp">#define ALSZ	7</span>
<span class="cp">#define ALMASK	~7</span>
<span class="cp">#endif</span>
<span class="cp">#if (_MIPS_SIM == _MIPS_SIM_NABI32) || (_MIPS_SIM == _MIPS_SIM_ABI64)</span>
<span class="cp">#define ALSZ	15</span>
<span class="cp">#define ALMASK	~15</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Macros to handle different pointer/register sizes for 32/64-bit code</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Size of a register</span>
<span class="cm"> */</span>
<span class="cp">#ifdef __mips64</span>
<span class="cp">#define SZREG	8</span>
<span class="cp">#else</span>
<span class="cp">#define SZREG	4</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Use the following macros in assemblercode to load/store registers,</span>
<span class="cm"> * pointers etc.</span>
<span class="cm"> */</span>
<span class="cp">#if (_MIPS_SIM == _MIPS_SIM_ABI32)</span>
<span class="cp">#define REG_S		sw</span>
<span class="cp">#define REG_L		lw</span>
<span class="cp">#define REG_SUBU	subu</span>
<span class="cp">#define REG_ADDU	addu</span>
<span class="cp">#endif</span>
<span class="cp">#if (_MIPS_SIM == _MIPS_SIM_NABI32) || (_MIPS_SIM == _MIPS_SIM_ABI64)</span>
<span class="cp">#define REG_S		sd</span>
<span class="cp">#define REG_L		ld</span>
<span class="cp">#define REG_SUBU	dsubu</span>
<span class="cp">#define REG_ADDU	daddu</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * How to add/sub/load/store/shift C int variables.</span>
<span class="cm"> */</span>
<span class="cp">#if (_MIPS_SZINT == 32)</span>
<span class="cp">#define INT_ADD		add</span>
<span class="cp">#define INT_ADDU	addu</span>
<span class="cp">#define INT_ADDI	addi</span>
<span class="cp">#define INT_ADDIU	addiu</span>
<span class="cp">#define INT_SUB		sub</span>
<span class="cp">#define INT_SUBU	subu</span>
<span class="cp">#define INT_L		lw</span>
<span class="cp">#define INT_S		sw</span>
<span class="cp">#define INT_SLL		sll</span>
<span class="cp">#define INT_SLLV	sllv</span>
<span class="cp">#define INT_SRL		srl</span>
<span class="cp">#define INT_SRLV	srlv</span>
<span class="cp">#define INT_SRA		sra</span>
<span class="cp">#define INT_SRAV	srav</span>
<span class="cp">#endif</span>

<span class="cp">#if (_MIPS_SZINT == 64)</span>
<span class="cp">#define INT_ADD		dadd</span>
<span class="cp">#define INT_ADDU	daddu</span>
<span class="cp">#define INT_ADDI	daddi</span>
<span class="cp">#define INT_ADDIU	daddiu</span>
<span class="cp">#define INT_SUB		dsub</span>
<span class="cp">#define INT_SUBU	dsubu</span>
<span class="cp">#define INT_L		ld</span>
<span class="cp">#define INT_S		sd</span>
<span class="cp">#define INT_SLL		dsll</span>
<span class="cp">#define INT_SLLV	dsllv</span>
<span class="cp">#define INT_SRL		dsrl</span>
<span class="cp">#define INT_SRLV	dsrlv</span>
<span class="cp">#define INT_SRA		dsra</span>
<span class="cp">#define INT_SRAV	dsrav</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * How to add/sub/load/store/shift C long variables.</span>
<span class="cm"> */</span>
<span class="cp">#if (_MIPS_SZLONG == 32)</span>
<span class="cp">#define LONG_ADD	add</span>
<span class="cp">#define LONG_ADDU	addu</span>
<span class="cp">#define LONG_ADDI	addi</span>
<span class="cp">#define LONG_ADDIU	addiu</span>
<span class="cp">#define LONG_SUB	sub</span>
<span class="cp">#define LONG_SUBU	subu</span>
<span class="cp">#define LONG_L		lw</span>
<span class="cp">#define LONG_S		sw</span>
<span class="cp">#define LONG_SLL	sll</span>
<span class="cp">#define LONG_SLLV	sllv</span>
<span class="cp">#define LONG_SRL	srl</span>
<span class="cp">#define LONG_SRLV	srlv</span>
<span class="cp">#define LONG_SRA	sra</span>
<span class="cp">#define LONG_SRAV	srav</span>

<span class="cp">#define LONG		.word</span>
<span class="cp">#define LONGSIZE	4</span>
<span class="cp">#define LONGMASK	3</span>
<span class="cp">#define LONGLOG		2</span>
<span class="cp">#endif</span>

<span class="cp">#if (_MIPS_SZLONG == 64)</span>
<span class="cp">#define LONG_ADD	dadd</span>
<span class="cp">#define LONG_ADDU	daddu</span>
<span class="cp">#define LONG_ADDI	daddi</span>
<span class="cp">#define LONG_ADDIU	daddiu</span>
<span class="cp">#define LONG_SUB	dsub</span>
<span class="cp">#define LONG_SUBU	dsubu</span>
<span class="cp">#define LONG_L		ld</span>
<span class="cp">#define LONG_S		sd</span>
<span class="cp">#define LONG_SLL	dsll</span>
<span class="cp">#define LONG_SLLV	dsllv</span>
<span class="cp">#define LONG_SRL	dsrl</span>
<span class="cp">#define LONG_SRLV	dsrlv</span>
<span class="cp">#define LONG_SRA	dsra</span>
<span class="cp">#define LONG_SRAV	dsrav</span>

<span class="cp">#define LONG		.dword</span>
<span class="cp">#define LONGSIZE	8</span>
<span class="cp">#define LONGMASK	7</span>
<span class="cp">#define LONGLOG		3</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * How to add/sub/load/store/shift pointers.</span>
<span class="cm"> */</span>
<span class="cp">#if (_MIPS_SZPTR == 32)</span>
<span class="cp">#define PTR_ADD		add</span>
<span class="cp">#define PTR_ADDU	addu</span>
<span class="cp">#define PTR_ADDI	addi</span>
<span class="cp">#define PTR_ADDIU	addiu</span>
<span class="cp">#define PTR_SUB		sub</span>
<span class="cp">#define PTR_SUBU	subu</span>
<span class="cp">#define PTR_L		lw</span>
<span class="cp">#define PTR_S		sw</span>
<span class="cp">#define PTR_LA		la</span>
<span class="cp">#define PTR_LI		li</span>
<span class="cp">#define PTR_SLL		sll</span>
<span class="cp">#define PTR_SLLV	sllv</span>
<span class="cp">#define PTR_SRL		srl</span>
<span class="cp">#define PTR_SRLV	srlv</span>
<span class="cp">#define PTR_SRA		sra</span>
<span class="cp">#define PTR_SRAV	srav</span>

<span class="cp">#define PTR_SCALESHIFT	2</span>

<span class="cp">#define PTR		.word</span>
<span class="cp">#define PTRSIZE		4</span>
<span class="cp">#define PTRLOG		2</span>
<span class="cp">#endif</span>

<span class="cp">#if (_MIPS_SZPTR == 64)</span>
<span class="cp">#define PTR_ADD		dadd</span>
<span class="cp">#define PTR_ADDU	daddu</span>
<span class="cp">#define PTR_ADDI	daddi</span>
<span class="cp">#define PTR_ADDIU	daddiu</span>
<span class="cp">#define PTR_SUB		dsub</span>
<span class="cp">#define PTR_SUBU	dsubu</span>
<span class="cp">#define PTR_L		ld</span>
<span class="cp">#define PTR_S		sd</span>
<span class="cp">#define PTR_LA		dla</span>
<span class="cp">#define PTR_LI		dli</span>
<span class="cp">#define PTR_SLL		dsll</span>
<span class="cp">#define PTR_SLLV	dsllv</span>
<span class="cp">#define PTR_SRL		dsrl</span>
<span class="cp">#define PTR_SRLV	dsrlv</span>
<span class="cp">#define PTR_SRA		dsra</span>
<span class="cp">#define PTR_SRAV	dsrav</span>

<span class="cp">#define PTR_SCALESHIFT	3</span>

<span class="cp">#define PTR		.dword</span>
<span class="cp">#define PTRSIZE		8</span>
<span class="cp">#define PTRLOG		3</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Some cp0 registers were extended to 64bit for MIPS III.</span>
<span class="cm"> */</span>
<span class="cp">#if (_MIPS_SIM == _MIPS_SIM_ABI32)</span>
<span class="cp">#define MFC0		mfc0</span>
<span class="cp">#define MTC0		mtc0</span>
<span class="cp">#endif</span>
<span class="cp">#if (_MIPS_SIM == _MIPS_SIM_NABI32) || (_MIPS_SIM == _MIPS_SIM_ABI64)</span>
<span class="cp">#define MFC0		dmfc0</span>
<span class="cp">#define MTC0		dmtc0</span>
<span class="cp">#endif</span>

<span class="cp">#define SSNOP		sll zero, zero, 1</span>

<span class="cp">#ifdef CONFIG_SGI_IP28</span>
<span class="cm">/* Inhibit speculative stores to volatile (e.g.DMA) or invalid addresses. */</span>
<span class="cp">#include &lt;asm/cacheops.h&gt;</span>
<span class="cp">#define R10KCBARRIER(addr)  cache   Cache_Barrier, addr;</span>
<span class="cp">#else</span>
<span class="cp">#define R10KCBARRIER(addr)</span>
<span class="cp">#endif</span>

<span class="cp">#endif </span><span class="cm">/* __ASM_ASM_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
