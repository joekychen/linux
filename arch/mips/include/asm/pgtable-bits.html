<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › mips › include › asm › pgtable-bits.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>pgtable-bits.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License.  See the file &quot;COPYING&quot; in the main directory of this archive</span>
<span class="cm"> * for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1994 - 2002 by Ralf Baechle</span>
<span class="cm"> * Copyright (C) 1999, 2000, 2001 Silicon Graphics, Inc.</span>
<span class="cm"> * Copyright (C) 2002  Maciej W. Rozycki</span>
<span class="cm"> */</span>
<span class="cp">#ifndef _ASM_PGTABLE_BITS_H</span>
<span class="cp">#define _ASM_PGTABLE_BITS_H</span>


<span class="cm">/*</span>
<span class="cm"> * Note that we shift the lower 32bits of each EntryLo[01] entry</span>
<span class="cm"> * 6 bits to the left. That way we can convert the PFN into the</span>
<span class="cm"> * physical address by a single &#39;and&#39; operation and gain 6 additional</span>
<span class="cm"> * bits for storing information which isn&#39;t present in a normal</span>
<span class="cm"> * MIPS page table.</span>
<span class="cm"> *</span>
<span class="cm"> * Similar to the Alpha port, we need to keep track of the ref</span>
<span class="cm"> * and mod bits in software.  We have a software &quot;yeah you can read</span>
<span class="cm"> * from this page&quot; bit, and a hardware one which actually lets the</span>
<span class="cm"> * process read from the page.  On the same token we have a software</span>
<span class="cm"> * writable bit and the real hardware one which actually lets the</span>
<span class="cm"> * process write to the page, this keeps a mod bit via the hardware</span>
<span class="cm"> * dirty bit.</span>
<span class="cm"> *</span>
<span class="cm"> * Certain revisions of the R4000 and R5000 have a bug where if a</span>
<span class="cm"> * certain sequence occurs in the last 3 instructions of an executable</span>
<span class="cm"> * page, and the following page is not mapped, the cpu can do</span>
<span class="cm"> * unpredictable things.  The code (when it is written) to deal with</span>
<span class="cm"> * this problem will be in the update_mmu_cache() code for the r4k.</span>
<span class="cm"> */</span>
<span class="cp">#if defined(CONFIG_64BIT_PHYS_ADDR) &amp;&amp; defined(CONFIG_CPU_MIPS32)</span>

<span class="cp">#define _PAGE_PRESENT               (1&lt;&lt;6)  </span><span class="cm">/* implemented in software */</span><span class="cp"></span>
<span class="cp">#define _PAGE_READ                  (1&lt;&lt;7)  </span><span class="cm">/* implemented in software */</span><span class="cp"></span>
<span class="cp">#define _PAGE_WRITE                 (1&lt;&lt;8)  </span><span class="cm">/* implemented in software */</span><span class="cp"></span>
<span class="cp">#define _PAGE_ACCESSED              (1&lt;&lt;9)  </span><span class="cm">/* implemented in software */</span><span class="cp"></span>
<span class="cp">#define _PAGE_MODIFIED              (1&lt;&lt;10) </span><span class="cm">/* implemented in software */</span><span class="cp"></span>
<span class="cp">#define _PAGE_FILE                  (1&lt;&lt;10) </span><span class="cm">/* set:pagecache unset:swap */</span><span class="cp"></span>

<span class="cp">#define _PAGE_R4KBUG                (1&lt;&lt;0)  </span><span class="cm">/* workaround for r4k bug  */</span><span class="cp"></span>
<span class="cp">#define _PAGE_GLOBAL                (1&lt;&lt;0)</span>
<span class="cp">#define _PAGE_VALID                 (1&lt;&lt;1)</span>
<span class="cp">#define _PAGE_SILENT_READ           (1&lt;&lt;1)  </span><span class="cm">/* synonym                 */</span><span class="cp"></span>
<span class="cp">#define _PAGE_DIRTY                 (1&lt;&lt;2)  </span><span class="cm">/* The MIPS dirty bit      */</span><span class="cp"></span>
<span class="cp">#define _PAGE_SILENT_WRITE          (1&lt;&lt;2)</span>
<span class="cp">#define _CACHE_SHIFT                3</span>
<span class="cp">#define _CACHE_MASK                 (7&lt;&lt;3)</span>

<span class="cp">#elif defined(CONFIG_CPU_R3000) || defined(CONFIG_CPU_TX39XX)</span>

<span class="cp">#define _PAGE_PRESENT               (1&lt;&lt;0)  </span><span class="cm">/* implemented in software */</span><span class="cp"></span>
<span class="cp">#define _PAGE_READ                  (1&lt;&lt;1)  </span><span class="cm">/* implemented in software */</span><span class="cp"></span>
<span class="cp">#define _PAGE_WRITE                 (1&lt;&lt;2)  </span><span class="cm">/* implemented in software */</span><span class="cp"></span>
<span class="cp">#define _PAGE_ACCESSED              (1&lt;&lt;3)  </span><span class="cm">/* implemented in software */</span><span class="cp"></span>
<span class="cp">#define _PAGE_MODIFIED              (1&lt;&lt;4)  </span><span class="cm">/* implemented in software */</span><span class="cp"></span>
<span class="cp">#define _PAGE_FILE                  (1&lt;&lt;4)  </span><span class="cm">/* set:pagecache unset:swap */</span><span class="cp"></span>

<span class="cp">#define _PAGE_GLOBAL                (1&lt;&lt;8)</span>
<span class="cp">#define _PAGE_VALID                 (1&lt;&lt;9)</span>
<span class="cp">#define _PAGE_SILENT_READ           (1&lt;&lt;9)  </span><span class="cm">/* synonym                 */</span><span class="cp"></span>
<span class="cp">#define _PAGE_DIRTY                 (1&lt;&lt;10) </span><span class="cm">/* The MIPS dirty bit      */</span><span class="cp"></span>
<span class="cp">#define _PAGE_SILENT_WRITE          (1&lt;&lt;10)</span>
<span class="cp">#define _CACHE_UNCACHED             (1&lt;&lt;11)</span>
<span class="cp">#define _CACHE_MASK                 (1&lt;&lt;11)</span>

<span class="cp">#else </span><span class="cm">/* &#39;Normal&#39; r4K case */</span><span class="cp"></span>
<span class="cm">/*</span>
<span class="cm"> * When using the RI/XI bit support, we have 13 bits of flags below</span>
<span class="cm"> * the physical address. The RI/XI bits are placed such that a SRL 5</span>
<span class="cm"> * can strip off the software bits, then a ROTR 2 can move the RI/XI</span>
<span class="cm"> * into bits [63:62]. This also limits physical address to 56 bits,</span>
<span class="cm"> * which is more than we need right now.</span>
<span class="cm"> */</span>

<span class="cm">/* implemented in software */</span>
<span class="cp">#define _PAGE_PRESENT_SHIFT	(0)</span>
<span class="cp">#define _PAGE_PRESENT		(1 &lt;&lt; _PAGE_PRESENT_SHIFT)</span>
<span class="cm">/* implemented in software, should be unused if kernel_uses_smartmips_rixi. */</span>
<span class="cp">#define _PAGE_READ_SHIFT	(kernel_uses_smartmips_rixi ? _PAGE_PRESENT_SHIFT : _PAGE_PRESENT_SHIFT + 1)</span>
<span class="cp">#define _PAGE_READ ({if (kernel_uses_smartmips_rixi) BUG(); 1 &lt;&lt; _PAGE_READ_SHIFT; })</span>
<span class="cm">/* implemented in software */</span>
<span class="cp">#define _PAGE_WRITE_SHIFT	(_PAGE_READ_SHIFT + 1)</span>
<span class="cp">#define _PAGE_WRITE		(1 &lt;&lt; _PAGE_WRITE_SHIFT)</span>
<span class="cm">/* implemented in software */</span>
<span class="cp">#define _PAGE_ACCESSED_SHIFT	(_PAGE_WRITE_SHIFT + 1)</span>
<span class="cp">#define _PAGE_ACCESSED		(1 &lt;&lt; _PAGE_ACCESSED_SHIFT)</span>
<span class="cm">/* implemented in software */</span>
<span class="cp">#define _PAGE_MODIFIED_SHIFT	(_PAGE_ACCESSED_SHIFT + 1)</span>
<span class="cp">#define _PAGE_MODIFIED		(1 &lt;&lt; _PAGE_MODIFIED_SHIFT)</span>
<span class="cm">/* set:pagecache unset:swap */</span>
<span class="cp">#define _PAGE_FILE		(_PAGE_MODIFIED)</span>

<span class="cp">#ifdef CONFIG_HUGETLB_PAGE</span>
<span class="cm">/* huge tlb page */</span>
<span class="cp">#define _PAGE_HUGE_SHIFT	(_PAGE_MODIFIED_SHIFT + 1)</span>
<span class="cp">#define _PAGE_HUGE		(1 &lt;&lt; _PAGE_HUGE_SHIFT)</span>
<span class="cp">#else</span>
<span class="cp">#define _PAGE_HUGE_SHIFT	(_PAGE_MODIFIED_SHIFT)</span>
<span class="cp">#define _PAGE_HUGE		({BUG(); 1; })  </span><span class="cm">/* Dummy value */</span><span class="cp"></span>
<span class="cp">#endif</span>

<span class="cm">/* Page cannot be executed */</span>
<span class="cp">#define _PAGE_NO_EXEC_SHIFT	(kernel_uses_smartmips_rixi ? _PAGE_HUGE_SHIFT + 1 : _PAGE_HUGE_SHIFT)</span>
<span class="cp">#define _PAGE_NO_EXEC		({if (!kernel_uses_smartmips_rixi) BUG(); 1 &lt;&lt; _PAGE_NO_EXEC_SHIFT; })</span>

<span class="cm">/* Page cannot be read */</span>
<span class="cp">#define _PAGE_NO_READ_SHIFT	(kernel_uses_smartmips_rixi ? _PAGE_NO_EXEC_SHIFT + 1 : _PAGE_NO_EXEC_SHIFT)</span>
<span class="cp">#define _PAGE_NO_READ		({if (!kernel_uses_smartmips_rixi) BUG(); 1 &lt;&lt; _PAGE_NO_READ_SHIFT; })</span>

<span class="cp">#define _PAGE_GLOBAL_SHIFT	(_PAGE_NO_READ_SHIFT + 1)</span>
<span class="cp">#define _PAGE_GLOBAL		(1 &lt;&lt; _PAGE_GLOBAL_SHIFT)</span>

<span class="cp">#define _PAGE_VALID_SHIFT	(_PAGE_GLOBAL_SHIFT + 1)</span>
<span class="cp">#define _PAGE_VALID		(1 &lt;&lt; _PAGE_VALID_SHIFT)</span>
<span class="cm">/* synonym                 */</span>
<span class="cp">#define _PAGE_SILENT_READ	(_PAGE_VALID)</span>

<span class="cm">/* The MIPS dirty bit      */</span>
<span class="cp">#define _PAGE_DIRTY_SHIFT	(_PAGE_VALID_SHIFT + 1)</span>
<span class="cp">#define _PAGE_DIRTY		(1 &lt;&lt; _PAGE_DIRTY_SHIFT)</span>
<span class="cp">#define _PAGE_SILENT_WRITE	(_PAGE_DIRTY)</span>

<span class="cp">#define _CACHE_SHIFT		(_PAGE_DIRTY_SHIFT + 1)</span>
<span class="cp">#define _CACHE_MASK		(7 &lt;&lt; _CACHE_SHIFT)</span>

<span class="cp">#define _PFN_SHIFT		(PAGE_SHIFT - 12 + _CACHE_SHIFT + 3)</span>

<span class="cp">#endif </span><span class="cm">/* defined(CONFIG_64BIT_PHYS_ADDR &amp;&amp; defined(CONFIG_CPU_MIPS32) */</span><span class="cp"></span>

<span class="cp">#ifndef _PFN_SHIFT</span>
<span class="cp">#define _PFN_SHIFT                  PAGE_SHIFT</span>
<span class="cp">#endif</span>
<span class="cp">#define _PFN_MASK		(~((1 &lt;&lt; (_PFN_SHIFT)) - 1))</span>

<span class="cp">#ifndef _PAGE_NO_READ</span>
<span class="cp">#define _PAGE_NO_READ ({BUG(); 0; })</span>
<span class="cp">#define _PAGE_NO_READ_SHIFT ({BUG(); 0; })</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef _PAGE_NO_EXEC</span>
<span class="cp">#define _PAGE_NO_EXEC ({BUG(); 0; })</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef _PAGE_GLOBAL_SHIFT</span>
<span class="cp">#define _PAGE_GLOBAL_SHIFT ilog2(_PAGE_GLOBAL)</span>
<span class="cp">#endif</span>


<span class="cp">#ifndef __ASSEMBLY__</span>
<span class="cm">/*</span>
<span class="cm"> * pte_to_entrylo converts a page table entry (PTE) into a Mips</span>
<span class="cm"> * entrylo0/1 value.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint64_t</span> <span class="nf">pte_to_entrylo</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pte_val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kernel_uses_smartmips_rixi</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">sa</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_32BIT</span>
		<span class="n">sa</span> <span class="o">=</span> <span class="mi">31</span> <span class="o">-</span> <span class="n">_PAGE_NO_READ_SHIFT</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">sa</span> <span class="o">=</span> <span class="mi">63</span> <span class="o">-</span> <span class="n">_PAGE_NO_READ_SHIFT</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="cm">/*</span>
<span class="cm">		 * C has no way to express that this is a DSRL</span>
<span class="cm">		 * _PAGE_NO_EXEC_SHIFT followed by a ROTR 2.  Luckily</span>
<span class="cm">		 * in the fast path this is done in assembly</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">pte_val</span> <span class="o">&gt;&gt;</span> <span class="n">_PAGE_GLOBAL_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">pte_val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">_PAGE_NO_EXEC</span> <span class="o">|</span> <span class="n">_PAGE_NO_READ</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">sa</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">pte_val</span> <span class="o">&gt;&gt;</span> <span class="n">_PAGE_GLOBAL_SHIFT</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Cache attributes</span>
<span class="cm"> */</span>
<span class="cp">#if defined(CONFIG_CPU_R3000) || defined(CONFIG_CPU_TX39XX)</span>

<span class="cp">#define _CACHE_CACHABLE_NONCOHERENT 0</span>

<span class="cp">#elif defined(CONFIG_CPU_SB1)</span>

<span class="cm">/* No penalty for being coherent on the SB1, so just</span>
<span class="cm">   use it for &quot;noncoherent&quot; spaces, too.  Shouldn&#39;t hurt. */</span>

<span class="cp">#define _CACHE_UNCACHED             (2&lt;&lt;_CACHE_SHIFT)</span>
<span class="cp">#define _CACHE_CACHABLE_COW         (5&lt;&lt;_CACHE_SHIFT)</span>
<span class="cp">#define _CACHE_CACHABLE_NONCOHERENT (5&lt;&lt;_CACHE_SHIFT)</span>
<span class="cp">#define _CACHE_UNCACHED_ACCELERATED (7&lt;&lt;_CACHE_SHIFT)</span>

<span class="cp">#elif defined(CONFIG_CPU_RM9000)</span>

<span class="cp">#define _CACHE_WT		    (0&lt;&lt;_CACHE_SHIFT)</span>
<span class="cp">#define _CACHE_WTWA		    (1&lt;&lt;_CACHE_SHIFT)</span>
<span class="cp">#define _CACHE_UC_B		    (2&lt;&lt;_CACHE_SHIFT)</span>
<span class="cp">#define _CACHE_WB		    (3&lt;&lt;_CACHE_SHIFT)</span>
<span class="cp">#define _CACHE_CWBEA		    (4&lt;&lt;_CACHE_SHIFT)</span>
<span class="cp">#define _CACHE_CWB		    (5&lt;&lt;_CACHE_SHIFT)</span>
<span class="cp">#define _CACHE_UCNB		    (6&lt;&lt;_CACHE_SHIFT)</span>
<span class="cp">#define _CACHE_FPC		    (7&lt;&lt;_CACHE_SHIFT)</span>

<span class="cp">#define _CACHE_UNCACHED		    _CACHE_UC_B</span>
<span class="cp">#define _CACHE_CACHABLE_NONCOHERENT _CACHE_WB</span>

<span class="cp">#else</span>

<span class="cp">#define _CACHE_CACHABLE_NO_WA	    (0&lt;&lt;_CACHE_SHIFT)  </span><span class="cm">/* R4600 only      */</span><span class="cp"></span>
<span class="cp">#define _CACHE_CACHABLE_WA	    (1&lt;&lt;_CACHE_SHIFT)  </span><span class="cm">/* R4600 only      */</span><span class="cp"></span>
<span class="cp">#define _CACHE_UNCACHED             (2&lt;&lt;_CACHE_SHIFT)  </span><span class="cm">/* R4[0246]00      */</span><span class="cp"></span>
<span class="cp">#define _CACHE_CACHABLE_NONCOHERENT (3&lt;&lt;_CACHE_SHIFT)  </span><span class="cm">/* R4[0246]00      */</span><span class="cp"></span>
<span class="cp">#define _CACHE_CACHABLE_CE          (4&lt;&lt;_CACHE_SHIFT)  </span><span class="cm">/* R4[04]00MC only */</span><span class="cp"></span>
<span class="cp">#define _CACHE_CACHABLE_COW         (5&lt;&lt;_CACHE_SHIFT)  </span><span class="cm">/* R4[04]00MC only */</span><span class="cp"></span>
<span class="cp">#define _CACHE_CACHABLE_COHERENT    (5&lt;&lt;_CACHE_SHIFT)  </span><span class="cm">/* MIPS32R2 CMP    */</span><span class="cp"></span>
<span class="cp">#define _CACHE_CACHABLE_CUW         (6&lt;&lt;_CACHE_SHIFT)  </span><span class="cm">/* R4[04]00MC only */</span><span class="cp"></span>
<span class="cp">#define _CACHE_UNCACHED_ACCELERATED (7&lt;&lt;_CACHE_SHIFT)  </span><span class="cm">/* R10000 only     */</span><span class="cp"></span>

<span class="cp">#endif</span>

<span class="cp">#define __READABLE	(_PAGE_SILENT_READ | _PAGE_ACCESSED | (kernel_uses_smartmips_rixi ? 0 : _PAGE_READ))</span>
<span class="cp">#define __WRITEABLE	(_PAGE_WRITE | _PAGE_SILENT_WRITE | _PAGE_MODIFIED)</span>

<span class="cp">#define _PAGE_CHG_MASK  (_PFN_MASK | _PAGE_ACCESSED | _PAGE_MODIFIED | _CACHE_MASK)</span>

<span class="cp">#endif </span><span class="cm">/* _ASM_PGTABLE_BITS_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
