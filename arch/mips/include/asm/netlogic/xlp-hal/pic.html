<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › mips › include › asm › netlogic › xlp-hal › pic.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../../index.html"></a><h1>pic.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 2003-2011 NetLogic Microsystems, Inc. (NetLogic). All rights</span>
<span class="cm"> * reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses.  You may choose to be licensed under the terms of the GNU</span>
<span class="cm"> * General Public License (GPL) Version 2, available from the file</span>
<span class="cm"> * COPYING in the main directory of this source tree, or the NetLogic</span>
<span class="cm"> * license below:</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions</span>
<span class="cm"> * are met:</span>
<span class="cm"> *</span>
<span class="cm"> * 1. Redistributions of source code must retain the above copyright</span>
<span class="cm"> *    notice, this list of conditions and the following disclaimer.</span>
<span class="cm"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<span class="cm"> *    notice, this list of conditions and the following disclaimer in</span>
<span class="cm"> *    the documentation and/or other materials provided with the</span>
<span class="cm"> *    distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED BY NETLOGIC ``AS IS&#39;&#39; AND ANY EXPRESS OR</span>
<span class="cm"> * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED</span>
<span class="cm"> * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="cm"> * ARE DISCLAIMED. IN NO EVENT SHALL NETLOGIC OR CONTRIBUTORS BE LIABLE</span>
<span class="cm"> * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
<span class="cm"> * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<span class="cm"> * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR</span>
<span class="cm"> * BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,</span>
<span class="cm"> * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE</span>
<span class="cm"> * OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN</span>
<span class="cm"> * IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm"> */</span>

<span class="cp">#ifndef _NLM_HAL_PIC_H</span>
<span class="cp">#define _NLM_HAL_PIC_H</span>

<span class="cm">/* PIC Specific registers */</span>
<span class="cp">#define PIC_CTRL                0x00</span>

<span class="cm">/* PIC control register defines */</span>
<span class="cp">#define PIC_CTRL_ITV		32 </span><span class="cm">/* interrupt timeout value */</span><span class="cp"></span>
<span class="cp">#define PIC_CTRL_ICI		19 </span><span class="cm">/* ICI interrupt timeout enable */</span><span class="cp"></span>
<span class="cp">#define PIC_CTRL_ITE		18 </span><span class="cm">/* interrupt timeout enable */</span><span class="cp"></span>
<span class="cp">#define PIC_CTRL_STE		10 </span><span class="cm">/* system timer interrupt enable */</span><span class="cp"></span>
<span class="cp">#define PIC_CTRL_WWR1		8  </span><span class="cm">/* watchdog 1 wraparound count for reset */</span><span class="cp"></span>
<span class="cp">#define PIC_CTRL_WWR0		6  </span><span class="cm">/* watchdog 0 wraparound count for reset */</span><span class="cp"></span>
<span class="cp">#define PIC_CTRL_WWN1		4  </span><span class="cm">/* watchdog 1 wraparound count for NMI */</span><span class="cp"></span>
<span class="cp">#define PIC_CTRL_WWN0		2  </span><span class="cm">/* watchdog 0 wraparound count for NMI */</span><span class="cp"></span>
<span class="cp">#define PIC_CTRL_WTE		0  </span><span class="cm">/* watchdog timer enable */</span><span class="cp"></span>

<span class="cm">/* PIC Status register defines */</span>
<span class="cp">#define PIC_ICI_STATUS		33 </span><span class="cm">/* ICI interrupt timeout status */</span><span class="cp"></span>
<span class="cp">#define PIC_ITE_STATUS		32 </span><span class="cm">/* interrupt timeout status */</span><span class="cp"></span>
<span class="cp">#define PIC_STS_STATUS		4  </span><span class="cm">/* System timer interrupt status */</span><span class="cp"></span>
<span class="cp">#define PIC_WNS_STATUS		2  </span><span class="cm">/* NMI status for watchdog timers */</span><span class="cp"></span>
<span class="cp">#define PIC_WIS_STATUS		0  </span><span class="cm">/* Interrupt status for watchdog timers */</span><span class="cp"></span>

<span class="cm">/* PIC IPI control register offsets */</span>
<span class="cp">#define PIC_IPICTRL_NMI		32</span>
<span class="cp">#define PIC_IPICTRL_RIV		20 </span><span class="cm">/* received interrupt vector */</span><span class="cp"></span>
<span class="cp">#define PIC_IPICTRL_IDB		16 </span><span class="cm">/* interrupt destination base */</span><span class="cp"></span>
<span class="cp">#define PIC_IPICTRL_DTE		 0 </span><span class="cm">/* interrupt destination thread enables */</span><span class="cp"></span>

<span class="cm">/* PIC IRT register offsets */</span>
<span class="cp">#define PIC_IRT_ENABLE		31</span>
<span class="cp">#define PIC_IRT_NMI		29</span>
<span class="cp">#define PIC_IRT_SCH		28 </span><span class="cm">/* Scheduling scheme */</span><span class="cp"></span>
<span class="cp">#define PIC_IRT_RVEC		20 </span><span class="cm">/* Interrupt receive vectors */</span><span class="cp"></span>
<span class="cp">#define PIC_IRT_DT		19 </span><span class="cm">/* Destination type */</span><span class="cp"></span>
<span class="cp">#define PIC_IRT_DB		16 </span><span class="cm">/* Destination base */</span><span class="cp"></span>
<span class="cp">#define PIC_IRT_DTE		0  </span><span class="cm">/* Destination thread enables */</span><span class="cp"></span>

<span class="cp">#define PIC_BYTESWAP            0x02</span>
<span class="cp">#define PIC_STATUS              0x04</span>
<span class="cp">#define PIC_INTR_TIMEOUT	0x06</span>
<span class="cp">#define PIC_ICI0_INTR_TIMEOUT	0x08</span>
<span class="cp">#define PIC_ICI1_INTR_TIMEOUT	0x0a</span>
<span class="cp">#define PIC_ICI2_INTR_TIMEOUT	0x0c</span>
<span class="cp">#define PIC_IPI_CTL		0x0e</span>
<span class="cp">#define PIC_INT_ACK             0x10</span>
<span class="cp">#define PIC_INT_PENDING0        0x12</span>
<span class="cp">#define PIC_INT_PENDING1        0x14</span>
<span class="cp">#define PIC_INT_PENDING2        0x16</span>

<span class="cp">#define PIC_WDOG0_MAXVAL        0x18</span>
<span class="cp">#define PIC_WDOG0_COUNT         0x1a</span>
<span class="cp">#define PIC_WDOG0_ENABLE0       0x1c</span>
<span class="cp">#define PIC_WDOG0_ENABLE1       0x1e</span>
<span class="cp">#define PIC_WDOG0_BEATCMD       0x20</span>
<span class="cp">#define PIC_WDOG0_BEAT0         0x22</span>
<span class="cp">#define PIC_WDOG0_BEAT1         0x24</span>

<span class="cp">#define PIC_WDOG1_MAXVAL        0x26</span>
<span class="cp">#define PIC_WDOG1_COUNT         0x28</span>
<span class="cp">#define PIC_WDOG1_ENABLE0       0x2a</span>
<span class="cp">#define PIC_WDOG1_ENABLE1       0x2c</span>
<span class="cp">#define PIC_WDOG1_BEATCMD       0x2e</span>
<span class="cp">#define PIC_WDOG1_BEAT0         0x30</span>
<span class="cp">#define PIC_WDOG1_BEAT1         0x32</span>

<span class="cp">#define PIC_WDOG_MAXVAL(i)      (PIC_WDOG0_MAXVAL + ((i) ? 7 : 0))</span>
<span class="cp">#define PIC_WDOG_COUNT(i)       (PIC_WDOG0_COUNT + ((i) ? 7 : 0))</span>
<span class="cp">#define PIC_WDOG_ENABLE0(i)     (PIC_WDOG0_ENABLE0 + ((i) ? 7 : 0))</span>
<span class="cp">#define PIC_WDOG_ENABLE1(i)     (PIC_WDOG0_ENABLE1 + ((i) ? 7 : 0))</span>
<span class="cp">#define PIC_WDOG_BEATCMD(i)     (PIC_WDOG0_BEATCMD + ((i) ? 7 : 0))</span>
<span class="cp">#define PIC_WDOG_BEAT0(i)       (PIC_WDOG0_BEAT0 + ((i) ? 7 : 0))</span>
<span class="cp">#define PIC_WDOG_BEAT1(i)       (PIC_WDOG0_BEAT1 + ((i) ? 7 : 0))</span>

<span class="cp">#define PIC_TIMER0_MAXVAL    0x34</span>
<span class="cp">#define PIC_TIMER1_MAXVAL    0x36</span>
<span class="cp">#define PIC_TIMER2_MAXVAL    0x38</span>
<span class="cp">#define PIC_TIMER3_MAXVAL    0x3a</span>
<span class="cp">#define PIC_TIMER4_MAXVAL    0x3c</span>
<span class="cp">#define PIC_TIMER5_MAXVAL    0x3e</span>
<span class="cp">#define PIC_TIMER6_MAXVAL    0x40</span>
<span class="cp">#define PIC_TIMER7_MAXVAL    0x42</span>
<span class="cp">#define PIC_TIMER_MAXVAL(i)  (PIC_TIMER0_MAXVAL + ((i) * 2))</span>

<span class="cp">#define PIC_TIMER0_COUNT     0x44</span>
<span class="cp">#define PIC_TIMER1_COUNT     0x46</span>
<span class="cp">#define PIC_TIMER2_COUNT     0x48</span>
<span class="cp">#define PIC_TIMER3_COUNT     0x4a</span>
<span class="cp">#define PIC_TIMER4_COUNT     0x4c</span>
<span class="cp">#define PIC_TIMER5_COUNT     0x4e</span>
<span class="cp">#define PIC_TIMER6_COUNT     0x50</span>
<span class="cp">#define PIC_TIMER7_COUNT     0x52</span>
<span class="cp">#define PIC_TIMER_COUNT(i)   (PIC_TIMER0_COUNT + ((i) * 2))</span>

<span class="cp">#define PIC_ITE0_N0_N1          0x54</span>
<span class="cp">#define PIC_ITE1_N0_N1          0x58</span>
<span class="cp">#define PIC_ITE2_N0_N1          0x5c</span>
<span class="cp">#define PIC_ITE3_N0_N1          0x60</span>
<span class="cp">#define PIC_ITE4_N0_N1          0x64</span>
<span class="cp">#define PIC_ITE5_N0_N1          0x68</span>
<span class="cp">#define PIC_ITE6_N0_N1          0x6c</span>
<span class="cp">#define PIC_ITE7_N0_N1          0x70</span>
<span class="cp">#define PIC_ITE_N0_N1(i)        (PIC_ITE0_N0_N1 + ((i) * 4))</span>

<span class="cp">#define PIC_ITE0_N2_N3          0x56</span>
<span class="cp">#define PIC_ITE1_N2_N3          0x5a</span>
<span class="cp">#define PIC_ITE2_N2_N3          0x5e</span>
<span class="cp">#define PIC_ITE3_N2_N3          0x62</span>
<span class="cp">#define PIC_ITE4_N2_N3          0x66</span>
<span class="cp">#define PIC_ITE5_N2_N3          0x6a</span>
<span class="cp">#define PIC_ITE6_N2_N3          0x6e</span>
<span class="cp">#define PIC_ITE7_N2_N3          0x72</span>
<span class="cp">#define PIC_ITE_N2_N3(i)        (PIC_ITE0_N2_N3 + ((i) * 4))</span>

<span class="cp">#define PIC_IRT0                0x74</span>
<span class="cp">#define PIC_IRT(i)              (PIC_IRT0 + ((i) * 2))</span>

<span class="cp">#define TIMER_CYCLES_MAXVAL	0xffffffffffffffffULL</span>

<span class="cm">/*</span>
<span class="cm"> *    IRT Map</span>
<span class="cm"> */</span>
<span class="cp">#define PIC_NUM_IRTS		160</span>

<span class="cp">#define PIC_IRT_WD_0_INDEX	0</span>
<span class="cp">#define PIC_IRT_WD_1_INDEX	1</span>
<span class="cp">#define PIC_IRT_WD_NMI_0_INDEX	2</span>
<span class="cp">#define PIC_IRT_WD_NMI_1_INDEX	3</span>
<span class="cp">#define PIC_IRT_TIMER_0_INDEX	4</span>
<span class="cp">#define PIC_IRT_TIMER_1_INDEX	5</span>
<span class="cp">#define PIC_IRT_TIMER_2_INDEX	6</span>
<span class="cp">#define PIC_IRT_TIMER_3_INDEX	7</span>
<span class="cp">#define PIC_IRT_TIMER_4_INDEX	8</span>
<span class="cp">#define PIC_IRT_TIMER_5_INDEX	9</span>
<span class="cp">#define PIC_IRT_TIMER_6_INDEX	10</span>
<span class="cp">#define PIC_IRT_TIMER_7_INDEX	11</span>
<span class="cp">#define PIC_IRT_CLOCK_INDEX	PIC_IRT_TIMER_7_INDEX</span>
<span class="cp">#define PIC_IRT_TIMER_INDEX(num)	((num) + PIC_IRT_TIMER_0_INDEX)</span>


<span class="cm">/* 11 and 12 */</span>
<span class="cp">#define PIC_NUM_MSG_Q_IRTS	32</span>
<span class="cp">#define PIC_IRT_MSG_Q0_INDEX	12</span>
<span class="cp">#define PIC_IRT_MSG_Q_INDEX(qid)	((qid) + PIC_IRT_MSG_Q0_INDEX)</span>
<span class="cm">/* 12 to 43 */</span>
<span class="cp">#define PIC_IRT_MSG_0_INDEX	44</span>
<span class="cp">#define PIC_IRT_MSG_1_INDEX	45</span>
<span class="cm">/* 44 and 45 */</span>
<span class="cp">#define PIC_NUM_PCIE_MSIX_IRTS	32</span>
<span class="cp">#define PIC_IRT_PCIE_MSIX_0_INDEX	46</span>
<span class="cp">#define PIC_IRT_PCIE_MSIX_INDEX(num)	((num) + PIC_IRT_PCIE_MSIX_0_INDEX)</span>
<span class="cm">/* 46 to 77 */</span>
<span class="cp">#define PIC_NUM_PCIE_LINK_IRTS		4</span>
<span class="cp">#define PIC_IRT_PCIE_LINK_0_INDEX	78</span>
<span class="cp">#define PIC_IRT_PCIE_LINK_1_INDEX	79</span>
<span class="cp">#define PIC_IRT_PCIE_LINK_2_INDEX	80</span>
<span class="cp">#define PIC_IRT_PCIE_LINK_3_INDEX	81</span>
<span class="cp">#define PIC_IRT_PCIE_LINK_INDEX(num)	((num) + PIC_IRT_PCIE_LINK_0_INDEX)</span>
<span class="cm">/* 78 to 81 */</span>
<span class="cp">#define PIC_NUM_NA_IRTS			32</span>
<span class="cm">/* 82 to 113 */</span>
<span class="cp">#define PIC_IRT_NA_0_INDEX		82</span>
<span class="cp">#define PIC_IRT_NA_INDEX(num)		((num) + PIC_IRT_NA_0_INDEX)</span>
<span class="cp">#define PIC_IRT_POE_INDEX		114</span>

<span class="cp">#define PIC_NUM_USB_IRTS		6</span>
<span class="cp">#define PIC_IRT_USB_0_INDEX		115</span>
<span class="cp">#define PIC_IRT_EHCI_0_INDEX		115</span>
<span class="cp">#define PIC_IRT_EHCI_1_INDEX		118</span>
<span class="cp">#define PIC_IRT_USB_INDEX(num)		((num) + PIC_IRT_USB_0_INDEX)</span>
<span class="cm">/* 115 to 120 */</span>
<span class="cp">#define PIC_IRT_GDX_INDEX		121</span>
<span class="cp">#define PIC_IRT_SEC_INDEX		122</span>
<span class="cp">#define PIC_IRT_RSA_INDEX		123</span>

<span class="cp">#define PIC_NUM_COMP_IRTS		4</span>
<span class="cp">#define PIC_IRT_COMP_0_INDEX		124</span>
<span class="cp">#define PIC_IRT_COMP_INDEX(num)		((num) + PIC_IRT_COMP_0_INDEX)</span>
<span class="cm">/* 124 to 127 */</span>
<span class="cp">#define PIC_IRT_GBU_INDEX		128</span>
<span class="cp">#define PIC_IRT_ICC_0_INDEX		129 </span><span class="cm">/* ICC - Inter Chip Coherency */</span><span class="cp"></span>
<span class="cp">#define PIC_IRT_ICC_1_INDEX		130</span>
<span class="cp">#define PIC_IRT_ICC_2_INDEX		131</span>
<span class="cp">#define PIC_IRT_CAM_INDEX		132</span>
<span class="cp">#define PIC_IRT_UART_0_INDEX		133</span>
<span class="cp">#define PIC_IRT_UART_1_INDEX		134</span>
<span class="cp">#define PIC_IRT_I2C_0_INDEX		135</span>
<span class="cp">#define PIC_IRT_I2C_1_INDEX		136</span>
<span class="cp">#define PIC_IRT_SYS_0_INDEX		137</span>
<span class="cp">#define PIC_IRT_SYS_1_INDEX		138</span>
<span class="cp">#define PIC_IRT_JTAG_INDEX		139</span>
<span class="cp">#define PIC_IRT_PIC_INDEX		140</span>
<span class="cp">#define PIC_IRT_NBU_INDEX		141</span>
<span class="cp">#define PIC_IRT_TCU_INDEX		142</span>
<span class="cp">#define PIC_IRT_GCU_INDEX		143 </span><span class="cm">/* GBC - Global Coherency */</span><span class="cp"></span>
<span class="cp">#define PIC_IRT_DMC_0_INDEX		144</span>
<span class="cp">#define PIC_IRT_DMC_1_INDEX		145</span>

<span class="cp">#define PIC_NUM_GPIO_IRTS		4</span>
<span class="cp">#define PIC_IRT_GPIO_0_INDEX		146</span>
<span class="cp">#define PIC_IRT_GPIO_INDEX(num)		((num) + PIC_IRT_GPIO_0_INDEX)</span>

<span class="cm">/* 146 to 149 */</span>
<span class="cp">#define PIC_IRT_NOR_INDEX		150</span>
<span class="cp">#define PIC_IRT_NAND_INDEX		151</span>
<span class="cp">#define PIC_IRT_SPI_INDEX		152</span>
<span class="cp">#define PIC_IRT_MMC_INDEX		153</span>

<span class="cp">#define PIC_CLOCK_TIMER			7</span>
<span class="cp">#define PIC_IRQ_BASE			8</span>

<span class="cp">#if !defined(LOCORE) &amp;&amp; !defined(__ASSEMBLY__)</span>

<span class="cp">#define PIC_IRT_FIRST_IRQ		(PIC_IRQ_BASE)</span>
<span class="cp">#define PIC_IRT_LAST_IRQ		63</span>
<span class="cp">#define PIC_IRQ_IS_IRT(irq)		((irq) &gt;= PIC_IRT_FIRST_IRQ)</span>

<span class="cm">/*</span>
<span class="cm"> *   Misc</span>
<span class="cm"> */</span>
<span class="cp">#define PIC_IRT_VALID			1</span>
<span class="cp">#define PIC_LOCAL_SCHEDULING		1</span>
<span class="cp">#define PIC_GLOBAL_SCHEDULING		0</span>

<span class="cp">#define nlm_read_pic_reg(b, r)	nlm_read_reg64(b, r)</span>
<span class="cp">#define nlm_write_pic_reg(b, r, v) nlm_write_reg64(b, r, v)</span>
<span class="cp">#define nlm_get_pic_pcibase(node) nlm_pcicfg_base(XLP_IO_PIC_OFFSET(node))</span>
<span class="cp">#define nlm_get_pic_regbase(node) (nlm_get_pic_pcibase(node) + XLP_IO_PCI_HDRSZ)</span>

<span class="cm">/* IRT and h/w interrupt routines */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">nlm_pic_read_irt</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irt_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">nlm_read_pic_reg</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">PIC_IRT</span><span class="p">(</span><span class="n">irt_index</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint64_t</span>
<span class="nf">nlm_pic_read_control</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">nlm_read_pic_reg</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">PIC_CTRL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">nlm_pic_write_control</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">base</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">control</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nlm_write_pic_reg</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">PIC_CTRL</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">nlm_pic_update_control</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">base</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">control</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint64_t</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nlm_read_pic_reg</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">PIC_CTRL</span><span class="p">);</span>
	<span class="n">nlm_write_pic_reg</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">PIC_CTRL</span><span class="p">,</span> <span class="n">control</span> <span class="o">|</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">nlm_set_irt_to_cpu</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint64_t</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">nlm_read_pic_reg</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">PIC_IRT</span><span class="p">(</span><span class="n">irt</span><span class="p">));</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">cpu</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">nlm_write_pic_reg</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">PIC_IRT</span><span class="p">(</span><span class="n">irt</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">nlm_pic_write_irt</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irt_num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">en</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nmi</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">sch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">db</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint64_t</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">en</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">nmi</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">sch</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">vec</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">dt</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">db</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">dte</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>

	<span class="n">nlm_write_pic_reg</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">PIC_IRT</span><span class="p">(</span><span class="n">irt_num</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">nlm_pic_write_irt_direct</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irt_num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">en</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nmi</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">sch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nlm_pic_write_irt</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">irt_num</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="n">nmi</span><span class="p">,</span> <span class="n">sch</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">(</span><span class="n">cpu</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">),</span>		<span class="cm">/* thread group */</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">));</span>	<span class="cm">/* thread mask */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint64_t</span>
<span class="nf">nlm_pic_read_timer</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">nlm_read_pic_reg</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">PIC_TIMER_COUNT</span><span class="p">(</span><span class="n">timer</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">nlm_pic_write_timer</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timer</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nlm_write_pic_reg</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">PIC_TIMER_COUNT</span><span class="p">(</span><span class="n">timer</span><span class="p">),</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">nlm_pic_set_timer</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timer</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">value</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint64_t</span> <span class="n">pic_ctrl</span> <span class="o">=</span> <span class="n">nlm_read_pic_reg</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">PIC_CTRL</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">en</span><span class="p">;</span>

	<span class="n">en</span> <span class="o">=</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nlm_write_pic_reg</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">PIC_TIMER_MAXVAL</span><span class="p">(</span><span class="n">timer</span><span class="p">),</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">nlm_pic_write_irt_direct</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">PIC_IRT_TIMER_INDEX</span><span class="p">(</span><span class="n">timer</span><span class="p">),</span>
		<span class="n">en</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

	<span class="cm">/* enable the timer */</span>
	<span class="n">pic_ctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">PIC_CTRL_STE</span> <span class="o">+</span> <span class="n">timer</span><span class="p">));</span>
	<span class="n">nlm_write_pic_reg</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">PIC_CTRL</span><span class="p">,</span> <span class="n">pic_ctrl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">nlm_pic_enable_irt</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint64_t</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">nlm_read_pic_reg</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">PIC_IRT</span><span class="p">(</span><span class="n">irt</span><span class="p">));</span>
	<span class="n">nlm_write_pic_reg</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">PIC_IRT</span><span class="p">(</span><span class="n">irt</span><span class="p">),</span> <span class="n">reg</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1u</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">nlm_pic_disable_irt</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">nlm_read_pic_reg</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">PIC_IRT</span><span class="p">(</span><span class="n">irt</span><span class="p">));</span>
	<span class="n">nlm_write_pic_reg</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">PIC_IRT</span><span class="p">(</span><span class="n">irt</span><span class="p">),</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">nlm_pic_send_ipi</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hwt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nmi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint64_t</span> <span class="n">ipi</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">node</span><span class="p">,</span> <span class="n">ncpu</span><span class="p">;</span>

	<span class="n">node</span> <span class="o">=</span> <span class="n">hwt</span> <span class="o">/</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">ncpu</span> <span class="o">=</span> <span class="n">hwt</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">ipi</span> <span class="o">=</span> <span class="p">((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">nmi</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">node</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ncpu</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ncpu</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span>
		<span class="n">ipi</span> <span class="o">|=</span> <span class="mh">0x10000</span><span class="p">;</span> <span class="cm">/* Setting bit 16 to select cpus 16-31 */</span>

	<span class="n">nlm_write_pic_reg</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">PIC_IPI_CTL</span><span class="p">,</span> <span class="n">ipi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">nlm_pic_ack</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irt_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nlm_write_pic_reg</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">PIC_INT_ACK</span><span class="p">,</span> <span class="n">irt_num</span><span class="p">);</span>

	<span class="cm">/* Ack the Status register for Watchdog &amp; System timers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irt_num</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">)</span>
		<span class="n">nlm_write_pic_reg</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">PIC_STATUS</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">irt_num</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">nlm_pic_init_irt</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hwt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nlm_pic_write_irt_direct</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">irt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">uint64_t</span> <span class="n">nlm_pic_base</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">nlm_irq_to_irt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">nlm_irt_to_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irt</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* __ASSEMBLY__ */</span><span class="cp"></span>
<span class="cp">#endif </span><span class="cm">/* _NLM_HAL_PIC_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:6}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../../javascript/docco.min.js"></script>
</html>
