<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › mips › sgi-ip22 › ip22-int.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ip22-int.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * ip22-int.c: Routines for generic manipulation of the INT[23] ASIC</span>
<span class="cm"> *             found on INDY and Indigo2 workstations.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1996 David S. Miller (davem@davemloft.net)</span>
<span class="cm"> * Copyright (C) 1997, 1998 Ralf Baechle (ralf@gnu.org)</span>
<span class="cm"> * Copyright (C) 1999 Andrew R. Baker (andrewb@uab.edu)</span>
<span class="cm"> *                    - Indigo2 changes</span>
<span class="cm"> *                    - Interrupt handling fixes</span>
<span class="cm"> * Copyright (C) 2001, 2003 Ladislav Michl (ladis@linux-mips.org)</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel_stat.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/ftrace.h&gt;</span>

<span class="cp">#include &lt;asm/irq_cpu.h&gt;</span>
<span class="cp">#include &lt;asm/sgi/hpc3.h&gt;</span>
<span class="cp">#include &lt;asm/sgi/ip22.h&gt;</span>

<span class="cm">/* So far nothing hangs here */</span>
<span class="cp">#undef USE_LIO3_IRQ</span>

<span class="k">struct</span> <span class="n">sgint_regs</span> <span class="o">*</span><span class="n">sgint</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">lc0msk_to_irqnr</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">lc1msk_to_irqnr</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">lc2msk_to_irqnr</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">lc3msk_to_irqnr</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">ip22_eisa_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">enable_local0_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* don&#39;t allow mappable interrupt to be enabled from setup_irq,</span>
<span class="cm">	 * we have our own way to do so */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">!=</span> <span class="n">SGI_MAP_0_IRQ</span><span class="p">)</span>
		<span class="n">sgint</span><span class="o">-&gt;</span><span class="n">imask0</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">SGINT_LOCAL0</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">disable_local0_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sgint</span><span class="o">-&gt;</span><span class="n">imask0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">SGINT_LOCAL0</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">ip22_local0_irq_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;IP22 local 0&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask</span>	<span class="o">=</span> <span class="n">disable_local0_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span>	<span class="o">=</span> <span class="n">enable_local0_irq</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">enable_local1_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* don&#39;t allow mappable interrupt to be enabled from setup_irq,</span>
<span class="cm">	 * we have our own way to do so */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">!=</span> <span class="n">SGI_MAP_1_IRQ</span><span class="p">)</span>
		<span class="n">sgint</span><span class="o">-&gt;</span><span class="n">imask1</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">SGINT_LOCAL1</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">disable_local1_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sgint</span><span class="o">-&gt;</span><span class="n">imask1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">SGINT_LOCAL1</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">ip22_local1_irq_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;IP22 local 1&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask</span>	<span class="o">=</span> <span class="n">disable_local1_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span>	<span class="o">=</span> <span class="n">enable_local1_irq</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">enable_local2_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sgint</span><span class="o">-&gt;</span><span class="n">imask0</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">SGI_MAP_0_IRQ</span> <span class="o">-</span> <span class="n">SGINT_LOCAL0</span><span class="p">));</span>
	<span class="n">sgint</span><span class="o">-&gt;</span><span class="n">cmeimask0</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">SGINT_LOCAL2</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">disable_local2_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sgint</span><span class="o">-&gt;</span><span class="n">cmeimask0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">SGINT_LOCAL2</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sgint</span><span class="o">-&gt;</span><span class="n">cmeimask0</span><span class="p">)</span>
		<span class="n">sgint</span><span class="o">-&gt;</span><span class="n">imask0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">SGI_MAP_0_IRQ</span> <span class="o">-</span> <span class="n">SGINT_LOCAL0</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">ip22_local2_irq_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;IP22 local 2&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask</span>	<span class="o">=</span> <span class="n">disable_local2_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span>	<span class="o">=</span> <span class="n">enable_local2_irq</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">enable_local3_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sgint</span><span class="o">-&gt;</span><span class="n">imask1</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">SGI_MAP_1_IRQ</span> <span class="o">-</span> <span class="n">SGINT_LOCAL1</span><span class="p">));</span>
	<span class="n">sgint</span><span class="o">-&gt;</span><span class="n">cmeimask1</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">SGINT_LOCAL3</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">disable_local3_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sgint</span><span class="o">-&gt;</span><span class="n">cmeimask1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">SGINT_LOCAL3</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sgint</span><span class="o">-&gt;</span><span class="n">cmeimask1</span><span class="p">)</span>
		<span class="n">sgint</span><span class="o">-&gt;</span><span class="n">imask1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">SGI_MAP_1_IRQ</span> <span class="o">-</span> <span class="n">SGINT_LOCAL1</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">ip22_local3_irq_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;IP22 local 3&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask</span>	<span class="o">=</span> <span class="n">disable_local3_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span>	<span class="o">=</span> <span class="n">enable_local3_irq</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">indy_local0_irqdispatch</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">sgint</span><span class="o">-&gt;</span><span class="n">istat0</span> <span class="o">&amp;</span> <span class="n">sgint</span><span class="o">-&gt;</span><span class="n">imask0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mask2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">SGINT_ISTAT0_LIO2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mask2</span> <span class="o">=</span> <span class="n">sgint</span><span class="o">-&gt;</span><span class="n">vmeistat</span> <span class="o">&amp;</span> <span class="n">sgint</span><span class="o">-&gt;</span><span class="n">cmeimask0</span><span class="p">;</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">lc2msk_to_irqnr</span><span class="p">[</span><span class="n">mask2</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">lc0msk_to_irqnr</span><span class="p">[</span><span class="n">mask</span><span class="p">];</span>

	<span class="cm">/* if irq == 0, then the interrupt has already been cleared */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">do_IRQ</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">indy_local1_irqdispatch</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">sgint</span><span class="o">-&gt;</span><span class="n">istat1</span> <span class="o">&amp;</span> <span class="n">sgint</span><span class="o">-&gt;</span><span class="n">imask1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mask2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">SGINT_ISTAT1_LIO3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mask2</span> <span class="o">=</span> <span class="n">sgint</span><span class="o">-&gt;</span><span class="n">vmeistat</span> <span class="o">&amp;</span> <span class="n">sgint</span><span class="o">-&gt;</span><span class="n">cmeimask1</span><span class="p">;</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">lc3msk_to_irqnr</span><span class="p">[</span><span class="n">mask2</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">lc1msk_to_irqnr</span><span class="p">[</span><span class="n">mask</span><span class="p">];</span>

	<span class="cm">/* if irq == 0, then the interrupt has already been cleared */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">do_IRQ</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">ip22_be_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__irq_entry</span> <span class="nf">indy_buserror_irq</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">SGI_BUSERR_IRQ</span><span class="p">;</span>

	<span class="n">irq_enter</span><span class="p">();</span>
	<span class="n">kstat_incr_irqs_this_cpu</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">irq_to_desc</span><span class="p">(</span><span class="n">irq</span><span class="p">));</span>
	<span class="n">ip22_be_interrupt</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">irq_exit</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irqaction</span> <span class="n">local0_cascade</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">handler</span>	<span class="o">=</span> <span class="n">no_action</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IRQF_NO_THREAD</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;local0 cascade&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irqaction</span> <span class="n">local1_cascade</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">handler</span>	<span class="o">=</span> <span class="n">no_action</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IRQF_NO_THREAD</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;local1 cascade&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irqaction</span> <span class="n">buserr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">handler</span>	<span class="o">=</span> <span class="n">no_action</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IRQF_NO_THREAD</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;Bus Error&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irqaction</span> <span class="n">map0_cascade</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">handler</span>	<span class="o">=</span> <span class="n">no_action</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IRQF_NO_THREAD</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;mapable0 cascade&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef USE_LIO3_IRQ</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">irqaction</span> <span class="n">map1_cascade</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">handler</span>	<span class="o">=</span> <span class="n">no_action</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IRQF_NO_THREAD</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;mapable1 cascade&quot;</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#define SGI_INTERRUPTS	SGINT_END</span>
<span class="cp">#else</span>
<span class="cp">#define SGI_INTERRUPTS	SGINT_LOCAL3</span>
<span class="cp">#endif</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">indy_8254timer_irq</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * IRQs on the INDY look basically (barring software IRQs which we don&#39;t use</span>
<span class="cm"> * at all) like:</span>
<span class="cm"> *</span>
<span class="cm"> *	MIPS IRQ	Source</span>
<span class="cm"> *      --------        ------</span>
<span class="cm"> *             0	Software (ignored)</span>
<span class="cm"> *             1        Software (ignored)</span>
<span class="cm"> *             2        Local IRQ level zero</span>
<span class="cm"> *             3        Local IRQ level one</span>
<span class="cm"> *             4        8254 Timer zero</span>
<span class="cm"> *             5        8254 Timer one</span>
<span class="cm"> *             6        Bus Error</span>
<span class="cm"> *             7        R4k timer (what we use)</span>
<span class="cm"> *</span>
<span class="cm"> * We handle the IRQ according to _our_ priority which is:</span>
<span class="cm"> *</span>
<span class="cm"> * Highest ----     R4k Timer</span>
<span class="cm"> *                  Local IRQ zero</span>
<span class="cm"> *                  Local IRQ one</span>
<span class="cm"> *                  Bus Error</span>
<span class="cm"> *                  8254 Timer zero</span>
<span class="cm"> * Lowest  ----     8254 Timer one</span>
<span class="cm"> *</span>
<span class="cm"> * then we just return, if multiple IRQs are pending then we will just take</span>
<span class="cm"> * another exception, big deal.</span>
<span class="cm"> */</span>

<span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">plat_irq_dispatch</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pending</span> <span class="o">=</span> <span class="n">read_c0_status</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">read_c0_cause</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * First we check for r4k counter/timer IRQ.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pending</span> <span class="o">&amp;</span> <span class="n">CAUSEF_IP7</span><span class="p">)</span>
		<span class="n">do_IRQ</span><span class="p">(</span><span class="n">SGI_TIMER_IRQ</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pending</span> <span class="o">&amp;</span> <span class="n">CAUSEF_IP2</span><span class="p">)</span>
		<span class="n">indy_local0_irqdispatch</span><span class="p">();</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pending</span> <span class="o">&amp;</span> <span class="n">CAUSEF_IP3</span><span class="p">)</span>
		<span class="n">indy_local1_irqdispatch</span><span class="p">();</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pending</span> <span class="o">&amp;</span> <span class="n">CAUSEF_IP6</span><span class="p">)</span>
		<span class="n">indy_buserror_irq</span><span class="p">();</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pending</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CAUSEF_IP4</span> <span class="o">|</span> <span class="n">CAUSEF_IP5</span><span class="p">))</span>
		<span class="n">indy_8254timer_irq</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">arch_init_irq</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Init local mask --&gt; irq tables. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lc0msk_to_irqnr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SGINT_LOCAL0</span> <span class="o">+</span> <span class="mi">7</span><span class="p">;</span>
			<span class="n">lc1msk_to_irqnr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SGINT_LOCAL1</span> <span class="o">+</span> <span class="mi">7</span><span class="p">;</span>
			<span class="n">lc2msk_to_irqnr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SGINT_LOCAL2</span> <span class="o">+</span> <span class="mi">7</span><span class="p">;</span>
			<span class="n">lc3msk_to_irqnr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SGINT_LOCAL3</span> <span class="o">+</span> <span class="mi">7</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lc0msk_to_irqnr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SGINT_LOCAL0</span> <span class="o">+</span> <span class="mi">6</span><span class="p">;</span>
			<span class="n">lc1msk_to_irqnr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SGINT_LOCAL1</span> <span class="o">+</span> <span class="mi">6</span><span class="p">;</span>
			<span class="n">lc2msk_to_irqnr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SGINT_LOCAL2</span> <span class="o">+</span> <span class="mi">6</span><span class="p">;</span>
			<span class="n">lc3msk_to_irqnr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SGINT_LOCAL3</span> <span class="o">+</span> <span class="mi">6</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lc0msk_to_irqnr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SGINT_LOCAL0</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
			<span class="n">lc1msk_to_irqnr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SGINT_LOCAL1</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
			<span class="n">lc2msk_to_irqnr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SGINT_LOCAL2</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
			<span class="n">lc3msk_to_irqnr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SGINT_LOCAL3</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lc0msk_to_irqnr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SGINT_LOCAL0</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">lc1msk_to_irqnr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SGINT_LOCAL1</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">lc2msk_to_irqnr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SGINT_LOCAL2</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">lc3msk_to_irqnr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SGINT_LOCAL3</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lc0msk_to_irqnr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SGINT_LOCAL0</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">lc1msk_to_irqnr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SGINT_LOCAL1</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">lc2msk_to_irqnr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SGINT_LOCAL2</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">lc3msk_to_irqnr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SGINT_LOCAL3</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lc0msk_to_irqnr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SGINT_LOCAL0</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">lc1msk_to_irqnr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SGINT_LOCAL1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">lc2msk_to_irqnr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SGINT_LOCAL2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">lc3msk_to_irqnr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SGINT_LOCAL3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lc0msk_to_irqnr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SGINT_LOCAL0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">lc1msk_to_irqnr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SGINT_LOCAL1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">lc2msk_to_irqnr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SGINT_LOCAL2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">lc3msk_to_irqnr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SGINT_LOCAL3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lc0msk_to_irqnr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SGINT_LOCAL0</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">lc1msk_to_irqnr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SGINT_LOCAL1</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">lc2msk_to_irqnr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SGINT_LOCAL2</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">lc3msk_to_irqnr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SGINT_LOCAL3</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">lc0msk_to_irqnr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">lc1msk_to_irqnr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">lc2msk_to_irqnr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">lc3msk_to_irqnr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Mask out all interrupts. */</span>
	<span class="n">sgint</span><span class="o">-&gt;</span><span class="n">imask0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sgint</span><span class="o">-&gt;</span><span class="n">imask1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sgint</span><span class="o">-&gt;</span><span class="n">cmeimask0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sgint</span><span class="o">-&gt;</span><span class="n">cmeimask1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* init CPU irqs */</span>
	<span class="n">mips_cpu_irq_init</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">SGINT_LOCAL0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SGI_INTERRUPTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">irq_chip</span> <span class="o">*</span><span class="n">handler</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">SGINT_LOCAL1</span><span class="p">)</span>
			<span class="n">handler</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ip22_local0_irq_type</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">SGINT_LOCAL2</span><span class="p">)</span>
			<span class="n">handler</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ip22_local1_irq_type</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">SGINT_LOCAL3</span><span class="p">)</span>
			<span class="n">handler</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ip22_local2_irq_type</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">handler</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ip22_local3_irq_type</span><span class="p">;</span>

		<span class="n">irq_set_chip_and_handler</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">handle_level_irq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* vector handler. this register the IRQ as non-sharable */</span>
	<span class="n">setup_irq</span><span class="p">(</span><span class="n">SGI_LOCAL_0_IRQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local0_cascade</span><span class="p">);</span>
	<span class="n">setup_irq</span><span class="p">(</span><span class="n">SGI_LOCAL_1_IRQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local1_cascade</span><span class="p">);</span>
	<span class="n">setup_irq</span><span class="p">(</span><span class="n">SGI_BUSERR_IRQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buserr</span><span class="p">);</span>

	<span class="cm">/* cascade in cascade. i love Indy ;-) */</span>
	<span class="n">setup_irq</span><span class="p">(</span><span class="n">SGI_MAP_0_IRQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">map0_cascade</span><span class="p">);</span>
<span class="cp">#ifdef USE_LIO3_IRQ</span>
	<span class="n">setup_irq</span><span class="p">(</span><span class="n">SGI_MAP_1_IRQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">map1_cascade</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_EISA</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip22_is_fullhouse</span><span class="p">())</span>	<span class="cm">/* Only Indigo-2 has EISA stuff */</span>
		<span class="n">ip22_eisa_init</span><span class="p">();</span>
<span class="cp">#endif</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
