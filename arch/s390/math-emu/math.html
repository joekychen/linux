<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › s390 › math-emu › math.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>math.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  arch/s390/math-emu/math.c</span>
<span class="cm"> *</span>
<span class="cm"> *  S390 version</span>
<span class="cm"> *    Copyright (C) 1999-2001 IBM Deutschland Entwicklung GmbH, IBM Corporation</span>
<span class="cm"> *    Author(s): Martin Schwidefsky (schwidefsky@de.ibm.com),</span>
<span class="cm"> *</span>
<span class="cm"> * &#39;math.c&#39; emulates IEEE instructions on a S390 processor</span>
<span class="cm"> *          that does not have the IEEE fpu (all processors before G5).</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/lowcore.h&gt;</span>

<span class="cp">#include &lt;asm/sfp-util.h&gt;</span>
<span class="cp">#include &lt;math-emu/soft-fp.h&gt;</span>
<span class="cp">#include &lt;math-emu/single.h&gt;</span>
<span class="cp">#include &lt;math-emu/double.h&gt;</span>
<span class="cp">#include &lt;math-emu/quad.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * I miss a macro to round a floating point number to the</span>
<span class="cm"> * nearest integer in the same floating point format.</span>
<span class="cm"> */</span>
<span class="cp">#define _FP_TO_FPINT_ROUND(fs, wc, X)					\</span>
<span class="cp">  do {									\</span>
<span class="cp">    switch (X##_c)							\</span>
<span class="cp">      {									\</span>
<span class="cp">      case FP_CLS_NORMAL:						\</span>
<span class="cp">        if (X##_e &gt; _FP_FRACBITS_##fs + _FP_EXPBIAS_##fs)		\</span>
<span class="cp">          { </span><span class="cm">/* floating point number has no bits after the dot. */</span><span class="cp">	\</span>
<span class="cp">          }								\</span>
<span class="cp">        else if (X##_e &lt;= _FP_FRACBITS_##fs + _FP_EXPBIAS_##fs &amp;&amp;	\</span>
<span class="cp">                 X##_e &gt; _FP_EXPBIAS_##fs)				\</span>
<span class="cp">	  { </span><span class="cm">/* some bits before the dot, some after it. */</span><span class="cp">		\</span>
<span class="cp">            _FP_FRAC_SRS_##wc(X, _FP_WFRACBITS_##fs,			\</span>
<span class="cp">                              X##_e - _FP_EXPBIAS_##fs			\</span>
<span class="cp">                              + _FP_FRACBITS_##fs);			\</span>
<span class="cp">	    _FP_ROUND(wc, X);						\</span>
<span class="cp">	    _FP_FRAC_SLL_##wc(X, X##_e - _FP_EXPBIAS_##fs		\</span>
<span class="cp">                              + _FP_FRACBITS_##fs);			\</span>
<span class="cp">          }								\</span>
<span class="cp">        else								\</span>
<span class="cp">          { </span><span class="cm">/* all bits after the dot. */</span><span class="cp">				\</span>
<span class="cp">	    FP_SET_EXCEPTION(FP_EX_INEXACT);				\</span>
<span class="cp">            X##_c = FP_CLS_ZERO;					\</span>
<span class="cp">	  }								\</span>
<span class="cp">        break;								\</span>
<span class="cp">      case FP_CLS_NAN:							\</span>
<span class="cp">      case FP_CLS_INF:							\</span>
<span class="cp">      case FP_CLS_ZERO:							\</span>
<span class="cp">        break;								\</span>
<span class="cp">      }									\</span>
<span class="cp">  } while (0)</span>

<span class="cp">#define FP_TO_FPINT_ROUND_S(X)	_FP_TO_FPINT_ROUND(S,1,X)</span>
<span class="cp">#define FP_TO_FPINT_ROUND_D(X)	_FP_TO_FPINT_ROUND(D,2,X)</span>
<span class="cp">#define FP_TO_FPINT_ROUND_Q(X)	_FP_TO_FPINT_ROUND(Q,4,X)</span>

<span class="k">typedef</span> <span class="k">union</span> <span class="p">{</span>
        <span class="kt">long</span> <span class="kt">double</span> <span class="n">ld</span><span class="p">;</span>
        <span class="k">struct</span> <span class="p">{</span>
                <span class="n">__u64</span> <span class="n">high</span><span class="p">;</span>
                <span class="n">__u64</span> <span class="n">low</span><span class="p">;</span>
        <span class="p">}</span> <span class="n">w</span><span class="p">;</span>
<span class="p">}</span> <span class="n">mathemu_ldcv</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SYSCTL</span>
<span class="kt">int</span> <span class="n">sysctl_ieee_emulation_warnings</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#define mathemu_put_user(x, p) \</span>
<span class="cp">        do { \</span>
<span class="cp">                if (put_user((x),(p))) \</span>
<span class="cp">                        return SIGSEGV; \</span>
<span class="cp">        } while (0)</span>

<span class="cp">#define mathemu_get_user(x, p) \</span>
<span class="cp">        do { \</span>
<span class="cp">                if (get_user((x),(p))) \</span>
<span class="cp">                        return SIGSEGV; \</span>
<span class="cp">        } while (0)</span>

<span class="cp">#define mathemu_copy_from_user(d, s, n)\</span>
<span class="cp">        do { \</span>
<span class="cp">                if (copy_from_user((d),(s),(n)) != 0) \</span>
<span class="cp">                        return SIGSEGV; \</span>
<span class="cp">        } while (0)</span>

<span class="cp">#define mathemu_copy_to_user(d, s, n) \</span>
<span class="cp">        do { \</span>
<span class="cp">                if (copy_to_user((d),(s),(n)) != 0) \</span>
<span class="cp">                        return SIGSEGV; \</span>
<span class="cp">        } while (0)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">display_emulation_not_implemented</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">instr</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">__u16</span> <span class="o">*</span><span class="n">location</span><span class="p">;</span>
        
<span class="cp">#ifdef CONFIG_SYSCTL</span>
        <span class="k">if</span><span class="p">(</span><span class="n">sysctl_ieee_emulation_warnings</span><span class="p">)</span>
<span class="cp">#endif</span>
        <span class="p">{</span>
                <span class="n">location</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">psw</span><span class="p">.</span><span class="n">addr</span><span class="o">-</span><span class="n">S390_lowcore</span><span class="p">.</span><span class="n">pgm_ilc</span><span class="p">);</span>
                <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s ieee fpu instruction not emulated &quot;</span>
                       <span class="s">&quot;process name: %s pid: %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                       <span class="n">instr</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
                <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s&#39;s PSW:    %08lx %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">instr</span><span class="p">,</span>
                       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">psw</span><span class="p">.</span><span class="n">mask</span><span class="p">,</span>
                       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">location</span><span class="p">);</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">emu_set_CC</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cc</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">regs</span><span class="o">-&gt;</span><span class="n">psw</span><span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">psw</span><span class="p">.</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0xFFFFCFFF</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">cc</span><span class="o">&amp;</span><span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set the condition code in the user psw.</span>
<span class="cm"> *  0 : Result is zero</span>
<span class="cm"> *  1 : Result is less than zero</span>
<span class="cm"> *  2 : Result is greater than zero</span>
<span class="cm"> *  3 : Result is NaN or INF</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">emu_set_CC_cs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">class</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sign</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">class</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">FP_CLS_NORMAL</span>:
        <span class="k">case</span> <span class="n">FP_CLS_INF</span>:
                <span class="n">emu_set_CC</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">sign</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">FP_CLS_ZERO</span>:
                <span class="n">emu_set_CC</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">FP_CLS_NAN</span>:
                <span class="n">emu_set_CC</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Add long double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_axbr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QA</span><span class="p">);</span> <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QB</span><span class="p">);</span> <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
	<span class="n">mathemu_ldcv</span> <span class="n">cvt</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">FP_UNPACK_QP</span><span class="p">(</span><span class="n">QA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">);</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">FP_UNPACK_QP</span><span class="p">(</span><span class="n">QB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">);</span>
        <span class="n">FP_ADD_Q</span><span class="p">(</span><span class="n">QR</span><span class="p">,</span> <span class="n">QA</span><span class="p">,</span> <span class="n">QB</span><span class="p">);</span>
        <span class="n">FP_PACK_QP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">,</span> <span class="n">QR</span><span class="p">);</span>
        <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span> <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span><span class="p">;</span>
        <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span> <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span><span class="p">;</span>
        <span class="n">emu_set_CC_cs</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">QR_c</span><span class="p">,</span> <span class="n">QR_s</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Add double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_adbr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DA</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DB</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
        <span class="n">FP_ADD_D</span><span class="p">(</span><span class="n">DR</span><span class="p">,</span> <span class="n">DA</span><span class="p">,</span> <span class="n">DB</span><span class="p">);</span>
	<span class="n">FP_PACK_DP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">d</span><span class="p">,</span> <span class="n">DR</span><span class="p">);</span>
        <span class="n">emu_set_CC_cs</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">DR_c</span><span class="p">,</span> <span class="n">DR_s</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Add double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_adb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DA</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DB</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DB</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
        <span class="n">FP_ADD_D</span><span class="p">(</span><span class="n">DR</span><span class="p">,</span> <span class="n">DA</span><span class="p">,</span> <span class="n">DB</span><span class="p">);</span>
	<span class="n">FP_PACK_DP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">d</span><span class="p">,</span> <span class="n">DR</span><span class="p">);</span>
        <span class="n">emu_set_CC_cs</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">DR_c</span><span class="p">,</span> <span class="n">DR_s</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Add float */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_aebr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SA</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SB</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
        <span class="n">FP_ADD_S</span><span class="p">(</span><span class="n">SR</span><span class="p">,</span> <span class="n">SA</span><span class="p">,</span> <span class="n">SB</span><span class="p">);</span>
	<span class="n">FP_PACK_SP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">f</span><span class="p">,</span> <span class="n">SR</span><span class="p">);</span>
        <span class="n">emu_set_CC_cs</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">SR_c</span><span class="p">,</span> <span class="n">SR_s</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Add float */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_aeb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SA</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SB</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SB</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
        <span class="n">FP_ADD_S</span><span class="p">(</span><span class="n">SR</span><span class="p">,</span> <span class="n">SA</span><span class="p">,</span> <span class="n">SB</span><span class="p">);</span>
	<span class="n">FP_PACK_SP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">f</span><span class="p">,</span> <span class="n">SR</span><span class="p">);</span>
        <span class="n">emu_set_CC_cs</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">SR_c</span><span class="p">,</span> <span class="n">SR_s</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Compare long double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_cxbr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QA</span><span class="p">);</span> <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QB</span><span class="p">);</span>
	<span class="n">mathemu_ldcv</span> <span class="n">cvt</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">IR</span><span class="p">;</span>

        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">FP_UNPACK_RAW_QP</span><span class="p">(</span><span class="n">QA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">);</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">FP_UNPACK_RAW_QP</span><span class="p">(</span><span class="n">QB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">);</span>
        <span class="n">FP_CMP_Q</span><span class="p">(</span><span class="n">IR</span><span class="p">,</span> <span class="n">QA</span><span class="p">,</span> <span class="n">QB</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
        <span class="cm">/*</span>
<span class="cm">         * IR == -1 if DA &lt; DB, IR == 0 if DA == DB,</span>
<span class="cm">         * IR == 1 if DA &gt; DB and IR == 3 if unorderded</span>
<span class="cm">         */</span>
        <span class="n">emu_set_CC</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="p">(</span><span class="n">IR</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="p">(</span><span class="n">IR</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="n">IR</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Compare double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_cdbr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DA</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DB</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">IR</span><span class="p">;</span>

        <span class="n">FP_UNPACK_RAW_DP</span><span class="p">(</span><span class="n">DA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
        <span class="n">FP_UNPACK_RAW_DP</span><span class="p">(</span><span class="n">DB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
        <span class="n">FP_CMP_D</span><span class="p">(</span><span class="n">IR</span><span class="p">,</span> <span class="n">DA</span><span class="p">,</span> <span class="n">DB</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
        <span class="cm">/*</span>
<span class="cm">         * IR == -1 if DA &lt; DB, IR == 0 if DA == DB,</span>
<span class="cm">         * IR == 1 if DA &gt; DB and IR == 3 if unorderded</span>
<span class="cm">         */</span>
        <span class="n">emu_set_CC</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="p">(</span><span class="n">IR</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="p">(</span><span class="n">IR</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="n">IR</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Compare double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_cdb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DA</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DB</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">IR</span><span class="p">;</span>

        <span class="n">FP_UNPACK_RAW_DP</span><span class="p">(</span><span class="n">DA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
        <span class="n">FP_UNPACK_RAW_DP</span><span class="p">(</span><span class="n">DB</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
        <span class="n">FP_CMP_D</span><span class="p">(</span><span class="n">IR</span><span class="p">,</span> <span class="n">DA</span><span class="p">,</span> <span class="n">DB</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
        <span class="cm">/*</span>
<span class="cm">         * IR == -1 if DA &lt; DB, IR == 0 if DA == DB,</span>
<span class="cm">         * IR == 1 if DA &gt; DB and IR == 3 if unorderded</span>
<span class="cm">         */</span>
        <span class="n">emu_set_CC</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="p">(</span><span class="n">IR</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="p">(</span><span class="n">IR</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="n">IR</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Compare float */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_cebr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SA</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SB</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">IR</span><span class="p">;</span>

        <span class="n">FP_UNPACK_RAW_SP</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
        <span class="n">FP_UNPACK_RAW_SP</span><span class="p">(</span><span class="n">SB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
        <span class="n">FP_CMP_S</span><span class="p">(</span><span class="n">IR</span><span class="p">,</span> <span class="n">SA</span><span class="p">,</span> <span class="n">SB</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
        <span class="cm">/*</span>
<span class="cm">         * IR == -1 if DA &lt; DB, IR == 0 if DA == DB,</span>
<span class="cm">         * IR == 1 if DA &gt; DB and IR == 3 if unorderded</span>
<span class="cm">         */</span>
        <span class="n">emu_set_CC</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="p">(</span><span class="n">IR</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="p">(</span><span class="n">IR</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="n">IR</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Compare float */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_ceb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SA</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SB</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">IR</span><span class="p">;</span>

        <span class="n">FP_UNPACK_RAW_SP</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
        <span class="n">FP_UNPACK_RAW_SP</span><span class="p">(</span><span class="n">SB</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
        <span class="n">FP_CMP_S</span><span class="p">(</span><span class="n">IR</span><span class="p">,</span> <span class="n">SA</span><span class="p">,</span> <span class="n">SB</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
        <span class="cm">/*</span>
<span class="cm">         * IR == -1 if DA &lt; DB, IR == 0 if DA == DB,</span>
<span class="cm">         * IR == 1 if DA &gt; DB and IR == 3 if unorderded</span>
<span class="cm">         */</span>
        <span class="n">emu_set_CC</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="p">(</span><span class="n">IR</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="p">(</span><span class="n">IR</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="n">IR</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Compare and signal long double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_kxbr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QA</span><span class="p">);</span> <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QB</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
	<span class="n">mathemu_ldcv</span> <span class="n">cvt</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">IR</span><span class="p">;</span>

        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">FP_UNPACK_RAW_QP</span><span class="p">(</span><span class="n">QA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">);</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">FP_UNPACK_QP</span><span class="p">(</span><span class="n">QB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">);</span>
        <span class="n">FP_CMP_Q</span><span class="p">(</span><span class="n">IR</span><span class="p">,</span> <span class="n">QA</span><span class="p">,</span> <span class="n">QB</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
        <span class="cm">/*</span>
<span class="cm">         * IR == -1 if DA &lt; DB, IR == 0 if DA == DB,</span>
<span class="cm">         * IR == 1 if DA &gt; DB and IR == 3 if unorderded</span>
<span class="cm">         */</span>
        <span class="n">emu_set_CC</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="p">(</span><span class="n">IR</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="p">(</span><span class="n">IR</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="n">IR</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">IR</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">FP_SET_EXCEPTION</span> <span class="p">(</span><span class="n">FP_EX_INVALID</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Compare and signal double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_kdbr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DA</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DB</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">IR</span><span class="p">;</span>

        <span class="n">FP_UNPACK_RAW_DP</span><span class="p">(</span><span class="n">DA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
        <span class="n">FP_UNPACK_RAW_DP</span><span class="p">(</span><span class="n">DB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
        <span class="n">FP_CMP_D</span><span class="p">(</span><span class="n">IR</span><span class="p">,</span> <span class="n">DA</span><span class="p">,</span> <span class="n">DB</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
        <span class="cm">/*</span>
<span class="cm">         * IR == -1 if DA &lt; DB, IR == 0 if DA == DB,</span>
<span class="cm">         * IR == 1 if DA &gt; DB and IR == 3 if unorderded</span>
<span class="cm">         */</span>
        <span class="n">emu_set_CC</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="p">(</span><span class="n">IR</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="p">(</span><span class="n">IR</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="n">IR</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">IR</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">FP_SET_EXCEPTION</span> <span class="p">(</span><span class="n">FP_EX_INVALID</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Compare and signal double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_kdb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DA</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DB</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">IR</span><span class="p">;</span>

        <span class="n">FP_UNPACK_RAW_DP</span><span class="p">(</span><span class="n">DA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
        <span class="n">FP_UNPACK_RAW_DP</span><span class="p">(</span><span class="n">DB</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
        <span class="n">FP_CMP_D</span><span class="p">(</span><span class="n">IR</span><span class="p">,</span> <span class="n">DA</span><span class="p">,</span> <span class="n">DB</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
        <span class="cm">/*</span>
<span class="cm">         * IR == -1 if DA &lt; DB, IR == 0 if DA == DB,</span>
<span class="cm">         * IR == 1 if DA &gt; DB and IR == 3 if unorderded</span>
<span class="cm">         */</span>
        <span class="n">emu_set_CC</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="p">(</span><span class="n">IR</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="p">(</span><span class="n">IR</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="n">IR</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">IR</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">FP_SET_EXCEPTION</span> <span class="p">(</span><span class="n">FP_EX_INVALID</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Compare and signal float */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_kebr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SA</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SB</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">IR</span><span class="p">;</span>

        <span class="n">FP_UNPACK_RAW_SP</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
        <span class="n">FP_UNPACK_RAW_SP</span><span class="p">(</span><span class="n">SB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
        <span class="n">FP_CMP_S</span><span class="p">(</span><span class="n">IR</span><span class="p">,</span> <span class="n">SA</span><span class="p">,</span> <span class="n">SB</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
        <span class="cm">/*</span>
<span class="cm">         * IR == -1 if DA &lt; DB, IR == 0 if DA == DB,</span>
<span class="cm">         * IR == 1 if DA &gt; DB and IR == 3 if unorderded</span>
<span class="cm">         */</span>
        <span class="n">emu_set_CC</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="p">(</span><span class="n">IR</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="p">(</span><span class="n">IR</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="n">IR</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">IR</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">FP_SET_EXCEPTION</span> <span class="p">(</span><span class="n">FP_EX_INVALID</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Compare and signal float */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_keb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SA</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SB</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">IR</span><span class="p">;</span>

        <span class="n">FP_UNPACK_RAW_SP</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
        <span class="n">FP_UNPACK_RAW_SP</span><span class="p">(</span><span class="n">SB</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
        <span class="n">FP_CMP_S</span><span class="p">(</span><span class="n">IR</span><span class="p">,</span> <span class="n">SA</span><span class="p">,</span> <span class="n">SB</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
        <span class="cm">/*</span>
<span class="cm">         * IR == -1 if DA &lt; DB, IR == 0 if DA == DB,</span>
<span class="cm">         * IR == 1 if DA &gt; DB and IR == 3 if unorderded</span>
<span class="cm">         */</span>
        <span class="n">emu_set_CC</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="p">(</span><span class="n">IR</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="p">(</span><span class="n">IR</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="n">IR</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">IR</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">FP_SET_EXCEPTION</span> <span class="p">(</span><span class="n">FP_EX_INVALID</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Convert from fixed long double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_cxfbr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
	<span class="n">mathemu_ldcv</span> <span class="n">cvt</span><span class="p">;</span>
        <span class="n">__s32</span> <span class="n">si</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">si</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gprs</span><span class="p">[</span><span class="n">ry</span><span class="p">];</span>
        <span class="n">FP_FROM_INT_Q</span><span class="p">(</span><span class="n">QR</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
        <span class="n">FP_PACK_QP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">,</span> <span class="n">QR</span><span class="p">);</span>
        <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span> <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span><span class="p">;</span>
        <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span> <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Convert from fixed double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_cdfbr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="n">__s32</span> <span class="n">si</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">si</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gprs</span><span class="p">[</span><span class="n">ry</span><span class="p">];</span>
        <span class="n">FP_FROM_INT_D</span><span class="p">(</span><span class="n">DR</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
        <span class="n">FP_PACK_DP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">d</span><span class="p">,</span> <span class="n">DR</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Convert from fixed float */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_cefbr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="n">__s32</span> <span class="n">si</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">si</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gprs</span><span class="p">[</span><span class="n">ry</span><span class="p">];</span>
        <span class="n">FP_FROM_INT_S</span><span class="p">(</span><span class="n">SR</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
        <span class="n">FP_PACK_SP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">f</span><span class="p">,</span> <span class="n">SR</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Convert to fixed long double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_cfxbr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QA</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
	<span class="n">mathemu_ldcv</span> <span class="n">cvt</span><span class="p">;</span>
        <span class="n">__s32</span> <span class="n">si</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">FP_RND_NEAREST</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">FP_UNPACK_QP</span><span class="p">(</span><span class="n">QA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">);</span>
        <span class="n">FP_TO_INT_ROUND_Q</span><span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">QA</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gprs</span><span class="p">[</span><span class="n">rx</span><span class="p">]</span> <span class="o">=</span> <span class="n">si</span><span class="p">;</span>
        <span class="n">emu_set_CC_cs</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">QA_c</span><span class="p">,</span> <span class="n">QA_s</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Convert to fixed double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_cfdbr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DA</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="n">__s32</span> <span class="n">si</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">FP_RND_NEAREST</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
        <span class="n">FP_TO_INT_ROUND_D</span><span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">DA</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gprs</span><span class="p">[</span><span class="n">rx</span><span class="p">]</span> <span class="o">=</span> <span class="n">si</span><span class="p">;</span>
        <span class="n">emu_set_CC_cs</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">DA_c</span><span class="p">,</span> <span class="n">DA_s</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Convert to fixed float */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_cfebr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SA</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="n">__s32</span> <span class="n">si</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">FP_RND_NEAREST</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
        <span class="n">FP_TO_INT_ROUND_S</span><span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">SA</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gprs</span><span class="p">[</span><span class="n">rx</span><span class="p">]</span> <span class="o">=</span> <span class="n">si</span><span class="p">;</span>
        <span class="n">emu_set_CC_cs</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">SA_c</span><span class="p">,</span> <span class="n">SA_s</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Divide long double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_dxbr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QA</span><span class="p">);</span> <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QB</span><span class="p">);</span> <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
	<span class="n">mathemu_ldcv</span> <span class="n">cvt</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">FP_UNPACK_QP</span><span class="p">(</span><span class="n">QA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">);</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">FP_UNPACK_QP</span><span class="p">(</span><span class="n">QB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">);</span>
        <span class="n">FP_DIV_Q</span><span class="p">(</span><span class="n">QR</span><span class="p">,</span> <span class="n">QA</span><span class="p">,</span> <span class="n">QB</span><span class="p">);</span>
        <span class="n">FP_PACK_QP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">,</span> <span class="n">QR</span><span class="p">);</span>
        <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span> <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span><span class="p">;</span>
        <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span> <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Divide double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_ddbr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DA</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DB</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
        <span class="n">FP_DIV_D</span><span class="p">(</span><span class="n">DR</span><span class="p">,</span> <span class="n">DA</span><span class="p">,</span> <span class="n">DB</span><span class="p">);</span>
	<span class="n">FP_PACK_DP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">d</span><span class="p">,</span> <span class="n">DR</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Divide double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_ddb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DA</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DB</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DB</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
        <span class="n">FP_DIV_D</span><span class="p">(</span><span class="n">DR</span><span class="p">,</span> <span class="n">DA</span><span class="p">,</span> <span class="n">DB</span><span class="p">);</span>
	<span class="n">FP_PACK_DP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">d</span><span class="p">,</span> <span class="n">DR</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Divide float */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_debr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SA</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SB</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
        <span class="n">FP_DIV_S</span><span class="p">(</span><span class="n">SR</span><span class="p">,</span> <span class="n">SA</span><span class="p">,</span> <span class="n">SB</span><span class="p">);</span>
	<span class="n">FP_PACK_SP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">f</span><span class="p">,</span> <span class="n">SR</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Divide float */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_deb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SA</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SB</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SB</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
        <span class="n">FP_DIV_S</span><span class="p">(</span><span class="n">SR</span><span class="p">,</span> <span class="n">SA</span><span class="p">,</span> <span class="n">SB</span><span class="p">);</span>
	<span class="n">FP_PACK_SP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">f</span><span class="p">,</span> <span class="n">SR</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Divide to integer double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_didbr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">display_emulation_not_implemented</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="s">&quot;didbr&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Divide to integer float */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_diebr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">display_emulation_not_implemented</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="s">&quot;diebr&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Extract fpc */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_efpc</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gprs</span><span class="p">[</span><span class="n">rx</span><span class="p">]</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span><span class="p">;</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Load and test long double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_ltxbr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">s390_fp_regs</span> <span class="o">*</span><span class="n">fp_regs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">;</span>
	<span class="n">mathemu_ldcv</span> <span class="n">cvt</span><span class="p">;</span>
        <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QA</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>

        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">FP_UNPACK_QP</span><span class="p">(</span><span class="n">QA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">);</span>
        <span class="n">fp_regs</span><span class="o">-&gt;</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span> <span class="n">fp_regs</span><span class="o">-&gt;</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">fp_regs</span><span class="o">-&gt;</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span> <span class="n">fp_regs</span><span class="o">-&gt;</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">emu_set_CC_cs</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">QA_c</span><span class="p">,</span> <span class="n">QA_s</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Load and test double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_ltdbr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">s390_fp_regs</span> <span class="o">*</span><span class="n">fp_regs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">;</span>
        <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DA</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>

        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fp_regs</span><span class="o">-&gt;</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
        <span class="n">fp_regs</span><span class="o">-&gt;</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span> <span class="n">fp_regs</span><span class="o">-&gt;</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">emu_set_CC_cs</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">DA_c</span><span class="p">,</span> <span class="n">DA_s</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Load and test double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_ltebr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">s390_fp_regs</span> <span class="o">*</span><span class="n">fp_regs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">;</span>
        <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SA</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>

        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fp_regs</span><span class="o">-&gt;</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
        <span class="n">fp_regs</span><span class="o">-&gt;</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span> <span class="n">fp_regs</span><span class="o">-&gt;</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">emu_set_CC_cs</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">SA_c</span><span class="p">,</span> <span class="n">SA_s</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Load complement long double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_lcxbr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QA</span><span class="p">);</span> <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
	<span class="n">mathemu_ldcv</span> <span class="n">cvt</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">FP_UNPACK_QP</span><span class="p">(</span><span class="n">QA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">);</span>
	<span class="n">FP_NEG_Q</span><span class="p">(</span><span class="n">QR</span><span class="p">,</span> <span class="n">QA</span><span class="p">);</span>
        <span class="n">FP_PACK_QP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">,</span> <span class="n">QR</span><span class="p">);</span>
        <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span> <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span><span class="p">;</span>
        <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span> <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span><span class="p">;</span>
        <span class="n">emu_set_CC_cs</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">QR_c</span><span class="p">,</span> <span class="n">QR_s</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Load complement double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_lcdbr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DA</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
	<span class="n">FP_NEG_D</span><span class="p">(</span><span class="n">DR</span><span class="p">,</span> <span class="n">DA</span><span class="p">);</span>
	<span class="n">FP_PACK_DP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">d</span><span class="p">,</span> <span class="n">DR</span><span class="p">);</span>
        <span class="n">emu_set_CC_cs</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">DR_c</span><span class="p">,</span> <span class="n">DR_s</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Load complement float */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_lcebr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SA</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
	<span class="n">FP_NEG_S</span><span class="p">(</span><span class="n">SR</span><span class="p">,</span> <span class="n">SA</span><span class="p">);</span>
	<span class="n">FP_PACK_SP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">f</span><span class="p">,</span> <span class="n">SR</span><span class="p">);</span>
        <span class="n">emu_set_CC_cs</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">SR_c</span><span class="p">,</span> <span class="n">SR_s</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Load floating point integer long double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_fixbr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">s390_fp_regs</span> <span class="o">*</span><span class="n">fp_regs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">;</span>
        <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QA</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
	<span class="n">mathemu_ldcv</span> <span class="n">cvt</span><span class="p">;</span>
        <span class="n">__s32</span> <span class="n">si</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">fp_regs</span><span class="o">-&gt;</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">FP_RND_NEAREST</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">fp_regs</span><span class="o">-&gt;</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span> <span class="o">=</span> <span class="n">fp_regs</span><span class="o">-&gt;</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">FP_UNPACK_QP</span><span class="p">(</span><span class="n">QA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">);</span>
	<span class="n">FP_TO_FPINT_ROUND_Q</span><span class="p">(</span><span class="n">QA</span><span class="p">);</span>
	<span class="n">FP_PACK_QP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">,</span> <span class="n">QA</span><span class="p">);</span>
	<span class="n">fp_regs</span><span class="o">-&gt;</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span> <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span><span class="p">;</span>
	<span class="n">fp_regs</span><span class="o">-&gt;</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span> <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Load floating point integer double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_fidbr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* FIXME: rounding mode !! */</span>
        <span class="n">s390_fp_regs</span> <span class="o">*</span><span class="n">fp_regs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">;</span>
        <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DA</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="n">__s32</span> <span class="n">si</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">fp_regs</span><span class="o">-&gt;</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">FP_RND_NEAREST</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fp_regs</span><span class="o">-&gt;</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
	<span class="n">FP_TO_FPINT_ROUND_D</span><span class="p">(</span><span class="n">DA</span><span class="p">);</span>
	<span class="n">FP_PACK_DP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp_regs</span><span class="o">-&gt;</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">d</span><span class="p">,</span> <span class="n">DA</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Load floating point integer float */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_fiebr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">s390_fp_regs</span> <span class="o">*</span><span class="n">fp_regs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">;</span>
        <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SA</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="n">__s32</span> <span class="n">si</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">fp_regs</span><span class="o">-&gt;</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">FP_RND_NEAREST</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fp_regs</span><span class="o">-&gt;</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
	<span class="n">FP_TO_FPINT_ROUND_S</span><span class="p">(</span><span class="n">SA</span><span class="p">);</span>
	<span class="n">FP_PACK_SP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp_regs</span><span class="o">-&gt;</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">f</span><span class="p">,</span> <span class="n">SA</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Load lengthened double to long double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_lxdbr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DA</span><span class="p">);</span> <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QR</span><span class="p">);</span>
	<span class="n">FP_DECL_EX</span><span class="p">;</span>
	<span class="n">mathemu_ldcv</span> <span class="n">cvt</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
	<span class="n">FP_CONV</span> <span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">QR</span><span class="p">,</span> <span class="n">DA</span><span class="p">);</span>
        <span class="n">FP_PACK_QP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">,</span> <span class="n">QR</span><span class="p">);</span>
        <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span> <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span><span class="p">;</span>
        <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span> <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Load lengthened double to long double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_lxdb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DA</span><span class="p">);</span> <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QR</span><span class="p">);</span>
	<span class="n">FP_DECL_EX</span><span class="p">;</span>
	<span class="n">mathemu_ldcv</span> <span class="n">cvt</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">FP_CONV</span> <span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">QR</span><span class="p">,</span> <span class="n">DA</span><span class="p">);</span>
        <span class="n">FP_PACK_QP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">,</span> <span class="n">QR</span><span class="p">);</span>
        <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span> <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span><span class="p">;</span>
        <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span> <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Load lengthened float to long double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_lxebr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SA</span><span class="p">);</span> <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QR</span><span class="p">);</span>
	<span class="n">FP_DECL_EX</span><span class="p">;</span>
	<span class="n">mathemu_ldcv</span> <span class="n">cvt</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
	<span class="n">FP_CONV</span> <span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">QR</span><span class="p">,</span> <span class="n">SA</span><span class="p">);</span>
        <span class="n">FP_PACK_QP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">,</span> <span class="n">QR</span><span class="p">);</span>
        <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span> <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span><span class="p">;</span>
        <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span> <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Load lengthened float to long double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_lxeb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SA</span><span class="p">);</span> <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QR</span><span class="p">);</span>
	<span class="n">FP_DECL_EX</span><span class="p">;</span>
	<span class="n">mathemu_ldcv</span> <span class="n">cvt</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">FP_CONV</span> <span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">QR</span><span class="p">,</span> <span class="n">SA</span><span class="p">);</span>
        <span class="n">FP_PACK_QP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">,</span> <span class="n">QR</span><span class="p">);</span>
        <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span> <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span><span class="p">;</span>
        <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span> <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Load lengthened float to double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_ldebr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SA</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DR</span><span class="p">);</span>
	<span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
	<span class="n">FP_CONV</span> <span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DR</span><span class="p">,</span> <span class="n">SA</span><span class="p">);</span>
	<span class="n">FP_PACK_DP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">d</span><span class="p">,</span> <span class="n">DR</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Load lengthened float to double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_ldeb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SA</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DR</span><span class="p">);</span>
	<span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">FP_CONV</span> <span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DR</span><span class="p">,</span> <span class="n">SA</span><span class="p">);</span>
	<span class="n">FP_PACK_DP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">d</span><span class="p">,</span> <span class="n">DR</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Load negative long double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_lnxbr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QA</span><span class="p">);</span> <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QR</span><span class="p">);</span>
	<span class="n">FP_DECL_EX</span><span class="p">;</span>
	<span class="n">mathemu_ldcv</span> <span class="n">cvt</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">FP_UNPACK_QP</span><span class="p">(</span><span class="n">QA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">QA_s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FP_NEG_Q</span><span class="p">(</span><span class="n">QR</span><span class="p">,</span> <span class="n">QA</span><span class="p">);</span>
		<span class="n">FP_PACK_QP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">,</span> <span class="n">QR</span><span class="p">);</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span> <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span><span class="p">;</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span> <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span>
			<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span>
			<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">emu_set_CC_cs</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">QR_c</span><span class="p">,</span> <span class="n">QR_s</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Load negative double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_lndbr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DA</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DR</span><span class="p">);</span>
	<span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">DA_s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FP_NEG_D</span><span class="p">(</span><span class="n">DR</span><span class="p">,</span> <span class="n">DA</span><span class="p">);</span>
		<span class="n">FP_PACK_DP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">d</span><span class="p">,</span> <span class="n">DR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span>
			<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
	<span class="n">emu_set_CC_cs</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">DR_c</span><span class="p">,</span> <span class="n">DR_s</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Load negative float */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_lnebr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SA</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SR</span><span class="p">);</span>
	<span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">SA_s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FP_NEG_S</span><span class="p">(</span><span class="n">SR</span><span class="p">,</span> <span class="n">SA</span><span class="p">);</span>
		<span class="n">FP_PACK_SP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">f</span><span class="p">,</span> <span class="n">SR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span>
			<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
	<span class="n">emu_set_CC_cs</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">SR_c</span><span class="p">,</span> <span class="n">SR_s</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Load positive long double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_lpxbr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QA</span><span class="p">);</span> <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QR</span><span class="p">);</span>
	<span class="n">FP_DECL_EX</span><span class="p">;</span>
	<span class="n">mathemu_ldcv</span> <span class="n">cvt</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">FP_UNPACK_QP</span><span class="p">(</span><span class="n">QA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">QA_s</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FP_NEG_Q</span><span class="p">(</span><span class="n">QR</span><span class="p">,</span> <span class="n">QA</span><span class="p">);</span>
		<span class="n">FP_PACK_QP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">,</span> <span class="n">QR</span><span class="p">);</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span> <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span><span class="p">;</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span> <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span><span class="p">{</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span>
			<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span>
			<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">emu_set_CC_cs</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">QR_c</span><span class="p">,</span> <span class="n">QR_s</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Load positive double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_lpdbr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DA</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DR</span><span class="p">);</span>
	<span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">DA_s</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FP_NEG_D</span><span class="p">(</span><span class="n">DR</span><span class="p">,</span> <span class="n">DA</span><span class="p">);</span>
		<span class="n">FP_PACK_DP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">d</span><span class="p">,</span> <span class="n">DR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span>
			<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
	<span class="n">emu_set_CC_cs</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">DR_c</span><span class="p">,</span> <span class="n">DR_s</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Load positive float */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_lpebr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SA</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SR</span><span class="p">);</span>
	<span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">SA_s</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FP_NEG_S</span><span class="p">(</span><span class="n">SR</span><span class="p">,</span> <span class="n">SA</span><span class="p">);</span>
		<span class="n">FP_PACK_SP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">f</span><span class="p">,</span> <span class="n">SR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span>
			<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
	<span class="n">emu_set_CC_cs</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">SR_c</span><span class="p">,</span> <span class="n">SR_s</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Load rounded long double to double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_ldxbr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QA</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DR</span><span class="p">);</span>
	<span class="n">FP_DECL_EX</span><span class="p">;</span>
	<span class="n">mathemu_ldcv</span> <span class="n">cvt</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">FP_UNPACK_QP</span><span class="p">(</span><span class="n">QA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">);</span>
	<span class="n">FP_CONV</span> <span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">DR</span><span class="p">,</span> <span class="n">QA</span><span class="p">);</span>
	<span class="n">FP_PACK_DP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">f</span><span class="p">,</span> <span class="n">DR</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Load rounded long double to float */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_lexbr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QA</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SR</span><span class="p">);</span>
	<span class="n">FP_DECL_EX</span><span class="p">;</span>
	<span class="n">mathemu_ldcv</span> <span class="n">cvt</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">FP_UNPACK_QP</span><span class="p">(</span><span class="n">QA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">);</span>
	<span class="n">FP_CONV</span> <span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">SR</span><span class="p">,</span> <span class="n">QA</span><span class="p">);</span>
	<span class="n">FP_PACK_SP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">f</span><span class="p">,</span> <span class="n">SR</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Load rounded double to float */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_ledbr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DA</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SR</span><span class="p">);</span>
	<span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
	<span class="n">FP_CONV</span> <span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">SR</span><span class="p">,</span> <span class="n">DA</span><span class="p">);</span>
	<span class="n">FP_PACK_SP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">f</span><span class="p">,</span> <span class="n">SR</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Multiply long double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_mxbr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QA</span><span class="p">);</span> <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QB</span><span class="p">);</span> <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
	<span class="n">mathemu_ldcv</span> <span class="n">cvt</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">FP_UNPACK_QP</span><span class="p">(</span><span class="n">QA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">);</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">FP_UNPACK_QP</span><span class="p">(</span><span class="n">QB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">);</span>
        <span class="n">FP_MUL_Q</span><span class="p">(</span><span class="n">QR</span><span class="p">,</span> <span class="n">QA</span><span class="p">,</span> <span class="n">QB</span><span class="p">);</span>
        <span class="n">FP_PACK_QP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">,</span> <span class="n">QR</span><span class="p">);</span>
        <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span> <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span><span class="p">;</span>
        <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span> <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Multiply double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_mdbr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DA</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DB</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
        <span class="n">FP_MUL_D</span><span class="p">(</span><span class="n">DR</span><span class="p">,</span> <span class="n">DA</span><span class="p">,</span> <span class="n">DB</span><span class="p">);</span>
	<span class="n">FP_PACK_DP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">d</span><span class="p">,</span> <span class="n">DR</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Multiply double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_mdb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DA</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DB</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DB</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
        <span class="n">FP_MUL_D</span><span class="p">(</span><span class="n">DR</span><span class="p">,</span> <span class="n">DA</span><span class="p">,</span> <span class="n">DB</span><span class="p">);</span>
	<span class="n">FP_PACK_DP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">d</span><span class="p">,</span> <span class="n">DR</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Multiply double to long double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_mxdbr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DA</span><span class="p">);</span> <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QA</span><span class="p">);</span> <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QB</span><span class="p">);</span> <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QR</span><span class="p">);</span>
	<span class="n">FP_DECL_EX</span><span class="p">;</span>
	<span class="n">mathemu_ldcv</span> <span class="n">cvt</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
	<span class="n">FP_CONV</span> <span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">QA</span><span class="p">,</span> <span class="n">DA</span><span class="p">);</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
	<span class="n">FP_CONV</span> <span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">QB</span><span class="p">,</span> <span class="n">DA</span><span class="p">);</span>
        <span class="n">FP_MUL_Q</span><span class="p">(</span><span class="n">QR</span><span class="p">,</span> <span class="n">QA</span><span class="p">,</span> <span class="n">QB</span><span class="p">);</span>
        <span class="n">FP_PACK_QP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">,</span> <span class="n">QR</span><span class="p">);</span>
        <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span> <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span><span class="p">;</span>
        <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span> <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Multiply double to long double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_mxdb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">long</span> <span class="kt">double</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QA</span><span class="p">);</span> <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QB</span><span class="p">);</span> <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
	<span class="n">mathemu_ldcv</span> <span class="n">cvt</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">FP_UNPACK_QP</span><span class="p">(</span><span class="n">QA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">);</span>
        <span class="n">FP_UNPACK_QP</span><span class="p">(</span><span class="n">QB</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
        <span class="n">FP_MUL_Q</span><span class="p">(</span><span class="n">QR</span><span class="p">,</span> <span class="n">QA</span><span class="p">,</span> <span class="n">QB</span><span class="p">);</span>
        <span class="n">FP_PACK_QP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">,</span> <span class="n">QR</span><span class="p">);</span>
        <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span> <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span><span class="p">;</span>
        <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span> <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Multiply float */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_meebr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SA</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SB</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
        <span class="n">FP_MUL_S</span><span class="p">(</span><span class="n">SR</span><span class="p">,</span> <span class="n">SA</span><span class="p">,</span> <span class="n">SB</span><span class="p">);</span>
	<span class="n">FP_PACK_SP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">f</span><span class="p">,</span> <span class="n">SR</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Multiply float */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_meeb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SA</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SB</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SB</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
        <span class="n">FP_MUL_S</span><span class="p">(</span><span class="n">SR</span><span class="p">,</span> <span class="n">SA</span><span class="p">,</span> <span class="n">SB</span><span class="p">);</span>
	<span class="n">FP_PACK_SP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">f</span><span class="p">,</span> <span class="n">SR</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Multiply float to double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_mdebr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SA</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DA</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DB</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DR</span><span class="p">);</span>
	<span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
	<span class="n">FP_CONV</span> <span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DA</span><span class="p">,</span> <span class="n">SA</span><span class="p">);</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
	<span class="n">FP_CONV</span> <span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DB</span><span class="p">,</span> <span class="n">SA</span><span class="p">);</span>
        <span class="n">FP_MUL_D</span><span class="p">(</span><span class="n">DR</span><span class="p">,</span> <span class="n">DA</span><span class="p">,</span> <span class="n">DB</span><span class="p">);</span>
	<span class="n">FP_PACK_DP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">d</span><span class="p">,</span> <span class="n">DR</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Multiply float to double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_mdeb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SA</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DA</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DB</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DR</span><span class="p">);</span>
	<span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
	<span class="n">FP_CONV</span> <span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DA</span><span class="p">,</span> <span class="n">SA</span><span class="p">);</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">FP_CONV</span> <span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DB</span><span class="p">,</span> <span class="n">SA</span><span class="p">);</span>
        <span class="n">FP_MUL_D</span><span class="p">(</span><span class="n">DR</span><span class="p">,</span> <span class="n">DA</span><span class="p">,</span> <span class="n">DB</span><span class="p">);</span>
	<span class="n">FP_PACK_DP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">d</span><span class="p">,</span> <span class="n">DR</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Multiply and add double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_madbr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rz</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DA</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DB</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DC</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rz</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
        <span class="n">FP_MUL_D</span><span class="p">(</span><span class="n">DR</span><span class="p">,</span> <span class="n">DA</span><span class="p">,</span> <span class="n">DB</span><span class="p">);</span>
        <span class="n">FP_ADD_D</span><span class="p">(</span><span class="n">DR</span><span class="p">,</span> <span class="n">DR</span><span class="p">,</span> <span class="n">DC</span><span class="p">);</span>
	<span class="n">FP_PACK_DP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rz</span><span class="p">].</span><span class="n">d</span><span class="p">,</span> <span class="n">DR</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Multiply and add double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_madb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rz</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DA</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DB</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DC</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DB</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rz</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
        <span class="n">FP_MUL_D</span><span class="p">(</span><span class="n">DR</span><span class="p">,</span> <span class="n">DA</span><span class="p">,</span> <span class="n">DB</span><span class="p">);</span>
        <span class="n">FP_ADD_D</span><span class="p">(</span><span class="n">DR</span><span class="p">,</span> <span class="n">DR</span><span class="p">,</span> <span class="n">DC</span><span class="p">);</span>
	<span class="n">FP_PACK_DP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rz</span><span class="p">].</span><span class="n">d</span><span class="p">,</span> <span class="n">DR</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Multiply and add float */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_maebr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rz</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SA</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SB</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SC</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rz</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
        <span class="n">FP_MUL_S</span><span class="p">(</span><span class="n">SR</span><span class="p">,</span> <span class="n">SA</span><span class="p">,</span> <span class="n">SB</span><span class="p">);</span>
        <span class="n">FP_ADD_S</span><span class="p">(</span><span class="n">SR</span><span class="p">,</span> <span class="n">SR</span><span class="p">,</span> <span class="n">SC</span><span class="p">);</span>
	<span class="n">FP_PACK_SP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rz</span><span class="p">].</span><span class="n">f</span><span class="p">,</span> <span class="n">SR</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Multiply and add float */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_maeb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rz</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SA</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SB</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SC</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SB</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rz</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
        <span class="n">FP_MUL_S</span><span class="p">(</span><span class="n">SR</span><span class="p">,</span> <span class="n">SA</span><span class="p">,</span> <span class="n">SB</span><span class="p">);</span>
        <span class="n">FP_ADD_S</span><span class="p">(</span><span class="n">SR</span><span class="p">,</span> <span class="n">SR</span><span class="p">,</span> <span class="n">SC</span><span class="p">);</span>
	<span class="n">FP_PACK_SP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rz</span><span class="p">].</span><span class="n">f</span><span class="p">,</span> <span class="n">SR</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Multiply and subtract double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_msdbr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rz</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DA</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DB</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DC</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rz</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
        <span class="n">FP_MUL_D</span><span class="p">(</span><span class="n">DR</span><span class="p">,</span> <span class="n">DA</span><span class="p">,</span> <span class="n">DB</span><span class="p">);</span>
        <span class="n">FP_SUB_D</span><span class="p">(</span><span class="n">DR</span><span class="p">,</span> <span class="n">DR</span><span class="p">,</span> <span class="n">DC</span><span class="p">);</span>
	<span class="n">FP_PACK_DP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rz</span><span class="p">].</span><span class="n">d</span><span class="p">,</span> <span class="n">DR</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Multiply and subtract double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_msdb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rz</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DA</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DB</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DC</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DB</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rz</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
        <span class="n">FP_MUL_D</span><span class="p">(</span><span class="n">DR</span><span class="p">,</span> <span class="n">DA</span><span class="p">,</span> <span class="n">DB</span><span class="p">);</span>
        <span class="n">FP_SUB_D</span><span class="p">(</span><span class="n">DR</span><span class="p">,</span> <span class="n">DR</span><span class="p">,</span> <span class="n">DC</span><span class="p">);</span>
	<span class="n">FP_PACK_DP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rz</span><span class="p">].</span><span class="n">d</span><span class="p">,</span> <span class="n">DR</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Multiply and subtract float */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_msebr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rz</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SA</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SB</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SC</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rz</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
        <span class="n">FP_MUL_S</span><span class="p">(</span><span class="n">SR</span><span class="p">,</span> <span class="n">SA</span><span class="p">,</span> <span class="n">SB</span><span class="p">);</span>
        <span class="n">FP_SUB_S</span><span class="p">(</span><span class="n">SR</span><span class="p">,</span> <span class="n">SR</span><span class="p">,</span> <span class="n">SC</span><span class="p">);</span>
	<span class="n">FP_PACK_SP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rz</span><span class="p">].</span><span class="n">f</span><span class="p">,</span> <span class="n">SR</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Multiply and subtract float */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_mseb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rz</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SA</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SB</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SC</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SB</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rz</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
        <span class="n">FP_MUL_S</span><span class="p">(</span><span class="n">SR</span><span class="p">,</span> <span class="n">SA</span><span class="p">,</span> <span class="n">SB</span><span class="p">);</span>
        <span class="n">FP_SUB_S</span><span class="p">(</span><span class="n">SR</span><span class="p">,</span> <span class="n">SR</span><span class="p">,</span> <span class="n">SC</span><span class="p">);</span>
	<span class="n">FP_PACK_SP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rz</span><span class="p">].</span><span class="n">f</span><span class="p">,</span> <span class="n">SR</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Set floating point control word */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_sfpc</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">__u32</span> <span class="n">temp</span><span class="p">;</span>

        <span class="n">temp</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gprs</span><span class="p">[</span><span class="n">rx</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FPC_VALID_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SIGILL</span><span class="p">;</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Square root long double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_sqxbr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QA</span><span class="p">);</span> <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
	<span class="n">mathemu_ldcv</span> <span class="n">cvt</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">FP_UNPACK_QP</span><span class="p">(</span><span class="n">QA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">);</span>
	<span class="n">FP_SQRT_Q</span><span class="p">(</span><span class="n">QR</span><span class="p">,</span> <span class="n">QA</span><span class="p">);</span>
        <span class="n">FP_PACK_QP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">,</span> <span class="n">QR</span><span class="p">);</span>
        <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span> <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span><span class="p">;</span>
        <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span> <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span><span class="p">;</span>
        <span class="n">emu_set_CC_cs</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">QR_c</span><span class="p">,</span> <span class="n">QR_s</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Square root double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_sqdbr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DA</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
	<span class="n">FP_SQRT_D</span><span class="p">(</span><span class="n">DR</span><span class="p">,</span> <span class="n">DA</span><span class="p">);</span>
	<span class="n">FP_PACK_DP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">d</span><span class="p">,</span> <span class="n">DR</span><span class="p">);</span>
        <span class="n">emu_set_CC_cs</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">DR_c</span><span class="p">,</span> <span class="n">DR_s</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Square root double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_sqdb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DA</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">FP_SQRT_D</span><span class="p">(</span><span class="n">DR</span><span class="p">,</span> <span class="n">DA</span><span class="p">);</span>
	<span class="n">FP_PACK_DP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">d</span><span class="p">,</span> <span class="n">DR</span><span class="p">);</span>
        <span class="n">emu_set_CC_cs</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">DR_c</span><span class="p">,</span> <span class="n">DR_s</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Square root float */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_sqebr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SA</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
	<span class="n">FP_SQRT_S</span><span class="p">(</span><span class="n">SR</span><span class="p">,</span> <span class="n">SA</span><span class="p">);</span>
	<span class="n">FP_PACK_SP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">f</span><span class="p">,</span> <span class="n">SR</span><span class="p">);</span>
        <span class="n">emu_set_CC_cs</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">SR_c</span><span class="p">,</span> <span class="n">SR_s</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Square root float */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_sqeb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SA</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">FP_SQRT_S</span><span class="p">(</span><span class="n">SR</span><span class="p">,</span> <span class="n">SA</span><span class="p">);</span>
	<span class="n">FP_PACK_SP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">f</span><span class="p">,</span> <span class="n">SR</span><span class="p">);</span>
        <span class="n">emu_set_CC_cs</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">SR_c</span><span class="p">,</span> <span class="n">SR_s</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Subtract long double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_sxbr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QA</span><span class="p">);</span> <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QB</span><span class="p">);</span> <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
	<span class="n">mathemu_ldcv</span> <span class="n">cvt</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">FP_UNPACK_QP</span><span class="p">(</span><span class="n">QA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">);</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">FP_UNPACK_QP</span><span class="p">(</span><span class="n">QB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">);</span>
        <span class="n">FP_SUB_Q</span><span class="p">(</span><span class="n">QR</span><span class="p">,</span> <span class="n">QA</span><span class="p">,</span> <span class="n">QB</span><span class="p">);</span>
        <span class="n">FP_PACK_QP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">,</span> <span class="n">QR</span><span class="p">);</span>
        <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span> <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span><span class="p">;</span>
        <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span> <span class="o">=</span> <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span><span class="p">;</span>
        <span class="n">emu_set_CC_cs</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">QR_c</span><span class="p">,</span> <span class="n">QR_s</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Subtract double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_sdbr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DA</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DB</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
        <span class="n">FP_SUB_D</span><span class="p">(</span><span class="n">DR</span><span class="p">,</span> <span class="n">DA</span><span class="p">,</span> <span class="n">DB</span><span class="p">);</span>
	<span class="n">FP_PACK_DP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">d</span><span class="p">,</span> <span class="n">DR</span><span class="p">);</span>
        <span class="n">emu_set_CC_cs</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">DR_c</span><span class="p">,</span> <span class="n">DR_s</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Subtract double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_sdb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DA</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DB</span><span class="p">);</span> <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
        <span class="n">FP_UNPACK_DP</span><span class="p">(</span><span class="n">DB</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
        <span class="n">FP_SUB_D</span><span class="p">(</span><span class="n">DR</span><span class="p">,</span> <span class="n">DA</span><span class="p">,</span> <span class="n">DB</span><span class="p">);</span>
	<span class="n">FP_PACK_DP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">d</span><span class="p">,</span> <span class="n">DR</span><span class="p">);</span>
        <span class="n">emu_set_CC_cs</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">DR_c</span><span class="p">,</span> <span class="n">DR_s</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Subtract float */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_sebr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SA</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SB</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">ry</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
        <span class="n">FP_SUB_S</span><span class="p">(</span><span class="n">SR</span><span class="p">,</span> <span class="n">SA</span><span class="p">,</span> <span class="n">SB</span><span class="p">);</span>
	<span class="n">FP_PACK_SP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">f</span><span class="p">,</span> <span class="n">SR</span><span class="p">);</span>
        <span class="n">emu_set_CC_cs</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">SR_c</span><span class="p">,</span> <span class="n">SR_s</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Subtract float */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_seb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SA</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SB</span><span class="p">);</span> <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SR</span><span class="p">);</span>
        <span class="n">FP_DECL_EX</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
        <span class="n">FP_UNPACK_SP</span><span class="p">(</span><span class="n">SB</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
        <span class="n">FP_SUB_S</span><span class="p">(</span><span class="n">SR</span><span class="p">,</span> <span class="n">SA</span><span class="p">,</span> <span class="n">SB</span><span class="p">);</span>
	<span class="n">FP_PACK_SP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">f</span><span class="p">,</span> <span class="n">SR</span><span class="p">);</span>
        <span class="n">emu_set_CC_cs</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">SR_c</span><span class="p">,</span> <span class="n">SR_s</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_fex</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Test data class long double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_tcxb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_Q</span><span class="p">(</span><span class="n">QA</span><span class="p">);</span>
	<span class="n">mathemu_ldcv</span> <span class="n">cvt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bit</span><span class="p">;</span>

        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">cvt</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">low</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">ui</span><span class="p">;</span>
        <span class="n">FP_UNPACK_RAW_QP</span><span class="p">(</span><span class="n">QA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cvt</span><span class="p">.</span><span class="n">ld</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">QA_e</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
		<span class="n">bit</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>		<span class="cm">/* normalized number */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">_FP_FRAC_ZEROP_4</span><span class="p">(</span><span class="n">QA</span><span class="p">))</span>
			<span class="n">bit</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>	<span class="cm">/* zero */</span>
		<span class="k">else</span>
			<span class="n">bit</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>	<span class="cm">/* denormalized number */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">_FP_EXPMAX_Q</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">_FP_FRAC_ZEROP_4</span><span class="p">(</span><span class="n">QA</span><span class="p">))</span>
			<span class="n">bit</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* infinity */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_FP_FRAC_HIGH_RAW_Q</span><span class="p">(</span><span class="n">QA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">_FP_QNANBIT_Q</span><span class="p">)</span>
			<span class="n">bit</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* quiet NAN */</span>
		<span class="k">else</span>
			<span class="n">bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* signaling NAN */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">QA_s</span><span class="p">)</span>
		<span class="n">bit</span><span class="o">++</span><span class="p">;</span>
	<span class="n">emu_set_CC</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="p">((</span><span class="n">__u32</span><span class="p">)</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">bit</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Test data class double */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_tcdb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_D</span><span class="p">(</span><span class="n">DA</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">bit</span><span class="p">;</span>

        <span class="n">FP_UNPACK_RAW_DP</span><span class="p">(</span><span class="n">DA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">DA_e</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
		<span class="n">bit</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>		<span class="cm">/* normalized number */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">_FP_FRAC_ZEROP_2</span><span class="p">(</span><span class="n">DA</span><span class="p">))</span>
			<span class="n">bit</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>	<span class="cm">/* zero */</span>
		<span class="k">else</span>
			<span class="n">bit</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>	<span class="cm">/* denormalized number */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">_FP_EXPMAX_D</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">_FP_FRAC_ZEROP_2</span><span class="p">(</span><span class="n">DA</span><span class="p">))</span>
			<span class="n">bit</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* infinity */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_FP_FRAC_HIGH_RAW_D</span><span class="p">(</span><span class="n">DA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">_FP_QNANBIT_D</span><span class="p">)</span>
			<span class="n">bit</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* quiet NAN */</span>
		<span class="k">else</span>
			<span class="n">bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* signaling NAN */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DA_s</span><span class="p">)</span>
		<span class="n">bit</span><span class="o">++</span><span class="p">;</span>
	<span class="n">emu_set_CC</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="p">((</span><span class="n">__u32</span><span class="p">)</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">bit</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Test data class float */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_tceb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FP_DECL_S</span><span class="p">(</span><span class="n">SA</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">bit</span><span class="p">;</span>

        <span class="n">FP_UNPACK_RAW_SP</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">SA_e</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
		<span class="n">bit</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>		<span class="cm">/* normalized number */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">_FP_FRAC_ZEROP_1</span><span class="p">(</span><span class="n">SA</span><span class="p">))</span>
			<span class="n">bit</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>	<span class="cm">/* zero */</span>
		<span class="k">else</span>
			<span class="n">bit</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>	<span class="cm">/* denormalized number */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">_FP_EXPMAX_S</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">_FP_FRAC_ZEROP_1</span><span class="p">(</span><span class="n">SA</span><span class="p">))</span>
			<span class="n">bit</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* infinity */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_FP_FRAC_HIGH_RAW_S</span><span class="p">(</span><span class="n">SA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">_FP_QNANBIT_S</span><span class="p">)</span>
			<span class="n">bit</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* quiet NAN */</span>
		<span class="k">else</span>
			<span class="n">bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* signaling NAN */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SA_s</span><span class="p">)</span>
		<span class="n">bit</span><span class="o">++</span><span class="p">;</span>
	<span class="n">emu_set_CC</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="p">((</span><span class="n">__u32</span><span class="p">)</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">bit</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">emu_load_regd</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">reg</span><span class="o">&amp;</span><span class="mi">9</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* test if reg in {0,2,4,6} */</span>
                <span class="k">return</span><span class="p">;</span>
	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span>		<span class="cm">/* load reg from fp_regs.fprs[reg] */</span>
		<span class="s">&quot;	bras	1,0f</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	ld	0,0(%1)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;0:	ex	%0,0(1)&quot;</span>
		<span class="o">:</span> <span class="cm">/* no output */</span>
		<span class="o">:</span> <span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="n">reg</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">),</span><span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">reg</span><span class="p">].</span><span class="n">d</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;1&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">emu_load_rege</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">reg</span><span class="o">&amp;</span><span class="mi">9</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* test if reg in {0,2,4,6} */</span>
                <span class="k">return</span><span class="p">;</span>
	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span>		<span class="cm">/* load reg from fp_regs.fprs[reg] */</span>
		<span class="s">&quot;	bras	1,0f</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	le	0,0(%1)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;0:	ex	%0,0(1)&quot;</span>
		<span class="o">:</span> <span class="cm">/* no output */</span>
		<span class="o">:</span> <span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="n">reg</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">),</span> <span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">reg</span><span class="p">].</span><span class="n">f</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;1&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">emu_store_regd</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">reg</span><span class="o">&amp;</span><span class="mi">9</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* test if reg in {0,2,4,6} */</span>
                <span class="k">return</span><span class="p">;</span>
	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span>		<span class="cm">/* store reg to fp_regs.fprs[reg] */</span>
		<span class="s">&quot;	bras	1,0f</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	std	0,0(%1)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;0:	ex	%0,0(1)&quot;</span>
		<span class="o">:</span> <span class="cm">/* no output */</span>
		<span class="o">:</span> <span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="n">reg</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">),</span> <span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">reg</span><span class="p">].</span><span class="n">d</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;1&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">emu_store_rege</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">reg</span><span class="o">&amp;</span><span class="mi">9</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* test if reg in {0,2,4,6} */</span>
                <span class="k">return</span><span class="p">;</span>
	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span>		<span class="cm">/* store reg to fp_regs.fprs[reg] */</span>
		<span class="s">&quot;	bras	1,0f</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	ste	0,0(%1)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;0:	ex	%0,0(1)&quot;</span>
		<span class="o">:</span> <span class="cm">/* no output */</span>
		<span class="o">:</span> <span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="n">reg</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">),</span> <span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fprs</span><span class="p">[</span><span class="n">reg</span><span class="p">].</span><span class="n">f</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;1&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">math_emu_b3</span><span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="n">opcode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span> <span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">_fex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">static</span> <span class="k">const</span> <span class="n">__u8</span> <span class="n">format_table</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="p">[</span><span class="mh">0x00</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">,[</span><span class="mh">0x01</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">,[</span><span class="mh">0x02</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">,[</span><span class="mh">0x03</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
		<span class="p">[</span><span class="mh">0x04</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0f</span><span class="p">,[</span><span class="mh">0x05</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0d</span><span class="p">,[</span><span class="mh">0x06</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0e</span><span class="p">,[</span><span class="mh">0x07</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0d</span><span class="p">,</span>
		<span class="p">[</span><span class="mh">0x08</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">,[</span><span class="mh">0x09</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">,[</span><span class="mh">0x0a</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">,[</span><span class="mh">0x0b</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
                <span class="p">[</span><span class="mh">0x0c</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0f</span><span class="p">,[</span><span class="mh">0x0d</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">,[</span><span class="mh">0x0e</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">,[</span><span class="mh">0x0f</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">,</span>
		<span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,[</span><span class="mh">0x11</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,[</span><span class="mh">0x12</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,[</span><span class="mh">0x13</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
		<span class="p">[</span><span class="mh">0x14</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">,[</span><span class="mh">0x15</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,[</span><span class="mh">0x16</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,[</span><span class="mh">0x17</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
                <span class="p">[</span><span class="mh">0x18</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,[</span><span class="mh">0x19</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,[</span><span class="mh">0x1a</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,[</span><span class="mh">0x1b</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
		<span class="p">[</span><span class="mh">0x1c</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,[</span><span class="mh">0x1d</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,[</span><span class="mh">0x1e</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">,[</span><span class="mh">0x1f</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">,</span>
		<span class="p">[</span><span class="mh">0x40</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,[</span><span class="mh">0x41</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,[</span><span class="mh">0x42</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,[</span><span class="mh">0x43</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
                <span class="p">[</span><span class="mh">0x44</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x12</span><span class="p">,[</span><span class="mh">0x45</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0d</span><span class="p">,[</span><span class="mh">0x46</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">,[</span><span class="mh">0x47</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
		<span class="p">[</span><span class="mh">0x48</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,[</span><span class="mh">0x49</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,[</span><span class="mh">0x4a</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,[</span><span class="mh">0x4b</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
		<span class="p">[</span><span class="mh">0x4c</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,[</span><span class="mh">0x4d</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,[</span><span class="mh">0x53</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">,[</span><span class="mh">0x57</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">,</span>
                <span class="p">[</span><span class="mh">0x5b</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">,[</span><span class="mh">0x5f</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">,[</span><span class="mh">0x84</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x13</span><span class="p">,[</span><span class="mh">0x8c</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x13</span><span class="p">,</span>
		<span class="p">[</span><span class="mh">0x94</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x09</span><span class="p">,[</span><span class="mh">0x95</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">,[</span><span class="mh">0x96</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x07</span><span class="p">,[</span><span class="mh">0x98</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>
		<span class="p">[</span><span class="mh">0x99</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0b</span><span class="p">,[</span><span class="mh">0x9a</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0a</span>
        <span class="p">};</span>
        <span class="k">static</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">jump_table</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span><span class="o">=</span> <span class="p">{</span>
                <span class="p">[</span><span class="mh">0x00</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_lpebr</span><span class="p">,[</span><span class="mh">0x01</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_lnebr</span><span class="p">,[</span><span class="mh">0x02</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_ltebr</span><span class="p">,</span>
                <span class="p">[</span><span class="mh">0x03</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_lcebr</span><span class="p">,[</span><span class="mh">0x04</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_ldebr</span><span class="p">,[</span><span class="mh">0x05</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_lxdbr</span><span class="p">,</span>
                <span class="p">[</span><span class="mh">0x06</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_lxebr</span><span class="p">,[</span><span class="mh">0x07</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_mxdbr</span><span class="p">,[</span><span class="mh">0x08</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_kebr</span><span class="p">,</span>
                <span class="p">[</span><span class="mh">0x09</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_cebr</span><span class="p">,</span> <span class="p">[</span><span class="mh">0x0a</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_aebr</span><span class="p">,</span> <span class="p">[</span><span class="mh">0x0b</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_sebr</span><span class="p">,</span>
                <span class="p">[</span><span class="mh">0x0c</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_mdebr</span><span class="p">,[</span><span class="mh">0x0d</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_debr</span><span class="p">,</span> <span class="p">[</span><span class="mh">0x0e</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_maebr</span><span class="p">,</span>
                <span class="p">[</span><span class="mh">0x0f</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_msebr</span><span class="p">,[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_lpdbr</span><span class="p">,[</span><span class="mh">0x11</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_lndbr</span><span class="p">,</span> 
                <span class="p">[</span><span class="mh">0x12</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_ltdbr</span><span class="p">,[</span><span class="mh">0x13</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_lcdbr</span><span class="p">,[</span><span class="mh">0x14</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_sqebr</span><span class="p">,</span>
                <span class="p">[</span><span class="mh">0x15</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_sqdbr</span><span class="p">,[</span><span class="mh">0x16</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_sqxbr</span><span class="p">,[</span><span class="mh">0x17</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_meebr</span><span class="p">,</span>
                <span class="p">[</span><span class="mh">0x18</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_kdbr</span><span class="p">,</span> <span class="p">[</span><span class="mh">0x19</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_cdbr</span><span class="p">,</span> <span class="p">[</span><span class="mh">0x1a</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_adbr</span><span class="p">,</span>
                <span class="p">[</span><span class="mh">0x1b</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_sdbr</span><span class="p">,</span> <span class="p">[</span><span class="mh">0x1c</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_mdbr</span><span class="p">,</span> <span class="p">[</span><span class="mh">0x1d</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_ddbr</span><span class="p">,</span>  
                <span class="p">[</span><span class="mh">0x1e</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_madbr</span><span class="p">,[</span><span class="mh">0x1f</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_msdbr</span><span class="p">,[</span><span class="mh">0x40</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_lpxbr</span><span class="p">,</span>
                <span class="p">[</span><span class="mh">0x41</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_lnxbr</span><span class="p">,[</span><span class="mh">0x42</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_ltxbr</span><span class="p">,[</span><span class="mh">0x43</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_lcxbr</span><span class="p">,</span>
                <span class="p">[</span><span class="mh">0x44</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_ledbr</span><span class="p">,[</span><span class="mh">0x45</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_ldxbr</span><span class="p">,[</span><span class="mh">0x46</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_lexbr</span><span class="p">,</span>
                <span class="p">[</span><span class="mh">0x47</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_fixbr</span><span class="p">,[</span><span class="mh">0x48</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_kxbr</span><span class="p">,</span> <span class="p">[</span><span class="mh">0x49</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_cxbr</span><span class="p">,</span>  
                <span class="p">[</span><span class="mh">0x4a</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_axbr</span><span class="p">,</span> <span class="p">[</span><span class="mh">0x4b</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_sxbr</span><span class="p">,</span> <span class="p">[</span><span class="mh">0x4c</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_mxbr</span><span class="p">,</span>
                <span class="p">[</span><span class="mh">0x4d</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_dxbr</span><span class="p">,</span> <span class="p">[</span><span class="mh">0x53</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_diebr</span><span class="p">,[</span><span class="mh">0x57</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_fiebr</span><span class="p">,</span>
                <span class="p">[</span><span class="mh">0x5b</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_didbr</span><span class="p">,[</span><span class="mh">0x5f</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_fidbr</span><span class="p">,[</span><span class="mh">0x84</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_sfpc</span><span class="p">,</span>
                <span class="p">[</span><span class="mh">0x8c</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_efpc</span><span class="p">,</span> <span class="p">[</span><span class="mh">0x94</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_cefbr</span><span class="p">,[</span><span class="mh">0x95</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_cdfbr</span><span class="p">,</span> 
                <span class="p">[</span><span class="mh">0x96</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_cxfbr</span><span class="p">,[</span><span class="mh">0x98</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_cfebr</span><span class="p">,[</span><span class="mh">0x99</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_cfdbr</span><span class="p">,</span>
                <span class="p">[</span><span class="mh">0x9a</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_cfxbr</span>
        <span class="p">};</span>

        <span class="k">switch</span> <span class="p">(</span><span class="n">format_table</span><span class="p">[</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="p">{</span>
        <span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* RRE format, long double operation */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x22</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">SIGILL</span><span class="p">;</span>
                <span class="n">emu_store_regd</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_store_regd</span><span class="p">(((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
                <span class="n">emu_store_regd</span><span class="p">(</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_store_regd</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
                <span class="cm">/* call the emulation function */</span>
                <span class="n">_fex</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">,</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">))</span>
			<span class="n">jump_table</span><span class="p">[</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                        <span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_load_regd</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_load_regd</span><span class="p">(((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
                <span class="n">emu_load_regd</span><span class="p">(</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_load_regd</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* RRE format, double operation */</span>
                <span class="n">emu_store_regd</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_store_regd</span><span class="p">(</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="cm">/* call the emulation function */</span>
                <span class="n">_fex</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">))</span>
			<span class="n">jump_table</span><span class="p">[</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                        <span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_load_regd</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_load_regd</span><span class="p">(</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* RRE format, float operation */</span>
                <span class="n">emu_store_rege</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_store_rege</span><span class="p">(</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="cm">/* call the emulation function */</span>
                <span class="n">_fex</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">))</span>
			<span class="n">jump_table</span><span class="p">[</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                        <span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_load_rege</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_load_rege</span><span class="p">(</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">4</span>: <span class="cm">/* RRF format, long double operation */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x22</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">SIGILL</span><span class="p">;</span>
                <span class="n">emu_store_regd</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_store_regd</span><span class="p">(((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
                <span class="n">emu_store_regd</span><span class="p">(</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_store_regd</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
                <span class="cm">/* call the emulation function */</span>
                <span class="n">_fex</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">))</span>
			<span class="n">jump_table</span><span class="p">[</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                        <span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
                <span class="n">emu_load_regd</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_load_regd</span><span class="p">(((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
                <span class="n">emu_load_regd</span><span class="p">(</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_load_regd</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">5</span>: <span class="cm">/* RRF format, double operation */</span>
                <span class="n">emu_store_regd</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_store_regd</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_store_regd</span><span class="p">(</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="cm">/* call the emulation function */</span>
                <span class="n">_fex</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">))</span>
			<span class="n">jump_table</span><span class="p">[</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                        <span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
                <span class="n">emu_load_regd</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_load_regd</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_load_regd</span><span class="p">(</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">6</span>: <span class="cm">/* RRF format, float operation */</span>
                <span class="n">emu_store_rege</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_store_rege</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_store_rege</span><span class="p">(</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="cm">/* call the emulation function */</span>
                <span class="n">_fex</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">))</span>
			<span class="n">jump_table</span><span class="p">[</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                        <span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
                <span class="n">emu_load_rege</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_load_rege</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_load_rege</span><span class="p">(</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">7</span>: <span class="cm">/* RRE format, cxfbr instruction */</span>
                <span class="cm">/* call the emulation function */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">SIGILL</span><span class="p">;</span>
                <span class="n">_fex</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">))</span>
			<span class="n">jump_table</span><span class="p">[</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                        <span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_load_regd</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_load_regd</span><span class="p">(((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">8</span>: <span class="cm">/* RRE format, cdfbr instruction */</span>
                <span class="cm">/* call the emulation function */</span>
                <span class="n">_fex</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">))</span>
			<span class="n">jump_table</span><span class="p">[</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                        <span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_load_regd</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">9</span>: <span class="cm">/* RRE format, cefbr instruction */</span>
                <span class="cm">/* call the emulation function */</span>
                <span class="n">_fex</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">))</span>
			<span class="n">jump_table</span><span class="p">[</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                        <span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_load_rege</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">10</span>: <span class="cm">/* RRF format, cfxbr instruction */</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">128</span><span class="p">)</span> <span class="o">==</span> <span class="mi">128</span> <span class="o">||</span> <span class="p">(</span><span class="n">opcode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">96</span><span class="p">)</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>
			<span class="cm">/* mask of { 2,3,8-15 } is invalid */</span>
			<span class="k">return</span> <span class="n">SIGILL</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">SIGILL</span><span class="p">;</span>
                <span class="n">emu_store_regd</span><span class="p">(</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_store_regd</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
                <span class="cm">/* call the emulation function */</span>
                <span class="n">_fex</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">))</span>
			<span class="n">jump_table</span><span class="p">[</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                        <span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">11</span>: <span class="cm">/* RRF format, cfdbr instruction */</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">128</span><span class="p">)</span> <span class="o">==</span> <span class="mi">128</span> <span class="o">||</span> <span class="p">(</span><span class="n">opcode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">96</span><span class="p">)</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>
			<span class="cm">/* mask of { 2,3,8-15 } is invalid */</span>
			<span class="k">return</span> <span class="n">SIGILL</span><span class="p">;</span>
                <span class="n">emu_store_regd</span><span class="p">(</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="cm">/* call the emulation function */</span>
                <span class="n">_fex</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">))</span>
			<span class="n">jump_table</span><span class="p">[</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                        <span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">12</span>: <span class="cm">/* RRF format, cfebr instruction */</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">128</span><span class="p">)</span> <span class="o">==</span> <span class="mi">128</span> <span class="o">||</span> <span class="p">(</span><span class="n">opcode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">96</span><span class="p">)</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>
			<span class="cm">/* mask of { 2,3,8-15 } is invalid */</span>
			<span class="k">return</span> <span class="n">SIGILL</span><span class="p">;</span>
                <span class="n">emu_store_rege</span><span class="p">(</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="cm">/* call the emulation function */</span>
                <span class="n">_fex</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">))</span>
			<span class="n">jump_table</span><span class="p">[</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                        <span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">13</span>: <span class="cm">/* RRE format, ldxbr &amp; mdxbr instruction */</span>
                <span class="cm">/* double store but long double load */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">SIGILL</span><span class="p">;</span>
                <span class="n">emu_store_regd</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_store_regd</span><span class="p">(</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="cm">/* call the emulation function */</span>
                <span class="n">_fex</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">))</span>
			<span class="n">jump_table</span><span class="p">[</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                        <span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_load_regd</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_load_regd</span><span class="p">(((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">14</span>: <span class="cm">/* RRE format, ldxbr &amp; mdxbr instruction */</span>
                <span class="cm">/* float store but long double load */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">SIGILL</span><span class="p">;</span>
                <span class="n">emu_store_rege</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_store_rege</span><span class="p">(</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="cm">/* call the emulation function */</span>
                <span class="n">_fex</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">))</span>
			<span class="n">jump_table</span><span class="p">[</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                        <span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_load_regd</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_load_regd</span><span class="p">(((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">15</span>: <span class="cm">/* RRE format, ldebr &amp; mdebr instruction */</span>
                <span class="cm">/* float store but double load */</span>
                <span class="n">emu_store_rege</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_store_rege</span><span class="p">(</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="cm">/* call the emulation function */</span>
                <span class="n">_fex</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">))</span>
			<span class="n">jump_table</span><span class="p">[</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                        <span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_load_regd</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">16</span>: <span class="cm">/* RRE format, ldxbr instruction */</span>
                <span class="cm">/* long double store but double load */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">SIGILL</span><span class="p">;</span>
                <span class="n">emu_store_regd</span><span class="p">(</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_store_regd</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
                <span class="cm">/* call the emulation function */</span>
                <span class="n">_fex</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">))</span>
			<span class="n">jump_table</span><span class="p">[</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                        <span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_load_regd</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">17</span>: <span class="cm">/* RRE format, ldxbr instruction */</span>
                <span class="cm">/* long double store but float load */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">SIGILL</span><span class="p">;</span>
                <span class="n">emu_store_regd</span><span class="p">(</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_store_regd</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
                <span class="cm">/* call the emulation function */</span>
                <span class="n">_fex</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">))</span>
			<span class="n">jump_table</span><span class="p">[</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                        <span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_load_rege</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">18</span>: <span class="cm">/* RRE format, ledbr instruction */</span>
                <span class="cm">/* double store but float load */</span>
                <span class="n">emu_store_regd</span><span class="p">(</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="cm">/* call the emulation function */</span>
                <span class="n">_fex</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">))</span>
			<span class="n">jump_table</span><span class="p">[</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                        <span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_load_rege</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">19</span>: <span class="cm">/* RRE format, efpc &amp; sfpc instruction */</span>
                <span class="cm">/* call the emulation function */</span>
                <span class="n">_fex</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">))</span>
			<span class="n">jump_table</span><span class="p">[</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                        <span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="nl">default:</span> <span class="cm">/* invalid operation */</span>
                <span class="k">return</span> <span class="n">SIGILL</span><span class="p">;</span>
        <span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_fex</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">|=</span> <span class="n">_fex</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">_fex</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">SIGFPE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span><span class="o">*</span> <span class="nf">calc_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">disp</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">addr_t</span> <span class="n">addr</span><span class="p">;</span>

        <span class="n">rx</span> <span class="o">&amp;=</span> <span class="mi">15</span><span class="p">;</span>
        <span class="n">rb</span> <span class="o">&amp;=</span> <span class="mi">15</span><span class="p">;</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="n">disp</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">;</span>
        <span class="n">addr</span> <span class="o">+=</span> <span class="p">(</span><span class="n">rx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gprs</span><span class="p">[</span><span class="n">rx</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* + index */</span>
        <span class="n">addr</span> <span class="o">+=</span> <span class="p">(</span><span class="n">rb</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gprs</span><span class="p">[</span><span class="n">rb</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* + base  */</span>
        <span class="k">return</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>
    
<span class="kt">int</span> <span class="nf">math_emu_ed</span><span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="n">opcode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span> <span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">_fex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">static</span> <span class="k">const</span> <span class="n">__u8</span> <span class="n">format_table</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="p">[</span><span class="mh">0x04</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">,[</span><span class="mh">0x05</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">,[</span><span class="mh">0x06</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x07</span><span class="p">,[</span><span class="mh">0x07</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">,</span>
		<span class="p">[</span><span class="mh">0x08</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,[</span><span class="mh">0x09</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,[</span><span class="mh">0x0a</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,[</span><span class="mh">0x0b</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
		<span class="p">[</span><span class="mh">0x0c</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">,[</span><span class="mh">0x0d</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,[</span><span class="mh">0x0e</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">,[</span><span class="mh">0x0f</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
                <span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">,[</span><span class="mh">0x11</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x09</span><span class="p">,[</span><span class="mh">0x12</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0a</span><span class="p">,[</span><span class="mh">0x14</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
		<span class="p">[</span><span class="mh">0x15</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,[</span><span class="mh">0x17</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,[</span><span class="mh">0x18</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,[</span><span class="mh">0x19</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
		<span class="p">[</span><span class="mh">0x1a</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,[</span><span class="mh">0x1b</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,[</span><span class="mh">0x1c</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,[</span><span class="mh">0x1d</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
                <span class="p">[</span><span class="mh">0x1e</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">,[</span><span class="mh">0x1f</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
        <span class="p">};</span>
        <span class="k">static</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">jump_table</span><span class="p">[]</span><span class="o">=</span> <span class="p">{</span>
                <span class="p">[</span><span class="mh">0x04</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_ldeb</span><span class="p">,[</span><span class="mh">0x05</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_lxdb</span><span class="p">,[</span><span class="mh">0x06</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_lxeb</span><span class="p">,</span>
                <span class="p">[</span><span class="mh">0x07</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_mxdb</span><span class="p">,[</span><span class="mh">0x08</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_keb</span><span class="p">,</span> <span class="p">[</span><span class="mh">0x09</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_ceb</span><span class="p">,</span>
                <span class="p">[</span><span class="mh">0x0a</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_aeb</span><span class="p">,</span> <span class="p">[</span><span class="mh">0x0b</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_seb</span><span class="p">,</span> <span class="p">[</span><span class="mh">0x0c</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_mdeb</span><span class="p">,</span>
                <span class="p">[</span><span class="mh">0x0d</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_deb</span><span class="p">,</span> <span class="p">[</span><span class="mh">0x0e</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_maeb</span><span class="p">,[</span><span class="mh">0x0f</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_mseb</span><span class="p">,</span>
                <span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_tceb</span><span class="p">,[</span><span class="mh">0x11</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_tcdb</span><span class="p">,[</span><span class="mh">0x12</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_tcxb</span><span class="p">,</span>
                <span class="p">[</span><span class="mh">0x14</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_sqeb</span><span class="p">,[</span><span class="mh">0x15</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_sqdb</span><span class="p">,[</span><span class="mh">0x17</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_meeb</span><span class="p">,</span>
                <span class="p">[</span><span class="mh">0x18</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_kdb</span><span class="p">,</span> <span class="p">[</span><span class="mh">0x19</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_cdb</span><span class="p">,</span> <span class="p">[</span><span class="mh">0x1a</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_adb</span><span class="p">,</span>
                <span class="p">[</span><span class="mh">0x1b</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_sdb</span><span class="p">,</span> <span class="p">[</span><span class="mh">0x1c</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_mdb</span><span class="p">,</span> <span class="p">[</span><span class="mh">0x1d</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_ddb</span><span class="p">,</span>
                <span class="p">[</span><span class="mh">0x1e</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_madb</span><span class="p">,[</span><span class="mh">0x1f</span><span class="p">]</span> <span class="o">=</span> <span class="n">emu_msdb</span>
        <span class="p">};</span>

        <span class="k">switch</span> <span class="p">(</span><span class="n">format_table</span><span class="p">[</span><span class="n">opcode</span><span class="p">[</span><span class="mi">5</span><span class="p">]])</span> <span class="p">{</span>
        <span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* RXE format, double constant */</span> <span class="p">{</span>
                <span class="n">__u64</span> <span class="o">*</span><span class="n">dxb</span><span class="p">,</span> <span class="n">temp</span><span class="p">;</span>
                <span class="n">__u32</span> <span class="n">opc</span><span class="p">;</span>

                <span class="n">emu_store_regd</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">opc</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">opcode</span><span class="p">);</span>
                <span class="n">dxb</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span> <span class="o">*</span><span class="p">)</span> <span class="n">calc_addr</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opc</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">opc</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">,</span> <span class="n">opc</span><span class="p">);</span>
                <span class="n">mathemu_copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="n">dxb</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
                <span class="cm">/* call the emulation function */</span>
                <span class="n">_fex</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="p">))</span>
			<span class="n">jump_table</span><span class="p">[</span><span class="n">opcode</span><span class="p">[</span><span class="mi">5</span><span class="p">]])</span>
                        <span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="kt">double</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
                <span class="n">emu_load_regd</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* RXE format, float constant */</span> <span class="p">{</span>
                <span class="n">__u32</span> <span class="o">*</span><span class="n">dxb</span><span class="p">,</span> <span class="n">temp</span><span class="p">;</span>
                <span class="n">__u32</span> <span class="n">opc</span><span class="p">;</span>

                <span class="n">emu_store_rege</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">opc</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">opcode</span><span class="p">);</span>
                <span class="n">dxb</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">calc_addr</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opc</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">opc</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">,</span> <span class="n">opc</span><span class="p">);</span>
                <span class="n">mathemu_get_user</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">dxb</span><span class="p">);</span>
                <span class="cm">/* call the emulation function */</span>
                <span class="n">_fex</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">))</span>
			<span class="n">jump_table</span><span class="p">[</span><span class="n">opcode</span><span class="p">[</span><span class="mi">5</span><span class="p">]])</span>
                        <span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
                <span class="n">emu_load_rege</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* RXF format, double constant */</span> <span class="p">{</span>
                <span class="n">__u64</span> <span class="o">*</span><span class="n">dxb</span><span class="p">,</span> <span class="n">temp</span><span class="p">;</span>
                <span class="n">__u32</span> <span class="n">opc</span><span class="p">;</span>

                <span class="n">emu_store_regd</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_store_regd</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">opc</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">opcode</span><span class="p">);</span>
                <span class="n">dxb</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span> <span class="o">*</span><span class="p">)</span> <span class="n">calc_addr</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opc</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">opc</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">,</span> <span class="n">opc</span><span class="p">);</span>
                <span class="n">mathemu_copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="n">dxb</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
                <span class="cm">/* call the emulation function */</span>
                <span class="n">_fex</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">))</span>
			<span class="n">jump_table</span><span class="p">[</span><span class="n">opcode</span><span class="p">[</span><span class="mi">5</span><span class="p">]])</span>
                        <span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="kt">double</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
                <span class="n">emu_load_regd</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="mi">4</span>: <span class="cm">/* RXF format, float constant */</span> <span class="p">{</span>
                <span class="n">__u32</span> <span class="o">*</span><span class="n">dxb</span><span class="p">,</span> <span class="n">temp</span><span class="p">;</span>
                <span class="n">__u32</span> <span class="n">opc</span><span class="p">;</span>

                <span class="n">emu_store_rege</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_store_rege</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">opc</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">opcode</span><span class="p">);</span>
                <span class="n">dxb</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">calc_addr</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opc</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">opc</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">,</span> <span class="n">opc</span><span class="p">);</span>
                <span class="n">mathemu_get_user</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">dxb</span><span class="p">);</span>
                <span class="cm">/* call the emulation function */</span>
                <span class="n">_fex</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">))</span>
			<span class="n">jump_table</span><span class="p">[</span><span class="n">opcode</span><span class="p">[</span><span class="mi">5</span><span class="p">]])</span>
                        <span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
                <span class="n">emu_load_rege</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="mi">5</span>: <span class="cm">/* RXE format, double constant */</span>
                <span class="cm">/* store double and load long double */</span> 
        <span class="p">{</span>
                <span class="n">__u64</span> <span class="o">*</span><span class="n">dxb</span><span class="p">,</span> <span class="n">temp</span><span class="p">;</span>
                <span class="n">__u32</span> <span class="n">opc</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">SIGILL</span><span class="p">;</span>
                <span class="n">emu_store_regd</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">opc</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">opcode</span><span class="p">);</span>
                <span class="n">dxb</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span> <span class="o">*</span><span class="p">)</span> <span class="n">calc_addr</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opc</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">opc</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">,</span> <span class="n">opc</span><span class="p">);</span>
                <span class="n">mathemu_copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="n">dxb</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
                <span class="cm">/* call the emulation function */</span>
                <span class="n">_fex</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="p">))</span>
			<span class="n">jump_table</span><span class="p">[</span><span class="n">opcode</span><span class="p">[</span><span class="mi">5</span><span class="p">]])</span>
                        <span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="kt">double</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
                <span class="n">emu_load_regd</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_load_regd</span><span class="p">(((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="mi">6</span>: <span class="cm">/* RXE format, float constant */</span>
                <span class="cm">/* store float and load double */</span> 
        <span class="p">{</span>
                <span class="n">__u32</span> <span class="o">*</span><span class="n">dxb</span><span class="p">,</span> <span class="n">temp</span><span class="p">;</span>
                <span class="n">__u32</span> <span class="n">opc</span><span class="p">;</span>
                <span class="n">emu_store_rege</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">opc</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">opcode</span><span class="p">);</span>
                <span class="n">dxb</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">calc_addr</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opc</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">opc</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">,</span> <span class="n">opc</span><span class="p">);</span>
                <span class="n">mathemu_get_user</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">dxb</span><span class="p">);</span>
                <span class="cm">/* call the emulation function */</span>
                <span class="n">_fex</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">))</span>
			<span class="n">jump_table</span><span class="p">[</span><span class="n">opcode</span><span class="p">[</span><span class="mi">5</span><span class="p">]])</span>
                        <span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
                <span class="n">emu_load_regd</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="mi">7</span>: <span class="cm">/* RXE format, float constant */</span>
                <span class="cm">/* store float and load long double */</span> 
        <span class="p">{</span>
                <span class="n">__u32</span> <span class="o">*</span><span class="n">dxb</span><span class="p">,</span> <span class="n">temp</span><span class="p">;</span>
                <span class="n">__u32</span> <span class="n">opc</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">SIGILL</span><span class="p">;</span>
                <span class="n">emu_store_rege</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">opc</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">opcode</span><span class="p">);</span>
                <span class="n">dxb</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">calc_addr</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opc</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">opc</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">,</span> <span class="n">opc</span><span class="p">);</span>
                <span class="n">mathemu_get_user</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">dxb</span><span class="p">);</span>
                <span class="cm">/* call the emulation function */</span>
                <span class="n">_fex</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">))</span>
			<span class="n">jump_table</span><span class="p">[</span><span class="n">opcode</span><span class="p">[</span><span class="mi">5</span><span class="p">]])</span>
                        <span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
                <span class="n">emu_load_regd</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_load_regd</span><span class="p">(((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="mi">8</span>: <span class="cm">/* RXE format, RX address used as int value */</span> <span class="p">{</span>
                <span class="n">__u64</span> <span class="n">dxb</span><span class="p">;</span>
                <span class="n">__u32</span> <span class="n">opc</span><span class="p">;</span>

                <span class="n">emu_store_rege</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">opc</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">opcode</span><span class="p">);</span>
                <span class="n">dxb</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span> <span class="n">calc_addr</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opc</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">opc</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">,</span> <span class="n">opc</span><span class="p">);</span>
                <span class="cm">/* call the emulation function */</span>
                <span class="n">_fex</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">long</span><span class="p">))</span>
			<span class="n">jump_table</span><span class="p">[</span><span class="n">opcode</span><span class="p">[</span><span class="mi">5</span><span class="p">]])</span>
                        <span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">dxb</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="mi">9</span>: <span class="cm">/* RXE format, RX address used as int value */</span> <span class="p">{</span>
                <span class="n">__u64</span> <span class="n">dxb</span><span class="p">;</span>
                <span class="n">__u32</span> <span class="n">opc</span><span class="p">;</span>

                <span class="n">emu_store_regd</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">opc</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">opcode</span><span class="p">);</span>
                <span class="n">dxb</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span> <span class="n">calc_addr</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opc</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">opc</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">,</span> <span class="n">opc</span><span class="p">);</span>
                <span class="cm">/* call the emulation function */</span>
                <span class="n">_fex</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">long</span><span class="p">))</span>
			<span class="n">jump_table</span><span class="p">[</span><span class="n">opcode</span><span class="p">[</span><span class="mi">5</span><span class="p">]])</span>
                        <span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">dxb</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="mi">10</span>: <span class="cm">/* RXE format, RX address used as int value */</span> <span class="p">{</span>
                <span class="n">__u64</span> <span class="n">dxb</span><span class="p">;</span>
                <span class="n">__u32</span> <span class="n">opc</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">SIGILL</span><span class="p">;</span>
                <span class="n">emu_store_regd</span><span class="p">((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span>
                <span class="n">emu_store_regd</span><span class="p">(((</span><span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
                <span class="n">opc</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">opcode</span><span class="p">);</span>
                <span class="n">dxb</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span> <span class="n">calc_addr</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opc</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">opc</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">,</span> <span class="n">opc</span><span class="p">);</span>
                <span class="cm">/* call the emulation function */</span>
                <span class="n">_fex</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">long</span><span class="p">))</span>
			<span class="n">jump_table</span><span class="p">[</span><span class="n">opcode</span><span class="p">[</span><span class="mi">5</span><span class="p">]])</span>
                        <span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opcode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">dxb</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nl">default:</span> <span class="cm">/* invalid operation */</span>
                <span class="k">return</span> <span class="n">SIGILL</span><span class="p">;</span>
        <span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_fex</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">|=</span> <span class="n">_fex</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">_fex</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">SIGFPE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Emulate LDR Rx,Ry with Rx or Ry not in {0, 2, 4, 6}</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">math_emu_ldr</span><span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">s390_fp_regs</span> <span class="o">*</span><span class="n">fp_regs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">;</span>
        <span class="n">__u16</span> <span class="n">opc</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">opcode</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">opc</span> <span class="o">&amp;</span> <span class="mh">0x90</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>           <span class="cm">/* test if rx in {0,2,4,6} */</span>
                <span class="cm">/* we got an exception therefore ry can&#39;t be in {0,2,4,6} */</span>
		<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span>		<span class="cm">/* load rx from fp_regs.fprs[ry] */</span>
			<span class="s">&quot;	bras	1,0f</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;	ld	0,0(%1)</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;0:	ex	%0,0(1)&quot;</span>
			<span class="o">:</span> <span class="cm">/* no output */</span>
			<span class="o">:</span> <span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="n">opc</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">),</span> <span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">fp_regs</span><span class="o">-&gt;</span><span class="n">fprs</span><span class="p">[</span><span class="n">opc</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">].</span><span class="n">d</span><span class="p">)</span>
			<span class="o">:</span> <span class="s">&quot;1&quot;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">opc</span> <span class="o">&amp;</span> <span class="mh">0x9</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>     <span class="cm">/* test if ry in {0,2,4,6} */</span>
		<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span>		<span class="cm">/* store ry to fp_regs.fprs[rx] */</span>
			<span class="s">&quot;	bras	1,0f</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;	std	0,0(%1)</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;0:	ex	%0,0(1)&quot;</span>
			<span class="o">:</span> <span class="cm">/* no output */</span>
			<span class="o">:</span> <span class="s">&quot;a&quot;</span> <span class="p">((</span><span class="n">opc</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span>
			  <span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">fp_regs</span><span class="o">-&gt;</span><span class="n">fprs</span><span class="p">[(</span><span class="n">opc</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">4</span><span class="p">].</span><span class="n">d</span><span class="p">)</span>
			<span class="o">:</span> <span class="s">&quot;1&quot;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span>  <span class="cm">/* move fp_regs.fprs[ry] to fp_regs.fprs[rx] */</span>
                <span class="n">fp_regs</span><span class="o">-&gt;</span><span class="n">fprs</span><span class="p">[(</span><span class="n">opc</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">fp_regs</span><span class="o">-&gt;</span><span class="n">fprs</span><span class="p">[</span><span class="n">opc</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Emulate LER Rx,Ry with Rx or Ry not in {0, 2, 4, 6}</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">math_emu_ler</span><span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">s390_fp_regs</span> <span class="o">*</span><span class="n">fp_regs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">;</span>
        <span class="n">__u16</span> <span class="n">opc</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">opcode</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">opc</span> <span class="o">&amp;</span> <span class="mh">0x90</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>           <span class="cm">/* test if rx in {0,2,4,6} */</span>
                <span class="cm">/* we got an exception therefore ry can&#39;t be in {0,2,4,6} */</span>
		<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span>		<span class="cm">/* load rx from fp_regs.fprs[ry] */</span>
			<span class="s">&quot;	bras	1,0f</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;	le	0,0(%1)</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;0:	ex	%0,0(1)&quot;</span>
			<span class="o">:</span> <span class="cm">/* no output */</span>
			<span class="o">:</span> <span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="n">opc</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">),</span> <span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">fp_regs</span><span class="o">-&gt;</span><span class="n">fprs</span><span class="p">[</span><span class="n">opc</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">].</span><span class="n">f</span><span class="p">)</span>
			<span class="o">:</span> <span class="s">&quot;1&quot;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">opc</span> <span class="o">&amp;</span> <span class="mh">0x9</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>     <span class="cm">/* test if ry in {0,2,4,6} */</span>
		<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span>		<span class="cm">/* store ry to fp_regs.fprs[rx] */</span>
			<span class="s">&quot;	bras	1,0f</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;	ste	0,0(%1)</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;0:	ex	%0,0(1)&quot;</span>
			<span class="o">:</span> <span class="cm">/* no output */</span>
			<span class="o">:</span> <span class="s">&quot;a&quot;</span> <span class="p">((</span><span class="n">opc</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span>
			  <span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">fp_regs</span><span class="o">-&gt;</span><span class="n">fprs</span><span class="p">[(</span><span class="n">opc</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">].</span><span class="n">f</span><span class="p">)</span>
			<span class="o">:</span> <span class="s">&quot;1&quot;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span>  <span class="cm">/* move fp_regs.fprs[ry] to fp_regs.fprs[rx] */</span>
                <span class="n">fp_regs</span><span class="o">-&gt;</span><span class="n">fprs</span><span class="p">[(</span><span class="n">opc</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">fp_regs</span><span class="o">-&gt;</span><span class="n">fprs</span><span class="p">[</span><span class="n">opc</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Emulate LD R,D(X,B) with R not in {0, 2, 4, 6}</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">math_emu_ld</span><span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="n">opcode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span> <span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">s390_fp_regs</span> <span class="o">*</span><span class="n">fp_regs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">;</span>
        <span class="n">__u32</span> <span class="n">opc</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">opcode</span><span class="p">);</span>
        <span class="n">__u64</span> <span class="o">*</span><span class="n">dxb</span><span class="p">;</span>

        <span class="n">dxb</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span> <span class="o">*</span><span class="p">)</span> <span class="n">calc_addr</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opc</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">opc</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">,</span> <span class="n">opc</span><span class="p">);</span>
        <span class="n">mathemu_copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp_regs</span><span class="o">-&gt;</span><span class="n">fprs</span><span class="p">[(</span><span class="n">opc</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">].</span><span class="n">d</span><span class="p">,</span> <span class="n">dxb</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Emulate LE R,D(X,B) with R not in {0, 2, 4, 6}</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">math_emu_le</span><span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="n">opcode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span> <span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">s390_fp_regs</span> <span class="o">*</span><span class="n">fp_regs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">;</span>
        <span class="n">__u32</span> <span class="n">opc</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">opcode</span><span class="p">);</span>
        <span class="n">__u32</span> <span class="o">*</span><span class="n">mem</span><span class="p">,</span> <span class="o">*</span><span class="n">dxb</span><span class="p">;</span>

        <span class="n">dxb</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">calc_addr</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opc</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">opc</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">,</span> <span class="n">opc</span><span class="p">);</span>
        <span class="n">mem</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">fp_regs</span><span class="o">-&gt;</span><span class="n">fprs</span><span class="p">[(</span><span class="n">opc</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
        <span class="n">mathemu_get_user</span><span class="p">(</span><span class="n">mem</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dxb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Emulate STD R,D(X,B) with R not in {0, 2, 4, 6}</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">math_emu_std</span><span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="n">opcode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span> <span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">s390_fp_regs</span> <span class="o">*</span><span class="n">fp_regs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">;</span>
        <span class="n">__u32</span> <span class="n">opc</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">opcode</span><span class="p">);</span>
        <span class="n">__u64</span> <span class="o">*</span><span class="n">dxb</span><span class="p">;</span>

        <span class="n">dxb</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span> <span class="o">*</span><span class="p">)</span> <span class="n">calc_addr</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opc</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">opc</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">,</span> <span class="n">opc</span><span class="p">);</span>
        <span class="n">mathemu_copy_to_user</span><span class="p">(</span><span class="n">dxb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fp_regs</span><span class="o">-&gt;</span><span class="n">fprs</span><span class="p">[(</span><span class="n">opc</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">].</span><span class="n">d</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Emulate STE R,D(X,B) with R not in {0, 2, 4, 6}</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">math_emu_ste</span><span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="n">opcode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span> <span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">s390_fp_regs</span> <span class="o">*</span><span class="n">fp_regs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">;</span>
        <span class="n">__u32</span> <span class="n">opc</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">opcode</span><span class="p">);</span>
        <span class="n">__u32</span> <span class="o">*</span><span class="n">mem</span><span class="p">,</span> <span class="o">*</span><span class="n">dxb</span><span class="p">;</span>

        <span class="n">dxb</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">calc_addr</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">opc</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">opc</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">,</span> <span class="n">opc</span><span class="p">);</span>
        <span class="n">mem</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">fp_regs</span><span class="o">-&gt;</span><span class="n">fprs</span><span class="p">[(</span><span class="n">opc</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">].</span><span class="n">f</span><span class="p">);</span>
        <span class="n">mathemu_put_user</span><span class="p">(</span><span class="n">mem</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dxb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Emulate LFPC D(B)</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">math_emu_lfpc</span><span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="n">opcode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">__u32</span> <span class="n">opc</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">opcode</span><span class="p">);</span>
        <span class="n">__u32</span> <span class="o">*</span><span class="n">dxb</span><span class="p">,</span> <span class="n">temp</span><span class="p">;</span>

        <span class="n">dxb</span><span class="o">=</span> <span class="p">(</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">calc_addr</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">opc</span><span class="o">&gt;&gt;</span><span class="mi">12</span><span class="p">,</span> <span class="n">opc</span><span class="p">);</span>
        <span class="n">mathemu_get_user</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">dxb</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FPC_VALID_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SIGILL</span><span class="p">;</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Emulate STFPC D(B)</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">math_emu_stfpc</span><span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="n">opcode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">__u32</span> <span class="n">opc</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">opcode</span><span class="p">);</span>
        <span class="n">__u32</span> <span class="o">*</span><span class="n">dxb</span><span class="p">;</span>

        <span class="n">dxb</span><span class="o">=</span> <span class="p">(</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">calc_addr</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">opc</span><span class="o">&gt;&gt;</span><span class="mi">12</span><span class="p">,</span> <span class="n">opc</span><span class="p">);</span>
        <span class="n">mathemu_put_user</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span><span class="p">,</span> <span class="n">dxb</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Emulate SRNM D(B)</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">math_emu_srnm</span><span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="n">opcode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">__u32</span> <span class="n">opc</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">opcode</span><span class="p">);</span>
        <span class="n">__u32</span> <span class="n">temp</span><span class="p">;</span>

        <span class="n">temp</span> <span class="o">=</span> <span class="n">calc_addr</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">opc</span><span class="o">&gt;&gt;</span><span class="mi">12</span><span class="p">,</span> <span class="n">opc</span><span class="p">);</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
        <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fp_regs</span><span class="p">.</span><span class="n">fpc</span> <span class="o">|=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* broken compiler ... */</span>
<span class="kt">long</span> <span class="kt">long</span>
<span class="nf">__negdi2</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span> <span class="n">u</span><span class="p">)</span>
<span class="p">{</span>

  <span class="k">union</span> <span class="n">lll</span> <span class="p">{</span>
    <span class="kt">long</span> <span class="kt">long</span> <span class="n">ll</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
  <span class="p">};</span>

  <span class="k">union</span> <span class="n">lll</span> <span class="n">w</span><span class="p">,</span><span class="n">uu</span><span class="p">;</span>

  <span class="n">uu</span><span class="p">.</span><span class="n">ll</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>

  <span class="n">w</span><span class="p">.</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">uu</span><span class="p">.</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="n">w</span><span class="p">.</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">uu</span><span class="p">.</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">w</span><span class="p">.</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">w</span><span class="p">.</span><span class="n">ll</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
