<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › s390 › kernel › machine_kexec.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>machine_kexec.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * arch/s390/kernel/machine_kexec.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright IBM Corp. 2005,2011</span>
<span class="cm"> *</span>
<span class="cm"> * Author(s): Rolf Adelsberger,</span>
<span class="cm"> *	      Heiko Carstens &lt;heiko.carstens@de.ibm.com&gt;</span>
<span class="cm"> *	      Michael Holzheu &lt;holzheu@linux.vnet.ibm.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/kexec.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/reboot.h&gt;</span>
<span class="cp">#include &lt;linux/ftrace.h&gt;</span>
<span class="cp">#include &lt;linux/debug_locks.h&gt;</span>
<span class="cp">#include &lt;asm/cio.h&gt;</span>
<span class="cp">#include &lt;asm/setup.h&gt;</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#include &lt;asm/pgalloc.h&gt;</span>
<span class="cp">#include &lt;asm/smp.h&gt;</span>
<span class="cp">#include &lt;asm/reset.h&gt;</span>
<span class="cp">#include &lt;asm/ipl.h&gt;</span>
<span class="cp">#include &lt;asm/diag.h&gt;</span>
<span class="cp">#include &lt;asm/asm-offsets.h&gt;</span>
<span class="cp">#include &lt;asm/os_info.h&gt;</span>

<span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">relocate_kernel_t</span><span class="p">)(</span><span class="n">kimage_entry_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>

<span class="k">extern</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">relocate_kernel</span><span class="p">[];</span>
<span class="k">extern</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">relocate_kernel_len</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_CRASH_DUMP</span>

<span class="kt">void</span> <span class="o">*</span><span class="n">fill_cpu_elf_notes</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">save_area</span> <span class="o">*</span><span class="n">sa</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Create ELF notes for one CPU</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">add_elf_notes</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">save_area</span> <span class="o">*</span><span class="n">sa</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="mi">4608</span> <span class="o">+</span> <span class="n">store_prefix</span><span class="p">();</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="mi">4608UL</span> <span class="o">+</span> <span class="n">sa</span><span class="o">-&gt;</span><span class="n">pref_reg</span><span class="p">),</span> <span class="n">sa</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sa</span><span class="p">));</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span> <span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">crash_notes</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">fill_cpu_elf_notes</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">sa</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">elf_note</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize CPU ELF notes</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">setup_regs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sa</span> <span class="o">=</span> <span class="n">S390_lowcore</span><span class="p">.</span><span class="n">prefixreg_save_area</span> <span class="o">+</span> <span class="n">SAVE_AREA_BASE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">this_cpu</span><span class="p">;</span>

	<span class="n">this_cpu</span> <span class="o">=</span> <span class="n">smp_find_processor_id</span><span class="p">(</span><span class="n">stap</span><span class="p">());</span>
	<span class="n">add_elf_notes</span><span class="p">(</span><span class="n">this_cpu</span><span class="p">);</span>
	<span class="n">for_each_online_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">==</span> <span class="n">this_cpu</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">smp_store_status</span><span class="p">(</span><span class="n">cpu</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">add_elf_notes</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Copy dump CPU store status info to absolute zero */</span>
	<span class="n">memcpy</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">SAVE_AREA_BASE</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">sa</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">save_area</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Start kdump: We expect here that a store status has been done on our CPU</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__do_machine_kdump</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">image</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_CRASH_DUMP</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">start_kdump</span><span class="p">)(</span><span class="kt">int</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)((</span><span class="k">struct</span> <span class="n">kimage</span> <span class="o">*</span><span class="p">)</span> <span class="n">image</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

	<span class="n">setup_regs</span><span class="p">();</span>
	<span class="n">__load_psw_mask</span><span class="p">(</span><span class="n">PSW_MASK_BASE</span> <span class="o">|</span> <span class="n">PSW_DEFAULT_KEY</span> <span class="o">|</span> <span class="n">PSW_MASK_EA</span> <span class="o">|</span> <span class="n">PSW_MASK_BA</span><span class="p">);</span>
	<span class="n">start_kdump</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check if kdump checksums are valid: We call purgatory with parameter &quot;0&quot;</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">kdump_csum_valid</span><span class="p">(</span><span class="k">struct</span> <span class="n">kimage</span> <span class="o">*</span><span class="n">image</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_CRASH_DUMP</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">start_kdump</span><span class="p">)(</span><span class="kt">int</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">__arch_local_irq_stnsm</span><span class="p">(</span><span class="mh">0xfb</span><span class="p">);</span> <span class="cm">/* disable DAT */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">start_kdump</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">__arch_local_irq_stosm</span><span class="p">(</span><span class="mh">0x04</span><span class="p">);</span> <span class="cm">/* enable DAT */</span>
	<span class="k">return</span> <span class="n">rc</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Map or unmap crashkernel memory</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">crash_map_pages</span><span class="p">(</span><span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crashk_res</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">crashk_res</span><span class="p">.</span><span class="n">start</span> <span class="o">%</span> <span class="n">KEXEC_CRASH_MEM_ALIGN</span> <span class="o">||</span>
	       <span class="n">size</span> <span class="o">%</span> <span class="n">KEXEC_CRASH_MEM_ALIGN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">vmem_add_mapping</span><span class="p">(</span><span class="n">crashk_res</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">vmem_remove_mapping</span><span class="p">(</span><span class="n">crashk_res</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span>
			<span class="n">os_info_crashkernel_add</span><span class="p">(</span><span class="n">crashk_res</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">os_info_crashkernel_add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Map crashkernel memory</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">crash_map_reserved_pages</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">crash_map_pages</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Unmap crashkernel memory</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">crash_unmap_reserved_pages</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">crash_map_pages</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Give back memory to hypervisor before new kdump is loaded</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">machine_kexec_prepare_kdump</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_CRASH_DUMP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MACHINE_IS_VM</span><span class="p">)</span>
		<span class="n">diag10_range</span><span class="p">(</span><span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">crashk_res</span><span class="p">.</span><span class="n">start</span><span class="p">),</span>
			     <span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">crashk_res</span><span class="p">.</span><span class="n">end</span> <span class="o">-</span> <span class="n">crashk_res</span><span class="p">.</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">machine_kexec_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">kimage</span> <span class="o">*</span><span class="n">image</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">reboot_code_buffer</span><span class="p">;</span>

	<span class="cm">/* Can&#39;t replace kernel image since it is read-only. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipl_flags</span> <span class="o">&amp;</span> <span class="n">IPL_NSS_VALID</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">KEXEC_TYPE_CRASH</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">machine_kexec_prepare_kdump</span><span class="p">();</span>

	<span class="cm">/* We don&#39;t support anything but the default image type for now. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">KEXEC_TYPE_DEFAULT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Get the destination where the assembler code should be copied to.*/</span>
	<span class="n">reboot_code_buffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">page_to_phys</span><span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">control_code_page</span><span class="p">);</span>

	<span class="cm">/* Then copy it */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">reboot_code_buffer</span><span class="p">,</span> <span class="n">relocate_kernel</span><span class="p">,</span> <span class="n">relocate_kernel_len</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">machine_kexec_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">kimage</span> <span class="o">*</span><span class="n">image</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">arch_crash_save_vmcoreinfo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">VMCOREINFO_SYMBOL</span><span class="p">(</span><span class="n">lowcore_ptr</span><span class="p">);</span>
	<span class="n">VMCOREINFO_SYMBOL</span><span class="p">(</span><span class="n">high_memory</span><span class="p">);</span>
	<span class="n">VMCOREINFO_LENGTH</span><span class="p">(</span><span class="n">lowcore_ptr</span><span class="p">,</span> <span class="n">NR_CPUS</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">machine_shutdown</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Do normal kexec</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__do_machine_kexec</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">relocate_kernel_t</span> <span class="n">data_mover</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kimage</span> <span class="o">*</span><span class="n">image</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">data_mover</span> <span class="o">=</span> <span class="p">(</span><span class="n">relocate_kernel_t</span><span class="p">)</span> <span class="n">page_to_phys</span><span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">control_code_page</span><span class="p">);</span>

	<span class="cm">/* Call the moving routine */</span>
	<span class="p">(</span><span class="o">*</span><span class="n">data_mover</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reset system and call either kdump or normal kexec</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__machine_kexec</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kimage</span> <span class="o">*</span><span class="n">image</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">__arch_local_irq_stosm</span><span class="p">(</span><span class="mh">0x04</span><span class="p">);</span> <span class="cm">/* enable DAT */</span>
	<span class="n">pfault_fini</span><span class="p">();</span>
	<span class="n">tracing_off</span><span class="p">();</span>
	<span class="n">debug_locks_off</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">KEXEC_TYPE_CRASH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lgr_info_log</span><span class="p">();</span>
		<span class="n">s390_reset_system</span><span class="p">(</span><span class="n">__do_machine_kdump</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">s390_reset_system</span><span class="p">(</span><span class="n">__do_machine_kexec</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">disabled_wait</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">__builtin_return_address</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Do either kdump or normal kexec. In case of kdump we first ask</span>
<span class="cm"> * purgatory, if kdump checksums are valid.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">machine_kexec</span><span class="p">(</span><span class="k">struct</span> <span class="n">kimage</span> <span class="o">*</span><span class="n">image</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">KEXEC_TYPE_CRASH</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">kdump_csum_valid</span><span class="p">(</span><span class="n">image</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">tracer_disable</span><span class="p">();</span>
	<span class="n">smp_send_stop</span><span class="p">();</span>
	<span class="n">smp_call_ipl_cpu</span><span class="p">(</span><span class="n">__machine_kexec</span><span class="p">,</span> <span class="n">image</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
