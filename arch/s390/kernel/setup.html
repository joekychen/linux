<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › s390 › kernel › setup.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>setup.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  arch/s390/kernel/setup.c</span>
<span class="cm"> *</span>
<span class="cm"> *  S390 version</span>
<span class="cm"> *    Copyright (C) IBM Corp. 1999,2012</span>
<span class="cm"> *    Author(s): Hartmut Penner (hp@de.ibm.com),</span>
<span class="cm"> *               Martin Schwidefsky (schwidefsky@de.ibm.com)</span>
<span class="cm"> *</span>
<span class="cm"> *  Derived from &quot;arch/i386/kernel/setup.c&quot;</span>
<span class="cm"> *    Copyright (C) 1995, Linus Torvalds</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * This file handles the architecture-dependent parts of initialization</span>
<span class="cm"> */</span>

<span class="cp">#define KMSG_COMPONENT &quot;setup&quot;</span>
<span class="cp">#define pr_fmt(fmt) KMSG_COMPONENT &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/memblock.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/stddef.h&gt;</span>
<span class="cp">#include &lt;linux/unistd.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/user.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/initrd.h&gt;</span>
<span class="cp">#include &lt;linux/bootmem.h&gt;</span>
<span class="cp">#include &lt;linux/root_dev.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/kernel_stat.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/notifier.h&gt;</span>
<span class="cp">#include &lt;linux/pfn.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/reboot.h&gt;</span>
<span class="cp">#include &lt;linux/topology.h&gt;</span>
<span class="cp">#include &lt;linux/ftrace.h&gt;</span>
<span class="cp">#include &lt;linux/kexec.h&gt;</span>
<span class="cp">#include &lt;linux/crash_dump.h&gt;</span>
<span class="cp">#include &lt;linux/memory.h&gt;</span>
<span class="cp">#include &lt;linux/compat.h&gt;</span>

<span class="cp">#include &lt;asm/ipl.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/facility.h&gt;</span>
<span class="cp">#include &lt;asm/smp.h&gt;</span>
<span class="cp">#include &lt;asm/mmu_context.h&gt;</span>
<span class="cp">#include &lt;asm/cpcmd.h&gt;</span>
<span class="cp">#include &lt;asm/lowcore.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/page.h&gt;</span>
<span class="cp">#include &lt;asm/ptrace.h&gt;</span>
<span class="cp">#include &lt;asm/sections.h&gt;</span>
<span class="cp">#include &lt;asm/ebcdic.h&gt;</span>
<span class="cp">#include &lt;asm/kvm_virtio.h&gt;</span>
<span class="cp">#include &lt;asm/diag.h&gt;</span>
<span class="cp">#include &lt;asm/os_info.h&gt;</span>
<span class="cp">#include &quot;entry.h&quot;</span>

<span class="kt">long</span> <span class="n">psw_kernel_bits</span>	<span class="o">=</span> <span class="n">PSW_DEFAULT_KEY</span> <span class="o">|</span> <span class="n">PSW_MASK_BASE</span> <span class="o">|</span> <span class="n">PSW_ASC_PRIMARY</span> <span class="o">|</span>
			  <span class="n">PSW_MASK_EA</span> <span class="o">|</span> <span class="n">PSW_MASK_BA</span><span class="p">;</span>
<span class="kt">long</span> <span class="n">psw_user_bits</span>	<span class="o">=</span> <span class="n">PSW_MASK_DAT</span> <span class="o">|</span> <span class="n">PSW_MASK_IO</span> <span class="o">|</span> <span class="n">PSW_MASK_EXT</span> <span class="o">|</span>
			  <span class="n">PSW_DEFAULT_KEY</span> <span class="o">|</span> <span class="n">PSW_MASK_BASE</span> <span class="o">|</span> <span class="n">PSW_MASK_MCHECK</span> <span class="o">|</span>
			  <span class="n">PSW_MASK_PSTATE</span> <span class="o">|</span> <span class="n">PSW_ASC_HOME</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * User copy operations.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">uaccess_ops</span> <span class="n">uaccess</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">uaccess</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Machine setup..</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">console_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">console_mode</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">console_devno</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">console_devno</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">console_irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">console_irq</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elf_hwcap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">char</span> <span class="n">elf_platform</span><span class="p">[</span><span class="n">ELF_PLATFORM_SIZE</span><span class="p">];</span>

<span class="k">struct</span> <span class="n">mem_chunk</span> <span class="n">__initdata</span> <span class="n">memory_chunk</span><span class="p">[</span><span class="n">MEMORY_CHUNKS</span><span class="p">];</span>

<span class="kt">int</span> <span class="n">__initdata</span> <span class="n">memory_end_set</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__initdata</span> <span class="n">memory_end</span><span class="p">;</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">VMALLOC_START</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">VMALLOC_START</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">VMALLOC_END</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">VMALLOC_END</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">vmemmap</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">vmemmap</span><span class="p">);</span>

<span class="cm">/* An array with a pointer to the lowcore of every CPU. */</span>
<span class="k">struct</span> <span class="n">_lowcore</span> <span class="o">*</span><span class="n">lowcore_ptr</span><span class="p">[</span><span class="n">NR_CPUS</span><span class="p">];</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">lowcore_ptr</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * This is set up by the setup-routine at boot-time</span>
<span class="cm"> * for S390 need to find out, what we have to setup</span>
<span class="cm"> * using address 0x10400 ...</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;asm/setup.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * condev= and conmode= setup parameter.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">condev_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">vdev</span><span class="p">;</span>

	<span class="n">vdev</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">str</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">vdev</span> <span class="o">&lt;</span> <span class="mi">65536</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">console_devno</span> <span class="o">=</span> <span class="n">vdev</span><span class="p">;</span>
		<span class="n">console_irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;condev=&quot;</span><span class="p">,</span> <span class="n">condev_setup</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">set_preferred_console</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MACHINE_IS_KVM</span><span class="p">)</span>
		<span class="n">add_preferred_console</span><span class="p">(</span><span class="s">&quot;hvc&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CONSOLE_IS_3215</span> <span class="o">||</span> <span class="n">CONSOLE_IS_SCLP</span><span class="p">)</span>
		<span class="n">add_preferred_console</span><span class="p">(</span><span class="s">&quot;ttyS&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CONSOLE_IS_3270</span><span class="p">)</span>
		<span class="n">add_preferred_console</span><span class="p">(</span><span class="s">&quot;tty3270&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">conmode_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_SCLP_CONSOLE) || defined(CONFIG_SCLP_VT220_CONSOLE)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;hwc&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;sclp&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">SET_CONSOLE_SCLP</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(CONFIG_TN3215_CONSOLE)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;3215&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">SET_CONSOLE_3215</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(CONFIG_TN3270_CONSOLE)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;3270&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">SET_CONSOLE_3270</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">set_preferred_console</span><span class="p">();</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;conmode=&quot;</span><span class="p">,</span> <span class="n">conmode_setup</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">conmode_default</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">query_buffer</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">MACHINE_IS_VM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpcmd</span><span class="p">(</span><span class="s">&quot;QUERY CONSOLE&quot;</span><span class="p">,</span> <span class="n">query_buffer</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">console_devno</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">query_buffer</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">query_buffer</span><span class="p">,</span> <span class="s">&quot;SUBCHANNEL =&quot;</span><span class="p">);</span>
		<span class="n">console_irq</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">13</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">cpcmd</span><span class="p">(</span><span class="s">&quot;QUERY TERM&quot;</span><span class="p">,</span> <span class="n">query_buffer</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">query_buffer</span><span class="p">,</span> <span class="s">&quot;CONMODE&quot;</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Set the conmode to 3215 so that the device recognition </span>
<span class="cm">		 * will set the cu_type of the console to 3215. If the</span>
<span class="cm">		 * conmode is 3270 and we don&#39;t set it back then both</span>
<span class="cm">		 * 3215 and the 3270 driver will try to access the console</span>
<span class="cm">		 * device (3215 as console and 3270 as normal tty).</span>
<span class="cm">		 */</span>
		<span class="n">cpcmd</span><span class="p">(</span><span class="s">&quot;TERM CONMODE 3215&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if defined(CONFIG_SCLP_CONSOLE) || defined(CONFIG_SCLP_VT220_CONSOLE)</span>
			<span class="n">SET_CONSOLE_SCLP</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&quot;3270&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if defined(CONFIG_TN3270_CONSOLE)</span>
			<span class="n">SET_CONSOLE_3270</span><span class="p">;</span>
<span class="cp">#elif defined(CONFIG_TN3215_CONSOLE)</span>
			<span class="n">SET_CONSOLE_3215</span><span class="p">;</span>
<span class="cp">#elif defined(CONFIG_SCLP_CONSOLE) || defined(CONFIG_SCLP_VT220_CONSOLE)</span>
			<span class="n">SET_CONSOLE_SCLP</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&quot;3215&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if defined(CONFIG_TN3215_CONSOLE)</span>
			<span class="n">SET_CONSOLE_3215</span><span class="p">;</span>
<span class="cp">#elif defined(CONFIG_TN3270_CONSOLE)</span>
			<span class="n">SET_CONSOLE_3270</span><span class="p">;</span>
<span class="cp">#elif defined(CONFIG_SCLP_CONSOLE) || defined(CONFIG_SCLP_VT220_CONSOLE)</span>
			<span class="n">SET_CONSOLE_SCLP</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#if defined(CONFIG_SCLP_CONSOLE) || defined(CONFIG_SCLP_VT220_CONSOLE)</span>
		<span class="n">SET_CONSOLE_SCLP</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_ZFCPDUMP</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">setup_zfcpdump</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">console_devno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">str</span><span class="p">[</span><span class="mi">41</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipl_info</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">IPL_TYPE_FCP_DUMP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">OLDMEM_BASE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">console_devno</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot; cio_ignore=all,!0.0.%04x,!0.0.%04x&quot;</span><span class="p">,</span>
			<span class="n">ipl_info</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">fcp</span><span class="p">.</span><span class="n">dev_id</span><span class="p">.</span><span class="n">devno</span><span class="p">,</span> <span class="n">console_devno</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot; cio_ignore=all,!0.0.%04x&quot;</span><span class="p">,</span>
			<span class="n">ipl_info</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">fcp</span><span class="p">.</span><span class="n">dev_id</span><span class="p">.</span><span class="n">devno</span><span class="p">);</span>
	<span class="n">strcat</span><span class="p">(</span><span class="n">boot_command_line</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
	<span class="n">console_loglevel</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">setup_zfcpdump</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">console_devno</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ZFCPDUMP */</span><span class="cp"></span>

 <span class="cm">/*</span>
<span class="cm"> * Reboot, halt and power_off stubs. They just call _machine_restart,</span>
<span class="cm"> * _machine_halt or _machine_power_off. </span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">machine_restart</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">command</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">in_interrupt</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">in_atomic</span><span class="p">())</span> <span class="o">||</span> <span class="n">oops_in_progress</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * Only unblank the console if we are called in enabled</span>
<span class="cm">		 * context or a bust_spinlocks cleared the way for us.</span>
<span class="cm">		 */</span>
		<span class="n">console_unblank</span><span class="p">();</span>
	<span class="n">_machine_restart</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">machine_halt</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_interrupt</span><span class="p">()</span> <span class="o">||</span> <span class="n">oops_in_progress</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * Only unblank the console if we are called in enabled</span>
<span class="cm">		 * context or a bust_spinlocks cleared the way for us.</span>
<span class="cm">		 */</span>
		<span class="n">console_unblank</span><span class="p">();</span>
	<span class="n">_machine_halt</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">machine_power_off</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_interrupt</span><span class="p">()</span> <span class="o">||</span> <span class="n">oops_in_progress</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * Only unblank the console if we are called in enabled</span>
<span class="cm">		 * context or a bust_spinlocks cleared the way for us.</span>
<span class="cm">		 */</span>
		<span class="n">console_unblank</span><span class="p">();</span>
	<span class="n">_machine_power_off</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Dummy power off function.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">pm_power_off</span><span class="p">)(</span><span class="kt">void</span><span class="p">)</span> <span class="o">=</span> <span class="n">machine_power_off</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">early_parse_mem</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memory_end</span> <span class="o">=</span> <span class="n">memparse</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>
	<span class="n">memory_end_set</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">early_param</span><span class="p">(</span><span class="s">&quot;mem&quot;</span><span class="p">,</span> <span class="n">early_parse_mem</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">parse_vmalloc</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">VMALLOC_END</span> <span class="o">=</span> <span class="p">(</span><span class="n">memparse</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">)</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">early_param</span><span class="p">(</span><span class="s">&quot;vmalloc&quot;</span><span class="p">,</span> <span class="n">parse_vmalloc</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">user_mode</span> <span class="o">=</span> <span class="n">HOME_SPACE_MODE</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">user_mode</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_amode_primary</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">psw_kernel_bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">psw_kernel_bits</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PSW_MASK_ASC</span><span class="p">)</span> <span class="o">|</span> <span class="n">PSW_ASC_HOME</span><span class="p">;</span>
	<span class="n">psw_user_bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">psw_user_bits</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PSW_MASK_ASC</span><span class="p">)</span> <span class="o">|</span> <span class="n">PSW_ASC_PRIMARY</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
	<span class="n">psw32_user_bits</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">psw32_user_bits</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PSW32_MASK_ASC</span><span class="p">)</span> <span class="o">|</span> <span class="n">PSW32_ASC_PRIMARY</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">MACHINE_HAS_MVCOS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uaccess</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uaccess_mvcos_switch</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uaccess</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uaccess</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uaccess_pt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uaccess</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Switch kernel/user addressing modes?</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">early_parse_switch_amode</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">user_mode</span> <span class="o">=</span> <span class="n">PRIMARY_SPACE_MODE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">early_param</span><span class="p">(</span><span class="s">&quot;switch_amode&quot;</span><span class="p">,</span> <span class="n">early_parse_switch_amode</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">early_parse_user_mode</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;primary&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">user_mode</span> <span class="o">=</span> <span class="n">PRIMARY_SPACE_MODE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span> <span class="o">||</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;home&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">user_mode</span> <span class="o">=</span> <span class="n">HOME_SPACE_MODE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">early_param</span><span class="p">(</span><span class="s">&quot;user_mode&quot;</span><span class="p">,</span> <span class="n">early_parse_user_mode</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_addressing_mode</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">user_mode</span> <span class="o">==</span> <span class="n">PRIMARY_SPACE_MODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set_amode_primary</span><span class="p">())</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Address spaces switched, &quot;</span>
				<span class="s">&quot;mvcos available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Address spaces switched, &quot;</span>
				<span class="s">&quot;mvcos not available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="o">*</span><span class="n">restart_stack</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">__section__</span><span class="p">(</span><span class="s">&quot;.data&quot;</span><span class="p">)));</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">setup_lowcore</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_lowcore</span> <span class="o">*</span><span class="n">lc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup lowcore for boot cpu</span>
<span class="cm">	 */</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">_lowcore</span><span class="p">)</span> <span class="o">!=</span> <span class="n">LC_PAGES</span> <span class="o">*</span> <span class="mi">4096</span><span class="p">);</span>
	<span class="n">lc</span> <span class="o">=</span> <span class="n">__alloc_bootmem_low</span><span class="p">(</span><span class="n">LC_PAGES</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">LC_PAGES</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">restart_psw</span><span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">psw_kernel_bits</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">restart_psw</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span>
		<span class="n">PSW_ADDR_AMODE</span> <span class="o">|</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">restart_int_handler</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">external_new_psw</span><span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">psw_kernel_bits</span> <span class="o">|</span>
		<span class="n">PSW_MASK_DAT</span> <span class="o">|</span> <span class="n">PSW_MASK_MCHECK</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">external_new_psw</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span>
		<span class="n">PSW_ADDR_AMODE</span> <span class="o">|</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">ext_int_handler</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">svc_new_psw</span><span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">psw_kernel_bits</span> <span class="o">|</span>
		<span class="n">PSW_MASK_DAT</span> <span class="o">|</span> <span class="n">PSW_MASK_IO</span> <span class="o">|</span> <span class="n">PSW_MASK_EXT</span> <span class="o">|</span> <span class="n">PSW_MASK_MCHECK</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">svc_new_psw</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">PSW_ADDR_AMODE</span> <span class="o">|</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">system_call</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">program_new_psw</span><span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">psw_kernel_bits</span> <span class="o">|</span>
		<span class="n">PSW_MASK_DAT</span> <span class="o">|</span> <span class="n">PSW_MASK_MCHECK</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">program_new_psw</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span>
		<span class="n">PSW_ADDR_AMODE</span> <span class="o">|</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pgm_check_handler</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">mcck_new_psw</span><span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">psw_kernel_bits</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">mcck_new_psw</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span>
		<span class="n">PSW_ADDR_AMODE</span> <span class="o">|</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">mcck_int_handler</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">io_new_psw</span><span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">psw_kernel_bits</span> <span class="o">|</span>
		<span class="n">PSW_MASK_DAT</span> <span class="o">|</span> <span class="n">PSW_MASK_MCHECK</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">io_new_psw</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">PSW_ADDR_AMODE</span> <span class="o">|</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">io_int_handler</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">clock_comparator</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1ULL</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">kernel_stack</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">init_thread_union</span><span class="p">)</span> <span class="o">+</span> <span class="n">THREAD_SIZE</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">async_stack</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span>
		<span class="n">__alloc_bootmem</span><span class="p">(</span><span class="n">ASYNC_SIZE</span><span class="p">,</span> <span class="n">ASYNC_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">ASYNC_SIZE</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">panic_stack</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span>
		<span class="n">__alloc_bootmem</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">current_task</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">init_thread_union</span><span class="p">.</span><span class="n">thread_info</span><span class="p">.</span><span class="n">task</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">thread_info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">init_thread_union</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">machine_flags</span> <span class="o">=</span> <span class="n">S390_lowcore</span><span class="p">.</span><span class="n">machine_flags</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">stfl_fac_list</span> <span class="o">=</span> <span class="n">S390_lowcore</span><span class="p">.</span><span class="n">stfl_fac_list</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">lc</span><span class="o">-&gt;</span><span class="n">stfle_fac_list</span><span class="p">,</span> <span class="n">S390_lowcore</span><span class="p">.</span><span class="n">stfle_fac_list</span><span class="p">,</span>
	       <span class="n">MAX_FACILITY_BIT</span><span class="o">/</span><span class="mi">8</span><span class="p">);</span>
<span class="cp">#ifndef CONFIG_64BIT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MACHINE_HAS_IEEE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lc</span><span class="o">-&gt;</span><span class="n">extended_save_area_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span>
			<span class="n">__alloc_bootmem_low</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* enable extended save area */</span>
		<span class="n">__ctl_set_bit</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">29</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">vdso_per_cpu_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">lc</span><span class="o">-&gt;</span><span class="n">paste</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="cp">#endif</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">sync_enter_timer</span> <span class="o">=</span> <span class="n">S390_lowcore</span><span class="p">.</span><span class="n">sync_enter_timer</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">async_enter_timer</span> <span class="o">=</span> <span class="n">S390_lowcore</span><span class="p">.</span><span class="n">async_enter_timer</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">exit_timer</span> <span class="o">=</span> <span class="n">S390_lowcore</span><span class="p">.</span><span class="n">exit_timer</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">user_timer</span> <span class="o">=</span> <span class="n">S390_lowcore</span><span class="p">.</span><span class="n">user_timer</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">system_timer</span> <span class="o">=</span> <span class="n">S390_lowcore</span><span class="p">.</span><span class="n">system_timer</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">steal_timer</span> <span class="o">=</span> <span class="n">S390_lowcore</span><span class="p">.</span><span class="n">steal_timer</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">last_update_timer</span> <span class="o">=</span> <span class="n">S390_lowcore</span><span class="p">.</span><span class="n">last_update_timer</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">last_update_clock</span> <span class="o">=</span> <span class="n">S390_lowcore</span><span class="p">.</span><span class="n">last_update_clock</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">ftrace_func</span> <span class="o">=</span> <span class="n">S390_lowcore</span><span class="p">.</span><span class="n">ftrace_func</span><span class="p">;</span>

	<span class="n">restart_stack</span> <span class="o">=</span> <span class="n">__alloc_bootmem</span><span class="p">(</span><span class="n">ASYNC_SIZE</span><span class="p">,</span> <span class="n">ASYNC_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">restart_stack</span> <span class="o">+=</span> <span class="n">ASYNC_SIZE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up PSW restart to call ipl.c:do_restart(). Copy the relevant</span>
<span class="cm">	 * restart data to the absolute zero lowcore. This is necesary if</span>
<span class="cm">	 * PSW restart is done on an offline CPU that has lowcore zero.</span>
<span class="cm">	 */</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">restart_stack</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">restart_stack</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">restart_fn</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">do_restart</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">restart_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lc</span><span class="o">-&gt;</span><span class="n">restart_source</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1UL</span><span class="p">;</span>

	<span class="cm">/* Setup absolute zero lowcore */</span>
	<span class="n">memcpy_absolute</span><span class="p">(</span><span class="o">&amp;</span><span class="n">S390_lowcore</span><span class="p">.</span><span class="n">restart_stack</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lc</span><span class="o">-&gt;</span><span class="n">restart_stack</span><span class="p">,</span>
			<span class="mi">4</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">));</span>
	<span class="n">memcpy_absolute</span><span class="p">(</span><span class="o">&amp;</span><span class="n">S390_lowcore</span><span class="p">.</span><span class="n">restart_psw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lc</span><span class="o">-&gt;</span><span class="n">restart_psw</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">lc</span><span class="o">-&gt;</span><span class="n">restart_psw</span><span class="p">));</span>

	<span class="n">set_prefix</span><span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">lc</span><span class="p">);</span>
	<span class="n">lowcore_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">lc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">code_resource</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;Kernel code&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_BUSY</span> <span class="o">|</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">data_resource</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Kernel data&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_BUSY</span> <span class="o">|</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">bss_resource</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Kernel bss&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_BUSY</span> <span class="o">|</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">__initdata</span> <span class="o">*</span><span class="n">standard_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">code_resource</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">data_resource</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">bss_resource</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">setup_resources</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="o">*</span><span class="n">std_res</span><span class="p">,</span> <span class="o">*</span><span class="n">sub_res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">code_resource</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">_text</span><span class="p">;</span>
	<span class="n">code_resource</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">_etext</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">data_resource</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">_etext</span><span class="p">;</span>
	<span class="n">data_resource</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">_edata</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">bss_resource</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">__bss_start</span><span class="p">;</span>
	<span class="n">bss_resource</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">__bss_stop</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MEMORY_CHUNKS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memory_chunk</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memory_chunk</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">CHUNK_OLDMEM</span> <span class="o">||</span>
		    <span class="n">memory_chunk</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">CHUNK_CRASHK</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">alloc_bootmem_low</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">));</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_BUSY</span> <span class="o">|</span> <span class="n">IORESOURCE_MEM</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">memory_chunk</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CHUNK_READ_WRITE</span>:
		<span class="k">case</span> <span class="n">CHUNK_CRASHK</span>:
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;System RAM&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CHUNK_READ_ONLY</span>:
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;System ROM&quot;</span><span class="p">;</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IORESOURCE_READONLY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;reserved&quot;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">memory_chunk</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">;</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">memory_chunk</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">request_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iomem_resource</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">standard_resources</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">std_res</span> <span class="o">=</span> <span class="n">standard_resources</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">std_res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">||</span>
			    <span class="n">std_res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">std_res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sub_res</span> <span class="o">=</span> <span class="n">alloc_bootmem_low</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sub_res</span><span class="p">));</span>
				<span class="o">*</span><span class="n">sub_res</span> <span class="o">=</span> <span class="o">*</span><span class="n">std_res</span><span class="p">;</span>
				<span class="n">sub_res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">;</span>
				<span class="n">std_res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">request_resource</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">sub_res</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">request_resource</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">std_res</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">real_memory_size</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">real_memory_size</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">setup_memory_end</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">vmalloc_size</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>


<span class="cp">#ifdef CONFIG_ZFCPDUMP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipl_info</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">IPL_TYPE_FCP_DUMP</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">OLDMEM_BASE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memory_end</span> <span class="o">=</span> <span class="n">ZFCPDUMP_HSA_SIZE</span><span class="p">;</span>
		<span class="n">memory_end_set</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">real_memory_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memory_end</span> <span class="o">&amp;=</span> <span class="n">PAGE_MASK</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure all chunks are MAX_ORDER aligned so we don&#39;t need the</span>
<span class="cm">	 * extra checks that HOLES_IN_ZONE would require.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MEMORY_CHUNKS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">mem_chunk</span> <span class="o">*</span><span class="n">chunk</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">align</span><span class="p">;</span>

		<span class="n">chunk</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">memory_chunk</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">align</span> <span class="o">=</span> <span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">MAX_ORDER</span> <span class="o">+</span> <span class="n">PAGE_SHIFT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">chunk</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">align</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">align</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">chunk</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">align</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="n">end</span><span class="p">)</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">chunk</span><span class="p">));</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">chunk</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
			<span class="n">chunk</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">real_memory_size</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">real_memory_size</span><span class="p">,</span>
				       <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Choose kernel address space layout: 2, 3, or 4 levels. */</span>
<span class="cp">#ifdef CONFIG_64BIT</span>
	<span class="n">vmalloc_size</span> <span class="o">=</span> <span class="n">VMALLOC_END</span> <span class="o">?:</span> <span class="mi">128UL</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">memory_end</span> <span class="o">?:</span> <span class="n">real_memory_size</span><span class="p">)</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">*</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span><span class="p">)</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">+</span> <span class="n">vmalloc_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">42</span><span class="p">))</span>
		<span class="n">vmax</span> <span class="o">=</span> <span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">42</span><span class="p">;</span>	<span class="cm">/* 3-level kernel page table */</span>
	<span class="k">else</span>
		<span class="n">vmax</span> <span class="o">=</span> <span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">53</span><span class="p">;</span>	<span class="cm">/* 4-level kernel page table */</span>
<span class="cp">#else</span>
	<span class="n">vmalloc_size</span> <span class="o">=</span> <span class="n">VMALLOC_END</span> <span class="o">?:</span> <span class="mi">96UL</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
	<span class="n">vmax</span> <span class="o">=</span> <span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">;</span>		<span class="cm">/* 2-level kernel page table */</span>
<span class="cp">#endif</span>
	<span class="cm">/* vmalloc area is at the end of the kernel address space. */</span>
	<span class="n">VMALLOC_END</span> <span class="o">=</span> <span class="n">vmax</span><span class="p">;</span>
	<span class="n">VMALLOC_START</span> <span class="o">=</span> <span class="n">vmax</span> <span class="o">-</span> <span class="n">vmalloc_size</span><span class="p">;</span>

	<span class="cm">/* Split remaining virtual space between 1:1 mapping &amp; vmemmap array */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">VMALLOC_START</span> <span class="o">/</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span><span class="p">));</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">VMALLOC_START</span> <span class="o">-</span> <span class="n">tmp</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="n">vmax</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* align to page table level */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">MAX_PHYSMEM_BITS</span><span class="p">);</span>
	<span class="n">vmemmap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="p">)</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* Take care that memory_end is set and &lt;= vmemmap */</span>
	<span class="n">memory_end</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">memory_end</span> <span class="o">?:</span> <span class="n">real_memory_size</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="cm">/* Fixup memory chunk array to fit into 0..memory_end */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MEMORY_CHUNKS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mem_chunk</span> <span class="o">*</span><span class="n">chunk</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">memory_chunk</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chunk</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">memory_end</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">chunk</span><span class="p">));</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chunk</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">memory_end</span><span class="p">)</span>
			<span class="n">chunk</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">memory_end</span> <span class="o">-</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">setup_vmcoreinfo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_KEXEC</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">paddr_vmcoreinfo_note</span><span class="p">();</span>

	<span class="n">memcpy_absolute</span><span class="p">(</span><span class="o">&amp;</span><span class="n">S390_lowcore</span><span class="p">.</span><span class="n">vmcore_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ptr</span><span class="p">));</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_CRASH_DUMP</span>

<span class="cm">/*</span>
<span class="cm"> * Find suitable location for crashkernel memory</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__init</span> <span class="nf">find_crash_base</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">crash_size</span><span class="p">,</span>
					    <span class="kt">char</span> <span class="o">**</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">crash_base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mem_chunk</span> <span class="o">*</span><span class="n">chunk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memory_chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">crash_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;first memory chunk must be at least crashkernel size&quot;</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">OLDMEM_BASE</span> <span class="o">&amp;&amp;</span> <span class="n">crash_size</span> <span class="o">==</span> <span class="n">OLDMEM_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">OLDMEM_BASE</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">MEMORY_CHUNKS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chunk</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">memory_chunk</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chunk</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chunk</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">CHUNK_READ_WRITE</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chunk</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">crash_size</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">crash_base</span> <span class="o">=</span> <span class="p">(</span><span class="n">chunk</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="o">-</span> <span class="n">crash_size</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crash_base</span> <span class="o">&lt;</span> <span class="n">crash_size</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crash_base</span> <span class="o">&lt;</span> <span class="n">ZFCPDUMP_HSA_SIZE_MAX</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crash_base</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">INITRD_START</span> <span class="o">+</span> <span class="n">INITRD_SIZE</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">crash_base</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;no suitable area found&quot;</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check if crash_base and crash_size is valid</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">verify_crash_base</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">crash_base</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">crash_size</span><span class="p">,</span>
				    <span class="kt">char</span> <span class="o">**</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mem_chunk</span> <span class="o">*</span><span class="n">chunk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Because we do the swap to zero, we must have at least &#39;crash_size&#39;</span>
<span class="cm">	 * bytes free space before crash_base</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crash_size</span> <span class="o">&gt;</span> <span class="n">crash_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;crashkernel offset must be greater than size&quot;</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* First memory chunk must be at least crash_size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memory_chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">crash_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;first memory chunk must be at least crashkernel size&quot;</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Check if we fit into the respective memory chunk */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MEMORY_CHUNKS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chunk</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">memory_chunk</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chunk</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crash_base</span> <span class="o">&lt;</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crash_base</span> <span class="o">&gt;=</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* we have found the memory chunk */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crash_base</span> <span class="o">+</span> <span class="n">crash_size</span> <span class="o">&gt;</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;selected memory chunk is too small for &quot;</span>
				<span class="s">&quot;crashkernel memory&quot;</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;invalid memory range specified&quot;</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reserve kdump memory by creating a memory hole in the mem_chunk array</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">reserve_kdump_bootmem</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span>
					 <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">create_mem_hole</span><span class="p">(</span><span class="n">memory_chunk</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * When kdump is enabled, we have to ensure that no memory from</span>
<span class="cm"> * the area [0 - crashkernel memory size] and</span>
<span class="cm"> * [crashk_res.start - crashk_res.end] is set offline.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">kdump_mem_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">action</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">memory_notify</span> <span class="o">*</span><span class="n">arg</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">start_pfn</span> <span class="o">&lt;</span> <span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crashk_res</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">NOTIFY_BAD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">start_pfn</span> <span class="o">&gt;</span> <span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">crashk_res</span><span class="p">.</span><span class="n">end</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">start_pfn</span> <span class="o">+</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">nr_pages</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">crashk_res</span><span class="p">.</span><span class="n">start</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">NOTIFY_BAD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">kdump_mem_nb</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">kdump_mem_notifier</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Make sure that oldmem, where the dump is stored, is protected</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">reserve_oldmem</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_CRASH_DUMP</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">OLDMEM_BASE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">reserve_kdump_bootmem</span><span class="p">(</span><span class="n">OLDMEM_BASE</span><span class="p">,</span> <span class="n">OLDMEM_SIZE</span><span class="p">,</span> <span class="n">CHUNK_OLDMEM</span><span class="p">);</span>
	<span class="n">reserve_kdump_bootmem</span><span class="p">(</span><span class="n">OLDMEM_SIZE</span><span class="p">,</span> <span class="n">memory_end</span> <span class="o">-</span> <span class="n">OLDMEM_SIZE</span><span class="p">,</span>
			      <span class="n">CHUNK_OLDMEM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">OLDMEM_BASE</span> <span class="o">+</span> <span class="n">OLDMEM_SIZE</span> <span class="o">==</span> <span class="n">real_memory_size</span><span class="p">)</span>
		<span class="n">saved_max_pfn</span> <span class="o">=</span> <span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">OLDMEM_BASE</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">saved_max_pfn</span> <span class="o">=</span> <span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">real_memory_size</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reserve memory for kdump kernel to be loaded with kexec</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">reserve_crashkernel</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_CRASH_DUMP</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">crash_base</span><span class="p">,</span> <span class="n">crash_size</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">parse_crashkernel</span><span class="p">(</span><span class="n">boot_command_line</span><span class="p">,</span> <span class="n">memory_end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crash_size</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">crash_base</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">||</span> <span class="n">crash_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">crash_base</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">crash_base</span><span class="p">,</span> <span class="n">KEXEC_CRASH_MEM_ALIGN</span><span class="p">);</span>
	<span class="n">crash_size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">crash_size</span><span class="p">,</span> <span class="n">KEXEC_CRASH_MEM_ALIGN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">register_memory_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kdump_mem_nb</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crash_base</span><span class="p">)</span>
		<span class="n">crash_base</span> <span class="o">=</span> <span class="n">find_crash_base</span><span class="p">(</span><span class="n">crash_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crash_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;crashkernel reservation failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="n">unregister_memory_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kdump_mem_nb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">verify_crash_base</span><span class="p">(</span><span class="n">crash_base</span><span class="p">,</span> <span class="n">crash_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;crashkernel reservation failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="n">unregister_memory_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kdump_mem_nb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">OLDMEM_BASE</span> <span class="o">&amp;&amp;</span> <span class="n">MACHINE_IS_VM</span><span class="p">)</span>
		<span class="n">diag10_range</span><span class="p">(</span><span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">crash_base</span><span class="p">),</span> <span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">crash_size</span><span class="p">));</span>
	<span class="n">crashk_res</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">crash_base</span><span class="p">;</span>
	<span class="n">crashk_res</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">crash_base</span> <span class="o">+</span> <span class="n">crash_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">insert_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iomem_resource</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crashk_res</span><span class="p">);</span>
	<span class="n">reserve_kdump_bootmem</span><span class="p">(</span><span class="n">crash_base</span><span class="p">,</span> <span class="n">crash_size</span><span class="p">,</span> <span class="n">CHUNK_CRASHK</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Reserving %lluMB of memory at %lluMB &quot;</span>
		<span class="s">&quot;for crashkernel (System RAM: %luMB)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">crash_size</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">,</span> <span class="n">crash_base</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">,</span> <span class="n">memory_end</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">);</span>
	<span class="n">os_info_crashkernel_add</span><span class="p">(</span><span class="n">crash_base</span><span class="p">,</span> <span class="n">crash_size</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">setup_memory</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bootmap_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_pfn</span><span class="p">,</span> <span class="n">end_pfn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * partially used pages are not usable - thus</span>
<span class="cm">	 * we are rounding upwards:</span>
<span class="cm">	 */</span>
	<span class="n">start_pfn</span> <span class="o">=</span> <span class="n">PFN_UP</span><span class="p">(</span><span class="n">__pa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_end</span><span class="p">));</span>
	<span class="n">end_pfn</span> <span class="o">=</span> <span class="n">max_pfn</span> <span class="o">=</span> <span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">memory_end</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_BLK_DEV_INITRD</span>
	<span class="cm">/*</span>
<span class="cm">	 * Move the initrd in case the bitmap of the bootmem allocater</span>
<span class="cm">	 * would overwrite it.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">INITRD_START</span> <span class="o">&amp;&amp;</span> <span class="n">INITRD_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bmap_size</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">;</span>

		<span class="n">bmap_size</span> <span class="o">=</span> <span class="n">bootmem_bootmap_pages</span><span class="p">(</span><span class="n">end_pfn</span> <span class="o">-</span> <span class="n">start_pfn</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">bmap_size</span> <span class="o">=</span> <span class="n">PFN_PHYS</span><span class="p">(</span><span class="n">bmap_size</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">PFN_PHYS</span><span class="p">(</span><span class="n">start_pfn</span><span class="p">)</span> <span class="o">+</span> <span class="n">bmap_size</span> <span class="o">&gt;</span> <span class="n">INITRD_START</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">start</span> <span class="o">=</span> <span class="n">PFN_PHYS</span><span class="p">(</span><span class="n">start_pfn</span><span class="p">)</span> <span class="o">+</span> <span class="n">bmap_size</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_CRASH_DUMP</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">OLDMEM_BASE</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Move initrd behind kdump oldmem */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">INITRD_SIZE</span> <span class="o">&gt;</span> <span class="n">OLDMEM_BASE</span> <span class="o">&amp;&amp;</span>
				    <span class="n">start</span> <span class="o">&lt;</span> <span class="n">OLDMEM_BASE</span> <span class="o">+</span> <span class="n">OLDMEM_SIZE</span><span class="p">)</span>
					<span class="n">start</span> <span class="o">=</span> <span class="n">OLDMEM_BASE</span> <span class="o">+</span> <span class="n">OLDMEM_SIZE</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">INITRD_SIZE</span> <span class="o">&gt;</span> <span class="n">memory_end</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;initrd extends beyond end of &quot;</span>
				       <span class="s">&quot;memory (0x%08lx &gt; 0x%08lx) &quot;</span>
				       <span class="s">&quot;disabling initrd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">start</span> <span class="o">+</span> <span class="n">INITRD_SIZE</span><span class="p">,</span> <span class="n">memory_end</span><span class="p">);</span>
				<span class="n">INITRD_START</span> <span class="o">=</span> <span class="n">INITRD_SIZE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Moving initrd (0x%08lx -&gt; &quot;</span>
					<span class="s">&quot;0x%08lx, size: %ld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">INITRD_START</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">INITRD_SIZE</span><span class="p">);</span>
				<span class="n">memmove</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">start</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">INITRD_START</span><span class="p">,</span>
					<span class="n">INITRD_SIZE</span><span class="p">);</span>
				<span class="n">INITRD_START</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize the boot-time allocator</span>
<span class="cm">	 */</span>
	<span class="n">bootmap_size</span> <span class="o">=</span> <span class="n">init_bootmem</span><span class="p">(</span><span class="n">start_pfn</span><span class="p">,</span> <span class="n">end_pfn</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Register RAM areas with the bootmem allocator.</span>
<span class="cm">	 */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MEMORY_CHUNKS</span> <span class="o">&amp;&amp;</span> <span class="n">memory_chunk</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_chunk</span><span class="p">,</span> <span class="n">end_chunk</span><span class="p">,</span> <span class="n">pfn</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">memory_chunk</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">!=</span> <span class="n">CHUNK_READ_WRITE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">memory_chunk</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">!=</span> <span class="n">CHUNK_CRASHK</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">start_chunk</span> <span class="o">=</span> <span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">memory_chunk</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">end_chunk</span> <span class="o">=</span> <span class="n">start_chunk</span> <span class="o">+</span> <span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">memory_chunk</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">);</span>
		<span class="n">end_chunk</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">end_chunk</span><span class="p">,</span> <span class="n">end_pfn</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">start_chunk</span> <span class="o">&gt;=</span> <span class="n">end_chunk</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">memblock_add_node</span><span class="p">(</span><span class="n">PFN_PHYS</span><span class="p">(</span><span class="n">start_chunk</span><span class="p">),</span>
				  <span class="n">PFN_PHYS</span><span class="p">(</span><span class="n">end_chunk</span> <span class="o">-</span> <span class="n">start_chunk</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pfn</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">start_chunk</span><span class="p">,</span> <span class="n">start_pfn</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">pfn</span> <span class="o">&lt;</span> <span class="n">end_chunk</span><span class="p">;</span> <span class="n">pfn</span><span class="o">++</span><span class="p">)</span>
			<span class="n">page_set_storage_key</span><span class="p">(</span><span class="n">PFN_PHYS</span><span class="p">(</span><span class="n">pfn</span><span class="p">),</span>
					     <span class="n">PAGE_DEFAULT_KEY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">psw_set_key</span><span class="p">(</span><span class="n">PAGE_DEFAULT_KEY</span><span class="p">);</span>

	<span class="n">free_bootmem_with_active_regions</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_pfn</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reserve memory used for lowcore/command line/kernel image.</span>
<span class="cm">	 */</span>
	<span class="n">reserve_bootmem</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">_ehead</span><span class="p">,</span> <span class="n">BOOTMEM_DEFAULT</span><span class="p">);</span>
	<span class="n">reserve_bootmem</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">_stext</span><span class="p">,</span>
			<span class="n">PFN_PHYS</span><span class="p">(</span><span class="n">start_pfn</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">_stext</span><span class="p">,</span>
			<span class="n">BOOTMEM_DEFAULT</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Reserve the bootmem bitmap itself as well. We do this in two</span>
<span class="cm">	 * steps (first step was init_bootmem()) because this catches</span>
<span class="cm">	 * the (very unlikely) case of us accidentally initializing the</span>
<span class="cm">	 * bootmem allocator with an invalid RAM area.</span>
<span class="cm">	 */</span>
	<span class="n">reserve_bootmem</span><span class="p">(</span><span class="n">start_pfn</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span> <span class="n">bootmap_size</span><span class="p">,</span>
			<span class="n">BOOTMEM_DEFAULT</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_CRASH_DUMP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crashk_res</span><span class="p">.</span><span class="n">start</span><span class="p">)</span>
		<span class="n">reserve_bootmem</span><span class="p">(</span><span class="n">crashk_res</span><span class="p">.</span><span class="n">start</span><span class="p">,</span>
				<span class="n">crashk_res</span><span class="p">.</span><span class="n">end</span> <span class="o">-</span> <span class="n">crashk_res</span><span class="p">.</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
				<span class="n">BOOTMEM_DEFAULT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_kdump_kernel</span><span class="p">())</span>
		<span class="n">reserve_bootmem</span><span class="p">(</span><span class="n">elfcorehdr_addr</span> <span class="o">-</span> <span class="n">OLDMEM_BASE</span><span class="p">,</span>
				<span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">elfcorehdr_size</span><span class="p">),</span> <span class="n">BOOTMEM_DEFAULT</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_BLK_DEV_INITRD</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">INITRD_START</span> <span class="o">&amp;&amp;</span> <span class="n">INITRD_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">INITRD_START</span> <span class="o">+</span> <span class="n">INITRD_SIZE</span> <span class="o">&lt;=</span> <span class="n">memory_end</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reserve_bootmem</span><span class="p">(</span><span class="n">INITRD_START</span><span class="p">,</span> <span class="n">INITRD_SIZE</span><span class="p">,</span>
					<span class="n">BOOTMEM_DEFAULT</span><span class="p">);</span>
			<span class="n">initrd_start</span> <span class="o">=</span> <span class="n">INITRD_START</span><span class="p">;</span>
			<span class="n">initrd_end</span> <span class="o">=</span> <span class="n">initrd_start</span> <span class="o">+</span> <span class="n">INITRD_SIZE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;initrd extends beyond end of &quot;</span>
			       <span class="s">&quot;memory (0x%08lx &gt; 0x%08lx) &quot;</span>
			       <span class="s">&quot;disabling initrd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">initrd_start</span> <span class="o">+</span> <span class="n">INITRD_SIZE</span><span class="p">,</span> <span class="n">memory_end</span><span class="p">);</span>
			<span class="n">initrd_start</span> <span class="o">=</span> <span class="n">initrd_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Setup hardware capabilities.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">setup_hwcaps</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">stfl_bits</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">21</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">cpuid</span> <span class="n">cpu_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The store facility list bits numbers as found in the principles</span>
<span class="cm">	 * of operation are numbered with bit 1UL&lt;&lt;31 as number 0 to</span>
<span class="cm">	 * bit 1UL&lt;&lt;0 as number 31.</span>
<span class="cm">	 *   Bit 0: instructions named N3, &quot;backported&quot; to esa-mode</span>
<span class="cm">	 *   Bit 2: z/Architecture mode is active</span>
<span class="cm">	 *   Bit 7: the store-facility-list-extended facility is installed</span>
<span class="cm">	 *   Bit 17: the message-security assist is installed</span>
<span class="cm">	 *   Bit 19: the long-displacement facility is installed</span>
<span class="cm">	 *   Bit 21: the extended-immediate facility is installed</span>
<span class="cm">	 *   Bit 22: extended-translation facility 3 is installed</span>
<span class="cm">	 *   Bit 30: extended-translation facility 3 enhancement facility</span>
<span class="cm">	 * These get translated to:</span>
<span class="cm">	 *   HWCAP_S390_ESAN3 bit 0, HWCAP_S390_ZARCH bit 1,</span>
<span class="cm">	 *   HWCAP_S390_STFLE bit 2, HWCAP_S390_MSA bit 3,</span>
<span class="cm">	 *   HWCAP_S390_LDISP bit 4, HWCAP_S390_EIMM bit 5 and</span>
<span class="cm">	 *   HWCAP_S390_ETF3EH bit 8 (22 &amp;&amp; 30).</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_facility</span><span class="p">(</span><span class="n">stfl_bits</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="n">elf_hwcap</span> <span class="o">|=</span> <span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_facility</span><span class="p">(</span><span class="mi">22</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">test_facility</span><span class="p">(</span><span class="mi">30</span><span class="p">))</span>
		<span class="n">elf_hwcap</span> <span class="o">|=</span> <span class="n">HWCAP_S390_ETF3EH</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check for additional facilities with store-facility-list-extended.</span>
<span class="cm">	 * stfle stores doublewords (8 byte) with bit 1ULL&lt;&lt;63 as bit 0</span>
<span class="cm">	 * and 1ULL&lt;&lt;0 as bit 63. Bits 0-31 contain the same information</span>
<span class="cm">	 * as stored by stfl, bits 32-xxx contain additional facilities.</span>
<span class="cm">	 * How many facility words are stored depends on the number of</span>
<span class="cm">	 * doublewords passed to the instruction. The additional facilities</span>
<span class="cm">	 * are:</span>
<span class="cm">	 *   Bit 42: decimal floating point facility is installed</span>
<span class="cm">	 *   Bit 44: perform floating point operation facility is installed</span>
<span class="cm">	 * translated to:</span>
<span class="cm">	 *   HWCAP_S390_DFP bit 6 (42 &amp;&amp; 44).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">elf_hwcap</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">test_facility</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">test_facility</span><span class="p">(</span><span class="mi">44</span><span class="p">))</span>
		<span class="n">elf_hwcap</span> <span class="o">|=</span> <span class="n">HWCAP_S390_DFP</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Huge page support HWCAP_S390_HPAGE is bit 7.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MACHINE_HAS_HPAGE</span><span class="p">)</span>
		<span class="n">elf_hwcap</span> <span class="o">|=</span> <span class="n">HWCAP_S390_HPAGE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * 64-bit register support for 31-bit processes</span>
<span class="cm">	 * HWCAP_S390_HIGH_GPRS is bit 9.</span>
<span class="cm">	 */</span>
	<span class="n">elf_hwcap</span> <span class="o">|=</span> <span class="n">HWCAP_S390_HIGH_GPRS</span><span class="p">;</span>

	<span class="n">get_cpu_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu_id</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cpu_id</span><span class="p">.</span><span class="n">machine</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x9672</span>:
<span class="cp">#if !defined(CONFIG_64BIT)</span>
	<span class="nl">default:</span>	<span class="cm">/* Use &quot;g5&quot; as default for 31 bit kernels. */</span>
<span class="cp">#endif</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">elf_platform</span><span class="p">,</span> <span class="s">&quot;g5&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x2064</span>:
	<span class="k">case</span> <span class="mh">0x2066</span>:
<span class="cp">#if defined(CONFIG_64BIT)</span>
	<span class="nl">default:</span>	<span class="cm">/* Use &quot;z900&quot; as default for 64 bit kernels. */</span>
<span class="cp">#endif</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">elf_platform</span><span class="p">,</span> <span class="s">&quot;z900&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x2084</span>:
	<span class="k">case</span> <span class="mh">0x2086</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">elf_platform</span><span class="p">,</span> <span class="s">&quot;z990&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x2094</span>:
	<span class="k">case</span> <span class="mh">0x2096</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">elf_platform</span><span class="p">,</span> <span class="s">&quot;z9-109&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x2097</span>:
	<span class="k">case</span> <span class="mh">0x2098</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">elf_platform</span><span class="p">,</span> <span class="s">&quot;z10&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x2817</span>:
	<span class="k">case</span> <span class="mh">0x2818</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">elf_platform</span><span class="p">,</span> <span class="s">&quot;z196&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Setup function called from init/main.c just after the banner</span>
<span class="cm"> * was printed.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">setup_arch</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">cmdline_p</span><span class="p">)</span>
<span class="p">{</span>
        <span class="cm">/*</span>
<span class="cm">         * print what head.S has found out about the machine</span>
<span class="cm">         */</span>
<span class="cp">#ifndef CONFIG_64BIT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MACHINE_IS_VM</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Linux is running as a z/VM &quot;</span>
			<span class="s">&quot;guest operating system in 31-bit mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">MACHINE_IS_LPAR</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Linux is running natively in 31-bit mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MACHINE_HAS_IEEE</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;The hardware system has IEEE compatible &quot;</span>
			<span class="s">&quot;floating point units</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;The hardware system has no IEEE compatible &quot;</span>
			<span class="s">&quot;floating point units</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#else </span><span class="cm">/* CONFIG_64BIT */</span><span class="cp"></span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MACHINE_IS_VM</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Linux is running as a z/VM &quot;</span>
			<span class="s">&quot;guest operating system in 64-bit mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">MACHINE_IS_KVM</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Linux is running under KVM in 64-bit mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">MACHINE_IS_LPAR</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Linux is running natively in 64-bit mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_64BIT */</span><span class="cp"></span>

	<span class="cm">/* Have one command line that is parsed and saved in /proc/cmdline */</span>
	<span class="cm">/* boot_command_line has been already set up in early.c */</span>
	<span class="o">*</span><span class="n">cmdline_p</span> <span class="o">=</span> <span class="n">boot_command_line</span><span class="p">;</span>

        <span class="n">ROOT_DEV</span> <span class="o">=</span> <span class="n">Root_RAM0</span><span class="p">;</span>

	<span class="n">init_mm</span><span class="p">.</span><span class="n">start_code</span> <span class="o">=</span> <span class="n">PAGE_OFFSET</span><span class="p">;</span>
	<span class="n">init_mm</span><span class="p">.</span><span class="n">end_code</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">_etext</span><span class="p">;</span>
	<span class="n">init_mm</span><span class="p">.</span><span class="n">end_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">_edata</span><span class="p">;</span>
	<span class="n">init_mm</span><span class="p">.</span><span class="n">brk</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">_end</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">MACHINE_HAS_MVCOS</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uaccess</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uaccess_mvcos</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uaccess</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uaccess</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uaccess_std</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uaccess</span><span class="p">));</span>

	<span class="n">parse_early_param</span><span class="p">();</span>

	<span class="n">os_info_init</span><span class="p">();</span>
	<span class="n">setup_ipl</span><span class="p">();</span>
	<span class="n">setup_memory_end</span><span class="p">();</span>
	<span class="n">setup_addressing_mode</span><span class="p">();</span>
	<span class="n">reserve_oldmem</span><span class="p">();</span>
	<span class="n">reserve_crashkernel</span><span class="p">();</span>
	<span class="n">setup_memory</span><span class="p">();</span>
	<span class="n">setup_resources</span><span class="p">();</span>
	<span class="n">setup_vmcoreinfo</span><span class="p">();</span>
	<span class="n">setup_lowcore</span><span class="p">();</span>

        <span class="n">cpu_init</span><span class="p">();</span>
	<span class="n">s390_init_cpu_topology</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup capabilities (ELF_HWCAP &amp; ELF_PLATFORM).</span>
<span class="cm">	 */</span>
	<span class="n">setup_hwcaps</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Create kernel page tables and switch to virtual addressing.</span>
<span class="cm">	 */</span>
        <span class="n">paging_init</span><span class="p">();</span>

        <span class="cm">/* Setup default console */</span>
	<span class="n">conmode_default</span><span class="p">();</span>
	<span class="n">set_preferred_console</span><span class="p">();</span>

	<span class="cm">/* Setup zfcpdump support */</span>
	<span class="n">setup_zfcpdump</span><span class="p">(</span><span class="n">console_devno</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
