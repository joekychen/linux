<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › s390 › kernel › debug.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>debug.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  arch/s390/kernel/debug.c</span>
<span class="cm"> *   S/390 debug facility</span>
<span class="cm"> *</span>
<span class="cm"> *    Copyright IBM Corp. 1999, 2012</span>
<span class="cm"> *</span>
<span class="cm"> *    Author(s): Michael Holzheu (holzheu@de.ibm.com),</span>
<span class="cm"> *               Holger Smolinski (Holger.Smolinski@de.ibm.com)</span>
<span class="cm"> *</span>
<span class="cm"> *    Bugreports to: &lt;Linux390@de.ibm.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#define KMSG_COMPONENT &quot;s390dbf&quot;</span>
<span class="cp">#define pr_fmt(fmt) KMSG_COMPONENT &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/stddef.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/sysctl.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>

<span class="cp">#include &lt;asm/debug.h&gt;</span>

<span class="cp">#define DEBUG_PROLOG_ENTRY -1</span>

<span class="cp">#define ALL_AREAS 0 </span><span class="cm">/* copy all debug areas */</span><span class="cp"></span>
<span class="cp">#define NO_AREAS  1 </span><span class="cm">/* copy no debug areas */</span><span class="cp"></span>

<span class="cm">/* typedefs */</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">file_private_info</span> <span class="p">{</span>
	<span class="n">loff_t</span> <span class="n">offset</span><span class="p">;</span>			<span class="cm">/* offset of last read in file */</span>
	<span class="kt">int</span>    <span class="n">act_area</span><span class="p">;</span>                <span class="cm">/* number of last formated area */</span>
	<span class="kt">int</span>    <span class="n">act_page</span><span class="p">;</span>                <span class="cm">/* act page in given area */</span>
	<span class="kt">int</span>    <span class="n">act_entry</span><span class="p">;</span>               <span class="cm">/* last formated entry (offset */</span>
                                        <span class="cm">/* relative to beginning of last */</span>
                                        <span class="cm">/* formated page) */</span>
	<span class="kt">size_t</span> <span class="n">act_entry_offset</span><span class="p">;</span>        <span class="cm">/* up to this offset we copied */</span>
					<span class="cm">/* in last read the last formated */</span>
					<span class="cm">/* entry to userland */</span>
	<span class="kt">char</span>   <span class="n">temp_buf</span><span class="p">[</span><span class="mi">2048</span><span class="p">];</span>		<span class="cm">/* buffer for output */</span>
	<span class="n">debug_info_t</span> <span class="o">*</span><span class="n">debug_info_org</span><span class="p">;</span>   <span class="cm">/* original debug information */</span>
	<span class="n">debug_info_t</span> <span class="o">*</span><span class="n">debug_info_snap</span><span class="p">;</span>	<span class="cm">/* snapshot of debug information */</span>
	<span class="k">struct</span> <span class="n">debug_view</span> <span class="o">*</span><span class="n">view</span><span class="p">;</span>	<span class="cm">/* used view of debug info */</span>
<span class="p">}</span> <span class="n">file_private_info_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">;</span>
	<span class="cm">/* </span>
<span class="cm">	 * This assumes that all args are converted into longs </span>
<span class="cm">	 * on L/390 this is the case for all types of parameter </span>
<span class="cm">	 * except of floats, and long long (32 bit) </span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>
	<span class="kt">long</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span> <span class="n">debug_sprintf_entry_t</span><span class="p">;</span>


<span class="cm">/* internal function prototyes */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">debug_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
			<span class="kt">size_t</span> <span class="n">user_len</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span> <span class="n">offset</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">debug_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
			<span class="kt">size_t</span> <span class="n">user_len</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span> <span class="n">offset</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">);</span>
<span class="k">static</span> <span class="n">debug_info_t</span> <span class="o">*</span><span class="n">debug_info_create</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pages_per_area</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">nr_areas</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buf_size</span><span class="p">,</span> <span class="n">umode_t</span> <span class="n">mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">debug_info_get</span><span class="p">(</span><span class="n">debug_info_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">debug_info_put</span><span class="p">(</span><span class="n">debug_info_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug_prolog_level_fn</span><span class="p">(</span><span class="n">debug_info_t</span> <span class="o">*</span> <span class="n">id</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">debug_view</span> <span class="o">*</span><span class="n">view</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">out_buf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug_input_level_fn</span><span class="p">(</span><span class="n">debug_info_t</span> <span class="o">*</span> <span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">debug_view</span> <span class="o">*</span><span class="n">view</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
			<span class="kt">size_t</span> <span class="n">user_buf_size</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span> <span class="n">offset</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug_prolog_pages_fn</span><span class="p">(</span><span class="n">debug_info_t</span> <span class="o">*</span> <span class="n">id</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">debug_view</span> <span class="o">*</span><span class="n">view</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">out_buf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug_input_pages_fn</span><span class="p">(</span><span class="n">debug_info_t</span> <span class="o">*</span> <span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">debug_view</span> <span class="o">*</span><span class="n">view</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
			<span class="kt">size_t</span> <span class="n">user_buf_size</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span> <span class="n">offset</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug_input_flush_fn</span><span class="p">(</span><span class="n">debug_info_t</span> <span class="o">*</span> <span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">debug_view</span> <span class="o">*</span><span class="n">view</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
			<span class="kt">size_t</span> <span class="n">user_buf_size</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span> <span class="n">offset</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug_hex_ascii_format_fn</span><span class="p">(</span><span class="n">debug_info_t</span> <span class="o">*</span> <span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">debug_view</span> <span class="o">*</span><span class="n">view</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">out_buf</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">in_buf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug_raw_format_fn</span><span class="p">(</span><span class="n">debug_info_t</span> <span class="o">*</span> <span class="n">id</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">debug_view</span> <span class="o">*</span><span class="n">view</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">out_buf</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">in_buf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug_raw_header_fn</span><span class="p">(</span><span class="n">debug_info_t</span> <span class="o">*</span> <span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">debug_view</span> <span class="o">*</span><span class="n">view</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">area</span><span class="p">,</span> <span class="n">debug_entry_t</span> <span class="o">*</span> <span class="n">entry</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">out_buf</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug_sprintf_format_fn</span><span class="p">(</span><span class="n">debug_info_t</span> <span class="o">*</span> <span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">debug_view</span> <span class="o">*</span><span class="n">view</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">out_buf</span><span class="p">,</span> <span class="n">debug_sprintf_entry_t</span> <span class="o">*</span><span class="n">curr_event</span><span class="p">);</span>

<span class="cm">/* globals */</span>

<span class="k">struct</span> <span class="n">debug_view</span> <span class="n">debug_raw_view</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;raw&quot;</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">debug_raw_header_fn</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">debug_raw_format_fn</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">debug_view</span> <span class="n">debug_hex_ascii_view</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;hex_ascii&quot;</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">debug_dflt_header_fn</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">debug_hex_ascii_format_fn</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">debug_view</span> <span class="n">debug_level_view</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;level&quot;</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">debug_prolog_level_fn</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">debug_input_level_fn</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">debug_view</span> <span class="n">debug_pages_view</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;pages&quot;</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">debug_prolog_pages_fn</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">debug_input_pages_fn</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">debug_view</span> <span class="n">debug_flush_view</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&quot;flush&quot;</span><span class="p">,</span>
        <span class="nb">NULL</span><span class="p">,</span>
        <span class="nb">NULL</span><span class="p">,</span>
        <span class="nb">NULL</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="n">debug_input_flush_fn</span><span class="p">,</span>
        <span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">debug_view</span> <span class="n">debug_sprintf_view</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;sprintf&quot;</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">debug_dflt_header_fn</span><span class="p">,</span>
	<span class="p">(</span><span class="n">debug_format_proc_t</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">debug_sprintf_format_fn</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="cm">/* used by dump analysis tools to determine version of debug feature */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__used</span> <span class="n">debug_feature_version</span> <span class="o">=</span> <span class="n">__DEBUG_FEATURE_VERSION</span><span class="p">;</span>

<span class="cm">/* static globals */</span>

<span class="k">static</span> <span class="n">debug_info_t</span> <span class="o">*</span><span class="n">debug_area_first</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="n">debug_info_t</span> <span class="o">*</span><span class="n">debug_area_last</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">debug_mutex</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">initialized</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug_critical</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">debug_file_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>   <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>    <span class="o">=</span> <span class="n">debug_output</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>   <span class="o">=</span> <span class="n">debug_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>    <span class="o">=</span> <span class="n">debug_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">debug_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>  <span class="o">=</span> <span class="n">no_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">debug_debugfs_root_entry</span><span class="p">;</span>

<span class="cm">/* functions */</span>

<span class="cm">/*</span>
<span class="cm"> * debug_areas_alloc</span>
<span class="cm"> * - Debug areas are implemented as a threedimensonal array:</span>
<span class="cm"> *   areas[areanumber][pagenumber][pageoffset]</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">debug_entry_t</span><span class="o">***</span>
<span class="nf">debug_areas_alloc</span><span class="p">(</span><span class="kt">int</span> <span class="n">pages_per_area</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_areas</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debug_entry_t</span><span class="o">***</span> <span class="n">areas</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">;</span>

	<span class="n">areas</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">nr_areas</span> <span class="o">*</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">debug_entry_t</span><span class="o">**</span><span class="p">),</span>
					<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">areas</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_malloc_areas</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_areas</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">pages_per_area</span> <span class="o">*</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">debug_entry_t</span><span class="o">*</span><span class="p">),</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">goto</span> <span class="n">fail_malloc_areas2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span><span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">pages_per_area</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="p">{</span>
				<span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">--</span><span class="p">;</span> <span class="n">j</span> <span class="o">&gt;=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]);</span>
				<span class="p">}</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="k">goto</span> <span class="n">fail_malloc_areas2</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">areas</span><span class="p">;</span>

<span class="nl">fail_malloc_areas2:</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">){</span>
		<span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">pages_per_area</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">){</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">areas</span><span class="p">);</span>
<span class="nl">fail_malloc_areas:</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * debug_info_alloc</span>
<span class="cm"> * - alloc new debug-info</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">debug_info_t</span><span class="o">*</span>
<span class="nf">debug_info_alloc</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pages_per_area</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_areas</span><span class="p">,</span>
		 <span class="kt">int</span> <span class="n">buf_size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debug_info_t</span><span class="o">*</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* alloc everything */</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">debug_info_t</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_malloc_rc</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">active_entries</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">nr_areas</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">active_entries</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_malloc_active_entries</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">active_pages</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">nr_areas</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">active_pages</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_malloc_active_pages</span><span class="p">;</span>
	<span class="k">if</span><span class="p">((</span><span class="n">mode</span> <span class="o">==</span> <span class="n">ALL_AREAS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pages_per_area</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)){</span>
		<span class="n">rc</span><span class="o">-&gt;</span><span class="n">areas</span> <span class="o">=</span> <span class="n">debug_areas_alloc</span><span class="p">(</span><span class="n">pages_per_area</span><span class="p">,</span> <span class="n">nr_areas</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">areas</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail_malloc_areas</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span><span class="o">-&gt;</span><span class="n">areas</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* initialize members */</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">pages_per_area</span> <span class="o">=</span> <span class="n">pages_per_area</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">nr_areas</span>       <span class="o">=</span> <span class="n">nr_areas</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">active_area</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">level</span>          <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">buf_size</span>       <span class="o">=</span> <span class="n">buf_size</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">entry_size</span>     <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">debug_entry_t</span><span class="p">)</span> <span class="o">+</span> <span class="n">buf_size</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">views</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DEBUG_MAX_VIEWS</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">debug_view</span> <span class="o">*</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">debugfs_entries</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span><span class="n">DEBUG_MAX_VIEWS</span> <span class="o">*</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span><span class="o">*</span><span class="p">));</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="nl">fail_malloc_areas:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">active_pages</span><span class="p">);</span>
<span class="nl">fail_malloc_active_pages:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">active_entries</span><span class="p">);</span>
<span class="nl">fail_malloc_active_entries:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
<span class="nl">fail_malloc_rc:</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * debug_areas_free</span>
<span class="cm"> * - free all debug areas</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">debug_areas_free</span><span class="p">(</span><span class="n">debug_info_t</span><span class="o">*</span> <span class="n">db_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">db_info</span><span class="o">-&gt;</span><span class="n">areas</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">db_info</span><span class="o">-&gt;</span><span class="n">nr_areas</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span><span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">db_info</span><span class="o">-&gt;</span><span class="n">pages_per_area</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">db_info</span><span class="o">-&gt;</span><span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">db_info</span><span class="o">-&gt;</span><span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">db_info</span><span class="o">-&gt;</span><span class="n">areas</span><span class="p">);</span>
	<span class="n">db_info</span><span class="o">-&gt;</span><span class="n">areas</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * debug_info_free</span>
<span class="cm"> * - free memory debug-info</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="n">debug_info_free</span><span class="p">(</span><span class="n">debug_info_t</span><span class="o">*</span> <span class="n">db_info</span><span class="p">){</span>
	<span class="n">debug_areas_free</span><span class="p">(</span><span class="n">db_info</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">db_info</span><span class="o">-&gt;</span><span class="n">active_entries</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">db_info</span><span class="o">-&gt;</span><span class="n">active_pages</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">db_info</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * debug_info_create</span>
<span class="cm"> * - create new debug-info</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">debug_info_t</span><span class="o">*</span>
<span class="n">debug_info_create</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pages_per_area</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_areas</span><span class="p">,</span>
		  <span class="kt">int</span> <span class="n">buf_size</span><span class="p">,</span> <span class="n">umode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debug_info_t</span><span class="o">*</span> <span class="n">rc</span><span class="p">;</span>

        <span class="n">rc</span> <span class="o">=</span> <span class="n">debug_info_alloc</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">pages_per_area</span><span class="p">,</span> <span class="n">nr_areas</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">,</span>
				<span class="n">DEBUG_DEFAULT_LEVEL</span><span class="p">,</span> <span class="n">ALL_AREAS</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> 
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">S_IFMT</span><span class="p">;</span>

	<span class="cm">/* create root directory */</span>
        <span class="n">rc</span><span class="o">-&gt;</span><span class="n">debugfs_root_entry</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					<span class="n">debug_debugfs_root_entry</span><span class="p">);</span>

	<span class="cm">/* append new element to linked list */</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug_area_first</span><span class="p">)</span> <span class="p">{</span>
                <span class="cm">/* first element in list */</span>
                <span class="n">debug_area_first</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
                <span class="n">rc</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="cm">/* append element to end of list */</span>
                <span class="n">debug_area_last</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
                <span class="n">rc</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">debug_area_last</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">debug_area_last</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
        <span class="n">rc</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">debug_info_get</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * debug_info_copy</span>
<span class="cm"> * - copy debug-info</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">debug_info_t</span><span class="o">*</span>
<span class="n">debug_info_copy</span><span class="p">(</span><span class="n">debug_info_t</span><span class="o">*</span> <span class="n">in</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">;</span>
        <span class="n">debug_info_t</span><span class="o">*</span> <span class="n">rc</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* get a consistent copy of the debug areas */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">debug_info_alloc</span><span class="p">(</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">pages_per_area</span><span class="p">,</span>
			<span class="n">in</span><span class="o">-&gt;</span><span class="n">nr_areas</span><span class="p">,</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">,</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="cm">/* has something changed in the meantime ? */</span>
		<span class="k">if</span><span class="p">((</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">pages_per_area</span> <span class="o">==</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">pages_per_area</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">nr_areas</span> <span class="o">==</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">nr_areas</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">debug_info_free</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">NO_AREAS</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

        <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">nr_areas</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
		<span class="k">for</span><span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">pages_per_area</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span><span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="p">}</span>
        <span class="p">}</span>
<span class="nl">out:</span>
        <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * debug_info_get</span>
<span class="cm"> * - increments reference count for debug-info</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="n">debug_info_get</span><span class="p">(</span><span class="n">debug_info_t</span> <span class="o">*</span> <span class="n">db_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">db_info</span><span class="p">)</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db_info</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * debug_info_put:</span>
<span class="cm"> * - decreases reference count for debug-info and frees it if necessary</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="n">debug_info_put</span><span class="p">(</span><span class="n">debug_info_t</span> <span class="o">*</span><span class="n">db_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">db_info</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db_info</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DEBUG_MAX_VIEWS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">db_info</span><span class="o">-&gt;</span><span class="n">views</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">db_info</span><span class="o">-&gt;</span><span class="n">debugfs_entries</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">db_info</span><span class="o">-&gt;</span><span class="n">debugfs_root_entry</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">db_info</span> <span class="o">==</span> <span class="n">debug_area_first</span><span class="p">)</span>
			<span class="n">debug_area_first</span> <span class="o">=</span> <span class="n">db_info</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">db_info</span> <span class="o">==</span> <span class="n">debug_area_last</span><span class="p">)</span>
			<span class="n">debug_area_last</span> <span class="o">=</span> <span class="n">db_info</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">db_info</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">)</span> <span class="n">db_info</span><span class="o">-&gt;</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">db_info</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">db_info</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="n">db_info</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">db_info</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span>
		<span class="n">debug_info_free</span><span class="p">(</span><span class="n">db_info</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * debug_format_entry:</span>
<span class="cm"> * - format one debug entry and return size of formated data</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="n">debug_format_entry</span><span class="p">(</span><span class="n">file_private_info_t</span> <span class="o">*</span><span class="n">p_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debug_info_t</span> <span class="o">*</span><span class="n">id_snap</span>   <span class="o">=</span> <span class="n">p_info</span><span class="o">-&gt;</span><span class="n">debug_info_snap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">debug_view</span> <span class="o">*</span><span class="n">view</span> <span class="o">=</span> <span class="n">p_info</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">;</span>
	<span class="n">debug_entry_t</span> <span class="o">*</span><span class="n">act_entry</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">p_info</span><span class="o">-&gt;</span><span class="n">act_entry</span> <span class="o">==</span> <span class="n">DEBUG_PROLOG_ENTRY</span><span class="p">){</span>
		<span class="cm">/* print prolog */</span>
        	<span class="k">if</span> <span class="p">(</span><span class="n">view</span><span class="o">-&gt;</span><span class="n">prolog_proc</span><span class="p">)</span>
                	<span class="n">len</span> <span class="o">+=</span> <span class="n">view</span><span class="o">-&gt;</span><span class="n">prolog_proc</span><span class="p">(</span><span class="n">id_snap</span><span class="p">,</span><span class="n">view</span><span class="p">,</span><span class="n">p_info</span><span class="o">-&gt;</span><span class="n">temp_buf</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">id_snap</span><span class="o">-&gt;</span><span class="n">areas</span><span class="p">)</span> <span class="cm">/* this is true, if we have a prolog only view */</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>    <span class="cm">/* or if &#39;pages_per_area&#39; is 0 */</span>
	<span class="n">act_entry</span> <span class="o">=</span> <span class="p">(</span><span class="n">debug_entry_t</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">id_snap</span><span class="o">-&gt;</span><span class="n">areas</span><span class="p">[</span><span class="n">p_info</span><span class="o">-&gt;</span><span class="n">act_area</span><span class="p">]</span>
				<span class="p">[</span><span class="n">p_info</span><span class="o">-&gt;</span><span class="n">act_page</span><span class="p">]</span> <span class="o">+</span> <span class="n">p_info</span><span class="o">-&gt;</span><span class="n">act_entry</span><span class="p">);</span>
                        
	<span class="k">if</span> <span class="p">(</span><span class="n">act_entry</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">stck</span> <span class="o">==</span> <span class="mi">0LL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>  <span class="cm">/* empty entry */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">view</span><span class="o">-&gt;</span><span class="n">header_proc</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">view</span><span class="o">-&gt;</span><span class="n">header_proc</span><span class="p">(</span><span class="n">id_snap</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">p_info</span><span class="o">-&gt;</span><span class="n">act_area</span><span class="p">,</span>
					<span class="n">act_entry</span><span class="p">,</span> <span class="n">p_info</span><span class="o">-&gt;</span><span class="n">temp_buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">view</span><span class="o">-&gt;</span><span class="n">format_proc</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">view</span><span class="o">-&gt;</span><span class="n">format_proc</span><span class="p">(</span><span class="n">id_snap</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">p_info</span><span class="o">-&gt;</span><span class="n">temp_buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span>
						<span class="n">DEBUG_DATA</span><span class="p">(</span><span class="n">act_entry</span><span class="p">));</span>
<span class="nl">out:</span>
        <span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * debug_next_entry:</span>
<span class="cm"> * - goto next entry in p_info</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="n">debug_next_entry</span><span class="p">(</span><span class="n">file_private_info_t</span> <span class="o">*</span><span class="n">p_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debug_info_t</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">p_info</span><span class="o">-&gt;</span><span class="n">debug_info_snap</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">p_info</span><span class="o">-&gt;</span><span class="n">act_entry</span> <span class="o">==</span> <span class="n">DEBUG_PROLOG_ENTRY</span><span class="p">){</span>
		<span class="n">p_info</span><span class="o">-&gt;</span><span class="n">act_entry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">p_info</span><span class="o">-&gt;</span><span class="n">act_page</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">areas</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">p_info</span><span class="o">-&gt;</span><span class="n">act_entry</span> <span class="o">+=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">;</span>
	<span class="cm">/* switch to next page, if we reached the end of the page  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p_info</span><span class="o">-&gt;</span><span class="n">act_entry</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">)){</span>
		<span class="cm">/* next page */</span>
		<span class="n">p_info</span><span class="o">-&gt;</span><span class="n">act_entry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">p_info</span><span class="o">-&gt;</span><span class="n">act_page</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span><span class="p">((</span><span class="n">p_info</span><span class="o">-&gt;</span><span class="n">act_page</span> <span class="o">%</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">pages_per_area</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* next area */</span>
        		<span class="n">p_info</span><span class="o">-&gt;</span><span class="n">act_area</span><span class="o">++</span><span class="p">;</span>
			<span class="n">p_info</span><span class="o">-&gt;</span><span class="n">act_page</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
        	<span class="k">if</span><span class="p">(</span><span class="n">p_info</span><span class="o">-&gt;</span><span class="n">act_area</span> <span class="o">&gt;=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">nr_areas</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * debug_output:</span>
<span class="cm"> * - called for user read()</span>
<span class="cm"> * - copies formated debug entries to the user buffer</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="n">debug_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>		<span class="cm">/* file descriptor */</span>
	    <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>	<span class="cm">/* user buffer */</span>
	    <span class="kt">size_t</span>  <span class="n">len</span><span class="p">,</span>		<span class="cm">/* length of buffer */</span>
	    <span class="n">loff_t</span> <span class="o">*</span><span class="n">offset</span><span class="p">)</span>		<span class="cm">/* offset in the file */</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">entry_offset</span><span class="p">;</span>
	<span class="n">file_private_info_t</span> <span class="o">*</span><span class="n">p_info</span><span class="p">;</span>

	<span class="n">p_info</span> <span class="o">=</span> <span class="p">((</span><span class="n">file_private_info_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">offset</span> <span class="o">!=</span> <span class="n">p_info</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span> 
		<span class="k">return</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">p_info</span><span class="o">-&gt;</span><span class="n">act_area</span> <span class="o">&gt;=</span> <span class="n">p_info</span><span class="o">-&gt;</span><span class="n">debug_info_snap</span><span class="o">-&gt;</span><span class="n">nr_areas</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">entry_offset</span> <span class="o">=</span> <span class="n">p_info</span><span class="o">-&gt;</span><span class="n">act_entry_offset</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">){</span>
		<span class="kt">int</span> <span class="n">formatted_line_size</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">formatted_line_residue</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">user_buf_residue</span><span class="p">;</span>
		<span class="kt">size_t</span> <span class="n">copy_size</span><span class="p">;</span>

		<span class="n">formatted_line_size</span> <span class="o">=</span> <span class="n">debug_format_entry</span><span class="p">(</span><span class="n">p_info</span><span class="p">);</span>
		<span class="n">formatted_line_residue</span> <span class="o">=</span> <span class="n">formatted_line_size</span> <span class="o">-</span> <span class="n">entry_offset</span><span class="p">;</span>
		<span class="n">user_buf_residue</span> <span class="o">=</span> <span class="n">len</span><span class="o">-</span><span class="n">count</span><span class="p">;</span>
		<span class="n">copy_size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">user_buf_residue</span><span class="p">,</span> <span class="n">formatted_line_residue</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">copy_size</span><span class="p">){</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">user_buf</span> <span class="o">+</span> <span class="n">count</span><span class="p">,</span> <span class="n">p_info</span><span class="o">-&gt;</span><span class="n">temp_buf</span>
					<span class="o">+</span> <span class="n">entry_offset</span><span class="p">,</span> <span class="n">copy_size</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">count</span> <span class="o">+=</span> <span class="n">copy_size</span><span class="p">;</span>
			<span class="n">entry_offset</span> <span class="o">+=</span> <span class="n">copy_size</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">copy_size</span> <span class="o">==</span> <span class="n">formatted_line_residue</span><span class="p">){</span>
			<span class="n">entry_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="n">debug_next_entry</span><span class="p">(</span><span class="n">p_info</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">p_info</span><span class="o">-&gt;</span><span class="n">offset</span>           <span class="o">=</span> <span class="o">*</span><span class="n">offset</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">p_info</span><span class="o">-&gt;</span><span class="n">act_entry_offset</span> <span class="o">=</span> <span class="n">entry_offset</span><span class="p">;</span>
	<span class="o">*</span><span class="n">offset</span> <span class="o">=</span> <span class="n">p_info</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * debug_input:</span>
<span class="cm"> * - called for user write()</span>
<span class="cm"> * - calls input function of view</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="n">debug_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">,</span>
		<span class="n">loff_t</span> <span class="o">*</span><span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">file_private_info_t</span> <span class="o">*</span><span class="n">p_info</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">debug_mutex</span><span class="p">);</span>
	<span class="n">p_info</span> <span class="o">=</span> <span class="p">((</span><span class="n">file_private_info_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p_info</span><span class="o">-&gt;</span><span class="n">view</span><span class="o">-&gt;</span><span class="n">input_proc</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">p_info</span><span class="o">-&gt;</span><span class="n">view</span><span class="o">-&gt;</span><span class="n">input_proc</span><span class="p">(</span><span class="n">p_info</span><span class="o">-&gt;</span><span class="n">debug_info_org</span><span class="p">,</span>
					      <span class="n">p_info</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">user_buf</span><span class="p">,</span>
					      <span class="n">length</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">debug_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>		<span class="cm">/* number of input characters */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * debug_open:</span>
<span class="cm"> * - called for user open()</span>
<span class="cm"> * - copies formated output to private_data area of the file</span>
<span class="cm"> *   handle</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="n">debug_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">file_private_info_t</span> <span class="o">*</span><span class="n">p_info</span><span class="p">;</span>
	<span class="n">debug_info_t</span> <span class="o">*</span><span class="n">debug_info</span><span class="p">,</span> <span class="o">*</span><span class="n">debug_info_snapshot</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">debug_mutex</span><span class="p">);</span>
	<span class="n">debug_info</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>
	<span class="cm">/* find debug view */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DEBUG_MAX_VIEWS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug_info</span><span class="o">-&gt;</span><span class="n">views</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">debug_info</span><span class="o">-&gt;</span><span class="n">debugfs_entries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span>
			 <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>	<span class="cm">/* found view ! */</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* no entry found */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">found:</span>

	<span class="cm">/* Make snapshot of current debug areas to get it consistent.     */</span>
	<span class="cm">/* To copy all the areas is only needed, if we have a view which  */</span>
	<span class="cm">/* formats the debug areas. */</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">debug_info</span><span class="o">-&gt;</span><span class="n">views</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">format_proc</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="n">debug_info</span><span class="o">-&gt;</span><span class="n">views</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">header_proc</span><span class="p">){</span>
		<span class="n">debug_info_snapshot</span> <span class="o">=</span> <span class="n">debug_info_copy</span><span class="p">(</span><span class="n">debug_info</span><span class="p">,</span> <span class="n">NO_AREAS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">debug_info_snapshot</span> <span class="o">=</span> <span class="n">debug_info_copy</span><span class="p">(</span><span class="n">debug_info</span><span class="p">,</span> <span class="n">ALL_AREAS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">debug_info_snapshot</span><span class="p">){</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p_info</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">file_private_info_t</span><span class="p">),</span>
						<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">p_info</span><span class="p">){</span>
		<span class="n">debug_info_free</span><span class="p">(</span><span class="n">debug_info_snapshot</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p_info</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">p_info</span><span class="o">-&gt;</span><span class="n">debug_info_snap</span> <span class="o">=</span> <span class="n">debug_info_snapshot</span><span class="p">;</span>
	<span class="n">p_info</span><span class="o">-&gt;</span><span class="n">debug_info_org</span>  <span class="o">=</span> <span class="n">debug_info</span><span class="p">;</span>
	<span class="n">p_info</span><span class="o">-&gt;</span><span class="n">view</span> <span class="o">=</span> <span class="n">debug_info</span><span class="o">-&gt;</span><span class="n">views</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">p_info</span><span class="o">-&gt;</span><span class="n">act_area</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">p_info</span><span class="o">-&gt;</span><span class="n">act_page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">p_info</span><span class="o">-&gt;</span><span class="n">act_entry</span> <span class="o">=</span> <span class="n">DEBUG_PROLOG_ENTRY</span><span class="p">;</span>
	<span class="n">p_info</span><span class="o">-&gt;</span><span class="n">act_entry_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">p_info</span><span class="p">;</span>
	<span class="n">debug_info_get</span><span class="p">(</span><span class="n">debug_info</span><span class="p">);</span>
	<span class="n">nonseekable_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">debug_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * debug_close:</span>
<span class="cm"> * - called for user close()</span>
<span class="cm"> * - deletes  private_data area of the file handle</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="n">debug_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">file_private_info_t</span> <span class="o">*</span><span class="n">p_info</span><span class="p">;</span>
	<span class="n">p_info</span> <span class="o">=</span> <span class="p">(</span><span class="n">file_private_info_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">p_info</span><span class="o">-&gt;</span><span class="n">debug_info_snap</span><span class="p">)</span>
		<span class="n">debug_info_free</span><span class="p">(</span><span class="n">p_info</span><span class="o">-&gt;</span><span class="n">debug_info_snap</span><span class="p">);</span>
	<span class="n">debug_info_put</span><span class="p">(</span><span class="n">p_info</span><span class="o">-&gt;</span><span class="n">debug_info_org</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* success */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * debug_register_mode:</span>
<span class="cm"> * - Creates and initializes debug area for the caller</span>
<span class="cm"> *   The mode parameter allows to specify access rights for the s390dbf files</span>
<span class="cm"> * - Returns handle for debug area</span>
<span class="cm"> */</span>

<span class="n">debug_info_t</span> <span class="o">*</span><span class="n">debug_register_mode</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pages_per_area</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">nr_areas</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buf_size</span><span class="p">,</span> <span class="n">umode_t</span> <span class="n">mode</span><span class="p">,</span>
				  <span class="n">uid_t</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid_t</span> <span class="n">gid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debug_info_t</span> <span class="o">*</span><span class="n">rc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Since debugfs currently does not support uid/gid other than root, */</span>
	<span class="cm">/* we do not allow gid/uid != 0 until we get support for that. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">uid</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">gid</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Root becomes the owner of all s390dbf files &quot;</span>
			   <span class="s">&quot;in sysfs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">initialized</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">debug_mutex</span><span class="p">);</span>

        <span class="cm">/* create new debug_info */</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">debug_info_create</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">pages_per_area</span><span class="p">,</span> <span class="n">nr_areas</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> 
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">debug_register_view</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debug_level_view</span><span class="p">);</span>
        <span class="n">debug_register_view</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debug_flush_view</span><span class="p">);</span>
	<span class="n">debug_register_view</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debug_pages_view</span><span class="p">);</span>
<span class="nl">out:</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">){</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Registering debug feature %s failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
        <span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">debug_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">debug_register_mode</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * debug_register:</span>
<span class="cm"> * - creates and initializes debug area for the caller</span>
<span class="cm"> * - returns handle for debug area</span>
<span class="cm"> */</span>

<span class="n">debug_info_t</span> <span class="o">*</span><span class="nf">debug_register</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pages_per_area</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">nr_areas</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buf_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">debug_register_mode</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">pages_per_area</span><span class="p">,</span> <span class="n">nr_areas</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">,</span>
				   <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * debug_unregister:</span>
<span class="cm"> * - give back debug area</span>
<span class="cm"> */</span>

<span class="kt">void</span>
<span class="nf">debug_unregister</span><span class="p">(</span><span class="n">debug_info_t</span> <span class="o">*</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">id</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">debug_mutex</span><span class="p">);</span>
	<span class="n">debug_info_put</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">debug_mutex</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * debug_set_size:</span>
<span class="cm"> * - set area size (number of pages) and number of areas</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">debug_set_size</span><span class="p">(</span><span class="n">debug_info_t</span><span class="o">*</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_areas</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pages_per_area</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">debug_entry_t</span> <span class="o">***</span> <span class="n">new_areas</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">id</span> <span class="o">||</span> <span class="p">(</span><span class="n">nr_areas</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pages_per_area</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">pages_per_area</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
		<span class="n">new_areas</span> <span class="o">=</span> <span class="n">debug_areas_alloc</span><span class="p">(</span><span class="n">pages_per_area</span><span class="p">,</span> <span class="n">nr_areas</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">new_areas</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Allocating memory for %i pages failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pages_per_area</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">new_areas</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">debug_areas_free</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">areas</span> <span class="o">=</span> <span class="n">new_areas</span><span class="p">;</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">nr_areas</span> <span class="o">=</span> <span class="n">nr_areas</span><span class="p">;</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">pages_per_area</span> <span class="o">=</span> <span class="n">pages_per_area</span><span class="p">;</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">active_area</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">active_entries</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">*</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">nr_areas</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">active_pages</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">*</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">nr_areas</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: set new size (%i pages)</span><span class="se">\n</span><span class="s">&quot;</span> <span class="p">,</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pages_per_area</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * debug_set_level:</span>
<span class="cm"> * - set actual debug level</span>
<span class="cm"> */</span>

<span class="kt">void</span>
<span class="nf">debug_set_level</span><span class="p">(</span><span class="n">debug_info_t</span><span class="o">*</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">id</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>	
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">new_level</span> <span class="o">==</span> <span class="n">DEBUG_OFF_LEVEL</span><span class="p">){</span>
                <span class="n">id</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">=</span> <span class="n">DEBUG_OFF_LEVEL</span><span class="p">;</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: switched off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">new_level</span> <span class="o">&gt;</span> <span class="n">DEBUG_MAX_LEVEL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">new_level</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: level %i is out of range (%i - %i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                        <span class="n">id</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">new_level</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DEBUG_MAX_LEVEL</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">id</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">=</span> <span class="n">new_level</span><span class="p">;</span>
        <span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * proceed_active_entry:</span>
<span class="cm"> * - set active entry to next in the ring buffer</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">proceed_active_entry</span><span class="p">(</span><span class="n">debug_info_t</span> <span class="o">*</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">active_entries</span><span class="p">[</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">active_area</span><span class="p">]</span> <span class="o">+=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">)</span>
	    <span class="o">&gt;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">)){</span>
		<span class="n">id</span><span class="o">-&gt;</span><span class="n">active_entries</span><span class="p">[</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">active_area</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">id</span><span class="o">-&gt;</span><span class="n">active_pages</span><span class="p">[</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">active_area</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">active_pages</span><span class="p">[</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">active_area</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span>
			<span class="n">id</span><span class="o">-&gt;</span><span class="n">pages_per_area</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * proceed_active_area:</span>
<span class="cm"> * - set active area to next in the ring buffer</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">proceed_active_area</span><span class="p">(</span><span class="n">debug_info_t</span> <span class="o">*</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">active_area</span><span class="o">++</span><span class="p">;</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">active_area</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">active_area</span> <span class="o">%</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">nr_areas</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * get_active_entry:</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">debug_entry_t</span><span class="o">*</span>
<span class="nf">get_active_entry</span><span class="p">(</span><span class="n">debug_info_t</span> <span class="o">*</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">debug_entry_t</span> <span class="o">*</span><span class="p">)</span> <span class="p">(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">areas</span><span class="p">[</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">active_area</span><span class="p">]</span>
					<span class="p">[</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">active_pages</span><span class="p">[</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">active_area</span><span class="p">]])</span> <span class="o">+</span>
					<span class="n">id</span><span class="o">-&gt;</span><span class="n">active_entries</span><span class="p">[</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">active_area</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * debug_finish_entry:</span>
<span class="cm"> * - set timestamp, caller address, cpu number etc.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">debug_finish_entry</span><span class="p">(</span><span class="n">debug_info_t</span> <span class="o">*</span> <span class="n">id</span><span class="p">,</span> <span class="n">debug_entry_t</span><span class="o">*</span> <span class="n">active</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">exception</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">active</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">stck</span> <span class="o">=</span> <span class="n">get_clock</span><span class="p">();</span>
	<span class="n">active</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">fields</span><span class="p">.</span><span class="n">cpuid</span> <span class="o">=</span> <span class="n">smp_processor_id</span><span class="p">();</span>
	<span class="n">active</span><span class="o">-&gt;</span><span class="n">caller</span> <span class="o">=</span> <span class="n">__builtin_return_address</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">active</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">fields</span><span class="p">.</span><span class="n">exception</span> <span class="o">=</span> <span class="n">exception</span><span class="p">;</span>
	<span class="n">active</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">fields</span><span class="p">.</span><span class="n">level</span>     <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
	<span class="n">proceed_active_entry</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span>
		<span class="n">proceed_active_area</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug_stoppable</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug_active</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>

<span class="cp">#define CTL_S390DBF_STOPPABLE 5678</span>
<span class="cp">#define CTL_S390DBF_ACTIVE 5679</span>

<span class="cm">/*</span>
<span class="cm"> * proc handler for the running debug_active sysctl</span>
<span class="cm"> * always allow read, allow write only if debug_stoppable is set or</span>
<span class="cm"> * if debug_active is already off</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">s390dbf_procactive</span><span class="p">(</span><span class="n">ctl_table</span> <span class="o">*</span><span class="n">table</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write</span><span class="p">,</span>
                     <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">lenp</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">write</span> <span class="o">||</span> <span class="n">debug_stoppable</span> <span class="o">||</span> <span class="o">!</span><span class="n">debug_active</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">proc_dointvec</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">lenp</span><span class="p">,</span> <span class="n">ppos</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">ctl_table</span> <span class="n">s390dbf_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>       <span class="o">=</span> <span class="s">&quot;debug_stoppable&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">debug_stoppable</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>           <span class="o">=</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>   <span class="o">=</span> <span class="n">proc_dointvec</span><span class="p">,</span>
	<span class="p">},</span>
	 <span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>       <span class="o">=</span> <span class="s">&quot;debug_active&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">debug_active</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>           <span class="o">=</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>   <span class="o">=</span> <span class="n">s390dbf_procactive</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ctl_table</span> <span class="n">s390dbf_dir_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>       <span class="o">=</span> <span class="s">&quot;s390dbf&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>         <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span>           <span class="o">=</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IXUGO</span><span class="p">,</span>
		<span class="p">.</span><span class="n">child</span>          <span class="o">=</span> <span class="n">s390dbf_table</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ctl_table_header</span> <span class="o">*</span><span class="n">s390dbf_sysctl_header</span><span class="p">;</span>

<span class="kt">void</span>
<span class="nf">debug_stop_all</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_stoppable</span><span class="p">)</span>
		<span class="n">debug_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">debug_set_critical</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debug_critical</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * debug_event_common:</span>
<span class="cm"> * - write debug entry with given size</span>
<span class="cm"> */</span>

<span class="n">debug_entry_t</span><span class="o">*</span>
<span class="nf">debug_event_common</span><span class="p">(</span><span class="n">debug_info_t</span> <span class="o">*</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">debug_entry_t</span> <span class="o">*</span><span class="n">active</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug_active</span> <span class="o">||</span> <span class="o">!</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">areas</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_critical</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spin_trylock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">active</span> <span class="o">=</span> <span class="n">get_active_entry</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">DEBUG_DATA</span><span class="p">(</span><span class="n">active</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">DEBUG_DATA</span><span class="p">(</span><span class="n">active</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> <span class="n">min</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">));</span>
	<span class="n">debug_finish_entry</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">active</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * debug_exception_common:</span>
<span class="cm"> * - write debug entry with given size and switch to next debug area</span>
<span class="cm"> */</span>

<span class="n">debug_entry_t</span>
<span class="o">*</span><span class="nf">debug_exception_common</span><span class="p">(</span><span class="n">debug_info_t</span> <span class="o">*</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">debug_entry_t</span> <span class="o">*</span><span class="n">active</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug_active</span> <span class="o">||</span> <span class="o">!</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">areas</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_critical</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spin_trylock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">active</span> <span class="o">=</span> <span class="n">get_active_entry</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">DEBUG_DATA</span><span class="p">(</span><span class="n">active</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">DEBUG_DATA</span><span class="p">(</span><span class="n">active</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> <span class="n">min</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">));</span>
	<span class="n">debug_finish_entry</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">active</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * counts arguments in format string for sprintf view</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">debug_count_numargs</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">numargs</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span><span class="p">(</span><span class="o">*</span><span class="n">string</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="n">string</span><span class="o">++==</span><span class="sc">&#39;%&#39;</span><span class="p">)</span>
			<span class="n">numargs</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">(</span><span class="n">numargs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * debug_sprintf_event:</span>
<span class="cm"> */</span>

<span class="n">debug_entry_t</span><span class="o">*</span>
<span class="nf">debug_sprintf_event</span><span class="p">(</span><span class="n">debug_info_t</span><span class="o">*</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">,...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span>   <span class="n">ap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">numargs</span><span class="p">,</span><span class="n">idx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">debug_sprintf_entry_t</span> <span class="o">*</span><span class="n">curr_event</span><span class="p">;</span>
	<span class="n">debug_entry_t</span> <span class="o">*</span><span class="n">active</span><span class="p">;</span>

	<span class="k">if</span><span class="p">((</span><span class="o">!</span><span class="n">id</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug_active</span> <span class="o">||</span> <span class="o">!</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">areas</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">numargs</span><span class="o">=</span><span class="n">debug_count_numargs</span><span class="p">(</span><span class="n">string</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_critical</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spin_trylock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">active</span> <span class="o">=</span> <span class="n">get_active_entry</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
	<span class="n">curr_event</span><span class="o">=</span><span class="p">(</span><span class="n">debug_sprintf_entry_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">DEBUG_DATA</span><span class="p">(</span><span class="n">active</span><span class="p">);</span>
	<span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span><span class="n">string</span><span class="p">);</span>
	<span class="n">curr_event</span><span class="o">-&gt;</span><span class="n">string</span><span class="o">=</span><span class="n">string</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">idx</span><span class="o">&lt;</span><span class="n">min</span><span class="p">(</span><span class="n">numargs</span><span class="p">,(</span><span class="kt">int</span><span class="p">)(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">buf_size</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span><span class="n">idx</span><span class="o">++</span><span class="p">)</span>
		<span class="n">curr_event</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">=</span><span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span><span class="kt">long</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">debug_finish_entry</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">active</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * debug_sprintf_exception:</span>
<span class="cm"> */</span>

<span class="n">debug_entry_t</span><span class="o">*</span>
<span class="nf">debug_sprintf_exception</span><span class="p">(</span><span class="n">debug_info_t</span><span class="o">*</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">,...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span>   <span class="n">ap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">numargs</span><span class="p">,</span><span class="n">idx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">debug_sprintf_entry_t</span> <span class="o">*</span><span class="n">curr_event</span><span class="p">;</span>
	<span class="n">debug_entry_t</span> <span class="o">*</span><span class="n">active</span><span class="p">;</span>

	<span class="k">if</span><span class="p">((</span><span class="o">!</span><span class="n">id</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug_active</span> <span class="o">||</span> <span class="o">!</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">areas</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">numargs</span><span class="o">=</span><span class="n">debug_count_numargs</span><span class="p">(</span><span class="n">string</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_critical</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spin_trylock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">active</span> <span class="o">=</span> <span class="n">get_active_entry</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
	<span class="n">curr_event</span><span class="o">=</span><span class="p">(</span><span class="n">debug_sprintf_entry_t</span> <span class="o">*</span><span class="p">)</span><span class="n">DEBUG_DATA</span><span class="p">(</span><span class="n">active</span><span class="p">);</span>
	<span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span><span class="n">string</span><span class="p">);</span>
	<span class="n">curr_event</span><span class="o">-&gt;</span><span class="n">string</span><span class="o">=</span><span class="n">string</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">idx</span><span class="o">&lt;</span><span class="n">min</span><span class="p">(</span><span class="n">numargs</span><span class="p">,(</span><span class="kt">int</span><span class="p">)(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">buf_size</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span><span class="n">idx</span><span class="o">++</span><span class="p">)</span>
		<span class="n">curr_event</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">=</span><span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span><span class="kt">long</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">debug_finish_entry</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">active</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * debug_init:</span>
<span class="cm"> * - is called exactly once to initialize the debug feature</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="n">__init</span> <span class="nf">debug_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">s390dbf_sysctl_header</span> <span class="o">=</span> <span class="n">register_sysctl_table</span><span class="p">(</span><span class="n">s390dbf_dir_table</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">debug_mutex</span><span class="p">);</span>
	<span class="n">debug_debugfs_root_entry</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="n">DEBUG_DIR_ROOT</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="n">initialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">debug_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * debug_register_view:</span>
<span class="cm"> */</span>

<span class="kt">int</span>
<span class="nf">debug_register_view</span><span class="p">(</span><span class="n">debug_info_t</span> <span class="o">*</span> <span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">debug_view</span> <span class="o">*</span><span class="n">view</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">umode_t</span> <span class="n">mode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">pde</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">id</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">|</span> <span class="n">S_IFREG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">S_IXUGO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">view</span><span class="o">-&gt;</span><span class="n">prolog_proc</span> <span class="o">||</span> <span class="n">view</span><span class="o">-&gt;</span><span class="n">format_proc</span> <span class="o">||</span> <span class="n">view</span><span class="o">-&gt;</span><span class="n">header_proc</span><span class="p">))</span>
		<span class="n">mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IRGRP</span> <span class="o">|</span> <span class="n">S_IROTH</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">view</span><span class="o">-&gt;</span><span class="n">input_proc</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IWGRP</span> <span class="o">|</span> <span class="n">S_IWOTH</span><span class="p">);</span>
	<span class="n">pde</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">view</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">debugfs_root_entry</span><span class="p">,</span>
				<span class="n">id</span> <span class="p">,</span> <span class="o">&amp;</span><span class="n">debug_file_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pde</span><span class="p">){</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Registering view %s/%s failed due to out of &quot;</span>
		       <span class="s">&quot;memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">view</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DEBUG_MAX_VIEWS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">views</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">DEBUG_MAX_VIEWS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Registering view %s/%s would exceed the maximum &quot;</span>
		       <span class="s">&quot;number of views %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">view</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">pde</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">id</span><span class="o">-&gt;</span><span class="n">views</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">view</span><span class="p">;</span>
		<span class="n">id</span><span class="o">-&gt;</span><span class="n">debugfs_entries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pde</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * debug_unregister_view:</span>
<span class="cm"> */</span>

<span class="kt">int</span>
<span class="nf">debug_unregister_view</span><span class="p">(</span><span class="n">debug_info_t</span> <span class="o">*</span> <span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">debug_view</span> <span class="o">*</span><span class="n">view</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">id</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DEBUG_MAX_VIEWS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">views</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">view</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">DEBUG_MAX_VIEWS</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">debugfs_entries</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">id</span><span class="o">-&gt;</span><span class="n">views</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">debug_get_user_string</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">user_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span><span class="o">*</span> <span class="n">buffer</span><span class="p">;</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">user_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">user_buf</span><span class="p">,</span> <span class="n">user_len</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EFAULT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* got the string, now strip linefeed. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">user_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
		<span class="n">buffer</span><span class="p">[</span><span class="n">user_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">buffer</span><span class="p">[</span><span class="n">user_len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">debug_get_uint</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">skip_spaces</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="p">){</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * functions for debug-views</span>
<span class="cm"> ***********************************</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm"> * prints out actual debug level</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">debug_prolog_pages_fn</span><span class="p">(</span><span class="n">debug_info_t</span> <span class="o">*</span> <span class="n">id</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">debug_view</span> <span class="o">*</span><span class="n">view</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">out_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">out_buf</span><span class="p">,</span> <span class="s">&quot;%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">pages_per_area</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * reads new size (number of pages per debug area)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">debug_input_pages_fn</span><span class="p">(</span><span class="n">debug_info_t</span> <span class="o">*</span> <span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">debug_view</span> <span class="o">*</span><span class="n">view</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
			<span class="kt">size_t</span> <span class="n">user_len</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span><span class="n">new_pages</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">user_len</span> <span class="o">&gt;</span> <span class="mh">0x10000</span><span class="p">)</span>
                <span class="n">user_len</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">offset</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">str</span> <span class="o">=</span> <span class="n">debug_get_user_string</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span><span class="n">user_len</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">str</span><span class="p">)){</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">new_pages</span> <span class="o">=</span> <span class="n">debug_get_uint</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">new_pages</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_str</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">debug_set_size</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">nr_areas</span><span class="p">,</span> <span class="n">new_pages</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_str</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">user_len</span><span class="p">;</span>
<span class="nl">free_str:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="o">*</span><span class="n">offset</span> <span class="o">+=</span> <span class="n">user_len</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>		<span class="cm">/* number of input characters */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * prints out actual debug level</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">debug_prolog_level_fn</span><span class="p">(</span><span class="n">debug_info_t</span> <span class="o">*</span> <span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">debug_view</span> <span class="o">*</span><span class="n">view</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">out_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">==</span> <span class="n">DEBUG_OFF_LEVEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">out_buf</span><span class="p">,</span><span class="s">&quot;-</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">out_buf</span><span class="p">,</span> <span class="s">&quot;%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * reads new debug level</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">debug_input_level_fn</span><span class="p">(</span><span class="n">debug_info_t</span> <span class="o">*</span> <span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">debug_view</span> <span class="o">*</span><span class="n">view</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
			<span class="kt">size_t</span> <span class="n">user_len</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span><span class="n">new_level</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">user_len</span> <span class="o">&gt;</span> <span class="mh">0x10000</span><span class="p">)</span>
                <span class="n">user_len</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">offset</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">str</span> <span class="o">=</span> <span class="n">debug_get_user_string</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span><span class="n">user_len</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">str</span><span class="p">)){</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span><span class="p">){</span>
		<span class="n">debug_set_level</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">DEBUG_OFF_LEVEL</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">user_len</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_str</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">new_level</span> <span class="o">=</span> <span class="n">debug_get_uint</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">new_level</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s is not a valid level for a debug &quot;</span>
			   <span class="s">&quot;feature</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">debug_set_level</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">new_level</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">user_len</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">free_str:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="o">*</span><span class="n">offset</span> <span class="o">+=</span> <span class="n">user_len</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>		<span class="cm">/* number of input characters */</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * flushes debug areas</span>
<span class="cm"> */</span>
 
<span class="k">static</span> <span class="kt">void</span> <span class="nf">debug_flush</span><span class="p">(</span><span class="n">debug_info_t</span><span class="o">*</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">area</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">;</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">id</span> <span class="o">||</span> <span class="o">!</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">areas</span><span class="p">)</span>
                <span class="k">return</span><span class="p">;</span>
        <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">area</span> <span class="o">==</span> <span class="n">DEBUG_FLUSH_ALL</span><span class="p">){</span>
                <span class="n">id</span><span class="o">-&gt;</span><span class="n">active_area</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">memset</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">active_entries</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">nr_areas</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">nr_areas</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">id</span><span class="o">-&gt;</span><span class="n">active_pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">for</span><span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">pages_per_area</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                        	<span class="n">memset</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">area</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">area</span> <span class="o">&lt;</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">nr_areas</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">id</span><span class="o">-&gt;</span><span class="n">active_entries</span><span class="p">[</span><span class="n">area</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">id</span><span class="o">-&gt;</span><span class="n">active_pages</span><span class="p">[</span><span class="n">area</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">pages_per_area</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                	<span class="n">memset</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">areas</span><span class="p">[</span><span class="n">area</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="p">}</span>
        <span class="p">}</span>
        <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * view function: flushes debug areas </span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">debug_input_flush_fn</span><span class="p">(</span><span class="n">debug_info_t</span> <span class="o">*</span> <span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">debug_view</span> <span class="o">*</span><span class="n">view</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
			<span class="kt">size_t</span> <span class="n">user_len</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">char</span> <span class="n">input_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">user_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">user_len</span> <span class="o">&gt;</span> <span class="mh">0x10000</span><span class="p">)</span>
                <span class="n">user_len</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">offset</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>
                <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">input_buf</span><span class="p">,</span> <span class="n">user_buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)){</span>
                <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
                <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="n">input_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span><span class="p">)</span> <span class="p">{</span> 
                <span class="n">debug_flush</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">DEBUG_FLUSH_ALL</span><span class="p">);</span>
                <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">isdigit</span><span class="p">(</span><span class="n">input_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
                <span class="kt">int</span> <span class="n">area</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">input_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="sc">&#39;0&#39;</span><span class="p">);</span>
                <span class="n">debug_flush</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">area</span><span class="p">);</span>
                <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
        <span class="p">}</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Flushing debug data failed because %c is not a valid &quot;</span>
		 <span class="s">&quot;area</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">input_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

<span class="nl">out:</span>
        <span class="o">*</span><span class="n">offset</span> <span class="o">+=</span> <span class="n">user_len</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>              <span class="cm">/* number of input characters */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * prints debug header in raw format</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">debug_raw_header_fn</span><span class="p">(</span><span class="n">debug_info_t</span> <span class="o">*</span> <span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">debug_view</span> <span class="o">*</span><span class="n">view</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">area</span><span class="p">,</span> <span class="n">debug_entry_t</span> <span class="o">*</span> <span class="n">entry</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">out_buf</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">debug_entry_t</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">out_buf</span><span class="p">,</span><span class="n">entry</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">debug_entry_t</span><span class="p">));</span>
        <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * prints debug data in raw format</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">debug_raw_format_fn</span><span class="p">(</span><span class="n">debug_info_t</span> <span class="o">*</span> <span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">debug_view</span> <span class="o">*</span><span class="n">view</span><span class="p">,</span>
			       <span class="kt">char</span> <span class="o">*</span><span class="n">out_buf</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">in_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">out_buf</span><span class="p">,</span> <span class="n">in_buf</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * prints debug data in hex/ascii format</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">debug_hex_ascii_format_fn</span><span class="p">(</span><span class="n">debug_info_t</span> <span class="o">*</span> <span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">debug_view</span> <span class="o">*</span><span class="n">view</span><span class="p">,</span>
	    		  <span class="kt">char</span> <span class="o">*</span><span class="n">out_buf</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">in_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">rc</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">out_buf</span> <span class="o">+</span> <span class="n">rc</span><span class="p">,</span> <span class="s">&quot;%02x &quot;</span><span class="p">,</span>
                              <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">in_buf</span><span class="p">)[</span><span class="n">i</span><span class="p">]);</span>
        <span class="p">}</span>
	<span class="n">rc</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">out_buf</span> <span class="o">+</span> <span class="n">rc</span><span class="p">,</span> <span class="s">&quot;| &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">in_buf</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isascii</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">isprint</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
			<span class="n">rc</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">out_buf</span> <span class="o">+</span> <span class="n">rc</span><span class="p">,</span> <span class="s">&quot;%c&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rc</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">out_buf</span> <span class="o">+</span> <span class="n">rc</span><span class="p">,</span> <span class="s">&quot;.&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">out_buf</span> <span class="o">+</span> <span class="n">rc</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * prints header for debug entry</span>
<span class="cm"> */</span>

<span class="kt">int</span>
<span class="nf">debug_dflt_header_fn</span><span class="p">(</span><span class="n">debug_info_t</span> <span class="o">*</span> <span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">debug_view</span> <span class="o">*</span><span class="n">view</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">area</span><span class="p">,</span> <span class="n">debug_entry_t</span> <span class="o">*</span> <span class="n">entry</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">out_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">time_spec</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">except_str</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">caller</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">level</span><span class="p">;</span>

	<span class="n">level</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">fields</span><span class="p">.</span><span class="n">level</span><span class="p">;</span>
	<span class="n">stck_to_timespec</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">stck</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">time_spec</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">fields</span><span class="p">.</span><span class="n">exception</span><span class="p">)</span>
		<span class="n">except_str</span> <span class="o">=</span> <span class="s">&quot;*&quot;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">except_str</span> <span class="o">=</span> <span class="s">&quot;-&quot;</span><span class="p">;</span>
	<span class="n">caller</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">caller</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PSW_ADDR_INSN</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">out_buf</span><span class="p">,</span> <span class="s">&quot;%02i %011lu:%06lu %1u %1s %02i %p  &quot;</span><span class="p">,</span>
		      <span class="n">area</span><span class="p">,</span> <span class="n">time_spec</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span> <span class="n">time_spec</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span>
		      <span class="n">except_str</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">fields</span><span class="p">.</span><span class="n">cpuid</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">caller</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * prints debug data sprintf-formated:</span>
<span class="cm"> * debug_sprinf_event/exception calls must be used together with this view</span>
<span class="cm"> */</span>

<span class="cp">#define DEBUG_SPRINTF_MAX_ARGS 10</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">debug_sprintf_format_fn</span><span class="p">(</span><span class="n">debug_info_t</span> <span class="o">*</span> <span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">debug_view</span> <span class="o">*</span><span class="n">view</span><span class="p">,</span>
                        <span class="kt">char</span> <span class="o">*</span><span class="n">out_buf</span><span class="p">,</span> <span class="n">debug_sprintf_entry_t</span> <span class="o">*</span><span class="n">curr_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">num_longs</span><span class="p">,</span> <span class="n">num_used_args</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">[</span><span class="n">DEBUG_SPRINTF_MAX_ARGS</span><span class="p">];</span>

	<span class="cm">/* count of longs fit into one entry */</span>
	<span class="n">num_longs</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">buf_size</span> <span class="o">/</span>  <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">);</span> 

	<span class="k">if</span><span class="p">(</span><span class="n">num_longs</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span> <span class="cm">/* bufsize of entry too small */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">num_longs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* no args, we use only the string */</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">out_buf</span><span class="p">,</span> <span class="n">curr_event</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">curr_event</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* number of arguments used for sprintf (without the format string) */</span>
	<span class="n">num_used_args</span>   <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">DEBUG_SPRINTF_MAX_ARGS</span><span class="p">,</span> <span class="p">(</span><span class="n">num_longs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">DEBUG_SPRINTF_MAX_ARGS</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_used_args</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span>  <span class="n">sprintf</span><span class="p">(</span><span class="n">out_buf</span><span class="p">,</span> <span class="n">curr_event</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">,</span> <span class="n">curr_event</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
		<span class="n">curr_event</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">curr_event</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
		<span class="n">curr_event</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span> <span class="n">curr_event</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="mi">4</span><span class="p">]],</span>
		<span class="n">curr_event</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="mi">5</span><span class="p">]],</span> <span class="n">curr_event</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="mi">6</span><span class="p">]],</span>
		<span class="n">curr_event</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="mi">7</span><span class="p">]],</span> <span class="n">curr_event</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="mi">8</span><span class="p">]],</span>
		<span class="n">curr_event</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="mi">9</span><span class="p">]]);</span>

<span class="nl">out:</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * clean up module</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">debug_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">debug_debugfs_root_entry</span><span class="p">);</span>
	<span class="n">unregister_sysctl_table</span><span class="p">(</span><span class="n">s390dbf_sysctl_header</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * module definitions</span>
<span class="cm"> */</span>
<span class="n">postcore_initcall</span><span class="p">(</span><span class="n">debug_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">debug_exit</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">debug_register</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">debug_unregister</span><span class="p">);</span> 
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">debug_set_level</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">debug_stop_all</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">debug_register_view</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">debug_unregister_view</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">debug_event_common</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">debug_exception_common</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">debug_hex_ascii_view</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">debug_raw_view</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">debug_dflt_header_fn</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">debug_sprintf_view</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">debug_sprintf_exception</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">debug_sprintf_event</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
