<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › s390 › kernel › early.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>early.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  arch/s390/kernel/early.c</span>
<span class="cm"> *</span>
<span class="cm"> *    Copyright IBM Corp. 2007, 2009</span>
<span class="cm"> *    Author(s): Hongjie Yang &lt;hongjie@us.ibm.com&gt;,</span>
<span class="cm"> *		 Heiko Carstens &lt;heiko.carstens@de.ibm.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#define KMSG_COMPONENT &quot;setup&quot;</span>
<span class="cp">#define pr_fmt(fmt) KMSG_COMPONENT &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/compiler.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/ftrace.h&gt;</span>
<span class="cp">#include &lt;linux/lockdep.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/pfn.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;asm/ebcdic.h&gt;</span>
<span class="cp">#include &lt;asm/ipl.h&gt;</span>
<span class="cp">#include &lt;asm/lowcore.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;</span>
<span class="cp">#include &lt;asm/sections.h&gt;</span>
<span class="cp">#include &lt;asm/setup.h&gt;</span>
<span class="cp">#include &lt;asm/sysinfo.h&gt;</span>
<span class="cp">#include &lt;asm/cpcmd.h&gt;</span>
<span class="cp">#include &lt;asm/sclp.h&gt;</span>
<span class="cp">#include &lt;asm/facility.h&gt;</span>
<span class="cp">#include &quot;entry.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Create a Kernel NSS if the SAVESYS= parameter is defined</span>
<span class="cm"> */</span>
<span class="cp">#define DEFSYS_CMD_SIZE		128</span>
<span class="cp">#define SAVESYS_CMD_SIZE	32</span>

<span class="kt">char</span> <span class="n">kernel_nss_name</span><span class="p">[</span><span class="n">NSS_NAME_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="n">setup_boot_command_line</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Get the TOD clock running.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">reset_tod_clock</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">time</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">store_clock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">time</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/* TOD clock not running. Set the clock to Unix Epoch. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set_clock</span><span class="p">(</span><span class="n">TOD_UNIX_EPOCH</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">store_clock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">time</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">disabled_wait</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">sched_clock_base_cc</span> <span class="o">=</span> <span class="n">TOD_UNIX_EPOCH</span><span class="p">;</span>
	<span class="n">S390_lowcore</span><span class="p">.</span><span class="n">last_update_clock</span> <span class="o">=</span> <span class="n">sched_clock_base_cc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SHARED_KERNEL</span>
<span class="kt">int</span> <span class="n">__init</span> <span class="n">savesys_ipl_nss</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">cmdlen</span><span class="p">);</span>

<span class="n">asm</span><span class="p">(</span>
	<span class="s">&quot;	.section .init.text,</span><span class="se">\&quot;</span><span class="s">ax</span><span class="se">\&quot;</span><span class="s">,@progbits</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;	.align	4</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;	.type	savesys_ipl_nss, @function</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;savesys_ipl_nss:</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="cp">#ifdef CONFIG_64BIT</span>
	<span class="s">&quot;	stmg	6,15,48(15)</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;	lgr	14,3</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;	sam31</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;	diag	2,14,0x8</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;	sam64</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;	lgr	2,14</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;	lmg	6,15,48(15)</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="cp">#else</span>
	<span class="s">&quot;	stm	6,15,24(15)</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;	lr	14,3</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;	diag	2,14,0x8</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;	lr	2,14</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;	lm	6,15,24(15)</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="cp">#endif</span>
	<span class="s">&quot;	br	14</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;	.size	savesys_ipl_nss, .-savesys_ipl_nss</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;	.previous</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">__initdata</span> <span class="kt">char</span> <span class="n">upper_command_line</span><span class="p">[</span><span class="n">COMMAND_LINE_SIZE</span><span class="p">];</span>

<span class="k">static</span> <span class="n">noinline</span> <span class="n">__init</span> <span class="kt">void</span> <span class="nf">create_kernel_nss</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">stext_pfn</span><span class="p">,</span> <span class="n">eshared_pfn</span><span class="p">,</span> <span class="n">end_pfn</span><span class="p">,</span> <span class="n">min_size</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_BLK_DEV_INITRD</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sinitrd_pfn</span><span class="p">,</span> <span class="n">einitrd_pfn</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">int</span> <span class="n">response</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hlen</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">savesys_ptr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">defsys_cmd</span><span class="p">[</span><span class="n">DEFSYS_CMD_SIZE</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">savesys_cmd</span><span class="p">[</span><span class="n">SAVESYS_CMD_SIZE</span><span class="p">];</span>

	<span class="cm">/* Do nothing if we are not running under VM */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">MACHINE_IS_VM</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Convert COMMAND_LINE to upper case */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">strlen</span><span class="p">(</span><span class="n">boot_command_line</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">upper_command_line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">toupper</span><span class="p">(</span><span class="n">boot_command_line</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">savesys_ptr</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">upper_command_line</span><span class="p">,</span> <span class="s">&quot;SAVESYS=&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">savesys_ptr</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">savesys_ptr</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>    <span class="cm">/* Point to the beginning of the NSS name */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NSS_NAME_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">savesys_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span> <span class="o">||</span> <span class="n">savesys_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">kernel_nss_name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">savesys_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">stext_pfn</span> <span class="o">=</span> <span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">__pa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_stext</span><span class="p">));</span>
	<span class="n">eshared_pfn</span> <span class="o">=</span> <span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">__pa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_eshared</span><span class="p">));</span>
	<span class="n">end_pfn</span> <span class="o">=</span> <span class="n">PFN_UP</span><span class="p">(</span><span class="n">__pa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_end</span><span class="p">));</span>
	<span class="n">min_size</span> <span class="o">=</span> <span class="n">end_pfn</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">hlen</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">defsys_cmd</span><span class="p">,</span> <span class="n">DEFSYS_CMD_SIZE</span><span class="p">,</span>
			<span class="s">&quot;DEFSYS %s 00000-%.5X EW %.5X-%.5X SR %.5X-%.5X&quot;</span><span class="p">,</span>
			<span class="n">kernel_nss_name</span><span class="p">,</span> <span class="n">stext_pfn</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">stext_pfn</span><span class="p">,</span>
			<span class="n">eshared_pfn</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">eshared_pfn</span><span class="p">,</span> <span class="n">end_pfn</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_BLK_DEV_INITRD</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">INITRD_START</span> <span class="o">&amp;&amp;</span> <span class="n">INITRD_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sinitrd_pfn</span> <span class="o">=</span> <span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">__pa</span><span class="p">(</span><span class="n">INITRD_START</span><span class="p">));</span>
		<span class="n">einitrd_pfn</span> <span class="o">=</span> <span class="n">PFN_UP</span><span class="p">(</span><span class="n">__pa</span><span class="p">(</span><span class="n">INITRD_START</span> <span class="o">+</span> <span class="n">INITRD_SIZE</span><span class="p">));</span>
		<span class="n">min_size</span> <span class="o">=</span> <span class="n">einitrd_pfn</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">hlen</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">defsys_cmd</span> <span class="o">+</span> <span class="n">hlen</span><span class="p">,</span> <span class="n">DEFSYS_CMD_SIZE</span> <span class="o">-</span> <span class="n">hlen</span><span class="p">,</span>
				 <span class="s">&quot; EW %.5X-%.5X&quot;</span><span class="p">,</span> <span class="n">sinitrd_pfn</span><span class="p">,</span> <span class="n">einitrd_pfn</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">defsys_cmd</span> <span class="o">+</span> <span class="n">hlen</span><span class="p">,</span> <span class="n">DEFSYS_CMD_SIZE</span> <span class="o">-</span> <span class="n">hlen</span><span class="p">,</span>
		 <span class="s">&quot; EW MINSIZE=%.7iK PARMREGS=0-13&quot;</span><span class="p">,</span> <span class="n">min_size</span><span class="p">);</span>
	<span class="n">defsys_cmd</span><span class="p">[</span><span class="n">DEFSYS_CMD_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">savesys_cmd</span><span class="p">,</span> <span class="n">SAVESYS_CMD_SIZE</span><span class="p">,</span> <span class="s">&quot;SAVESYS %s </span><span class="se">\n</span><span class="s"> IPL %s&quot;</span><span class="p">,</span>
		 <span class="n">kernel_nss_name</span><span class="p">,</span> <span class="n">kernel_nss_name</span><span class="p">);</span>
	<span class="n">savesys_cmd</span><span class="p">[</span><span class="n">SAVESYS_CMD_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">__cpcmd</span><span class="p">(</span><span class="n">defsys_cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">response</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">response</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Defining the Linux kernel NSS failed with rc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">response</span><span class="p">);</span>
		<span class="n">kernel_nss_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">savesys_cmd</span><span class="p">);</span>
	<span class="n">ASCEBC</span><span class="p">(</span><span class="n">savesys_cmd</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">response</span> <span class="o">=</span> <span class="n">savesys_ipl_nss</span><span class="p">(</span><span class="n">savesys_cmd</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="cm">/* On success: response is equal to the command size,</span>
<span class="cm">	 *	       max SAVESYS_CMD_SIZE</span>
<span class="cm">	 * On error: response contains the numeric portion of cp error message.</span>
<span class="cm">	 *	     for SAVESYS it will be &gt;= 263</span>
<span class="cm">	 *	     for missing privilege class, it will be 1</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">response</span> <span class="o">&gt;</span> <span class="n">SAVESYS_CMD_SIZE</span> <span class="o">||</span> <span class="n">response</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Saving the Linux kernel NSS failed with rc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">response</span><span class="p">);</span>
		<span class="n">kernel_nss_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* re-initialize cputime accounting. */</span>
	<span class="n">sched_clock_base_cc</span> <span class="o">=</span> <span class="n">get_clock</span><span class="p">();</span>
	<span class="n">S390_lowcore</span><span class="p">.</span><span class="n">last_update_clock</span> <span class="o">=</span> <span class="n">sched_clock_base_cc</span><span class="p">;</span>
	<span class="n">S390_lowcore</span><span class="p">.</span><span class="n">last_update_timer</span> <span class="o">=</span> <span class="mh">0x7fffffffffffffffULL</span><span class="p">;</span>
	<span class="n">S390_lowcore</span><span class="p">.</span><span class="n">user_timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">S390_lowcore</span><span class="p">.</span><span class="n">system_timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;SPT 0(%0)&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">S390_lowcore</span><span class="p">.</span><span class="n">last_update_timer</span><span class="p">));</span>

	<span class="cm">/* re-setup boot command line with new ipl vm parms */</span>
	<span class="n">ipl_update_parameters</span><span class="p">();</span>
	<span class="n">setup_boot_command_line</span><span class="p">();</span>

	<span class="n">ipl_flags</span> <span class="o">=</span> <span class="n">IPL_NSS_VALID</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else </span><span class="cm">/* CONFIG_SHARED_KERNEL */</span><span class="cp"></span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">create_kernel_nss</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_SHARED_KERNEL */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Clear bss memory</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">noinline</span> <span class="n">__init</span> <span class="kt">void</span> <span class="nf">clear_bss_section</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">__bss_start</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">__bss_stop</span> <span class="o">-</span> <span class="n">__bss_start</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize storage key for kernel pages</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">noinline</span> <span class="n">__init</span> <span class="kt">void</span> <span class="nf">init_kernel_storage_key</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_pfn</span><span class="p">,</span> <span class="n">init_pfn</span><span class="p">;</span>

	<span class="n">end_pfn</span> <span class="o">=</span> <span class="n">PFN_UP</span><span class="p">(</span><span class="n">__pa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_end</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">init_pfn</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">init_pfn</span> <span class="o">&lt;</span> <span class="n">end_pfn</span><span class="p">;</span> <span class="n">init_pfn</span><span class="o">++</span><span class="p">)</span>
		<span class="n">page_set_storage_key</span><span class="p">(</span><span class="n">init_pfn</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span>
				     <span class="n">PAGE_DEFAULT_KEY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__initdata</span> <span class="k">struct</span> <span class="n">sysinfo_3_2_2</span> <span class="n">vmms</span> <span class="n">__aligned</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">);</span>

<span class="k">static</span> <span class="n">noinline</span> <span class="n">__init</span> <span class="kt">void</span> <span class="nf">detect_machine_type</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Check current-configuration-level */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">stsi</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">S390_lowcore</span><span class="p">.</span><span class="n">machine_flags</span> <span class="o">|=</span> <span class="n">MACHINE_FLAG_LPAR</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Get virtual-machine cpu information. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stsi</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vmms</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOSYS</span> <span class="o">||</span> <span class="o">!</span><span class="n">vmms</span><span class="p">.</span><span class="n">count</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Running under KVM? If not we assume z/VM */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">vmms</span><span class="p">.</span><span class="n">vm</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cpi</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\xd2\xe5\xd4</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
		<span class="n">S390_lowcore</span><span class="p">.</span><span class="n">machine_flags</span> <span class="o">|=</span> <span class="n">MACHINE_FLAG_KVM</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">S390_lowcore</span><span class="p">.</span><span class="n">machine_flags</span> <span class="o">|=</span> <span class="n">MACHINE_FLAG_VM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">early_pgm_check_handler</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">exception_table_entry</span> <span class="o">*</span><span class="n">fixup</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">S390_lowcore</span><span class="p">.</span><span class="n">program_old_psw</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">fixup</span> <span class="o">=</span> <span class="n">search_exception_tables</span><span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="n">PSW_ADDR_INSN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fixup</span><span class="p">)</span>
		<span class="n">disabled_wait</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">S390_lowcore</span><span class="p">.</span><span class="n">program_old_psw</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">fixup</span><span class="o">-&gt;</span><span class="n">fixup</span> <span class="o">|</span> <span class="n">PSW_ADDR_AMODE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline</span> <span class="n">__init</span> <span class="kt">void</span> <span class="nf">setup_lowcore_early</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">psw_t</span> <span class="n">psw</span><span class="p">;</span>

	<span class="n">psw</span><span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">PSW_MASK_BASE</span> <span class="o">|</span> <span class="n">PSW_DEFAULT_KEY</span> <span class="o">|</span> <span class="n">PSW_MASK_EA</span> <span class="o">|</span> <span class="n">PSW_MASK_BA</span><span class="p">;</span>
	<span class="n">psw</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">PSW_ADDR_AMODE</span> <span class="o">|</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">s390_base_ext_handler</span><span class="p">;</span>
	<span class="n">S390_lowcore</span><span class="p">.</span><span class="n">external_new_psw</span> <span class="o">=</span> <span class="n">psw</span><span class="p">;</span>
	<span class="n">psw</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">PSW_ADDR_AMODE</span> <span class="o">|</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">s390_base_pgm_handler</span><span class="p">;</span>
	<span class="n">S390_lowcore</span><span class="p">.</span><span class="n">program_new_psw</span> <span class="o">=</span> <span class="n">psw</span><span class="p">;</span>
	<span class="n">s390_base_pgm_handler_fn</span> <span class="o">=</span> <span class="n">early_pgm_check_handler</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline</span> <span class="n">__init</span> <span class="kt">void</span> <span class="nf">setup_facility_list</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">stfle</span><span class="p">(</span><span class="n">S390_lowcore</span><span class="p">.</span><span class="n">stfle_fac_list</span><span class="p">,</span>
	      <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">S390_lowcore</span><span class="p">.</span><span class="n">stfle_fac_list</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline</span> <span class="n">__init</span> <span class="kt">void</span> <span class="nf">setup_hpage</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef CONFIG_DEBUG_PAGEALLOC</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_facility</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">test_facility</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">S390_lowcore</span><span class="p">.</span><span class="n">machine_flags</span> <span class="o">|=</span> <span class="n">MACHINE_FLAG_HPAGE</span><span class="p">;</span>
	<span class="n">__ctl_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">23</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">void</span> <span class="nf">detect_mvpg</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef CONFIG_64BIT</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span>
		<span class="s">&quot;	la	0,0</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	mvpg	%2,%2</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;0:	la	%0,0</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;1:</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="n">EX_TABLE</span><span class="p">(</span><span class="mi">0</span><span class="n">b</span><span class="p">,</span><span class="mi">1</span><span class="n">b</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;=d&quot;</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;0&quot;</span> <span class="p">(</span><span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">),</span> <span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;memory&quot;</span><span class="p">,</span> <span class="s">&quot;cc&quot;</span><span class="p">,</span> <span class="s">&quot;0&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">S390_lowcore</span><span class="p">.</span><span class="n">machine_flags</span> <span class="o">|=</span> <span class="n">MACHINE_FLAG_MVPG</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">void</span> <span class="nf">detect_ieee</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef CONFIG_64BIT</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span>
		<span class="s">&quot;	efpc	%1,0</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;0:	la	%0,0</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;1:</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="n">EX_TABLE</span><span class="p">(</span><span class="mi">0</span><span class="n">b</span><span class="p">,</span><span class="mi">1</span><span class="n">b</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;=d&quot;</span> <span class="p">(</span><span class="n">rc</span><span class="p">),</span> <span class="s">&quot;=d&quot;</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="o">:</span> <span class="s">&quot;0&quot;</span> <span class="p">(</span><span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;cc&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">S390_lowcore</span><span class="p">.</span><span class="n">machine_flags</span> <span class="o">|=</span> <span class="n">MACHINE_FLAG_IEEE</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">void</span> <span class="nf">detect_csp</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef CONFIG_64BIT</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span>
		<span class="s">&quot;	la	0,0</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	la	1,0</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	la	2,4</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	csp	0,2</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;0:	la	%0,0</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;1:</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="n">EX_TABLE</span><span class="p">(</span><span class="mi">0</span><span class="n">b</span><span class="p">,</span><span class="mi">1</span><span class="n">b</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;=d&quot;</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;0&quot;</span> <span class="p">(</span><span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;cc&quot;</span><span class="p">,</span> <span class="s">&quot;0&quot;</span><span class="p">,</span> <span class="s">&quot;1&quot;</span><span class="p">,</span> <span class="s">&quot;2&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">S390_lowcore</span><span class="p">.</span><span class="n">machine_flags</span> <span class="o">|=</span> <span class="n">MACHINE_FLAG_CSP</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">void</span> <span class="nf">detect_diag9c</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu_address</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cpu_address</span> <span class="o">=</span> <span class="n">stap</span><span class="p">();</span>
	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span>
		<span class="s">&quot;	diag	%2,0,0x9c</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;0:	la	%0,0</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;1:</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="n">EX_TABLE</span><span class="p">(</span><span class="mi">0</span><span class="n">b</span><span class="p">,</span><span class="mi">1</span><span class="n">b</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;=d&quot;</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;0&quot;</span> <span class="p">(</span><span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">),</span> <span class="s">&quot;d&quot;</span> <span class="p">(</span><span class="n">cpu_address</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;cc&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">S390_lowcore</span><span class="p">.</span><span class="n">machine_flags</span> <span class="o">|=</span> <span class="n">MACHINE_FLAG_DIAG9C</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">void</span> <span class="nf">detect_diag44</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_64BIT</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span>
		<span class="s">&quot;	diag	0,0,0x44</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;0:	la	%0,0</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;1:</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="n">EX_TABLE</span><span class="p">(</span><span class="mi">0</span><span class="n">b</span><span class="p">,</span><span class="mi">1</span><span class="n">b</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;=d&quot;</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;0&quot;</span> <span class="p">(</span><span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;cc&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">S390_lowcore</span><span class="p">.</span><span class="n">machine_flags</span> <span class="o">|=</span> <span class="n">MACHINE_FLAG_DIAG44</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">void</span> <span class="nf">detect_machine_facilities</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_64BIT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_facility</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
		<span class="n">S390_lowcore</span><span class="p">.</span><span class="n">machine_flags</span> <span class="o">|=</span> <span class="n">MACHINE_FLAG_IDTE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_facility</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
		<span class="n">S390_lowcore</span><span class="p">.</span><span class="n">machine_flags</span> <span class="o">|=</span> <span class="n">MACHINE_FLAG_PFMF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_facility</span><span class="p">(</span><span class="mi">11</span><span class="p">))</span>
		<span class="n">S390_lowcore</span><span class="p">.</span><span class="n">machine_flags</span> <span class="o">|=</span> <span class="n">MACHINE_FLAG_TOPOLOGY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_facility</span><span class="p">(</span><span class="mi">27</span><span class="p">))</span>
		<span class="n">S390_lowcore</span><span class="p">.</span><span class="n">machine_flags</span> <span class="o">|=</span> <span class="n">MACHINE_FLAG_MVCOS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_facility</span><span class="p">(</span><span class="mi">40</span><span class="p">))</span>
		<span class="n">S390_lowcore</span><span class="p">.</span><span class="n">machine_flags</span> <span class="o">|=</span> <span class="n">MACHINE_FLAG_SPP</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">void</span> <span class="nf">rescue_initrd</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_BLK_DEV_INITRD</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">min_initrd_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">_end</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4UL</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Just like in case of IPL from VM reader we make sure there is a</span>
<span class="cm">	 * gap of 4MB between end of kernel and start of initrd.</span>
<span class="cm">	 * That way we can also be sure that saving an NSS will succeed,</span>
<span class="cm">	 * which however only requires different segments.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">INITRD_START</span> <span class="o">||</span> <span class="o">!</span><span class="n">INITRD_SIZE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">INITRD_START</span> <span class="o">&gt;=</span> <span class="n">min_initrd_addr</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">memmove</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">min_initrd_addr</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">INITRD_START</span><span class="p">,</span> <span class="n">INITRD_SIZE</span><span class="p">);</span>
	<span class="n">INITRD_START</span> <span class="o">=</span> <span class="n">min_initrd_addr</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/* Set up boot command line */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">append_to_cmdline</span><span class="p">(</span><span class="kt">size_t</span> <span class="p">(</span><span class="o">*</span><span class="n">ipl_data</span><span class="p">)(</span><span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">))</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">parm</span><span class="p">,</span> <span class="o">*</span><span class="n">delim</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">rc</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">boot_command_line</span><span class="p">);</span>

	<span class="n">delim</span> <span class="o">=</span> <span class="n">boot_command_line</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>	<span class="cm">/* &#39;\0&#39; character position */</span>
	<span class="n">parm</span>  <span class="o">=</span> <span class="n">boot_command_line</span> <span class="o">+</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* append right after &#39;\0&#39; */</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ipl_data</span><span class="p">(</span><span class="n">parm</span><span class="p">,</span> <span class="n">COMMAND_LINE_SIZE</span> <span class="o">-</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">parm</span> <span class="o">==</span> <span class="sc">&#39;=&#39;</span><span class="p">)</span>
			<span class="n">memmove</span><span class="p">(</span><span class="n">boot_command_line</span><span class="p">,</span> <span class="n">parm</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">delim</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>		<span class="cm">/* replace &#39;\0&#39; with space */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">has_ebcdic_char</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">str</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">str</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">setup_boot_command_line</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">COMMAND_LINE</span><span class="p">[</span><span class="n">ARCH_COMMAND_LINE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* convert arch command line to ascii if necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">has_ebcdic_char</span><span class="p">(</span><span class="n">COMMAND_LINE</span><span class="p">))</span>
		<span class="n">EBCASC</span><span class="p">(</span><span class="n">COMMAND_LINE</span><span class="p">,</span> <span class="n">ARCH_COMMAND_LINE_SIZE</span><span class="p">);</span>
	<span class="cm">/* copy arch command line */</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">boot_command_line</span><span class="p">,</span> <span class="n">strstrip</span><span class="p">(</span><span class="n">COMMAND_LINE</span><span class="p">),</span>
		<span class="n">ARCH_COMMAND_LINE_SIZE</span><span class="p">);</span>

	<span class="cm">/* append IPL PARM data to the boot command line */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MACHINE_IS_VM</span><span class="p">)</span>
		<span class="n">append_to_cmdline</span><span class="p">(</span><span class="n">append_ipl_vmparm</span><span class="p">);</span>

	<span class="n">append_to_cmdline</span><span class="p">(</span><span class="n">append_ipl_scpdata</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Save ipl parameters, clear bss memory, initialize storage keys</span>
<span class="cm"> * and create a kernel NSS at startup if the SAVESYS= parm is defined</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">startup_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">reset_tod_clock</span><span class="p">();</span>
	<span class="n">ipl_save_parameters</span><span class="p">();</span>
	<span class="n">rescue_initrd</span><span class="p">();</span>
	<span class="n">clear_bss_section</span><span class="p">();</span>
	<span class="n">init_kernel_storage_key</span><span class="p">();</span>
	<span class="n">lockdep_init</span><span class="p">();</span>
	<span class="n">lockdep_off</span><span class="p">();</span>
	<span class="n">sort_main_extable</span><span class="p">();</span>
	<span class="n">setup_lowcore_early</span><span class="p">();</span>
	<span class="n">setup_facility_list</span><span class="p">();</span>
	<span class="n">detect_machine_type</span><span class="p">();</span>
	<span class="n">ipl_update_parameters</span><span class="p">();</span>
	<span class="n">setup_boot_command_line</span><span class="p">();</span>
	<span class="n">create_kernel_nss</span><span class="p">();</span>
	<span class="n">detect_mvpg</span><span class="p">();</span>
	<span class="n">detect_ieee</span><span class="p">();</span>
	<span class="n">detect_csp</span><span class="p">();</span>
	<span class="n">detect_diag9c</span><span class="p">();</span>
	<span class="n">detect_diag44</span><span class="p">();</span>
	<span class="n">detect_machine_facilities</span><span class="p">();</span>
	<span class="n">setup_hpage</span><span class="p">();</span>
	<span class="n">sclp_facilities_detect</span><span class="p">();</span>
	<span class="n">detect_memory_layout</span><span class="p">(</span><span class="n">memory_chunk</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_DYNAMIC_FTRACE</span>
	<span class="n">S390_lowcore</span><span class="p">.</span><span class="n">ftrace_func</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ftrace_caller</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">lockdep_on</span><span class="p">();</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
