<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › s390 › include › asm › processor.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>processor.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  include/asm-s390/processor.h</span>
<span class="cm"> *</span>
<span class="cm"> *  S390 version</span>
<span class="cm"> *    Copyright (C) 1999 IBM Deutschland Entwicklung GmbH, IBM Corporation</span>
<span class="cm"> *    Author(s): Hartmut Penner (hp@de.ibm.com),</span>
<span class="cm"> *               Martin Schwidefsky (schwidefsky@de.ibm.com)</span>
<span class="cm"> *</span>
<span class="cm"> *  Derived from &quot;include/asm-i386/processor.h&quot;</span>
<span class="cm"> *    Copyright (C) 1994, Linus Torvalds</span>
<span class="cm"> */</span>

<span class="cp">#ifndef __ASM_S390_PROCESSOR_H</span>
<span class="cp">#define __ASM_S390_PROCESSOR_H</span>

<span class="cp">#include &lt;linux/linkage.h&gt;</span>
<span class="cp">#include &lt;linux/irqflags.h&gt;</span>
<span class="cp">#include &lt;asm/cpu.h&gt;</span>
<span class="cp">#include &lt;asm/page.h&gt;</span>
<span class="cp">#include &lt;asm/ptrace.h&gt;</span>
<span class="cp">#include &lt;asm/setup.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * Default implementation of macro that returns current</span>
<span class="cm"> * instruction pointer (&quot;program counter&quot;).</span>
<span class="cm"> */</span>
<span class="cp">#define current_text_addr() ({ void *pc; asm(&quot;basr %0,0&quot; : &quot;=a&quot; (pc)); pc; })</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">get_cpu_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpuid</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;stidp %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=Q&quot;</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">s390_adjust_jiffies</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">cpuinfo_op</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">sysctl_ieee_emulation_warnings</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * User space process size: 2GB for 31 bit, 4TB or 8PT for 64 bit.</span>
<span class="cm"> */</span>
<span class="cp">#ifndef CONFIG_64BIT</span>

<span class="cp">#define TASK_SIZE		(1UL &lt;&lt; 31)</span>
<span class="cp">#define TASK_UNMAPPED_BASE	(1UL &lt;&lt; 30)</span>

<span class="cp">#else </span><span class="cm">/* CONFIG_64BIT */</span><span class="cp"></span>

<span class="cp">#define TASK_SIZE_OF(tsk)	((tsk)-&gt;mm-&gt;context.asce_limit)</span>
<span class="cp">#define TASK_UNMAPPED_BASE	(test_thread_flag(TIF_31BIT) ? \</span>
<span class="cp">					(1UL &lt;&lt; 30) : (1UL &lt;&lt; 41))</span>
<span class="cp">#define TASK_SIZE		TASK_SIZE_OF(current)</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_64BIT */</span><span class="cp"></span>

<span class="cp">#ifndef CONFIG_64BIT</span>
<span class="cp">#define STACK_TOP		(1UL &lt;&lt; 31)</span>
<span class="cp">#define STACK_TOP_MAX		(1UL &lt;&lt; 31)</span>
<span class="cp">#else </span><span class="cm">/* CONFIG_64BIT */</span><span class="cp"></span>
<span class="cp">#define STACK_TOP		(1UL &lt;&lt; (test_thread_flag(TIF_31BIT) ? 31:42))</span>
<span class="cp">#define STACK_TOP_MAX		(1UL &lt;&lt; 42)</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_64BIT */</span><span class="cp"></span>

<span class="cp">#define HAVE_ARCH_PICK_MMAP_LAYOUT</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
        <span class="n">__u32</span> <span class="n">ar4</span><span class="p">;</span>
<span class="p">}</span> <span class="n">mm_segment_t</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Thread structure</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">thread_struct</span> <span class="p">{</span>
	<span class="n">s390_fp_regs</span> <span class="n">fp_regs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">acrs</span><span class="p">[</span><span class="n">NUM_ACRS</span><span class="p">];</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ksp</span><span class="p">;</span>              <span class="cm">/* kernel stack pointer             */</span>
	<span class="n">mm_segment_t</span> <span class="n">mm_segment</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">gmap_addr</span><span class="p">;</span>	<span class="cm">/* address of last gmap fault. */</span>
	<span class="k">struct</span> <span class="n">per_regs</span> <span class="n">per_user</span><span class="p">;</span>	<span class="cm">/* User specified PER registers */</span>
	<span class="k">struct</span> <span class="n">per_event</span> <span class="n">per_event</span><span class="p">;</span>	<span class="cm">/* Cause of the last PER trap */</span>
        <span class="cm">/* pfault_wait is used to block the process on a pfault event */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pfault_wait</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">thread_struct</span> <span class="n">thread_struct</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Stack layout of a C stack frame.</span>
<span class="cm"> */</span>
<span class="cp">#ifndef __PACK_STACK</span>
<span class="k">struct</span> <span class="n">stack_frame</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">back_chain</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">empty1</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">gprs</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">empty2</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="p">};</span>
<span class="cp">#else</span>
<span class="k">struct</span> <span class="n">stack_frame</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">empty1</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">empty2</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">gprs</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">back_chain</span><span class="p">;</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="cp">#define ARCH_MIN_TASKALIGN	8</span>

<span class="cp">#define INIT_THREAD {							\</span>
<span class="cp">	.ksp = sizeof(init_stack) + (unsigned long) &amp;init_stack,	\</span>
<span class="cp">}</span>

<span class="cm">/*</span>
<span class="cm"> * Do necessary setup to start up a new thread.</span>
<span class="cm"> */</span>
<span class="cp">#define start_thread(regs, new_psw, new_stackp) do {			\</span>
<span class="cp">	regs-&gt;psw.mask	= psw_user_bits | PSW_MASK_EA | PSW_MASK_BA;	\</span>
<span class="cp">	regs-&gt;psw.addr	= new_psw | PSW_ADDR_AMODE;			\</span>
<span class="cp">	regs-&gt;gprs[15]	= new_stackp;					\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define start_thread31(regs, new_psw, new_stackp) do {			\</span>
<span class="cp">	regs-&gt;psw.mask	= psw_user_bits | PSW_MASK_BA;			\</span>
<span class="cp">	regs-&gt;psw.addr	= new_psw | PSW_ADDR_AMODE;			\</span>
<span class="cp">	regs-&gt;gprs[15]	= new_stackp;					\</span>
<span class="cp">	crst_table_downgrade(current-&gt;mm, 1UL &lt;&lt; 31);			\</span>
<span class="cp">} while (0)</span>

<span class="cm">/* Forward declaration, a strange C thing */</span>
<span class="k">struct</span> <span class="n">task_struct</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">mm_struct</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">seq_file</span><span class="p">;</span>

<span class="cm">/* Free all resources held by a thread. */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">release_thread</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">kernel_thread</span><span class="p">(</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span> <span class="n">arg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Return saved PC of a blocked thread.</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">thread_saved_pc</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">t</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">show_code</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">get_wchan</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
<span class="cp">#define task_pt_regs(tsk) ((struct pt_regs *) \</span>
<span class="cp">        (task_stack_page(tsk) + THREAD_SIZE) - 1)</span>
<span class="cp">#define KSTK_EIP(tsk)	(task_pt_regs(tsk)-&gt;psw.addr)</span>
<span class="cp">#define KSTK_ESP(tsk)	(task_pt_regs(tsk)-&gt;gprs[15])</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">stap</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">cpu_address</span><span class="p">;</span>

	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;stap %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=m&quot;</span> <span class="p">(</span><span class="n">cpu_address</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">cpu_address</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Give up the time slice of the virtual PU.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cpu_relax</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MACHINE_HAS_DIAG44</span><span class="p">)</span>
		<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;diag 0,0,68&quot;</span><span class="p">);</span>
	<span class="n">barrier</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">psw_set_key</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;spka 0(%0)&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;d&quot;</span> <span class="p">(</span><span class="n">key</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set PSW to specified value.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__load_psw</span><span class="p">(</span><span class="n">psw_t</span> <span class="n">psw</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef CONFIG_64BIT</span>
	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;lpsw  %0&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;Q&quot;</span> <span class="p">(</span><span class="n">psw</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;cc&quot;</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;lpswe %0&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;Q&quot;</span> <span class="p">(</span><span class="n">psw</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;cc&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set PSW mask to specified value, while leaving the</span>
<span class="cm"> * PSW addr pointing to the next instruction.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__load_psw_mask</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">psw_t</span> <span class="n">psw</span><span class="p">;</span>

	<span class="n">psw</span><span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>

<span class="cp">#ifndef CONFIG_64BIT</span>
	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span>
		<span class="s">&quot;	basr	%0,0</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;0:	ahi	%0,1f-0b</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	st	%0,%O1+4(%R1)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lpsw	%1</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;1:&quot;</span>
		<span class="o">:</span> <span class="s">&quot;=&amp;d&quot;</span> <span class="p">(</span><span class="n">addr</span><span class="p">),</span> <span class="s">&quot;=Q&quot;</span> <span class="p">(</span><span class="n">psw</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;Q&quot;</span> <span class="p">(</span><span class="n">psw</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;memory&quot;</span><span class="p">,</span> <span class="s">&quot;cc&quot;</span><span class="p">);</span>
<span class="cp">#else </span><span class="cm">/* CONFIG_64BIT */</span><span class="cp"></span>
	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span>
		<span class="s">&quot;	larl	%0,1f</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	stg	%0,%O1+8(%R1)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lpswe	%1</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;1:&quot;</span>
		<span class="o">:</span> <span class="s">&quot;=&amp;d&quot;</span> <span class="p">(</span><span class="n">addr</span><span class="p">),</span> <span class="s">&quot;=Q&quot;</span> <span class="p">(</span><span class="n">psw</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;Q&quot;</span> <span class="p">(</span><span class="n">psw</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;memory&quot;</span><span class="p">,</span> <span class="s">&quot;cc&quot;</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_64BIT */</span><span class="cp"></span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Rewind PSW instruction address by specified number of bytes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">__rewind_psw</span><span class="p">(</span><span class="n">psw_t</span> <span class="n">psw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ilc</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef CONFIG_64BIT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psw</span><span class="p">.</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="n">PSW_ADDR_AMODE</span><span class="p">)</span>
		<span class="cm">/* 31 bit mode */</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">psw</span><span class="p">.</span><span class="n">addr</span> <span class="o">-</span> <span class="n">ilc</span><span class="p">)</span> <span class="o">|</span> <span class="n">PSW_ADDR_AMODE</span><span class="p">;</span>
	<span class="cm">/* 24 bit mode */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">psw</span><span class="p">.</span><span class="n">addr</span> <span class="o">-</span> <span class="n">ilc</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">psw</span><span class="p">.</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">PSW_MASK_EA</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1UL</span> <span class="o">:</span>
	       <span class="p">(</span><span class="n">psw</span><span class="p">.</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">PSW_MASK_BA</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span>
					  <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">psw</span><span class="p">.</span><span class="n">addr</span> <span class="o">-</span> <span class="n">ilc</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>
 
<span class="cm">/*</span>
<span class="cm"> * Function to drop a processor into disabled wait state</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">__noreturn</span> <span class="nf">disabled_wait</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ctl_buf</span><span class="p">;</span>
        <span class="n">psw_t</span> <span class="n">dw_psw</span><span class="p">;</span>

	<span class="n">dw_psw</span><span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">PSW_MASK_BASE</span> <span class="o">|</span> <span class="n">PSW_MASK_WAIT</span> <span class="o">|</span> <span class="n">PSW_MASK_BA</span> <span class="o">|</span> <span class="n">PSW_MASK_EA</span><span class="p">;</span>
        <span class="n">dw_psw</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">code</span><span class="p">;</span>
        <span class="cm">/* </span>
<span class="cm">         * Store status and then load disabled wait psw,</span>
<span class="cm">         * the processor is dead afterwards</span>
<span class="cm">         */</span>
<span class="cp">#ifndef CONFIG_64BIT</span>
	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span>
		<span class="s">&quot;	stctl	0,0,0(%2)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	ni	0(%2),0xef</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/* switch off protection */</span>
		<span class="s">&quot;	lctl	0,0,0(%2)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	stpt	0xd8</span><span class="se">\n</span><span class="s">&quot;</span>		<span class="cm">/* store timer */</span>
		<span class="s">&quot;	stckc	0xe0</span><span class="se">\n</span><span class="s">&quot;</span>		<span class="cm">/* store clock comparator */</span>
		<span class="s">&quot;	stpx	0x108</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/* store prefix register */</span>
		<span class="s">&quot;	stam	0,15,0x120</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/* store access registers */</span>
		<span class="s">&quot;	std	0,0x160</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/* store f0 */</span>
		<span class="s">&quot;	std	2,0x168</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/* store f2 */</span>
		<span class="s">&quot;	std	4,0x170</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/* store f4 */</span>
		<span class="s">&quot;	std	6,0x178</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/* store f6 */</span>
		<span class="s">&quot;	stm	0,15,0x180</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/* store general registers */</span>
		<span class="s">&quot;	stctl	0,15,0x1c0</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/* store control registers */</span>
		<span class="s">&quot;	oi	0x1c0,0x10</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/* fake protection bit */</span>
		<span class="s">&quot;	lpsw	0(%1)&quot;</span>
		<span class="o">:</span> <span class="s">&quot;=m&quot;</span> <span class="p">(</span><span class="n">ctl_buf</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dw_psw</span><span class="p">),</span> <span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_buf</span><span class="p">),</span> <span class="s">&quot;m&quot;</span> <span class="p">(</span><span class="n">dw_psw</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;cc&quot;</span><span class="p">);</span>
<span class="cp">#else </span><span class="cm">/* CONFIG_64BIT */</span><span class="cp"></span>
	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span>
		<span class="s">&quot;	stctg	0,0,0(%2)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	ni	4(%2),0xef</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/* switch off protection */</span>
		<span class="s">&quot;	lctlg	0,0,0(%2)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lghi	1,0x1000</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	stpt	0x328(1)</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/* store timer */</span>
		<span class="s">&quot;	stckc	0x330(1)</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/* store clock comparator */</span>
		<span class="s">&quot;	stpx	0x318(1)</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/* store prefix register */</span>
		<span class="s">&quot;	stam	0,15,0x340(1)</span><span class="se">\n</span><span class="s">&quot;</span><span class="cm">/* store access registers */</span>
		<span class="s">&quot;	stfpc	0x31c(1)</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/* store fpu control */</span>
		<span class="s">&quot;	std	0,0x200(1)</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/* store f0 */</span>
		<span class="s">&quot;	std	1,0x208(1)</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/* store f1 */</span>
		<span class="s">&quot;	std	2,0x210(1)</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/* store f2 */</span>
		<span class="s">&quot;	std	3,0x218(1)</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/* store f3 */</span>
		<span class="s">&quot;	std	4,0x220(1)</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/* store f4 */</span>
		<span class="s">&quot;	std	5,0x228(1)</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/* store f5 */</span>
		<span class="s">&quot;	std	6,0x230(1)</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/* store f6 */</span>
		<span class="s">&quot;	std	7,0x238(1)</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/* store f7 */</span>
		<span class="s">&quot;	std	8,0x240(1)</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/* store f8 */</span>
		<span class="s">&quot;	std	9,0x248(1)</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/* store f9 */</span>
		<span class="s">&quot;	std	10,0x250(1)</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/* store f10 */</span>
		<span class="s">&quot;	std	11,0x258(1)</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/* store f11 */</span>
		<span class="s">&quot;	std	12,0x260(1)</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/* store f12 */</span>
		<span class="s">&quot;	std	13,0x268(1)</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/* store f13 */</span>
		<span class="s">&quot;	std	14,0x270(1)</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/* store f14 */</span>
		<span class="s">&quot;	std	15,0x278(1)</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/* store f15 */</span>
		<span class="s">&quot;	stmg	0,15,0x280(1)</span><span class="se">\n</span><span class="s">&quot;</span><span class="cm">/* store general registers */</span>
		<span class="s">&quot;	stctg	0,15,0x380(1)</span><span class="se">\n</span><span class="s">&quot;</span><span class="cm">/* store control registers */</span>
		<span class="s">&quot;	oi	0x384(1),0x10</span><span class="se">\n</span><span class="s">&quot;</span><span class="cm">/* fake protection bit */</span>
		<span class="s">&quot;	lpswe	0(%1)&quot;</span>
		<span class="o">:</span> <span class="s">&quot;=m&quot;</span> <span class="p">(</span><span class="n">ctl_buf</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dw_psw</span><span class="p">),</span> <span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_buf</span><span class="p">),</span> <span class="s">&quot;m&quot;</span> <span class="p">(</span><span class="n">dw_psw</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;cc&quot;</span><span class="p">,</span> <span class="s">&quot;0&quot;</span><span class="p">,</span> <span class="s">&quot;1&quot;</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_64BIT */</span><span class="cp"></span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Use to set psw mask except for the first byte which</span>
<span class="cm"> * won&#39;t be changed by this function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">__set_psw_mask</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__load_psw_mask</span><span class="p">(</span><span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">arch_local_save_flags</span><span class="p">()</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="o">-</span><span class="mi">1UL</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)));</span>
<span class="p">}</span>

<span class="cp">#define local_mcck_enable() \</span>
<span class="cp">	__set_psw_mask(psw_kernel_bits | PSW_MASK_DAT | PSW_MASK_MCHECK)</span>
<span class="cp">#define local_mcck_disable() \</span>
<span class="cp">	__set_psw_mask(psw_kernel_bits | PSW_MASK_DAT)</span>

<span class="cm">/*</span>
<span class="cm"> * Basic Machine Check/Program Check Handler.</span>
<span class="cm"> */</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">s390_base_mcck_handler</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">s390_base_pgm_handler</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">s390_base_ext_handler</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">s390_base_mcck_handler_fn</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">s390_base_pgm_handler_fn</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">s390_base_ext_handler_fn</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>

<span class="cp">#define ARCH_LOW_ADDRESS_LIMIT	0x7fffffffUL</span>

<span class="cm">/*</span>
<span class="cm"> * Helper macro for exception table entries</span>
<span class="cm"> */</span>
<span class="cp">#ifndef CONFIG_64BIT</span>
<span class="cp">#define EX_TABLE(_fault,_target)			\</span>
<span class="cp">	&quot;.section __ex_table,\&quot;a\&quot;\n&quot;			\</span>
<span class="cp">	&quot;	.align 4\n&quot;				\</span>
<span class="cp">	&quot;	.long  &quot; #_fault &quot;,&quot; #_target &quot;\n&quot;	\</span>
<span class="cp">	&quot;.previous\n&quot;</span>
<span class="cp">#else</span>
<span class="cp">#define EX_TABLE(_fault,_target)			\</span>
<span class="cp">	&quot;.section __ex_table,\&quot;a\&quot;\n&quot;			\</span>
<span class="cp">	&quot;	.align 8\n&quot;				\</span>
<span class="cp">	&quot;	.quad  &quot; #_fault &quot;,&quot; #_target &quot;\n&quot;	\</span>
<span class="cp">	&quot;.previous\n&quot;</span>
<span class="cp">#endif</span>

<span class="cp">#endif                                 </span><span class="cm">/* __ASM_S390_PROCESSOR_H           */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
