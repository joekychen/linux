<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › s390 › include › asm › percpu.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>percpu.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef __ARCH_S390_PERCPU__</span>
<span class="cp">#define __ARCH_S390_PERCPU__</span>

<span class="cp">#include &lt;linux/preempt.h&gt;</span>
<span class="cp">#include &lt;asm/cmpxchg.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * s390 uses its own implementation for per cpu data, the offset of</span>
<span class="cm"> * the cpu local data area is cached in the cpu&#39;s lowcore memory.</span>
<span class="cm"> */</span>
<span class="cp">#define __my_cpu_offset S390_lowcore.percpu_offset</span>

<span class="cm">/*</span>
<span class="cm"> * For 64 bit module code, the module may be more than 4G above the</span>
<span class="cm"> * per cpu area, use weak definitions to force the compiler to</span>
<span class="cm"> * generate external references.</span>
<span class="cm"> */</span>
<span class="cp">#if defined(CONFIG_SMP) &amp;&amp; defined(CONFIG_64BIT) &amp;&amp; defined(MODULE)</span>
<span class="cp">#define ARCH_NEEDS_WEAK_PER_CPU</span>
<span class="cp">#endif</span>

<span class="cp">#define arch_this_cpu_to_op(pcp, val, op)				\</span>
<span class="cp">do {									\</span>
<span class="cp">	typedef typeof(pcp) pcp_op_T__;					\</span>
<span class="cp">	pcp_op_T__ old__, new__, prev__;				\</span>
<span class="cp">	pcp_op_T__ *ptr__;						\</span>
<span class="cp">	preempt_disable();						\</span>
<span class="cp">	ptr__ = __this_cpu_ptr(&amp;(pcp));					\</span>
<span class="cp">	prev__ = *ptr__;						\</span>
<span class="cp">	do {								\</span>
<span class="cp">		old__ = prev__;						\</span>
<span class="cp">		new__ = old__ op (val);					\</span>
<span class="cp">		switch (sizeof(*ptr__)) {				\</span>
<span class="cp">		case 8:							\</span>
<span class="cp">			prev__ = cmpxchg64(ptr__, old__, new__);	\</span>
<span class="cp">			break;						\</span>
<span class="cp">		default:						\</span>
<span class="cp">			prev__ = cmpxchg(ptr__, old__, new__);		\</span>
<span class="cp">		}							\</span>
<span class="cp">	} while (prev__ != old__);					\</span>
<span class="cp">	preempt_enable();						\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define this_cpu_add_1(pcp, val) arch_this_cpu_to_op(pcp, val, +)</span>
<span class="cp">#define this_cpu_add_2(pcp, val) arch_this_cpu_to_op(pcp, val, +)</span>
<span class="cp">#define this_cpu_add_4(pcp, val) arch_this_cpu_to_op(pcp, val, +)</span>
<span class="cp">#define this_cpu_add_8(pcp, val) arch_this_cpu_to_op(pcp, val, +)</span>

<span class="cp">#define this_cpu_and_1(pcp, val) arch_this_cpu_to_op(pcp, val, &amp;)</span>
<span class="cp">#define this_cpu_and_2(pcp, val) arch_this_cpu_to_op(pcp, val, &amp;)</span>
<span class="cp">#define this_cpu_and_4(pcp, val) arch_this_cpu_to_op(pcp, val, &amp;)</span>
<span class="cp">#define this_cpu_and_8(pcp, val) arch_this_cpu_to_op(pcp, val, &amp;)</span>

<span class="cp">#define this_cpu_or_1(pcp, val) arch_this_cpu_to_op(pcp, val, |)</span>
<span class="cp">#define this_cpu_or_2(pcp, val) arch_this_cpu_to_op(pcp, val, |)</span>
<span class="cp">#define this_cpu_or_4(pcp, val) arch_this_cpu_to_op(pcp, val, |)</span>
<span class="cp">#define this_cpu_or_8(pcp, val) arch_this_cpu_to_op(pcp, val, |)</span>

<span class="cp">#define this_cpu_xor_1(pcp, val) arch_this_cpu_to_op(pcp, val, ^)</span>
<span class="cp">#define this_cpu_xor_2(pcp, val) arch_this_cpu_to_op(pcp, val, ^)</span>
<span class="cp">#define this_cpu_xor_4(pcp, val) arch_this_cpu_to_op(pcp, val, ^)</span>
<span class="cp">#define this_cpu_xor_8(pcp, val) arch_this_cpu_to_op(pcp, val, ^)</span>

<span class="cp">#define arch_this_cpu_cmpxchg(pcp, oval, nval)			\</span>
<span class="cp">({									\</span>
<span class="cp">	typedef typeof(pcp) pcp_op_T__;					\</span>
<span class="cp">	pcp_op_T__ ret__;						\</span>
<span class="cp">	pcp_op_T__ *ptr__;						\</span>
<span class="cp">	preempt_disable();						\</span>
<span class="cp">	ptr__ = __this_cpu_ptr(&amp;(pcp));					\</span>
<span class="cp">	switch (sizeof(*ptr__)) {					\</span>
<span class="cp">	case 8:								\</span>
<span class="cp">		ret__ = cmpxchg64(ptr__, oval, nval);			\</span>
<span class="cp">		break;							\</span>
<span class="cp">	default:							\</span>
<span class="cp">		ret__ = cmpxchg(ptr__, oval, nval);			\</span>
<span class="cp">	}								\</span>
<span class="cp">	preempt_enable();						\</span>
<span class="cp">	ret__;								\</span>
<span class="cp">})</span>

<span class="cp">#define this_cpu_cmpxchg_1(pcp, oval, nval) arch_this_cpu_cmpxchg(pcp, oval, nval)</span>
<span class="cp">#define this_cpu_cmpxchg_2(pcp, oval, nval) arch_this_cpu_cmpxchg(pcp, oval, nval)</span>
<span class="cp">#define this_cpu_cmpxchg_4(pcp, oval, nval) arch_this_cpu_cmpxchg(pcp, oval, nval)</span>
<span class="cp">#define this_cpu_cmpxchg_8(pcp, oval, nval) arch_this_cpu_cmpxchg(pcp, oval, nval)</span>

<span class="cp">#include &lt;asm-generic/percpu.h&gt;</span>

<span class="cp">#endif </span><span class="cm">/* __ARCH_S390_PERCPU__ */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
