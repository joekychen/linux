<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › unicore32 › kernel › clock.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>clock.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/arch/unicore32/kernel/clock.c</span>
<span class="cm"> *</span>
<span class="cm"> * Code specific to PKUnity SoC and UniCore ISA</span>
<span class="cm"> *</span>
<span class="cm"> *	Maintained by GUAN Xue-tao &lt;gxt@mprc.pku.edu.cn&gt;</span>
<span class="cm"> *	Copyright (C) 2001-2010 Guan Xuetao</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>

<span class="cp">#include &lt;mach/hardware.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * Very simple clock implementation</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">clk</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">node</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">rate</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_ost_clk</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;OST_CLK&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate</span>		<span class="o">=</span> <span class="n">CLOCK_TICK_RATE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_mclk_clk</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;MAIN_CLK&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_bclk32_clk</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;BUS32_CLK&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_ddr_clk</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;DDR_CLK&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">clk_vga_clk</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;VGA_CLK&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">clocks</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">clocks_mutex</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="nf">clk_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">clk</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOENT</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clocks_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clocks</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clk</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clocks_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">clk</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">clk_get</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">clk_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">clk_put</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">clk_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">clk_enable</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">clk_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">clk_disable</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">clk_get_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">clk_get_rate</span><span class="p">);</span>

<span class="k">struct</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">div</span><span class="p">;</span>
<span class="p">}</span> <span class="n">vga_clk_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{.</span><span class="n">rate</span> <span class="o">=</span>  <span class="mi">25175000</span><span class="p">,</span> <span class="p">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="mh">0x00002001</span><span class="p">,</span> <span class="p">.</span><span class="n">div</span> <span class="o">=</span> <span class="mh">0x9</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">rate</span> <span class="o">=</span>  <span class="mi">31500000</span><span class="p">,</span> <span class="p">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="mh">0x00002001</span><span class="p">,</span> <span class="p">.</span><span class="n">div</span> <span class="o">=</span> <span class="mh">0x7</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">rate</span> <span class="o">=</span>  <span class="mi">40000000</span><span class="p">,</span> <span class="p">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="mh">0x00003801</span><span class="p">,</span> <span class="p">.</span><span class="n">div</span> <span class="o">=</span> <span class="mh">0x9</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">rate</span> <span class="o">=</span>  <span class="mi">49500000</span><span class="p">,</span> <span class="p">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="mh">0x00003801</span><span class="p">,</span> <span class="p">.</span><span class="n">div</span> <span class="o">=</span> <span class="mh">0x7</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">rate</span> <span class="o">=</span>  <span class="mi">65000000</span><span class="p">,</span> <span class="p">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="mh">0x00002c01</span><span class="p">,</span> <span class="p">.</span><span class="n">div</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">rate</span> <span class="o">=</span>  <span class="mi">78750000</span><span class="p">,</span> <span class="p">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="mh">0x00002400</span><span class="p">,</span> <span class="p">.</span><span class="n">div</span> <span class="o">=</span> <span class="mh">0x7</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">108000000</span><span class="p">,</span> <span class="p">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="mh">0x00002c01</span><span class="p">,</span> <span class="p">.</span><span class="n">div</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">106500000</span><span class="p">,</span> <span class="p">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="mh">0x00003c01</span><span class="p">,</span> <span class="p">.</span><span class="n">div</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">rate</span> <span class="o">=</span>  <span class="mi">50650000</span><span class="p">,</span> <span class="p">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="mh">0x00106400</span><span class="p">,</span> <span class="p">.</span><span class="n">div</span> <span class="o">=</span> <span class="mh">0x9</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">rate</span> <span class="o">=</span>  <span class="mi">61500000</span><span class="p">,</span> <span class="p">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="mh">0x00106400</span><span class="p">,</span> <span class="p">.</span><span class="n">div</span> <span class="o">=</span> <span class="mh">0xa</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">rate</span> <span class="o">=</span>  <span class="mi">85500000</span><span class="p">,</span> <span class="p">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="mh">0x00002800</span><span class="p">,</span> <span class="p">.</span><span class="n">div</span> <span class="o">=</span> <span class="mh">0x6</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mrate</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">prate</span><span class="p">;</span>
<span class="p">}</span> <span class="n">mclk_clk_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{.</span><span class="n">mrate</span> <span class="o">=</span> <span class="mi">500000000</span><span class="p">,</span> <span class="p">.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00109801</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">mrate</span> <span class="o">=</span> <span class="mi">525000000</span><span class="p">,</span> <span class="p">.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00104C00</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">mrate</span> <span class="o">=</span> <span class="mi">550000000</span><span class="p">,</span> <span class="p">.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00105000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">mrate</span> <span class="o">=</span> <span class="mi">575000000</span><span class="p">,</span> <span class="p">.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00105400</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">mrate</span> <span class="o">=</span> <span class="mi">600000000</span><span class="p">,</span> <span class="p">.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00105800</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">mrate</span> <span class="o">=</span> <span class="mi">625000000</span><span class="p">,</span> <span class="p">.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00105C00</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">mrate</span> <span class="o">=</span> <span class="mi">650000000</span><span class="p">,</span> <span class="p">.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00106000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">mrate</span> <span class="o">=</span> <span class="mi">675000000</span><span class="p">,</span> <span class="p">.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00106400</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">mrate</span> <span class="o">=</span> <span class="mi">700000000</span><span class="p">,</span> <span class="p">.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00106800</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">mrate</span> <span class="o">=</span> <span class="mi">725000000</span><span class="p">,</span> <span class="p">.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00106C00</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">mrate</span> <span class="o">=</span> <span class="mi">750000000</span><span class="p">,</span> <span class="p">.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00107000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">mrate</span> <span class="o">=</span> <span class="mi">775000000</span><span class="p">,</span> <span class="p">.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00107400</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">mrate</span> <span class="o">=</span> <span class="mi">800000000</span><span class="p">,</span> <span class="p">.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00107800</span><span class="p">},</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">clk_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clk</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">clk_vga_clk</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pll_vgacfg</span><span class="p">,</span> <span class="n">pll_vgadiv</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

		<span class="cm">/* lookup vga_clk_table */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">vga_clk_table</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="n">vga_clk_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pll_vgacfg</span> <span class="o">=</span> <span class="n">vga_clk_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cfg</span><span class="p">;</span>
				<span class="n">pll_vgadiv</span> <span class="o">=</span> <span class="n">vga_clk_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">div</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">PM_PLLVGACFG</span><span class="p">)</span> <span class="o">==</span> <span class="n">pll_vgacfg</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* set pll vga cfg reg. */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">pll_vgacfg</span><span class="p">,</span> <span class="n">PM_PLLVGACFG</span><span class="p">);</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">PM_PMCR_CFBVGA</span><span class="p">,</span> <span class="n">PM_PMCR</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">PM_PLLDFCDONE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PM_PLLDFCDONE_VGADFC</span><span class="p">)</span>
				<span class="o">!=</span> <span class="n">PM_PLLDFCDONE_VGADFC</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span> <span class="cm">/* about 1ms */</span>

		<span class="cm">/* set div cfg reg. */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">PM_PCGR</span><span class="p">)</span> <span class="o">|</span> <span class="n">PM_PCGR_VGACLK</span><span class="p">,</span> <span class="n">PM_PCGR</span><span class="p">);</span>

		<span class="n">writel</span><span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">PM_DIVCFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PM_DIVCFG_VGACLK_MASK</span><span class="p">)</span>
				<span class="o">|</span> <span class="n">PM_DIVCFG_VGACLK</span><span class="p">(</span><span class="n">pll_vgadiv</span><span class="p">),</span> <span class="n">PM_DIVCFG</span><span class="p">);</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">PM_SWRESET</span><span class="p">)</span> <span class="o">|</span> <span class="n">PM_SWRESET_VGADIV</span><span class="p">,</span> <span class="n">PM_SWRESET</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">PM_SWRESET</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PM_SWRESET_VGADIV</span><span class="p">)</span>
				<span class="o">==</span> <span class="n">PM_SWRESET_VGADIV</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span> <span class="cm">/* 65536 bclk32, about 320us */</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">PM_PCGR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PM_PCGR_VGACLK</span><span class="p">,</span> <span class="n">PM_PCGR</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_CPU_FREQ</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clk</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">clk_mclk_clk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">pll_rate</span><span class="p">,</span> <span class="n">divstatus</span> <span class="o">=</span> <span class="n">PM_DIVSTATUS</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

		<span class="cm">/* lookup mclk_clk_table */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mclk_clk_table</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="n">mclk_clk_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mrate</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pll_rate</span> <span class="o">=</span> <span class="n">mclk_clk_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">prate</span><span class="p">;</span>
				<span class="n">clk_mclk_clk</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="n">mclk_clk_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mrate</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">clk_mclk_clk</span><span class="p">.</span><span class="n">rate</span><span class="p">)</span>
			<span class="n">clk_bclk32_clk</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="n">clk_mclk_clk</span><span class="p">.</span><span class="n">rate</span>
				<span class="o">/</span> <span class="p">(((</span><span class="n">divstatus</span> <span class="o">&amp;</span> <span class="mh">0x0000f000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* set pll sys cfg reg. */</span>
		<span class="n">PM_PLLSYSCFG</span> <span class="o">=</span> <span class="n">pll_rate</span><span class="p">;</span>

		<span class="n">PM_PMCR</span> <span class="o">=</span> <span class="n">PM_PMCR_CFBSYS</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">PM_PLLDFCDONE</span> <span class="o">&amp;</span> <span class="n">PM_PLLDFCDONE_SYSDFC</span><span class="p">)</span>
				<span class="o">!=</span> <span class="n">PM_PLLDFCDONE_SYSDFC</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
			<span class="cm">/* about 1ms */</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">clk_set_rate</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">clk_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clocks_mutex</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clocks</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clocks_mutex</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEFAULT</span> <span class="s">&quot;PKUnity PM: %s %lu.%02luM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">)</span><span class="o">/</span><span class="mi">1000000</span><span class="p">,</span> <span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">)</span><span class="o">/</span><span class="mi">10000</span> <span class="o">%</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">clk_register</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">clk_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clocks_mutex</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clocks_mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">clk_unregister</span><span class="p">);</span>

<span class="k">struct</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">prate</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate</span><span class="p">;</span>
<span class="p">}</span> <span class="n">pllrate_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00002001</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">250000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00104801</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">250000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00104C01</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">262500000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00002401</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">275000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00105001</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">275000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00105401</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">287500000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00002801</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">300000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00105801</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">300000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00105C01</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">312500000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00002C01</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">325000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00106001</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">325000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00106401</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">337500000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00003001</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">350000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00106801</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">350000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00106C01</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">362500000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00003401</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">375000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00107001</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">375000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00107401</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">387500000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00003801</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">400000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00107801</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">400000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00107C01</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">412500000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00003C01</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">425000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00108001</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">425000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00108401</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">437500000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00004001</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">450000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00108801</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">450000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00108C01</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">462500000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00004401</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">475000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00109001</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">475000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00109401</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">487500000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00004801</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">500000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00109801</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">500000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00104C00</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">525000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00002400</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">550000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00105000</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">550000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00105400</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">575000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00002800</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">600000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00105800</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">600000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00105C00</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">625000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00002C00</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">650000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00106000</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">650000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00106400</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">675000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00003000</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">700000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00106800</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">700000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00106C00</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">725000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00003400</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">750000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00107000</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">750000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00107400</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">775000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00003800</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">800000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00107800</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">800000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00107C00</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">825000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00003C00</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">850000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00108000</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">850000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00108400</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">875000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00004000</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">900000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00108800</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">900000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00108C00</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">925000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00004400</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">950000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00109000</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">950000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00109400</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">975000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00004800</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">1000000000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00109800</span><span class="p">,</span> <span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">1000000000</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">prate</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">drate</span><span class="p">;</span>
<span class="p">}</span> <span class="n">pddr_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00100800</span><span class="p">,</span> <span class="p">.</span><span class="n">drate</span> <span class="o">=</span> <span class="mi">44236800</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00100C00</span><span class="p">,</span> <span class="p">.</span><span class="n">drate</span> <span class="o">=</span> <span class="mi">66355200</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00101000</span><span class="p">,</span> <span class="p">.</span><span class="n">drate</span> <span class="o">=</span> <span class="mi">88473600</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00101400</span><span class="p">,</span> <span class="p">.</span><span class="n">drate</span> <span class="o">=</span> <span class="mi">110592000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00101800</span><span class="p">,</span> <span class="p">.</span><span class="n">drate</span> <span class="o">=</span> <span class="mi">132710400</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00101C01</span><span class="p">,</span> <span class="p">.</span><span class="n">drate</span> <span class="o">=</span> <span class="mi">154828800</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00102001</span><span class="p">,</span> <span class="p">.</span><span class="n">drate</span> <span class="o">=</span> <span class="mi">176947200</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00102401</span><span class="p">,</span> <span class="p">.</span><span class="n">drate</span> <span class="o">=</span> <span class="mi">199065600</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00102801</span><span class="p">,</span> <span class="p">.</span><span class="n">drate</span> <span class="o">=</span> <span class="mi">221184000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00102C01</span><span class="p">,</span> <span class="p">.</span><span class="n">drate</span> <span class="o">=</span> <span class="mi">243302400</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00103001</span><span class="p">,</span> <span class="p">.</span><span class="n">drate</span> <span class="o">=</span> <span class="mi">265420800</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00103401</span><span class="p">,</span> <span class="p">.</span><span class="n">drate</span> <span class="o">=</span> <span class="mi">287539200</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00103801</span><span class="p">,</span> <span class="p">.</span><span class="n">drate</span> <span class="o">=</span> <span class="mi">309657600</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00103C01</span><span class="p">,</span> <span class="p">.</span><span class="n">drate</span> <span class="o">=</span> <span class="mi">331776000</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">prate</span> <span class="o">=</span> <span class="mh">0x00104001</span><span class="p">,</span> <span class="p">.</span><span class="n">drate</span> <span class="o">=</span> <span class="mi">353894400</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">clk_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_PUV3_PM</span>
	<span class="n">u32</span> <span class="n">pllrate</span><span class="p">,</span> <span class="n">divstatus</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">PM_DIVSTATUS</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">pcgr_val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">PM_PCGR</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pcgr_val</span> <span class="o">|=</span> <span class="n">PM_PCGR_BCLKMME</span> <span class="o">|</span> <span class="n">PM_PCGR_BCLKH264E</span> <span class="o">|</span> <span class="n">PM_PCGR_BCLKH264D</span>
			<span class="o">|</span> <span class="n">PM_PCGR_HECLK</span> <span class="o">|</span> <span class="n">PM_PCGR_HDCLK</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">pcgr_val</span><span class="p">,</span> <span class="n">PM_PCGR</span><span class="p">);</span>

	<span class="n">pllrate</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">PM_PLLSYSSTATUS</span><span class="p">);</span>

	<span class="cm">/* lookup pmclk_table */</span>
	<span class="n">clk_mclk_clk</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pllrate_table</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pllrate</span> <span class="o">==</span> <span class="n">pllrate_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">prate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clk_mclk_clk</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="n">pllrate_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rate</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clk_mclk_clk</span><span class="p">.</span><span class="n">rate</span><span class="p">)</span>
		<span class="n">clk_bclk32_clk</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="n">clk_mclk_clk</span><span class="p">.</span><span class="n">rate</span> <span class="o">/</span>
			<span class="p">(((</span><span class="n">divstatus</span> <span class="o">&amp;</span> <span class="mh">0x0000f000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">pllrate</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">PM_PLLDDRSTATUS</span><span class="p">);</span>

	<span class="cm">/* lookup pddr_table */</span>
	<span class="n">clk_ddr_clk</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pddr_table</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pllrate</span> <span class="o">==</span> <span class="n">pddr_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">prate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clk_ddr_clk</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="n">pddr_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">drate</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">pllrate</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">PM_PLLVGASTATUS</span><span class="p">);</span>

	<span class="cm">/* lookup pvga_table */</span>
	<span class="n">clk_vga_clk</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pllrate_table</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pllrate</span> <span class="o">==</span> <span class="n">pllrate_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">prate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clk_vga_clk</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="n">pllrate_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rate</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clk_vga_clk</span><span class="p">.</span><span class="n">rate</span><span class="p">)</span>
		<span class="n">clk_vga_clk</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="n">clk_vga_clk</span><span class="p">.</span><span class="n">rate</span> <span class="o">/</span>
			<span class="p">(((</span><span class="n">divstatus</span> <span class="o">&amp;</span> <span class="mh">0x00f00000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">clk_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clk_vga_clk</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ARCH_FPGA</span>
	<span class="n">clk_ddr_clk</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">33000000</span><span class="p">;</span>
	<span class="n">clk_mclk_clk</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">33000000</span><span class="p">;</span>
	<span class="n">clk_bclk32_clk</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">33000000</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">clk_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clk_ddr_clk</span><span class="p">);</span>
	<span class="n">clk_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clk_mclk_clk</span><span class="p">);</span>
	<span class="n">clk_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clk_bclk32_clk</span><span class="p">);</span>
	<span class="n">clk_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clk_ost_clk</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">core_initcall</span><span class="p">(</span><span class="n">clk_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
