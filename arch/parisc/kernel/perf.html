<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › parisc › kernel › perf.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>perf.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Parisc performance counters</span>
<span class="cm"> *  Copyright (C) 2001 Randolph Chung &lt;tausq@debian.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This code is derived, with permission, from HP/UX sources.</span>
<span class="cm"> *</span>
<span class="cm"> *    This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *    it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *    the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm"> *    any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *    This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *    GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *    You should have received a copy of the GNU General Public License</span>
<span class="cm"> *    along with this program; if not, write to the Free Software</span>
<span class="cm"> *    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *  Edited comment from original sources:</span>
<span class="cm"> *</span>
<span class="cm"> *  This driver programs the PCX-U/PCX-W performance counters</span>
<span class="cm"> *  on the PA-RISC 2.0 chips.  The driver keeps all images now</span>
<span class="cm"> *  internally to the kernel to hopefully eliminate the possibility</span>
<span class="cm"> *  of a bad image halting the CPU.  Also, there are different</span>
<span class="cm"> *  images for the PCX-W and later chips vs the PCX-U chips.</span>
<span class="cm"> *</span>
<span class="cm"> *  Only 1 process is allowed to access the driver at any time,</span>
<span class="cm"> *  so the only protection that is needed is at open and close.</span>
<span class="cm"> *  A variable &quot;perf_enabled&quot; is used to hold the state of the</span>
<span class="cm"> *  driver.  The spinlock &quot;perf_lock&quot; is used to protect the</span>
<span class="cm"> *  modification of the state during open/close operations so</span>
<span class="cm"> *  multiple processes don&#39;t get into the driver simultaneously.</span>
<span class="cm"> *</span>
<span class="cm"> *  This driver accesses the processor directly vs going through</span>
<span class="cm"> *  the PDC INTRIGUE calls.  This is done to eliminate bugs introduced</span>
<span class="cm"> *  in various PDC revisions.  The code is much more maintainable</span>
<span class="cm"> *  and reliable this way vs having to debug on every version of PDC</span>
<span class="cm"> *  on every box. </span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/capability.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/miscdevice.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/perf.h&gt;</span>
<span class="cp">#include &lt;asm/parisc-device.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;</span>
<span class="cp">#include &lt;asm/runway.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;		</span><span class="cm">/* for __raw_read() */</span><span class="cp"></span>

<span class="cp">#include &quot;perf_images.h&quot;</span>

<span class="cp">#define MAX_RDR_WORDS	24</span>
<span class="cp">#define PERF_VERSION	2	</span><span class="cm">/* derived from hpux&#39;s PI v2 interface */</span><span class="cp"></span>

<span class="cm">/* definition of RDR regs */</span>
<span class="k">struct</span> <span class="n">rdr_tbl_ent</span> <span class="p">{</span>
	<span class="kt">uint16_t</span>	<span class="n">width</span><span class="p">;</span>
	<span class="kt">uint8_t</span>		<span class="n">num_words</span><span class="p">;</span>
	<span class="kt">uint8_t</span>		<span class="n">write_control</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">perf_processor_interface</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="n">UNKNOWN_INTF</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">perf_enabled</span> <span class="n">__read_mostly</span><span class="p">;</span>
<span class="k">static</span> <span class="n">spinlock_t</span> <span class="n">perf_lock</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">parisc_device</span> <span class="o">*</span><span class="n">cpu_device</span> <span class="n">__read_mostly</span><span class="p">;</span>

<span class="cm">/* RDRs to write for PCX-W */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">perf_rdrs_W</span><span class="p">[]</span> <span class="o">=</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">};</span>

<span class="cm">/* RDRs to write for PCX-U */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">perf_rdrs_U</span><span class="p">[]</span> <span class="o">=</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">};</span>

<span class="cm">/* RDR register descriptions for PCX-W */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rdr_tbl_ent</span> <span class="n">perf_rdr_tbl_W</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">19</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">8</span> <span class="p">},</span>   <span class="cm">/* RDR 0 */</span>
	<span class="p">{</span> <span class="mi">16</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">16</span> <span class="p">},</span>  <span class="cm">/* RDR 1 */</span>
	<span class="p">{</span> <span class="mi">72</span><span class="p">,</span>	<span class="mi">2</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>   <span class="cm">/* RDR 2 */</span>
	<span class="p">{</span> <span class="mi">81</span><span class="p">,</span>	<span class="mi">2</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>   <span class="cm">/* RDR 3 */</span>
	<span class="p">{</span> <span class="mi">328</span><span class="p">,</span>	<span class="mi">6</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>   <span class="cm">/* RDR 4 */</span>
	<span class="p">{</span> <span class="mi">160</span><span class="p">,</span>	<span class="mi">3</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>   <span class="cm">/* RDR 5 */</span>
	<span class="p">{</span> <span class="mi">336</span><span class="p">,</span>	<span class="mi">6</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>   <span class="cm">/* RDR 6 */</span>
	<span class="p">{</span> <span class="mi">164</span><span class="p">,</span>	<span class="mi">3</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>   <span class="cm">/* RDR 7 */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>   <span class="cm">/* RDR 8 */</span>
	<span class="p">{</span> <span class="mi">35</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>   <span class="cm">/* RDR 9 */</span>
	<span class="p">{</span> <span class="mi">6</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>   <span class="cm">/* RDR 10 */</span>
	<span class="p">{</span> <span class="mi">18</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>   <span class="cm">/* RDR 11 */</span>
	<span class="p">{</span> <span class="mi">13</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>   <span class="cm">/* RDR 12 */</span>
	<span class="p">{</span> <span class="mi">8</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>   <span class="cm">/* RDR 13 */</span>
	<span class="p">{</span> <span class="mi">8</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>   <span class="cm">/* RDR 14 */</span>
	<span class="p">{</span> <span class="mi">8</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>   <span class="cm">/* RDR 15 */</span>
	<span class="p">{</span> <span class="mi">1530</span><span class="p">,</span>	<span class="mi">24</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>   <span class="cm">/* RDR 16 */</span>
	<span class="p">{</span> <span class="mi">16</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>   <span class="cm">/* RDR 17 */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>   <span class="cm">/* RDR 18 */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>   <span class="cm">/* RDR 19 */</span>
	<span class="p">{</span> <span class="mi">152</span><span class="p">,</span>	<span class="mi">3</span><span class="p">,</span>	<span class="mi">24</span> <span class="p">},</span>  <span class="cm">/* RDR 20 */</span>
	<span class="p">{</span> <span class="mi">152</span><span class="p">,</span>	<span class="mi">3</span><span class="p">,</span>	<span class="mi">24</span> <span class="p">},</span>  <span class="cm">/* RDR 21 */</span>
	<span class="p">{</span> <span class="mi">233</span><span class="p">,</span>	<span class="mi">4</span><span class="p">,</span>	<span class="mi">48</span> <span class="p">},</span>  <span class="cm">/* RDR 22 */</span>
	<span class="p">{</span> <span class="mi">233</span><span class="p">,</span>	<span class="mi">4</span><span class="p">,</span>	<span class="mi">48</span> <span class="p">},</span>  <span class="cm">/* RDR 23 */</span>
	<span class="p">{</span> <span class="mi">71</span><span class="p">,</span>	<span class="mi">2</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>   <span class="cm">/* RDR 24 */</span>
	<span class="p">{</span> <span class="mi">71</span><span class="p">,</span>	<span class="mi">2</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>   <span class="cm">/* RDR 25 */</span>
	<span class="p">{</span> <span class="mi">11</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>   <span class="cm">/* RDR 26 */</span>
	<span class="p">{</span> <span class="mi">18</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>   <span class="cm">/* RDR 27 */</span>
	<span class="p">{</span> <span class="mi">128</span><span class="p">,</span>	<span class="mi">2</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>   <span class="cm">/* RDR 28 */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>   <span class="cm">/* RDR 29 */</span>
	<span class="p">{</span> <span class="mi">16</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>   <span class="cm">/* RDR 30 */</span>
	<span class="p">{</span> <span class="mi">16</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>   <span class="cm">/* RDR 31 */</span>
<span class="p">};</span>

<span class="cm">/* RDR register descriptions for PCX-U */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rdr_tbl_ent</span> <span class="n">perf_rdr_tbl_U</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">19</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">8</span> <span class="p">},</span>              <span class="cm">/* RDR 0 */</span>
	<span class="p">{</span> <span class="mi">32</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">16</span> <span class="p">},</span>             <span class="cm">/* RDR 1 */</span>
	<span class="p">{</span> <span class="mi">20</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>              <span class="cm">/* RDR 2 */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>              <span class="cm">/* RDR 3 */</span>
	<span class="p">{</span> <span class="mi">344</span><span class="p">,</span>	<span class="mi">6</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>              <span class="cm">/* RDR 4 */</span>
	<span class="p">{</span> <span class="mi">176</span><span class="p">,</span>	<span class="mi">3</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>              <span class="cm">/* RDR 5 */</span>
	<span class="p">{</span> <span class="mi">336</span><span class="p">,</span>	<span class="mi">6</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>              <span class="cm">/* RDR 6 */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>              <span class="cm">/* RDR 7 */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>              <span class="cm">/* RDR 8 */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>              <span class="cm">/* RDR 9 */</span>
	<span class="p">{</span> <span class="mi">28</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>              <span class="cm">/* RDR 10 */</span>
	<span class="p">{</span> <span class="mi">33</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>              <span class="cm">/* RDR 11 */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>              <span class="cm">/* RDR 12 */</span>
	<span class="p">{</span> <span class="mi">230</span><span class="p">,</span>	<span class="mi">4</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>              <span class="cm">/* RDR 13 */</span>
	<span class="p">{</span> <span class="mi">32</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>              <span class="cm">/* RDR 14 */</span>
	<span class="p">{</span> <span class="mi">128</span><span class="p">,</span>	<span class="mi">2</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>              <span class="cm">/* RDR 15 */</span>
	<span class="p">{</span> <span class="mi">1494</span><span class="p">,</span>	<span class="mi">24</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>              <span class="cm">/* RDR 16 */</span>
	<span class="p">{</span> <span class="mi">18</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>              <span class="cm">/* RDR 17 */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>              <span class="cm">/* RDR 18 */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>              <span class="cm">/* RDR 19 */</span>
	<span class="p">{</span> <span class="mi">158</span><span class="p">,</span>	<span class="mi">3</span><span class="p">,</span>	<span class="mi">24</span> <span class="p">},</span>             <span class="cm">/* RDR 20 */</span>
	<span class="p">{</span> <span class="mi">158</span><span class="p">,</span>	<span class="mi">3</span><span class="p">,</span>	<span class="mi">24</span> <span class="p">},</span>             <span class="cm">/* RDR 21 */</span>
	<span class="p">{</span> <span class="mi">194</span><span class="p">,</span>	<span class="mi">4</span><span class="p">,</span>	<span class="mi">48</span> <span class="p">},</span>             <span class="cm">/* RDR 22 */</span>
	<span class="p">{</span> <span class="mi">194</span><span class="p">,</span>	<span class="mi">4</span><span class="p">,</span>	<span class="mi">48</span> <span class="p">},</span>             <span class="cm">/* RDR 23 */</span>
	<span class="p">{</span> <span class="mi">71</span><span class="p">,</span>	<span class="mi">2</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>              <span class="cm">/* RDR 24 */</span>
	<span class="p">{</span> <span class="mi">71</span><span class="p">,</span>	<span class="mi">2</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>              <span class="cm">/* RDR 25 */</span>
	<span class="p">{</span> <span class="mi">28</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>              <span class="cm">/* RDR 26 */</span>
	<span class="p">{</span> <span class="mi">33</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>              <span class="cm">/* RDR 27 */</span>
	<span class="p">{</span> <span class="mi">88</span><span class="p">,</span>	<span class="mi">2</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>              <span class="cm">/* RDR 28 */</span>
	<span class="p">{</span> <span class="mi">32</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>              <span class="cm">/* RDR 29 */</span>
	<span class="p">{</span> <span class="mi">24</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>              <span class="cm">/* RDR 30 */</span>
	<span class="p">{</span> <span class="mi">16</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>              <span class="cm">/* RDR 31 */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * A non-zero write_control in the above tables is a byte offset into</span>
<span class="cm"> * this array.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">perf_bitmasks</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x0000000000000000ul</span><span class="p">,</span>     <span class="cm">/* first dbl word must be zero */</span>
	<span class="mh">0xfdffe00000000000ul</span><span class="p">,</span>     <span class="cm">/* RDR0 bitmask */</span>
	<span class="mh">0x003f000000000000ul</span><span class="p">,</span>     <span class="cm">/* RDR1 bitmask */</span>
	<span class="mh">0x00fffffffffffffful</span><span class="p">,</span>     <span class="cm">/* RDR20-RDR21 bitmask (152 bits) */</span>
	<span class="mh">0xfffffffffffffffful</span><span class="p">,</span>
	<span class="mh">0xfffffffc00000000ul</span><span class="p">,</span>
	<span class="mh">0xfffffffffffffffful</span><span class="p">,</span>     <span class="cm">/* RDR22-RDR23 bitmask (233 bits) */</span>
	<span class="mh">0xfffffffffffffffful</span><span class="p">,</span>
	<span class="mh">0xfffffffffffffffcul</span><span class="p">,</span>
	<span class="mh">0xff00000000000000ul</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Write control bitmasks for Pa-8700 processor given</span>
<span class="cm"> * some things have changed slightly.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">perf_bitmasks_piranha</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x0000000000000000ul</span><span class="p">,</span>     <span class="cm">/* first dbl word must be zero */</span>
	<span class="mh">0xfdffe00000000000ul</span><span class="p">,</span>     <span class="cm">/* RDR0 bitmask */</span>
	<span class="mh">0x003f000000000000ul</span><span class="p">,</span>     <span class="cm">/* RDR1 bitmask */</span>
	<span class="mh">0x00fffffffffffffful</span><span class="p">,</span>     <span class="cm">/* RDR20-RDR21 bitmask (158 bits) */</span>
	<span class="mh">0xfffffffffffffffful</span><span class="p">,</span>
	<span class="mh">0xfffffffc00000000ul</span><span class="p">,</span>
	<span class="mh">0xfffffffffffffffful</span><span class="p">,</span>     <span class="cm">/* RDR22-RDR23 bitmask (210 bits) */</span>
	<span class="mh">0xfffffffffffffffful</span><span class="p">,</span>
	<span class="mh">0xfffffffffffffffful</span><span class="p">,</span>
	<span class="mh">0xfffc000000000000ul</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">bitmask_array</span><span class="p">;</span>   <span class="cm">/* array of bitmasks to use */</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> * Function Prototypes</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">perf_config</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="n">image_ptr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">perf_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">perf_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">perf_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">perf_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> 
	<span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">long</span> <span class="n">perf_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">perf_start_counters</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">perf_stop_counters</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="n">raddr</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rdr_tbl_ent</span> <span class="o">*</span> <span class="n">perf_rdr_get_entry</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">rdr_num</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">perf_rdr_read_ubuf</span><span class="p">(</span><span class="kt">uint32_t</span>	<span class="n">rdr_num</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">buffer</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">perf_rdr_clear</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">rdr_num</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">perf_write_image</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="n">memaddr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">perf_rdr_write</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">rdr_num</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">buffer</span><span class="p">);</span>

<span class="cm">/* External Assembly Routines */</span>
<span class="k">extern</span> <span class="kt">uint64_t</span> <span class="n">perf_rdr_shift_in_W</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">rdr_num</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">width</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">uint64_t</span> <span class="n">perf_rdr_shift_in_U</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">rdr_num</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">width</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">perf_rdr_shift_out_W</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">rdr_num</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">buffer</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">perf_rdr_shift_out_U</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">rdr_num</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">buffer</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">perf_intrigue_enable_perf_counters</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">perf_intrigue_disable_perf_counters</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> * Function Definitions</span>
<span class="cm"> *****************************************************************************/</span>


<span class="cm">/*</span>
<span class="cm"> * configure:</span>
<span class="cm"> *</span>
<span class="cm"> * Configure the cpu with a given data image.  First turn off the counters, </span>
<span class="cm"> * then download the image, then turn the counters back on.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">perf_config</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="n">image_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">error</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">raddr</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="cm">/* Stop the counters*/</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">perf_stop_counters</span><span class="p">(</span><span class="n">raddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;perf_config: perf_stop_counters = %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> 
	<span class="p">}</span>

<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Preparing to write image</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Write the image to the chip */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">perf_write_image</span><span class="p">((</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)</span><span class="n">image_ptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;perf_config: DOWNLOAD = %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> 
	<span class="p">}</span>

<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Preparing to start counters</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Start the counters */</span>
	<span class="n">perf_start_counters</span><span class="p">();</span>

	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Open the device and initialize all of its memory.  The device is only </span>
<span class="cm"> * opened once, but can be &quot;queried&quot; by multiple processes that know its</span>
<span class="cm"> * file descriptor.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">perf_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">perf_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">perf_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">perf_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">perf_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
 	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">perf_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Close the device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">perf_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">perf_lock</span><span class="p">);</span>
	<span class="n">perf_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">perf_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read does nothing for this driver</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">perf_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * write:</span>
<span class="cm"> *</span>
<span class="cm"> * This routine downloads the image to the chip.  It must be</span>
<span class="cm"> * called on the processor that the download should happen</span>
<span class="cm"> * on.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">perf_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> 
	<span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">image_size</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">image_type</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">interface_type</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">test</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">perf_processor_interface</span> <span class="o">==</span> <span class="n">ONYX_INTF</span><span class="p">)</span> 
		<span class="n">image_size</span> <span class="o">=</span> <span class="n">PCXU_IMAGE_SIZE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">perf_processor_interface</span> <span class="o">==</span> <span class="n">CUDA_INTF</span><span class="p">)</span> 
		<span class="n">image_size</span> <span class="o">=</span> <span class="n">PCXW_IMAGE_SIZE</span><span class="p">;</span>
	<span class="k">else</span> 
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">image_type</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> 
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Get the interface type and test type */</span>
   	<span class="n">interface_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">image_type</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">test</span>           <span class="o">=</span> <span class="p">(</span><span class="n">image_type</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>

	<span class="cm">/* Make sure everything makes sense */</span>

	<span class="cm">/* First check the machine type is correct for</span>
<span class="cm">	   the requested image */</span>
        <span class="k">if</span> <span class="p">(((</span><span class="n">perf_processor_interface</span> <span class="o">==</span> <span class="n">CUDA_INTF</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		       <span class="p">(</span><span class="n">interface_type</span> <span class="o">!=</span> <span class="n">CUDA_INTF</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">perf_processor_interface</span> <span class="o">==</span> <span class="n">ONYX_INTF</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	               <span class="p">(</span><span class="n">interface_type</span> <span class="o">!=</span> <span class="n">ONYX_INTF</span><span class="p">)))</span> 
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Next check to make sure the requested image</span>
<span class="cm">	   is valid */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">interface_type</span> <span class="o">==</span> <span class="n">CUDA_INTF</span><span class="p">)</span> <span class="o">&amp;&amp;</span> 
		       <span class="p">(</span><span class="n">test</span> <span class="o">&gt;=</span> <span class="n">MAX_CUDA_IMAGES</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">interface_type</span> <span class="o">==</span> <span class="n">ONYX_INTF</span><span class="p">)</span> <span class="o">&amp;&amp;</span> 
		       <span class="p">(</span><span class="n">test</span> <span class="o">&gt;=</span> <span class="n">MAX_ONYX_IMAGES</span><span class="p">)))</span> 
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Copy the image into the processor */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">interface_type</span> <span class="o">==</span> <span class="n">CUDA_INTF</span><span class="p">)</span> 
		<span class="k">return</span> <span class="n">perf_config</span><span class="p">(</span><span class="n">cuda_images</span><span class="p">[</span><span class="n">test</span><span class="p">]);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">perf_config</span><span class="p">(</span><span class="n">onyx_images</span><span class="p">[</span><span class="n">test</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Patch the images that need to know the IVA addresses.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">perf_patch_images</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if 0</span><span class="c"> /* FIXME!! */</span>
<span class="c">/* </span>
<span class="c"> * NOTE:  this routine is VERY specific to the current TLB image.</span>
<span class="c"> * If the image is changed, this routine might also need to be changed.</span>
<span class="c"> */</span>
<span class="c">	extern void $i_itlb_miss_2_0();</span>
<span class="c">	extern void $i_dtlb_miss_2_0();</span>
<span class="c">	extern void PA2_0_iva();</span>

<span class="c">	/* </span>
<span class="c">	 * We can only use the lower 32-bits, the upper 32-bits should be 0</span>
<span class="c">	 * anyway given this is in the kernel </span>
<span class="c">	 */</span>
<span class="c">	uint32_t itlb_addr  = (uint32_t)&amp;($i_itlb_miss_2_0);</span>
<span class="c">	uint32_t dtlb_addr  = (uint32_t)&amp;($i_dtlb_miss_2_0);</span>
<span class="c">	uint32_t IVAaddress = (uint32_t)&amp;PA2_0_iva;</span>

<span class="c">	if (perf_processor_interface == ONYX_INTF) {</span>
<span class="c">		/* clear last 2 bytes */</span>
<span class="c">		onyx_images[TLBMISS][15] &amp;= 0xffffff00;  </span>
<span class="c">		/* set 2 bytes */</span>
<span class="c">		onyx_images[TLBMISS][15] |= (0x000000ff&amp;((dtlb_addr) &gt;&gt; 24));</span>
<span class="c">		onyx_images[TLBMISS][16] = (dtlb_addr &lt;&lt; 8)&amp;0xffffff00;</span>
<span class="c">		onyx_images[TLBMISS][17] = itlb_addr;</span>

<span class="c">		/* clear last 2 bytes */</span>
<span class="c">		onyx_images[TLBHANDMISS][15] &amp;= 0xffffff00;  </span>
<span class="c">		/* set 2 bytes */</span>
<span class="c">		onyx_images[TLBHANDMISS][15] |= (0x000000ff&amp;((dtlb_addr) &gt;&gt; 24));</span>
<span class="c">		onyx_images[TLBHANDMISS][16] = (dtlb_addr &lt;&lt; 8)&amp;0xffffff00;</span>
<span class="c">		onyx_images[TLBHANDMISS][17] = itlb_addr;</span>

<span class="c">		/* clear last 2 bytes */</span>
<span class="c">		onyx_images[BIG_CPI][15] &amp;= 0xffffff00;  </span>
<span class="c">		/* set 2 bytes */</span>
<span class="c">		onyx_images[BIG_CPI][15] |= (0x000000ff&amp;((dtlb_addr) &gt;&gt; 24));</span>
<span class="c">		onyx_images[BIG_CPI][16] = (dtlb_addr &lt;&lt; 8)&amp;0xffffff00;</span>
<span class="c">		onyx_images[BIG_CPI][17] = itlb_addr;</span>

<span class="c">	    onyx_images[PANIC][15] &amp;= 0xffffff00;  /* clear last 2 bytes */</span>
<span class="c">	 	onyx_images[PANIC][15] |= (0x000000ff&amp;((IVAaddress) &gt;&gt; 24)); /* set 2 bytes */</span>
<span class="c">		onyx_images[PANIC][16] = (IVAaddress &lt;&lt; 8)&amp;0xffffff00;</span>


<span class="c">	} else if (perf_processor_interface == CUDA_INTF) {</span>
<span class="c">		/* Cuda interface */</span>
<span class="c">		cuda_images[TLBMISS][16] =  </span>
<span class="c">			(cuda_images[TLBMISS][16]&amp;0xffff0000) |</span>
<span class="c">			((dtlb_addr &gt;&gt; 8)&amp;0x0000ffff);</span>
<span class="c">		cuda_images[TLBMISS][17] = </span>
<span class="c">			((dtlb_addr &lt;&lt; 24)&amp;0xff000000) | ((itlb_addr &gt;&gt; 16)&amp;0x000000ff);</span>
<span class="c">		cuda_images[TLBMISS][18] = (itlb_addr &lt;&lt; 16)&amp;0xffff0000;</span>

<span class="c">		cuda_images[TLBHANDMISS][16] = </span>
<span class="c">			(cuda_images[TLBHANDMISS][16]&amp;0xffff0000) |</span>
<span class="c">			((dtlb_addr &gt;&gt; 8)&amp;0x0000ffff);</span>
<span class="c">		cuda_images[TLBHANDMISS][17] = </span>
<span class="c">			((dtlb_addr &lt;&lt; 24)&amp;0xff000000) | ((itlb_addr &gt;&gt; 16)&amp;0x000000ff);</span>
<span class="c">		cuda_images[TLBHANDMISS][18] = (itlb_addr &lt;&lt; 16)&amp;0xffff0000;</span>

<span class="c">		cuda_images[BIG_CPI][16] = </span>
<span class="c">			(cuda_images[BIG_CPI][16]&amp;0xffff0000) |</span>
<span class="c">			((dtlb_addr &gt;&gt; 8)&amp;0x0000ffff);</span>
<span class="c">		cuda_images[BIG_CPI][17] = </span>
<span class="c">			((dtlb_addr &lt;&lt; 24)&amp;0xff000000) | ((itlb_addr &gt;&gt; 16)&amp;0x000000ff);</span>
<span class="c">		cuda_images[BIG_CPI][18] = (itlb_addr &lt;&lt; 16)&amp;0xffff0000;</span>
<span class="c">	} else {</span>
<span class="c">		/* Unknown type */</span>
<span class="c">	}</span>
<span class="cp">#endif</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * ioctl routine</span>
<span class="cm"> * All routines effect the processor that they are executed on.  Thus you </span>
<span class="cm"> * must be running on the processor that you wish to change.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">perf_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">error_start</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">raddr</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>

	    <span class="k">case</span> <span class="n">PA_PERF_ON</span>:
			<span class="cm">/* Start the counters */</span>
			<span class="n">perf_start_counters</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>

	    <span class="k">case</span> <span class="n">PA_PERF_OFF</span>:
			<span class="n">error_start</span> <span class="o">=</span> <span class="n">perf_stop_counters</span><span class="p">(</span><span class="n">raddr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error_start</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;perf_off: perf_stop_counters = %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error_start</span><span class="p">);</span>
				<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* copy out the Counters */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="n">raddr</span><span class="p">,</span> 
					<span class="k">sizeof</span> <span class="p">(</span><span class="n">raddr</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">error</span> <span class="o">=</span>  <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

	    <span class="k">case</span> <span class="n">PA_PERF_VERSION</span>:
  	  		<span class="cm">/* Return the version # */</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">PERF_VERSION</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

	    <span class="nl">default:</span>
  	 		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">perf_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">no_llseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">perf_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">perf_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">perf_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">compat_ioctl</span> <span class="o">=</span> <span class="n">perf_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">perf_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">perf_release</span>
<span class="p">};</span>
	
<span class="k">static</span> <span class="k">struct</span> <span class="n">miscdevice</span> <span class="n">perf_dev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">MISC_DYNAMIC_MINOR</span><span class="p">,</span>
	<span class="n">PA_PERF_DEV</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">perf_fops</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize the module</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">perf_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Determine correct processor interface to use */</span>
	<span class="n">bitmask_array</span> <span class="o">=</span> <span class="n">perf_bitmasks</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">cpu_type</span> <span class="o">==</span> <span class="n">pcxu</span> <span class="o">||</span>
	    <span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">cpu_type</span> <span class="o">==</span> <span class="n">pcxu_</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">perf_processor_interface</span> <span class="o">=</span> <span class="n">ONYX_INTF</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">cpu_type</span> <span class="o">==</span> <span class="n">pcxw</span> <span class="o">||</span>
		 <span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">cpu_type</span> <span class="o">==</span> <span class="n">pcxw_</span> <span class="o">||</span>
		 <span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">cpu_type</span> <span class="o">==</span> <span class="n">pcxw2</span> <span class="o">||</span>
		 <span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">cpu_type</span> <span class="o">==</span> <span class="n">mako</span> <span class="o">||</span>
		 <span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">cpu_type</span> <span class="o">==</span> <span class="n">mako2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">perf_processor_interface</span> <span class="o">=</span> <span class="n">CUDA_INTF</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">cpu_type</span> <span class="o">==</span> <span class="n">pcxw2</span> <span class="o">||</span>
		    <span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">cpu_type</span> <span class="o">==</span> <span class="n">mako</span> <span class="o">||</span>
		    <span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">cpu_type</span> <span class="o">==</span> <span class="n">mako2</span><span class="p">)</span>
			<span class="n">bitmask_array</span> <span class="o">=</span> <span class="n">perf_bitmasks_piranha</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">perf_processor_interface</span> <span class="o">=</span> <span class="n">UNKNOWN_INTF</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Performance monitoring counters not supported on this processor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">misc_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">perf_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Performance monitoring counters: &quot;</span>
			<span class="s">&quot;cannot register misc device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Patch the images to match the system */</span>
    	<span class="n">perf_patch_images</span><span class="p">();</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">perf_lock</span><span class="p">);</span>

	<span class="cm">/* TODO: this only lets us access the first cpu.. what to do for SMP? */</span>
	<span class="n">cpu_device</span> <span class="o">=</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">cpu_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Performance monitoring counters enabled for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">per_cpu</span><span class="p">(</span><span class="n">cpu_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * perf_start_counters(void)</span>
<span class="cm"> *</span>
<span class="cm"> * Start the counters.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">perf_start_counters</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Enable performance monitor counters */</span>
	<span class="n">perf_intrigue_enable_perf_counters</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * perf_stop_counters</span>
<span class="cm"> *</span>
<span class="cm"> * Stop the performance counters and save counts</span>
<span class="cm"> * in a per_processor array.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">perf_stop_counters</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="n">raddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint64_t</span> <span class="n">userbuf</span><span class="p">[</span><span class="n">MAX_RDR_WORDS</span><span class="p">];</span>

	<span class="cm">/* Disable performance counters */</span>
	<span class="n">perf_intrigue_disable_perf_counters</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">perf_processor_interface</span> <span class="o">==</span> <span class="n">ONYX_INTF</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">uint64_t</span> <span class="n">tmp64</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Read the counters</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">perf_rdr_read_ubuf</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">userbuf</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">13</span><span class="p">;</span>

		<span class="cm">/* Counter0 is bits 1398 to 1429 */</span>
		<span class="n">tmp64</span> <span class="o">=</span>  <span class="p">(</span><span class="n">userbuf</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00000000ffc00000</span><span class="p">;</span>
		<span class="n">tmp64</span> <span class="o">|=</span> <span class="p">(</span><span class="n">userbuf</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">42</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00000000003fffff</span><span class="p">;</span>
		<span class="cm">/* OR sticky0 (bit 1430) to counter0 bit 32 */</span>
		<span class="n">tmp64</span> <span class="o">|=</span> <span class="p">(</span><span class="n">userbuf</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0000000080000000</span><span class="p">;</span>
		<span class="n">raddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">tmp64</span><span class="p">;</span>

		<span class="cm">/* Counter1 is bits 1431 to 1462 */</span>
		<span class="n">tmp64</span> <span class="o">=</span>  <span class="p">(</span><span class="n">userbuf</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00000000ffffffff</span><span class="p">;</span>
		<span class="cm">/* OR sticky1 (bit 1463) to counter1 bit 32 */</span>
		<span class="n">tmp64</span> <span class="o">|=</span> <span class="p">(</span><span class="n">userbuf</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0000000080000000</span><span class="p">;</span>
		<span class="n">raddr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">tmp64</span><span class="p">;</span>

		<span class="cm">/* Counter2 is bits 1464 to 1495 */</span>
		<span class="n">tmp64</span> <span class="o">=</span>  <span class="p">(</span><span class="n">userbuf</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00000000ff000000</span><span class="p">;</span>
		<span class="n">tmp64</span> <span class="o">|=</span> <span class="p">(</span><span class="n">userbuf</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">40</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0000000000ffffff</span><span class="p">;</span>
		<span class="cm">/* OR sticky2 (bit 1496) to counter2 bit 32 */</span>
		<span class="n">tmp64</span> <span class="o">|=</span> <span class="p">(</span><span class="n">userbuf</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0000000080000000</span><span class="p">;</span>
		<span class="n">raddr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">tmp64</span><span class="p">;</span>
		
		<span class="cm">/* Counter3 is bits 1497 to 1528 */</span>
		<span class="n">tmp64</span> <span class="o">=</span>  <span class="p">(</span><span class="n">userbuf</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00000000ffffffff</span><span class="p">;</span>
		<span class="cm">/* OR sticky3 (bit 1529) to counter3 bit 32 */</span>
		<span class="n">tmp64</span> <span class="o">|=</span> <span class="p">(</span><span class="n">userbuf</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">25</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0000000080000000</span><span class="p">;</span>
		<span class="n">raddr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">tmp64</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Zero out the counters</span>
<span class="cm">		 */</span>

		<span class="cm">/*</span>
<span class="cm">		 * The counters and sticky-bits comprise the last 132 bits</span>
<span class="cm">		 * (1398 - 1529) of RDR16 on a U chip.  We&#39;ll zero these</span>
<span class="cm">		 * out the easy way: zero out last 10 bits of dword 21,</span>
<span class="cm">		 * all of dword 22 and 58 bits (plus 6 don&#39;t care bits) of</span>
<span class="cm">		 * dword 23.</span>
<span class="cm">		 */</span>
		<span class="n">userbuf</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0xfffffffffffffc00ul</span><span class="p">;</span>	<span class="cm">/* 0 to last 10 bits */</span>
		<span class="n">userbuf</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">userbuf</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* </span>
<span class="cm">		 * Write back the zeroed bytes + the image given</span>
<span class="cm">		 * the read was destructive.</span>
<span class="cm">		 */</span>
		<span class="n">perf_rdr_write</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">userbuf</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * Read RDR-15 which contains the counters and sticky bits </span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">perf_rdr_read_ubuf</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="n">userbuf</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">13</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* </span>
<span class="cm">		 * Clear out the counters</span>
<span class="cm">		 */</span>
		<span class="n">perf_rdr_clear</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Copy the counters </span>
<span class="cm">		 */</span>
		<span class="n">raddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)((</span><span class="n">userbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00000000ffffffffUL</span><span class="p">);</span>
		<span class="n">raddr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)(</span><span class="n">userbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x00000000ffffffffUL</span><span class="p">);</span>
		<span class="n">raddr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)((</span><span class="n">userbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00000000ffffffffUL</span><span class="p">);</span>
		<span class="n">raddr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)(</span><span class="n">userbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x00000000ffffffffUL</span><span class="p">);</span>
	<span class="p">}</span>
 
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * perf_rdr_get_entry</span>
<span class="cm"> *</span>
<span class="cm"> * Retrieve a pointer to the description of what this</span>
<span class="cm"> * RDR contains.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rdr_tbl_ent</span> <span class="o">*</span> <span class="nf">perf_rdr_get_entry</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">rdr_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">perf_processor_interface</span> <span class="o">==</span> <span class="n">ONYX_INTF</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">perf_rdr_tbl_U</span><span class="p">[</span><span class="n">rdr_num</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">perf_rdr_tbl_W</span><span class="p">[</span><span class="n">rdr_num</span><span class="p">];</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * perf_rdr_read_ubuf</span>
<span class="cm"> *</span>
<span class="cm"> * Read the RDR value into the buffer specified.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">perf_rdr_read_ubuf</span><span class="p">(</span><span class="kt">uint32_t</span>	<span class="n">rdr_num</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint64_t</span>	<span class="n">data</span><span class="p">,</span> <span class="n">data_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">width</span><span class="p">,</span> <span class="n">xbits</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">rdr_tbl_ent</span> <span class="o">*</span><span class="n">tentry</span><span class="p">;</span>

	<span class="n">tentry</span> <span class="o">=</span> <span class="n">perf_rdr_get_entry</span><span class="p">(</span><span class="n">rdr_num</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">width</span> <span class="o">=</span> <span class="n">tentry</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Clear out buffer */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">tentry</span><span class="o">-&gt;</span><span class="n">num_words</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>	

	<span class="cm">/* Check for bits an even number of 64 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">xbits</span> <span class="o">=</span> <span class="n">width</span> <span class="o">&amp;</span> <span class="mh">0x03f</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data_mask</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">data_mask</span> <span class="o">&lt;&lt;=</span> <span class="p">(</span><span class="mi">64</span> <span class="o">-</span> <span class="n">xbits</span><span class="p">);</span>
		<span class="n">data_mask</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Grab all of the data */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">tentry</span><span class="o">-&gt;</span><span class="n">num_words</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">perf_processor_interface</span> <span class="o">==</span> <span class="n">ONYX_INTF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">perf_rdr_shift_in_U</span><span class="p">(</span><span class="n">rdr_num</span><span class="p">,</span> <span class="n">width</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">perf_rdr_shift_in_W</span><span class="p">(</span><span class="n">rdr_num</span><span class="p">,</span> <span class="n">width</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xbits</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">64</span> <span class="o">-</span> <span class="n">xbits</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="p">((</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="n">xbits</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">data_mask</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * perf_rdr_clear</span>
<span class="cm"> *</span>
<span class="cm"> * Zero out the given RDR register</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">perf_rdr_clear</span><span class="p">(</span><span class="kt">uint32_t</span>	<span class="n">rdr_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">rdr_tbl_ent</span> <span class="o">*</span><span class="n">tentry</span><span class="p">;</span>
	<span class="kt">int32_t</span>		<span class="n">i</span><span class="p">;</span>

	<span class="n">tentry</span> <span class="o">=</span> <span class="n">perf_rdr_get_entry</span><span class="p">(</span><span class="n">rdr_num</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tentry</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">tentry</span><span class="o">-&gt;</span><span class="n">num_words</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">perf_processor_interface</span> <span class="o">==</span> <span class="n">ONYX_INTF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">perf_rdr_shift_out_U</span><span class="p">(</span><span class="n">rdr_num</span><span class="p">,</span> <span class="mi">0UL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">perf_rdr_shift_out_W</span><span class="p">(</span><span class="n">rdr_num</span><span class="p">,</span> <span class="mi">0UL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * perf_write_image</span>
<span class="cm"> *</span>
<span class="cm"> * Write the given image out to the processor</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">perf_write_image</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="n">memaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint64_t</span> <span class="n">buffer</span><span class="p">[</span><span class="n">MAX_RDR_WORDS</span><span class="p">];</span>
	<span class="kt">uint64_t</span> <span class="o">*</span><span class="n">bptr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">dwords</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">intrigue_rdr</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">intrigue_bitmask</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">tmp64</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">runway</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">rdr_tbl_ent</span> <span class="o">*</span><span class="n">tentry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Clear out counters */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">perf_processor_interface</span> <span class="o">==</span> <span class="n">ONYX_INTF</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">perf_rdr_clear</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>

		<span class="cm">/* Toggle performance monitor */</span>
		<span class="n">perf_intrigue_enable_perf_counters</span><span class="p">();</span>
		<span class="n">perf_intrigue_disable_perf_counters</span><span class="p">();</span>

		<span class="n">intrigue_rdr</span> <span class="o">=</span> <span class="n">perf_rdrs_U</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">perf_rdr_clear</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>
		<span class="n">intrigue_rdr</span> <span class="o">=</span> <span class="n">perf_rdrs_W</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Write all RDRs */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">intrigue_rdr</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tentry</span> <span class="o">=</span> <span class="n">perf_rdr_get_entry</span><span class="p">(</span><span class="o">*</span><span class="n">intrigue_rdr</span><span class="p">);</span>
		<span class="n">perf_rdr_read_ubuf</span><span class="p">(</span><span class="o">*</span><span class="n">intrigue_rdr</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
		<span class="n">bptr</span>   <span class="o">=</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">dwords</span> <span class="o">=</span> <span class="n">tentry</span><span class="o">-&gt;</span><span class="n">num_words</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tentry</span><span class="o">-&gt;</span><span class="n">write_control</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">intrigue_bitmask</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bitmask_array</span><span class="p">[</span><span class="n">tentry</span><span class="o">-&gt;</span><span class="n">write_control</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">];</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">dwords</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tmp64</span> <span class="o">=</span> <span class="o">*</span><span class="n">intrigue_bitmask</span> <span class="o">&amp;</span> <span class="o">*</span><span class="n">memaddr</span><span class="o">++</span><span class="p">;</span>
				<span class="n">tmp64</span> <span class="o">|=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="o">*</span><span class="n">intrigue_bitmask</span><span class="o">++</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">*</span><span class="n">bptr</span><span class="p">;</span>
				<span class="o">*</span><span class="n">bptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">tmp64</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">dwords</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">bptr</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">memaddr</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">perf_rdr_write</span><span class="p">(</span><span class="o">*</span><span class="n">intrigue_rdr</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
		<span class="n">intrigue_rdr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now copy out the Runway stuff which is not in RDRs</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_device</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;write_image: cpu_device not yet initialized!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">runway</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">cpu_device</span><span class="o">-&gt;</span><span class="n">hpa</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>

	<span class="cm">/* Merge intrigue bits into Runway STATUS 0 */</span>
	<span class="n">tmp64</span> <span class="o">=</span> <span class="n">__raw_readq</span><span class="p">(</span><span class="n">runway</span> <span class="o">+</span> <span class="n">RUNWAY_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffecfffffffffffful</span><span class="p">;</span>
	<span class="n">__raw_writeq</span><span class="p">(</span><span class="n">tmp64</span> <span class="o">|</span> <span class="p">(</span><span class="o">*</span><span class="n">memaddr</span><span class="o">++</span> <span class="o">&amp;</span> <span class="mh">0x0013000000000000ul</span><span class="p">),</span> 
		     <span class="n">runway</span> <span class="o">+</span> <span class="n">RUNWAY_STATUS</span><span class="p">);</span>
	
	<span class="cm">/* Write RUNWAY DEBUG registers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__raw_writeq</span><span class="p">(</span><span class="o">*</span><span class="n">memaddr</span><span class="o">++</span><span class="p">,</span> <span class="n">runway</span> <span class="o">+</span> <span class="n">RUNWAY_DEBUG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> 
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * perf_rdr_write</span>
<span class="cm"> *</span>
<span class="cm"> * Write the given RDR register with the contents</span>
<span class="cm"> * of the given buffer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">perf_rdr_write</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">rdr_num</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">rdr_tbl_ent</span> <span class="o">*</span><span class="n">tentry</span><span class="p">;</span>
	<span class="kt">int32_t</span>		<span class="n">i</span><span class="p">;</span>

<span class="n">printk</span><span class="p">(</span><span class="s">&quot;perf_rdr_write</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">tentry</span> <span class="o">=</span> <span class="n">perf_rdr_get_entry</span><span class="p">(</span><span class="n">rdr_num</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tentry</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">tentry</span><span class="o">-&gt;</span><span class="n">num_words</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">perf_processor_interface</span> <span class="o">==</span> <span class="n">ONYX_INTF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">perf_rdr_shift_out_U</span><span class="p">(</span><span class="n">rdr_num</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">perf_rdr_shift_out_W</span><span class="p">(</span><span class="n">rdr_num</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>	
	<span class="p">}</span>
<span class="n">printk</span><span class="p">(</span><span class="s">&quot;perf_rdr_write done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">perf_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
