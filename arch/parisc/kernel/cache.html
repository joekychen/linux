<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › parisc › kernel › cache.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>cache.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License.  See the file &quot;COPYING&quot; in the main directory of this archive</span>
<span class="cm"> * for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1999-2006 Helge Deller &lt;deller@gmx.de&gt; (07-13-1999)</span>
<span class="cm"> * Copyright (C) 1999 SuSE GmbH Nuernberg</span>
<span class="cm"> * Copyright (C) 2000 Philipp Rumpf (prumpf@tux.org)</span>
<span class="cm"> *</span>
<span class="cm"> * Cache and TLB management</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
 
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/pagemap.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;asm/pdc.h&gt;</span>
<span class="cp">#include &lt;asm/cache.h&gt;</span>
<span class="cp">#include &lt;asm/cacheflush.h&gt;</span>
<span class="cp">#include &lt;asm/tlbflush.h&gt;</span>
<span class="cp">#include &lt;asm/page.h&gt;</span>
<span class="cp">#include &lt;asm/pgalloc.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;</span>
<span class="cp">#include &lt;asm/sections.h&gt;</span>
<span class="cp">#include &lt;asm/shmparam.h&gt;</span>

<span class="kt">int</span> <span class="n">split_tlb</span> <span class="n">__read_mostly</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">dcache_stride</span> <span class="n">__read_mostly</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">icache_stride</span> <span class="n">__read_mostly</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dcache_stride</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">flush_dcache_page_asm</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">phys_addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vaddr</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">flush_dcache_page_asm</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">flush_icache_page_asm</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">phys_addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vaddr</span><span class="p">);</span>


<span class="cm">/* On some machines (e.g. ones with the Merced bus), there can be</span>
<span class="cm"> * only a single PxTLB broadcast at a time; this must be guaranteed</span>
<span class="cm"> * by software.  We put a spinlock around all TLB flushes  to</span>
<span class="cm"> * ensure this.</span>
<span class="cm"> */</span>
<span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">pa_tlb_lock</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">pdc_cache_info</span> <span class="n">cache_info</span> <span class="n">__read_mostly</span><span class="p">;</span>
<span class="cp">#ifndef CONFIG_PA20</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pdc_btlb_info</span> <span class="n">btlb_info</span> <span class="n">__read_mostly</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_SMP</span>
<span class="kt">void</span>
<span class="nf">flush_data_cache</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">on_each_cpu</span><span class="p">(</span><span class="n">flush_data_cache_local</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span> 
<span class="nf">flush_instruction_cache</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">on_each_cpu</span><span class="p">(</span><span class="n">flush_instruction_cache_local</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="kt">void</span>
<span class="nf">flush_cache_all_local</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">flush_instruction_cache_local</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="n">flush_data_cache_local</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">flush_cache_all_local</span><span class="p">);</span>

<span class="kt">void</span>
<span class="nf">update_mmu_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">address</span><span class="p">,</span> <span class="n">pte_t</span> <span class="o">*</span><span class="n">ptep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">pte_page</span><span class="p">(</span><span class="o">*</span><span class="n">ptep</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pfn_valid</span><span class="p">(</span><span class="n">page_to_pfn</span><span class="p">(</span><span class="n">page</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">page_mapping</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">PG_dcache_dirty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">flush_kernel_dcache_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">PG_dcache_dirty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">parisc_requires_coherency</span><span class="p">())</span>
		<span class="n">flush_kernel_dcache_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">show_cache_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;I-cache</span><span class="se">\t\t</span><span class="s">: %ld KB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		<span class="n">cache_info</span><span class="p">.</span><span class="n">ic_size</span><span class="o">/</span><span class="mi">1024</span> <span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cache_info</span><span class="p">.</span><span class="n">dc_loop</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="s">&quot;%lu-way associative&quot;</span><span class="p">,</span> <span class="n">cache_info</span><span class="p">.</span><span class="n">dc_loop</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;D-cache</span><span class="se">\t\t</span><span class="s">: %ld KB (%s%s, %s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cache_info</span><span class="p">.</span><span class="n">dc_size</span><span class="o">/</span><span class="mi">1024</span><span class="p">,</span>
		<span class="p">(</span><span class="n">cache_info</span><span class="p">.</span><span class="n">dc_conf</span><span class="p">.</span><span class="n">cc_wt</span> <span class="o">?</span> <span class="s">&quot;WT&quot;</span><span class="o">:</span><span class="s">&quot;WB&quot;</span><span class="p">),</span>
		<span class="p">(</span><span class="n">cache_info</span><span class="p">.</span><span class="n">dc_conf</span><span class="p">.</span><span class="n">cc_sh</span> <span class="o">?</span> <span class="s">&quot;, shared I/D&quot;</span><span class="o">:</span><span class="s">&quot;&quot;</span><span class="p">),</span>
		<span class="p">((</span><span class="n">cache_info</span><span class="p">.</span><span class="n">dc_loop</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;direct mapped&quot;</span> <span class="o">:</span> <span class="n">buf</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;ITLB entries</span><span class="se">\t</span><span class="s">: %ld</span><span class="se">\n</span><span class="s">&quot;</span> <span class="s">&quot;DTLB entries</span><span class="se">\t</span><span class="s">: %ld%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cache_info</span><span class="p">.</span><span class="n">it_size</span><span class="p">,</span>
		<span class="n">cache_info</span><span class="p">.</span><span class="n">dt_size</span><span class="p">,</span>
		<span class="n">cache_info</span><span class="p">.</span><span class="n">dt_conf</span><span class="p">.</span><span class="n">tc_sh</span> <span class="o">?</span> <span class="s">&quot; - shared with ITLB&quot;</span><span class="o">:</span><span class="s">&quot;&quot;</span>
	<span class="p">);</span>
		
<span class="cp">#ifndef CONFIG_PA20</span>
	<span class="cm">/* BTLB - Block TLB */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">btlb_info</span><span class="p">.</span><span class="n">max_size</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;BTLB</span><span class="se">\t\t</span><span class="s">: not supported</span><span class="se">\n</span><span class="s">&quot;</span> <span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> 
		<span class="s">&quot;BTLB fixed</span><span class="se">\t</span><span class="s">: max. %d pages, pagesize=%d (%dMB)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;BTLB fix-entr.</span><span class="se">\t</span><span class="s">: %d instruction, %d data (%d combined)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;BTLB var-entr.</span><span class="se">\t</span><span class="s">: %d instruction, %d data (%d combined)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">btlb_info</span><span class="p">.</span><span class="n">max_size</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="mi">4096</span><span class="p">,</span>
		<span class="n">btlb_info</span><span class="p">.</span><span class="n">max_size</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">btlb_info</span><span class="p">.</span><span class="n">fixed_range_info</span><span class="p">.</span><span class="n">num_i</span><span class="p">,</span>
		<span class="n">btlb_info</span><span class="p">.</span><span class="n">fixed_range_info</span><span class="p">.</span><span class="n">num_d</span><span class="p">,</span>
		<span class="n">btlb_info</span><span class="p">.</span><span class="n">fixed_range_info</span><span class="p">.</span><span class="n">num_comb</span><span class="p">,</span> 
		<span class="n">btlb_info</span><span class="p">.</span><span class="n">variable_range_info</span><span class="p">.</span><span class="n">num_i</span><span class="p">,</span>
		<span class="n">btlb_info</span><span class="p">.</span><span class="n">variable_range_info</span><span class="p">.</span><span class="n">num_d</span><span class="p">,</span>
		<span class="n">btlb_info</span><span class="p">.</span><span class="n">variable_range_info</span><span class="p">.</span><span class="n">num_comb</span>
		<span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> 
<span class="nf">parisc_cache_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdc_cache_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cache_info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;parisc_cache_init: pdc_cache_info failed&quot;</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	printk(&quot;ic_size %lx dc_size %lx it_size %lx\n&quot;,</span>
<span class="c">		cache_info.ic_size,</span>
<span class="c">		cache_info.dc_size,</span>
<span class="c">		cache_info.it_size);</span>

<span class="c">	printk(&quot;DC  base 0x%lx stride 0x%lx count 0x%lx loop 0x%lx\n&quot;,</span>
<span class="c">		cache_info.dc_base,</span>
<span class="c">		cache_info.dc_stride,</span>
<span class="c">		cache_info.dc_count,</span>
<span class="c">		cache_info.dc_loop);</span>

<span class="c">	printk(&quot;dc_conf = 0x%lx  alias %d blk %d line %d shift %d\n&quot;,</span>
<span class="c">		*(unsigned long *) (&amp;cache_info.dc_conf),</span>
<span class="c">		cache_info.dc_conf.cc_alias,</span>
<span class="c">		cache_info.dc_conf.cc_block,</span>
<span class="c">		cache_info.dc_conf.cc_line,</span>
<span class="c">		cache_info.dc_conf.cc_shift);</span>
<span class="c">	printk(&quot;	wt %d sh %d cst %d hv %d\n&quot;,</span>
<span class="c">		cache_info.dc_conf.cc_wt,</span>
<span class="c">		cache_info.dc_conf.cc_sh,</span>
<span class="c">		cache_info.dc_conf.cc_cst,</span>
<span class="c">		cache_info.dc_conf.cc_hv);</span>

<span class="c">	printk(&quot;IC  base 0x%lx stride 0x%lx count 0x%lx loop 0x%lx\n&quot;,</span>
<span class="c">		cache_info.ic_base,</span>
<span class="c">		cache_info.ic_stride,</span>
<span class="c">		cache_info.ic_count,</span>
<span class="c">		cache_info.ic_loop);</span>

<span class="c">	printk(&quot;ic_conf = 0x%lx  alias %d blk %d line %d shift %d\n&quot;,</span>
<span class="c">		*(unsigned long *) (&amp;cache_info.ic_conf),</span>
<span class="c">		cache_info.ic_conf.cc_alias,</span>
<span class="c">		cache_info.ic_conf.cc_block,</span>
<span class="c">		cache_info.ic_conf.cc_line,</span>
<span class="c">		cache_info.ic_conf.cc_shift);</span>
<span class="c">	printk(&quot;	wt %d sh %d cst %d hv %d\n&quot;,</span>
<span class="c">		cache_info.ic_conf.cc_wt,</span>
<span class="c">		cache_info.ic_conf.cc_sh,</span>
<span class="c">		cache_info.ic_conf.cc_cst,</span>
<span class="c">		cache_info.ic_conf.cc_hv);</span>

<span class="c">	printk(&quot;D-TLB conf: sh %d page %d cst %d aid %d pad1 %d\n&quot;,</span>
<span class="c">		cache_info.dt_conf.tc_sh,</span>
<span class="c">		cache_info.dt_conf.tc_page,</span>
<span class="c">		cache_info.dt_conf.tc_cst,</span>
<span class="c">		cache_info.dt_conf.tc_aid,</span>
<span class="c">		cache_info.dt_conf.tc_pad1);</span>

<span class="c">	printk(&quot;I-TLB conf: sh %d page %d cst %d aid %d pad1 %d\n&quot;,</span>
<span class="c">		cache_info.it_conf.tc_sh,</span>
<span class="c">		cache_info.it_conf.tc_page,</span>
<span class="c">		cache_info.it_conf.tc_cst,</span>
<span class="c">		cache_info.it_conf.tc_aid,</span>
<span class="c">		cache_info.it_conf.tc_pad1);</span>
<span class="cp">#endif</span>

	<span class="n">split_tlb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cache_info</span><span class="p">.</span><span class="n">dt_conf</span><span class="p">.</span><span class="n">tc_sh</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">cache_info</span><span class="p">.</span><span class="n">dt_conf</span><span class="p">.</span><span class="n">tc_sh</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cache_info</span><span class="p">.</span><span class="n">dt_conf</span><span class="p">.</span><span class="n">tc_sh</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Unexpected TLB configuration. &quot;</span>
			<span class="s">&quot;Will flush I/D separately (could be optimized).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">split_tlb</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* &quot;New and Improved&quot; version from Jim Hull </span>
<span class="cm">	 *	(1 &lt;&lt; (cc_block-1)) * (cc_line &lt;&lt; (4 + cnf.cc_shift))</span>
<span class="cm">	 * The following CAFL_STRIDE is an optimized version, see</span>
<span class="cm">	 * http://lists.parisc-linux.org/pipermail/parisc-linux/2004-June/023625.html</span>
<span class="cm">	 * http://lists.parisc-linux.org/pipermail/parisc-linux/2004-June/023671.html</span>
<span class="cm">	 */</span>
<span class="cp">#define CAFL_STRIDE(cnf) (cnf.cc_line &lt;&lt; (3 + cnf.cc_block + cnf.cc_shift))</span>
	<span class="n">dcache_stride</span> <span class="o">=</span> <span class="n">CAFL_STRIDE</span><span class="p">(</span><span class="n">cache_info</span><span class="p">.</span><span class="n">dc_conf</span><span class="p">);</span>
	<span class="n">icache_stride</span> <span class="o">=</span> <span class="n">CAFL_STRIDE</span><span class="p">(</span><span class="n">cache_info</span><span class="p">.</span><span class="n">ic_conf</span><span class="p">);</span>
<span class="cp">#undef CAFL_STRIDE</span>

<span class="cp">#ifndef CONFIG_PA20</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdc_btlb_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btlb_info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btlb_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">btlb_info</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">pdc</span><span class="p">.</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">PDC_MODEL_NVA_MASK</span><span class="p">)</span> <span class="o">==</span>
						<span class="n">PDC_MODEL_NVA_UNSUPPORTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;parisc_cache_init: Only equivalent aliasing supported!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		panic(&quot;SMP kernel required to avoid non-equivalent aliasing&quot;);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">disable_sr_hashing</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">srhash_type</span><span class="p">,</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">space_bits</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">cpu_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">pcx</span>: <span class="cm">/* We shouldn&#39;t get this far.  setup.c should prevent it. */</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">pcxs</span>:
	<span class="k">case</span> <span class="n">pcxt</span>:
	<span class="k">case</span> <span class="n">pcxt_</span>:
		<span class="n">srhash_type</span> <span class="o">=</span> <span class="n">SRHASH_PCXST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">pcxl</span>:
		<span class="n">srhash_type</span> <span class="o">=</span> <span class="n">SRHASH_PCXL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">pcxl2</span>: <span class="cm">/* pcxl2 doesn&#39;t support space register hashing */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="nl">default:</span> <span class="cm">/* Currently all PA2.0 machines use the same ins. sequence */</span>
		<span class="n">srhash_type</span> <span class="o">=</span> <span class="n">SRHASH_PA20</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">disable_sr_hashing_asm</span><span class="p">(</span><span class="n">srhash_type</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">pdc_spaceid_bits</span><span class="p">(</span><span class="o">&amp;</span><span class="n">space_bits</span><span class="p">);</span>
	<span class="cm">/* If this procedure isn&#39;t implemented, don&#39;t panic. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">retval</span> <span class="o">!=</span> <span class="n">PDC_BAD_OPTION</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;pdc_spaceid_bits call failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">space_bits</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;SpaceID hashing is still on!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">__flush_cache_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vmaddr</span><span class="p">,</span>
		   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">physaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">flush_dcache_page_asm</span><span class="p">(</span><span class="n">physaddr</span><span class="p">,</span> <span class="n">vmaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">&amp;</span> <span class="n">VM_EXEC</span><span class="p">)</span>
		<span class="n">flush_icache_page_asm</span><span class="p">(</span><span class="n">physaddr</span><span class="p">,</span> <span class="n">vmaddr</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">flush_dcache_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">page_mapping</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">mpnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">prio_tree_iter</span> <span class="n">iter</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="n">old_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pgoff_t</span> <span class="n">pgoff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mapping</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mapping_mapped</span><span class="p">(</span><span class="n">mapping</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">PG_dcache_dirty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">flush_kernel_dcache_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mapping</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pgoff</span> <span class="o">=</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">PAGE_CACHE_SHIFT</span> <span class="o">-</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>

	<span class="cm">/* We have carefully arranged in arch_get_unmapped_area() that</span>
<span class="cm">	 * *any* mappings of a file are always congruently mapped (whether</span>
<span class="cm">	 * declared as MAP_PRIVATE or MAP_SHARED), so we only need</span>
<span class="cm">	 * to flush one address here for them all to become coherent */</span>

	<span class="n">flush_dcache_mmap_lock</span><span class="p">(</span><span class="n">mapping</span><span class="p">);</span>
	<span class="n">vma_prio_tree_foreach</span><span class="p">(</span><span class="n">mpnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">i_mmap</span><span class="p">,</span> <span class="n">pgoff</span><span class="p">,</span> <span class="n">pgoff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">pgoff</span> <span class="o">-</span> <span class="n">mpnt</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">mpnt</span><span class="o">-&gt;</span><span class="n">vm_start</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>

		<span class="cm">/* The TLB is the engine of coherence on parisc: The</span>
<span class="cm">		 * CPU is entitled to speculate any page with a TLB</span>
<span class="cm">		 * mapping, so here we kill the mapping then flush the</span>
<span class="cm">		 * page along a special flush only alias mapping.</span>
<span class="cm">		 * This guarantees that the page is no-longer in the</span>
<span class="cm">		 * cache for any process and nor may it be</span>
<span class="cm">		 * speculatively read in (until the user or kernel</span>
<span class="cm">		 * specifically accesses it, of course) */</span>

		<span class="n">flush_tlb_page</span><span class="p">(</span><span class="n">mpnt</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_addr</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">old_addr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SHMLBA</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SHMLBA</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">__flush_cache_page</span><span class="p">(</span><span class="n">mpnt</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">page_to_phys</span><span class="p">(</span><span class="n">page</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">old_addr</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;INEQUIVALENT ALIASES 0x%lx and 0x%lx in file %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">old_addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">mpnt</span><span class="o">-&gt;</span><span class="n">vm_file</span> <span class="o">?</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">mpnt</span><span class="o">-&gt;</span><span class="n">vm_file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;(null)&quot;</span><span class="p">);</span>
			<span class="n">old_addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">flush_dcache_mmap_unlock</span><span class="p">(</span><span class="n">mapping</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">flush_dcache_page</span><span class="p">);</span>

<span class="cm">/* Defined in arch/parisc/kernel/pacache.S */</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">flush_kernel_dcache_range_asm</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">flush_kernel_dcache_page_asm</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">flush_data_cache_local</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">flush_kernel_icache_range_asm</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">clear_user_page_asm</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="cm">/* This function is implemented in assembly in pacache.S */</span>
	<span class="k">extern</span> <span class="kt">void</span> <span class="n">__clear_user_page_asm</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vaddr</span><span class="p">);</span>

	<span class="n">purge_tlb_start</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">__clear_user_page_asm</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">vaddr</span><span class="p">);</span>
	<span class="n">purge_tlb_end</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define FLUSH_THRESHOLD 0x80000 </span><span class="cm">/* 0.5MB */</span><span class="cp"></span>
<span class="kt">int</span> <span class="n">parisc_cache_flush_threshold</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="n">FLUSH_THRESHOLD</span><span class="p">;</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">parisc_setup_cache_timing</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rangetime</span><span class="p">,</span> <span class="n">alltime</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">alltime</span> <span class="o">=</span> <span class="n">mfctl</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
	<span class="n">flush_data_cache</span><span class="p">();</span>
	<span class="n">alltime</span> <span class="o">=</span> <span class="n">mfctl</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="n">alltime</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">_end</span> <span class="o">-</span> <span class="n">_text</span><span class="p">);</span>
	<span class="n">rangetime</span> <span class="o">=</span> <span class="n">mfctl</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
	<span class="n">flush_kernel_dcache_range</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">_text</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">rangetime</span> <span class="o">=</span> <span class="n">mfctl</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="n">rangetime</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Whole cache flush %lu cycles, flushing %lu bytes %lu cycles</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">alltime</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">rangetime</span><span class="p">);</span>

	<span class="cm">/* Racy, but if we see an intermediate value, it&#39;s ok too... */</span>
	<span class="n">parisc_cache_flush_threshold</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="n">alltime</span> <span class="o">/</span> <span class="n">rangetime</span><span class="p">;</span>

	<span class="n">parisc_cache_flush_threshold</span> <span class="o">=</span> <span class="p">(</span><span class="n">parisc_cache_flush_threshold</span> <span class="o">+</span> <span class="n">L1_CACHE_BYTES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;~</span> <span class="p">(</span><span class="n">L1_CACHE_BYTES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> 
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parisc_cache_flush_threshold</span><span class="p">)</span>
		<span class="n">parisc_cache_flush_threshold</span> <span class="o">=</span> <span class="n">FLUSH_THRESHOLD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parisc_cache_flush_threshold</span> <span class="o">&gt;</span> <span class="n">cache_info</span><span class="p">.</span><span class="n">dc_size</span><span class="p">)</span>
		<span class="n">parisc_cache_flush_threshold</span> <span class="o">=</span> <span class="n">cache_info</span><span class="p">.</span><span class="n">dc_size</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Setting cache flush threshold to %x (%d CPUs online)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">parisc_cache_flush_threshold</span><span class="p">,</span> <span class="n">num_online_cpus</span><span class="p">());</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">purge_kernel_dcache_page</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">clear_user_page_asm</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vaddr</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">clear_user_page</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vaddr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">pg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">purge_kernel_dcache_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">page</span><span class="p">);</span>
	<span class="n">purge_tlb_start</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">pdtlb_kernel</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="n">purge_tlb_end</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">clear_user_page_asm</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">vaddr</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">clear_user_page</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">flush_kernel_dcache_page_addr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">flush_kernel_dcache_page_asm</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">purge_tlb_start</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">pdtlb_kernel</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">purge_tlb_end</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">flush_kernel_dcache_page_addr</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">copy_user_page</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">vto</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">vfrom</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vaddr</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">pg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* no coherency needed (all in kmap/kunmap) */</span>
	<span class="n">copy_user_page_asm</span><span class="p">(</span><span class="n">vto</span><span class="p">,</span> <span class="n">vfrom</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parisc_requires_coherency</span><span class="p">())</span>
		<span class="n">flush_kernel_dcache_page_asm</span><span class="p">(</span><span class="n">vto</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">copy_user_page</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PA8X00</span>

<span class="kt">void</span> <span class="nf">kunmap_parisc</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parisc_requires_coherency</span><span class="p">())</span>
		<span class="n">flush_kernel_dcache_page_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">kunmap_parisc</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="kt">void</span> <span class="nf">__flush_tlb_range</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sid</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">npages</span><span class="p">;</span>

	<span class="n">npages</span> <span class="o">=</span> <span class="p">((</span><span class="n">end</span> <span class="o">-</span> <span class="p">(</span><span class="n">start</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">npages</span> <span class="o">&gt;=</span> <span class="mi">512</span><span class="p">)</span>  <span class="cm">/* 2MB of space: arbitrary, should be tuned */</span>
		<span class="n">flush_tlb_all</span><span class="p">();</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

		<span class="n">mtsp</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">purge_tlb_start</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">split_tlb</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">npages</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pdtlb</span><span class="p">(</span><span class="n">start</span><span class="p">);</span>
				<span class="n">pitlb</span><span class="p">(</span><span class="n">start</span><span class="p">);</span>
				<span class="n">start</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">npages</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pdtlb</span><span class="p">(</span><span class="n">start</span><span class="p">);</span>
				<span class="n">start</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">purge_tlb_end</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cacheflush_h_tmp_function</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dummy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">flush_cache_all_local</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">flush_cache_all</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">on_each_cpu</span><span class="p">(</span><span class="n">cacheflush_h_tmp_function</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">flush_cache_mm</span><span class="p">(</span><span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="n">flush_cache_all</span><span class="p">();</span>
<span class="cp">#else</span>
	<span class="n">flush_cache_all_local</span><span class="p">();</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">flush_user_dcache_range</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">parisc_cache_flush_threshold</span><span class="p">)</span>
		<span class="n">flush_user_dcache_range_asm</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">flush_data_cache</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">flush_user_icache_range</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">parisc_cache_flush_threshold</span><span class="p">)</span>
		<span class="n">flush_user_icache_range_asm</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">flush_instruction_cache</span><span class="p">();</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">flush_cache_range</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sr3</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">);</span>

	<span class="n">sr3</span> <span class="o">=</span> <span class="n">mfsp</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_mm</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">==</span> <span class="n">sr3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">flush_user_dcache_range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">);</span>
		<span class="n">flush_user_icache_range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">flush_cache_all</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">flush_cache_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vmaddr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pfn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_mm</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">);</span>

	<span class="n">flush_tlb_page</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="n">vmaddr</span><span class="p">);</span>
	<span class="n">__flush_cache_page</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="n">vmaddr</span><span class="p">,</span> <span class="n">page_to_phys</span><span class="p">(</span><span class="n">pfn_to_page</span><span class="p">(</span><span class="n">pfn</span><span class="p">)));</span>

<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
