<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › parisc › kernel › traps.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>traps.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/arch/parisc/traps.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 1991, 1992  Linus Torvalds</span>
<span class="cm"> *  Copyright (C) 1999, 2000  Philipp Rumpf &lt;prumpf@tux.org&gt;</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * &#39;Traps.c&#39; handles hardware traps and faults after we have saved some</span>
<span class="cm"> * state in &#39;asm.s&#39;.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/smp.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/bug.h&gt;</span>

<span class="cp">#include &lt;asm/assembly.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/traps.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>
<span class="cp">#include &lt;linux/atomic.h&gt;</span>
<span class="cp">#include &lt;asm/smp.h&gt;</span>
<span class="cp">#include &lt;asm/pdc.h&gt;</span>
<span class="cp">#include &lt;asm/pdc_chassis.h&gt;</span>
<span class="cp">#include &lt;asm/unwind.h&gt;</span>
<span class="cp">#include &lt;asm/tlbflush.h&gt;</span>
<span class="cp">#include &lt;asm/cacheflush.h&gt;</span>

<span class="cp">#include &quot;../math-emu/math-emu.h&quot;	</span><span class="cm">/* for handle_fpe() */</span><span class="cp"></span>

<span class="cp">#define PRINT_USER_FAULTS </span><span class="cm">/* (turn this on if you want user faults to be */</span><span class="cp"></span>
			  <span class="cm">/*  dumped to the console via printk)          */</span>

<span class="cp">#if defined(CONFIG_SMP) || defined(CONFIG_DEBUG_SPINLOCK)</span>
<span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">pa_dbit_lock</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">parisc_show_stack</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">printbinary</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">nbits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">mask</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">x</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">);</span>
		<span class="n">mask</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nbits</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_64BIT</span>
<span class="cp">#define RFMT &quot;%016lx&quot;</span>
<span class="cp">#else</span>
<span class="cp">#define RFMT &quot;%08lx&quot;</span>
<span class="cp">#endif</span>
<span class="cp">#define FFMT &quot;%016llx&quot;	</span><span class="cm">/* fpregs are 64-bit always */</span><span class="cp"></span>

<span class="cp">#define PRINTREGS(lvl,r,f,fmt,x)	\</span>
<span class="cp">	printk(&quot;%s%s%02d-%02d  &quot; fmt &quot; &quot; fmt &quot; &quot; fmt &quot; &quot; fmt &quot;\n&quot;,	\</span>
<span class="cp">		lvl, f, (x), (x+3), (r)[(x)+0], (r)[(x)+1],		\</span>
<span class="cp">		(r)[(x)+2], (r)[(x)+3])</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_gr</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">level</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s     YZrvWESTHLNXBCVMcbcbcbcbOGFRQPDI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
	<span class="n">printbinary</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%sPSW: %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">print_tainted</span><span class="p">());</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">PRINTREGS</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">,</span> <span class="n">RFMT</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_fr</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">level</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="k">struct</span> <span class="p">{</span> <span class="n">u32</span> <span class="n">sw</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="p">}</span> <span class="n">s</span><span class="p">;</span>

	<span class="cm">/* FR are 64bit everywhere. Need to use asm to get the content</span>
<span class="cm">	 * of fpsr/fper1, and we assume that we won&#39;t have a FP Identify</span>
<span class="cm">	 * in our way, otherwise we&#39;re screwed.</span>
<span class="cm">	 * The fldd is used to restore the T-bit if there was one, as the</span>
<span class="cm">	 * store clears it anyway.</span>
<span class="cm">	 * PA2.0 book says &quot;thou shall not use fstw on FPSR/FPERs&quot; - T-Bone */</span>
	<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">&quot;fstd %%fr0,0(%1)	</span><span class="se">\n\t</span><span class="s">&quot;</span>
		      <span class="s">&quot;fldd 0(%1),%%fr0	</span><span class="se">\n\t</span><span class="s">&quot;</span>
		      <span class="o">:</span> <span class="s">&quot;=m&quot;</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;r0&quot;</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s      VZOUICununcqcqcqcqcqcrmunTDVZOUI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
	<span class="n">printbinary</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">sw</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%sFPSR: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%sFPER1: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">sw</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="cm">/* here we&#39;ll print fr0 again, tho it&#39;ll be meaningless */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">PRINTREGS</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">fr</span><span class="p">,</span> <span class="s">&quot;fr&quot;</span><span class="p">,</span> <span class="n">FFMT</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">show_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">user</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">level</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cr30</span><span class="p">,</span> <span class="n">cr31</span><span class="p">;</span>

	<span class="n">user</span> <span class="o">=</span> <span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
	<span class="n">level</span> <span class="o">=</span> <span class="n">user</span> <span class="o">?</span> <span class="n">KERN_DEBUG</span> <span class="o">:</span> <span class="n">KERN_CRIT</span><span class="p">;</span>

	<span class="n">print_gr</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">PRINTREGS</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">sr</span><span class="p">,</span> <span class="s">&quot;sr&quot;</span><span class="p">,</span> <span class="n">RFMT</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">user</span><span class="p">)</span>
		<span class="n">print_fr</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>

	<span class="n">cr30</span> <span class="o">=</span> <span class="n">mfctl</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>
	<span class="n">cr31</span> <span class="o">=</span> <span class="n">mfctl</span><span class="p">(</span><span class="mi">31</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%sIASQ: &quot;</span> <span class="n">RFMT</span> <span class="s">&quot; &quot;</span> <span class="n">RFMT</span> <span class="s">&quot; IAOQ: &quot;</span> <span class="n">RFMT</span> <span class="s">&quot; &quot;</span> <span class="n">RFMT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">level</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">iasq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">iasq</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">iaoq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">iaoq</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s IIR: %08lx    ISR: &quot;</span> <span class="n">RFMT</span> <span class="s">&quot;  IOR: &quot;</span> <span class="n">RFMT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">level</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ior</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s CPU: %8d   CR30: &quot;</span> <span class="n">RFMT</span> <span class="s">&quot; CR31: &quot;</span> <span class="n">RFMT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">level</span><span class="p">,</span> <span class="n">current_thread_info</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">,</span> <span class="n">cr30</span><span class="p">,</span> <span class="n">cr31</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s ORIG_R28: &quot;</span> <span class="n">RFMT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">orig_r28</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s IAOQ[0]: &quot;</span> <span class="n">RFMT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">iaoq</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s IAOQ[1]: &quot;</span> <span class="n">RFMT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">iaoq</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s RP(r2): &quot;</span> <span class="n">RFMT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s IAOQ[0]: %pS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">iaoq</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s IAOQ[1]: %pS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">iaoq</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s RP(r2): %pS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

		<span class="n">parisc_show_stack</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">dump_stack</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">show_stack</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dump_stack</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_show_stack</span><span class="p">(</span><span class="k">struct</span> <span class="n">unwind_frame_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;Backtrace:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unwind_once</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ip</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">__kernel_text_address</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot; [&lt;&quot;</span> <span class="n">RFMT</span> <span class="s">&quot;&gt;] %pS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">);</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">parisc_show_stack</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">unwind_frame_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>

	<span class="n">t</span> <span class="o">=</span> <span class="n">task</span> <span class="o">?</span> <span class="n">task</span> <span class="o">:</span> <span class="n">current</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">unwind_frame_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">show_stack</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="n">current</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sp</span><span class="p">;</span>

<span class="nl">HERE:</span>
		<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">&quot;copy %%r30, %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">sp</span><span class="p">));</span>
		<span class="p">{</span>
			<span class="k">struct</span> <span class="n">pt_regs</span> <span class="n">r</span><span class="p">;</span>

			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="p">));</span>
			<span class="n">r</span><span class="p">.</span><span class="n">iaoq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="n">HERE</span><span class="p">;</span>
			<span class="n">r</span><span class="p">.</span><span class="n">gr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">__builtin_return_address</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">r</span><span class="p">.</span><span class="n">gr</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="p">;</span>

			<span class="n">unwind_frame_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">unwind_frame_init_from_blocked_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">show_stack:</span>
	<span class="n">do_show_stack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">show_stack</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">parisc_show_stack</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">is_valid_bugaddr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iaoq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">die_if_kernel</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">long</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span> <span class="cm">/* STFU */</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;%s (pid %d): %s (code %ld) at &quot;</span> <span class="n">RFMT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">task_pid_nr</span><span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="n">str</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">iaoq</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="cp">#ifdef PRINT_USER_FAULTS</span>
		<span class="cm">/* XXX for debugging only */</span>
		<span class="n">show_regs</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">oops_in_progress</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">oops_enter</span><span class="p">();</span>

	<span class="cm">/* Amuse the user in a SPARC fashion */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span>
			<span class="s">&quot;      _______________________________ </span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;     &lt; Your System ate a SPARC! Gah! &gt;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;      ------------------------------- </span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;             </span><span class="se">\\</span><span class="s">   ^__^</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;                 (__)</span><span class="se">\\</span><span class="s">       )</span><span class="se">\\</span><span class="s">/</span><span class="se">\\\n</span><span class="s">&quot;</span>
			<span class="s">&quot;                  U  ||----w |</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;                     ||     ||</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	
	<span class="cm">/* unlock the pdc lock if necessary */</span>
	<span class="n">pdc_emergency_unlock</span><span class="p">();</span>

	<span class="cm">/* maybe the kernel hasn&#39;t booted very far yet and hasn&#39;t been able </span>
<span class="cm">	 * to initialize the serial or STI console. In that case we should </span>
<span class="cm">	 * re-enable the pdc console, so that the user will be able to </span>
<span class="cm">	 * identify the problem. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">console_drivers</span><span class="p">)</span>
		<span class="n">pdc_console_restart</span><span class="p">();</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;%s (pid %d): %s (code %ld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">task_pid_nr</span><span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="n">str</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="cm">/* Wot&#39;s wrong wif bein&#39; racy? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PARISC_KERNEL_DEATH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;%s() recursion detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">local_irq_enable</span><span class="p">();</span>
		<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">PARISC_KERNEL_DEATH</span><span class="p">;</span>

	<span class="n">show_regs</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
	<span class="n">dump_stack</span><span class="p">();</span>
	<span class="n">add_taint</span><span class="p">(</span><span class="n">TAINT_DIE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in_interrupt</span><span class="p">())</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Fatal exception in interrupt&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">panic_on_oops</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;Fatal exception: panic in 5 seconds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ssleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Fatal exception&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">oops_exit</span><span class="p">();</span>
	<span class="n">do_exit</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">syscall_ipi</span><span class="p">(</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">syscall</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">),</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">syscall</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* gdb uses break 4,8 */</span>
<span class="cp">#define GDB_BREAK_INSN 0x10004</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_gdb_break</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">siginfo</span> <span class="n">si</span><span class="p">;</span>

	<span class="n">si</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGTRAP</span><span class="p">;</span>
	<span class="n">si</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">si</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">wot</span><span class="p">;</span>
	<span class="n">si</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iaoq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">);</span>
	<span class="n">force_sig_info</span><span class="p">(</span><span class="n">SIGTRAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_break</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">iir</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">iir</span> <span class="o">==</span> <span class="n">PARISC_BUG_BREAK_INSN</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* check if a BUG() or WARN() trapped here.  */</span>
		<span class="k">enum</span> <span class="n">bug_trap_type</span> <span class="n">tt</span><span class="p">;</span>
		<span class="n">tt</span> <span class="o">=</span> <span class="n">report_bug</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iaoq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tt</span> <span class="o">==</span> <span class="n">BUG_TRAP_TYPE_WARN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">iaoq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">iaoq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span> <span class="cm">/* return to next instruction when WARN_ON().  */</span>
		<span class="p">}</span>
		<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;Unknown kernel breakpoint&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span>
			<span class="p">(</span><span class="n">tt</span> <span class="o">==</span> <span class="n">BUG_TRAP_TYPE_NONE</span><span class="p">)</span> <span class="o">?</span> <span class="mi">9</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef PRINT_USER_FAULTS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">iir</span> <span class="o">!=</span> <span class="n">GDB_BREAK_INSN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;break %d,%d: pid=%d command=&#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">iir</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">,</span> <span class="p">(</span><span class="n">iir</span><span class="o">&gt;&gt;</span><span class="mi">13</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">13</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
			<span class="n">task_pid_nr</span><span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">);</span>
		<span class="n">show_regs</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* send standard GDB signal */</span>
	<span class="n">handle_gdb_break</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">TRAP_BRKPT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">default_trap</span><span class="p">(</span><span class="kt">int</span> <span class="n">code</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Trap %d on CPU %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">());</span>
	<span class="n">show_regs</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">cpu_lpmc</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span> <span class="n">code</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="n">default_trap</span><span class="p">;</span>


<span class="kt">void</span> <span class="nf">transfer_pim_to_trap_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">register</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hpmc_pim_data</span><span class="p">[];</span>
    <span class="k">struct</span> <span class="n">pdc_hpmc_pim_11</span> <span class="o">*</span><span class="n">pim_narrow</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">pdc_hpmc_pim_20</span> <span class="o">*</span><span class="n">pim_wide</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">cpu_type</span> <span class="o">&gt;=</span> <span class="n">pcxu</span><span class="p">)</span> <span class="p">{</span>

	<span class="n">pim_wide</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pdc_hpmc_pim_20</span> <span class="o">*</span><span class="p">)</span><span class="n">hpmc_pim_data</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Note: The following code will probably generate a</span>
<span class="cm">	 * bunch of truncation error warnings from the compiler.</span>
<span class="cm">	 * Could be handled with an ifdef, but perhaps there</span>
<span class="cm">	 * is a better way.</span>
<span class="cm">	 */</span>

	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pim_wide</span><span class="o">-&gt;</span><span class="n">cr</span><span class="p">[</span><span class="mi">22</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	    <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pim_wide</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	    <span class="n">regs</span><span class="o">-&gt;</span><span class="n">fr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pim_wide</span><span class="o">-&gt;</span><span class="n">fr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	    <span class="n">regs</span><span class="o">-&gt;</span><span class="n">sr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pim_wide</span><span class="o">-&gt;</span><span class="n">sr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">iasq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pim_wide</span><span class="o">-&gt;</span><span class="n">cr</span><span class="p">[</span><span class="mi">17</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">iasq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pim_wide</span><span class="o">-&gt;</span><span class="n">iasq_back</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">iaoq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pim_wide</span><span class="o">-&gt;</span><span class="n">cr</span><span class="p">[</span><span class="mi">18</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">iaoq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pim_wide</span><span class="o">-&gt;</span><span class="n">iaoq_back</span><span class="p">;</span>

	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">sar</span>  <span class="o">=</span> <span class="n">pim_wide</span><span class="o">-&gt;</span><span class="n">cr</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span>  <span class="o">=</span> <span class="n">pim_wide</span><span class="o">-&gt;</span><span class="n">cr</span><span class="p">[</span><span class="mi">19</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">isr</span>  <span class="o">=</span> <span class="n">pim_wide</span><span class="o">-&gt;</span><span class="n">cr</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">ior</span>  <span class="o">=</span> <span class="n">pim_wide</span><span class="o">-&gt;</span><span class="n">cr</span><span class="p">[</span><span class="mi">21</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
	<span class="n">pim_narrow</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pdc_hpmc_pim_11</span> <span class="o">*</span><span class="p">)</span><span class="n">hpmc_pim_data</span><span class="p">;</span>

	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pim_narrow</span><span class="o">-&gt;</span><span class="n">cr</span><span class="p">[</span><span class="mi">22</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	    <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pim_narrow</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	    <span class="n">regs</span><span class="o">-&gt;</span><span class="n">fr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pim_narrow</span><span class="o">-&gt;</span><span class="n">fr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	    <span class="n">regs</span><span class="o">-&gt;</span><span class="n">sr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pim_narrow</span><span class="o">-&gt;</span><span class="n">sr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">iasq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pim_narrow</span><span class="o">-&gt;</span><span class="n">cr</span><span class="p">[</span><span class="mi">17</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">iasq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pim_narrow</span><span class="o">-&gt;</span><span class="n">iasq_back</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">iaoq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pim_narrow</span><span class="o">-&gt;</span><span class="n">cr</span><span class="p">[</span><span class="mi">18</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">iaoq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pim_narrow</span><span class="o">-&gt;</span><span class="n">iaoq_back</span><span class="p">;</span>

	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">sar</span>  <span class="o">=</span> <span class="n">pim_narrow</span><span class="o">-&gt;</span><span class="n">cr</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span>  <span class="o">=</span> <span class="n">pim_narrow</span><span class="o">-&gt;</span><span class="n">cr</span><span class="p">[</span><span class="mi">19</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">isr</span>  <span class="o">=</span> <span class="n">pim_narrow</span><span class="o">-&gt;</span><span class="n">cr</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">ior</span>  <span class="o">=</span> <span class="n">pim_narrow</span><span class="o">-&gt;</span><span class="n">cr</span><span class="p">[</span><span class="mi">21</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="cm">/*</span>
<span class="cm">     * The following fields only have meaning if we came through</span>
<span class="cm">     * another path. So just zero them here.</span>
<span class="cm">     */</span>

    <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ksp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">regs</span><span class="o">-&gt;</span><span class="n">kpc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">regs</span><span class="o">-&gt;</span><span class="n">orig_r28</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * This routine is called as a last resort when everything else</span>
<span class="cm"> * has gone clearly wrong. We get called for faults in kernel space,</span>
<span class="cm"> * and HPMC&#39;s.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">parisc_terminate</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">code</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">terminate_lock</span><span class="p">);</span>

	<span class="n">oops_in_progress</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">set_eiem</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">local_irq_disable</span><span class="p">();</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">terminate_lock</span><span class="p">);</span>

	<span class="cm">/* unlock the pdc lock if necessary */</span>
	<span class="n">pdc_emergency_unlock</span><span class="p">();</span>

	<span class="cm">/* restart pdc console if necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">console_drivers</span><span class="p">)</span>
		<span class="n">pdc_console_restart</span><span class="p">();</span>

	<span class="cm">/* Not all paths will gutter the processor... */</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">code</span><span class="p">){</span>

	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">transfer_pim_to_trap_frame</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* Fall through */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>
	    
	<span class="p">{</span>
		<span class="cm">/* show_stack(NULL, (unsigned long *)regs-&gt;gr[30]); */</span>
		<span class="k">struct</span> <span class="n">unwind_frame_info</span> <span class="n">info</span><span class="p">;</span>
		<span class="n">unwind_frame_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="n">do_show_stack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;%s: Code=%d regs=%p (Addr=&quot;</span> <span class="n">RFMT</span> <span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">msg</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">show_regs</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">terminate_lock</span><span class="p">);</span>

	<span class="cm">/* put soft power button back under hardware control;</span>
<span class="cm">	 * if the user had pressed it once at any time, the </span>
<span class="cm">	 * system will shut down immediately right here. */</span>
	<span class="n">pdc_soft_power_button</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	
	<span class="cm">/* Call kernel panic() so reboot timeouts work properly </span>
<span class="cm">	 * FIXME: This function should be on the list of</span>
<span class="cm">	 * panic notifiers, and we should call panic</span>
<span class="cm">	 * directly from the location that we wish. </span>
<span class="cm">	 * e.g. We should not call panic from</span>
<span class="cm">	 * parisc_terminate, but rather the oter way around.</span>
<span class="cm">	 * This hack works, prints the panic message twice,</span>
<span class="cm">	 * and it enables reboot timers!</span>
<span class="cm">	 */</span>
	<span class="n">panic</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">notrace</span> <span class="nf">handle_interruption</span><span class="p">(</span><span class="kt">int</span> <span class="n">code</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fault_address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fault_space</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siginfo</span> <span class="n">si</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
	    <span class="n">pdc_console_restart</span><span class="p">();</span>  <span class="cm">/* switch back to pdc if HPMC */</span>
	<span class="k">else</span>
	    <span class="n">local_irq_enable</span><span class="p">();</span>

	<span class="cm">/* Security check:</span>
<span class="cm">	 * If the priority level is still user, and the</span>
<span class="cm">	 * faulting space is not equal to the active space</span>
<span class="cm">	 * then the user is attempting something in a space</span>
<span class="cm">	 * that does not belong to them. Kill the process.</span>
<span class="cm">	 *</span>
<span class="cm">	 * This is normally the situation when the user</span>
<span class="cm">	 * attempts to jump into the kernel space at the</span>
<span class="cm">	 * wrong offset, be it at the gateway page or a</span>
<span class="cm">	 * random location.</span>
<span class="cm">	 *</span>
<span class="cm">	 * We cannot normally signal the process because it</span>
<span class="cm">	 * could *be* on the gateway page, and processes</span>
<span class="cm">	 * executing on the gateway page can&#39;t have signals</span>
<span class="cm">	 * delivered.</span>
<span class="cm">	 * </span>
<span class="cm">	 * We merely readjust the address into the users</span>
<span class="cm">	 * space, at a destination address of zero, and</span>
<span class="cm">	 * allow processing to continue.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iaoq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iasq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sr</span><span class="p">[</span><span class="mi">7</span><span class="p">]))</span> <span class="p">{</span> 
	  	<span class="cm">/* Kill the user process later */</span>
	  	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">iaoq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">|</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">iaoq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">iaoq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	 	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">iasq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">iasq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">sr</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PSW_B</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	printk(KERN_CRIT &quot;Interruption # %d\n&quot;, code);</span>
<span class="cp">#endif</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span>  <span class="mi">1</span>:
		<span class="cm">/* High-priority machine check (HPMC) */</span>
		
		<span class="cm">/* set up a new led state on systems shipped with a LED State panel */</span>
		<span class="n">pdc_chassis_send_status</span><span class="p">(</span><span class="n">PDC_CHASSIS_DIRECT_HPMC</span><span class="p">);</span>
		    
	    	<span class="n">parisc_terminate</span><span class="p">(</span><span class="s">&quot;High Priority Machine Check (HPMC)&quot;</span><span class="p">,</span>
				<span class="n">regs</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* NOT REACHED */</span>
		
	<span class="k">case</span>  <span class="mi">2</span>:
		<span class="cm">/* Power failure interrupt */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;Power failure interrupt !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span>  <span class="mi">3</span>:
		<span class="cm">/* Recovery counter trap */</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PSW_R</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">user_space</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span>
			<span class="n">handle_gdb_break</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">TRAP_TRACE</span><span class="p">);</span>
		<span class="cm">/* else this must be the start of a syscall - just let it run */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span>  <span class="mi">5</span>:
		<span class="cm">/* Low-priority machine check */</span>
		<span class="n">pdc_chassis_send_status</span><span class="p">(</span><span class="n">PDC_CHASSIS_DIRECT_LPMC</span><span class="p">);</span>
		
		<span class="n">flush_cache_all</span><span class="p">();</span>
		<span class="n">flush_tlb_all</span><span class="p">();</span>
		<span class="n">cpu_lpmc</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span>  <span class="mi">6</span>:
		<span class="cm">/* Instruction TLB miss fault/Instruction page fault */</span>
		<span class="n">fault_address</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">iaoq</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">fault_space</span>   <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">iasq</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span>  <span class="mi">8</span>:
		<span class="cm">/* Illegal instruction trap */</span>
		<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;Illegal instruction&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">code</span><span class="p">);</span>
		<span class="n">si</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">ILL_ILLOPC</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">give_sigill</span><span class="p">;</span>

	<span class="k">case</span>  <span class="mi">9</span>:
		<span class="cm">/* Break instruction trap */</span>
		<span class="n">handle_break</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	
	<span class="k">case</span> <span class="mi">10</span>:
		<span class="cm">/* Privileged operation trap */</span>
		<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;Privileged operation&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">code</span><span class="p">);</span>
		<span class="n">si</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">ILL_PRVOPC</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">give_sigill</span><span class="p">;</span>
	
	<span class="k">case</span> <span class="mi">11</span>:
		<span class="cm">/* Privileged register trap */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="mh">0xffdfffe0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x034008a0</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* This is a MFCTL cr26/cr27 to gr instruction.</span>
<span class="cm">			 * PCXS traps on this, so we need to emulate it.</span>
<span class="cm">			 */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="mh">0x00200000</span><span class="p">)</span>
				<span class="n">regs</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">]</span> <span class="o">=</span> <span class="n">mfctl</span><span class="p">(</span><span class="mi">27</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">regs</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">]</span> <span class="o">=</span> <span class="n">mfctl</span><span class="p">(</span><span class="mi">26</span><span class="p">);</span>

			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">iaoq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">iaoq</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">iaoq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">iasq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">iasq</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;Privileged register usage&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">code</span><span class="p">);</span>
		<span class="n">si</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">ILL_PRVREG</span><span class="p">;</span>
	<span class="nl">give_sigill:</span>
		<span class="n">si</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGILL</span><span class="p">;</span>
		<span class="n">si</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">si</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">iaoq</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">force_sig_info</span><span class="p">(</span><span class="n">SIGILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">12</span>:
		<span class="cm">/* Overflow Trap, let the userland signal handler do the cleanup */</span>
		<span class="n">si</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGFPE</span><span class="p">;</span>
		<span class="n">si</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">FPE_INTOVF</span><span class="p">;</span>
		<span class="n">si</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">iaoq</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">force_sig_info</span><span class="p">(</span><span class="n">SIGFPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
		
	<span class="k">case</span> <span class="mi">13</span>:
		<span class="cm">/* Conditional Trap</span>
<span class="cm">		   The condition succeeds in an instruction which traps</span>
<span class="cm">		   on condition  */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">)){</span>
			<span class="n">si</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGFPE</span><span class="p">;</span>
			<span class="cm">/* Set to zero, and let the userspace app figure it out from</span>
<span class="cm">		   	   the insn pointed to by si_addr */</span>
			<span class="n">si</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">si</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">iaoq</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">force_sig_info</span><span class="p">(</span><span class="n">SIGFPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> 
		<span class="cm">/* The kernel doesn&#39;t want to handle condition codes */</span>
		<span class="k">break</span><span class="p">;</span>
		
	<span class="k">case</span> <span class="mi">14</span>:
		<span class="cm">/* Assist Exception Trap, i.e. floating point exception. */</span>
		<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;Floating point exception&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* quiet */</span>
		<span class="n">handle_fpe</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
		
	<span class="k">case</span> <span class="mi">15</span>:
		<span class="cm">/* Data TLB miss fault/Data page fault */</span>
		<span class="cm">/* Fall through */</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="cm">/* Non-access instruction TLB miss fault */</span>
		<span class="cm">/* The instruction TLB entry needed for the target address of the FIC</span>
<span class="cm">		   is absent, and hardware can&#39;t find it, so we get to cleanup */</span>
		<span class="cm">/* Fall through */</span>
	<span class="k">case</span> <span class="mi">17</span>:
		<span class="cm">/* Non-access data TLB miss fault/Non-access data page fault */</span>
		<span class="cm">/* FIXME: </span>
<span class="cm">		 	 Still need to add slow path emulation code here!</span>
<span class="cm">		         If the insn used a non-shadow register, then the tlb</span>
<span class="cm">			 handlers could not have their side-effect (e.g. probe</span>
<span class="cm">			 writing to a target register) emulated since rfir would</span>
<span class="cm">			 erase the changes to said register. Instead we have to</span>
<span class="cm">			 setup everything, call this function we are in, and emulate</span>
<span class="cm">			 by hand. Technically we need to emulate:</span>
<span class="cm">			 fdc,fdce,pdc,&quot;fic,4f&quot;,prober,probeir,probew, probeiw</span>
<span class="cm">		*/</span>			  
		<span class="n">fault_address</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ior</span><span class="p">;</span>
		<span class="n">fault_space</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">18</span>:
		<span class="cm">/* PCXS only -- later cpu&#39;s split this into types 26,27 &amp; 28 */</span>
		<span class="cm">/* Check for unaligned access */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_unaligned</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">handle_unaligned</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Fall Through */</span>
	<span class="k">case</span> <span class="mi">26</span>: 
		<span class="cm">/* PCXL: Data memory access rights trap */</span>
		<span class="n">fault_address</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ior</span><span class="p">;</span>
		<span class="n">fault_space</span>   <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">19</span>:
		<span class="cm">/* Data memory break trap */</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">PSW_X</span><span class="p">;</span> <span class="cm">/* So we can single-step over the trap */</span>
		<span class="cm">/* fall thru */</span>
	<span class="k">case</span> <span class="mi">21</span>:
		<span class="cm">/* Page reference trap */</span>
		<span class="n">handle_gdb_break</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">TRAP_HWBKPT</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">25</span>:
		<span class="cm">/* Taken branch trap */</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PSW_T</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">user_space</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span>
			<span class="n">handle_gdb_break</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">TRAP_BRANCH</span><span class="p">);</span>
		<span class="cm">/* else this must be the start of a syscall - just let it</span>
<span class="cm">		 * run.</span>
<span class="cm">		 */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span>  <span class="mi">7</span>:  
		<span class="cm">/* Instruction access rights */</span>
		<span class="cm">/* PCXL: Instruction memory protection trap */</span>

		<span class="cm">/*</span>
<span class="cm">		 * This could be caused by either: 1) a process attempting</span>
<span class="cm">		 * to execute within a vma that does not have execute</span>
<span class="cm">		 * permission, or 2) an access rights violation caused by a</span>
<span class="cm">		 * flush only translation set up by ptep_get_and_clear().</span>
<span class="cm">		 * So we check the vma permissions to differentiate the two.</span>
<span class="cm">		 * If the vma indicates we have execute permission, then</span>
<span class="cm">		 * the cause is the latter one. In this case, we need to</span>
<span class="cm">		 * call do_page_fault() to fix the problem.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">;</span>

			<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>
			<span class="n">vma</span> <span class="o">=</span> <span class="n">find_vma</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">,</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iaoq</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vma</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iaoq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">&amp;</span> <span class="n">VM_EXEC</span><span class="p">))</span> <span class="p">{</span>

				<span class="n">fault_address</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">iaoq</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="n">fault_space</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">iasq</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

				<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span> <span class="cm">/* call do_page_fault() */</span>
			<span class="p">}</span>
			<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Fall Through */</span>
	<span class="k">case</span> <span class="mi">27</span>: 
		<span class="cm">/* Data memory protection ID trap */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="mi">27</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">fixup_exception</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;Protection id trap&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">code</span><span class="p">);</span>
		<span class="n">si</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">SEGV_MAPERR</span><span class="p">;</span>
		<span class="n">si</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGSEGV</span><span class="p">;</span>
		<span class="n">si</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span>
		    <span class="n">si</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">iaoq</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">else</span>
		    <span class="n">si</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ior</span><span class="p">;</span>
		<span class="n">force_sig_info</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">28</span>: 
		<span class="cm">/* Unaligned data reference trap */</span>
		<span class="n">handle_unaligned</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef PRINT_USER_FAULTS</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">handle_interruption() pid=%d command=&#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">task_pid_nr</span><span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">);</span>
			<span class="n">show_regs</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="cm">/* SIGBUS, for lack of a better one. */</span>
			<span class="n">si</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGBUS</span><span class="p">;</span>
			<span class="n">si</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">BUS_OBJERR</span><span class="p">;</span>
			<span class="n">si</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">si</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ior</span><span class="p">;</span>
			<span class="n">force_sig_info</span><span class="p">(</span><span class="n">SIGBUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pdc_chassis_send_status</span><span class="p">(</span><span class="n">PDC_CHASSIS_DIRECT_PANIC</span><span class="p">);</span>
		
		<span class="n">parisc_terminate</span><span class="p">(</span><span class="s">&quot;Unexpected interruption&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* NOT REACHED */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">((</span><span class="n">fault_space</span> <span class="o">&gt;&gt;</span> <span class="n">SPACEID_SHIFT</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">sr</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">SPACEID_SHIFT</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef PRINT_USER_FAULTS</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fault_space</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;User Fault on Kernel Space &quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;User Fault (long pointer) (fault %d) &quot;</span><span class="p">,</span>
			       <span class="n">code</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;pid=%d command=&#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">task_pid_nr</span><span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">);</span>
		<span class="n">show_regs</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">si</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGSEGV</span><span class="p">;</span>
		<span class="n">si</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">si</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">SEGV_MAPERR</span><span class="p">;</span>
		<span class="n">si</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ior</span><span class="p">;</span>
		<span class="n">force_sig_info</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>

	    <span class="cm">/*</span>
<span class="cm">	     * The kernel should never fault on its own address space.</span>
<span class="cm">	     */</span>

	    <span class="k">if</span> <span class="p">(</span><span class="n">fault_space</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> 
	    <span class="p">{</span>
		<span class="n">pdc_chassis_send_status</span><span class="p">(</span><span class="n">PDC_CHASSIS_DIRECT_PANIC</span><span class="p">);</span>
		<span class="n">parisc_terminate</span><span class="p">(</span><span class="s">&quot;Kernel Fault&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">fault_address</span><span class="p">);</span>
	
	    <span class="p">}</span>
	<span class="p">}</span>

	<span class="n">do_page_fault</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">fault_address</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="n">__init</span> <span class="nf">check_ivt</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">iva</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">extern</span> <span class="n">u32</span> <span class="n">os_hpmc_size</span><span class="p">;</span>
	<span class="k">extern</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">os_hpmc</span><span class="p">[];</span>

	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">ivap</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">hpmcp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">length</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">iva</span><span class="p">,</span> <span class="s">&quot;cows can fly&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">ivap</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">iva</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	    <span class="o">*</span><span class="n">ivap</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Compute Checksum for HPMC handler */</span>
	<span class="n">length</span> <span class="o">=</span> <span class="n">os_hpmc_size</span><span class="p">;</span>
	<span class="n">ivap</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>

	<span class="n">hpmcp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">os_hpmc</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">length</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	    <span class="n">check</span> <span class="o">+=</span> <span class="o">*</span><span class="n">hpmcp</span><span class="o">++</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	    <span class="n">check</span> <span class="o">+=</span> <span class="n">ivap</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="n">ivap</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">check</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
	
<span class="cp">#ifndef CONFIG_64BIT</span>
<span class="k">extern</span> <span class="k">const</span> <span class="kt">void</span> <span class="n">fault_vector_11</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="k">extern</span> <span class="k">const</span> <span class="kt">void</span> <span class="n">fault_vector_20</span><span class="p">;</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">trap_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">iva</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">cpu_type</span> <span class="o">&gt;=</span> <span class="n">pcxu</span><span class="p">)</span>
		<span class="n">iva</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">fault_vector_20</span><span class="p">;</span>
	<span class="k">else</span>
<span class="cp">#ifdef CONFIG_64BIT</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Can&#39;t boot 64-bit OS on PA1.1 processor!&quot;</span><span class="p">);</span>
<span class="cp">#else</span>
		<span class="n">iva</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">fault_vector_11</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_ivt</span><span class="p">(</span><span class="n">iva</span><span class="p">))</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;IVT invalid&quot;</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
