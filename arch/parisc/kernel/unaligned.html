<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › parisc › kernel › unaligned.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>unaligned.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *    Unaligned memory access handler</span>
<span class="cm"> *</span>
<span class="cm"> *    Copyright (C) 2001 Randolph Chung &lt;tausq@debian.org&gt;</span>
<span class="cm"> *    Significantly tweaked by LaMont Jones &lt;lamont@debian.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *    This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *    it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *    the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm"> *    any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *    This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *    GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *    You should have received a copy of the GNU General Public License</span>
<span class="cm"> *    along with this program; if not, write to the Free Software</span>
<span class="cm"> *    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/signal.h&gt;</span>
<span class="cp">#include &lt;linux/ratelimit.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cm">/* #define DEBUG_UNALIGNED 1 */</span>

<span class="cp">#ifdef DEBUG_UNALIGNED</span>
<span class="cp">#define DPRINTF(fmt, args...) do { printk(KERN_DEBUG &quot;%s:%d:%s &quot;, __FILE__, __LINE__, __func__ ); printk(KERN_DEBUG fmt, ##args ); } while (0)</span>
<span class="cp">#else</span>
<span class="cp">#define DPRINTF(fmt, args...)</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_64BIT</span>
<span class="cp">#define RFMT &quot;%016lx&quot;</span>
<span class="cp">#else</span>
<span class="cp">#define RFMT &quot;%08lx&quot;</span>
<span class="cp">#endif</span>

<span class="cp">#define FIXUP_BRANCH(lbl) \</span>
<span class="cp">	&quot;\tldil L%%&quot; #lbl &quot;, %%r1\n&quot;			\</span>
<span class="cp">	&quot;\tldo R%%&quot; #lbl &quot;(%%r1), %%r1\n&quot;		\</span>
<span class="cp">	&quot;\tbv,n %%r0(%%r1)\n&quot;</span>
<span class="cm">/* If you use FIXUP_BRANCH, then you must list this clobber */</span>
<span class="cp">#define FIXUP_BRANCH_CLOBBER &quot;r1&quot;</span>

<span class="cm">/* 1111 1100 0000 0000 0001 0011 1100 0000 */</span>
<span class="cp">#define OPCODE1(a,b,c)	((a)&lt;&lt;26|(b)&lt;&lt;12|(c)&lt;&lt;6) </span>
<span class="cp">#define OPCODE2(a,b)	((a)&lt;&lt;26|(b)&lt;&lt;1)</span>
<span class="cp">#define OPCODE3(a,b)	((a)&lt;&lt;26|(b)&lt;&lt;2)</span>
<span class="cp">#define OPCODE4(a)	((a)&lt;&lt;26)</span>
<span class="cp">#define OPCODE1_MASK	OPCODE1(0x3f,1,0xf)</span>
<span class="cp">#define OPCODE2_MASK 	OPCODE2(0x3f,1)</span>
<span class="cp">#define OPCODE3_MASK	OPCODE3(0x3f,1)</span>
<span class="cp">#define OPCODE4_MASK    OPCODE4(0x3f)</span>

<span class="cm">/* skip LDB - never unaligned (index) */</span>
<span class="cp">#define OPCODE_LDH_I	OPCODE1(0x03,0,0x1)</span>
<span class="cp">#define OPCODE_LDW_I	OPCODE1(0x03,0,0x2)</span>
<span class="cp">#define OPCODE_LDD_I	OPCODE1(0x03,0,0x3)</span>
<span class="cp">#define OPCODE_LDDA_I	OPCODE1(0x03,0,0x4)</span>
<span class="cp">#define OPCODE_LDCD_I	OPCODE1(0x03,0,0x5)</span>
<span class="cp">#define OPCODE_LDWA_I	OPCODE1(0x03,0,0x6)</span>
<span class="cp">#define OPCODE_LDCW_I	OPCODE1(0x03,0,0x7)</span>
<span class="cm">/* skip LDB - never unaligned (short) */</span>
<span class="cp">#define OPCODE_LDH_S	OPCODE1(0x03,1,0x1)</span>
<span class="cp">#define OPCODE_LDW_S	OPCODE1(0x03,1,0x2)</span>
<span class="cp">#define OPCODE_LDD_S	OPCODE1(0x03,1,0x3)</span>
<span class="cp">#define OPCODE_LDDA_S	OPCODE1(0x03,1,0x4)</span>
<span class="cp">#define OPCODE_LDCD_S	OPCODE1(0x03,1,0x5)</span>
<span class="cp">#define OPCODE_LDWA_S	OPCODE1(0x03,1,0x6)</span>
<span class="cp">#define OPCODE_LDCW_S	OPCODE1(0x03,1,0x7)</span>
<span class="cm">/* skip STB - never unaligned */</span>
<span class="cp">#define OPCODE_STH	OPCODE1(0x03,1,0x9)</span>
<span class="cp">#define OPCODE_STW	OPCODE1(0x03,1,0xa)</span>
<span class="cp">#define OPCODE_STD	OPCODE1(0x03,1,0xb)</span>
<span class="cm">/* skip STBY - never unaligned */</span>
<span class="cm">/* skip STDBY - never unaligned */</span>
<span class="cp">#define OPCODE_STWA	OPCODE1(0x03,1,0xe)</span>
<span class="cp">#define OPCODE_STDA	OPCODE1(0x03,1,0xf)</span>

<span class="cp">#define OPCODE_FLDWX	OPCODE1(0x09,0,0x0)</span>
<span class="cp">#define OPCODE_FLDWXR	OPCODE1(0x09,0,0x1)</span>
<span class="cp">#define OPCODE_FSTWX	OPCODE1(0x09,0,0x8)</span>
<span class="cp">#define OPCODE_FSTWXR	OPCODE1(0x09,0,0x9)</span>
<span class="cp">#define OPCODE_FLDWS	OPCODE1(0x09,1,0x0)</span>
<span class="cp">#define OPCODE_FLDWSR	OPCODE1(0x09,1,0x1)</span>
<span class="cp">#define OPCODE_FSTWS	OPCODE1(0x09,1,0x8)</span>
<span class="cp">#define OPCODE_FSTWSR	OPCODE1(0x09,1,0x9)</span>
<span class="cp">#define OPCODE_FLDDX	OPCODE1(0x0b,0,0x0)</span>
<span class="cp">#define OPCODE_FSTDX	OPCODE1(0x0b,0,0x8)</span>
<span class="cp">#define OPCODE_FLDDS	OPCODE1(0x0b,1,0x0)</span>
<span class="cp">#define OPCODE_FSTDS	OPCODE1(0x0b,1,0x8)</span>

<span class="cp">#define OPCODE_LDD_L	OPCODE2(0x14,0)</span>
<span class="cp">#define OPCODE_FLDD_L	OPCODE2(0x14,1)</span>
<span class="cp">#define OPCODE_STD_L	OPCODE2(0x1c,0)</span>
<span class="cp">#define OPCODE_FSTD_L	OPCODE2(0x1c,1)</span>

<span class="cp">#define OPCODE_LDW_M	OPCODE3(0x17,1)</span>
<span class="cp">#define OPCODE_FLDW_L	OPCODE3(0x17,0)</span>
<span class="cp">#define OPCODE_FSTW_L	OPCODE3(0x1f,0)</span>
<span class="cp">#define OPCODE_STW_M	OPCODE3(0x1f,1)</span>

<span class="cp">#define OPCODE_LDH_L    OPCODE4(0x11)</span>
<span class="cp">#define OPCODE_LDW_L    OPCODE4(0x12)</span>
<span class="cp">#define OPCODE_LDWM     OPCODE4(0x13)</span>
<span class="cp">#define OPCODE_STH_L    OPCODE4(0x19)</span>
<span class="cp">#define OPCODE_STW_L    OPCODE4(0x1A)</span>
<span class="cp">#define OPCODE_STWM     OPCODE4(0x1B)</span>

<span class="cp">#define MAJOR_OP(i) (((i)&gt;&gt;26)&amp;0x3f)</span>
<span class="cp">#define R1(i) (((i)&gt;&gt;21)&amp;0x1f)</span>
<span class="cp">#define R2(i) (((i)&gt;&gt;16)&amp;0x1f)</span>
<span class="cp">#define R3(i) ((i)&amp;0x1f)</span>
<span class="cp">#define FR3(i) ((((i)&lt;&lt;1)&amp;0x1f)|(((i)&gt;&gt;6)&amp;1))</span>
<span class="cp">#define IM(i,n) (((i)&gt;&gt;1&amp;((1&lt;&lt;(n-1))-1))|((i)&amp;1?((0-1L)&lt;&lt;(n-1)):0))</span>
<span class="cp">#define IM5_2(i) IM((i)&gt;&gt;16,5)</span>
<span class="cp">#define IM5_3(i) IM((i),5)</span>
<span class="cp">#define IM14(i) IM((i),14)</span>

<span class="cp">#define ERR_NOTHANDLED	-1</span>
<span class="cp">#define ERR_PAGEFAULT	-2</span>

<span class="kt">int</span> <span class="n">unaligned_enabled</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="kt">void</span> <span class="n">die_if_kernel</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">long</span> <span class="n">err</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emulate_ldh</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">toreg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">saddr</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ior</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">DPRINTF</span><span class="p">(</span><span class="s">&quot;load &quot;</span> <span class="n">RFMT</span> <span class="s">&quot;:&quot;</span> <span class="n">RFMT</span> <span class="s">&quot; to r%d for 2 bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ior</span><span class="p">,</span> <span class="n">toreg</span><span class="p">);</span>

	<span class="n">__asm__</span> <span class="n">__volatile__</span>  <span class="p">(</span>
<span class="s">&quot;	mtsp	%4, %%sr1</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;1:	ldbs	0(%%sr1,%3), %%r20</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;2:	ldbs	1(%%sr1,%3), %0</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	depw	%%r20, 23, 24, %0</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	copy	%%r0, %1</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;3:	</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	.section .fixup,</span><span class="se">\&quot;</span><span class="s">ax</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>
<span class="s">&quot;4:	ldi	-2, %1</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">FIXUP_BRANCH</span><span class="p">(</span><span class="mi">3</span><span class="n">b</span><span class="p">)</span>
<span class="s">&quot;	.previous</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">ASM_EXCEPTIONTABLE_ENTRY</span><span class="p">(</span><span class="mi">1</span><span class="n">b</span><span class="p">,</span> <span class="mi">4</span><span class="n">b</span><span class="p">)</span>
	<span class="n">ASM_EXCEPTIONTABLE_ENTRY</span><span class="p">(</span><span class="mi">2</span><span class="n">b</span><span class="p">,</span> <span class="mi">4</span><span class="n">b</span><span class="p">)</span>
	<span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
	<span class="o">:</span> <span class="s">&quot;0&quot;</span> <span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">saddr</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">)</span>
	<span class="o">:</span> <span class="s">&quot;r20&quot;</span><span class="p">,</span> <span class="n">FIXUP_BRANCH_CLOBBER</span> <span class="p">);</span>

	<span class="n">DPRINTF</span><span class="p">(</span><span class="s">&quot;val = 0x&quot;</span> <span class="n">RFMT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">toreg</span><span class="p">)</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="n">toreg</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emulate_ldw</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">toreg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">saddr</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ior</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">DPRINTF</span><span class="p">(</span><span class="s">&quot;load &quot;</span> <span class="n">RFMT</span> <span class="s">&quot;:&quot;</span> <span class="n">RFMT</span> <span class="s">&quot; to r%d for 4 bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ior</span><span class="p">,</span> <span class="n">toreg</span><span class="p">);</span>

	<span class="n">__asm__</span> <span class="n">__volatile__</span>  <span class="p">(</span>
<span class="s">&quot;	zdep	%3,28,2,%%r19</span><span class="se">\n</span><span class="s">&quot;</span>		<span class="cm">/* r19=(ofs&amp;3)*8 */</span>
<span class="s">&quot;	mtsp	%4, %%sr1</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	depw	%%r0,31,2,%3</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;1:	ldw	0(%%sr1,%3),%0</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;2:	ldw	4(%%sr1,%3),%%r20</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	subi	32,%%r19,%%r19</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	mtctl	%%r19,11</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	vshd	%0,%%r20,%0</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	copy	%%r0, %1</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;3:	</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	.section .fixup,</span><span class="se">\&quot;</span><span class="s">ax</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>
<span class="s">&quot;4:	ldi	-2, %1</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">FIXUP_BRANCH</span><span class="p">(</span><span class="mi">3</span><span class="n">b</span><span class="p">)</span>
<span class="s">&quot;	.previous</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">ASM_EXCEPTIONTABLE_ENTRY</span><span class="p">(</span><span class="mi">1</span><span class="n">b</span><span class="p">,</span> <span class="mi">4</span><span class="n">b</span><span class="p">)</span>
	<span class="n">ASM_EXCEPTIONTABLE_ENTRY</span><span class="p">(</span><span class="mi">2</span><span class="n">b</span><span class="p">,</span> <span class="mi">4</span><span class="n">b</span><span class="p">)</span>
	<span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
	<span class="o">:</span> <span class="s">&quot;0&quot;</span> <span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">saddr</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">)</span>
	<span class="o">:</span> <span class="s">&quot;r19&quot;</span><span class="p">,</span> <span class="s">&quot;r20&quot;</span><span class="p">,</span> <span class="n">FIXUP_BRANCH_CLOBBER</span> <span class="p">);</span>

	<span class="n">DPRINTF</span><span class="p">(</span><span class="s">&quot;val = 0x&quot;</span> <span class="n">RFMT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flop</span><span class="p">)</span>
		<span class="p">((</span><span class="n">__u32</span><span class="o">*</span><span class="p">)(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">fr</span><span class="p">))[</span><span class="n">toreg</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">toreg</span><span class="p">)</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="n">toreg</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emulate_ldd</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">toreg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">saddr</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ior</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">DPRINTF</span><span class="p">(</span><span class="s">&quot;load &quot;</span> <span class="n">RFMT</span> <span class="s">&quot;:&quot;</span> <span class="n">RFMT</span> <span class="s">&quot; to r%d for 8 bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ior</span><span class="p">,</span> <span class="n">toreg</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PA20</span>

<span class="cp">#ifndef CONFIG_64BIT</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flop</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span>  <span class="p">(</span>
<span class="s">&quot;	depd,z	%3,60,3,%%r19</span><span class="se">\n</span><span class="s">&quot;</span>		<span class="cm">/* r19=(ofs&amp;7)*8 */</span>
<span class="s">&quot;	mtsp	%4, %%sr1</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	depd	%%r0,63,3,%3</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;1:	ldd	0(%%sr1,%3),%0</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;2:	ldd	8(%%sr1,%3),%%r20</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	subi	64,%%r19,%%r19</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	mtsar	%%r19</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	shrpd	%0,%%r20,%%sar,%0</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	copy	%%r0, %1</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;3:	</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	.section .fixup,</span><span class="se">\&quot;</span><span class="s">ax</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>
<span class="s">&quot;4:	ldi	-2, %1</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">FIXUP_BRANCH</span><span class="p">(</span><span class="mi">3</span><span class="n">b</span><span class="p">)</span>
<span class="s">&quot;	.previous</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">ASM_EXCEPTIONTABLE_ENTRY</span><span class="p">(</span><span class="mi">1</span><span class="n">b</span><span class="p">,</span><span class="mi">4</span><span class="n">b</span><span class="p">)</span>
	<span class="n">ASM_EXCEPTIONTABLE_ENTRY</span><span class="p">(</span><span class="mi">2</span><span class="n">b</span><span class="p">,</span><span class="mi">4</span><span class="n">b</span><span class="p">)</span>
	<span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
	<span class="o">:</span> <span class="s">&quot;0&quot;</span> <span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">saddr</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">)</span>
	<span class="o">:</span> <span class="s">&quot;r19&quot;</span><span class="p">,</span> <span class="s">&quot;r20&quot;</span><span class="p">,</span> <span class="n">FIXUP_BRANCH_CLOBBER</span> <span class="p">);</span>
<span class="cp">#else</span>
    <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">valh</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">vall</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span>  <span class="p">(</span>
<span class="s">&quot;	zdep	%5,29,2,%%r19</span><span class="se">\n</span><span class="s">&quot;</span>		<span class="cm">/* r19=(ofs&amp;3)*8 */</span>
<span class="s">&quot;	mtsp	%6, %%sr1</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	dep	%%r0,31,2,%5</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;1:	ldw	0(%%sr1,%5),%0</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;2:	ldw	4(%%sr1,%5),%1</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;3:	ldw	8(%%sr1,%5),%%r20</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	subi	32,%%r19,%%r19</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	mtsar	%%r19</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	vshd	%0,%1,%0</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	vshd	%1,%%r20,%1</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	copy	%%r0, %2</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;4:	</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	.section .fixup,</span><span class="se">\&quot;</span><span class="s">ax</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>
<span class="s">&quot;5:	ldi	-2, %2</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">FIXUP_BRANCH</span><span class="p">(</span><span class="mi">4</span><span class="n">b</span><span class="p">)</span>
<span class="s">&quot;	.previous</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">ASM_EXCEPTIONTABLE_ENTRY</span><span class="p">(</span><span class="mi">1</span><span class="n">b</span><span class="p">,</span><span class="mi">5</span><span class="n">b</span><span class="p">)</span>
	<span class="n">ASM_EXCEPTIONTABLE_ENTRY</span><span class="p">(</span><span class="mi">2</span><span class="n">b</span><span class="p">,</span><span class="mi">5</span><span class="n">b</span><span class="p">)</span>
	<span class="n">ASM_EXCEPTIONTABLE_ENTRY</span><span class="p">(</span><span class="mi">3</span><span class="n">b</span><span class="p">,</span><span class="mi">5</span><span class="n">b</span><span class="p">)</span>
	<span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">valh</span><span class="p">),</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">vall</span><span class="p">),</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
	<span class="o">:</span> <span class="s">&quot;0&quot;</span> <span class="p">(</span><span class="n">valh</span><span class="p">),</span> <span class="s">&quot;1&quot;</span> <span class="p">(</span><span class="n">vall</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">saddr</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">)</span>
	<span class="o">:</span> <span class="s">&quot;r19&quot;</span><span class="p">,</span> <span class="s">&quot;r20&quot;</span><span class="p">,</span> <span class="n">FIXUP_BRANCH_CLOBBER</span> <span class="p">);</span>
	<span class="n">val</span><span class="o">=</span><span class="p">((</span><span class="n">__u64</span><span class="p">)</span><span class="n">valh</span><span class="o">&lt;&lt;</span><span class="mi">32</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">__u64</span><span class="p">)</span><span class="n">vall</span><span class="p">;</span>
    <span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">DPRINTF</span><span class="p">(</span><span class="s">&quot;val = 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flop</span><span class="p">)</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">fr</span><span class="p">[</span><span class="n">toreg</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">toreg</span><span class="p">)</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="n">toreg</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emulate_sth</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">frreg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="n">frreg</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">frreg</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DPRINTF</span><span class="p">(</span><span class="s">&quot;store r%d (0x&quot;</span> <span class="n">RFMT</span> <span class="s">&quot;) to &quot;</span> <span class="n">RFMT</span> <span class="s">&quot;:&quot;</span> <span class="n">RFMT</span> <span class="s">&quot; for 2 bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">frreg</span><span class="p">,</span> 
		<span class="n">val</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ior</span><span class="p">);</span>

	<span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span>
<span class="s">&quot;	mtsp %3, %%sr1</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	extrw,u %1, 23, 8, %%r19</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;1:	stb %1, 1(%%sr1, %2)</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;2:	stb %%r19, 0(%%sr1, %2)</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	copy	%%r0, %0</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;3:	</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	.section .fixup,</span><span class="se">\&quot;</span><span class="s">ax</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>
<span class="s">&quot;4:	ldi	-2, %0</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">FIXUP_BRANCH</span><span class="p">(</span><span class="mi">3</span><span class="n">b</span><span class="p">)</span>
<span class="s">&quot;	.previous</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">ASM_EXCEPTIONTABLE_ENTRY</span><span class="p">(</span><span class="mi">1</span><span class="n">b</span><span class="p">,</span><span class="mi">4</span><span class="n">b</span><span class="p">)</span>
	<span class="n">ASM_EXCEPTIONTABLE_ENTRY</span><span class="p">(</span><span class="mi">2</span><span class="n">b</span><span class="p">,</span><span class="mi">4</span><span class="n">b</span><span class="p">)</span>
	<span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
	<span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ior</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">)</span>
	<span class="o">:</span> <span class="s">&quot;r19&quot;</span><span class="p">,</span> <span class="n">FIXUP_BRANCH_CLOBBER</span> <span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emulate_stw</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">frreg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flop</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="n">__u32</span><span class="o">*</span><span class="p">)(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">fr</span><span class="p">))[</span><span class="n">frreg</span><span class="p">];</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">frreg</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="n">frreg</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DPRINTF</span><span class="p">(</span><span class="s">&quot;store r%d (0x&quot;</span> <span class="n">RFMT</span> <span class="s">&quot;) to &quot;</span> <span class="n">RFMT</span> <span class="s">&quot;:&quot;</span> <span class="n">RFMT</span> <span class="s">&quot; for 4 bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">frreg</span><span class="p">,</span> 
		<span class="n">val</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ior</span><span class="p">);</span>


	<span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span>
<span class="s">&quot;	mtsp %3, %%sr1</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	zdep	%2, 28, 2, %%r19</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	dep	%%r0, 31, 2, %2</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	mtsar	%%r19</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	depwi,z	-2, %%sar, 32, %%r19</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;1:	ldw	0(%%sr1,%2),%%r20</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;2:	ldw	4(%%sr1,%2),%%r21</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	vshd	%%r0, %1, %%r22</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	vshd	%1, %%r0, %%r1</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	and	%%r20, %%r19, %%r20</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	andcm	%%r21, %%r19, %%r21</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	or	%%r22, %%r20, %%r20</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	or	%%r1, %%r21, %%r21</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	stw	%%r20,0(%%sr1,%2)</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	stw	%%r21,4(%%sr1,%2)</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	copy	%%r0, %0</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;3:	</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	.section .fixup,</span><span class="se">\&quot;</span><span class="s">ax</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>
<span class="s">&quot;4:	ldi	-2, %0</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">FIXUP_BRANCH</span><span class="p">(</span><span class="mi">3</span><span class="n">b</span><span class="p">)</span>
<span class="s">&quot;	.previous</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">ASM_EXCEPTIONTABLE_ENTRY</span><span class="p">(</span><span class="mi">1</span><span class="n">b</span><span class="p">,</span><span class="mi">4</span><span class="n">b</span><span class="p">)</span>
	<span class="n">ASM_EXCEPTIONTABLE_ENTRY</span><span class="p">(</span><span class="mi">2</span><span class="n">b</span><span class="p">,</span><span class="mi">4</span><span class="n">b</span><span class="p">)</span>
	<span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
	<span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ior</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">)</span>
	<span class="o">:</span> <span class="s">&quot;r19&quot;</span><span class="p">,</span> <span class="s">&quot;r20&quot;</span><span class="p">,</span> <span class="s">&quot;r21&quot;</span><span class="p">,</span> <span class="s">&quot;r22&quot;</span><span class="p">,</span> <span class="s">&quot;r1&quot;</span><span class="p">,</span> <span class="n">FIXUP_BRANCH_CLOBBER</span> <span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emulate_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">frreg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u64</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flop</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">fr</span><span class="p">[</span><span class="n">frreg</span><span class="p">];</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">frreg</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="n">frreg</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DPRINTF</span><span class="p">(</span><span class="s">&quot;store r%d (0x%016llx) to &quot;</span> <span class="n">RFMT</span> <span class="s">&quot;:&quot;</span> <span class="n">RFMT</span> <span class="s">&quot; for 8 bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">frreg</span><span class="p">,</span> 
		<span class="n">val</span><span class="p">,</span>  <span class="n">regs</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ior</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PA20</span>
<span class="cp">#ifndef CONFIG_64BIT</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flop</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span>
<span class="s">&quot;	mtsp %3, %%sr1</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	depd,z	%2, 60, 3, %%r19</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	depd	%%r0, 63, 3, %2</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	mtsar	%%r19</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	depdi,z	-2, %%sar, 64, %%r19</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;1:	ldd	0(%%sr1,%2),%%r20</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;2:	ldd	8(%%sr1,%2),%%r21</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	shrpd	%%r0, %1, %%sar, %%r22</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	shrpd	%1, %%r0, %%sar, %%r1</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	and	%%r20, %%r19, %%r20</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	andcm	%%r21, %%r19, %%r21</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	or	%%r22, %%r20, %%r20</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	or	%%r1, %%r21, %%r21</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;3:	std	%%r20,0(%%sr1,%2)</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;4:	std	%%r21,8(%%sr1,%2)</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	copy	%%r0, %0</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;5:	</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	.section .fixup,</span><span class="se">\&quot;</span><span class="s">ax</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>
<span class="s">&quot;6:	ldi	-2, %0</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">FIXUP_BRANCH</span><span class="p">(</span><span class="mi">5</span><span class="n">b</span><span class="p">)</span>
<span class="s">&quot;	.previous</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">ASM_EXCEPTIONTABLE_ENTRY</span><span class="p">(</span><span class="mi">1</span><span class="n">b</span><span class="p">,</span><span class="mi">6</span><span class="n">b</span><span class="p">)</span>
	<span class="n">ASM_EXCEPTIONTABLE_ENTRY</span><span class="p">(</span><span class="mi">2</span><span class="n">b</span><span class="p">,</span><span class="mi">6</span><span class="n">b</span><span class="p">)</span>
	<span class="n">ASM_EXCEPTIONTABLE_ENTRY</span><span class="p">(</span><span class="mi">3</span><span class="n">b</span><span class="p">,</span><span class="mi">6</span><span class="n">b</span><span class="p">)</span>
	<span class="n">ASM_EXCEPTIONTABLE_ENTRY</span><span class="p">(</span><span class="mi">4</span><span class="n">b</span><span class="p">,</span><span class="mi">6</span><span class="n">b</span><span class="p">)</span>
	<span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
	<span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ior</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">)</span>
	<span class="o">:</span> <span class="s">&quot;r19&quot;</span><span class="p">,</span> <span class="s">&quot;r20&quot;</span><span class="p">,</span> <span class="s">&quot;r21&quot;</span><span class="p">,</span> <span class="s">&quot;r22&quot;</span><span class="p">,</span> <span class="s">&quot;r1&quot;</span><span class="p">,</span> <span class="n">FIXUP_BRANCH_CLOBBER</span> <span class="p">);</span>
<span class="cp">#else</span>
    <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">valh</span><span class="o">=</span><span class="p">(</span><span class="n">val</span><span class="o">&gt;&gt;</span><span class="mi">32</span><span class="p">),</span><span class="n">vall</span><span class="o">=</span><span class="p">(</span><span class="n">val</span><span class="o">&amp;</span><span class="mh">0xffffffffl</span><span class="p">);</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span>
<span class="s">&quot;	mtsp	%4, %%sr1</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	zdep	%2, 29, 2, %%r19</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	dep	%%r0, 31, 2, %2</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	mtsar	%%r19</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	zvdepi	-2, 32, %%r19</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;1:	ldw	0(%%sr1,%3),%%r20</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;2:	ldw	8(%%sr1,%3),%%r21</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	vshd	%1, %2, %%r1</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	vshd	%%r0, %1, %1</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	vshd	%2, %%r0, %2</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	and	%%r20, %%r19, %%r20</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	andcm	%%r21, %%r19, %%r21</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	or	%1, %%r20, %1</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	or	%2, %%r21, %2</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;3:	stw	%1,0(%%sr1,%1)</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;4:	stw	%%r1,4(%%sr1,%3)</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;5:	stw	%2,8(%%sr1,%3)</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	copy	%%r0, %0</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;6:	</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;	.section .fixup,</span><span class="se">\&quot;</span><span class="s">ax</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>
<span class="s">&quot;7:	ldi	-2, %0</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">FIXUP_BRANCH</span><span class="p">(</span><span class="mi">6</span><span class="n">b</span><span class="p">)</span>
<span class="s">&quot;	.previous</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">ASM_EXCEPTIONTABLE_ENTRY</span><span class="p">(</span><span class="mi">1</span><span class="n">b</span><span class="p">,</span><span class="mi">7</span><span class="n">b</span><span class="p">)</span>
	<span class="n">ASM_EXCEPTIONTABLE_ENTRY</span><span class="p">(</span><span class="mi">2</span><span class="n">b</span><span class="p">,</span><span class="mi">7</span><span class="n">b</span><span class="p">)</span>
	<span class="n">ASM_EXCEPTIONTABLE_ENTRY</span><span class="p">(</span><span class="mi">3</span><span class="n">b</span><span class="p">,</span><span class="mi">7</span><span class="n">b</span><span class="p">)</span>
	<span class="n">ASM_EXCEPTIONTABLE_ENTRY</span><span class="p">(</span><span class="mi">4</span><span class="n">b</span><span class="p">,</span><span class="mi">7</span><span class="n">b</span><span class="p">)</span>
	<span class="n">ASM_EXCEPTIONTABLE_ENTRY</span><span class="p">(</span><span class="mi">5</span><span class="n">b</span><span class="p">,</span><span class="mi">7</span><span class="n">b</span><span class="p">)</span>
	<span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
	<span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">valh</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">vall</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ior</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">)</span>
	<span class="o">:</span> <span class="s">&quot;r19&quot;</span><span class="p">,</span> <span class="s">&quot;r20&quot;</span><span class="p">,</span> <span class="s">&quot;r21&quot;</span><span class="p">,</span> <span class="s">&quot;r1&quot;</span><span class="p">,</span> <span class="n">FIXUP_BRANCH_CLOBBER</span> <span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">handle_unaligned</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">DEFINE_RATELIMIT_STATE</span><span class="p">(</span><span class="n">ratelimit</span><span class="p">,</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">newbase</span> <span class="o">=</span> <span class="n">R1</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">)</span><span class="o">?</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="n">R1</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">)]</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">modify</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">ERR_NOTHANDLED</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siginfo</span> <span class="n">si</span><span class="p">;</span>
	<span class="k">register</span> <span class="kt">int</span> <span class="n">flop</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>	<span class="cm">/* true if this is a flop */</span>

	<span class="cm">/* log a message with pacing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PARISC_UAC_SIGBUS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">goto</span> <span class="n">force_sigbus</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PARISC_UAC_NOPRINT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">__ratelimit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ratelimit</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s(%d): unaligned access to 0x&quot;</span> <span class="n">RFMT</span> <span class="s">&quot; at ip=0x&quot;</span> <span class="n">RFMT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">task_pid_nr</span><span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ior</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">iaoq</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG_UNALIGNED</span>
			<span class="n">show_regs</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
<span class="cp">#endif		</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">unaligned_enabled</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">force_sigbus</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* handle modification - OK, it&#39;s ugly, see the instruction manual */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">MAJOR_OP</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">))</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x03</span>:
	<span class="k">case</span> <span class="mh">0x09</span>:
	<span class="k">case</span> <span class="mh">0x0b</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="o">&amp;</span><span class="mh">0x20</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">modify</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="o">&amp;</span><span class="mh">0x1000</span><span class="p">)</span>		<span class="cm">/* short loads */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="o">&amp;</span><span class="mh">0x200</span><span class="p">)</span>
					<span class="n">newbase</span> <span class="o">+=</span> <span class="n">IM5_3</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">newbase</span> <span class="o">+=</span> <span class="n">IM5_2</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="o">&amp;</span><span class="mh">0x2000</span><span class="p">)</span>	<span class="cm">/* scaled indexed */</span>
			<span class="p">{</span>
				<span class="kt">int</span> <span class="n">shift</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="n">OPCODE1_MASK</span><span class="p">)</span>
				<span class="p">{</span>
				<span class="k">case</span> <span class="n">OPCODE_LDH_I</span>:
					<span class="n">shift</span><span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">OPCODE_LDW_I</span>:
					<span class="n">shift</span><span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">OPCODE_LDD_I</span>:
				<span class="k">case</span> <span class="n">OPCODE_LDDA_I</span>:
					<span class="n">shift</span><span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">newbase</span> <span class="o">+=</span> <span class="p">(</span><span class="n">R2</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">)</span><span class="o">?</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="n">R2</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">)]</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="n">shift</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>				<span class="cm">/* simple indexed */</span>
				<span class="n">newbase</span> <span class="o">+=</span> <span class="p">(</span><span class="n">R2</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">)</span><span class="o">?</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="n">R2</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">)]</span><span class="o">:</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x13</span>:
	<span class="k">case</span> <span class="mh">0x1b</span>:
		<span class="n">modify</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">newbase</span> <span class="o">+=</span> <span class="n">IM14</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x14</span>:
	<span class="k">case</span> <span class="mh">0x1c</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="o">&amp;</span><span class="mi">8</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">modify</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">newbase</span> <span class="o">+=</span> <span class="n">IM14</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="o">&amp;~</span><span class="mh">0xe</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x16</span>:
	<span class="k">case</span> <span class="mh">0x1e</span>:
		<span class="n">modify</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">newbase</span> <span class="o">+=</span> <span class="n">IM14</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="o">&amp;</span><span class="mi">6</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x17</span>:
	<span class="k">case</span> <span class="mh">0x1f</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="o">&amp;</span><span class="mi">4</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">modify</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">newbase</span> <span class="o">+=</span> <span class="n">IM14</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="o">&amp;~</span><span class="mi">4</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* TODO: make this cleaner... */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="n">OPCODE1_MASK</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">OPCODE_LDH_I</span>:
	<span class="k">case</span> <span class="n">OPCODE_LDH_S</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">emulate_ldh</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">R3</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OPCODE_LDW_I</span>:
	<span class="k">case</span> <span class="n">OPCODE_LDWA_I</span>:
	<span class="k">case</span> <span class="n">OPCODE_LDW_S</span>:
	<span class="k">case</span> <span class="n">OPCODE_LDWA_S</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">emulate_ldw</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">R3</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">),</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OPCODE_STH</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">emulate_sth</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">R2</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OPCODE_STW</span>:
	<span class="k">case</span> <span class="n">OPCODE_STWA</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">emulate_stw</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">R2</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">),</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PA20</span>
	<span class="k">case</span> <span class="n">OPCODE_LDD_I</span>:
	<span class="k">case</span> <span class="n">OPCODE_LDDA_I</span>:
	<span class="k">case</span> <span class="n">OPCODE_LDD_S</span>:
	<span class="k">case</span> <span class="n">OPCODE_LDDA_S</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">emulate_ldd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">R3</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">),</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OPCODE_STD</span>:
	<span class="k">case</span> <span class="n">OPCODE_STDA</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">emulate_std</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">R2</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">),</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">case</span> <span class="n">OPCODE_FLDWX</span>:
	<span class="k">case</span> <span class="n">OPCODE_FLDWS</span>:
	<span class="k">case</span> <span class="n">OPCODE_FLDWXR</span>:
	<span class="k">case</span> <span class="n">OPCODE_FLDWSR</span>:
		<span class="n">flop</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">emulate_ldw</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span><span class="n">FR3</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">),</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OPCODE_FLDDX</span>:
	<span class="k">case</span> <span class="n">OPCODE_FLDDS</span>:
		<span class="n">flop</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">emulate_ldd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span><span class="n">R3</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">),</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OPCODE_FSTWX</span>:
	<span class="k">case</span> <span class="n">OPCODE_FSTWS</span>:
	<span class="k">case</span> <span class="n">OPCODE_FSTWXR</span>:
	<span class="k">case</span> <span class="n">OPCODE_FSTWSR</span>:
		<span class="n">flop</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">emulate_stw</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span><span class="n">FR3</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">),</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OPCODE_FSTDX</span>:
	<span class="k">case</span> <span class="n">OPCODE_FSTDS</span>:
		<span class="n">flop</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">emulate_std</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span><span class="n">R3</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">),</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OPCODE_LDCD_I</span>:
	<span class="k">case</span> <span class="n">OPCODE_LDCW_I</span>:
	<span class="k">case</span> <span class="n">OPCODE_LDCD_S</span>:
	<span class="k">case</span> <span class="n">OPCODE_LDCW_S</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ERR_NOTHANDLED</span><span class="p">;</span>	<span class="cm">/* &quot;undefined&quot;, but lets kill them. */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_PA20</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="n">OPCODE2_MASK</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">OPCODE_FLDD_L</span>:
		<span class="n">flop</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">emulate_ldd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span><span class="n">R2</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">),</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPCODE_FSTD_L</span>:
		<span class="n">flop</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">emulate_std</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">R2</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">),</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPCODE_LDD_L</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">emulate_ldd</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">R2</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">),</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPCODE_STD_L</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">emulate_std</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">R2</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">),</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="n">OPCODE3_MASK</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">OPCODE_FLDW_L</span>:
		<span class="n">flop</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">emulate_ldw</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">R2</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">),</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPCODE_LDW_M</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">emulate_ldw</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">R2</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">),</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OPCODE_FSTW_L</span>:
		<span class="n">flop</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">emulate_stw</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">R2</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">),</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPCODE_STW_M</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">emulate_stw</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">R2</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">),</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="n">OPCODE4_MASK</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">OPCODE_LDH_L</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">emulate_ldh</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">R2</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPCODE_LDW_L</span>:
	<span class="k">case</span> <span class="n">OPCODE_LDWM</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">emulate_ldw</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">R2</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">),</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPCODE_STH_L</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">emulate_sth</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">R2</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPCODE_STW_L</span>:
	<span class="k">case</span> <span class="n">OPCODE_STWM</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">emulate_stw</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">R2</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">),</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">modify</span> <span class="o">&amp;&amp;</span> <span class="n">R1</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">))</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="n">R1</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">)]</span> <span class="o">=</span> <span class="n">newbase</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">ERR_NOTHANDLED</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;Not-handled unaligned insn 0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span><span class="p">);</span>

	<span class="n">DPRINTF</span><span class="p">(</span><span class="s">&quot;ret = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;Unaligned handler failed, ret = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;Unaligned data reference&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="mi">28</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">ERR_PAGEFAULT</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">si</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGSEGV</span><span class="p">;</span>
			<span class="n">si</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">si</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">SEGV_MAPERR</span><span class="p">;</span>
			<span class="n">si</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ior</span><span class="p">;</span>
			<span class="n">force_sig_info</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
<span class="nl">force_sigbus:</span>
			<span class="cm">/* couldn&#39;t handle it ... */</span>
			<span class="n">si</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGBUS</span><span class="p">;</span>
			<span class="n">si</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">si</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">BUS_ADRALN</span><span class="p">;</span>
			<span class="n">si</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ior</span><span class="p">;</span>
			<span class="n">force_sig_info</span><span class="p">(</span><span class="n">SIGBUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
		<span class="p">}</span>
		
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* else we handled it, let life go on. */</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">|=</span><span class="n">PSW_N</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * NB: check_unaligned() is only used for PCXS processors right</span>
<span class="cm"> * now, so we only check for PA1.1 encodings at this point.</span>
<span class="cm"> */</span>

<span class="kt">int</span>
<span class="nf">check_unaligned</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">align_mask</span><span class="p">;</span>

	<span class="cm">/* Get alignment mask */</span>

	<span class="n">align_mask</span> <span class="o">=</span> <span class="mi">0UL</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="n">OPCODE1_MASK</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">OPCODE_LDH_I</span>:
	<span class="k">case</span> <span class="n">OPCODE_LDH_S</span>:
	<span class="k">case</span> <span class="n">OPCODE_STH</span>:
		<span class="n">align_mask</span> <span class="o">=</span> <span class="mi">1UL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OPCODE_LDW_I</span>:
	<span class="k">case</span> <span class="n">OPCODE_LDWA_I</span>:
	<span class="k">case</span> <span class="n">OPCODE_LDW_S</span>:
	<span class="k">case</span> <span class="n">OPCODE_LDWA_S</span>:
	<span class="k">case</span> <span class="n">OPCODE_STW</span>:
	<span class="k">case</span> <span class="n">OPCODE_STWA</span>:
		<span class="n">align_mask</span> <span class="o">=</span> <span class="mi">3UL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="n">OPCODE4_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OPCODE_LDH_L</span>:
		<span class="k">case</span> <span class="n">OPCODE_STH_L</span>:
			<span class="n">align_mask</span> <span class="o">=</span> <span class="mi">1UL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OPCODE_LDW_L</span>:
		<span class="k">case</span> <span class="n">OPCODE_LDWM</span>:
		<span class="k">case</span> <span class="n">OPCODE_STW_L</span>:
		<span class="k">case</span> <span class="n">OPCODE_STWM</span>:
			<span class="n">align_mask</span> <span class="o">=</span> <span class="mi">3UL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ior</span> <span class="o">&amp;</span> <span class="n">align_mask</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
