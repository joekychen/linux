<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › parisc › math-emu › fpudispatch.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>fpudispatch.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Linux/PA-RISC Project (http://www.parisc-linux.org/)</span>
<span class="cm"> *</span>
<span class="cm"> * Floating-point emulation code</span>
<span class="cm"> *  Copyright (C) 2001 Hewlett-Packard (Paul Bame) &lt;bame@debian.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *    This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *    it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *    the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm"> *    any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *    This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *    GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *    You should have received a copy of the GNU General Public License</span>
<span class="cm"> *    along with this program; if not, write to the Free Software</span>
<span class="cm"> *    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> * BEGIN_DESC</span>
<span class="cm"> *</span>
<span class="cm"> *  File:</span>
<span class="cm"> *	@(#)	pa/fp/fpudispatch.c		$Revision: 1.1 $</span>
<span class="cm"> *</span>
<span class="cm"> *  Purpose:</span>
<span class="cm"> *	&lt;&lt;please update with a synopsis of the functionality provided by this file&gt;&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  External Interfaces:</span>
<span class="cm"> *	&lt;&lt;the following list was autogenerated, please review&gt;&gt;</span>
<span class="cm"> *	emfpudispatch(ir, dummy1, dummy2, fpregs)</span>
<span class="cm"> *	fpudispatch(ir, excp_code, holder, fpregs)</span>
<span class="cm"> *</span>
<span class="cm"> *  Internal Interfaces:</span>
<span class="cm"> *	&lt;&lt;the following list was autogenerated, please review&gt;&gt;</span>
<span class="cm"> *	static u_int decode_06(u_int, u_int *)</span>
<span class="cm"> *	static u_int decode_0c(u_int, u_int, u_int, u_int *)</span>
<span class="cm"> *	static u_int decode_0e(u_int, u_int, u_int, u_int *)</span>
<span class="cm"> *	static u_int decode_26(u_int, u_int *)</span>
<span class="cm"> *	static u_int decode_2e(u_int, u_int *)</span>
<span class="cm"> *	static void update_status_cbit(u_int *, u_int, u_int, u_int)</span>
<span class="cm"> *</span>
<span class="cm"> *  Theory:</span>
<span class="cm"> *	&lt;&lt;please update with a overview of the operation of this file&gt;&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * END_DESC</span>
<span class="cm">*/</span>

<span class="cp">#define FPUDEBUG 0</span>

<span class="cp">#include &quot;float.h&quot;</span>
<span class="cp">#include &lt;linux/bug.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;</span>
<span class="cm">/* #include &lt;sys/debug.h&gt; */</span>
<span class="cm">/* #include &lt;machine/sys/mdep_private.h&gt; */</span>

<span class="cp">#define COPR_INST 0x30000000</span>

<span class="cm">/*</span>
<span class="cm"> * definition of extru macro.  If pos and len are constants, the compiler</span>
<span class="cm"> * will generate an extru instruction when optimized</span>
<span class="cm"> */</span>
<span class="cp">#define extru(r,pos,len)	(((r) &gt;&gt; (31-(pos))) &amp; (( 1 &lt;&lt; (len)) - 1))</span>
<span class="cm">/* definitions of bit field locations in the instruction */</span>
<span class="cp">#define fpmajorpos 5</span>
<span class="cp">#define fpr1pos	10</span>
<span class="cp">#define fpr2pos 15</span>
<span class="cp">#define fptpos	31</span>
<span class="cp">#define fpsubpos 18</span>
<span class="cp">#define fpclass1subpos 16</span>
<span class="cp">#define fpclasspos 22</span>
<span class="cp">#define fpfmtpos 20</span>
<span class="cp">#define fpdfpos 18</span>
<span class="cp">#define fpnulpos 26</span>
<span class="cm">/*</span>
<span class="cm"> * the following are the extra bits for the 0E major op</span>
<span class="cm"> */</span>
<span class="cp">#define fpxr1pos 24</span>
<span class="cp">#define fpxr2pos 19</span>
<span class="cp">#define fpxtpos 25</span>
<span class="cp">#define fpxpos 23</span>
<span class="cp">#define fp0efmtpos 20</span>
<span class="cm">/*</span>
<span class="cm"> * the following are for the multi-ops</span>
<span class="cm"> */</span>
<span class="cp">#define fprm1pos 10</span>
<span class="cp">#define fprm2pos 15</span>
<span class="cp">#define fptmpos 31</span>
<span class="cp">#define fprapos 25</span>
<span class="cp">#define fptapos 20</span>
<span class="cp">#define fpmultifmt 26</span>
<span class="cm">/*</span>
<span class="cm"> * the following are for the fused FP instructions</span>
<span class="cm"> */</span>
     <span class="cm">/* fprm1pos 10 */</span>
     <span class="cm">/* fprm2pos 15 */</span>
<span class="cp">#define fpraupos 18</span>
<span class="cp">#define fpxrm2pos 19</span>
     <span class="cm">/* fpfmtpos 20 */</span>
<span class="cp">#define fpralpos 23</span>
<span class="cp">#define fpxrm1pos 24</span>
     <span class="cm">/* fpxtpos 25 */</span>
<span class="cp">#define fpfusedsubop 26</span>
     <span class="cm">/* fptpos	31 */</span>

<span class="cm">/*</span>
<span class="cm"> * offset to constant zero in the FP emulation registers</span>
<span class="cm"> */</span>
<span class="cp">#define fpzeroreg (32*sizeof(double)/sizeof(u_int))</span>

<span class="cm">/*</span>
<span class="cm"> * extract the major opcode from the instruction</span>
<span class="cm"> */</span>
<span class="cp">#define get_major(op) extru(op,fpmajorpos,6)</span>
<span class="cm">/*</span>
<span class="cm"> * extract the two bit class field from the FP instruction. The class is at bit</span>
<span class="cm"> * positions 21-22</span>
<span class="cm"> */</span>
<span class="cp">#define get_class(op) extru(op,fpclasspos,2)</span>
<span class="cm">/*</span>
<span class="cm"> * extract the 3 bit subop field.  For all but class 1 instructions, it is</span>
<span class="cm"> * located at bit positions 16-18</span>
<span class="cm"> */</span>
<span class="cp">#define get_subop(op) extru(op,fpsubpos,3)</span>
<span class="cm">/*</span>
<span class="cm"> * extract the 2 or 3 bit subop field from class 1 instructions.  It is located</span>
<span class="cm"> * at bit positions 15-16 (PA1.1) or 14-16 (PA2.0)</span>
<span class="cm"> */</span>
<span class="cp">#define get_subop1_PA1_1(op) extru(op,fpclass1subpos,2)	</span><span class="cm">/* PA89 (1.1) fmt */</span><span class="cp"></span>
<span class="cp">#define get_subop1_PA2_0(op) extru(op,fpclass1subpos,3)	</span><span class="cm">/* PA 2.0 fmt */</span><span class="cp"></span>

<span class="cm">/* definitions of unimplemented exceptions */</span>
<span class="cp">#define MAJOR_0C_EXCP	0x09</span>
<span class="cp">#define MAJOR_0E_EXCP	0x0b</span>
<span class="cp">#define MAJOR_06_EXCP	0x03</span>
<span class="cp">#define MAJOR_26_EXCP	0x23</span>
<span class="cp">#define MAJOR_2E_EXCP	0x2b</span>
<span class="cp">#define PA83_UNIMP_EXCP	0x01</span>

<span class="cm">/*</span>
<span class="cm"> * Special Defines for TIMEX specific code</span>
<span class="cm"> */</span>

<span class="cp">#define FPU_TYPE_FLAG_POS (EM_FPU_TYPE_OFFSET&gt;&gt;2)</span>
<span class="cp">#define TIMEX_ROLEX_FPU_MASK (TIMEX_EXTEN_FLAG|ROLEX_EXTEN_FLAG)</span>

<span class="cm">/*</span>
<span class="cm"> * Static function definitions</span>
<span class="cm"> */</span>
<span class="cp">#define _PROTOTYPES</span>
<span class="cp">#if defined(_PROTOTYPES) || defined(_lint)</span>
<span class="k">static</span> <span class="n">u_int</span> <span class="n">decode_0c</span><span class="p">(</span><span class="n">u_int</span><span class="p">,</span> <span class="n">u_int</span><span class="p">,</span> <span class="n">u_int</span><span class="p">,</span> <span class="n">u_int</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u_int</span> <span class="n">decode_0e</span><span class="p">(</span><span class="n">u_int</span><span class="p">,</span> <span class="n">u_int</span><span class="p">,</span> <span class="n">u_int</span><span class="p">,</span> <span class="n">u_int</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u_int</span> <span class="n">decode_06</span><span class="p">(</span><span class="n">u_int</span><span class="p">,</span> <span class="n">u_int</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u_int</span> <span class="n">decode_26</span><span class="p">(</span><span class="n">u_int</span><span class="p">,</span> <span class="n">u_int</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u_int</span> <span class="n">decode_2e</span><span class="p">(</span><span class="n">u_int</span><span class="p">,</span> <span class="n">u_int</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">update_status_cbit</span><span class="p">(</span><span class="n">u_int</span> <span class="o">*</span><span class="p">,</span> <span class="n">u_int</span><span class="p">,</span> <span class="n">u_int</span><span class="p">,</span> <span class="n">u_int</span><span class="p">);</span>
<span class="cp">#else </span><span class="cm">/* !_PROTOTYPES&amp;&amp;!_lint */</span><span class="cp"></span>
<span class="k">static</span> <span class="n">u_int</span> <span class="n">decode_0c</span><span class="p">();</span>
<span class="k">static</span> <span class="n">u_int</span> <span class="n">decode_0e</span><span class="p">();</span>
<span class="k">static</span> <span class="n">u_int</span> <span class="n">decode_06</span><span class="p">();</span>
<span class="k">static</span> <span class="n">u_int</span> <span class="n">decode_26</span><span class="p">();</span>
<span class="k">static</span> <span class="n">u_int</span> <span class="n">decode_2e</span><span class="p">();</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">update_status_cbit</span><span class="p">();</span>
<span class="cp">#endif </span><span class="cm">/* _PROTOTYPES&amp;&amp;!_lint */</span><span class="cp"></span>

<span class="cp">#define VASSERT(x)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">parisc_linux_get_fpu_type</span><span class="p">(</span><span class="n">u_int</span> <span class="n">fpregs</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="cm">/* on pa-linux the fpu type is not filled in by the</span>
<span class="cm">	 * caller; it is constructed here  </span>
<span class="cm">	 */</span> 
	<span class="k">if</span> <span class="p">(</span><span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">cpu_type</span> <span class="o">==</span> <span class="n">pcxs</span><span class="p">)</span>
		<span class="n">fpregs</span><span class="p">[</span><span class="n">FPU_TYPE_FLAG_POS</span><span class="p">]</span> <span class="o">=</span> <span class="n">TIMEX_EXTEN_FLAG</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">cpu_type</span> <span class="o">==</span> <span class="n">pcxt</span> <span class="o">||</span>
	         <span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">cpu_type</span> <span class="o">==</span> <span class="n">pcxt_</span><span class="p">)</span>
		<span class="n">fpregs</span><span class="p">[</span><span class="n">FPU_TYPE_FLAG_POS</span><span class="p">]</span> <span class="o">=</span> <span class="n">ROLEX_EXTEN_FLAG</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">cpu_type</span> <span class="o">&gt;=</span> <span class="n">pcxu</span><span class="p">)</span>
		<span class="n">fpregs</span><span class="p">[</span><span class="n">FPU_TYPE_FLAG_POS</span><span class="p">]</span> <span class="o">=</span> <span class="n">PA2_0_FPU_FLAG</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * this routine will decode the excepting floating point instruction and</span>
<span class="cm"> * call the approiate emulation routine.</span>
<span class="cm"> * It is called by decode_fpu with the following parameters:</span>
<span class="cm"> * fpudispatch(current_ir, unimplemented_code, 0, &amp;Fpu_register)</span>
<span class="cm"> * where current_ir is the instruction to be emulated,</span>
<span class="cm"> * unimplemented_code is the exception_code that the hardware generated</span>
<span class="cm"> * and &amp;Fpu_register is the address of emulated FP reg 0.</span>
<span class="cm"> */</span>
<span class="n">u_int</span>
<span class="nf">fpudispatch</span><span class="p">(</span><span class="n">u_int</span> <span class="n">ir</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">excp_code</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">holder</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">fpregs</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="n">u_int</span> <span class="n">class</span><span class="p">,</span> <span class="n">subop</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">fpu_type_flags</span><span class="p">;</span>

	<span class="cm">/* All FP emulation code assumes that ints are 4-bytes in length */</span>
	<span class="n">VASSERT</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">parisc_linux_get_fpu_type</span><span class="p">(</span><span class="n">fpregs</span><span class="p">);</span>

	<span class="n">fpu_type_flags</span><span class="o">=</span><span class="n">fpregs</span><span class="p">[</span><span class="n">FPU_TYPE_FLAG_POS</span><span class="p">];</span>  <span class="cm">/* get fpu type flags */</span>

	<span class="n">class</span> <span class="o">=</span> <span class="n">get_class</span><span class="p">(</span><span class="n">ir</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">class</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span>  <span class="p">(</span><span class="n">fpu_type_flags</span> <span class="o">&amp;</span> <span class="n">PA2_0_FPU_FLAG</span><span class="p">)</span>
			<span class="n">subop</span> <span class="o">=</span> <span class="n">get_subop1_PA2_0</span><span class="p">(</span><span class="n">ir</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">subop</span> <span class="o">=</span> <span class="n">get_subop1_PA1_1</span><span class="p">(</span><span class="n">ir</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">subop</span> <span class="o">=</span> <span class="n">get_subop</span><span class="p">(</span><span class="n">ir</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">FPUDEBUG</span><span class="p">)</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;class %d subop %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">class</span><span class="p">,</span> <span class="n">subop</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">excp_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MAJOR_0C_EXCP</span>:
		<span class="k">case</span> <span class="n">PA83_UNIMP_EXCP</span>:
			<span class="k">return</span><span class="p">(</span><span class="n">decode_0c</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">class</span><span class="p">,</span><span class="n">subop</span><span class="p">,</span><span class="n">fpregs</span><span class="p">));</span>
		<span class="k">case</span> <span class="n">MAJOR_0E_EXCP</span>:
			<span class="k">return</span><span class="p">(</span><span class="n">decode_0e</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">class</span><span class="p">,</span><span class="n">subop</span><span class="p">,</span><span class="n">fpregs</span><span class="p">));</span>
		<span class="k">case</span> <span class="n">MAJOR_06_EXCP</span>:
			<span class="k">return</span><span class="p">(</span><span class="n">decode_06</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fpregs</span><span class="p">));</span>
		<span class="k">case</span> <span class="n">MAJOR_26_EXCP</span>:
			<span class="k">return</span><span class="p">(</span><span class="n">decode_26</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fpregs</span><span class="p">));</span>
		<span class="k">case</span> <span class="n">MAJOR_2E_EXCP</span>:
			<span class="k">return</span><span class="p">(</span><span class="n">decode_2e</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fpregs</span><span class="p">));</span>
		<span class="nl">default:</span>
			<span class="cm">/* &quot;crashme Night Gallery painting nr 2. (asm_crash.s).</span>
<span class="cm">			 * This was fixed for multi-user kernels, but</span>
<span class="cm">			 * workstation kernels had a panic here.  This allowed</span>
<span class="cm">			 * any arbitrary user to panic the kernel by executing</span>
<span class="cm">			 * setting the FP exception registers to strange values</span>
<span class="cm">			 * and generating an emulation trap.  The emulation and</span>
<span class="cm">			 * exception code must never be able to panic the</span>
<span class="cm">			 * kernel.</span>
<span class="cm">			 */</span>
			<span class="k">return</span><span class="p">(</span><span class="n">UNIMPLEMENTEDEXCEPTION</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * this routine is called by $emulation_trap to emulate a coprocessor</span>
<span class="cm"> * instruction if one doesn&#39;t exist</span>
<span class="cm"> */</span>
<span class="n">u_int</span>
<span class="nf">emfpudispatch</span><span class="p">(</span><span class="n">u_int</span> <span class="n">ir</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">dummy1</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">dummy2</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">fpregs</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="n">u_int</span> <span class="n">class</span><span class="p">,</span> <span class="n">subop</span><span class="p">,</span> <span class="n">major</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">fpu_type_flags</span><span class="p">;</span>

	<span class="cm">/* All FP emulation code assumes that ints are 4-bytes in length */</span>
	<span class="n">VASSERT</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">fpu_type_flags</span><span class="o">=</span><span class="n">fpregs</span><span class="p">[</span><span class="n">FPU_TYPE_FLAG_POS</span><span class="p">];</span>  <span class="cm">/* get fpu type flags */</span>

	<span class="n">major</span> <span class="o">=</span> <span class="n">get_major</span><span class="p">(</span><span class="n">ir</span><span class="p">);</span>
	<span class="n">class</span> <span class="o">=</span> <span class="n">get_class</span><span class="p">(</span><span class="n">ir</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">class</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span>  <span class="p">(</span><span class="n">fpu_type_flags</span> <span class="o">&amp;</span> <span class="n">PA2_0_FPU_FLAG</span><span class="p">)</span>
			<span class="n">subop</span> <span class="o">=</span> <span class="n">get_subop1_PA2_0</span><span class="p">(</span><span class="n">ir</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">subop</span> <span class="o">=</span> <span class="n">get_subop1_PA1_1</span><span class="p">(</span><span class="n">ir</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">subop</span> <span class="o">=</span> <span class="n">get_subop</span><span class="p">(</span><span class="n">ir</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">major</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x0C</span>:
			<span class="k">return</span><span class="p">(</span><span class="n">decode_0c</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">class</span><span class="p">,</span><span class="n">subop</span><span class="p">,</span><span class="n">fpregs</span><span class="p">));</span>
		<span class="k">case</span> <span class="mh">0x0E</span>:
			<span class="k">return</span><span class="p">(</span><span class="n">decode_0e</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">class</span><span class="p">,</span><span class="n">subop</span><span class="p">,</span><span class="n">fpregs</span><span class="p">));</span>
		<span class="k">case</span> <span class="mh">0x06</span>:
			<span class="k">return</span><span class="p">(</span><span class="n">decode_06</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fpregs</span><span class="p">));</span>
		<span class="k">case</span> <span class="mh">0x26</span>:
			<span class="k">return</span><span class="p">(</span><span class="n">decode_26</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fpregs</span><span class="p">));</span>
		<span class="k">case</span> <span class="mh">0x2E</span>:
			<span class="k">return</span><span class="p">(</span><span class="n">decode_2e</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fpregs</span><span class="p">));</span>
		<span class="nl">default:</span>
			<span class="k">return</span><span class="p">(</span><span class="n">PA83_UNIMP_EXCP</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
	

<span class="k">static</span> <span class="n">u_int</span>
<span class="nf">decode_0c</span><span class="p">(</span><span class="n">u_int</span> <span class="n">ir</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">class</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">subop</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">fpregs</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="n">u_int</span> <span class="n">r1</span><span class="p">,</span><span class="n">r2</span><span class="p">,</span><span class="n">t</span><span class="p">;</span>		<span class="cm">/* operand register offsets */</span> 
	<span class="n">u_int</span> <span class="n">fmt</span><span class="p">;</span>		<span class="cm">/* also sf for class 1 conversions */</span>
	<span class="n">u_int</span>  <span class="n">df</span><span class="p">;</span>		<span class="cm">/* for class 1 conversions */</span>
	<span class="n">u_int</span> <span class="o">*</span><span class="n">status</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">local_status</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">fpu_type_flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ir</span> <span class="o">==</span> <span class="n">COPR_INST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fpregs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">EMULATION_VERSION</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">;</span>
		<span class="k">return</span><span class="p">(</span><span class="n">NOEXCEPTION</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>	<span class="cm">/* fp status register */</span>
	<span class="n">local_status</span> <span class="o">=</span> <span class="n">fpregs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="cm">/* and local copy */</span>
	<span class="n">r1</span> <span class="o">=</span> <span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fpr1pos</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u_int</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>		<span class="cm">/* map fr0 source to constant zero */</span>
		<span class="n">r1</span> <span class="o">=</span> <span class="n">fpzeroreg</span><span class="p">;</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fptpos</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u_int</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">class</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>	<span class="cm">/* don&#39;t allow fr0 as a dest */</span>
		<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0C_EXCP</span><span class="p">);</span>
	<span class="n">fmt</span> <span class="o">=</span> <span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fpfmtpos</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>	<span class="cm">/* get fmt completer */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">class</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">case</span> <span class="mi">0</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">subop</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:	<span class="cm">/* COPR 0,0 emulated above*/</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0C_EXCP</span><span class="p">);</span>
			<span class="k">case</span> <span class="mi">2</span>:	<span class="cm">/* FCPY */</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* illegal */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0C_EXCP</span><span class="p">);</span>
				    <span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* quad */</span>
					<span class="n">t</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>  <span class="cm">/* force to even reg #s */</span>
					<span class="n">r1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
					<span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="o">+</span><span class="mi">3</span><span class="p">];</span>
					<span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>
				    <span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* double */</span>
					<span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
				    <span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* single */</span>
					<span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">];</span>
					<span class="k">return</span><span class="p">(</span><span class="n">NOEXCEPTION</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* FABS */</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* illegal */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0C_EXCP</span><span class="p">);</span>
				    <span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* quad */</span>
					<span class="n">t</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>  <span class="cm">/* force to even reg #s */</span>
					<span class="n">r1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
					<span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="o">+</span><span class="mi">3</span><span class="p">];</span>
					<span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>
				    <span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* double */</span>
					<span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
				    <span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* single */</span>
					<span class="cm">/* copy and clear sign bit */</span>
					<span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7fffffff</span><span class="p">;</span>
					<span class="k">return</span><span class="p">(</span><span class="n">NOEXCEPTION</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="mi">6</span>: <span class="cm">/* FNEG */</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* illegal */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0C_EXCP</span><span class="p">);</span>
				    <span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* quad */</span>
					<span class="n">t</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>  <span class="cm">/* force to even reg #s */</span>
					<span class="n">r1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
					<span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="o">+</span><span class="mi">3</span><span class="p">];</span>
					<span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>
				    <span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* double */</span>
					<span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
				    <span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* single */</span>
					<span class="cm">/* copy and invert sign bit */</span>
					<span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">]</span> <span class="o">^</span> <span class="mh">0x80000000</span><span class="p">;</span>
					<span class="k">return</span><span class="p">(</span><span class="n">NOEXCEPTION</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="mi">7</span>: <span class="cm">/* FNEGABS */</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* illegal */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0C_EXCP</span><span class="p">);</span>
				    <span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* quad */</span>
					<span class="n">t</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>  <span class="cm">/* force to even reg #s */</span>
					<span class="n">r1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
					<span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="o">+</span><span class="mi">3</span><span class="p">];</span>
					<span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>
				    <span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* double */</span>
					<span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
				    <span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* single */</span>
					<span class="cm">/* copy and set sign bit */</span>
					<span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x80000000</span><span class="p">;</span>
					<span class="k">return</span><span class="p">(</span><span class="n">NOEXCEPTION</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="mi">4</span>: <span class="cm">/* FSQRT */</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">0</span>:
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_fsqrt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">1</span>:
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_fsqrt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">2</span>:
				    <span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* quad not implemented */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0C_EXCP</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="mi">5</span>: <span class="cm">/* FRND */</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">0</span>:
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_frnd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">1</span>:
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_frnd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">2</span>:
				    <span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* quad not implemented */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0C_EXCP</span><span class="p">);</span>
				<span class="p">}</span>
		<span class="p">}</span> <span class="cm">/* end of switch (subop) */</span>

	<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* class 1 */</span>
		<span class="n">df</span> <span class="o">=</span> <span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fpdfpos</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span> <span class="cm">/* get dest format */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">df</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * fmt&#39;s 2 and 3 are illegal of not implemented</span>
<span class="cm">			 * quad conversions</span>
<span class="cm">			 */</span>
			<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0C_EXCP</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * encode source and dest formats into 2 bits.</span>
<span class="cm">		 * high bit is source, low bit is dest.</span>
<span class="cm">		 * bit = 1 --&gt; double precision</span>
<span class="cm">		 */</span>
		<span class="n">fmt</span> <span class="o">=</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">df</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">subop</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* FCNVFF */</span>
				<span class="k">switch</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* sgl/sgl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0C_EXCP</span><span class="p">);</span>
				    <span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* sgl/dbl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_to_dbl_fcnvff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* dbl/sgl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_to_sgl_fcnvff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* dbl/dbl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0C_EXCP</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* FCNVXF */</span>
				<span class="k">switch</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* sgl/sgl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_to_sgl_fcnvxf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* sgl/dbl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_to_dbl_fcnvxf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* dbl/sgl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_to_sgl_fcnvxf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* dbl/dbl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_to_dbl_fcnvxf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* FCNVFX */</span>
				<span class="k">switch</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* sgl/sgl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_to_sgl_fcnvfx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* sgl/dbl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_to_dbl_fcnvfx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* dbl/sgl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_to_sgl_fcnvfx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* dbl/dbl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_to_dbl_fcnvfx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* FCNVFXT */</span>
				<span class="k">switch</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* sgl/sgl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_to_sgl_fcnvfxt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* sgl/dbl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_to_dbl_fcnvfxt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* dbl/sgl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_to_sgl_fcnvfxt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* dbl/dbl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_to_dbl_fcnvfxt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="mi">5</span>: <span class="cm">/* FCNVUF (PA2.0 only) */</span>
				<span class="k">switch</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* sgl/sgl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_to_sgl_fcnvuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* sgl/dbl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_to_dbl_fcnvuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* dbl/sgl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_to_sgl_fcnvuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* dbl/dbl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_to_dbl_fcnvuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="mi">6</span>: <span class="cm">/* FCNVFU (PA2.0 only) */</span>
				<span class="k">switch</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* sgl/sgl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_to_sgl_fcnvfu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* sgl/dbl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_to_dbl_fcnvfu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* dbl/sgl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_to_sgl_fcnvfu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* dbl/dbl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_to_dbl_fcnvfu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="mi">7</span>: <span class="cm">/* FCNVFUT (PA2.0 only) */</span>
				<span class="k">switch</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* sgl/sgl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_to_sgl_fcnvfut</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* sgl/dbl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_to_dbl_fcnvfut</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* dbl/sgl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_to_sgl_fcnvfut</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* dbl/dbl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_to_dbl_fcnvfut</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="mi">4</span>: <span class="cm">/* undefined */</span>
				<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0C_EXCP</span><span class="p">);</span>
		<span class="p">}</span> <span class="cm">/* end of switch subop */</span>

	<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* class 2 */</span>
		<span class="n">fpu_type_flags</span><span class="o">=</span><span class="n">fpregs</span><span class="p">[</span><span class="n">FPU_TYPE_FLAG_POS</span><span class="p">];</span>
		<span class="n">r2</span> <span class="o">=</span> <span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">fpr2pos</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u_int</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">r2</span> <span class="o">=</span> <span class="n">fpzeroreg</span><span class="p">;</span>
		<span class="k">if</span>  <span class="p">(</span><span class="n">fpu_type_flags</span> <span class="o">&amp;</span> <span class="n">PA2_0_FPU_FLAG</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* FTEST if nullify bit set, otherwise FCMP */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">fpnulpos</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>  <span class="cm">/* FTEST */</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">0</span>:
					<span class="cm">/*</span>
<span class="cm">					 * arg0 is not used</span>
<span class="cm">					 * second param is the t field used for</span>
<span class="cm">					 * ftest,acc and ftest,rej</span>
<span class="cm">					 * third param is the subop (y-field)</span>
<span class="cm">					 */</span>
					<span class="n">BUG</span><span class="p">();</span>
					<span class="cm">/* Unsupported</span>
<span class="cm">					 * return(ftest(0L,extru(ir,fptpos,5),</span>
<span class="cm">					 *	 &amp;fpregs[0],subop));</span>
<span class="cm">					 */</span>
				    <span class="k">case</span> <span class="mi">1</span>:
				    <span class="k">case</span> <span class="mi">2</span>:
				    <span class="k">case</span> <span class="mi">3</span>:
					<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0C_EXCP</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>  <span class="cm">/* FCMP */</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">0</span>:
					<span class="n">retval</span> <span class="o">=</span> <span class="n">sgl_fcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r2</span><span class="p">],</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fptpos</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span>
						<span class="o">&amp;</span><span class="n">local_status</span><span class="p">);</span>
					<span class="n">update_status_cbit</span><span class="p">(</span><span class="n">status</span><span class="p">,</span><span class="n">local_status</span><span class="p">,</span>
						<span class="n">fpu_type_flags</span><span class="p">,</span> <span class="n">subop</span><span class="p">);</span>
					<span class="k">return</span><span class="p">(</span><span class="n">retval</span><span class="p">);</span>
				    <span class="k">case</span> <span class="mi">1</span>:
					<span class="n">retval</span> <span class="o">=</span> <span class="n">dbl_fcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r2</span><span class="p">],</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fptpos</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span>
						<span class="o">&amp;</span><span class="n">local_status</span><span class="p">);</span>
					<span class="n">update_status_cbit</span><span class="p">(</span><span class="n">status</span><span class="p">,</span><span class="n">local_status</span><span class="p">,</span>
						<span class="n">fpu_type_flags</span><span class="p">,</span> <span class="n">subop</span><span class="p">);</span>
					<span class="k">return</span><span class="p">(</span><span class="n">retval</span><span class="p">);</span>
				    <span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* illegal */</span>
				    <span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* quad not implemented */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0C_EXCP</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>  <span class="cm">/* end of if for PA2.0 */</span>
		<span class="k">else</span> <span class="p">{</span>	<span class="cm">/* PA1.0 &amp; PA1.1 */</span>
		    <span class="k">switch</span> <span class="p">(</span><span class="n">subop</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">2</span>:
			<span class="k">case</span> <span class="mi">3</span>:
			<span class="k">case</span> <span class="mi">4</span>:
			<span class="k">case</span> <span class="mi">5</span>:
			<span class="k">case</span> <span class="mi">6</span>:
			<span class="k">case</span> <span class="mi">7</span>:
				<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0C_EXCP</span><span class="p">);</span>
			<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* FCMP */</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">0</span>:
					<span class="n">retval</span> <span class="o">=</span> <span class="n">sgl_fcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r2</span><span class="p">],</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fptpos</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span>
						<span class="o">&amp;</span><span class="n">local_status</span><span class="p">);</span>
					<span class="n">update_status_cbit</span><span class="p">(</span><span class="n">status</span><span class="p">,</span><span class="n">local_status</span><span class="p">,</span>
						<span class="n">fpu_type_flags</span><span class="p">,</span> <span class="n">subop</span><span class="p">);</span>
					<span class="k">return</span><span class="p">(</span><span class="n">retval</span><span class="p">);</span>
				    <span class="k">case</span> <span class="mi">1</span>:
					<span class="n">retval</span> <span class="o">=</span> <span class="n">dbl_fcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r2</span><span class="p">],</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fptpos</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span>
						<span class="o">&amp;</span><span class="n">local_status</span><span class="p">);</span>
					<span class="n">update_status_cbit</span><span class="p">(</span><span class="n">status</span><span class="p">,</span><span class="n">local_status</span><span class="p">,</span>
						<span class="n">fpu_type_flags</span><span class="p">,</span> <span class="n">subop</span><span class="p">);</span>
					<span class="k">return</span><span class="p">(</span><span class="n">retval</span><span class="p">);</span>
				    <span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* illegal */</span>
				    <span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* quad not implemented */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0C_EXCP</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* FTEST */</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">0</span>:
					<span class="cm">/*</span>
<span class="cm">					 * arg0 is not used</span>
<span class="cm">					 * second param is the t field used for</span>
<span class="cm">					 * ftest,acc and ftest,rej</span>
<span class="cm">					 * third param is the subop (y-field)</span>
<span class="cm">					 */</span>
					<span class="n">BUG</span><span class="p">();</span>
					<span class="cm">/* unsupported</span>
<span class="cm">					 * return(ftest(0L,extru(ir,fptpos,5),</span>
<span class="cm">					 *     &amp;fpregs[0],subop));</span>
<span class="cm">					 */</span>
				    <span class="k">case</span> <span class="mi">1</span>:
				    <span class="k">case</span> <span class="mi">2</span>:
				    <span class="k">case</span> <span class="mi">3</span>:
					<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0C_EXCP</span><span class="p">);</span>
				<span class="p">}</span>
		    <span class="p">}</span> <span class="cm">/* end of switch subop */</span>
		<span class="p">}</span> <span class="cm">/* end of else for PA1.0 &amp; PA1.1 */</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* class 3 */</span>
		<span class="n">r2</span> <span class="o">=</span> <span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fpr2pos</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u_int</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">r2</span> <span class="o">=</span> <span class="n">fpzeroreg</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">subop</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">5</span>:
			<span class="k">case</span> <span class="mi">6</span>:
			<span class="k">case</span> <span class="mi">7</span>:
				<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0C_EXCP</span><span class="p">);</span>
			
			<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* FADD */</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">0</span>:
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_fadd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r2</span><span class="p">],</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">1</span>:
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_fadd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r2</span><span class="p">],</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* illegal */</span>
				    <span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* quad not implemented */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0C_EXCP</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* FSUB */</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">0</span>:
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_fsub</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r2</span><span class="p">],</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">1</span>:
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_fsub</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r2</span><span class="p">],</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* illegal */</span>
				    <span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* quad not implemented */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0C_EXCP</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* FMPY */</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">0</span>:
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_fmpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r2</span><span class="p">],</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">1</span>:
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_fmpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r2</span><span class="p">],</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* illegal */</span>
				    <span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* quad not implemented */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0C_EXCP</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* FDIV */</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">0</span>:
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_fdiv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r2</span><span class="p">],</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">1</span>:
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_fdiv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r2</span><span class="p">],</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* illegal */</span>
				    <span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* quad not implemented */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0C_EXCP</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="mi">4</span>: <span class="cm">/* FREM */</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">0</span>:
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_frem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r2</span><span class="p">],</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">1</span>:
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_frem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r2</span><span class="p">],</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* illegal */</span>
				    <span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* quad not implemented */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0C_EXCP</span><span class="p">);</span>
				<span class="p">}</span>
		<span class="p">}</span> <span class="cm">/* end of class 3 switch */</span>
	<span class="p">}</span> <span class="cm">/* end of switch(class) */</span>

	<span class="cm">/* If we get here, something is really wrong! */</span>
	<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0C_EXCP</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u_int</span>
<span class="n">decode_0e</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">class</span><span class="p">,</span><span class="n">subop</span><span class="p">,</span><span class="n">fpregs</span><span class="p">)</span>
<span class="n">u_int</span> <span class="n">ir</span><span class="p">,</span><span class="n">class</span><span class="p">,</span><span class="n">subop</span><span class="p">;</span>
<span class="n">u_int</span> <span class="n">fpregs</span><span class="p">[];</span>
<span class="p">{</span>
	<span class="n">u_int</span> <span class="n">r1</span><span class="p">,</span><span class="n">r2</span><span class="p">,</span><span class="n">t</span><span class="p">;</span>		<span class="cm">/* operand register offsets */</span>
	<span class="n">u_int</span> <span class="n">fmt</span><span class="p">;</span>		<span class="cm">/* also sf for class 1 conversions */</span>
	<span class="n">u_int</span> <span class="n">df</span><span class="p">;</span>		<span class="cm">/* dest format for class 1 conversions */</span>
	<span class="n">u_int</span> <span class="o">*</span><span class="n">status</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">local_status</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">fpu_type_flags</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">local_status</span> <span class="o">=</span> <span class="n">fpregs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">r1</span> <span class="o">=</span> <span class="p">((</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fpr1pos</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fpxr1pos</span><span class="p">,</span><span class="mi">1</span><span class="p">)));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">r1</span> <span class="o">=</span> <span class="n">fpzeroreg</span><span class="p">;</span>
	<span class="n">t</span> <span class="o">=</span> <span class="p">((</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fptpos</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fpxtpos</span><span class="p">,</span><span class="mi">1</span><span class="p">)));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">class</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0E_EXCP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">class</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>		<span class="cm">/* class 0 or 1 has 2 bit fmt */</span>
		<span class="n">fmt</span> <span class="o">=</span> <span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fpfmtpos</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
	<span class="k">else</span> 			<span class="cm">/* class 2 and 3 have 1 bit fmt */</span>
		<span class="n">fmt</span> <span class="o">=</span> <span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fp0efmtpos</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * An undefined combination, double precision accessing the</span>
<span class="cm">	 * right half of a FPR, can get us into trouble.  </span>
<span class="cm">	 * Let&#39;s just force proper alignment on it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">==</span> <span class="n">DBL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">class</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">t</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">class</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">case</span> <span class="mi">0</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">subop</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* unimplemented */</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0E_EXCP</span><span class="p">);</span>
			<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* FCPY */</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">2</span>:
				    <span class="k">case</span> <span class="mi">3</span>:
					<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0E_EXCP</span><span class="p">);</span>
				    <span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* double */</span>
					<span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
				    <span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* single */</span>
					<span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">];</span>
					<span class="k">return</span><span class="p">(</span><span class="n">NOEXCEPTION</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* FABS */</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">2</span>:
				    <span class="k">case</span> <span class="mi">3</span>:
					<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0E_EXCP</span><span class="p">);</span>
				    <span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* double */</span>
					<span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
				    <span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* single */</span>
					<span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7fffffff</span><span class="p">;</span>
					<span class="k">return</span><span class="p">(</span><span class="n">NOEXCEPTION</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="mi">6</span>: <span class="cm">/* FNEG */</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">2</span>:
				    <span class="k">case</span> <span class="mi">3</span>:
					<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0E_EXCP</span><span class="p">);</span>
				    <span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* double */</span>
					<span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
				    <span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* single */</span>
					<span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">]</span> <span class="o">^</span> <span class="mh">0x80000000</span><span class="p">;</span>
					<span class="k">return</span><span class="p">(</span><span class="n">NOEXCEPTION</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="mi">7</span>: <span class="cm">/* FNEGABS */</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">2</span>:
				    <span class="k">case</span> <span class="mi">3</span>:
					<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0E_EXCP</span><span class="p">);</span>
				    <span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* double */</span>
					<span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
				    <span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* single */</span>
					<span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x80000000</span><span class="p">;</span>
					<span class="k">return</span><span class="p">(</span><span class="n">NOEXCEPTION</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="mi">4</span>: <span class="cm">/* FSQRT */</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">0</span>:
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_fsqrt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">1</span>:
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_fsqrt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">2</span>:
				    <span class="k">case</span> <span class="mi">3</span>:
					<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0E_EXCP</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="mi">5</span>: <span class="cm">/* FRMD */</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">0</span>:
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_frnd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">1</span>:
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_frnd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">2</span>:
				    <span class="k">case</span> <span class="mi">3</span>:
					<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0E_EXCP</span><span class="p">);</span>
				<span class="p">}</span>
		<span class="p">}</span> <span class="cm">/* end of switch (subop */</span>
	
	<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* class 1 */</span>
		<span class="n">df</span> <span class="o">=</span> <span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fpdfpos</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span> <span class="cm">/* get dest format */</span>
		<span class="cm">/*</span>
<span class="cm">		 * Fix Crashme problem (writing to 31R in double precision)</span>
<span class="cm">		 * here too.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">df</span> <span class="o">==</span> <span class="n">DBL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">t</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">df</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">))</span>
			<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0E_EXCP</span><span class="p">);</span>
		
		<span class="n">fmt</span> <span class="o">=</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">df</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">subop</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* FCNVFF */</span>
				<span class="k">switch</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* sgl/sgl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0E_EXCP</span><span class="p">);</span>
				    <span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* sgl/dbl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_to_dbl_fcnvff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* dbl/sgl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_to_sgl_fcnvff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* dbl/dbl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0E_EXCP</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* FCNVXF */</span>
				<span class="k">switch</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* sgl/sgl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_to_sgl_fcnvxf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* sgl/dbl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_to_dbl_fcnvxf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* dbl/sgl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_to_sgl_fcnvxf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* dbl/dbl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_to_dbl_fcnvxf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* FCNVFX */</span>
				<span class="k">switch</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* sgl/sgl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_to_sgl_fcnvfx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* sgl/dbl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_to_dbl_fcnvfx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* dbl/sgl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_to_sgl_fcnvfx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* dbl/dbl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_to_dbl_fcnvfx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* FCNVFXT */</span>
				<span class="k">switch</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* sgl/sgl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_to_sgl_fcnvfxt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* sgl/dbl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_to_dbl_fcnvfxt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* dbl/sgl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_to_sgl_fcnvfxt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* dbl/dbl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_to_dbl_fcnvfxt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="mi">5</span>: <span class="cm">/* FCNVUF (PA2.0 only) */</span>
				<span class="k">switch</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* sgl/sgl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_to_sgl_fcnvuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* sgl/dbl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_to_dbl_fcnvuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* dbl/sgl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_to_sgl_fcnvuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* dbl/dbl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_to_dbl_fcnvuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="mi">6</span>: <span class="cm">/* FCNVFU (PA2.0 only) */</span>
				<span class="k">switch</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* sgl/sgl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_to_sgl_fcnvfu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* sgl/dbl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_to_dbl_fcnvfu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* dbl/sgl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_to_sgl_fcnvfu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* dbl/dbl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_to_dbl_fcnvfu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="mi">7</span>: <span class="cm">/* FCNVFUT (PA2.0 only) */</span>
				<span class="k">switch</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* sgl/sgl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_to_sgl_fcnvfut</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* sgl/dbl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_to_dbl_fcnvfut</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* dbl/sgl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_to_sgl_fcnvfut</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* dbl/dbl */</span>
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_to_dbl_fcnvfut</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="mi">4</span>: <span class="cm">/* undefined */</span>
				<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0C_EXCP</span><span class="p">);</span>
		<span class="p">}</span> <span class="cm">/* end of switch subop */</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* class 2 */</span>
		<span class="cm">/*</span>
<span class="cm">		 * Be careful out there.</span>
<span class="cm">		 * Crashme can generate cases where FR31R is specified</span>
<span class="cm">		 * as the source or target of a double precision operation.</span>
<span class="cm">		 * Since we just pass the address of the floating-point</span>
<span class="cm">		 * register to the emulation routines, this can cause</span>
<span class="cm">		 * corruption of fpzeroreg.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">==</span> <span class="n">DBL</span><span class="p">)</span>
			<span class="n">r2</span> <span class="o">=</span> <span class="p">(</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fpr2pos</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">r2</span> <span class="o">=</span> <span class="p">((</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fpr2pos</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fpxr2pos</span><span class="p">,</span><span class="mi">1</span><span class="p">)));</span>
		<span class="n">fpu_type_flags</span><span class="o">=</span><span class="n">fpregs</span><span class="p">[</span><span class="n">FPU_TYPE_FLAG_POS</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">r2</span> <span class="o">=</span> <span class="n">fpzeroreg</span><span class="p">;</span>
		<span class="k">if</span>  <span class="p">(</span><span class="n">fpu_type_flags</span> <span class="o">&amp;</span> <span class="n">PA2_0_FPU_FLAG</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* FTEST if nullify bit set, otherwise FCMP */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">fpnulpos</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>  <span class="cm">/* FTEST */</span>
				<span class="cm">/* not legal */</span>
				<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0E_EXCP</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>  <span class="cm">/* FCMP */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="cm">/*</span>
<span class="cm">				     * fmt is only 1 bit long</span>
<span class="cm">				     */</span>
				    <span class="k">case</span> <span class="mi">0</span>:
					<span class="n">retval</span> <span class="o">=</span> <span class="n">sgl_fcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r2</span><span class="p">],</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fptpos</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span>
						<span class="o">&amp;</span><span class="n">local_status</span><span class="p">);</span>
					<span class="n">update_status_cbit</span><span class="p">(</span><span class="n">status</span><span class="p">,</span><span class="n">local_status</span><span class="p">,</span>
						<span class="n">fpu_type_flags</span><span class="p">,</span> <span class="n">subop</span><span class="p">);</span>
					<span class="k">return</span><span class="p">(</span><span class="n">retval</span><span class="p">);</span>
				    <span class="k">case</span> <span class="mi">1</span>:
					<span class="n">retval</span> <span class="o">=</span> <span class="n">dbl_fcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r2</span><span class="p">],</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fptpos</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span>
						<span class="o">&amp;</span><span class="n">local_status</span><span class="p">);</span>
					<span class="n">update_status_cbit</span><span class="p">(</span><span class="n">status</span><span class="p">,</span><span class="n">local_status</span><span class="p">,</span>
						<span class="n">fpu_type_flags</span><span class="p">,</span> <span class="n">subop</span><span class="p">);</span>
					<span class="k">return</span><span class="p">(</span><span class="n">retval</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>  <span class="cm">/* end of if for PA2.0 */</span>
		<span class="k">else</span> <span class="p">{</span>  <span class="cm">/* PA1.0 &amp; PA1.1 */</span>
		    <span class="k">switch</span> <span class="p">(</span><span class="n">subop</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">1</span>:
			<span class="k">case</span> <span class="mi">2</span>:
			<span class="k">case</span> <span class="mi">3</span>:
			<span class="k">case</span> <span class="mi">4</span>:
			<span class="k">case</span> <span class="mi">5</span>:
			<span class="k">case</span> <span class="mi">6</span>:
			<span class="k">case</span> <span class="mi">7</span>:
				<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0E_EXCP</span><span class="p">);</span>
			<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* FCMP */</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="cm">/*</span>
<span class="cm">				     * fmt is only 1 bit long</span>
<span class="cm">				     */</span>
				    <span class="k">case</span> <span class="mi">0</span>:
					<span class="n">retval</span> <span class="o">=</span> <span class="n">sgl_fcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r2</span><span class="p">],</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fptpos</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span>
						<span class="o">&amp;</span><span class="n">local_status</span><span class="p">);</span>
					<span class="n">update_status_cbit</span><span class="p">(</span><span class="n">status</span><span class="p">,</span><span class="n">local_status</span><span class="p">,</span>
						<span class="n">fpu_type_flags</span><span class="p">,</span> <span class="n">subop</span><span class="p">);</span>
					<span class="k">return</span><span class="p">(</span><span class="n">retval</span><span class="p">);</span>
				    <span class="k">case</span> <span class="mi">1</span>:
					<span class="n">retval</span> <span class="o">=</span> <span class="n">dbl_fcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r2</span><span class="p">],</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fptpos</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span>
						<span class="o">&amp;</span><span class="n">local_status</span><span class="p">);</span>
					<span class="n">update_status_cbit</span><span class="p">(</span><span class="n">status</span><span class="p">,</span><span class="n">local_status</span><span class="p">,</span>
						<span class="n">fpu_type_flags</span><span class="p">,</span> <span class="n">subop</span><span class="p">);</span>
					<span class="k">return</span><span class="p">(</span><span class="n">retval</span><span class="p">);</span>
				<span class="p">}</span>
		    <span class="p">}</span> <span class="cm">/* end of switch subop */</span>
		<span class="p">}</span> <span class="cm">/* end of else for PA1.0 &amp; PA1.1 */</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* class 3 */</span>
		<span class="cm">/*</span>
<span class="cm">		 * Be careful out there.</span>
<span class="cm">		 * Crashme can generate cases where FR31R is specified</span>
<span class="cm">		 * as the source or target of a double precision operation.</span>
<span class="cm">		 * Since we just pass the address of the floating-point</span>
<span class="cm">		 * register to the emulation routines, this can cause</span>
<span class="cm">		 * corruption of fpzeroreg.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">==</span> <span class="n">DBL</span><span class="p">)</span>
			<span class="n">r2</span> <span class="o">=</span> <span class="p">(</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fpr2pos</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">r2</span> <span class="o">=</span> <span class="p">((</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fpr2pos</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fpxr2pos</span><span class="p">,</span><span class="mi">1</span><span class="p">)));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">r2</span> <span class="o">=</span> <span class="n">fpzeroreg</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">subop</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">5</span>:
			<span class="k">case</span> <span class="mi">6</span>:
			<span class="k">case</span> <span class="mi">7</span>:
				<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0E_EXCP</span><span class="p">);</span>
			
			<span class="cm">/*</span>
<span class="cm">			 * Note that fmt is only 1 bit for class 3 */</span>
			<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* FADD */</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">0</span>:
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_fadd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r2</span><span class="p">],</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">1</span>:
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_fadd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r2</span><span class="p">],</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* FSUB */</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">0</span>:
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_fsub</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r2</span><span class="p">],</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">1</span>:
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_fsub</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r2</span><span class="p">],</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* FMPY or XMPYU */</span>
				<span class="cm">/*</span>
<span class="cm">				 * check for integer multiply (x bit set)</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fpxpos</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				    <span class="cm">/*</span>
<span class="cm">				     * emulate XMPYU</span>
<span class="cm">				     */</span>
				    <span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">case</span> <span class="mi">0</span>:
					    <span class="cm">/*</span>
<span class="cm">					     * bad instruction if t specifies</span>
<span class="cm">					     * the right half of a register</span>
<span class="cm">					     */</span>
					    <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
						<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0E_EXCP</span><span class="p">);</span>
					    <span class="n">BUG</span><span class="p">();</span>
					    <span class="cm">/* unsupported</span>
<span class="cm">					     * impyu(&amp;fpregs[r1],&amp;fpregs[r2],</span>
<span class="cm">						 * &amp;fpregs[t]);</span>
<span class="cm">					     */</span>
					    <span class="k">return</span><span class="p">(</span><span class="n">NOEXCEPTION</span><span class="p">);</span>
					<span class="k">case</span> <span class="mi">1</span>:
						<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0E_EXCP</span><span class="p">);</span>
				    <span class="p">}</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="p">{</span> <span class="cm">/* FMPY */</span>
				    <span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				        <span class="k">case</span> <span class="mi">0</span>:
					    <span class="k">return</span><span class="p">(</span><span class="n">sgl_fmpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span>
					       <span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r2</span><span class="p">],</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				        <span class="k">case</span> <span class="mi">1</span>:
					    <span class="k">return</span><span class="p">(</span><span class="n">dbl_fmpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span>
					       <span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r2</span><span class="p">],</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="p">}</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* FDIV */</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">0</span>:
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_fdiv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r2</span><span class="p">],</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">1</span>:
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_fdiv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r2</span><span class="p">],</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="mi">4</span>: <span class="cm">/* FREM */</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
				    <span class="k">case</span> <span class="mi">0</span>:
					<span class="k">return</span><span class="p">(</span><span class="n">sgl_frem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r2</span><span class="p">],</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				    <span class="k">case</span> <span class="mi">1</span>:
					<span class="k">return</span><span class="p">(</span><span class="n">dbl_frem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r1</span><span class="p">],</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">r2</span><span class="p">],</span>
						<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="n">status</span><span class="p">));</span>
				<span class="p">}</span>
		<span class="p">}</span> <span class="cm">/* end of class 3 switch */</span>
	<span class="p">}</span> <span class="cm">/* end of switch(class) */</span>

	<span class="cm">/* If we get here, something is really wrong! */</span>
	<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_0E_EXCP</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * routine to decode the 06 (FMPYADD and FMPYCFXT) instruction</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u_int</span>
<span class="n">decode_06</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fpregs</span><span class="p">)</span>
<span class="n">u_int</span> <span class="n">ir</span><span class="p">;</span>
<span class="n">u_int</span> <span class="n">fpregs</span><span class="p">[];</span>
<span class="p">{</span>
	<span class="n">u_int</span> <span class="n">rm1</span><span class="p">,</span> <span class="n">rm2</span><span class="p">,</span> <span class="n">tm</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">ta</span><span class="p">;</span> <span class="cm">/* operands */</span>
	<span class="n">u_int</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">fpu_type_flags</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="kt">double</span> <span class="n">dbl</span><span class="p">;</span>
		<span class="kt">float</span> <span class="n">flt</span><span class="p">;</span>
		<span class="k">struct</span> <span class="p">{</span> <span class="n">u_int</span> <span class="n">i1</span><span class="p">;</span> <span class="n">u_int</span> <span class="n">i2</span><span class="p">;</span> <span class="p">}</span> <span class="n">ints</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">mtmp</span><span class="p">,</span> <span class="n">atmp</span><span class="p">;</span>


	<span class="n">status</span> <span class="o">=</span> <span class="n">fpregs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>		<span class="cm">/* use a local copy of status reg */</span>
	<span class="n">fpu_type_flags</span><span class="o">=</span><span class="n">fpregs</span><span class="p">[</span><span class="n">FPU_TYPE_FLAG_POS</span><span class="p">];</span>  <span class="cm">/* get fpu type flags */</span>
	<span class="n">fmt</span> <span class="o">=</span> <span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">fpmultifmt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* get sgl/dbl flag */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* DBL */</span>
		<span class="n">rm1</span> <span class="o">=</span> <span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">fprm1pos</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u_int</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rm1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rm1</span> <span class="o">=</span> <span class="n">fpzeroreg</span><span class="p">;</span>
		<span class="n">rm2</span> <span class="o">=</span> <span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">fprm2pos</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u_int</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rm2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rm2</span> <span class="o">=</span> <span class="n">fpzeroreg</span><span class="p">;</span>
		<span class="n">tm</span> <span class="o">=</span> <span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">fptmpos</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u_int</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tm</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_06_EXCP</span><span class="p">);</span>
		<span class="n">ra</span> <span class="o">=</span> <span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">fprapos</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u_int</span><span class="p">);</span>
		<span class="n">ta</span> <span class="o">=</span> <span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">fptapos</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u_int</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ta</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_06_EXCP</span><span class="p">);</span>

		<span class="k">if</span>  <span class="p">(</span><span class="n">fpu_type_flags</span> <span class="o">&amp;</span> <span class="n">TIMEX_ROLEX_FPU_MASK</span><span class="p">)</span>  <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ra</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			 	<span class="cm">/* special case FMPYCFXT, see sgl case below */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dbl_fmpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">rm1</span><span class="p">],</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">rm2</span><span class="p">],</span>
					<span class="o">&amp;</span><span class="n">mtmp</span><span class="p">.</span><span class="n">ints</span><span class="p">.</span><span class="n">i1</span><span class="p">,</span><span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
					<span class="n">error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dbl_to_sgl_fcnvfxt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">ta</span><span class="p">],</span>
					<span class="o">&amp;</span><span class="n">atmp</span><span class="p">.</span><span class="n">ints</span><span class="p">.</span><span class="n">i1</span><span class="p">,</span><span class="o">&amp;</span><span class="n">atmp</span><span class="p">.</span><span class="n">ints</span><span class="p">.</span><span class="n">i1</span><span class="p">,</span><span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
					<span class="n">error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dbl_fmpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">rm1</span><span class="p">],</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">rm2</span><span class="p">],</span><span class="o">&amp;</span><span class="n">mtmp</span><span class="p">.</span><span class="n">ints</span><span class="p">.</span><span class="n">i1</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="n">error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dbl_fadd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">ta</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">ra</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">atmp</span><span class="p">.</span><span class="n">ints</span><span class="p">.</span><span class="n">i1</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="n">error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

		<span class="k">else</span>

			<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ra</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">ra</span> <span class="o">=</span> <span class="n">fpzeroreg</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dbl_fmpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">rm1</span><span class="p">],</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">rm2</span><span class="p">],</span><span class="o">&amp;</span><span class="n">mtmp</span><span class="p">.</span><span class="n">ints</span><span class="p">.</span><span class="n">i1</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="n">error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dbl_fadd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">ta</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">ra</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">atmp</span><span class="p">.</span><span class="n">ints</span><span class="p">.</span><span class="n">i1</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="n">error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_06_EXCP</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* copy results */</span>
			<span class="n">fpregs</span><span class="p">[</span><span class="n">tm</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtmp</span><span class="p">.</span><span class="n">ints</span><span class="p">.</span><span class="n">i1</span><span class="p">;</span>
			<span class="n">fpregs</span><span class="p">[</span><span class="n">tm</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtmp</span><span class="p">.</span><span class="n">ints</span><span class="p">.</span><span class="n">i2</span><span class="p">;</span>
			<span class="n">fpregs</span><span class="p">[</span><span class="n">ta</span><span class="p">]</span> <span class="o">=</span> <span class="n">atmp</span><span class="p">.</span><span class="n">ints</span><span class="p">.</span><span class="n">i1</span><span class="p">;</span>
			<span class="n">fpregs</span><span class="p">[</span><span class="n">ta</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">atmp</span><span class="p">.</span><span class="n">ints</span><span class="p">.</span><span class="n">i2</span><span class="p">;</span>
			<span class="n">fpregs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
			<span class="k">return</span><span class="p">(</span><span class="n">NOEXCEPTION</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span> <span class="cm">/* SGL */</span>
		<span class="cm">/*</span>
<span class="cm">		 * calculate offsets for single precision numbers</span>
<span class="cm">		 * See table 6-14 in PA-89 architecture for mapping</span>
<span class="cm">		 */</span>
		<span class="n">rm1</span> <span class="o">=</span> <span class="p">(</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fprm1pos</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x10</span> <span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* get offset */</span>
		<span class="n">rm1</span> <span class="o">|=</span> <span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fprm1pos</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* add right word offset */</span>

		<span class="n">rm2</span> <span class="o">=</span> <span class="p">(</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fprm2pos</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x10</span> <span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* get offset */</span>
		<span class="n">rm2</span> <span class="o">|=</span> <span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fprm2pos</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* add right word offset */</span>

		<span class="n">tm</span> <span class="o">=</span> <span class="p">(</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fptmpos</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x10</span> <span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* get offset */</span>
		<span class="n">tm</span> <span class="o">|=</span> <span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fptmpos</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* add right word offset */</span>

		<span class="n">ra</span> <span class="o">=</span> <span class="p">(</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fprapos</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x10</span> <span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* get offset */</span>
		<span class="n">ra</span> <span class="o">|=</span> <span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fprapos</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* add right word offset */</span>

		<span class="n">ta</span> <span class="o">=</span> <span class="p">(</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fptapos</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x10</span> <span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* get offset */</span>
		<span class="n">ta</span> <span class="o">|=</span> <span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fptapos</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* add right word offset */</span>
		
		<span class="k">if</span> <span class="p">(</span><span class="n">ra</span> <span class="o">==</span> <span class="mh">0x20</span> <span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">fpu_type_flags</span> <span class="o">&amp;</span> <span class="n">TIMEX_ROLEX_FPU_MASK</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* special case FMPYCFXT (really 0)</span>
<span class="cm">			  * This instruction is only present on the Timex and</span>
<span class="cm">			  * Rolex fpu&#39;s in so if it is the special case and</span>
<span class="cm">			  * one of these fpu&#39;s we run the FMPYCFXT instruction</span>
<span class="cm">			  */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sgl_fmpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">rm1</span><span class="p">],</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">rm2</span><span class="p">],</span><span class="o">&amp;</span><span class="n">mtmp</span><span class="p">.</span><span class="n">ints</span><span class="p">.</span><span class="n">i1</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="n">error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sgl_to_sgl_fcnvfxt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">ta</span><span class="p">],</span><span class="o">&amp;</span><span class="n">atmp</span><span class="p">.</span><span class="n">ints</span><span class="p">.</span><span class="n">i1</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">atmp</span><span class="p">.</span><span class="n">ints</span><span class="p">.</span><span class="n">i1</span><span class="p">,</span><span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="n">error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sgl_fmpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">rm1</span><span class="p">],</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">rm2</span><span class="p">],</span><span class="o">&amp;</span><span class="n">mtmp</span><span class="p">.</span><span class="n">ints</span><span class="p">.</span><span class="n">i1</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="n">error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sgl_fadd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">ta</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">ra</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">atmp</span><span class="p">.</span><span class="n">ints</span><span class="p">.</span><span class="n">i1</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="n">error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_06_EXCP</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* copy results */</span>
			<span class="n">fpregs</span><span class="p">[</span><span class="n">tm</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtmp</span><span class="p">.</span><span class="n">ints</span><span class="p">.</span><span class="n">i1</span><span class="p">;</span>
			<span class="n">fpregs</span><span class="p">[</span><span class="n">ta</span><span class="p">]</span> <span class="o">=</span> <span class="n">atmp</span><span class="p">.</span><span class="n">ints</span><span class="p">.</span><span class="n">i1</span><span class="p">;</span>
			<span class="n">fpregs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
			<span class="k">return</span><span class="p">(</span><span class="n">NOEXCEPTION</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * routine to decode the 26 (FMPYSUB) instruction</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u_int</span>
<span class="n">decode_26</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fpregs</span><span class="p">)</span>
<span class="n">u_int</span> <span class="n">ir</span><span class="p">;</span>
<span class="n">u_int</span> <span class="n">fpregs</span><span class="p">[];</span>
<span class="p">{</span>
	<span class="n">u_int</span> <span class="n">rm1</span><span class="p">,</span> <span class="n">rm2</span><span class="p">,</span> <span class="n">tm</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">ta</span><span class="p">;</span> <span class="cm">/* operands */</span>
	<span class="n">u_int</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="kt">double</span> <span class="n">dbl</span><span class="p">;</span>
		<span class="kt">float</span> <span class="n">flt</span><span class="p">;</span>
		<span class="k">struct</span> <span class="p">{</span> <span class="n">u_int</span> <span class="n">i1</span><span class="p">;</span> <span class="n">u_int</span> <span class="n">i2</span><span class="p">;</span> <span class="p">}</span> <span class="n">ints</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">mtmp</span><span class="p">,</span> <span class="n">atmp</span><span class="p">;</span>


	<span class="n">status</span> <span class="o">=</span> <span class="n">fpregs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">fmt</span> <span class="o">=</span> <span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">fpmultifmt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* get sgl/dbl flag */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* DBL */</span>
		<span class="n">rm1</span> <span class="o">=</span> <span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">fprm1pos</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u_int</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rm1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rm1</span> <span class="o">=</span> <span class="n">fpzeroreg</span><span class="p">;</span>
		<span class="n">rm2</span> <span class="o">=</span> <span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">fprm2pos</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u_int</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rm2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rm2</span> <span class="o">=</span> <span class="n">fpzeroreg</span><span class="p">;</span>
		<span class="n">tm</span> <span class="o">=</span> <span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">fptmpos</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u_int</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tm</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_26_EXCP</span><span class="p">);</span>
		<span class="n">ra</span> <span class="o">=</span> <span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">fprapos</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u_int</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ra</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_26_EXCP</span><span class="p">);</span>
		<span class="n">ta</span> <span class="o">=</span> <span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">fptapos</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u_int</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ta</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_26_EXCP</span><span class="p">);</span>
		
		<span class="k">if</span> <span class="p">(</span><span class="n">dbl_fmpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">rm1</span><span class="p">],</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">rm2</span><span class="p">],</span><span class="o">&amp;</span><span class="n">mtmp</span><span class="p">.</span><span class="n">ints</span><span class="p">.</span><span class="n">i1</span><span class="p">,</span><span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
			<span class="n">error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dbl_fsub</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">ta</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">ra</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">atmp</span><span class="p">.</span><span class="n">ints</span><span class="p">.</span><span class="n">i1</span><span class="p">,</span><span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
			<span class="n">error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_26_EXCP</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* copy results */</span>
			<span class="n">fpregs</span><span class="p">[</span><span class="n">tm</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtmp</span><span class="p">.</span><span class="n">ints</span><span class="p">.</span><span class="n">i1</span><span class="p">;</span>
			<span class="n">fpregs</span><span class="p">[</span><span class="n">tm</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtmp</span><span class="p">.</span><span class="n">ints</span><span class="p">.</span><span class="n">i2</span><span class="p">;</span>
			<span class="n">fpregs</span><span class="p">[</span><span class="n">ta</span><span class="p">]</span> <span class="o">=</span> <span class="n">atmp</span><span class="p">.</span><span class="n">ints</span><span class="p">.</span><span class="n">i1</span><span class="p">;</span>
			<span class="n">fpregs</span><span class="p">[</span><span class="n">ta</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">atmp</span><span class="p">.</span><span class="n">ints</span><span class="p">.</span><span class="n">i2</span><span class="p">;</span>
			<span class="n">fpregs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
			<span class="k">return</span><span class="p">(</span><span class="n">NOEXCEPTION</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span> <span class="cm">/* SGL */</span>
		<span class="cm">/*</span>
<span class="cm">		 * calculate offsets for single precision numbers</span>
<span class="cm">		 * See table 6-14 in PA-89 architecture for mapping</span>
<span class="cm">		 */</span>
		<span class="n">rm1</span> <span class="o">=</span> <span class="p">(</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fprm1pos</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x10</span> <span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* get offset */</span>
		<span class="n">rm1</span> <span class="o">|=</span> <span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fprm1pos</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* add right word offset */</span>

		<span class="n">rm2</span> <span class="o">=</span> <span class="p">(</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fprm2pos</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x10</span> <span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* get offset */</span>
		<span class="n">rm2</span> <span class="o">|=</span> <span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fprm2pos</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* add right word offset */</span>

		<span class="n">tm</span> <span class="o">=</span> <span class="p">(</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fptmpos</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x10</span> <span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* get offset */</span>
		<span class="n">tm</span> <span class="o">|=</span> <span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fptmpos</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* add right word offset */</span>

		<span class="n">ra</span> <span class="o">=</span> <span class="p">(</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fprapos</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x10</span> <span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* get offset */</span>
		<span class="n">ra</span> <span class="o">|=</span> <span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fprapos</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* add right word offset */</span>

		<span class="n">ta</span> <span class="o">=</span> <span class="p">(</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fptapos</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x10</span> <span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* get offset */</span>
		<span class="n">ta</span> <span class="o">|=</span> <span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fptapos</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* add right word offset */</span>
		
		<span class="k">if</span> <span class="p">(</span><span class="n">sgl_fmpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">rm1</span><span class="p">],</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">rm2</span><span class="p">],</span><span class="o">&amp;</span><span class="n">mtmp</span><span class="p">.</span><span class="n">ints</span><span class="p">.</span><span class="n">i1</span><span class="p">,</span><span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
			<span class="n">error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sgl_fsub</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">ta</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">ra</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">atmp</span><span class="p">.</span><span class="n">ints</span><span class="p">.</span><span class="n">i1</span><span class="p">,</span><span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
			<span class="n">error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_26_EXCP</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* copy results */</span>
			<span class="n">fpregs</span><span class="p">[</span><span class="n">tm</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtmp</span><span class="p">.</span><span class="n">ints</span><span class="p">.</span><span class="n">i1</span><span class="p">;</span>
			<span class="n">fpregs</span><span class="p">[</span><span class="n">ta</span><span class="p">]</span> <span class="o">=</span> <span class="n">atmp</span><span class="p">.</span><span class="n">ints</span><span class="p">.</span><span class="n">i1</span><span class="p">;</span>
			<span class="n">fpregs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
			<span class="k">return</span><span class="p">(</span><span class="n">NOEXCEPTION</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * routine to decode the 2E (FMPYFADD,FMPYNFADD) instructions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u_int</span>
<span class="n">decode_2e</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fpregs</span><span class="p">)</span>
<span class="n">u_int</span> <span class="n">ir</span><span class="p">;</span>
<span class="n">u_int</span> <span class="n">fpregs</span><span class="p">[];</span>
<span class="p">{</span>
	<span class="n">u_int</span> <span class="n">rm1</span><span class="p">,</span> <span class="n">rm2</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">t</span><span class="p">;</span> <span class="cm">/* operands */</span>
	<span class="n">u_int</span> <span class="n">fmt</span><span class="p">;</span>

	<span class="n">fmt</span> <span class="o">=</span> <span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fpfmtpos</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* get fmt completer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">==</span> <span class="n">DBL</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* DBL */</span>
		<span class="n">rm1</span> <span class="o">=</span> <span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fprm1pos</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u_int</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rm1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rm1</span> <span class="o">=</span> <span class="n">fpzeroreg</span><span class="p">;</span>
		<span class="n">rm2</span> <span class="o">=</span> <span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fprm2pos</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u_int</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rm2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rm2</span> <span class="o">=</span> <span class="n">fpzeroreg</span><span class="p">;</span>
		<span class="n">ra</span> <span class="o">=</span> <span class="p">((</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fpraupos</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fpralpos</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span>
		     <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u_int</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ra</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ra</span> <span class="o">=</span> <span class="n">fpzeroreg</span><span class="p">;</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fptpos</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u_int</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_2E_EXCP</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fpfusedsubop</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* fmpyfadd or fmpynfadd? */</span>
			<span class="k">return</span><span class="p">(</span><span class="n">dbl_fmpynfadd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">rm1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">rm2</span><span class="p">],</span>
					<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">ra</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">]));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span><span class="p">(</span><span class="n">dbl_fmpyfadd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">rm1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">rm2</span><span class="p">],</span>
					<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">ra</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">]));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="cm">/* end DBL */</span>
	<span class="k">else</span> <span class="p">{</span> <span class="cm">/* SGL */</span>
		<span class="n">rm1</span> <span class="o">=</span> <span class="p">(</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fprm1pos</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fpxrm1pos</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rm1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rm1</span> <span class="o">=</span> <span class="n">fpzeroreg</span><span class="p">;</span>
		<span class="n">rm2</span> <span class="o">=</span> <span class="p">(</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fprm2pos</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fpxrm2pos</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rm2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rm2</span> <span class="o">=</span> <span class="n">fpzeroreg</span><span class="p">;</span>
		<span class="n">ra</span> <span class="o">=</span> <span class="p">(</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fpraupos</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">)</span><span class="o">|</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fpralpos</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ra</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ra</span> <span class="o">=</span> <span class="n">fpzeroreg</span><span class="p">;</span>
		<span class="n">t</span> <span class="o">=</span> <span class="p">((</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fptpos</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fpxtpos</span><span class="p">,</span><span class="mi">1</span><span class="p">)));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">(</span><span class="n">MAJOR_2E_EXCP</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">extru</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="n">fpfusedsubop</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* fmpyfadd or fmpynfadd? */</span>
			<span class="k">return</span><span class="p">(</span><span class="n">sgl_fmpynfadd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">rm1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">rm2</span><span class="p">],</span>
					<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">ra</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">]));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span><span class="p">(</span><span class="n">sgl_fmpyfadd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">rm1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">rm2</span><span class="p">],</span>
					<span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">ra</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">fpregs</span><span class="p">[</span><span class="n">t</span><span class="p">]));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="cm">/* end SGL */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * update_status_cbit</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine returns the correct FP status register value in</span>
<span class="cm"> *	*status, based on the C-bit &amp; V-bit returned by the FCMP</span>
<span class="cm"> *	emulation routine in new_status.  The architecture type</span>
<span class="cm"> *	(PA83, PA89 or PA2.0) is available in fpu_type.  The y_field</span>
<span class="cm"> *	and the architecture type are used to determine what flavor</span>
<span class="cm"> *	of FCMP is being emulated.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="n">update_status_cbit</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">new_status</span><span class="p">,</span> <span class="n">fpu_type</span><span class="p">,</span> <span class="n">y_field</span><span class="p">)</span>
<span class="n">u_int</span> <span class="o">*</span><span class="n">status</span><span class="p">,</span> <span class="n">new_status</span><span class="p">;</span>
<span class="n">u_int</span> <span class="n">fpu_type</span><span class="p">;</span>
<span class="n">u_int</span> <span class="n">y_field</span><span class="p">;</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * For PA89 FPU&#39;s which implement the Compare Queue and</span>
<span class="cm">	 * for PA2.0 FPU&#39;s, update the Compare Queue if the y-field = 0,</span>
<span class="cm">	 * otherwise update the specified bit in the Compare Array.</span>
<span class="cm">	 * Note that the y-field will always be 0 for non-PA2.0 FPU&#39;s.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fpu_type</span> <span class="o">&amp;</span> <span class="n">TIMEX_EXTEN_FLAG</span><span class="p">)</span> <span class="o">||</span> 
	    <span class="p">(</span><span class="n">fpu_type</span> <span class="o">&amp;</span> <span class="n">ROLEX_EXTEN_FLAG</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">fpu_type</span> <span class="o">&amp;</span> <span class="n">PA2_0_FPU_FLAG</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">y_field</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x04000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* old Cbit */</span>
				  <span class="p">((</span><span class="o">*</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x003ff000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* old CQ   */</span>
				  <span class="p">(</span><span class="n">new_status</span> <span class="o">&amp;</span> <span class="mh">0xffc007ff</span><span class="p">);</span> <span class="cm">/* all other bits*/</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x04000000</span><span class="p">)</span> <span class="o">|</span>     <span class="cm">/* old Cbit */</span>
				  <span class="p">((</span><span class="n">new_status</span> <span class="o">&amp;</span> <span class="mh">0x04000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">y_field</span><span class="o">+</span><span class="mi">4</span><span class="p">))</span> <span class="o">|</span>
				  <span class="p">(</span><span class="n">new_status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x04000000</span> <span class="o">&amp;</span>  <span class="cm">/* other bits */</span>
				   <span class="o">~</span><span class="p">(</span><span class="mh">0x04000000</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">y_field</span><span class="o">+</span><span class="mi">4</span><span class="p">)));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* if PA83, just update the C-bit */</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">new_status</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
