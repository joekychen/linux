<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › parisc › lib › memcpy.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>memcpy.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *    Optimized memory copy routines.</span>
<span class="cm"> *</span>
<span class="cm"> *    Copyright (C) 2004 Randolph Chung &lt;tausq@debian.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *    This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *    it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *    the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm"> *    any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *    This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *    GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *    You should have received a copy of the GNU General Public License</span>
<span class="cm"> *    along with this program; if not, write to the Free Software</span>
<span class="cm"> *    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> *    Portions derived from the GNU C Library</span>
<span class="cm"> *    Copyright (C) 1991, 1997, 2003 Free Software Foundation, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Several strategies are tried to try to get the best performance for various</span>
<span class="cm"> * conditions. In the optimal case, we copy 64-bytes in an unrolled loop using </span>
<span class="cm"> * fp regs. This is followed by loops that copy 32- or 16-bytes at a time using</span>
<span class="cm"> * general registers.  Unaligned copies are handled either by aligning the </span>
<span class="cm"> * destination and then using shift-and-write method, or in a few cases by </span>
<span class="cm"> * falling back to a byte-at-a-time copy.</span>
<span class="cm"> *</span>
<span class="cm"> * I chose to implement this in C because it is easier to maintain and debug,</span>
<span class="cm"> * and in my experiments it appears that the C code generated by gcc (3.3/3.4</span>
<span class="cm"> * at the time of writing) is fairly optimal. Unfortunately some of the </span>
<span class="cm"> * semantics of the copy routine (exception handling) is difficult to express</span>
<span class="cm"> * in C, so we have to play some tricks to get it to work.</span>
<span class="cm"> *</span>
<span class="cm"> * All the loads and stores are done via explicit asm() code in order to use</span>
<span class="cm"> * the right space registers. </span>
<span class="cm"> * </span>
<span class="cm"> * Testing with various alignments and buffer sizes shows that this code is </span>
<span class="cm"> * often &gt;10x faster than a simple byte-at-a-time copy, even for strangely</span>
<span class="cm"> * aligned operands. It is interesting to note that the glibc version</span>
<span class="cm"> * of memcpy (written in C) is actually quite fast already. This routine is </span>
<span class="cm"> * able to beat it by 30-40% for aligned copies because of the loop unrolling, </span>
<span class="cm"> * but in some cases the glibc version is still slightly faster. This lends </span>
<span class="cm"> * more credibility that gcc can generate very good code as long as we are </span>
<span class="cm"> * careful.</span>
<span class="cm"> *</span>
<span class="cm"> * TODO:</span>
<span class="cm"> * - cache prefetching needs more experimentation to get optimal settings</span>
<span class="cm"> * - try not to use the post-increment address modifiers; they create additional</span>
<span class="cm"> *   interlocks</span>
<span class="cm"> * - replace byte-copy loops with stybs sequences</span>
<span class="cm"> */</span>

<span class="cp">#ifdef __KERNEL__</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/compiler.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#define s_space &quot;%%sr1&quot;</span>
<span class="cp">#define d_space &quot;%%sr2&quot;</span>
<span class="cp">#else</span>
<span class="cp">#include &quot;memcpy.h&quot;</span>
<span class="cp">#define s_space &quot;%%sr0&quot;</span>
<span class="cp">#define d_space &quot;%%sr0&quot;</span>
<span class="cp">#define pa_memcpy new2_copy</span>
<span class="cp">#endif</span>

<span class="n">DECLARE_PER_CPU</span><span class="p">(</span><span class="k">struct</span> <span class="n">exception_data</span><span class="p">,</span> <span class="n">exception_data</span><span class="p">);</span>

<span class="cp">#define preserve_branch(label)	do {					\</span>
<span class="cp">	volatile int dummy;						\</span>
<span class="cp">	</span><span class="cm">/* The following branch is never taken, it&#39;s just here to  */</span><span class="cp">	\</span>
<span class="cp">	</span><span class="cm">/* prevent gcc from optimizing away our exception code. */</span><span class="cp"> 	\</span>
<span class="cp">	if (unlikely(dummy != dummy))					\</span>
<span class="cp">		goto label;						\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define get_user_space() (segment_eq(get_fs(), KERNEL_DS) ? 0 : mfsp(3))</span>
<span class="cp">#define get_kernel_space() (0)</span>

<span class="cp">#define MERGE(w0, sh_1, w1, sh_2)  ({					\</span>
<span class="cp">	unsigned int _r;						\</span>
<span class="cp">	asm volatile (							\</span>
<span class="cp">	&quot;mtsar %3\n&quot;							\</span>
<span class="cp">	&quot;shrpw %1, %2, %%sar, %0\n&quot;					\</span>
<span class="cp">	: &quot;=r&quot;(_r)							\</span>
<span class="cp">	: &quot;r&quot;(w0), &quot;r&quot;(w1), &quot;r&quot;(sh_2)					\</span>
<span class="cp">	);								\</span>
<span class="cp">	_r;								\</span>
<span class="cp">})</span>
<span class="cp">#define THRESHOLD	16</span>

<span class="cp">#ifdef DEBUG_MEMCPY</span>
<span class="cp">#define DPRINTF(fmt, args...) do { printk(KERN_DEBUG &quot;%s:%d:%s &quot;, __FILE__, __LINE__, __func__ ); printk(KERN_DEBUG fmt, ##args ); } while (0)</span>
<span class="cp">#else</span>
<span class="cp">#define DPRINTF(fmt, args...)</span>
<span class="cp">#endif</span>

<span class="cp">#define def_load_ai_insn(_insn,_sz,_tt,_s,_a,_t,_e)	\</span>
<span class="cp">	__asm__ __volatile__ (				\</span>
<span class="cp">	&quot;1:\t&quot; #_insn &quot;,ma &quot; #_sz &quot;(&quot; _s &quot;,%1), %0\n\t&quot;	\</span>
<span class="cp">	ASM_EXCEPTIONTABLE_ENTRY(1b,_e)			\</span>
<span class="cp">	: _tt(_t), &quot;+r&quot;(_a)				\</span>
<span class="cp">	: 						\</span>
<span class="cp">	: &quot;r8&quot;)</span>

<span class="cp">#define def_store_ai_insn(_insn,_sz,_tt,_s,_a,_t,_e) 	\</span>
<span class="cp">	__asm__ __volatile__ (				\</span>
<span class="cp">	&quot;1:\t&quot; #_insn &quot;,ma %1, &quot; #_sz &quot;(&quot; _s &quot;,%0)\n\t&quot;	\</span>
<span class="cp">	ASM_EXCEPTIONTABLE_ENTRY(1b,_e)			\</span>
<span class="cp">	: &quot;+r&quot;(_a) 					\</span>
<span class="cp">	: _tt(_t)					\</span>
<span class="cp">	: &quot;r8&quot;)</span>

<span class="cp">#define ldbma(_s, _a, _t, _e) def_load_ai_insn(ldbs,1,&quot;=r&quot;,_s,_a,_t,_e)</span>
<span class="cp">#define stbma(_s, _t, _a, _e) def_store_ai_insn(stbs,1,&quot;r&quot;,_s,_a,_t,_e)</span>
<span class="cp">#define ldwma(_s, _a, _t, _e) def_load_ai_insn(ldw,4,&quot;=r&quot;,_s,_a,_t,_e)</span>
<span class="cp">#define stwma(_s, _t, _a, _e) def_store_ai_insn(stw,4,&quot;r&quot;,_s,_a,_t,_e)</span>
<span class="cp">#define flddma(_s, _a, _t, _e) def_load_ai_insn(fldd,8,&quot;=f&quot;,_s,_a,_t,_e)</span>
<span class="cp">#define fstdma(_s, _t, _a, _e) def_store_ai_insn(fstd,8,&quot;f&quot;,_s,_a,_t,_e)</span>

<span class="cp">#define def_load_insn(_insn,_tt,_s,_o,_a,_t,_e) 	\</span>
<span class="cp">	__asm__ __volatile__ (				\</span>
<span class="cp">	&quot;1:\t&quot; #_insn &quot; &quot; #_o &quot;(&quot; _s &quot;,%1), %0\n\t&quot;	\</span>
<span class="cp">	ASM_EXCEPTIONTABLE_ENTRY(1b,_e)			\</span>
<span class="cp">	: _tt(_t) 					\</span>
<span class="cp">	: &quot;r&quot;(_a)					\</span>
<span class="cp">	: &quot;r8&quot;)</span>

<span class="cp">#define def_store_insn(_insn,_tt,_s,_t,_o,_a,_e) 	\</span>
<span class="cp">	__asm__ __volatile__ (				\</span>
<span class="cp">	&quot;1:\t&quot; #_insn &quot; %0, &quot; #_o &quot;(&quot; _s &quot;,%1)\n\t&quot; 	\</span>
<span class="cp">	ASM_EXCEPTIONTABLE_ENTRY(1b,_e)			\</span>
<span class="cp">	: 						\</span>
<span class="cp">	: _tt(_t), &quot;r&quot;(_a)				\</span>
<span class="cp">	: &quot;r8&quot;)</span>

<span class="cp">#define ldw(_s,_o,_a,_t,_e)	def_load_insn(ldw,&quot;=r&quot;,_s,_o,_a,_t,_e)</span>
<span class="cp">#define stw(_s,_t,_o,_a,_e) 	def_store_insn(stw,&quot;r&quot;,_s,_t,_o,_a,_e)</span>

<span class="cp">#ifdef  CONFIG_PREFETCH</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">prefetch_src</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__asm__</span><span class="p">(</span><span class="s">&quot;ldw 0(&quot;</span> <span class="n">s_space</span> <span class="s">&quot;,%0), %%r0&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">addr</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">prefetch_dst</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__asm__</span><span class="p">(</span><span class="s">&quot;ldd 0(&quot;</span> <span class="n">d_space</span> <span class="s">&quot;,%0), %%r0&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">addr</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define prefetch_src(addr) do { } while(0)</span>
<span class="cp">#define prefetch_dst(addr) do { } while(0)</span>
<span class="cp">#endif</span>

<span class="cm">/* Copy from a not-aligned src to an aligned dst, using shifts. Handles 4 words</span>
<span class="cm"> * per loop.  This code is derived from glibc. </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">copy_dstaligned</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dst</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">src</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">o_dst</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">o_src</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">o_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* gcc complains that a2 and a3 may be uninitialized, but actually</span>
<span class="cm">	 * they cannot be.  Initialize a2/a3 to shut gcc up.</span>
<span class="cm">	 */</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">a3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sh_1</span><span class="p">,</span> <span class="n">sh_2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">exception_data</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>

	<span class="cm">/* prefetch_src((const void *)src); */</span>

	<span class="cm">/* Calculate how to shift a word read at the memory operation</span>
<span class="cm">	   aligned srcp to make it aligned for copy.  */</span>
	<span class="n">sh_1</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="n">src</span> <span class="o">%</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">));</span>
	<span class="n">sh_2</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="o">-</span> <span class="n">sh_1</span><span class="p">;</span>

	<span class="cm">/* Make src aligned by rounding it down.  */</span>
	<span class="n">src</span> <span class="o">&amp;=</span> <span class="o">-</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">len</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="cm">/* a1 = ((unsigned int *) src)[0];</span>
<span class="cm">			   a2 = ((unsigned int *) src)[1]; */</span>
			<span class="n">ldw</span><span class="p">(</span><span class="n">s_space</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">cda_ldw_exc</span><span class="p">);</span>
			<span class="n">ldw</span><span class="p">(</span><span class="n">s_space</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">cda_ldw_exc</span><span class="p">);</span>
			<span class="n">src</span> <span class="o">-=</span> <span class="mi">1</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>
			<span class="n">dst</span> <span class="o">-=</span> <span class="mi">3</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">do1</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="cm">/* a0 = ((unsigned int *) src)[0];</span>
<span class="cm">			   a1 = ((unsigned int *) src)[1]; */</span>
			<span class="n">ldw</span><span class="p">(</span><span class="n">s_space</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">a0</span><span class="p">,</span> <span class="n">cda_ldw_exc</span><span class="p">);</span>
			<span class="n">ldw</span><span class="p">(</span><span class="n">s_space</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">cda_ldw_exc</span><span class="p">);</span>
			<span class="n">src</span> <span class="o">-=</span> <span class="mi">0</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>
			<span class="n">dst</span> <span class="o">-=</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">do2</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* a3 = ((unsigned int *) src)[0];</span>
<span class="cm">			   a0 = ((unsigned int *) src)[1]; */</span>
			<span class="n">ldw</span><span class="p">(</span><span class="n">s_space</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">cda_ldw_exc</span><span class="p">);</span>
			<span class="n">ldw</span><span class="p">(</span><span class="n">s_space</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">a0</span><span class="p">,</span> <span class="n">cda_ldw_exc</span><span class="p">);</span>
			<span class="n">src</span> <span class="o">-=-</span><span class="mi">1</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>
			<span class="n">dst</span> <span class="o">-=</span> <span class="mi">1</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">do3</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="cm">/* a2 = ((unsigned int *) src)[0];</span>
<span class="cm">			   a3 = ((unsigned int *) src)[1]; */</span>
			<span class="n">ldw</span><span class="p">(</span><span class="n">s_space</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">cda_ldw_exc</span><span class="p">);</span>
			<span class="n">ldw</span><span class="p">(</span><span class="n">s_space</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">cda_ldw_exc</span><span class="p">);</span>
			<span class="n">src</span> <span class="o">-=-</span><span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>
			<span class="n">dst</span> <span class="o">-=</span> <span class="mi">0</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">do0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">do4</span><span class="p">;</span>			<span class="cm">/* No-op.  */</span>
	<span class="p">}</span>

	<span class="k">do</span>
	<span class="p">{</span>
		<span class="cm">/* prefetch_src((const void *)(src + 4 * sizeof(unsigned int))); */</span>
<span class="nl">do4:</span>
		<span class="cm">/* a0 = ((unsigned int *) src)[0]; */</span>
		<span class="n">ldw</span><span class="p">(</span><span class="n">s_space</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">a0</span><span class="p">,</span> <span class="n">cda_ldw_exc</span><span class="p">);</span>
		<span class="cm">/* ((unsigned int *) dst)[0] = MERGE (a2, sh_1, a3, sh_2); */</span>
		<span class="n">stw</span><span class="p">(</span><span class="n">d_space</span><span class="p">,</span> <span class="n">MERGE</span> <span class="p">(</span><span class="n">a2</span><span class="p">,</span> <span class="n">sh_1</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">sh_2</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">cda_stw_exc</span><span class="p">);</span>
<span class="nl">do3:</span>
		<span class="cm">/* a1 = ((unsigned int *) src)[1]; */</span>
		<span class="n">ldw</span><span class="p">(</span><span class="n">s_space</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">cda_ldw_exc</span><span class="p">);</span>
		<span class="cm">/* ((unsigned int *) dst)[1] = MERGE (a3, sh_1, a0, sh_2); */</span>
		<span class="n">stw</span><span class="p">(</span><span class="n">d_space</span><span class="p">,</span> <span class="n">MERGE</span> <span class="p">(</span><span class="n">a3</span><span class="p">,</span> <span class="n">sh_1</span><span class="p">,</span> <span class="n">a0</span><span class="p">,</span> <span class="n">sh_2</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">cda_stw_exc</span><span class="p">);</span>
<span class="nl">do2:</span>
		<span class="cm">/* a2 = ((unsigned int *) src)[2]; */</span>
		<span class="n">ldw</span><span class="p">(</span><span class="n">s_space</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">cda_ldw_exc</span><span class="p">);</span>
		<span class="cm">/* ((unsigned int *) dst)[2] = MERGE (a0, sh_1, a1, sh_2); */</span>
		<span class="n">stw</span><span class="p">(</span><span class="n">d_space</span><span class="p">,</span> <span class="n">MERGE</span> <span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">sh_1</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">sh_2</span><span class="p">),</span> <span class="mi">8</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">cda_stw_exc</span><span class="p">);</span>
<span class="nl">do1:</span>
		<span class="cm">/* a3 = ((unsigned int *) src)[3]; */</span>
		<span class="n">ldw</span><span class="p">(</span><span class="n">s_space</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">cda_ldw_exc</span><span class="p">);</span>
		<span class="cm">/* ((unsigned int *) dst)[3] = MERGE (a1, sh_1, a2, sh_2); */</span>
		<span class="n">stw</span><span class="p">(</span><span class="n">d_space</span><span class="p">,</span> <span class="n">MERGE</span> <span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">sh_1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">sh_2</span><span class="p">),</span> <span class="mi">12</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">cda_stw_exc</span><span class="p">);</span>

		<span class="n">src</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>
		<span class="n">dst</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

<span class="nl">do0:</span>
	<span class="cm">/* ((unsigned int *) dst)[0] = MERGE (a2, sh_1, a3, sh_2); */</span>
	<span class="n">stw</span><span class="p">(</span><span class="n">d_space</span><span class="p">,</span> <span class="n">MERGE</span> <span class="p">(</span><span class="n">a2</span><span class="p">,</span> <span class="n">sh_1</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">sh_2</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">cda_stw_exc</span><span class="p">);</span>

	<span class="n">preserve_branch</span><span class="p">(</span><span class="n">handle_load_error</span><span class="p">);</span>
	<span class="n">preserve_branch</span><span class="p">(</span><span class="n">handle_store_error</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">handle_load_error:</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span><span class="s">&quot;cda_ldw_exc:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">d</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">exception_data</span><span class="p">);</span>
	<span class="n">DPRINTF</span><span class="p">(</span><span class="s">&quot;cda_ldw_exc: o_len=%lu fault_addr=%lu o_src=%lu ret=%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">o_len</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">fault_addr</span><span class="p">,</span> <span class="n">o_src</span><span class="p">,</span> <span class="n">o_len</span> <span class="o">-</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">fault_addr</span> <span class="o">+</span> <span class="n">o_src</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">o_len</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">fault_addr</span> <span class="o">+</span> <span class="n">o_src</span><span class="p">;</span>

<span class="nl">handle_store_error:</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span><span class="s">&quot;cda_stw_exc:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">d</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">exception_data</span><span class="p">);</span>
	<span class="n">DPRINTF</span><span class="p">(</span><span class="s">&quot;cda_stw_exc: o_len=%lu fault_addr=%lu o_dst=%lu ret=%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">o_len</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">fault_addr</span><span class="p">,</span> <span class="n">o_dst</span><span class="p">,</span> <span class="n">o_len</span> <span class="o">-</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">fault_addr</span> <span class="o">+</span> <span class="n">o_dst</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">o_len</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">fault_addr</span> <span class="o">+</span> <span class="n">o_dst</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Returns 0 for success, otherwise, returns number of bytes not transferred. */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">pa_memcpy</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dstp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">srcp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t3</span><span class="p">;</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pcs</span><span class="p">,</span> <span class="o">*</span><span class="n">pcd</span><span class="p">;</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pws</span><span class="p">,</span> <span class="o">*</span><span class="n">pwd</span><span class="p">;</span>
	<span class="k">register</span> <span class="kt">double</span> <span class="o">*</span><span class="n">pds</span><span class="p">,</span> <span class="o">*</span><span class="n">pdd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">o_dst</span><span class="p">,</span> <span class="n">o_src</span><span class="p">,</span> <span class="n">o_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">exception_data</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>

	<span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">srcp</span><span class="p">;</span>
	<span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dstp</span><span class="p">;</span>
	<span class="n">pcs</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">srcp</span><span class="p">;</span>
	<span class="n">pcd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dstp</span><span class="p">;</span>

	<span class="n">o_dst</span> <span class="o">=</span> <span class="n">dst</span><span class="p">;</span> <span class="n">o_src</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span> <span class="n">o_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="cm">/* prefetch_src((const void *)srcp); */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">THRESHOLD</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">byte_copy</span><span class="p">;</span>

	<span class="cm">/* Check alignment */</span>
	<span class="n">t1</span> <span class="o">=</span> <span class="p">(</span><span class="n">src</span> <span class="o">^</span> <span class="n">dst</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">t1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">unaligned_copy</span><span class="p">;</span>

	<span class="cm">/* src and dst have same alignment. */</span>

	<span class="cm">/* Copy bytes till we are double-aligned. */</span>
	<span class="n">t2</span> <span class="o">=</span> <span class="n">src</span> <span class="o">&amp;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">t2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">t2</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span> <span class="o">-</span> <span class="n">t2</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">t2</span> <span class="o">&amp;&amp;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* *pcd++ = *pcs++; */</span>
			<span class="n">ldbma</span><span class="p">(</span><span class="n">s_space</span><span class="p">,</span> <span class="n">pcs</span><span class="p">,</span> <span class="n">t3</span><span class="p">,</span> <span class="n">pmc_load_exc</span><span class="p">);</span>
			<span class="n">len</span><span class="o">--</span><span class="p">;</span>
			<span class="n">stbma</span><span class="p">(</span><span class="n">d_space</span><span class="p">,</span> <span class="n">t3</span><span class="p">,</span> <span class="n">pcd</span><span class="p">,</span> <span class="n">pmc_store_exc</span><span class="p">);</span>
			<span class="n">t2</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">pds</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span> <span class="o">*</span><span class="p">)</span><span class="n">pcs</span><span class="p">;</span>
	<span class="n">pdd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span> <span class="o">*</span><span class="p">)</span><span class="n">pcd</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* Copy 8 doubles at a time */</span>
<span class="c">	while (len &gt;= 8*sizeof(double)) {</span>
<span class="c">		register double r1, r2, r3, r4, r5, r6, r7, r8;</span>
<span class="c">		/* prefetch_src((char *)pds + L1_CACHE_BYTES); */</span>
<span class="c">		flddma(s_space, pds, r1, pmc_load_exc);</span>
<span class="c">		flddma(s_space, pds, r2, pmc_load_exc);</span>
<span class="c">		flddma(s_space, pds, r3, pmc_load_exc);</span>
<span class="c">		flddma(s_space, pds, r4, pmc_load_exc);</span>
<span class="c">		fstdma(d_space, r1, pdd, pmc_store_exc);</span>
<span class="c">		fstdma(d_space, r2, pdd, pmc_store_exc);</span>
<span class="c">		fstdma(d_space, r3, pdd, pmc_store_exc);</span>
<span class="c">		fstdma(d_space, r4, pdd, pmc_store_exc);</span>

<span class="cp">#if 0</span>
<span class="c">		if (L1_CACHE_BYTES &lt;= 32)</span>
<span class="c">			prefetch_src((char *)pds + L1_CACHE_BYTES);</span>
<span class="cp">#endif</span>
<span class="c">		flddma(s_space, pds, r5, pmc_load_exc);</span>
<span class="c">		flddma(s_space, pds, r6, pmc_load_exc);</span>
<span class="c">		flddma(s_space, pds, r7, pmc_load_exc);</span>
<span class="c">		flddma(s_space, pds, r8, pmc_load_exc);</span>
<span class="c">		fstdma(d_space, r5, pdd, pmc_store_exc);</span>
<span class="c">		fstdma(d_space, r6, pdd, pmc_store_exc);</span>
<span class="c">		fstdma(d_space, r7, pdd, pmc_store_exc);</span>
<span class="c">		fstdma(d_space, r8, pdd, pmc_store_exc);</span>
<span class="c">		len -= 8*sizeof(double);</span>
<span class="c">	}</span>
<span class="cp">#endif</span>

	<span class="n">pws</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">pds</span><span class="p">;</span>
	<span class="n">pwd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">pdd</span><span class="p">;</span>

<span class="nl">word_copy:</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r1</span><span class="p">,</span><span class="n">r2</span><span class="p">,</span><span class="n">r3</span><span class="p">,</span><span class="n">r4</span><span class="p">,</span><span class="n">r5</span><span class="p">,</span><span class="n">r6</span><span class="p">,</span><span class="n">r7</span><span class="p">,</span><span class="n">r8</span><span class="p">;</span>
		<span class="cm">/* prefetch_src((char *)pws + L1_CACHE_BYTES); */</span>
		<span class="n">ldwma</span><span class="p">(</span><span class="n">s_space</span><span class="p">,</span> <span class="n">pws</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">pmc_load_exc</span><span class="p">);</span>
		<span class="n">ldwma</span><span class="p">(</span><span class="n">s_space</span><span class="p">,</span> <span class="n">pws</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">pmc_load_exc</span><span class="p">);</span>
		<span class="n">ldwma</span><span class="p">(</span><span class="n">s_space</span><span class="p">,</span> <span class="n">pws</span><span class="p">,</span> <span class="n">r3</span><span class="p">,</span> <span class="n">pmc_load_exc</span><span class="p">);</span>
		<span class="n">ldwma</span><span class="p">(</span><span class="n">s_space</span><span class="p">,</span> <span class="n">pws</span><span class="p">,</span> <span class="n">r4</span><span class="p">,</span> <span class="n">pmc_load_exc</span><span class="p">);</span>
		<span class="n">stwma</span><span class="p">(</span><span class="n">d_space</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">pwd</span><span class="p">,</span> <span class="n">pmc_store_exc</span><span class="p">);</span>
		<span class="n">stwma</span><span class="p">(</span><span class="n">d_space</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">pwd</span><span class="p">,</span> <span class="n">pmc_store_exc</span><span class="p">);</span>
		<span class="n">stwma</span><span class="p">(</span><span class="n">d_space</span><span class="p">,</span> <span class="n">r3</span><span class="p">,</span> <span class="n">pwd</span><span class="p">,</span> <span class="n">pmc_store_exc</span><span class="p">);</span>
		<span class="n">stwma</span><span class="p">(</span><span class="n">d_space</span><span class="p">,</span> <span class="n">r4</span><span class="p">,</span> <span class="n">pwd</span><span class="p">,</span> <span class="n">pmc_store_exc</span><span class="p">);</span>

		<span class="n">ldwma</span><span class="p">(</span><span class="n">s_space</span><span class="p">,</span> <span class="n">pws</span><span class="p">,</span> <span class="n">r5</span><span class="p">,</span> <span class="n">pmc_load_exc</span><span class="p">);</span>
		<span class="n">ldwma</span><span class="p">(</span><span class="n">s_space</span><span class="p">,</span> <span class="n">pws</span><span class="p">,</span> <span class="n">r6</span><span class="p">,</span> <span class="n">pmc_load_exc</span><span class="p">);</span>
		<span class="n">ldwma</span><span class="p">(</span><span class="n">s_space</span><span class="p">,</span> <span class="n">pws</span><span class="p">,</span> <span class="n">r7</span><span class="p">,</span> <span class="n">pmc_load_exc</span><span class="p">);</span>
		<span class="n">ldwma</span><span class="p">(</span><span class="n">s_space</span><span class="p">,</span> <span class="n">pws</span><span class="p">,</span> <span class="n">r8</span><span class="p">,</span> <span class="n">pmc_load_exc</span><span class="p">);</span>
		<span class="n">stwma</span><span class="p">(</span><span class="n">d_space</span><span class="p">,</span> <span class="n">r5</span><span class="p">,</span> <span class="n">pwd</span><span class="p">,</span> <span class="n">pmc_store_exc</span><span class="p">);</span>
		<span class="n">stwma</span><span class="p">(</span><span class="n">d_space</span><span class="p">,</span> <span class="n">r6</span><span class="p">,</span> <span class="n">pwd</span><span class="p">,</span> <span class="n">pmc_store_exc</span><span class="p">);</span>
		<span class="n">stwma</span><span class="p">(</span><span class="n">d_space</span><span class="p">,</span> <span class="n">r7</span><span class="p">,</span> <span class="n">pwd</span><span class="p">,</span> <span class="n">pmc_store_exc</span><span class="p">);</span>
		<span class="n">stwma</span><span class="p">(</span><span class="n">d_space</span><span class="p">,</span> <span class="n">r8</span><span class="p">,</span> <span class="n">pwd</span><span class="p">,</span> <span class="n">pmc_store_exc</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="mi">8</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r1</span><span class="p">,</span><span class="n">r2</span><span class="p">,</span><span class="n">r3</span><span class="p">,</span><span class="n">r4</span><span class="p">;</span>
		<span class="n">ldwma</span><span class="p">(</span><span class="n">s_space</span><span class="p">,</span> <span class="n">pws</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">pmc_load_exc</span><span class="p">);</span>
		<span class="n">ldwma</span><span class="p">(</span><span class="n">s_space</span><span class="p">,</span> <span class="n">pws</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">pmc_load_exc</span><span class="p">);</span>
		<span class="n">ldwma</span><span class="p">(</span><span class="n">s_space</span><span class="p">,</span> <span class="n">pws</span><span class="p">,</span> <span class="n">r3</span><span class="p">,</span> <span class="n">pmc_load_exc</span><span class="p">);</span>
		<span class="n">ldwma</span><span class="p">(</span><span class="n">s_space</span><span class="p">,</span> <span class="n">pws</span><span class="p">,</span> <span class="n">r4</span><span class="p">,</span> <span class="n">pmc_load_exc</span><span class="p">);</span>
		<span class="n">stwma</span><span class="p">(</span><span class="n">d_space</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">pwd</span><span class="p">,</span> <span class="n">pmc_store_exc</span><span class="p">);</span>
		<span class="n">stwma</span><span class="p">(</span><span class="n">d_space</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">pwd</span><span class="p">,</span> <span class="n">pmc_store_exc</span><span class="p">);</span>
		<span class="n">stwma</span><span class="p">(</span><span class="n">d_space</span><span class="p">,</span> <span class="n">r3</span><span class="p">,</span> <span class="n">pwd</span><span class="p">,</span> <span class="n">pmc_store_exc</span><span class="p">);</span>
		<span class="n">stwma</span><span class="p">(</span><span class="n">d_space</span><span class="p">,</span> <span class="n">r4</span><span class="p">,</span> <span class="n">pwd</span><span class="p">,</span> <span class="n">pmc_store_exc</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="mi">4</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pcs</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pws</span><span class="p">;</span>
	<span class="n">pcd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pwd</span><span class="p">;</span>

<span class="nl">byte_copy:</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* *pcd++ = *pcs++; */</span>
		<span class="n">ldbma</span><span class="p">(</span><span class="n">s_space</span><span class="p">,</span> <span class="n">pcs</span><span class="p">,</span> <span class="n">t3</span><span class="p">,</span> <span class="n">pmc_load_exc</span><span class="p">);</span>
		<span class="n">stbma</span><span class="p">(</span><span class="n">d_space</span><span class="p">,</span> <span class="n">t3</span><span class="p">,</span> <span class="n">pcd</span><span class="p">,</span> <span class="n">pmc_store_exc</span><span class="p">);</span>
		<span class="n">len</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">unaligned_copy:</span>
	<span class="cm">/* possibly we are aligned on a word, but not on a double... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">((</span><span class="n">t1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">t2</span> <span class="o">=</span> <span class="n">src</span> <span class="o">&amp;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">t2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">t2</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="o">-</span> <span class="n">t2</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">t2</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* *pcd++ = *pcs++; */</span>
				<span class="n">ldbma</span><span class="p">(</span><span class="n">s_space</span><span class="p">,</span> <span class="n">pcs</span><span class="p">,</span> <span class="n">t3</span><span class="p">,</span> <span class="n">pmc_load_exc</span><span class="p">);</span>
				<span class="n">stbma</span><span class="p">(</span><span class="n">d_space</span><span class="p">,</span> <span class="n">t3</span><span class="p">,</span> <span class="n">pcd</span><span class="p">,</span> <span class="n">pmc_store_exc</span><span class="p">);</span>
				<span class="n">len</span><span class="o">--</span><span class="p">;</span>
				<span class="n">t2</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">pws</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">pcs</span><span class="p">;</span>
		<span class="n">pwd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">pcd</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">word_copy</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Align the destination.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">dst</span> <span class="o">&amp;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">t2</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">dst</span> <span class="o">&amp;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">t2</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* *pcd++ = *pcs++; */</span>
			<span class="n">ldbma</span><span class="p">(</span><span class="n">s_space</span><span class="p">,</span> <span class="n">pcs</span><span class="p">,</span> <span class="n">t3</span><span class="p">,</span> <span class="n">pmc_load_exc</span><span class="p">);</span>
			<span class="n">stbma</span><span class="p">(</span><span class="n">d_space</span><span class="p">,</span> <span class="n">t3</span><span class="p">,</span> <span class="n">pcd</span><span class="p">,</span> <span class="n">pmc_store_exc</span><span class="p">);</span>
			<span class="n">len</span><span class="o">--</span><span class="p">;</span>
			<span class="n">t2</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pcd</span><span class="p">;</span>
		<span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pcs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">copy_dstaligned</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">len</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">),</span> 
		<span class="n">o_dst</span><span class="p">,</span> <span class="n">o_src</span><span class="p">,</span> <span class="n">o_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pcs</span> <span class="o">+=</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="o">-</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">));</span>
	<span class="n">pcd</span> <span class="o">+=</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="o">-</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">));</span>
	<span class="n">len</span> <span class="o">%=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>

	<span class="n">preserve_branch</span><span class="p">(</span><span class="n">handle_load_error</span><span class="p">);</span>
	<span class="n">preserve_branch</span><span class="p">(</span><span class="n">handle_store_error</span><span class="p">);</span>

	<span class="k">goto</span> <span class="n">byte_copy</span><span class="p">;</span>

<span class="nl">handle_load_error:</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span><span class="s">&quot;pmc_load_exc:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">d</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">exception_data</span><span class="p">);</span>
	<span class="n">DPRINTF</span><span class="p">(</span><span class="s">&quot;pmc_load_exc: o_len=%lu fault_addr=%lu o_src=%lu ret=%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">o_len</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">fault_addr</span><span class="p">,</span> <span class="n">o_src</span><span class="p">,</span> <span class="n">o_len</span> <span class="o">-</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">fault_addr</span> <span class="o">+</span> <span class="n">o_src</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">o_len</span> <span class="o">-</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">fault_addr</span> <span class="o">+</span> <span class="n">o_src</span><span class="p">;</span>

<span class="nl">handle_store_error:</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span><span class="s">&quot;pmc_store_exc:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">d</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">exception_data</span><span class="p">);</span>
	<span class="n">DPRINTF</span><span class="p">(</span><span class="s">&quot;pmc_store_exc: o_len=%lu fault_addr=%lu o_dst=%lu ret=%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">o_len</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">fault_addr</span><span class="p">,</span> <span class="n">o_dst</span><span class="p">,</span> <span class="n">o_len</span> <span class="o">-</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">fault_addr</span> <span class="o">+</span> <span class="n">o_dst</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">o_len</span> <span class="o">-</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">fault_addr</span> <span class="o">+</span> <span class="n">o_dst</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef __KERNEL__</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">copy_to_user</span><span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mtsp</span><span class="p">(</span><span class="n">get_kernel_space</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">mtsp</span><span class="p">(</span><span class="n">get_user_space</span><span class="p">(),</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pa_memcpy</span><span class="p">((</span><span class="kt">void</span> <span class="n">__force</span> <span class="o">*</span><span class="p">)</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__copy_from_user</span><span class="p">);</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">__copy_from_user</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mtsp</span><span class="p">(</span><span class="n">get_user_space</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">mtsp</span><span class="p">(</span><span class="n">get_kernel_space</span><span class="p">(),</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pa_memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__force</span> <span class="o">*</span><span class="p">)</span><span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">copy_in_user</span><span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mtsp</span><span class="p">(</span><span class="n">get_user_space</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">mtsp</span><span class="p">(</span><span class="n">get_user_space</span><span class="p">(),</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pa_memcpy</span><span class="p">((</span><span class="kt">void</span> <span class="n">__force</span> <span class="o">*</span><span class="p">)</span><span class="n">dst</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__force</span> <span class="o">*</span><span class="p">)</span><span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="o">*</span> <span class="nf">memcpy</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">dst</span><span class="p">,</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mtsp</span><span class="p">(</span><span class="n">get_kernel_space</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">mtsp</span><span class="p">(</span><span class="n">get_kernel_space</span><span class="p">(),</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">pa_memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dst</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">copy_to_user</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">copy_from_user</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">copy_in_user</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">memcpy</span><span class="p">);</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
