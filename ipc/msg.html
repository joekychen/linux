<!DOCTYPE html>
<html><head><title>joekychen/linux » ipc › msg.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../index.html"></a><h1>msg.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/ipc/msg.c</span>
<span class="cm"> * Copyright (C) 1992 Krishna Balasubramanian</span>
<span class="cm"> *</span>
<span class="cm"> * Removed all the remaining kerneld mess</span>
<span class="cm"> * Catch the -EFAULT stuff properly</span>
<span class="cm"> * Use GFP_KERNEL for messages as in 1.2</span>
<span class="cm"> * Fixed up the unchecked user space derefs</span>
<span class="cm"> * Copyright (C) 1998 Alan Cox &amp; Andi Kleen</span>
<span class="cm"> *</span>
<span class="cm"> * /proc/sysvipc/msg support (c) 1999 Dragos Acostachioaie &lt;dragos@iname.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * mostly rewritten, threaded and wake-one semantics added</span>
<span class="cm"> * MSGMAX limit removed, sysctl&#39;s added</span>
<span class="cm"> * (c) 1999 Manfred Spraul &lt;manfred@colorfullife.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * support for audit of ipc object properties and permission changes</span>
<span class="cm"> * Dustin Kirkland &lt;dustin.kirkland@us.ibm.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * namespaces support</span>
<span class="cm"> * OpenVZ, SWsoft Inc.</span>
<span class="cm"> * Pavel Emelianov &lt;xemul@openvz.org&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/capability.h&gt;</span>
<span class="cp">#include &lt;linux/msg.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/security.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/syscalls.h&gt;</span>
<span class="cp">#include &lt;linux/audit.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/rwsem.h&gt;</span>
<span class="cp">#include &lt;linux/nsproxy.h&gt;</span>
<span class="cp">#include &lt;linux/ipc_namespace.h&gt;</span>

<span class="cp">#include &lt;asm/current.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &quot;util.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * one msg_receiver structure for each sleeping receiver:</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">msg_receiver</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">r_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span>	<span class="o">*</span><span class="n">r_tsk</span><span class="p">;</span>

	<span class="kt">int</span>			<span class="n">r_mode</span><span class="p">;</span>
	<span class="kt">long</span>			<span class="n">r_msgtype</span><span class="p">;</span>
	<span class="kt">long</span>			<span class="n">r_maxsize</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">msg_msg</span>		<span class="o">*</span><span class="k">volatile</span> <span class="n">r_msg</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* one msg_sender for each sleeping sender */</span>
<span class="k">struct</span> <span class="n">msg_sender</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span>	<span class="o">*</span><span class="n">tsk</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define SEARCH_ANY		1</span>
<span class="cp">#define SEARCH_EQUAL		2</span>
<span class="cp">#define SEARCH_NOTEQUAL		3</span>
<span class="cp">#define SEARCH_LESSEQUAL	4</span>

<span class="cp">#define msg_ids(ns)	((ns)-&gt;ids[IPC_MSG_IDS])</span>

<span class="cp">#define msg_unlock(msq)		ipc_unlock(&amp;(msq)-&gt;q_perm)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">freeque</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipc_namespace</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kern_ipc_perm</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">newque</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipc_namespace</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipc_params</span> <span class="o">*</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sysvipc_msg_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">it</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Scale msgmni with the available lowmem size: the memory dedicated to msg</span>
<span class="cm"> * queues should occupy at most 1/MSG_MEM_SCALE of lowmem.</span>
<span class="cm"> * Also take into account the number of nsproxies created so far.</span>
<span class="cm"> * This should be done staying within the (MSGMNI , IPCMNI/nr_ipc_ns) range.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">recompute_msgmni</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipc_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sysinfo</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">allowed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nb_ns</span><span class="p">;</span>

	<span class="n">si_meminfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
	<span class="n">allowed</span> <span class="o">=</span> <span class="p">(((</span><span class="n">i</span><span class="p">.</span><span class="n">totalram</span> <span class="o">-</span> <span class="n">i</span><span class="p">.</span><span class="n">totalhigh</span><span class="p">)</span> <span class="o">/</span> <span class="n">MSG_MEM_SCALE</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span><span class="p">.</span><span class="n">mem_unit</span><span class="p">)</span>
		<span class="o">/</span> <span class="n">MSGMNB</span><span class="p">;</span>
	<span class="n">nb_ns</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nr_ipc_ns</span><span class="p">);</span>
	<span class="n">allowed</span> <span class="o">/=</span> <span class="n">nb_ns</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">allowed</span> <span class="o">&lt;</span> <span class="n">MSGMNI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">msg_ctlmni</span> <span class="o">=</span> <span class="n">MSGMNI</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">allowed</span> <span class="o">&gt;</span> <span class="n">IPCMNI</span> <span class="o">/</span> <span class="n">nb_ns</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">msg_ctlmni</span> <span class="o">=</span> <span class="n">IPCMNI</span> <span class="o">/</span> <span class="n">nb_ns</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">msg_ctlmni</span> <span class="o">=</span> <span class="n">allowed</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">msg_init_ns</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipc_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">msg_ctlmax</span> <span class="o">=</span> <span class="n">MSGMAX</span><span class="p">;</span>
	<span class="n">ns</span><span class="o">-&gt;</span><span class="n">msg_ctlmnb</span> <span class="o">=</span> <span class="n">MSGMNB</span><span class="p">;</span>

	<span class="n">recompute_msgmni</span><span class="p">(</span><span class="n">ns</span><span class="p">);</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">msg_bytes</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">msg_hdrs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ipc_init_ids</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">[</span><span class="n">IPC_MSG_IDS</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IPC_NS</span>
<span class="kt">void</span> <span class="nf">msg_exit_ns</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipc_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">free_ipcs</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg_ids</span><span class="p">(</span><span class="n">ns</span><span class="p">),</span> <span class="n">freeque</span><span class="p">);</span>
	<span class="n">idr_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">[</span><span class="n">IPC_MSG_IDS</span><span class="p">].</span><span class="n">ipcs_idr</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">msg_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">msg_init_ns</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_ipc_ns</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;msgmni has been set to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">init_ipc_ns</span><span class="p">.</span><span class="n">msg_ctlmni</span><span class="p">);</span>

	<span class="n">ipc_init_proc_interface</span><span class="p">(</span><span class="s">&quot;sysvipc/msg&quot;</span><span class="p">,</span>
				<span class="s">&quot;       key      msqid perms      cbytes       qnum lspid lrpid   uid   gid  cuid  cgid      stime      rtime      ctime</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">IPC_MSG_IDS</span><span class="p">,</span> <span class="n">sysvipc_msg_proc_show</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * msg_lock_(check_) routines are called in the paths where the rw_mutex</span>
<span class="cm"> * is not held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">msg_queue</span> <span class="o">*</span><span class="nf">msg_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipc_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kern_ipc_perm</span> <span class="o">*</span><span class="n">ipcp</span> <span class="o">=</span> <span class="n">ipc_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg_ids</span><span class="p">(</span><span class="n">ns</span><span class="p">),</span> <span class="n">id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ipcp</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">msg_queue</span> <span class="o">*</span><span class="p">)</span><span class="n">ipcp</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ipcp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msg_queue</span><span class="p">,</span> <span class="n">q_perm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">msg_queue</span> <span class="o">*</span><span class="nf">msg_lock_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipc_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span>
						<span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kern_ipc_perm</span> <span class="o">*</span><span class="n">ipcp</span> <span class="o">=</span> <span class="n">ipc_lock_check</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg_ids</span><span class="p">(</span><span class="n">ns</span><span class="p">),</span> <span class="n">id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ipcp</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">msg_queue</span> <span class="o">*</span><span class="p">)</span><span class="n">ipcp</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ipcp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msg_queue</span><span class="p">,</span> <span class="n">q_perm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">msg_rmid</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipc_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msg_queue</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ipc_rmid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg_ids</span><span class="p">(</span><span class="n">ns</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * newque - Create a new msg queue</span>
<span class="cm"> * @ns: namespace</span>
<span class="cm"> * @params: ptr to the structure that contains the key and msgflg</span>
<span class="cm"> *</span>
<span class="cm"> * Called with msg_ids.rw_mutex held (writer)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">newque</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipc_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipc_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msg_queue</span> <span class="o">*</span><span class="n">msq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">key_t</span> <span class="n">key</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">msgflg</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">flg</span><span class="p">;</span>

	<span class="n">msq</span> <span class="o">=</span> <span class="n">ipc_rcu_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">msq</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msq</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">msgflg</span> <span class="o">&amp;</span> <span class="n">S_IRWXUGO</span><span class="p">;</span>
	<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>

	<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">.</span><span class="n">security</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">security_msg_queue_alloc</span><span class="p">(</span><span class="n">msq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipc_rcu_putref</span><span class="p">(</span><span class="n">msq</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * ipc_addid() locks msq</span>
<span class="cm">	 */</span>
	<span class="n">id</span> <span class="o">=</span> <span class="n">ipc_addid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg_ids</span><span class="p">(</span><span class="n">ns</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">msg_ctlmni</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">security_msg_queue_free</span><span class="p">(</span><span class="n">msq</span><span class="p">);</span>
		<span class="n">ipc_rcu_putref</span><span class="p">(</span><span class="n">msq</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">id</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_stime</span> <span class="o">=</span> <span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_rtime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_ctime</span> <span class="o">=</span> <span class="n">get_seconds</span><span class="p">();</span>
	<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_cbytes</span> <span class="o">=</span> <span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_qnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_qbytes</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">msg_ctlmnb</span><span class="p">;</span>
	<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_lspid</span> <span class="o">=</span> <span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_lrpid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_messages</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_receivers</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_senders</span><span class="p">);</span>

	<span class="n">msg_unlock</span><span class="p">(</span><span class="n">msq</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ss_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">msg_queue</span> <span class="o">*</span><span class="n">msq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msg_sender</span> <span class="o">*</span><span class="n">mss</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mss</span><span class="o">-&gt;</span><span class="n">tsk</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">TASK_INTERRUPTIBLE</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mss</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_senders</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ss_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">msg_sender</span> <span class="o">*</span><span class="n">mss</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mss</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">.</span><span class="n">next</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mss</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ss_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">kill</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">h</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">msg_sender</span> <span class="o">*</span><span class="n">mss</span><span class="p">;</span>

		<span class="n">mss</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msg_sender</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kill</span><span class="p">)</span>
			<span class="n">mss</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">wake_up_process</span><span class="p">(</span><span class="n">mss</span><span class="o">-&gt;</span><span class="n">tsk</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">expunge_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">msg_queue</span> <span class="o">*</span><span class="n">msq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_receivers</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_receivers</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">msg_receiver</span> <span class="o">*</span><span class="n">msr</span><span class="p">;</span>

		<span class="n">msr</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msg_receiver</span><span class="p">,</span> <span class="n">r_list</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">msr</span><span class="o">-&gt;</span><span class="n">r_msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">wake_up_process</span><span class="p">(</span><span class="n">msr</span><span class="o">-&gt;</span><span class="n">r_tsk</span><span class="p">);</span>
		<span class="n">smp_mb</span><span class="p">();</span>
		<span class="n">msr</span><span class="o">-&gt;</span><span class="n">r_msg</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * freeque() wakes up waiters on the sender and receiver waiting queue,</span>
<span class="cm"> * removes the message queue from message queue ID IDR, and cleans up all the</span>
<span class="cm"> * messages associated with this queue.</span>
<span class="cm"> *</span>
<span class="cm"> * msg_ids.rw_mutex (writer) and the spinlock for this message queue are held</span>
<span class="cm"> * before freeque() is called. msg_ids.rw_mutex remains locked on exit.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">freeque</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipc_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kern_ipc_perm</span> <span class="o">*</span><span class="n">ipcp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msg_queue</span> <span class="o">*</span><span class="n">msq</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ipcp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msg_queue</span><span class="p">,</span> <span class="n">q_perm</span><span class="p">);</span>

	<span class="n">expunge_all</span><span class="p">(</span><span class="n">msq</span><span class="p">,</span> <span class="o">-</span><span class="n">EIDRM</span><span class="p">);</span>
	<span class="n">ss_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_senders</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">msg_rmid</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">msq</span><span class="p">);</span>
	<span class="n">msg_unlock</span><span class="p">(</span><span class="n">msq</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_messages</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_messages</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">msg_msg</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msg_msg</span><span class="p">,</span> <span class="n">m_list</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">msg_hdrs</span><span class="p">);</span>
		<span class="n">free_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">atomic_sub</span><span class="p">(</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_cbytes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">msg_bytes</span><span class="p">);</span>
	<span class="n">security_msg_queue_free</span><span class="p">(</span><span class="n">msq</span><span class="p">);</span>
	<span class="n">ipc_rcu_putref</span><span class="p">(</span><span class="n">msq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called with msg_ids.rw_mutex and ipcp locked.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">msg_security</span><span class="p">(</span><span class="k">struct</span> <span class="n">kern_ipc_perm</span> <span class="o">*</span><span class="n">ipcp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">msgflg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msg_queue</span> <span class="o">*</span><span class="n">msq</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ipcp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msg_queue</span><span class="p">,</span> <span class="n">q_perm</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">security_msg_queue_associate</span><span class="p">(</span><span class="n">msq</span><span class="p">,</span> <span class="n">msgflg</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">SYSCALL_DEFINE2</span><span class="p">(</span><span class="n">msgget</span><span class="p">,</span> <span class="n">key_t</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">msgflg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ipc_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipc_ops</span> <span class="n">msg_ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipc_params</span> <span class="n">msg_params</span><span class="p">;</span>

	<span class="n">ns</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">nsproxy</span><span class="o">-&gt;</span><span class="n">ipc_ns</span><span class="p">;</span>

	<span class="n">msg_ops</span><span class="p">.</span><span class="n">getnew</span> <span class="o">=</span> <span class="n">newque</span><span class="p">;</span>
	<span class="n">msg_ops</span><span class="p">.</span><span class="n">associate</span> <span class="o">=</span> <span class="n">msg_security</span><span class="p">;</span>
	<span class="n">msg_ops</span><span class="p">.</span><span class="n">more_checks</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">msg_params</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
	<span class="n">msg_params</span><span class="p">.</span><span class="n">flg</span> <span class="o">=</span> <span class="n">msgflg</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ipcget</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg_ids</span><span class="p">(</span><span class="n">ns</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">msg_ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg_params</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="n">copy_msqid_to_user</span><span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msqid64_ds</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span> <span class="kt">int</span> <span class="n">version</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IPC_64</span>:
		<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">in</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">in</span><span class="p">));</span>
	<span class="k">case</span> <span class="n">IPC_OLD</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">msqid_ds</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">out</span><span class="p">));</span>

		<span class="n">ipc64_perm_to_ipc_perm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">msg_perm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">out</span><span class="p">.</span><span class="n">msg_perm</span><span class="p">);</span>

		<span class="n">out</span><span class="p">.</span><span class="n">msg_stime</span>		<span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">msg_stime</span><span class="p">;</span>
		<span class="n">out</span><span class="p">.</span><span class="n">msg_rtime</span>		<span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">msg_rtime</span><span class="p">;</span>
		<span class="n">out</span><span class="p">.</span><span class="n">msg_ctime</span>		<span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">msg_ctime</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">msg_cbytes</span> <span class="o">&gt;</span> <span class="n">USHRT_MAX</span><span class="p">)</span>
			<span class="n">out</span><span class="p">.</span><span class="n">msg_cbytes</span>	<span class="o">=</span> <span class="n">USHRT_MAX</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">out</span><span class="p">.</span><span class="n">msg_cbytes</span>	<span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">msg_cbytes</span><span class="p">;</span>
		<span class="n">out</span><span class="p">.</span><span class="n">msg_lcbytes</span>		<span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">msg_cbytes</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">msg_qnum</span> <span class="o">&gt;</span> <span class="n">USHRT_MAX</span><span class="p">)</span>
			<span class="n">out</span><span class="p">.</span><span class="n">msg_qnum</span>	<span class="o">=</span> <span class="n">USHRT_MAX</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">out</span><span class="p">.</span><span class="n">msg_qnum</span>	<span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">msg_qnum</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">msg_qbytes</span> <span class="o">&gt;</span> <span class="n">USHRT_MAX</span><span class="p">)</span>
			<span class="n">out</span><span class="p">.</span><span class="n">msg_qbytes</span>	<span class="o">=</span> <span class="n">USHRT_MAX</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">out</span><span class="p">.</span><span class="n">msg_qbytes</span>	<span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">msg_qbytes</span><span class="p">;</span>
		<span class="n">out</span><span class="p">.</span><span class="n">msg_lqbytes</span>		<span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">msg_qbytes</span><span class="p">;</span>

		<span class="n">out</span><span class="p">.</span><span class="n">msg_lspid</span>		<span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">msg_lspid</span><span class="p">;</span>
		<span class="n">out</span><span class="p">.</span><span class="n">msg_lrpid</span>		<span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">msg_lrpid</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">out</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">out</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="n">copy_msqid_from_user</span><span class="p">(</span><span class="k">struct</span> <span class="n">msqid64_ds</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">version</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IPC_64</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">out</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPC_OLD</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">msqid_ds</span> <span class="n">tbuf_old</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbuf_old</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tbuf_old</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">out</span><span class="o">-&gt;</span><span class="n">msg_perm</span><span class="p">.</span><span class="n">uid</span>      	<span class="o">=</span> <span class="n">tbuf_old</span><span class="p">.</span><span class="n">msg_perm</span><span class="p">.</span><span class="n">uid</span><span class="p">;</span>
		<span class="n">out</span><span class="o">-&gt;</span><span class="n">msg_perm</span><span class="p">.</span><span class="n">gid</span>      	<span class="o">=</span> <span class="n">tbuf_old</span><span class="p">.</span><span class="n">msg_perm</span><span class="p">.</span><span class="n">gid</span><span class="p">;</span>
		<span class="n">out</span><span class="o">-&gt;</span><span class="n">msg_perm</span><span class="p">.</span><span class="n">mode</span>     	<span class="o">=</span> <span class="n">tbuf_old</span><span class="p">.</span><span class="n">msg_perm</span><span class="p">.</span><span class="n">mode</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tbuf_old</span><span class="p">.</span><span class="n">msg_qbytes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">out</span><span class="o">-&gt;</span><span class="n">msg_qbytes</span>	<span class="o">=</span> <span class="n">tbuf_old</span><span class="p">.</span><span class="n">msg_lqbytes</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">out</span><span class="o">-&gt;</span><span class="n">msg_qbytes</span>	<span class="o">=</span> <span class="n">tbuf_old</span><span class="p">.</span><span class="n">msg_qbytes</span><span class="p">;</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function handles some msgctl commands which require the rw_mutex</span>
<span class="cm"> * to be held in write mode.</span>
<span class="cm"> * NOTE: no locks must be held, the rw_mutex is taken inside this function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">msgctl_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipc_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span> <span class="kt">int</span> <span class="n">msqid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">msqid_ds</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">version</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kern_ipc_perm</span> <span class="o">*</span><span class="n">ipcp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msqid64_ds</span> <span class="n">uninitialized_var</span><span class="p">(</span><span class="n">msqid64</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">msg_queue</span> <span class="o">*</span><span class="n">msq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">IPC_SET</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_msqid_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msqid64</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">version</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ipcp</span> <span class="o">=</span> <span class="n">ipcctl_pre_down</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg_ids</span><span class="p">(</span><span class="n">ns</span><span class="p">),</span> <span class="n">msqid</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">msqid64</span><span class="p">.</span><span class="n">msg_perm</span><span class="p">,</span> <span class="n">msqid64</span><span class="p">.</span><span class="n">msg_qbytes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ipcp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ipcp</span><span class="p">);</span>

	<span class="n">msq</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ipcp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msg_queue</span><span class="p">,</span> <span class="n">q_perm</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">security_msg_queue_msgctl</span><span class="p">(</span><span class="n">msq</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IPC_RMID</span>:
		<span class="n">freeque</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">ipcp</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_up</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IPC_SET</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">msqid64</span><span class="p">.</span><span class="n">msg_qbytes</span> <span class="o">&gt;</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">msg_ctlmnb</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_RESOURCE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_qbytes</span> <span class="o">=</span> <span class="n">msqid64</span><span class="p">.</span><span class="n">msg_qbytes</span><span class="p">;</span>

		<span class="n">ipc_update_perm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msqid64</span><span class="p">.</span><span class="n">msg_perm</span><span class="p">,</span> <span class="n">ipcp</span><span class="p">);</span>
		<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_ctime</span> <span class="o">=</span> <span class="n">get_seconds</span><span class="p">();</span>
		<span class="cm">/* sleeping receivers might be excluded by</span>
<span class="cm">		 * stricter permissions.</span>
<span class="cm">		 */</span>
		<span class="n">expunge_all</span><span class="p">(</span><span class="n">msq</span><span class="p">,</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">);</span>
		<span class="cm">/* sleeping senders might be able to send</span>
<span class="cm">		 * due to a larger queue size.</span>
<span class="cm">		 */</span>
		<span class="n">ss_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_senders</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out_unlock:</span>
	<span class="n">msg_unlock</span><span class="p">(</span><span class="n">msq</span><span class="p">);</span>
<span class="nl">out_up:</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg_ids</span><span class="p">(</span><span class="n">ns</span><span class="p">).</span><span class="n">rw_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SYSCALL_DEFINE3</span><span class="p">(</span><span class="n">msgctl</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">msqid</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msqid_ds</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msg_queue</span> <span class="o">*</span><span class="n">msq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">version</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipc_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msqid</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">cmd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">version</span> <span class="o">=</span> <span class="n">ipc_parse_version</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">ns</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">nsproxy</span><span class="o">-&gt;</span><span class="n">ipc_ns</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IPC_INFO</span>:
	<span class="k">case</span> <span class="n">MSG_INFO</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">msginfo</span> <span class="n">msginfo</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">max_id</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * We must not return kernel stack data.</span>
<span class="cm">		 * due to padding, it&#39;s not enough</span>
<span class="cm">		 * to set all member fields.</span>
<span class="cm">		 */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">security_msg_queue_msgctl</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msginfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msginfo</span><span class="p">));</span>
		<span class="n">msginfo</span><span class="p">.</span><span class="n">msgmni</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">msg_ctlmni</span><span class="p">;</span>
		<span class="n">msginfo</span><span class="p">.</span><span class="n">msgmax</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">msg_ctlmax</span><span class="p">;</span>
		<span class="n">msginfo</span><span class="p">.</span><span class="n">msgmnb</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">msg_ctlmnb</span><span class="p">;</span>
		<span class="n">msginfo</span><span class="p">.</span><span class="n">msgssz</span> <span class="o">=</span> <span class="n">MSGSSZ</span><span class="p">;</span>
		<span class="n">msginfo</span><span class="p">.</span><span class="n">msgseg</span> <span class="o">=</span> <span class="n">MSGSEG</span><span class="p">;</span>
		<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg_ids</span><span class="p">(</span><span class="n">ns</span><span class="p">).</span><span class="n">rw_mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">MSG_INFO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msginfo</span><span class="p">.</span><span class="n">msgpool</span> <span class="o">=</span> <span class="n">msg_ids</span><span class="p">(</span><span class="n">ns</span><span class="p">).</span><span class="n">in_use</span><span class="p">;</span>
			<span class="n">msginfo</span><span class="p">.</span><span class="n">msgmap</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">msg_hdrs</span><span class="p">);</span>
			<span class="n">msginfo</span><span class="p">.</span><span class="n">msgtql</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">msg_bytes</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">msginfo</span><span class="p">.</span><span class="n">msgmap</span> <span class="o">=</span> <span class="n">MSGMAP</span><span class="p">;</span>
			<span class="n">msginfo</span><span class="p">.</span><span class="n">msgpool</span> <span class="o">=</span> <span class="n">MSGPOOL</span><span class="p">;</span>
			<span class="n">msginfo</span><span class="p">.</span><span class="n">msgtql</span> <span class="o">=</span> <span class="n">MSGTQL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">max_id</span> <span class="o">=</span> <span class="n">ipc_get_maxid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg_ids</span><span class="p">(</span><span class="n">ns</span><span class="p">));</span>
		<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg_ids</span><span class="p">(</span><span class="n">ns</span><span class="p">).</span><span class="n">rw_mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msginfo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">msginfo</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">max_id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">max_id</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">MSG_STAT</span>:	<span class="cm">/* msqid is an index rather than a msg queue id */</span>
	<span class="k">case</span> <span class="n">IPC_STAT</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">msqid64_ds</span> <span class="n">tbuf</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">success_return</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">MSG_STAT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msq</span> <span class="o">=</span> <span class="n">msg_lock</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">msqid</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">msq</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">msq</span><span class="p">);</span>
			<span class="n">success_return</span> <span class="o">=</span> <span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">msq</span> <span class="o">=</span> <span class="n">msg_lock_check</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">msqid</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">msq</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">msq</span><span class="p">);</span>
			<span class="n">success_return</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipcperms</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">security_msg_queue_msgctl</span><span class="p">(</span><span class="n">msq</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tbuf</span><span class="p">));</span>

		<span class="n">kernel_to_ipc64_perm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tbuf</span><span class="p">.</span><span class="n">msg_perm</span><span class="p">);</span>
		<span class="n">tbuf</span><span class="p">.</span><span class="n">msg_stime</span>  <span class="o">=</span> <span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_stime</span><span class="p">;</span>
		<span class="n">tbuf</span><span class="p">.</span><span class="n">msg_rtime</span>  <span class="o">=</span> <span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_rtime</span><span class="p">;</span>
		<span class="n">tbuf</span><span class="p">.</span><span class="n">msg_ctime</span>  <span class="o">=</span> <span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_ctime</span><span class="p">;</span>
		<span class="n">tbuf</span><span class="p">.</span><span class="n">msg_cbytes</span> <span class="o">=</span> <span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_cbytes</span><span class="p">;</span>
		<span class="n">tbuf</span><span class="p">.</span><span class="n">msg_qnum</span>   <span class="o">=</span> <span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_qnum</span><span class="p">;</span>
		<span class="n">tbuf</span><span class="p">.</span><span class="n">msg_qbytes</span> <span class="o">=</span> <span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_qbytes</span><span class="p">;</span>
		<span class="n">tbuf</span><span class="p">.</span><span class="n">msg_lspid</span>  <span class="o">=</span> <span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_lspid</span><span class="p">;</span>
		<span class="n">tbuf</span><span class="p">.</span><span class="n">msg_lrpid</span>  <span class="o">=</span> <span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_lrpid</span><span class="p">;</span>
		<span class="n">msg_unlock</span><span class="p">(</span><span class="n">msq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_msqid_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tbuf</span><span class="p">,</span> <span class="n">version</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">success_return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">IPC_SET</span>:
	<span class="k">case</span> <span class="n">IPC_RMID</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">msgctl_down</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">msqid</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span>  <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out_unlock:</span>
	<span class="n">msg_unlock</span><span class="p">(</span><span class="n">msq</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">testmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">msg_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">long</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">SEARCH_ANY</span>:
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SEARCH_LESSEQUAL</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">m_type</span> <span class="o">&lt;=</span><span class="n">type</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SEARCH_EQUAL</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">m_type</span> <span class="o">==</span> <span class="n">type</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SEARCH_NOTEQUAL</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">m_type</span> <span class="o">!=</span> <span class="n">type</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">pipelined_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">msg_queue</span> <span class="o">*</span><span class="n">msq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msg_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_receivers</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_receivers</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">msg_receiver</span> <span class="o">*</span><span class="n">msr</span><span class="p">;</span>

		<span class="n">msr</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msg_receiver</span><span class="p">,</span> <span class="n">r_list</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">testmsg</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">msr</span><span class="o">-&gt;</span><span class="n">r_msgtype</span><span class="p">,</span> <span class="n">msr</span><span class="o">-&gt;</span><span class="n">r_mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">security_msg_queue_msgrcv</span><span class="p">(</span><span class="n">msq</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">msr</span><span class="o">-&gt;</span><span class="n">r_tsk</span><span class="p">,</span>
					       <span class="n">msr</span><span class="o">-&gt;</span><span class="n">r_msgtype</span><span class="p">,</span> <span class="n">msr</span><span class="o">-&gt;</span><span class="n">r_mode</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msr</span><span class="o">-&gt;</span><span class="n">r_list</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">msr</span><span class="o">-&gt;</span><span class="n">r_maxsize</span> <span class="o">&lt;</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">m_ts</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">msr</span><span class="o">-&gt;</span><span class="n">r_msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">wake_up_process</span><span class="p">(</span><span class="n">msr</span><span class="o">-&gt;</span><span class="n">r_tsk</span><span class="p">);</span>
				<span class="n">smp_mb</span><span class="p">();</span>
				<span class="n">msr</span><span class="o">-&gt;</span><span class="n">r_msg</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">E2BIG</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">msr</span><span class="o">-&gt;</span><span class="n">r_msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_lrpid</span> <span class="o">=</span> <span class="n">task_pid_vnr</span><span class="p">(</span><span class="n">msr</span><span class="o">-&gt;</span><span class="n">r_tsk</span><span class="p">);</span>
				<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_rtime</span> <span class="o">=</span> <span class="n">get_seconds</span><span class="p">();</span>
				<span class="n">wake_up_process</span><span class="p">(</span><span class="n">msr</span><span class="o">-&gt;</span><span class="n">r_tsk</span><span class="p">);</span>
				<span class="n">smp_mb</span><span class="p">();</span>
				<span class="n">msr</span><span class="o">-&gt;</span><span class="n">r_msg</span> <span class="o">=</span> <span class="n">msg</span><span class="p">;</span>

				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">long</span> <span class="n">do_msgsnd</span><span class="p">(</span><span class="kt">int</span> <span class="n">msqid</span><span class="p">,</span> <span class="kt">long</span> <span class="n">mtype</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">mtext</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">msgsz</span><span class="p">,</span> <span class="kt">int</span> <span class="n">msgflg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msg_queue</span> <span class="o">*</span><span class="n">msq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msg_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipc_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">;</span>

	<span class="n">ns</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">nsproxy</span><span class="o">-&gt;</span><span class="n">ipc_ns</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msgsz</span> <span class="o">&gt;</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">msg_ctlmax</span> <span class="o">||</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">msgsz</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">msqid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mtype</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">load_msg</span><span class="p">(</span><span class="n">mtext</span><span class="p">,</span> <span class="n">msgsz</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>

	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">m_type</span> <span class="o">=</span> <span class="n">mtype</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">m_ts</span> <span class="o">=</span> <span class="n">msgsz</span><span class="p">;</span>

	<span class="n">msq</span> <span class="o">=</span> <span class="n">msg_lock_check</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">msqid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">msq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">msq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">msg_sender</span> <span class="n">s</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipcperms</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">,</span> <span class="n">S_IWUGO</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_unlock_free</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">security_msg_queue_msgsnd</span><span class="p">(</span><span class="n">msq</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">msgflg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_unlock_free</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">msgsz</span> <span class="o">+</span> <span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_cbytes</span> <span class="o">&lt;=</span> <span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_qbytes</span> <span class="o">&amp;&amp;</span>
				<span class="mi">1</span> <span class="o">+</span> <span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_qnum</span> <span class="o">&lt;=</span> <span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_qbytes</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* queue full, wait: */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msgflg</span> <span class="o">&amp;</span> <span class="n">IPC_NOWAIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_unlock_free</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ss_add</span><span class="p">(</span><span class="n">msq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
		<span class="n">ipc_rcu_getref</span><span class="p">(</span><span class="n">msq</span><span class="p">);</span>
		<span class="n">msg_unlock</span><span class="p">(</span><span class="n">msq</span><span class="p">);</span>
		<span class="n">schedule</span><span class="p">();</span>

		<span class="n">ipc_lock_by_ptr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">);</span>
		<span class="n">ipc_rcu_putref</span><span class="p">(</span><span class="n">msq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">.</span><span class="n">deleted</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIDRM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_unlock_free</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ss_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTNOHAND</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_unlock_free</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_lspid</span> <span class="o">=</span> <span class="n">task_tgid_vnr</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_stime</span> <span class="o">=</span> <span class="n">get_seconds</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pipelined_send</span><span class="p">(</span><span class="n">msq</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* no one is waiting for this message, enqueue it */</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">m_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_messages</span><span class="p">);</span>
		<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_cbytes</span> <span class="o">+=</span> <span class="n">msgsz</span><span class="p">;</span>
		<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_qnum</span><span class="o">++</span><span class="p">;</span>
		<span class="n">atomic_add</span><span class="p">(</span><span class="n">msgsz</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">msg_bytes</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">msg_hdrs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="nl">out_unlock_free:</span>
	<span class="n">msg_unlock</span><span class="p">(</span><span class="n">msq</span><span class="p">);</span>
<span class="nl">out_free:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">free_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SYSCALL_DEFINE4</span><span class="p">(</span><span class="n">msgsnd</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">msqid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msgbuf</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">msgp</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">,</span> <span class="n">msgsz</span><span class="p">,</span>
		<span class="kt">int</span><span class="p">,</span> <span class="n">msgflg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">mtype</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">mtype</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msgp</span><span class="o">-&gt;</span><span class="n">mtype</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">do_msgsnd</span><span class="p">(</span><span class="n">msqid</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">msgp</span><span class="o">-&gt;</span><span class="n">mtext</span><span class="p">,</span> <span class="n">msgsz</span><span class="p">,</span> <span class="n">msgflg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">convert_mode</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="n">msgtyp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">msgflg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 *  find message of correct type.</span>
<span class="cm">	 *  msgtyp = 0 =&gt; get first.</span>
<span class="cm">	 *  msgtyp &gt; 0 =&gt; get first message of matching type.</span>
<span class="cm">	 *  msgtyp &lt; 0 =&gt; get message with least type must be &lt; abs(msgtype).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">msgtyp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SEARCH_ANY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">msgtyp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">msgtyp</span> <span class="o">=</span> <span class="o">-*</span><span class="n">msgtyp</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">SEARCH_LESSEQUAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msgflg</span> <span class="o">&amp;</span> <span class="n">MSG_EXCEPT</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SEARCH_NOTEQUAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">SEARCH_EQUAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">long</span> <span class="n">do_msgrcv</span><span class="p">(</span><span class="kt">int</span> <span class="n">msqid</span><span class="p">,</span> <span class="kt">long</span> <span class="o">*</span><span class="n">pmtype</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">mtext</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">msgsz</span><span class="p">,</span> <span class="kt">long</span> <span class="n">msgtyp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">msgflg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msg_queue</span> <span class="o">*</span><span class="n">msq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msg_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipc_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msqid</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">msgsz</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">convert_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msgtyp</span><span class="p">,</span> <span class="n">msgflg</span><span class="p">);</span>
	<span class="n">ns</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">nsproxy</span><span class="o">-&gt;</span><span class="n">ipc_ns</span><span class="p">;</span>

	<span class="n">msq</span> <span class="o">=</span> <span class="n">msg_lock_check</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">msqid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">msq</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">msq</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">msg_receiver</span> <span class="n">msr_d</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

		<span class="n">msg</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EACCES</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipcperms</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

		<span class="n">msg</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EAGAIN</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_messages</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_messages</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">msg_msg</span> <span class="o">*</span><span class="n">walk_msg</span><span class="p">;</span>

			<span class="n">walk_msg</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msg_msg</span><span class="p">,</span> <span class="n">m_list</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">testmsg</span><span class="p">(</span><span class="n">walk_msg</span><span class="p">,</span> <span class="n">msgtyp</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">security_msg_queue_msgrcv</span><span class="p">(</span><span class="n">msq</span><span class="p">,</span> <span class="n">walk_msg</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span>
						       <span class="n">msgtyp</span><span class="p">,</span> <span class="n">mode</span><span class="p">))</span> <span class="p">{</span>

				<span class="n">msg</span> <span class="o">=</span> <span class="n">walk_msg</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">SEARCH_LESSEQUAL</span> <span class="o">&amp;&amp;</span>
						<span class="n">walk_msg</span><span class="o">-&gt;</span><span class="n">m_type</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">msg</span> <span class="o">=</span> <span class="n">walk_msg</span><span class="p">;</span>
					<span class="n">msgtyp</span> <span class="o">=</span> <span class="n">walk_msg</span><span class="o">-&gt;</span><span class="n">m_type</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">msg</span> <span class="o">=</span> <span class="n">walk_msg</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Found a suitable message.</span>
<span class="cm">			 * Unlink it from the queue.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">msgsz</span> <span class="o">&lt;</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">m_ts</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">msgflg</span> <span class="o">&amp;</span> <span class="n">MSG_NOERROR</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">msg</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">E2BIG</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">m_list</span><span class="p">);</span>
			<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_qnum</span><span class="o">--</span><span class="p">;</span>
			<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_rtime</span> <span class="o">=</span> <span class="n">get_seconds</span><span class="p">();</span>
			<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_lrpid</span> <span class="o">=</span> <span class="n">task_tgid_vnr</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
			<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_cbytes</span> <span class="o">-=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">m_ts</span><span class="p">;</span>
			<span class="n">atomic_sub</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">m_ts</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">msg_bytes</span><span class="p">);</span>
			<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">msg_hdrs</span><span class="p">);</span>
			<span class="n">ss_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_senders</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">msg_unlock</span><span class="p">(</span><span class="n">msq</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* No message waiting. Wait for a message */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msgflg</span> <span class="o">&amp;</span> <span class="n">IPC_NOWAIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msg</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMSG</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msr_d</span><span class="p">.</span><span class="n">r_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_receivers</span><span class="p">);</span>
		<span class="n">msr_d</span><span class="p">.</span><span class="n">r_tsk</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>
		<span class="n">msr_d</span><span class="p">.</span><span class="n">r_msgtype</span> <span class="o">=</span> <span class="n">msgtyp</span><span class="p">;</span>
		<span class="n">msr_d</span><span class="p">.</span><span class="n">r_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msgflg</span> <span class="o">&amp;</span> <span class="n">MSG_NOERROR</span><span class="p">)</span>
			<span class="n">msr_d</span><span class="p">.</span><span class="n">r_maxsize</span> <span class="o">=</span> <span class="n">INT_MAX</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">msr_d</span><span class="p">.</span><span class="n">r_maxsize</span> <span class="o">=</span> <span class="n">msgsz</span><span class="p">;</span>
		<span class="n">msr_d</span><span class="p">.</span><span class="n">r_msg</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EAGAIN</span><span class="p">);</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">TASK_INTERRUPTIBLE</span><span class="p">;</span>
		<span class="n">msg_unlock</span><span class="p">(</span><span class="n">msq</span><span class="p">);</span>

		<span class="n">schedule</span><span class="p">();</span>

		<span class="cm">/* Lockless receive, part 1:</span>
<span class="cm">		 * Disable preemption.  We don&#39;t hold a reference to the queue</span>
<span class="cm">		 * and getting a reference would defeat the idea of a lockless</span>
<span class="cm">		 * operation, thus the code relies on rcu to guarantee the</span>
<span class="cm">		 * existence of msq:</span>
<span class="cm">		 * Prior to destruction, expunge_all(-EIRDM) changes r_msg.</span>
<span class="cm">		 * Thus if r_msg is -EAGAIN, then the queue not yet destroyed.</span>
<span class="cm">		 * rcu_read_lock() prevents preemption between reading r_msg</span>
<span class="cm">		 * and the spin_lock() inside ipc_lock_by_ptr().</span>
<span class="cm">		 */</span>
		<span class="n">rcu_read_lock</span><span class="p">();</span>

		<span class="cm">/* Lockless receive, part 2:</span>
<span class="cm">		 * Wait until pipelined_send or expunge_all are outside of</span>
<span class="cm">		 * wake_up_process(). There is a race with exit(), see</span>
<span class="cm">		 * ipc/mqueue.c for the details.</span>
<span class="cm">		 */</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">msg_msg</span><span class="o">*</span><span class="p">)</span><span class="n">msr_d</span><span class="p">.</span><span class="n">r_msg</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">msg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cpu_relax</span><span class="p">();</span>
			<span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">msg_msg</span> <span class="o">*</span><span class="p">)</span><span class="n">msr_d</span><span class="p">.</span><span class="n">r_msg</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Lockless receive, part 3:</span>
<span class="cm">		 * If there is a message or an error then accept it without</span>
<span class="cm">		 * locking.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msg</span> <span class="o">!=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EAGAIN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rcu_read_unlock</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Lockless receive, part 3:</span>
<span class="cm">		 * Acquire the queue spinlock.</span>
<span class="cm">		 */</span>
		<span class="n">ipc_lock_by_ptr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">);</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>

		<span class="cm">/* Lockless receive, part 4:</span>
<span class="cm">		 * Repeat test after acquiring the spinlock.</span>
<span class="cm">		 */</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">msg_msg</span><span class="o">*</span><span class="p">)</span><span class="n">msr_d</span><span class="p">.</span><span class="n">r_msg</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msg</span> <span class="o">!=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EAGAIN</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msr_d</span><span class="p">.</span><span class="n">r_list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">msg</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ERESTARTNOHAND</span><span class="p">);</span>
<span class="nl">out_unlock:</span>
			<span class="n">msg_unlock</span><span class="p">(</span><span class="n">msq</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>

	<span class="n">msgsz</span> <span class="o">=</span> <span class="p">(</span><span class="n">msgsz</span> <span class="o">&gt;</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">m_ts</span><span class="p">)</span> <span class="o">?</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">m_ts</span> <span class="o">:</span> <span class="n">msgsz</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pmtype</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">m_type</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">store_msg</span><span class="p">(</span><span class="n">mtext</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">msgsz</span><span class="p">))</span>
		<span class="n">msgsz</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">free_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">msgsz</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SYSCALL_DEFINE5</span><span class="p">(</span><span class="n">msgrcv</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">msqid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msgbuf</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">msgp</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">,</span> <span class="n">msgsz</span><span class="p">,</span>
		<span class="kt">long</span><span class="p">,</span> <span class="n">msgtyp</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">msgflg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">err</span><span class="p">,</span> <span class="n">mtype</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span>  <span class="n">do_msgrcv</span><span class="p">(</span><span class="n">msqid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mtype</span><span class="p">,</span> <span class="n">msgp</span><span class="o">-&gt;</span><span class="n">mtext</span><span class="p">,</span> <span class="n">msgsz</span><span class="p">,</span> <span class="n">msgtyp</span><span class="p">,</span> <span class="n">msgflg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">mtype</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msgp</span><span class="o">-&gt;</span><span class="n">mtype</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sysvipc_msg_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">it</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msg_queue</span> <span class="o">*</span><span class="n">msq</span> <span class="o">=</span> <span class="n">it</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span>
			<span class="s">&quot;%10d %10d  %4o  %10lu %10lu %5u %5u %5u %5u %5u %5u %10lu %10lu %10lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">.</span><span class="n">key</span><span class="p">,</span>
			<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
			<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">.</span><span class="n">mode</span><span class="p">,</span>
			<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_cbytes</span><span class="p">,</span>
			<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_qnum</span><span class="p">,</span>
			<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_lspid</span><span class="p">,</span>
			<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_lrpid</span><span class="p">,</span>
			<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">.</span><span class="n">uid</span><span class="p">,</span>
			<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">.</span><span class="n">gid</span><span class="p">,</span>
			<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">.</span><span class="n">cuid</span><span class="p">,</span>
			<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">.</span><span class="n">cgid</span><span class="p">,</span>
			<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_stime</span><span class="p">,</span>
			<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_rtime</span><span class="p">,</span>
			<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_ctime</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:1}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../javascript/docco.min.js"></script>
</html>
