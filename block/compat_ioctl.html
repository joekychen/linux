<!DOCTYPE html>
<html><head><title>joekychen/linux » block › compat_ioctl.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../index.html"></a><h1>compat_ioctl.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/blkpg.h&gt;</span>
<span class="cp">#include &lt;linux/blktrace_api.h&gt;</span>
<span class="cp">#include &lt;linux/cdrom.h&gt;</span>
<span class="cp">#include &lt;linux/compat.h&gt;</span>
<span class="cp">#include &lt;linux/elevator.h&gt;</span>
<span class="cp">#include &lt;linux/fd.h&gt;</span>
<span class="cp">#include &lt;linux/hdreg.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/syscalls.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">compat_put_ushort</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">compat_put_int</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">compat_int_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">compat_put_uint</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">compat_uint_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">compat_put_long</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">,</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">compat_long_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">compat_put_ulong</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">,</span> <span class="n">compat_ulong_t</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">compat_ulong_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">compat_put_u64</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">,</span> <span class="n">u64</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">compat_u64</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">compat_hd_geometry</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">heads</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sectors</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">cylinders</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">start</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">compat_hdio_getgeo</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">compat_hd_geometry</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ugeo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hd_geometry</span> <span class="n">geo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ugeo</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">fops</span><span class="o">-&gt;</span><span class="n">getgeo</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We need to set the startsect first, the driver may</span>
<span class="cm">	 * want to override it.</span>
<span class="cm">	 */</span>
	<span class="n">geo</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">get_start_sect</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">fops</span><span class="o">-&gt;</span><span class="n">getgeo</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">geo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">ugeo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">geo</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">geo</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ugeo</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">compat_hdio_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mm_segment_t</span> <span class="n">old_fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">kval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uvp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">__blkdev_driver_ioctl</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span>
				<span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">kval</span><span class="p">));</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">old_fs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uvp</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">kval</span><span class="p">,</span> <span class="n">uvp</span><span class="p">))</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">compat_cdrom_read_audio</span> <span class="p">{</span>
	<span class="k">union</span> <span class="n">cdrom_addr</span>	<span class="n">addr</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">addr_format</span><span class="p">;</span>
	<span class="n">compat_int_t</span>		<span class="n">nframes</span><span class="p">;</span>
	<span class="n">compat_caddr_t</span>		<span class="n">buf</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">compat_cdrom_generic_command</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">cmd</span><span class="p">[</span><span class="n">CDROM_PACKET_SIZE</span><span class="p">];</span>
	<span class="n">compat_caddr_t</span>	<span class="n">buffer</span><span class="p">;</span>
	<span class="n">compat_uint_t</span>	<span class="n">buflen</span><span class="p">;</span>
	<span class="n">compat_int_t</span>	<span class="n">stat</span><span class="p">;</span>
	<span class="n">compat_caddr_t</span>	<span class="n">sense</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">data_direction</span><span class="p">;</span>
	<span class="n">compat_int_t</span>	<span class="n">quiet</span><span class="p">;</span>
	<span class="n">compat_int_t</span>	<span class="n">timeout</span><span class="p">;</span>
	<span class="n">compat_caddr_t</span>	<span class="n">reserved</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">compat_cdrom_read_audio</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_read_audio</span> <span class="n">__user</span> <span class="o">*</span><span class="n">cdread_audio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">compat_cdrom_read_audio</span> <span class="n">__user</span> <span class="o">*</span><span class="n">cdread_audio32</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">datap</span><span class="p">;</span>

	<span class="n">cdread_audio</span> <span class="o">=</span> <span class="n">compat_alloc_user_space</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cdread_audio</span><span class="p">));</span>
	<span class="n">cdread_audio32</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_in_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdread_audio</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
			 <span class="o">&amp;</span><span class="n">cdread_audio32</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cdread_audio32</span><span class="p">)</span> <span class="o">-</span>
			  <span class="k">sizeof</span><span class="p">(</span><span class="n">compat_caddr_t</span><span class="p">))))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cdread_audio32</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">datap</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">datap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cdread_audio</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">__blkdev_driver_ioctl</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cdread_audio</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">compat_cdrom_generic_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_generic_command</span> <span class="n">__user</span> <span class="o">*</span><span class="n">cgc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">compat_cdrom_generic_command</span> <span class="n">__user</span> <span class="o">*</span><span class="n">cgc32</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dir</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">itmp</span><span class="p">;</span>

	<span class="n">cgc</span> <span class="o">=</span> <span class="n">compat_alloc_user_space</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cgc</span><span class="p">));</span>
	<span class="n">cgc32</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_in_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc32</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">get_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc32</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">put_user</span><span class="p">(</span><span class="n">compat_ptr</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">copy_in_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buflen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc32</span><span class="o">-&gt;</span><span class="n">buflen</span><span class="p">,</span>
			 <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)))</span> <span class="o">||</span>
	    <span class="n">get_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc32</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">put_user</span><span class="p">(</span><span class="n">compat_ptr</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">get_user</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc32</span><span class="o">-&gt;</span><span class="n">data_direction</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">put_user</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="o">-&gt;</span><span class="n">data_direction</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">get_user</span><span class="p">(</span><span class="n">itmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc32</span><span class="o">-&gt;</span><span class="n">quiet</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">put_user</span><span class="p">(</span><span class="n">itmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="o">-&gt;</span><span class="n">quiet</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">get_user</span><span class="p">(</span><span class="n">itmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc32</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">put_user</span><span class="p">(</span><span class="n">itmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">get_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc32</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">||</span>
	    <span class="n">put_user</span><span class="p">(</span><span class="n">compat_ptr</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">__blkdev_driver_ioctl</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cgc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">compat_blkpg_ioctl_arg</span> <span class="p">{</span>
	<span class="n">compat_int_t</span> <span class="n">op</span><span class="p">;</span>
	<span class="n">compat_int_t</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">compat_int_t</span> <span class="n">datalen</span><span class="p">;</span>
	<span class="n">compat_caddr_t</span> <span class="n">data</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">compat_blkpg_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">compat_blkpg_ioctl_arg</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ua32</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">blkpg_ioctl_arg</span> <span class="n">__user</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">compat_alloc_user_space</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">));</span>
	<span class="n">compat_caddr_t</span> <span class="n">udata</span><span class="p">;</span>
	<span class="n">compat_int_t</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ua32</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ua32</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ua32</span><span class="o">-&gt;</span><span class="n">datalen</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">datalen</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">udata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ua32</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">compat_ptr</span><span class="p">(</span><span class="n">udata</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">blkdev_ioctl</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">a</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define BLKBSZGET_32		_IOR(0x12, 112, int)</span>
<span class="cp">#define BLKBSZSET_32		_IOW(0x12, 113, int)</span>
<span class="cp">#define BLKGETSIZE64_32		_IOR(0x12, 114, int)</span>

<span class="k">struct</span> <span class="n">compat_floppy_drive_params</span> <span class="p">{</span>
	<span class="kt">char</span>		<span class="n">cmos</span><span class="p">;</span>
	<span class="n">compat_ulong_t</span>	<span class="n">max_dtr</span><span class="p">;</span>
	<span class="n">compat_ulong_t</span>	<span class="n">hlt</span><span class="p">;</span>
	<span class="n">compat_ulong_t</span>	<span class="n">hut</span><span class="p">;</span>
	<span class="n">compat_ulong_t</span>	<span class="n">srt</span><span class="p">;</span>
	<span class="n">compat_ulong_t</span>	<span class="n">spinup</span><span class="p">;</span>
	<span class="n">compat_ulong_t</span>	<span class="n">spindown</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">spindown_offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">select_delay</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">rps</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">tracks</span><span class="p">;</span>
	<span class="n">compat_ulong_t</span>	<span class="n">timeout</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">interleave_sect</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">floppy_max_errors</span> <span class="n">max_errors</span><span class="p">;</span>
	<span class="kt">char</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="kt">char</span>		<span class="n">read_track</span><span class="p">;</span>
	<span class="kt">short</span>		<span class="n">autodetect</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">compat_int_t</span>	<span class="n">checkfreq</span><span class="p">;</span>
	<span class="n">compat_int_t</span>	<span class="n">native_format</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">compat_floppy_drive_struct</span> <span class="p">{</span>
	<span class="kt">signed</span> <span class="kt">char</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="n">compat_ulong_t</span>	<span class="n">spinup_date</span><span class="p">;</span>
	<span class="n">compat_ulong_t</span>	<span class="n">select_date</span><span class="p">;</span>
	<span class="n">compat_ulong_t</span>	<span class="n">first_read_date</span><span class="p">;</span>
	<span class="kt">short</span>		<span class="n">probed_format</span><span class="p">;</span>
	<span class="kt">short</span>		<span class="n">track</span><span class="p">;</span>
	<span class="kt">short</span>		<span class="n">maxblock</span><span class="p">;</span>
	<span class="kt">short</span>		<span class="n">maxtrack</span><span class="p">;</span>
	<span class="n">compat_int_t</span>	<span class="n">generation</span><span class="p">;</span>
	<span class="n">compat_int_t</span>	<span class="n">keep_data</span><span class="p">;</span>
	<span class="n">compat_int_t</span>	<span class="n">fd_ref</span><span class="p">;</span>
	<span class="n">compat_int_t</span>	<span class="n">fd_device</span><span class="p">;</span>
	<span class="n">compat_int_t</span>	<span class="n">last_checked</span><span class="p">;</span>
	<span class="n">compat_caddr_t</span> <span class="n">dmabuf</span><span class="p">;</span>
	<span class="n">compat_int_t</span>	<span class="n">bufblocks</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">compat_floppy_fdc_state</span> <span class="p">{</span>
	<span class="n">compat_int_t</span>	<span class="n">spec1</span><span class="p">;</span>
	<span class="n">compat_int_t</span>	<span class="n">spec2</span><span class="p">;</span>
	<span class="n">compat_int_t</span>	<span class="n">dtr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">version</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">dor</span><span class="p">;</span>
	<span class="n">compat_ulong_t</span>	<span class="n">address</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">rawcmd</span><span class="o">:</span><span class="mi">2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">reset</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">need_configure</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">perp_mode</span><span class="o">:</span><span class="mi">2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">has_fifo</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">driver_version</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">track</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">compat_floppy_write_errors</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">write_errors</span><span class="p">;</span>
	<span class="n">compat_ulong_t</span>	<span class="n">first_error_sector</span><span class="p">;</span>
	<span class="n">compat_int_t</span>	<span class="n">first_error_generation</span><span class="p">;</span>
	<span class="n">compat_ulong_t</span>	<span class="n">last_error_sector</span><span class="p">;</span>
	<span class="n">compat_int_t</span>	<span class="n">last_error_generation</span><span class="p">;</span>
	<span class="n">compat_uint_t</span>	<span class="n">badness</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define FDSETPRM32 _IOW(2, 0x42, struct compat_floppy_struct)</span>
<span class="cp">#define FDDEFPRM32 _IOW(2, 0x43, struct compat_floppy_struct)</span>
<span class="cp">#define FDSETDRVPRM32 _IOW(2, 0x90, struct compat_floppy_drive_params)</span>
<span class="cp">#define FDGETDRVPRM32 _IOR(2, 0x11, struct compat_floppy_drive_params)</span>
<span class="cp">#define FDGETDRVSTAT32 _IOR(2, 0x12, struct compat_floppy_drive_struct)</span>
<span class="cp">#define FDPOLLDRVSTAT32 _IOR(2, 0x13, struct compat_floppy_drive_struct)</span>
<span class="cp">#define FDGETFDCSTAT32 _IOR(2, 0x15, struct compat_floppy_fdc_state)</span>
<span class="cp">#define FDWERRORGET32  _IOR(2, 0x17, struct compat_floppy_write_errors)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">cmd32</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">cmd</span><span class="p">;</span>
<span class="p">}</span> <span class="n">fd_ioctl_trans_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">FDSETPRM32</span><span class="p">,</span> <span class="n">FDSETPRM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">FDDEFPRM32</span><span class="p">,</span> <span class="n">FDDEFPRM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">FDGETPRM32</span><span class="p">,</span> <span class="n">FDGETPRM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">FDSETDRVPRM32</span><span class="p">,</span> <span class="n">FDSETDRVPRM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">FDGETDRVPRM32</span><span class="p">,</span> <span class="n">FDGETDRVPRM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">FDGETDRVSTAT32</span><span class="p">,</span> <span class="n">FDGETDRVSTAT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">FDPOLLDRVSTAT32</span><span class="p">,</span> <span class="n">FDPOLLDRVSTAT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">FDGETFDCSTAT32</span><span class="p">,</span> <span class="n">FDGETFDCSTAT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">FDWERRORGET32</span><span class="p">,</span> <span class="n">FDWERRORGET</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cp">#define NR_FD_IOCTL_TRANS ARRAY_SIZE(fd_ioctl_trans_table)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">compat_fd_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mm_segment_t</span> <span class="n">old_fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">karg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">kcmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_FD_IOCTL_TRANS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">fd_ioctl_trans_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmd32</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kcmd</span> <span class="o">=</span> <span class="n">fd_ioctl_trans_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmd</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kcmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FDSETPRM32</span>:
	<span class="k">case</span> <span class="n">FDDEFPRM32</span>:
	<span class="k">case</span> <span class="n">FDGETPRM32</span>:
	<span class="p">{</span>
		<span class="n">compat_uptr_t</span> <span class="n">name</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">compat_floppy_struct</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uf</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">floppy_struct</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>

		<span class="n">uf</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
		<span class="n">f</span> <span class="o">=</span> <span class="n">karg</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">floppy_struct</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">karg</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">FDGETPRM32</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">sect</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">sect</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">stretch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">stretch</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">gap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">gap</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">spec1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">spec1</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt_gap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">fmt_gap</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">FDSETDRVPRM32</span>:
	<span class="k">case</span> <span class="n">FDGETDRVPRM32</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">compat_floppy_drive_params</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uf</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">floppy_drive_params</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>

		<span class="n">uf</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
		<span class="n">f</span> <span class="o">=</span> <span class="n">karg</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">floppy_drive_params</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">karg</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">FDGETDRVPRM32</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">cmos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">cmos</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">max_dtr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">max_dtr</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">hlt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">hlt</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">hut</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">hut</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">srt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">srt</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">spinup</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">spinup</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">spindown</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">spindown</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">spindown_offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">spindown_offset</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">select_delay</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">select_delay</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">rps</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">rps</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">tracks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">tracks</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">interleave_sect</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">interleave_sect</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">max_errors</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">max_errors</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">max_errors</span><span class="p">));</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">read_track</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">read_track</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__copy_from_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">autodetect</span><span class="p">,</span> <span class="n">uf</span><span class="o">-&gt;</span><span class="n">autodetect</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">autodetect</span><span class="p">));</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">checkfreq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">checkfreq</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">native_format</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">native_format</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">FDGETDRVSTAT32</span>:
	<span class="k">case</span> <span class="n">FDPOLLDRVSTAT32</span>:
		<span class="n">karg</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">floppy_drive_struct</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">karg</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FDGETFDCSTAT32</span>:
		<span class="n">karg</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">floppy_fdc_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">karg</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FDWERRORGET32</span>:
		<span class="n">karg</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">floppy_write_errors</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">karg</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">__blkdev_driver_ioctl</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">kcmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">karg</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">old_fs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FDGETPRM32</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">floppy_struct</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">karg</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">compat_floppy_struct</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uf</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">sect</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">sect</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">stretch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">stretch</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">gap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">gap</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">spec1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">spec1</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt_gap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">fmt_gap</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">compat_caddr_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">FDGETDRVPRM32</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">compat_floppy_drive_params</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uf</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">floppy_drive_params</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">karg</span><span class="p">;</span>

		<span class="n">uf</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">cmos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">cmos</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">max_dtr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">max_dtr</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">hlt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">hlt</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">hut</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">hut</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">srt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">srt</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">spinup</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">spinup</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">spindown</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">spindown</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">spindown_offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">spindown_offset</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">select_delay</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">select_delay</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">rps</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">rps</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">tracks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">tracks</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">interleave_sect</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">interleave_sect</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">max_errors</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">max_errors</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">max_errors</span><span class="p">));</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">read_track</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">read_track</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__copy_to_user</span><span class="p">(</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">autodetect</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">autodetect</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">autodetect</span><span class="p">));</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">checkfreq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">checkfreq</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">native_format</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">native_format</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">FDGETDRVSTAT32</span>:
	<span class="k">case</span> <span class="n">FDPOLLDRVSTAT32</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">compat_floppy_drive_struct</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uf</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">floppy_drive_struct</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">karg</span><span class="p">;</span>

		<span class="n">uf</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">spinup_date</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">spinup_date</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">select_date</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">select_date</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">first_read_date</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">first_read_date</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">probed_format</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">probed_format</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">maxblock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">maxblock</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">maxtrack</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">maxtrack</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">generation</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">generation</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">keep_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">keep_data</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fd_ref</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">fd_ref</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fd_device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">fd_device</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">last_checked</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">last_checked</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">dmabuf</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">bufblocks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">bufblocks</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">FDGETFDCSTAT32</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">compat_floppy_fdc_state</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uf</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">floppy_fdc_state</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">karg</span><span class="p">;</span>

		<span class="n">uf</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">spec1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">spec1</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">spec2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">spec2</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">dtr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">dtr</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">dor</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">dor</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__copy_to_user</span><span class="p">((</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">),</span>
				   <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">driver_version</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">driver_version</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__copy_to_user</span><span class="p">(</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">FDWERRORGET32</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">compat_floppy_write_errors</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uf</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">floppy_write_errors</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">karg</span><span class="p">;</span>

		<span class="n">uf</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">write_errors</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">write_errors</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">first_error_sector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">first_error_sector</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">first_error_generation</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">first_error_generation</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">last_error_sector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">last_error_sector</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">last_error_generation</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">last_error_generation</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">badness</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uf</span><span class="o">-&gt;</span><span class="n">badness</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">karg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">compat_blkdev_driver_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HDIO_GET_UNMASKINTR</span>:
	<span class="k">case</span> <span class="n">HDIO_GET_MULTCOUNT</span>:
	<span class="k">case</span> <span class="n">HDIO_GET_KEEPSETTINGS</span>:
	<span class="k">case</span> <span class="n">HDIO_GET_32BIT</span>:
	<span class="k">case</span> <span class="n">HDIO_GET_NOWERR</span>:
	<span class="k">case</span> <span class="n">HDIO_GET_DMA</span>:
	<span class="k">case</span> <span class="n">HDIO_GET_NICE</span>:
	<span class="k">case</span> <span class="n">HDIO_GET_WCACHE</span>:
	<span class="k">case</span> <span class="n">HDIO_GET_ACOUSTIC</span>:
	<span class="k">case</span> <span class="n">HDIO_GET_ADDRESS</span>:
	<span class="k">case</span> <span class="n">HDIO_GET_BUSSTATE</span>:
		<span class="k">return</span> <span class="n">compat_hdio_ioctl</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">FDSETPRM32</span>:
	<span class="k">case</span> <span class="n">FDDEFPRM32</span>:
	<span class="k">case</span> <span class="n">FDGETPRM32</span>:
	<span class="k">case</span> <span class="n">FDSETDRVPRM32</span>:
	<span class="k">case</span> <span class="n">FDGETDRVPRM32</span>:
	<span class="k">case</span> <span class="n">FDGETDRVSTAT32</span>:
	<span class="k">case</span> <span class="n">FDPOLLDRVSTAT32</span>:
	<span class="k">case</span> <span class="n">FDGETFDCSTAT32</span>:
	<span class="k">case</span> <span class="n">FDWERRORGET32</span>:
		<span class="k">return</span> <span class="n">compat_fd_ioctl</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CDROMREADAUDIO</span>:
		<span class="k">return</span> <span class="n">compat_cdrom_read_audio</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CDROM_SEND_PACKET</span>:
		<span class="k">return</span> <span class="n">compat_cdrom_generic_command</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * No handler required for the ones below, we just need to</span>
<span class="cm">	 * convert arg to a 64 bit pointer.</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">BLKSECTSET</span>:
	<span class="cm">/*</span>
<span class="cm">	 * 0x03 -- HD/IDE ioctl&#39;s used by hdparm and friends.</span>
<span class="cm">	 *         Some need translations, these do not.</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">HDIO_GET_IDENTITY</span>:
	<span class="k">case</span> <span class="n">HDIO_DRIVE_TASK</span>:
	<span class="k">case</span> <span class="n">HDIO_DRIVE_CMD</span>:
	<span class="cm">/* 0x330 is reserved -- it used to be HDIO_GETGEO_BIG */</span>
	<span class="k">case</span> <span class="mh">0x330</span>:
	<span class="cm">/* 0x02 -- Floppy ioctls */</span>
	<span class="k">case</span> <span class="n">FDMSGON</span>:
	<span class="k">case</span> <span class="n">FDMSGOFF</span>:
	<span class="k">case</span> <span class="n">FDSETEMSGTRESH</span>:
	<span class="k">case</span> <span class="n">FDFLUSH</span>:
	<span class="k">case</span> <span class="n">FDWERRORCLR</span>:
	<span class="k">case</span> <span class="n">FDSETMAXERRS</span>:
	<span class="k">case</span> <span class="n">FDGETMAXERRS</span>:
	<span class="k">case</span> <span class="n">FDGETDRVTYP</span>:
	<span class="k">case</span> <span class="n">FDEJECT</span>:
	<span class="k">case</span> <span class="n">FDCLRPRM</span>:
	<span class="k">case</span> <span class="n">FDFMTBEG</span>:
	<span class="k">case</span> <span class="n">FDFMTEND</span>:
	<span class="k">case</span> <span class="n">FDRESET</span>:
	<span class="k">case</span> <span class="n">FDTWADDLE</span>:
	<span class="k">case</span> <span class="n">FDFMTTRK</span>:
	<span class="k">case</span> <span class="n">FDRAWCMD</span>:
	<span class="cm">/* CDROM stuff */</span>
	<span class="k">case</span> <span class="n">CDROMPAUSE</span>:
	<span class="k">case</span> <span class="n">CDROMRESUME</span>:
	<span class="k">case</span> <span class="n">CDROMPLAYMSF</span>:
	<span class="k">case</span> <span class="n">CDROMPLAYTRKIND</span>:
	<span class="k">case</span> <span class="n">CDROMREADTOCHDR</span>:
	<span class="k">case</span> <span class="n">CDROMREADTOCENTRY</span>:
	<span class="k">case</span> <span class="n">CDROMSTOP</span>:
	<span class="k">case</span> <span class="n">CDROMSTART</span>:
	<span class="k">case</span> <span class="n">CDROMEJECT</span>:
	<span class="k">case</span> <span class="n">CDROMVOLCTRL</span>:
	<span class="k">case</span> <span class="n">CDROMSUBCHNL</span>:
	<span class="k">case</span> <span class="n">CDROMMULTISESSION</span>:
	<span class="k">case</span> <span class="n">CDROM_GET_MCN</span>:
	<span class="k">case</span> <span class="n">CDROMRESET</span>:
	<span class="k">case</span> <span class="n">CDROMVOLREAD</span>:
	<span class="k">case</span> <span class="n">CDROMSEEK</span>:
	<span class="k">case</span> <span class="n">CDROMPLAYBLK</span>:
	<span class="k">case</span> <span class="n">CDROMCLOSETRAY</span>:
	<span class="k">case</span> <span class="n">CDROM_DISC_STATUS</span>:
	<span class="k">case</span> <span class="n">CDROM_CHANGER_NSLOTS</span>:
	<span class="k">case</span> <span class="n">CDROM_GET_CAPABILITY</span>:
	<span class="cm">/* Ignore cdrom.h about these next 5 ioctls, they absolutely do</span>
<span class="cm">	 * not take a struct cdrom_read, instead they take a struct cdrom_msf</span>
<span class="cm">	 * which is compatible.</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">CDROMREADMODE2</span>:
	<span class="k">case</span> <span class="n">CDROMREADMODE1</span>:
	<span class="k">case</span> <span class="n">CDROMREADRAW</span>:
	<span class="k">case</span> <span class="n">CDROMREADCOOKED</span>:
	<span class="k">case</span> <span class="n">CDROMREADALL</span>:
	<span class="cm">/* DVD ioctls */</span>
	<span class="k">case</span> <span class="n">DVD_READ_STRUCT</span>:
	<span class="k">case</span> <span class="n">DVD_WRITE_STRUCT</span>:
	<span class="k">case</span> <span class="n">DVD_AUTH</span>:
		<span class="n">arg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
	<span class="cm">/* These intepret arg as an unsigned long, not as a pointer,</span>
<span class="cm">	 * so we must not do compat_ptr() conversion. */</span>
	<span class="k">case</span> <span class="n">HDIO_SET_MULTCOUNT</span>:
	<span class="k">case</span> <span class="n">HDIO_SET_UNMASKINTR</span>:
	<span class="k">case</span> <span class="n">HDIO_SET_KEEPSETTINGS</span>:
	<span class="k">case</span> <span class="n">HDIO_SET_32BIT</span>:
	<span class="k">case</span> <span class="n">HDIO_SET_NOWERR</span>:
	<span class="k">case</span> <span class="n">HDIO_SET_DMA</span>:
	<span class="k">case</span> <span class="n">HDIO_SET_PIO_MODE</span>:
	<span class="k">case</span> <span class="n">HDIO_SET_NICE</span>:
	<span class="k">case</span> <span class="n">HDIO_SET_WCACHE</span>:
	<span class="k">case</span> <span class="n">HDIO_SET_ACOUSTIC</span>:
	<span class="k">case</span> <span class="n">HDIO_SET_BUSSTATE</span>:
	<span class="k">case</span> <span class="n">HDIO_SET_ADDRESS</span>:
	<span class="k">case</span> <span class="n">CDROMEJECT_SW</span>:
	<span class="k">case</span> <span class="n">CDROM_SET_OPTIONS</span>:
	<span class="k">case</span> <span class="n">CDROM_CLEAR_OPTIONS</span>:
	<span class="k">case</span> <span class="n">CDROM_SELECT_SPEED</span>:
	<span class="k">case</span> <span class="n">CDROM_SELECT_DISC</span>:
	<span class="k">case</span> <span class="n">CDROM_MEDIA_CHANGED</span>:
	<span class="k">case</span> <span class="n">CDROM_DRIVE_STATUS</span>:
	<span class="k">case</span> <span class="n">CDROM_LOCKDOOR</span>:
	<span class="k">case</span> <span class="n">CDROM_DEBUG</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* unknown ioctl number */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">__blkdev_driver_ioctl</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Most of the generic ioctls are handled in the normal fallback path.</span>
<span class="cm">   This assumes the blkdev&#39;s low level compat_ioctl always returns</span>
<span class="cm">   ENOIOCTLCMD for unknown ioctls. */</span>
<span class="kt">long</span> <span class="nf">compat_blkdev_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mapping</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_bdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span> <span class="o">=</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="p">;</span>
	<span class="n">fmode_t</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">backing_dev_info</span> <span class="o">*</span><span class="n">bdi</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">size</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * O_NDELAY can be altered using fcntl(.., F_SETFL, ..), so we have</span>
<span class="cm">	 * to updated it before every ioctl.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NDELAY</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">FMODE_NDELAY</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FMODE_NDELAY</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HDIO_GETGEO</span>:
		<span class="k">return</span> <span class="n">compat_hdio_getgeo</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="n">bdev</span><span class="p">,</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span>
	<span class="k">case</span> <span class="n">BLKPBSZGET</span>:
		<span class="k">return</span> <span class="n">compat_put_uint</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">bdev_physical_block_size</span><span class="p">(</span><span class="n">bdev</span><span class="p">));</span>
	<span class="k">case</span> <span class="n">BLKIOMIN</span>:
		<span class="k">return</span> <span class="n">compat_put_uint</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">bdev_io_min</span><span class="p">(</span><span class="n">bdev</span><span class="p">));</span>
	<span class="k">case</span> <span class="n">BLKIOOPT</span>:
		<span class="k">return</span> <span class="n">compat_put_uint</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">bdev_io_opt</span><span class="p">(</span><span class="n">bdev</span><span class="p">));</span>
	<span class="k">case</span> <span class="n">BLKALIGNOFF</span>:
		<span class="k">return</span> <span class="n">compat_put_int</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">bdev_alignment_offset</span><span class="p">(</span><span class="n">bdev</span><span class="p">));</span>
	<span class="k">case</span> <span class="n">BLKDISCARDZEROES</span>:
		<span class="k">return</span> <span class="n">compat_put_uint</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">bdev_discard_zeroes_data</span><span class="p">(</span><span class="n">bdev</span><span class="p">));</span>
	<span class="k">case</span> <span class="n">BLKFLSBUF</span>:
	<span class="k">case</span> <span class="n">BLKROSET</span>:
	<span class="k">case</span> <span class="n">BLKDISCARD</span>:
	<span class="k">case</span> <span class="n">BLKSECDISCARD</span>:
	<span class="cm">/*</span>
<span class="cm">	 * the ones below are implemented in blkdev_locked_ioctl,</span>
<span class="cm">	 * but we call blkdev_ioctl, which gets the lock for us</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">BLKRRPART</span>:
		<span class="k">return</span> <span class="n">blkdev_ioctl</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span>
	<span class="k">case</span> <span class="n">BLKBSZSET_32</span>:
		<span class="k">return</span> <span class="n">blkdev_ioctl</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">BLKBSZSET</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span>
	<span class="k">case</span> <span class="n">BLKPG</span>:
		<span class="k">return</span> <span class="n">compat_blkpg_ioctl</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span>
	<span class="k">case</span> <span class="n">BLKRAGET</span>:
	<span class="k">case</span> <span class="n">BLKFRAGET</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">bdi</span> <span class="o">=</span> <span class="n">blk_get_backing_dev_info</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bdi</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">compat_put_long</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span>
				       <span class="p">(</span><span class="n">bdi</span><span class="o">-&gt;</span><span class="n">ra_pages</span> <span class="o">*</span> <span class="n">PAGE_CACHE_SIZE</span><span class="p">)</span> <span class="o">/</span> <span class="mi">512</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">BLKROGET</span>: <span class="cm">/* compatible */</span>
		<span class="k">return</span> <span class="n">compat_put_int</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">bdev_read_only</span><span class="p">(</span><span class="n">bdev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">BLKBSZGET_32</span>: <span class="cm">/* get the logical block size (cf. BLKSSZGET) */</span>
		<span class="k">return</span> <span class="n">compat_put_int</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">block_size</span><span class="p">(</span><span class="n">bdev</span><span class="p">));</span>
	<span class="k">case</span> <span class="n">BLKSSZGET</span>: <span class="cm">/* get block device hardware sector size */</span>
		<span class="k">return</span> <span class="n">compat_put_int</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">bdev_logical_block_size</span><span class="p">(</span><span class="n">bdev</span><span class="p">));</span>
	<span class="k">case</span> <span class="n">BLKSECTGET</span>:
		<span class="k">return</span> <span class="n">compat_put_ushort</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span>
					 <span class="n">queue_max_sectors</span><span class="p">(</span><span class="n">bdev_get_queue</span><span class="p">(</span><span class="n">bdev</span><span class="p">)));</span>
	<span class="k">case</span> <span class="n">BLKROTATIONAL</span>:
		<span class="k">return</span> <span class="n">compat_put_ushort</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span>
					 <span class="o">!</span><span class="n">blk_queue_nonrot</span><span class="p">(</span><span class="n">bdev_get_queue</span><span class="p">(</span><span class="n">bdev</span><span class="p">)));</span>
	<span class="k">case</span> <span class="n">BLKRASET</span>: <span class="cm">/* compatible, but no compat_ptr (!) */</span>
	<span class="k">case</span> <span class="n">BLKFRASET</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="n">bdi</span> <span class="o">=</span> <span class="n">blk_get_backing_dev_info</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bdi</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
		<span class="n">bdi</span><span class="o">-&gt;</span><span class="n">ra_pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span> <span class="o">*</span> <span class="mi">512</span><span class="p">)</span> <span class="o">/</span> <span class="n">PAGE_CACHE_SIZE</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BLKGETSIZE</span>:
		<span class="n">size</span> <span class="o">=</span> <span class="n">i_size_read</span><span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_inode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">~</span><span class="mi">0UL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFBIG</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">compat_put_ulong</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">BLKGETSIZE64_32</span>:
		<span class="k">return</span> <span class="n">compat_put_u64</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">i_size_read</span><span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_inode</span><span class="p">));</span>

	<span class="k">case</span> <span class="n">BLKTRACESETUP32</span>:
	<span class="k">case</span> <span class="n">BLKTRACESTART</span>: <span class="cm">/* compatible */</span>
	<span class="k">case</span> <span class="n">BLKTRACESTOP</span>:  <span class="cm">/* compatible */</span>
	<span class="k">case</span> <span class="n">BLKTRACETEARDOWN</span>: <span class="cm">/* compatible */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">blk_trace_ioctl</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">fops</span><span class="o">-&gt;</span><span class="n">compat_ioctl</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">fops</span><span class="o">-&gt;</span><span class="n">compat_ioctl</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">compat_blkdev_driver_ioctl</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:1}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../javascript/docco.min.js"></script>
</html>
