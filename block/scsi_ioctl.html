<!DOCTYPE html>
<html><head><title>joekychen/linux » block › scsi_ioctl.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../index.html"></a><h1>scsi_ioctl.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2001 Jens Axboe &lt;axboe@suse.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public Licens</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/capability.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/cdrom.h&gt;</span>
<span class="cp">#include &lt;linux/ratelimit.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/times.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_ioctl.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>

<span class="k">struct</span> <span class="n">blk_cmd_filter</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">read_ok</span><span class="p">[</span><span class="n">BLK_SCSI_CMD_PER_LONG</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">write_ok</span><span class="p">[</span><span class="n">BLK_SCSI_CMD_PER_LONG</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">blk_cmd_filter</span> <span class="n">blk_default_cmd_filter</span><span class="p">;</span>

<span class="cm">/* Command group 3 is reserved and should never be used.  */</span>
<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scsi_command_size_tbl</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span>
	<span class="mi">16</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">scsi_command_size_tbl</span><span class="p">);</span>

<span class="cp">#include &lt;scsi/sg.h&gt;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sg_get_version</span><span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">sg_version_num</span> <span class="o">=</span> <span class="mi">30527</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">sg_version_num</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">scsi_get_idlun</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">scsi_get_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sg_get_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">jiffies_to_clock_t</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">sg_timeout</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sg_set_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">sg_timeout</span> <span class="o">=</span> <span class="n">clock_t_to_jiffies</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sg_get_reserved_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">val</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">sg_reserved_size</span><span class="p">,</span> <span class="n">queue_max_sectors</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sg_set_reserved_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">queue_max_sectors</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">))</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">queue_max_sectors</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>

	<span class="n">q</span><span class="o">-&gt;</span><span class="n">sg_reserved_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * will always return that we are ATAPI even for a real SCSI drive, I&#39;m not</span>
<span class="cm"> * so sure this is worth doing anything about (why would you care??)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sg_emulated_host</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">blk_set_cmd_filter_defaults</span><span class="p">(</span><span class="k">struct</span> <span class="n">blk_cmd_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Basic read-only commands */</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">TEST_UNIT_READY</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">REQUEST_SENSE</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">READ_6</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">READ_10</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">READ_12</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">READ_16</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">READ_BUFFER</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">READ_DEFECT_DATA</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">READ_CAPACITY</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">READ_LONG</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">INQUIRY</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">MODE_SENSE</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">MODE_SENSE_10</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">LOG_SENSE</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">START_STOP</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_VERIFY_10</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">VERIFY_16</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">REPORT_LUNS</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">SERVICE_ACTION_IN</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">RECEIVE_DIAGNOSTIC</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">MAINTENANCE_IN</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_READ_BUFFER_CAPACITY</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>

	<span class="cm">/* Audio CD commands */</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_PLAY_CD</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_PLAY_AUDIO_10</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_PLAY_AUDIO_MSF</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_PLAY_AUDIO_TI</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_PAUSE_RESUME</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>

	<span class="cm">/* CD/DVD data reading */</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_READ_CD</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_READ_CD_MSF</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_READ_DISC_INFO</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_READ_CDVD_CAPACITY</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_READ_DVD_STRUCTURE</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_READ_HEADER</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_READ_TRACK_RZONE_INFO</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_READ_SUBCHANNEL</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_READ_TOC_PMA_ATIP</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_REPORT_KEY</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_SCAN</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_GET_CONFIGURATION</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_READ_FORMAT_CAPACITIES</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_GET_EVENT_STATUS_NOTIFICATION</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_GET_PERFORMANCE</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_SEEK</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_STOP_PLAY_SCAN</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">);</span>

	<span class="cm">/* Basic writing commands */</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">WRITE_6</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">write_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">WRITE_10</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">write_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">WRITE_VERIFY</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">write_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">WRITE_12</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">write_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">WRITE_VERIFY_12</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">write_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">WRITE_16</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">write_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">WRITE_LONG</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">write_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">WRITE_LONG_2</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">write_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">ERASE</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">write_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_MODE_SELECT_10</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">write_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">MODE_SELECT</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">write_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">LOG_SELECT</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">write_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_BLANK</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">write_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_CLOSE_TRACK</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">write_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_FLUSH_CACHE</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">write_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_FORMAT_UNIT</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">write_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_REPAIR_RZONE_TRACK</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">write_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_RESERVE_RZONE_TRACK</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">write_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_SEND_DVD_STRUCTURE</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">write_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_SEND_EVENT</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">write_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_SEND_KEY</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">write_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_SEND_OPC</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">write_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_SEND_CUE_SHEET</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">write_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_SET_SPEED</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">write_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_PREVENT_ALLOW_MEDIUM_REMOVAL</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">write_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_LOAD_UNLOAD</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">write_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_SET_STREAMING</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">write_ok</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">GPCMD_SET_READ_AHEAD</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">write_ok</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">blk_verify_command</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">has_write_perm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">blk_cmd_filter</span> <span class="o">*</span><span class="n">filter</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">blk_default_cmd_filter</span><span class="p">;</span>

	<span class="cm">/* root can do any command. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_RAWIO</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* if there&#39;s no filter set, assume we&#39;re filtering everything out */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">filter</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="cm">/* Anybody who can open the device can do a read-safe command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">read_ok</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Write-safe commands require a writable open */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">write_ok</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">has_write_perm</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">blk_verify_command</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">blk_fill_sghdr_rq</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">sg_io_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">cmdp</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blk_verify_command</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * fill in request structure</span>
<span class="cm">	 */</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">;</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">=</span> <span class="n">REQ_TYPE_BLOCK_PC</span><span class="p">;</span>

	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">)</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">sg_timeout</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">)</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">BLK_DEFAULT_SG_TIMEOUT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="n">BLK_MIN_SG_TIMEOUT</span><span class="p">)</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">BLK_MIN_SG_TIMEOUT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">blk_complete_sghdr_rq</span><span class="p">(</span><span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sg_io_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * fill in all the output members</span>
<span class="cm">	 */</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">masked_status</span> <span class="o">=</span> <span class="n">status_byte</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">msg_status</span> <span class="o">=</span> <span class="n">msg_byte</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">host_status</span> <span class="o">=</span> <span class="n">host_byte</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">driver_status</span> <span class="o">=</span> <span class="n">driver_byte</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">masked_status</span> <span class="o">||</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">host_status</span> <span class="o">||</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">driver_status</span><span class="p">)</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">|=</span> <span class="n">SG_INFO_CHECK</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">resid</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">resid_len</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sb_len_wr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">sense_len</span> <span class="o">&amp;&amp;</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sbp</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">mx_sb_len</span><span class="p">,</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">sense_len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sbp</span><span class="p">,</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
			<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">sb_len_wr</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">blk_rq_unmap_user</span><span class="p">(</span><span class="n">bio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">blk_put_request</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sg_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">bd_disk</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">sg_io_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_time</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">writing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">sense</span><span class="p">[</span><span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">interface_id</span> <span class="o">!=</span> <span class="sc">&#39;S&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">&gt;</span> <span class="n">BLK_MAX_CDB</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">dxfer_len</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">queue_max_hw_sectors</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">dxfer_len</span><span class="p">)</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">dxfer_direction</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SG_DXFER_TO_DEV</span>:
			<span class="n">writing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SG_DXFER_TO_FROM_DEV</span>:
		<span class="k">case</span> <span class="n">SG_DXFER_FROM_DEV</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="n">rq</span> <span class="o">=</span> <span class="n">blk_get_request</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">writing</span> <span class="o">?</span> <span class="n">WRITE</span> <span class="o">:</span> <span class="n">READ</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rq</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">blk_fill_sghdr_rq</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">rq</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">blk_put_request</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">iovec_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sg_iovec</span><span class="p">)</span> <span class="o">*</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">iovec_count</span><span class="p">;</span>
		<span class="kt">size_t</span> <span class="n">iov_data_len</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sg_iovec</span> <span class="o">*</span><span class="n">sg_iov</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="n">iov</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">sg_iov</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sg_iov</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">sg_iov</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">dxferp</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">sg_iov</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Sum up the vecs, making sure they don&#39;t overflow</span>
<span class="cm">		 */</span>
		<span class="n">iov</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="p">)</span> <span class="n">sg_iov</span><span class="p">;</span>
		<span class="n">iov_data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">iovec_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">iov_data_len</span> <span class="o">+</span> <span class="n">iov</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">&lt;</span> <span class="n">iov_data_len</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">sg_iov</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">iov_data_len</span> <span class="o">+=</span> <span class="n">iov</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_len</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* SG_IO howto says that the shorter of the two wins */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">dxfer_len</span> <span class="o">&lt;</span> <span class="n">iov_data_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">iovec_count</span> <span class="o">=</span> <span class="n">iov_shorten</span><span class="p">(</span><span class="n">iov</span><span class="p">,</span>
						       <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">iovec_count</span><span class="p">,</span>
						       <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">dxfer_len</span><span class="p">);</span>
			<span class="n">iov_data_len</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">dxfer_len</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">blk_rq_map_user_iov</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">rq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">sg_iov</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">iovec_count</span><span class="p">,</span>
					  <span class="n">iov_data_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sg_iov</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">dxfer_len</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">blk_rq_map_user</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">rq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">dxferp</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">dxfer_len</span><span class="p">,</span>
				      <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">bio</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">sense</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sense</span><span class="p">));</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">sense</span> <span class="o">=</span> <span class="n">sense</span><span class="p">;</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">sense_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">start_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="cm">/* ignore return value. All information is passed back to caller</span>
<span class="cm">	 * (if he doesn&#39;t check that is his problem).</span>
<span class="cm">	 * N.B. a non-zero SCSI status is _not_ necessarily an error.</span>
<span class="cm">	 */</span>
	<span class="n">blk_execute_rq</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">bd_disk</span><span class="p">,</span> <span class="n">rq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">duration</span> <span class="o">=</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">blk_complete_sghdr_rq</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">bio</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">blk_put_request</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sg_scsi_ioctl  --  handle deprecated SCSI_IOCTL_SEND_COMMAND ioctl</span>
<span class="cm"> * @file:	file this ioctl operates on (optional)</span>
<span class="cm"> * @q:		request queue to send scsi commands down</span>
<span class="cm"> * @disk:	gendisk to operate on (option)</span>
<span class="cm"> * @sic:	userspace structure describing the command to perform</span>
<span class="cm"> *</span>
<span class="cm"> * Send down the scsi command described by @sic to the device below</span>
<span class="cm"> * the request queue @q.  If @file is non-NULL it&#39;s used to perform</span>
<span class="cm"> * fine-grained permission checks that allow users to send down</span>
<span class="cm"> * non-destructive SCSI commands.  If the caller has a struct gendisk</span>
<span class="cm"> * available it should be passed in as @disk to allow the low level</span>
<span class="cm"> * driver to use the information contained in it.  A non-NULL @disk</span>
<span class="cm"> * is only allowed if the caller knows that the low level driver doesn&#39;t</span>
<span class="cm"> * need it (e.g. in the scsi subsystem).</span>
<span class="cm"> *</span>
<span class="cm"> * Notes:</span>
<span class="cm"> *   -  This interface is deprecated - users should use the SG_IO</span>
<span class="cm"> *      interface instead, as this is a more flexible approach to</span>
<span class="cm"> *      performing SCSI commands on a device.</span>
<span class="cm"> *   -  The SCSI command length is determined by examining the 1st byte</span>
<span class="cm"> *      of the given command. There is no way to override this.</span>
<span class="cm"> *   -  Data transfers are limited to PAGE_SIZE</span>
<span class="cm"> *   -  The length (x + y) must be at least OMAX_SB_LEN bytes long to</span>
<span class="cm"> *      accommodate the sense buffer when an error occurs.</span>
<span class="cm"> *      The sense buffer is truncated to OMAX_SB_LEN (16) bytes so that</span>
<span class="cm"> *      old code will not be surprised.</span>
<span class="cm"> *   -  If a Unix error occurs (e.g. ENOMEM) then the user will receive</span>
<span class="cm"> *      a negative return and the Unix error code in &#39;errno&#39;.</span>
<span class="cm"> *      If the SCSI command succeeds then 0 is returned.</span>
<span class="cm"> *      Positive numbers returned are the compacted SCSI error codes (4</span>
<span class="cm"> *      bytes in one int) where the lowest byte is the SCSI status.</span>
<span class="cm"> */</span>
<span class="cp">#define OMAX_SB_LEN 16          </span><span class="cm">/* For backward compatibility */</span><span class="cp"></span>
<span class="kt">int</span> <span class="nf">sg_scsi_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">scsi_ioctl_command</span> <span class="n">__user</span> <span class="o">*</span><span class="n">sic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">in_len</span><span class="p">,</span> <span class="n">out_len</span><span class="p">,</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">cmdlen</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">sense</span><span class="p">[</span><span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sic</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * get in an out lengths, verify they don&#39;t exceed a page worth of data</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">in_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sic</span><span class="o">-&gt;</span><span class="n">inlen</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">out_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sic</span><span class="o">-&gt;</span><span class="n">outlen</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_len</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span> <span class="o">||</span> <span class="n">out_len</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">opcode</span><span class="p">,</span> <span class="n">sic</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">bytes</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">in_len</span><span class="p">,</span> <span class="n">out_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buffer</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">bounce_gfp</span> <span class="o">|</span> <span class="n">GFP_USER</span><span class="o">|</span> <span class="n">__GFP_NOWARN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="n">rq</span> <span class="o">=</span> <span class="n">blk_get_request</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">in_len</span> <span class="o">?</span> <span class="n">WRITE</span> <span class="o">:</span> <span class="n">READ</span><span class="p">,</span> <span class="n">__GFP_WAIT</span><span class="p">);</span>

	<span class="n">cmdlen</span> <span class="o">=</span> <span class="n">COMMAND_SIZE</span><span class="p">(</span><span class="n">opcode</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * get command and data to send to device, if any</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="n">cmdlen</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">sic</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">cmdlen</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in_len</span> <span class="o">&amp;&amp;</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">sic</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">cmdlen</span><span class="p">,</span> <span class="n">in_len</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">blk_verify_command</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* default.  possible overriden later */</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SEND_DIAGNOSTIC</span>:
	<span class="k">case</span> <span class="n">FORMAT_UNIT</span>:
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">FORMAT_UNIT_TIMEOUT</span><span class="p">;</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">START_STOP</span>:
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">START_STOP_TIMEOUT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MOVE_MEDIUM</span>:
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">MOVE_MEDIUM_TIMEOUT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READ_ELEMENT_STATUS</span>:
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">READ_ELEMENT_STATUS_TIMEOUT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READ_DEFECT_DATA</span>:
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">READ_DEFECT_DATA_TIMEOUT</span><span class="p">;</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">BLK_DEFAULT_SG_TIMEOUT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&amp;&amp;</span> <span class="n">blk_rq_map_kern</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">rq</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">__GFP_WAIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">DRIVER_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">sense</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sense</span><span class="p">));</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">sense</span> <span class="o">=</span> <span class="n">sense</span><span class="p">;</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">sense_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">=</span> <span class="n">REQ_TYPE_BLOCK_PC</span><span class="p">;</span>

	<span class="n">blk_execute_rq</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">disk</span><span class="p">,</span> <span class="n">rq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>	<span class="cm">/* only 8 bit SCSI status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">sense_len</span> <span class="o">&amp;&amp;</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">OMAX_SB_LEN</span> <span class="o">&gt;</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">sense_len</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">rq</span><span class="o">-&gt;</span><span class="n">sense_len</span> <span class="o">:</span> <span class="n">OMAX_SB_LEN</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">sic</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">,</span> <span class="n">bytes</span><span class="p">))</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">sic</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">out_len</span><span class="p">))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	
<span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
	<span class="n">blk_put_request</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">sg_scsi_ioctl</span><span class="p">);</span>

<span class="cm">/* Send basic block requests */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__blk_send_generic</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">bd_disk</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">rq</span> <span class="o">=</span> <span class="n">blk_get_request</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">WRITE</span><span class="p">,</span> <span class="n">__GFP_WAIT</span><span class="p">);</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">=</span> <span class="n">REQ_TYPE_BLOCK_PC</span><span class="p">;</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">BLK_DEFAULT_SG_TIMEOUT</span><span class="p">;</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">blk_execute_rq</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">bd_disk</span><span class="p">,</span> <span class="n">rq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">blk_put_request</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">blk_send_start_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">bd_disk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__blk_send_generic</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">bd_disk</span><span class="p">,</span> <span class="n">GPCMD_START_STOP_UNIT</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">scsi_cmd_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">bd_disk</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">,</span>
		   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * new sgv3 interface</span>
<span class="cm">		 */</span>
		<span class="k">case</span> <span class="n">SG_GET_VERSION_NUM</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">sg_get_version</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SCSI_IOCTL_GET_IDLUN</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">scsi_get_idlun</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SCSI_IOCTL_GET_BUS_NUMBER</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">scsi_get_bus</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SG_SET_TIMEOUT</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">sg_set_timeout</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SG_GET_TIMEOUT</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">sg_get_timeout</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SG_GET_RESERVED_SIZE</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">sg_get_reserved_size</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SG_SET_RESERVED_SIZE</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">sg_set_reserved_size</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SG_EMULATED_HOST</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">sg_emulated_host</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SG_IO</span>: <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sg_io_hdr</span> <span class="n">hdr</span><span class="p">;</span>

			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdr</span><span class="p">)))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">sg_io</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">bd_disk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdr</span><span class="p">)))</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">CDROM_SEND_PACKET</span>: <span class="p">{</span>
			<span class="k">struct</span> <span class="n">cdrom_generic_command</span> <span class="n">cgc</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">sg_io_hdr</span> <span class="n">hdr</span><span class="p">;</span>

			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cgc</span><span class="p">)))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">cgc</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">clock_t_to_jiffies</span><span class="p">(</span><span class="n">cgc</span><span class="p">.</span><span class="n">timeout</span><span class="p">);</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdr</span><span class="p">));</span>
			<span class="n">hdr</span><span class="p">.</span><span class="n">interface_id</span> <span class="o">=</span> <span class="sc">&#39;S&#39;</span><span class="p">;</span>
			<span class="n">hdr</span><span class="p">.</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">);</span>
			<span class="n">hdr</span><span class="p">.</span><span class="n">dxfer_len</span> <span class="o">=</span> <span class="n">cgc</span><span class="p">.</span><span class="n">buflen</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">cgc</span><span class="p">.</span><span class="n">data_direction</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">CGC_DATA_UNKNOWN</span>:
					<span class="n">hdr</span><span class="p">.</span><span class="n">dxfer_direction</span> <span class="o">=</span> <span class="n">SG_DXFER_UNKNOWN</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">CGC_DATA_WRITE</span>:
					<span class="n">hdr</span><span class="p">.</span><span class="n">dxfer_direction</span> <span class="o">=</span> <span class="n">SG_DXFER_TO_DEV</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">CGC_DATA_READ</span>:
					<span class="n">hdr</span><span class="p">.</span><span class="n">dxfer_direction</span> <span class="o">=</span> <span class="n">SG_DXFER_FROM_DEV</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">CGC_DATA_NONE</span>:
					<span class="n">hdr</span><span class="p">.</span><span class="n">dxfer_direction</span> <span class="o">=</span> <span class="n">SG_DXFER_NONE</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">hdr</span><span class="p">.</span><span class="n">dxferp</span> <span class="o">=</span> <span class="n">cgc</span><span class="p">.</span><span class="n">buffer</span><span class="p">;</span>
			<span class="n">hdr</span><span class="p">.</span><span class="n">sbp</span> <span class="o">=</span> <span class="n">cgc</span><span class="p">.</span><span class="n">sense</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">sbp</span><span class="p">)</span>
				<span class="n">hdr</span><span class="p">.</span><span class="n">mx_sb_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_sense</span><span class="p">);</span>
			<span class="n">hdr</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">cgc</span><span class="p">.</span><span class="n">timeout</span><span class="p">);</span>
			<span class="n">hdr</span><span class="p">.</span><span class="n">cmdp</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">cdrom_generic_command</span> <span class="n">__user</span><span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
			<span class="n">hdr</span><span class="p">.</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">);</span>

			<span class="n">err</span> <span class="o">=</span> <span class="n">sg_io</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">bd_disk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

			<span class="n">cgc</span><span class="p">.</span><span class="n">stat</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">cgc</span><span class="p">.</span><span class="n">buflen</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">.</span><span class="n">resid</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cgc</span><span class="p">)))</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * old junk scsi send command ioctl</span>
<span class="cm">		 */</span>
		<span class="k">case</span> <span class="n">SCSI_IOCTL_SEND_COMMAND</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;program %s is using a deprecated SCSI ioctl, please convert it to SG_IO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">err</span> <span class="o">=</span> <span class="n">sg_scsi_ioctl</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">bd_disk</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CDROMCLOSETRAY</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">blk_send_start_stop</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">bd_disk</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CDROMEJECT</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">blk_send_start_stop</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">bd_disk</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">scsi_cmd_ioctl</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">scsi_verify_blk_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bd</span> <span class="o">&amp;&amp;</span> <span class="n">bd</span> <span class="o">==</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_contains</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Actually none of these is particularly useful on a partition,</span>
<span class="cm">	 * but they are safe.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCSI_IOCTL_GET_IDLUN</span>:
	<span class="k">case</span> <span class="n">SCSI_IOCTL_GET_BUS_NUMBER</span>:
	<span class="k">case</span> <span class="n">SCSI_IOCTL_GET_PCI</span>:
	<span class="k">case</span> <span class="n">SCSI_IOCTL_PROBE_HOST</span>:
	<span class="k">case</span> <span class="n">SG_GET_VERSION_NUM</span>:
	<span class="k">case</span> <span class="n">SG_SET_TIMEOUT</span>:
	<span class="k">case</span> <span class="n">SG_GET_TIMEOUT</span>:
	<span class="k">case</span> <span class="n">SG_GET_RESERVED_SIZE</span>:
	<span class="k">case</span> <span class="n">SG_SET_RESERVED_SIZE</span>:
	<span class="k">case</span> <span class="n">SG_EMULATED_HOST</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CDROM_GET_CAPABILITY</span>:
		<span class="cm">/* Keep this until we remove the printk below.  udev sends it</span>
<span class="cm">		 * and we do not want to spam dmesg about it.   CD-ROMs do</span>
<span class="cm">		 * not have partitions, so we get here only for disks.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_RAWIO</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* In particular, rule out all resets and host-specific ioctls.  */</span>
	<span class="n">printk_ratelimited</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			   <span class="s">&quot;%s: sending ioctl %x to a partition!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">scsi_verify_blk_ioctl</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">scsi_cmd_blk_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bd</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">scsi_verify_blk_ioctl</span><span class="p">(</span><span class="n">bd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">scsi_cmd_ioctl</span><span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">scsi_cmd_blk_ioctl</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">blk_scsi_ioctl_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">blk_set_cmd_filter_defaults</span><span class="p">(</span><span class="o">&amp;</span><span class="n">blk_default_cmd_filter</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">fs_initcall</span><span class="p">(</span><span class="n">blk_scsi_ioctl_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:1}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../javascript/docco.min.js"></script>
</html>
