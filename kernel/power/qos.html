<!DOCTYPE html>
<html><head><title>joekychen/linux » kernel › power › qos.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>qos.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This module exposes the interface to kernel space for specifying</span>
<span class="cm"> * QoS dependencies.  It provides infrastructure for registration of:</span>
<span class="cm"> *</span>
<span class="cm"> * Dependents on a QoS value : register requests</span>
<span class="cm"> * Watchers of QoS value : get notified when target QoS value changes</span>
<span class="cm"> *</span>
<span class="cm"> * This QoS design is best effort based.  Dependents register their QoS needs.</span>
<span class="cm"> * Watchers register to keep track of the current QoS needs of the system.</span>
<span class="cm"> *</span>
<span class="cm"> * There are 3 basic classes of QoS parameter: latency, timeout, throughput</span>
<span class="cm"> * each have defined units:</span>
<span class="cm"> * latency: usec</span>
<span class="cm"> * timeout: usec &lt;-- currently not used.</span>
<span class="cm"> * throughput: kbs (kilo byte / sec)</span>
<span class="cm"> *</span>
<span class="cm"> * There are lists of pm_qos_objects each one wrapping requests, notifiers</span>
<span class="cm"> *</span>
<span class="cm"> * User mode requests on a QOS parameter register themselves to the</span>
<span class="cm"> * subsystem by opening the device node /dev/... and writing there request to</span>
<span class="cm"> * the node.  As long as the process holds a file handle open to the node the</span>
<span class="cm"> * client continues to be accounted for.  Upon file release the usermode</span>
<span class="cm"> * request is removed and a new qos target is computed.  This way when the</span>
<span class="cm"> * request that the application has is cleaned up when closes the file</span>
<span class="cm"> * pointer or exits the pm_qos_object will get an opportunity to clean up.</span>
<span class="cm"> *</span>
<span class="cm"> * Mark Gross &lt;mgross@linux.intel.com&gt;</span>
<span class="cm"> */</span>

<span class="cm">/*#define DEBUG*/</span>

<span class="cp">#include &lt;linux/pm_qos.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/miscdevice.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>

<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * locking rule: all changes to constraints or notifiers lists</span>
<span class="cm"> * or pm_qos_object list and pm_qos_objects need to happen with pm_qos_lock</span>
<span class="cm"> * held, taken with _irqsave.  One lock to rule them all</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">pm_qos_object</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">pm_qos_constraints</span> <span class="o">*</span><span class="n">constraints</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">miscdevice</span> <span class="n">pm_qos_power_miscdev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">pm_qos_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pm_qos_object</span> <span class="n">null_pm_qos</span><span class="p">;</span>

<span class="k">static</span> <span class="n">BLOCKING_NOTIFIER_HEAD</span><span class="p">(</span><span class="n">cpu_dma_lat_notifier</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pm_qos_constraints</span> <span class="n">cpu_dma_constraints</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">PLIST_HEAD_INIT</span><span class="p">(</span><span class="n">cpu_dma_constraints</span><span class="p">.</span><span class="n">list</span><span class="p">),</span>
	<span class="p">.</span><span class="n">target_value</span> <span class="o">=</span> <span class="n">PM_QOS_CPU_DMA_LAT_DEFAULT_VALUE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">PM_QOS_CPU_DMA_LAT_DEFAULT_VALUE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PM_QOS_MIN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">notifiers</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cpu_dma_lat_notifier</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pm_qos_object</span> <span class="n">cpu_dma_pm_qos</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cpu_dma_constraints</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cpu_dma_latency&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">BLOCKING_NOTIFIER_HEAD</span><span class="p">(</span><span class="n">network_lat_notifier</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pm_qos_constraints</span> <span class="n">network_lat_constraints</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">PLIST_HEAD_INIT</span><span class="p">(</span><span class="n">network_lat_constraints</span><span class="p">.</span><span class="n">list</span><span class="p">),</span>
	<span class="p">.</span><span class="n">target_value</span> <span class="o">=</span> <span class="n">PM_QOS_NETWORK_LAT_DEFAULT_VALUE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">PM_QOS_NETWORK_LAT_DEFAULT_VALUE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PM_QOS_MIN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">notifiers</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">network_lat_notifier</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pm_qos_object</span> <span class="n">network_lat_pm_qos</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">network_lat_constraints</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;network_latency&quot;</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="n">BLOCKING_NOTIFIER_HEAD</span><span class="p">(</span><span class="n">network_throughput_notifier</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pm_qos_constraints</span> <span class="n">network_tput_constraints</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">PLIST_HEAD_INIT</span><span class="p">(</span><span class="n">network_tput_constraints</span><span class="p">.</span><span class="n">list</span><span class="p">),</span>
	<span class="p">.</span><span class="n">target_value</span> <span class="o">=</span> <span class="n">PM_QOS_NETWORK_THROUGHPUT_DEFAULT_VALUE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">PM_QOS_NETWORK_THROUGHPUT_DEFAULT_VALUE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PM_QOS_MAX</span><span class="p">,</span>
	<span class="p">.</span><span class="n">notifiers</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">network_throughput_notifier</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pm_qos_object</span> <span class="n">network_throughput_pm_qos</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">network_tput_constraints</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;network_throughput&quot;</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">pm_qos_object</span> <span class="o">*</span><span class="n">pm_qos_array</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">null_pm_qos</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">cpu_dma_pm_qos</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">network_lat_pm_qos</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">network_throughput_pm_qos</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">pm_qos_power_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">f_pos</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">pm_qos_power_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">f_pos</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pm_qos_power_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pm_qos_power_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">pm_qos_power_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">pm_qos_power_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">pm_qos_power_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">pm_qos_power_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">pm_qos_power_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">noop_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* unlocked internal variant */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">pm_qos_get_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm_qos_constraints</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plist_head_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">default_value</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PM_QOS_MIN</span>:
		<span class="k">return</span> <span class="n">plist_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PM_QOS_MAX</span>:
		<span class="k">return</span> <span class="n">plist_last</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* runtime check for not using enum */</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">s32</span> <span class="nf">pm_qos_read_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm_qos_constraints</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">target_value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pm_qos_set_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm_qos_constraints</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">s32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">target_value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_qos_update_target - manages the constraints list and calls the notifiers</span>
<span class="cm"> *  if needed</span>
<span class="cm"> * @c: constraints data struct</span>
<span class="cm"> * @node: request to add to the list, to update or to remove</span>
<span class="cm"> * @action: action to take on the constraints list</span>
<span class="cm"> * @value: value of the request to add or update</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns 1 if the aggregated constraint value has changed, 0</span>
<span class="cm"> *  otherwise.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pm_qos_update_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm_qos_constraints</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">plist_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span>
			 <span class="k">enum</span> <span class="n">pm_qos_req_action</span> <span class="n">action</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">prev_value</span><span class="p">,</span> <span class="n">curr_value</span><span class="p">,</span> <span class="n">new_value</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm_qos_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">prev_value</span> <span class="o">=</span> <span class="n">pm_qos_get_value</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="n">PM_QOS_DEFAULT_VALUE</span><span class="p">)</span>
		<span class="n">new_value</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">default_value</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">new_value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PM_QOS_REMOVE_REQ</span>:
		<span class="n">plist_del</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PM_QOS_UPDATE_REQ</span>:
		<span class="cm">/*</span>
<span class="cm">		 * to change the list, we atomically remove, reinit</span>
<span class="cm">		 * with new value and add, then see if the extremal</span>
<span class="cm">		 * changed</span>
<span class="cm">		 */</span>
		<span class="n">plist_del</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">PM_QOS_ADD_REQ</span>:
		<span class="n">plist_node_init</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">new_value</span><span class="p">);</span>
		<span class="n">plist_add</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* no action */</span>
		<span class="p">;</span>
	<span class="p">}</span>

	<span class="n">curr_value</span> <span class="o">=</span> <span class="n">pm_qos_get_value</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="n">pm_qos_set_value</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">curr_value</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm_qos_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prev_value</span> <span class="o">!=</span> <span class="n">curr_value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">blocking_notifier_call_chain</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">notifiers</span><span class="p">,</span>
					     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">curr_value</span><span class="p">,</span>
					     <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_qos_request - returns current system wide qos expectation</span>
<span class="cm"> * @pm_qos_class: identification of which qos value is requested</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns the current target value.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pm_qos_request</span><span class="p">(</span><span class="kt">int</span> <span class="n">pm_qos_class</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pm_qos_read_value</span><span class="p">(</span><span class="n">pm_qos_array</span><span class="p">[</span><span class="n">pm_qos_class</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pm_qos_request</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">pm_qos_request_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm_qos_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">pm_qos_class</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pm_qos_request_active</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * pm_qos_work_fn - the timeout handler of pm_qos_update_request_timeout</span>
<span class="cm"> * @work: work struct for the delayed work (timeout)</span>
<span class="cm"> *</span>
<span class="cm"> * This cancels the timeout request by falling back to the default at timeout.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pm_qos_work_fn</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pm_qos_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">to_delayed_work</span><span class="p">(</span><span class="n">work</span><span class="p">),</span>
						  <span class="k">struct</span> <span class="n">pm_qos_request</span><span class="p">,</span>
						  <span class="n">work</span><span class="p">);</span>

	<span class="n">pm_qos_update_request</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">PM_QOS_DEFAULT_VALUE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_qos_add_request - inserts new qos request into the list</span>
<span class="cm"> * @req: pointer to a preallocated handle</span>
<span class="cm"> * @pm_qos_class: identifies which list of qos request to use</span>
<span class="cm"> * @value: defines the qos request</span>
<span class="cm"> *</span>
<span class="cm"> * This function inserts a new entry in the pm_qos_class list of requested qos</span>
<span class="cm"> * performance characteristics.  It recomputes the aggregate QoS expectations</span>
<span class="cm"> * for the pm_qos_class of parameters and initializes the pm_qos_request</span>
<span class="cm"> * handle.  Caller needs to save this handle for later use in updates and</span>
<span class="cm"> * removal.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">pm_qos_add_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm_qos_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">pm_qos_class</span><span class="p">,</span> <span class="n">s32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span> <span class="cm">/*guard against callers passing in null */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pm_qos_request_active</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WARN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="s">&quot;pm_qos_add_request() called for already added request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">pm_qos_class</span> <span class="o">=</span> <span class="n">pm_qos_class</span><span class="p">;</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">pm_qos_work_fn</span><span class="p">);</span>
	<span class="n">pm_qos_update_target</span><span class="p">(</span><span class="n">pm_qos_array</span><span class="p">[</span><span class="n">pm_qos_class</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">PM_QOS_ADD_REQ</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pm_qos_add_request</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * pm_qos_update_request - modifies an existing qos request</span>
<span class="cm"> * @req : handle to list element holding a pm_qos request to use</span>
<span class="cm"> * @value: defines the qos request</span>
<span class="cm"> *</span>
<span class="cm"> * Updates an existing qos request for the pm_qos_class of parameters along</span>
<span class="cm"> * with updating the target pm_qos_class value.</span>
<span class="cm"> *</span>
<span class="cm"> * Attempts are made to make this code callable on hot code paths.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pm_qos_update_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm_qos_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
			   <span class="n">s32</span> <span class="n">new_value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span> <span class="cm">/*guard against callers passing in null */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pm_qos_request_active</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WARN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="s">&quot;pm_qos_update_request() called for unknown object</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">delayed_work_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">))</span>
		<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_value</span> <span class="o">!=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">.</span><span class="n">prio</span><span class="p">)</span>
		<span class="n">pm_qos_update_target</span><span class="p">(</span>
			<span class="n">pm_qos_array</span><span class="p">[</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">pm_qos_class</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">PM_QOS_UPDATE_REQ</span><span class="p">,</span> <span class="n">new_value</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pm_qos_update_request</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * pm_qos_update_request_timeout - modifies an existing qos request temporarily.</span>
<span class="cm"> * @req : handle to list element holding a pm_qos request to use</span>
<span class="cm"> * @new_value: defines the temporal qos request</span>
<span class="cm"> * @timeout_us: the effective duration of this qos request in usecs.</span>
<span class="cm"> *</span>
<span class="cm"> * After timeout_us, this qos request is cancelled automatically.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pm_qos_update_request_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm_qos_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="n">s32</span> <span class="n">new_value</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout_us</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN</span><span class="p">(</span><span class="o">!</span><span class="n">pm_qos_request_active</span><span class="p">(</span><span class="n">req</span><span class="p">),</span>
		 <span class="s">&quot;%s called for unknown object.&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">delayed_work_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">))</span>
		<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_value</span> <span class="o">!=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">.</span><span class="n">prio</span><span class="p">)</span>
		<span class="n">pm_qos_update_target</span><span class="p">(</span>
			<span class="n">pm_qos_array</span><span class="p">[</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">pm_qos_class</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">PM_QOS_UPDATE_REQ</span><span class="p">,</span> <span class="n">new_value</span><span class="p">);</span>

	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">usecs_to_jiffies</span><span class="p">(</span><span class="n">timeout_us</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_qos_remove_request - modifies an existing qos request</span>
<span class="cm"> * @req: handle to request list element</span>
<span class="cm"> *</span>
<span class="cm"> * Will remove pm qos request from the list of constraints and</span>
<span class="cm"> * recompute the current target value for the pm_qos_class.  Call this</span>
<span class="cm"> * on slow code paths.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pm_qos_remove_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm_qos_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span> <span class="cm">/*guard against callers passing in null */</span>
		<span class="k">return</span><span class="p">;</span>
		<span class="cm">/* silent return to keep pcm code cleaner */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pm_qos_request_active</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WARN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="s">&quot;pm_qos_remove_request() called for unknown object</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">delayed_work_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">))</span>
		<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>

	<span class="n">pm_qos_update_target</span><span class="p">(</span><span class="n">pm_qos_array</span><span class="p">[</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">pm_qos_class</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">PM_QOS_REMOVE_REQ</span><span class="p">,</span>
			     <span class="n">PM_QOS_DEFAULT_VALUE</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pm_qos_remove_request</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * pm_qos_add_notifier - sets notification entry for changes to target value</span>
<span class="cm"> * @pm_qos_class: identifies which qos target changes should be notified.</span>
<span class="cm"> * @notifier: notifier block managed by caller.</span>
<span class="cm"> *</span>
<span class="cm"> * will register the notifier into a notification chain that gets called</span>
<span class="cm"> * upon changes to the pm_qos_class target value.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pm_qos_add_notifier</span><span class="p">(</span><span class="kt">int</span> <span class="n">pm_qos_class</span><span class="p">,</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">notifier</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">blocking_notifier_chain_register</span><span class="p">(</span>
			<span class="n">pm_qos_array</span><span class="p">[</span><span class="n">pm_qos_class</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">notifiers</span><span class="p">,</span>
			<span class="n">notifier</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pm_qos_add_notifier</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * pm_qos_remove_notifier - deletes notification entry from chain.</span>
<span class="cm"> * @pm_qos_class: identifies which qos target changes are notified.</span>
<span class="cm"> * @notifier: notifier block to be removed.</span>
<span class="cm"> *</span>
<span class="cm"> * will remove the notifier from the notification chain that gets called</span>
<span class="cm"> * upon changes to the pm_qos_class target value.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pm_qos_remove_notifier</span><span class="p">(</span><span class="kt">int</span> <span class="n">pm_qos_class</span><span class="p">,</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">notifier</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">blocking_notifier_chain_unregister</span><span class="p">(</span>
			<span class="n">pm_qos_array</span><span class="p">[</span><span class="n">pm_qos_class</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="o">-&gt;</span><span class="n">notifiers</span><span class="p">,</span>
			<span class="n">notifier</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pm_qos_remove_notifier</span><span class="p">);</span>

<span class="cm">/* User space interface to PM QoS classes via misc devices */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">register_pm_qos_misc</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm_qos_object</span> <span class="o">*</span><span class="n">qos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qos</span><span class="o">-&gt;</span><span class="n">pm_qos_power_miscdev</span><span class="p">.</span><span class="n">minor</span> <span class="o">=</span> <span class="n">MISC_DYNAMIC_MINOR</span><span class="p">;</span>
	<span class="n">qos</span><span class="o">-&gt;</span><span class="n">pm_qos_power_miscdev</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">qos</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">qos</span><span class="o">-&gt;</span><span class="n">pm_qos_power_miscdev</span><span class="p">.</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm_qos_power_fops</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">misc_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qos</span><span class="o">-&gt;</span><span class="n">pm_qos_power_miscdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">find_pm_qos_object_by_minor</span><span class="p">(</span><span class="kt">int</span> <span class="n">minor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pm_qos_class</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pm_qos_class</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pm_qos_class</span> <span class="o">&lt;</span> <span class="n">PM_QOS_NUM_CLASSES</span><span class="p">;</span> <span class="n">pm_qos_class</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">minor</span> <span class="o">==</span>
			<span class="n">pm_qos_array</span><span class="p">[</span><span class="n">pm_qos_class</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">pm_qos_power_miscdev</span><span class="p">.</span><span class="n">minor</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">pm_qos_class</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm_qos_power_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">pm_qos_class</span><span class="p">;</span>

	<span class="n">pm_qos_class</span> <span class="o">=</span> <span class="n">find_pm_qos_object_by_minor</span><span class="p">(</span><span class="n">iminor</span><span class="p">(</span><span class="n">inode</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pm_qos_class</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pm_qos_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">pm_qos_add_request</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">pm_qos_class</span><span class="p">,</span> <span class="n">PM_QOS_DEFAULT_VALUE</span><span class="p">);</span>
		<span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm_qos_power_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pm_qos_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">pm_qos_remove_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">pm_qos_power_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">f_pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm_qos_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pm_qos_request_active</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm_qos_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">pm_qos_get_value</span><span class="p">(</span><span class="n">pm_qos_array</span><span class="p">[</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">pm_qos_class</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">constraints</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm_qos_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">f_pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">s32</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">pm_qos_power_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">f_pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm_qos_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">s32</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">s32</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">11</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* ASCII perhaps? */</span>
		<span class="kt">char</span> <span class="n">ascii_value</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">ulval</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">ascii_value</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ascii_value</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
				<span class="n">ascii_value</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ascii_value</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">strict_strtoul</span><span class="p">(</span><span class="n">ascii_value</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ulval</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s, 0x%lx, 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ascii_value</span><span class="p">,</span> <span class="n">ulval</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">s32</span><span class="p">)</span><span class="n">lower_32_bits</span><span class="p">(</span><span class="n">ulval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">pm_qos_update_request</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pm_qos_power_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pm_qos_array</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PM_QOS_NUM_CLASSES</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PM_QOS_NUM_CLASSES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">register_pm_qos_misc</span><span class="p">(</span><span class="n">pm_qos_array</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;pm_qos_param: %s setup failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">pm_qos_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">late_initcall</span><span class="p">(</span><span class="n">pm_qos_power_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
