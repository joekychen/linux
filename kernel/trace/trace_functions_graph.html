<!DOCTYPE html>
<html><head><title>joekychen/linux » kernel › trace › trace_functions_graph.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>trace_functions_graph.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * Function graph tracer.</span>
<span class="cm"> * Copyright (c) 2008-2009 Frederic Weisbecker &lt;fweisbec@gmail.com&gt;</span>
<span class="cm"> * Mostly borrowed from function tracer which</span>
<span class="cm"> * is Copyright (c) Steven Rostedt &lt;srostedt@redhat.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/ftrace.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>

<span class="cp">#include &quot;trace.h&quot;</span>
<span class="cp">#include &quot;trace_output.h&quot;</span>

<span class="cm">/* When set, irq functions will be ignored */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ftrace_graph_skip_irqs</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">fgraph_cpu_data</span> <span class="p">{</span>
	<span class="n">pid_t</span>		<span class="n">last_pid</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">depth</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">depth_irq</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">ignore</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">enter_funcs</span><span class="p">[</span><span class="n">FTRACE_RETFUNC_DEPTH</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">fgraph_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">fgraph_cpu_data</span> <span class="n">__percpu</span> <span class="o">*</span><span class="n">cpu_data</span><span class="p">;</span>

	<span class="cm">/* Place to preserve last processed entry. */</span>
	<span class="k">struct</span> <span class="n">ftrace_graph_ent_entry</span>	<span class="n">ent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ftrace_graph_ret_entry</span>	<span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">failed</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">cpu</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define TRACE_GRAPH_INDENT	2</span>

<span class="cm">/* Flag options */</span>
<span class="cp">#define TRACE_GRAPH_PRINT_OVERRUN	0x1</span>
<span class="cp">#define TRACE_GRAPH_PRINT_CPU		0x2</span>
<span class="cp">#define TRACE_GRAPH_PRINT_OVERHEAD	0x4</span>
<span class="cp">#define TRACE_GRAPH_PRINT_PROC		0x8</span>
<span class="cp">#define TRACE_GRAPH_PRINT_DURATION	0x10</span>
<span class="cp">#define TRACE_GRAPH_PRINT_ABS_TIME	0x20</span>
<span class="cp">#define TRACE_GRAPH_PRINT_IRQS		0x40</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tracer_opt</span> <span class="n">trace_opts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Display overruns? (for self-debug purpose) */</span>
	<span class="p">{</span> <span class="n">TRACER_OPT</span><span class="p">(</span><span class="n">funcgraph</span><span class="o">-</span><span class="n">overrun</span><span class="p">,</span> <span class="n">TRACE_GRAPH_PRINT_OVERRUN</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Display CPU ? */</span>
	<span class="p">{</span> <span class="n">TRACER_OPT</span><span class="p">(</span><span class="n">funcgraph</span><span class="o">-</span><span class="n">cpu</span><span class="p">,</span> <span class="n">TRACE_GRAPH_PRINT_CPU</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Display Overhead ? */</span>
	<span class="p">{</span> <span class="n">TRACER_OPT</span><span class="p">(</span><span class="n">funcgraph</span><span class="o">-</span><span class="n">overhead</span><span class="p">,</span> <span class="n">TRACE_GRAPH_PRINT_OVERHEAD</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Display proc name/pid */</span>
	<span class="p">{</span> <span class="n">TRACER_OPT</span><span class="p">(</span><span class="n">funcgraph</span><span class="o">-</span><span class="n">proc</span><span class="p">,</span> <span class="n">TRACE_GRAPH_PRINT_PROC</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Display duration of execution */</span>
	<span class="p">{</span> <span class="n">TRACER_OPT</span><span class="p">(</span><span class="n">funcgraph</span><span class="o">-</span><span class="n">duration</span><span class="p">,</span> <span class="n">TRACE_GRAPH_PRINT_DURATION</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Display absolute time of an entry */</span>
	<span class="p">{</span> <span class="n">TRACER_OPT</span><span class="p">(</span><span class="n">funcgraph</span><span class="o">-</span><span class="n">abstime</span><span class="p">,</span> <span class="n">TRACE_GRAPH_PRINT_ABS_TIME</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Display interrupts */</span>
	<span class="p">{</span> <span class="n">TRACER_OPT</span><span class="p">(</span><span class="n">funcgraph</span><span class="o">-</span><span class="n">irqs</span><span class="p">,</span> <span class="n">TRACE_GRAPH_PRINT_IRQS</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span> <span class="cm">/* Empty entry */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tracer_flags</span> <span class="n">tracer_flags</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Don&#39;t display overruns and proc by default */</span>
	<span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">TRACE_GRAPH_PRINT_CPU</span> <span class="o">|</span> <span class="n">TRACE_GRAPH_PRINT_OVERHEAD</span> <span class="o">|</span>
	       <span class="n">TRACE_GRAPH_PRINT_DURATION</span> <span class="o">|</span> <span class="n">TRACE_GRAPH_PRINT_IRQS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">opts</span> <span class="o">=</span> <span class="n">trace_opts</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">trace_array</span> <span class="o">*</span><span class="n">graph_array</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * DURATION column is being also used to display IRQ signs,</span>
<span class="cm"> * following values are used by print_graph_irq and others</span>
<span class="cm"> * to fill in space into DURATION column.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">DURATION_FILL_FULL</span>  <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="n">DURATION_FILL_START</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span>
	<span class="n">DURATION_FILL_END</span>   <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">print_line_t</span>
<span class="n">print_graph_duration</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">duration</span><span class="p">,</span> <span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
		     <span class="n">u32</span> <span class="n">flags</span><span class="p">);</span>

<span class="cm">/* Add a function return address to the trace stack on thread info.*/</span>
<span class="kt">int</span>
<span class="nf">ftrace_push_return_trace</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ret</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">func</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">depth</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">frame_pointer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">calltime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">ret_stack</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We must make sure the ret_stack is tested before we read</span>
<span class="cm">	 * anything else.</span>
<span class="cm">	 */</span>
	<span class="n">smp_rmb</span><span class="p">();</span>

	<span class="cm">/* The return trace stack is full */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">curr_ret_stack</span> <span class="o">==</span> <span class="n">FTRACE_RETFUNC_DEPTH</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">trace_overrun</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">calltime</span> <span class="o">=</span> <span class="n">trace_clock_local</span><span class="p">();</span>

	<span class="n">index</span> <span class="o">=</span> <span class="o">++</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">curr_ret_stack</span><span class="p">;</span>
	<span class="n">barrier</span><span class="p">();</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="n">ret_stack</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="n">ret_stack</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span><span class="p">;</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="n">ret_stack</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">calltime</span> <span class="o">=</span> <span class="n">calltime</span><span class="p">;</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="n">ret_stack</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">subtime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="n">ret_stack</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">fp</span> <span class="o">=</span> <span class="n">frame_pointer</span><span class="p">;</span>
	<span class="o">*</span><span class="n">depth</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Retrieve a function return address to the trace stack on thread info.*/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ftrace_pop_return_trace</span><span class="p">(</span><span class="k">struct</span> <span class="n">ftrace_graph_ret</span> <span class="o">*</span><span class="n">trace</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">ret</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">frame_pointer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">curr_ret_stack</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ftrace_graph_stop</span><span class="p">();</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* Might as well panic, otherwise we have no where to go */</span>
		<span class="o">*</span><span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">panic</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_HAVE_FUNCTION_GRAPH_FP_TEST</span>
	<span class="cm">/*</span>
<span class="cm">	 * The arch may choose to record the frame pointer used</span>
<span class="cm">	 * and check it here to make sure that it is what we expect it</span>
<span class="cm">	 * to be. If gcc does not set the place holder of the return</span>
<span class="cm">	 * address in the frame pointer, and does a copy instead, then</span>
<span class="cm">	 * the function graph trace will fail. This test detects this</span>
<span class="cm">	 * case.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Currently, x86_32 with optimize for size (-Os) makes the latest</span>
<span class="cm">	 * gcc do the above.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">ret_stack</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">fp</span> <span class="o">!=</span> <span class="n">frame_pointer</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ftrace_graph_stop</span><span class="p">();</span>
		<span class="n">WARN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Bad frame pointer: expected %lx, received %lx</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;  from func %ps return to %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">current</span><span class="o">-&gt;</span><span class="n">ret_stack</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">fp</span><span class="p">,</span>
		     <span class="n">frame_pointer</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">ret_stack</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">func</span><span class="p">,</span>
		     <span class="n">current</span><span class="o">-&gt;</span><span class="n">ret_stack</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">ret</span><span class="p">);</span>
		<span class="o">*</span><span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">panic</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="o">*</span><span class="n">ret</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">ret_stack</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">ret</span><span class="p">;</span>
	<span class="n">trace</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">ret_stack</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">func</span><span class="p">;</span>
	<span class="n">trace</span><span class="o">-&gt;</span><span class="n">calltime</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">ret_stack</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">calltime</span><span class="p">;</span>
	<span class="n">trace</span><span class="o">-&gt;</span><span class="n">overrun</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">trace_overrun</span><span class="p">);</span>
	<span class="n">trace</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send the trace to the ring-buffer.</span>
<span class="cm"> * @return the original return address.</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">ftrace_return_to_handler</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">frame_pointer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ftrace_graph_ret</span> <span class="n">trace</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ftrace_pop_return_trace</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trace</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">,</span> <span class="n">frame_pointer</span><span class="p">);</span>
	<span class="n">trace</span><span class="p">.</span><span class="n">rettime</span> <span class="o">=</span> <span class="n">trace_clock_local</span><span class="p">();</span>
	<span class="n">ftrace_graph_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trace</span><span class="p">);</span>
	<span class="n">barrier</span><span class="p">();</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="n">curr_ret_stack</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ftrace_graph_stop</span><span class="p">();</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* Might as well panic. What else to do? */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">panic</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">__trace_graph_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_array</span> <span class="o">*</span><span class="n">tr</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ftrace_graph_ent</span> <span class="o">*</span><span class="n">trace</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">pc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ftrace_event_call</span> <span class="o">*</span><span class="n">call</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event_funcgraph_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ring_buffer_event</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ring_buffer</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ftrace_graph_ent_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">__this_cpu_read</span><span class="p">(</span><span class="n">ftrace_cpu_disabled</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">event</span> <span class="o">=</span> <span class="n">trace_buffer_lock_reserve</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">TRACE_GRAPH_ENT</span><span class="p">,</span>
					  <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">entry</span><span class="p">),</span> <span class="n">flags</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">event</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">entry</span>	<span class="o">=</span> <span class="n">ring_buffer_event_data</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">graph_ent</span>			<span class="o">=</span> <span class="o">*</span><span class="n">trace</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">filter_current_check_discard</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">event</span><span class="p">))</span>
		<span class="n">ring_buffer_unlock_commit</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ftrace_graph_ignore_irqs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ftrace_graph_skip_irqs</span> <span class="o">||</span> <span class="n">trace_recursion_test</span><span class="p">(</span><span class="n">TRACE_IRQ_BIT</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">in_irq</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">trace_graph_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">ftrace_graph_ent</span> <span class="o">*</span><span class="n">trace</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">trace_array</span> <span class="o">*</span><span class="n">tr</span> <span class="o">=</span> <span class="n">graph_array</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">trace_array_cpu</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">disabled</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ftrace_trace_task</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* trace it when it is-nested-in or is a function enabled. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">trace</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">||</span> <span class="n">ftrace_graph_addr</span><span class="p">(</span><span class="n">trace</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">))</span> <span class="o">||</span>
	      <span class="n">ftrace_graph_ignore_irqs</span><span class="p">())</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">cpu</span> <span class="o">=</span> <span class="n">raw_smp_processor_id</span><span class="p">();</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">cpu</span><span class="p">];</span>
	<span class="n">disabled</span> <span class="o">=</span> <span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">disabled</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">disabled</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pc</span> <span class="o">=</span> <span class="n">preempt_count</span><span class="p">();</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">__trace_graph_entry</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">disabled</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">trace_graph_thresh_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">ftrace_graph_ent</span> <span class="o">*</span><span class="n">trace</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tracing_thresh</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">trace_graph_entry</span><span class="p">(</span><span class="n">trace</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">__trace_graph_function</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_array</span> <span class="o">*</span><span class="n">tr</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">time</span> <span class="o">=</span> <span class="n">trace_clock_local</span><span class="p">();</span>
	<span class="k">struct</span> <span class="n">ftrace_graph_ent</span> <span class="n">ent</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">func</span>  <span class="o">=</span> <span class="n">ip</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">ftrace_graph_ret</span> <span class="n">ret</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">func</span>     <span class="o">=</span> <span class="n">ip</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">calltime</span> <span class="o">=</span> <span class="n">time</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rettime</span>  <span class="o">=</span> <span class="n">time</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">__trace_graph_entry</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ent</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
	<span class="n">__trace_graph_return</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">trace_graph_function</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_array</span> <span class="o">*</span><span class="n">tr</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">parent_ip</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__trace_graph_function</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">__trace_graph_return</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_array</span> <span class="o">*</span><span class="n">tr</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ftrace_graph_ret</span> <span class="o">*</span><span class="n">trace</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">pc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ftrace_event_call</span> <span class="o">*</span><span class="n">call</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event_funcgraph_exit</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ring_buffer_event</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ring_buffer</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ftrace_graph_ret_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">__this_cpu_read</span><span class="p">(</span><span class="n">ftrace_cpu_disabled</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">event</span> <span class="o">=</span> <span class="n">trace_buffer_lock_reserve</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">TRACE_GRAPH_RET</span><span class="p">,</span>
					  <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">entry</span><span class="p">),</span> <span class="n">flags</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">event</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">entry</span>	<span class="o">=</span> <span class="n">ring_buffer_event_data</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">ret</span>				<span class="o">=</span> <span class="o">*</span><span class="n">trace</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">filter_current_check_discard</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">event</span><span class="p">))</span>
		<span class="n">ring_buffer_unlock_commit</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">trace_graph_return</span><span class="p">(</span><span class="k">struct</span> <span class="n">ftrace_graph_ret</span> <span class="o">*</span><span class="n">trace</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">trace_array</span> <span class="o">*</span><span class="n">tr</span> <span class="o">=</span> <span class="n">graph_array</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">trace_array_cpu</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">disabled</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pc</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">cpu</span> <span class="o">=</span> <span class="n">raw_smp_processor_id</span><span class="p">();</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">cpu</span><span class="p">];</span>
	<span class="n">disabled</span> <span class="o">=</span> <span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">disabled</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">disabled</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pc</span> <span class="o">=</span> <span class="n">preempt_count</span><span class="p">();</span>
		<span class="n">__trace_graph_return</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">disabled</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">set_graph_array</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_array</span> <span class="o">*</span><span class="n">tr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">graph_array</span> <span class="o">=</span> <span class="n">tr</span><span class="p">;</span>

	<span class="cm">/* Make graph_array visible before we start tracing */</span>

	<span class="n">smp_mb</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">trace_graph_thresh_return</span><span class="p">(</span><span class="k">struct</span> <span class="n">ftrace_graph_ret</span> <span class="o">*</span><span class="n">trace</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tracing_thresh</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">trace</span><span class="o">-&gt;</span><span class="n">rettime</span> <span class="o">-</span> <span class="n">trace</span><span class="o">-&gt;</span><span class="n">calltime</span> <span class="o">&lt;</span> <span class="n">tracing_thresh</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">trace_graph_return</span><span class="p">(</span><span class="n">trace</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">graph_trace_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_array</span> <span class="o">*</span><span class="n">tr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">set_graph_array</span><span class="p">(</span><span class="n">tr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tracing_thresh</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">register_ftrace_graph</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trace_graph_thresh_return</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">trace_graph_thresh_entry</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">register_ftrace_graph</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trace_graph_return</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">trace_graph_entry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">tracing_start_cmdline_record</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">graph_trace_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_array</span> <span class="o">*</span><span class="n">tr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tracing_stop_cmdline_record</span><span class="p">();</span>
	<span class="n">unregister_ftrace_graph</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">max_bytes_for_cpu</span><span class="p">;</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">print_line_t</span>
<span class="nf">print_graph_cpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Start with a space character - to make it stand out</span>
<span class="cm">	 * to the right a bit when trace output is pasted into</span>
<span class="cm">	 * email:</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot; %*d) &quot;</span><span class="p">,</span> <span class="n">max_bytes_for_cpu</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">TRACE_TYPE_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define TRACE_GRAPH_PROCINFO_LENGTH	14</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">print_line_t</span>
<span class="nf">print_graph_proc</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">pid_t</span> <span class="n">pid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">comm</span><span class="p">[</span><span class="n">TASK_COMM_LEN</span><span class="p">];</span>
	<span class="cm">/* sign + log10(MAX_INT) + &#39;\0&#39; */</span>
	<span class="kt">char</span> <span class="n">pid_str</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">spaces</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">trace_find_cmdline</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">comm</span><span class="p">);</span>
	<span class="n">comm</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">pid_str</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>

	<span class="cm">/* 1 stands for the &quot;-&quot; character */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">comm</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">pid_str</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">TRACE_GRAPH_PROCINFO_LENGTH</span><span class="p">)</span>
		<span class="n">spaces</span> <span class="o">=</span> <span class="n">TRACE_GRAPH_PROCINFO_LENGTH</span> <span class="o">-</span> <span class="n">len</span><span class="p">;</span>

	<span class="cm">/* First spaces to align center */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">spaces</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%s-%s&quot;</span><span class="p">,</span> <span class="n">comm</span><span class="p">,</span> <span class="n">pid_str</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>

	<span class="cm">/* Last spaces to align center */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">spaces</span> <span class="o">-</span> <span class="p">(</span><span class="n">spaces</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">TRACE_TYPE_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">enum</span> <span class="n">print_line_t</span>
<span class="nf">print_graph_lat_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">trace_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">trace_seq_putc</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">trace_print_lat_fmt</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* If the pid changed since the last trace, output this event */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">print_line_t</span>
<span class="nf">verif_pid</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">pid_t</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fgraph_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pid_t</span> <span class="n">prev_pid</span><span class="p">;</span>
	<span class="n">pid_t</span> <span class="o">*</span><span class="n">last_pid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TRACE_TYPE_HANDLED</span><span class="p">;</span>

	<span class="n">last_pid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu_data</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">last_pid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">last_pid</span> <span class="o">==</span> <span class="n">pid</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TRACE_TYPE_HANDLED</span><span class="p">;</span>

	<span class="n">prev_pid</span> <span class="o">=</span> <span class="o">*</span><span class="n">last_pid</span><span class="p">;</span>
	<span class="o">*</span><span class="n">last_pid</span> <span class="o">=</span> <span class="n">pid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prev_pid</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TRACE_TYPE_HANDLED</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm"> * Context-switch trace line:</span>

<span class="cm"> ------------------------------------------</span>
<span class="cm"> | 1)  migration/0--1  =&gt;  sshd-1755</span>
<span class="cm"> ------------------------------------------</span>

<span class="cm"> */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span>
		<span class="s">&quot; ------------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">print_graph_cpu</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">print_graph_proc</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">prev_pid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot; =&gt; &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">print_graph_proc</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span>
		<span class="s">&quot;</span><span class="se">\n</span><span class="s"> ------------------------------------------</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">TRACE_TYPE_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ftrace_graph_ret_entry</span> <span class="o">*</span>
<span class="nf">get_return_for_leaf</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_iterator</span> <span class="o">*</span><span class="n">iter</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ftrace_graph_ent_entry</span> <span class="o">*</span><span class="n">curr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fgraph_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ring_buffer_iter</span> <span class="o">*</span><span class="n">ring_iter</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ring_buffer_event</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ftrace_graph_ret_entry</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the previous output failed to write to the seq buffer,</span>
<span class="cm">	 * then we just reuse the data from before.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">failed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">curr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ent</span><span class="p">;</span>
		<span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="n">ring_iter</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">buffer_iter</span><span class="p">[</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">];</span>

		<span class="cm">/* First peek to compare current entry and the next one */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ring_iter</span><span class="p">)</span>
			<span class="n">event</span> <span class="o">=</span> <span class="n">ring_buffer_iter_peek</span><span class="p">(</span><span class="n">ring_iter</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * We need to consume the current entry to see</span>
<span class="cm">			 * the next one.</span>
<span class="cm">			 */</span>
			<span class="n">ring_buffer_consume</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">,</span>
					    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">event</span> <span class="o">=</span> <span class="n">ring_buffer_peek</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">,</span>
						 <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">event</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">next</span> <span class="o">=</span> <span class="n">ring_buffer_event_data</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Save current and next entries for later reference</span>
<span class="cm">			 * if the output fails.</span>
<span class="cm">			 */</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">ent</span> <span class="o">=</span> <span class="o">*</span><span class="n">curr</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * If the next event is not a return type, then</span>
<span class="cm">			 * we only care about what type it is. Otherwise we can</span>
<span class="cm">			 * safely copy the entire event.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">ent</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">TRACE_GRAPH_RET</span><span class="p">)</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">=</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">ret</span><span class="p">.</span><span class="n">ent</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">ent</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">ent</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">TRACE_GRAPH_RET</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">ent</span><span class="p">.</span><span class="n">pid</span> <span class="o">!=</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">ent</span><span class="p">.</span><span class="n">pid</span> <span class="o">||</span>
			<span class="n">curr</span><span class="o">-&gt;</span><span class="n">graph_ent</span><span class="p">.</span><span class="n">func</span> <span class="o">!=</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">ret</span><span class="p">.</span><span class="n">func</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* this is a leaf, now advance the iterator */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ring_iter</span><span class="p">)</span>
		<span class="n">ring_buffer_read</span><span class="p">(</span><span class="n">ring_iter</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">next</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">print_graph_abs_time</span><span class="p">(</span><span class="n">u64</span> <span class="n">t</span><span class="p">,</span> <span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">usecs_rem</span><span class="p">;</span>

	<span class="n">usecs_rem</span> <span class="o">=</span> <span class="n">do_div</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">NSEC_PER_SEC</span><span class="p">);</span>
	<span class="n">usecs_rem</span> <span class="o">/=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%5lu.%06lu |  &quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">t</span><span class="p">,</span> <span class="n">usecs_rem</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">print_line_t</span>
<span class="nf">print_graph_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_iterator</span> <span class="o">*</span><span class="n">iter</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">trace_type</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">pid_t</span> <span class="n">pid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">__irqentry_text_start</span> <span class="o">||</span>
		<span class="n">addr</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">__irqentry_text_end</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TRACE_TYPE_UNHANDLED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">trace_flags</span> <span class="o">&amp;</span> <span class="n">TRACE_ITER_CONTEXT_INFO</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Absolute time */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRACE_GRAPH_PRINT_ABS_TIME</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">print_graph_abs_time</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">ts</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Cpu */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRACE_GRAPH_PRINT_CPU</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">print_graph_cpu</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Proc */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRACE_GRAPH_PRINT_PROC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">print_graph_proc</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot; | &quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* No overhead */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">print_graph_duration</span><span class="p">(</span><span class="n">DURATION_FILL_START</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">TRACE_TYPE_HANDLED</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">TRACE_GRAPH_ENT</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;==========&gt;&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;&lt;==========&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">print_graph_duration</span><span class="p">(</span><span class="n">DURATION_FILL_END</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">TRACE_TYPE_HANDLED</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">TRACE_TYPE_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">print_line_t</span>
<span class="nf">trace_print_graph_duration</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">duration</span><span class="p">,</span> <span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nsecs_rem</span> <span class="o">=</span> <span class="n">do_div</span><span class="p">(</span><span class="n">duration</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="cm">/* log10(ULONG_MAX) + &#39;\0&#39; */</span>
	<span class="kt">char</span> <span class="n">msecs_str</span><span class="p">[</span><span class="mi">21</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">nsecs_str</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">msecs_str</span><span class="p">,</span> <span class="s">&quot;%lu&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">duration</span><span class="p">);</span>

	<span class="cm">/* Print msecs */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">msecs_str</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">msecs_str</span><span class="p">);</span>

	<span class="cm">/* Print nsecs (we don&#39;t want to exceed 7 numbers) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">size_t</span> <span class="n">slen</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nsecs_str</span><span class="p">),</span> <span class="mi">8UL</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>

		<span class="n">snprintf</span><span class="p">(</span><span class="n">nsecs_str</span><span class="p">,</span> <span class="n">slen</span><span class="p">,</span> <span class="s">&quot;%03lu&quot;</span><span class="p">,</span> <span class="n">nsecs_rem</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;.%s&quot;</span><span class="p">,</span> <span class="n">nsecs_str</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">nsecs_str</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot; us &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>

	<span class="cm">/* Print remaining spaces to fit the row&#39;s width */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">TRACE_TYPE_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">print_line_t</span>
<span class="nf">print_graph_duration</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">duration</span><span class="p">,</span> <span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
		     <span class="n">u32</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRACE_GRAPH_PRINT_DURATION</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">trace_flags</span> <span class="o">&amp;</span> <span class="n">TRACE_ITER_CONTEXT_INFO</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">TRACE_TYPE_HANDLED</span><span class="p">;</span>

	<span class="cm">/* No real adata, just filling the column with spaces */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">duration</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DURATION_FILL_FULL</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;              |  &quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="n">TRACE_TYPE_HANDLED</span> <span class="o">:</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DURATION_FILL_START</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;  &quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="n">TRACE_TYPE_HANDLED</span> <span class="o">:</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DURATION_FILL_END</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot; |&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="n">TRACE_TYPE_HANDLED</span> <span class="o">:</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Signal a overhead of time execution to the output */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRACE_GRAPH_PRINT_OVERHEAD</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Duration exceeded 100 msecs */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">duration</span> <span class="o">&gt;</span> <span class="mi">100000ULL</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;! &quot;</span><span class="p">);</span>
		<span class="cm">/* Duration exceeded 10 msecs */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">duration</span> <span class="o">&gt;</span> <span class="mi">10000ULL</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;+ &quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The -1 means we either did not exceed the duration tresholds</span>
<span class="cm">	 * or we dont want to print out the overhead. Either way we need</span>
<span class="cm">	 * to fill out the space.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;  &quot;</span><span class="p">);</span>

	<span class="cm">/* Catching here any failure happenned above */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_print_graph_duration</span><span class="p">(</span><span class="n">duration</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">TRACE_TYPE_HANDLED</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;|  &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">TRACE_TYPE_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Case of a leaf function on its call entry */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">print_line_t</span>
<span class="nf">print_graph_entry_leaf</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_iterator</span> <span class="o">*</span><span class="n">iter</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ftrace_graph_ent_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ftrace_graph_ret_entry</span> <span class="o">*</span><span class="n">ret_entry</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fgraph_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ftrace_graph_ret</span> <span class="o">*</span><span class="n">graph_ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ftrace_graph_ent</span> <span class="o">*</span><span class="n">call</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">duration</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">graph_ret</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ret_entry</span><span class="o">-&gt;</span><span class="n">ret</span><span class="p">;</span>
	<span class="n">call</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">graph_ent</span><span class="p">;</span>
	<span class="n">duration</span> <span class="o">=</span> <span class="n">graph_ret</span><span class="o">-&gt;</span><span class="n">rettime</span> <span class="o">-</span> <span class="n">graph_ret</span><span class="o">-&gt;</span><span class="n">calltime</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fgraph_cpu_data</span> <span class="o">*</span><span class="n">cpu_data</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">;</span>

		<span class="n">cpu_data</span> <span class="o">=</span> <span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu_data</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Comments display at + 1 to depth. Since</span>
<span class="cm">		 * this is a leaf function, keep the comments</span>
<span class="cm">		 * equal to this depth.</span>
<span class="cm">		 */</span>
		<span class="n">cpu_data</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* No need to keep this function around for this depth */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">&lt;</span> <span class="n">FTRACE_RETFUNC_DEPTH</span><span class="p">)</span>
			<span class="n">cpu_data</span><span class="o">-&gt;</span><span class="n">enter_funcs</span><span class="p">[</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Overhead and duration */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">print_graph_duration</span><span class="p">(</span><span class="n">duration</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>

	<span class="cm">/* Function */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">*</span> <span class="n">TRACE_GRAPH_INDENT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%ps();</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">TRACE_TYPE_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">print_line_t</span>
<span class="nf">print_graph_entry_nested</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_iterator</span> <span class="o">*</span><span class="n">iter</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ftrace_graph_ent_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ftrace_graph_ent</span> <span class="o">*</span><span class="n">call</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">graph_ent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fgraph_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fgraph_cpu_data</span> <span class="o">*</span><span class="n">cpu_data</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">;</span>

		<span class="n">cpu_data</span> <span class="o">=</span> <span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu_data</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
		<span class="n">cpu_data</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">;</span>

		<span class="cm">/* Save this function pointer to see if the exit matches */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">&lt;</span> <span class="n">FTRACE_RETFUNC_DEPTH</span><span class="p">)</span>
			<span class="n">cpu_data</span><span class="o">-&gt;</span><span class="n">enter_funcs</span><span class="p">[</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">]</span> <span class="o">=</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* No time */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">print_graph_duration</span><span class="p">(</span><span class="n">DURATION_FILL_FULL</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">TRACE_TYPE_HANDLED</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Function */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">*</span> <span class="n">TRACE_GRAPH_INDENT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%ps() {</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">call</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * we already consumed the current entry to check the next one</span>
<span class="cm">	 * and see if this is a leaf.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">TRACE_TYPE_NO_CONSUME</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">print_line_t</span>
<span class="nf">print_graph_prologue</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_iterator</span> <span class="o">*</span><span class="n">iter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fgraph_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">trace_entry</span> <span class="o">*</span><span class="n">ent</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">ent</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Pid */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">verif_pid</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Interrupt */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">print_graph_irq</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">trace_flags</span> <span class="o">&amp;</span> <span class="n">TRACE_ITER_CONTEXT_INFO</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Absolute time */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRACE_GRAPH_PRINT_ABS_TIME</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">print_graph_abs_time</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">ts</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Cpu */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRACE_GRAPH_PRINT_CPU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">print_graph_cpu</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Proc */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRACE_GRAPH_PRINT_PROC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">print_graph_proc</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot; | &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Latency format */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trace_flags</span> <span class="o">&amp;</span> <span class="n">TRACE_ITER_LATENCY_FMT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">print_graph_lat_fmt</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ent</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Entry check for irq code</span>
<span class="cm"> *</span>
<span class="cm"> * returns 1 if</span>
<span class="cm"> *  - we are inside irq code</span>
<span class="cm"> *  - we just entered irq code</span>
<span class="cm"> *</span>
<span class="cm"> * retunns 0 if</span>
<span class="cm"> *  - funcgraph-interrupts option is set</span>
<span class="cm"> *  - we are not inside irq code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">check_irq_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_iterator</span> <span class="o">*</span><span class="n">iter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">depth_irq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fgraph_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we are either displaying irqs, or we got called as</span>
<span class="cm">	 * a graph event and private data does not exist,</span>
<span class="cm">	 * then we bypass the irq check.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRACE_GRAPH_PRINT_IRQS</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">depth_irq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu_data</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">depth_irq</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We are inside the irq code</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">depth_irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">__irqentry_text_start</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">__irqentry_text_end</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We are entering irq code.</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">depth_irq</span> <span class="o">=</span> <span class="n">depth</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return check for irq code</span>
<span class="cm"> *</span>
<span class="cm"> * returns 1 if</span>
<span class="cm"> *  - we are inside irq code</span>
<span class="cm"> *  - we just left irq code</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 if</span>
<span class="cm"> *  - funcgraph-interrupts option is set</span>
<span class="cm"> *  - we are not inside irq code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">check_irq_return</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_iterator</span> <span class="o">*</span><span class="n">iter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">depth_irq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fgraph_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we are either displaying irqs, or we got called as</span>
<span class="cm">	 * a graph event and private data does not exist,</span>
<span class="cm">	 * then we bypass the irq check.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRACE_GRAPH_PRINT_IRQS</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">depth_irq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu_data</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">depth_irq</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We are not inside the irq code.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">depth_irq</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We are inside the irq code, and this is returning entry.</span>
<span class="cm">	 * Let&#39;s not trace it and clear the entry depth, since</span>
<span class="cm">	 * we are out of irq code.</span>
<span class="cm">	 *</span>
<span class="cm">	 * This condition ensures that we &#39;leave the irq code&#39; once</span>
<span class="cm">	 * we are out of the entry depth. Thus protecting us from</span>
<span class="cm">	 * the RETURN entry loss.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">depth_irq</span> <span class="o">&gt;=</span> <span class="n">depth</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">depth_irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We are inside the irq code, and this is not the entry.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">print_line_t</span>
<span class="nf">print_graph_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">ftrace_graph_ent_entry</span> <span class="o">*</span><span class="n">field</span><span class="p">,</span> <span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">trace_iterator</span> <span class="o">*</span><span class="n">iter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fgraph_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ftrace_graph_ent</span> <span class="o">*</span><span class="n">call</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">graph_ent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ftrace_graph_ret_entry</span> <span class="o">*</span><span class="n">leaf_ret</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">enum</span> <span class="n">print_line_t</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_irq_entry</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">TRACE_TYPE_HANDLED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">print_graph_prologue</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">TRACE_GRAPH_ENT</span><span class="p">,</span> <span class="n">call</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">,</span> <span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>

	<span class="n">leaf_ret</span> <span class="o">=</span> <span class="n">get_return_for_leaf</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">field</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">leaf_ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">print_graph_entry_leaf</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">leaf_ret</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">print_graph_entry_nested</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If we failed to write our output, then we need to make</span>
<span class="cm">		 * note of it. Because we already consumed our entry.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">full</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">failed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">cpu</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">failed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">print_line_t</span>
<span class="nf">print_graph_return</span><span class="p">(</span><span class="k">struct</span> <span class="n">ftrace_graph_ret</span> <span class="o">*</span><span class="n">trace</span><span class="p">,</span> <span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">trace_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">trace_iterator</span> <span class="o">*</span><span class="n">iter</span><span class="p">,</span>
		   <span class="n">u32</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">duration</span> <span class="o">=</span> <span class="n">trace</span><span class="o">-&gt;</span><span class="n">rettime</span> <span class="o">-</span> <span class="n">trace</span><span class="o">-&gt;</span><span class="n">calltime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fgraph_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">pid_t</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">func_match</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_irq_return</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">trace</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">TRACE_TYPE_HANDLED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fgraph_cpu_data</span> <span class="o">*</span><span class="n">cpu_data</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">;</span>

		<span class="n">cpu_data</span> <span class="o">=</span> <span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu_data</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Comments display at + 1 to depth. This is the</span>
<span class="cm">		 * return from a function, we now want the comments</span>
<span class="cm">		 * to display at the same level of the bracket.</span>
<span class="cm">		 */</span>
		<span class="n">cpu_data</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">=</span> <span class="n">trace</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">trace</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">&lt;</span> <span class="n">FTRACE_RETFUNC_DEPTH</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cpu_data</span><span class="o">-&gt;</span><span class="n">enter_funcs</span><span class="p">[</span><span class="n">trace</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">]</span> <span class="o">!=</span> <span class="n">trace</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">)</span>
				<span class="n">func_match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">cpu_data</span><span class="o">-&gt;</span><span class="n">enter_funcs</span><span class="p">[</span><span class="n">trace</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">print_graph_prologue</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>

	<span class="cm">/* Overhead and duration */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">print_graph_duration</span><span class="p">(</span><span class="n">duration</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>

	<span class="cm">/* Closing brace */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">trace</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">*</span> <span class="n">TRACE_GRAPH_INDENT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the return function does not have a matching entry,</span>
<span class="cm">	 * then the entry was lost. Instead of just printing</span>
<span class="cm">	 * the &#39;}&#39; and letting the user guess what function this</span>
<span class="cm">	 * belongs to, write out the function name.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">func_match</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;} /* %ps */</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">trace</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Overrun */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRACE_GRAPH_PRINT_OVERRUN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot; (Overruns: %lu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">trace</span><span class="o">-&gt;</span><span class="n">overrun</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">print_graph_irq</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">trace</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">,</span> <span class="n">TRACE_GRAPH_RET</span><span class="p">,</span>
			      <span class="n">cpu</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">TRACE_TYPE_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">print_line_t</span>
<span class="nf">print_graph_comment</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">trace_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">trace_iterator</span> <span class="o">*</span><span class="n">iter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sym_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">trace_flags</span> <span class="o">&amp;</span> <span class="n">TRACE_ITER_SYM_MASK</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fgraph_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">trace_event</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
		<span class="n">depth</span> <span class="o">=</span> <span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu_data</span><span class="p">,</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">print_graph_prologue</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>

	<span class="cm">/* No time */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">print_graph_duration</span><span class="p">(</span><span class="n">DURATION_FILL_FULL</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">TRACE_TYPE_HANDLED</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Indentation */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">TRACE_GRAPH_INDENT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="cm">/* The comment */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;/* &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRACE_BPRINT</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_print_bprintk_msg_only</span><span class="p">(</span><span class="n">iter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">TRACE_TYPE_HANDLED</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRACE_PRINT</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_print_printk_msg_only</span><span class="p">(</span><span class="n">iter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">TRACE_TYPE_HANDLED</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">event</span> <span class="o">=</span> <span class="n">ftrace_find_event</span><span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">event</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">TRACE_TYPE_UNHANDLED</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">trace</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">sym_flags</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">TRACE_TYPE_HANDLED</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Strip ending newline */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot; */</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">TRACE_TYPE_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">enum</span> <span class="n">print_line_t</span>
<span class="nf">print_graph_function_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_iterator</span> <span class="o">*</span><span class="n">iter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ftrace_graph_ent_entry</span> <span class="o">*</span><span class="n">field</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fgraph_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">trace_entry</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">ent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu_data</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ignore</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu_data</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ignore</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">TRACE_TYPE_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the last output failed, there&#39;s a possibility we need</span>
<span class="cm">	 * to print out the missing entry which would never go out.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">failed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">field</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ent</span><span class="p">;</span>
		<span class="n">iter</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">print_graph_entry</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">iter</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">TRACE_TYPE_HANDLED</span> <span class="o">&amp;&amp;</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">!=</span> <span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu_data</span><span class="p">,</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ignore</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">TRACE_TYPE_NO_CONSUME</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">iter</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">cpu</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRACE_GRAPH_ENT</span>: <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * print_graph_entry() may consume the current event,</span>
<span class="cm">		 * thus @field may become invalid, so we need to save it.</span>
<span class="cm">		 * sizeof(struct ftrace_graph_ent_entry) is very small,</span>
<span class="cm">		 * it can be safely saved at the stack.</span>
<span class="cm">		 */</span>
		<span class="k">struct</span> <span class="n">ftrace_graph_ent_entry</span> <span class="n">saved</span><span class="p">;</span>
		<span class="n">trace_assign_type</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
		<span class="n">saved</span> <span class="o">=</span> <span class="o">*</span><span class="n">field</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">print_graph_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">saved</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">iter</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">TRACE_GRAPH_RET</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ftrace_graph_ret_entry</span> <span class="o">*</span><span class="n">field</span><span class="p">;</span>
		<span class="n">trace_assign_type</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">print_graph_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">ret</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">iter</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">TRACE_STACK</span>:
	<span class="k">case</span> <span class="n">TRACE_FN</span>:
		<span class="cm">/* dont trace stack and functions as comments */</span>
		<span class="k">return</span> <span class="n">TRACE_TYPE_UNHANDLED</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">print_graph_comment</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">iter</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">TRACE_TYPE_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">print_line_t</span>
<span class="nf">print_graph_function</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_iterator</span> <span class="o">*</span><span class="n">iter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">print_graph_function_flags</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">tracer_flags</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">print_line_t</span>
<span class="nf">print_graph_function_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_iterator</span> <span class="o">*</span><span class="n">iter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">trace_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">print_graph_function</span><span class="p">(</span><span class="n">iter</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_lat_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">spaces</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;                &quot;</span>	<span class="cm">/* 16 spaces */</span>
		<span class="s">&quot;    &quot;</span>					<span class="cm">/* 4 spaces */</span>
		<span class="s">&quot;                 &quot;</span><span class="p">;</span>			<span class="cm">/* 17 spaces */</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRACE_GRAPH_PRINT_ABS_TIME</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRACE_GRAPH_PRINT_CPU</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRACE_GRAPH_PRINT_PROC</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="mi">17</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;#%.*s  _-----=&gt; irqs-off        </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">spaces</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;#%.*s / _----=&gt; need-resched    </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">spaces</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;#%.*s| / _---=&gt; hardirq/softirq </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">spaces</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;#%.*s|| / _--=&gt; preempt-depth   </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">spaces</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;#%.*s||| /                      </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">spaces</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__print_graph_headers_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">trace_flags</span> <span class="o">&amp;</span> <span class="n">TRACE_ITER_LATENCY_FMT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lat</span><span class="p">)</span>
		<span class="n">print_lat_header</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* 1st line */</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;#&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRACE_GRAPH_PRINT_ABS_TIME</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;     TIME       &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRACE_GRAPH_PRINT_CPU</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot; CPU&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRACE_GRAPH_PRINT_PROC</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;  TASK/PID       &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lat</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;||||&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRACE_GRAPH_PRINT_DURATION</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;  DURATION   &quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;               FUNCTION CALLS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* 2nd line */</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;#&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRACE_GRAPH_PRINT_ABS_TIME</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;      |         &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRACE_GRAPH_PRINT_CPU</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot; |  &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRACE_GRAPH_PRINT_PROC</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;   |    |        &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lat</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;||||&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TRACE_GRAPH_PRINT_DURATION</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;   |   |      &quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;               |   |   |   |</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">print_graph_headers</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">print_graph_headers_flags</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">tracer_flags</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">print_graph_headers_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">trace_iterator</span> <span class="o">*</span><span class="n">iter</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">trace_flags</span> <span class="o">&amp;</span> <span class="n">TRACE_ITER_CONTEXT_INFO</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">trace_flags</span> <span class="o">&amp;</span> <span class="n">TRACE_ITER_LATENCY_FMT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* print nothing if the buffers are empty */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">trace_empty</span><span class="p">(</span><span class="n">iter</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">print_trace_header</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">iter</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">__print_graph_headers_flags</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">graph_trace_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_iterator</span> <span class="o">*</span><span class="n">iter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* pid and depth on the last trace processed */</span>
	<span class="k">struct</span> <span class="n">fgraph_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>

	<span class="n">iter</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu_data</span> <span class="o">=</span> <span class="n">alloc_percpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">fgraph_cpu_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu_data</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err_free</span><span class="p">;</span>

	<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pid_t</span> <span class="o">*</span><span class="n">pid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu_data</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">last_pid</span><span class="p">);</span>
		<span class="kt">int</span> <span class="o">*</span><span class="n">depth</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu_data</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">);</span>
		<span class="kt">int</span> <span class="o">*</span><span class="n">ignore</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu_data</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ignore</span><span class="p">);</span>
		<span class="kt">int</span> <span class="o">*</span><span class="n">depth_irq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu_data</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">depth_irq</span><span class="p">);</span>

		<span class="o">*</span><span class="n">pid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ignore</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">depth_irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iter</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>

 <span class="nl">out_err_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
 <span class="nl">out_err:</span>
	<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;function graph tracer: not enough memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">graph_trace_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_iterator</span> <span class="o">*</span><span class="n">iter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fgraph_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_percpu</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu_data</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">func_graph_set_flag</span><span class="p">(</span><span class="n">u32</span> <span class="n">old_flags</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bit</span><span class="p">,</span> <span class="kt">int</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bit</span> <span class="o">==</span> <span class="n">TRACE_GRAPH_PRINT_IRQS</span><span class="p">)</span>
		<span class="n">ftrace_graph_skip_irqs</span> <span class="o">=</span> <span class="o">!</span><span class="n">set</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">trace_event_functions</span> <span class="n">graph_functions</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">trace</span>		<span class="o">=</span> <span class="n">print_graph_function_event</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">trace_event</span> <span class="n">graph_trace_entry_event</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">TRACE_GRAPH_ENT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">funcs</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">graph_functions</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">trace_event</span> <span class="n">graph_trace_ret_event</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">TRACE_GRAPH_RET</span><span class="p">,</span>
	<span class="p">.</span><span class="n">funcs</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">graph_functions</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tracer</span> <span class="n">graph_trace</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;function_graph&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">graph_trace_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pipe_open</span>	<span class="o">=</span> <span class="n">graph_trace_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>		<span class="o">=</span> <span class="n">graph_trace_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pipe_close</span>	<span class="o">=</span> <span class="n">graph_trace_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wait_pipe</span>	<span class="o">=</span> <span class="n">poll_wait_pipe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">graph_trace_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset</span>		<span class="o">=</span> <span class="n">graph_trace_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">print_line</span>	<span class="o">=</span> <span class="n">print_graph_function</span><span class="p">,</span>
	<span class="p">.</span><span class="n">print_header</span>	<span class="o">=</span> <span class="n">print_graph_headers</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">tracer_flags</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_flag</span>	<span class="o">=</span> <span class="n">func_graph_set_flag</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_FTRACE_SELFTEST</span>
	<span class="p">.</span><span class="n">selftest</span>	<span class="o">=</span> <span class="n">trace_selftest_startup_function_graph</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">int</span> <span class="nf">init_graph_trace</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">max_bytes_for_cpu</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">nr_cpu_ids</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">register_ftrace_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">graph_trace_entry_event</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Warning: could not register graph trace events</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">register_ftrace_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">graph_trace_ret_event</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Warning: could not register graph trace events</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">register_tracer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">graph_trace</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">device_initcall</span><span class="p">(</span><span class="n">init_graph_trace</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
