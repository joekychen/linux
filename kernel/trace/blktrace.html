<!DOCTYPE html>
<html><head><title>joekychen/linux » kernel › trace › blktrace.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>blktrace.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2006 Jens Axboe &lt;axboe@kernel.dk&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/blktrace_api.h&gt;</span>
<span class="cp">#include &lt;linux/percpu.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>

<span class="cp">#include &lt;trace/events/block.h&gt;</span>

<span class="cp">#include &quot;trace_output.h&quot;</span>

<span class="cp">#ifdef CONFIG_BLK_DEV_IO_TRACE</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blktrace_seq</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">trace_array</span> <span class="o">*</span><span class="n">blk_tr</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">blk_tracer_enabled</span> <span class="n">__read_mostly</span><span class="p">;</span>

<span class="cm">/* Select an alternative, minimalistic output than the original one */</span>
<span class="cp">#define TRACE_BLK_OPT_CLASSIC	0x1</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tracer_opt</span> <span class="n">blk_tracer_opts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Default disable the minimalistic output */</span>
	<span class="p">{</span> <span class="n">TRACER_OPT</span><span class="p">(</span><span class="n">blk_classic</span><span class="p">,</span> <span class="n">TRACE_BLK_OPT_CLASSIC</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tracer_flags</span> <span class="n">blk_tracer_flags</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">val</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">opts</span> <span class="o">=</span> <span class="n">blk_tracer_opts</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Global reference count of probes */</span>
<span class="k">static</span> <span class="n">atomic_t</span> <span class="n">blk_probes_ref</span> <span class="o">=</span> <span class="n">ATOMIC_INIT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">blk_register_tracepoints</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">blk_unregister_tracepoints</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Send out a notify message.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">trace_note</span><span class="p">(</span><span class="k">struct</span> <span class="n">blk_trace</span> <span class="o">*</span><span class="n">bt</span><span class="p">,</span> <span class="n">pid_t</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">action</span><span class="p">,</span>
		       <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">blk_io_trace</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ring_buffer_event</span> <span class="o">*</span><span class="n">event</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ring_buffer</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">smp_processor_id</span><span class="p">();</span>
	<span class="n">bool</span> <span class="n">blk_tracer</span> <span class="o">=</span> <span class="n">blk_tracer_enabled</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">blk_tracer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buffer</span> <span class="o">=</span> <span class="n">blk_tr</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
		<span class="n">pc</span> <span class="o">=</span> <span class="n">preempt_count</span><span class="p">();</span>
		<span class="n">event</span> <span class="o">=</span> <span class="n">trace_buffer_lock_reserve</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">TRACE_BLK</span><span class="p">,</span>
						  <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span>
						  <span class="mi">0</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">event</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">ring_buffer_event_data</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">record_it</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">rchan</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">t</span> <span class="o">=</span> <span class="n">relay_reserve</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">rchan</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">BLK_IO_TRACE_MAGIC</span> <span class="o">|</span> <span class="n">BLK_IO_TRACE_VERSION</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span> <span class="o">=</span> <span class="n">ktime_to_ns</span><span class="p">(</span><span class="n">ktime_get</span><span class="p">());</span>
<span class="nl">record_it:</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">bt</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">action</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="n">pid</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">cpu</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">pdu_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">t</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">blk_tracer</span><span class="p">)</span>
			<span class="n">trace_buffer_unlock_commit</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send out a notify for this process, if we haven&#39;t done so since a trace</span>
<span class="cm"> * started</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">trace_note_tsk</span><span class="p">(</span><span class="k">struct</span> <span class="n">blk_trace</span> <span class="o">*</span><span class="n">bt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">tsk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tsk</span><span class="o">-&gt;</span><span class="n">btrace_seq</span> <span class="o">=</span> <span class="n">blktrace_seq</span><span class="p">;</span>
	<span class="n">trace_note</span><span class="p">(</span><span class="n">bt</span><span class="p">,</span> <span class="n">tsk</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">BLK_TN_PROCESS</span><span class="p">,</span> <span class="n">tsk</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">trace_note_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">blk_trace</span> <span class="o">*</span><span class="n">bt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">now</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">words</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">getnstimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">now</span><span class="p">);</span>
	<span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
	<span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">trace_note</span><span class="p">(</span><span class="n">bt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BLK_TN_TIMESTAMP</span><span class="p">,</span> <span class="n">words</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">words</span><span class="p">));</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">__trace_note_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">blk_trace</span> <span class="o">*</span><span class="n">bt</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">trace_state</span> <span class="o">!=</span> <span class="n">Blktrace_running</span> <span class="o">&amp;&amp;</span>
		     <span class="o">!</span><span class="n">blk_tracer_enabled</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the BLK_TC_NOTIFY action mask isn&#39;t set, don&#39;t send any note</span>
<span class="cm">	 * message to the trace.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">act_mask</span> <span class="o">&amp;</span> <span class="n">BLK_TC_NOTIFY</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">msg_data</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">());</span>
	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">vscnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">BLK_TN_MAX_MSG</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>

	<span class="n">trace_note</span><span class="p">(</span><span class="n">bt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BLK_TN_MESSAGE</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">__trace_note_message</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">act_log_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">blk_trace</span> <span class="o">*</span><span class="n">bt</span><span class="p">,</span> <span class="n">u32</span> <span class="n">what</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sector</span><span class="p">,</span>
			 <span class="n">pid_t</span> <span class="n">pid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">act_mask</span> <span class="o">&lt;&lt;</span> <span class="n">BLK_TC_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">what</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sector</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sector</span> <span class="o">&lt;</span> <span class="n">bt</span><span class="o">-&gt;</span><span class="n">start_lba</span> <span class="o">||</span> <span class="n">sector</span> <span class="o">&gt;</span> <span class="n">bt</span><span class="o">-&gt;</span><span class="n">end_lba</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">&amp;&amp;</span> <span class="n">pid</span> <span class="o">!=</span> <span class="n">bt</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Data direction bit lookup</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">ddir_act</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">BLK_TC_ACT</span><span class="p">(</span><span class="n">BLK_TC_READ</span><span class="p">),</span>
				 <span class="n">BLK_TC_ACT</span><span class="p">(</span><span class="n">BLK_TC_WRITE</span><span class="p">)</span> <span class="p">};</span>

<span class="cp">#define BLK_TC_RAHEAD		BLK_TC_AHEAD</span>

<span class="cm">/* The ilog2() calls fall out because they&#39;re constant */</span>
<span class="cp">#define MASK_TC_BIT(rw, __name) ((rw &amp; REQ_ ## __name) &lt;&lt; \</span>
<span class="cp">	  (ilog2(BLK_TC_ ## __name) + BLK_TC_SHIFT - __REQ_ ## __name))</span>

<span class="cm">/*</span>
<span class="cm"> * The worker for the various blk_add_trace*() types. Fills out a</span>
<span class="cm"> * blk_io_trace structure and places it in a per-cpu subbuffer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__blk_add_trace</span><span class="p">(</span><span class="k">struct</span> <span class="n">blk_trace</span> <span class="o">*</span><span class="n">bt</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">sector</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bytes</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">rw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">what</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pdu_len</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pdu_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">tsk</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ring_buffer_event</span> <span class="o">*</span><span class="n">event</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ring_buffer</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">blk_io_trace</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">sequence</span><span class="p">;</span>
	<span class="n">pid_t</span> <span class="n">pid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">pc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">blk_tracer</span> <span class="o">=</span> <span class="n">blk_tracer_enabled</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">trace_state</span> <span class="o">!=</span> <span class="n">Blktrace_running</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">blk_tracer</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">what</span> <span class="o">|=</span> <span class="n">ddir_act</span><span class="p">[</span><span class="n">rw</span> <span class="o">&amp;</span> <span class="n">WRITE</span><span class="p">];</span>
	<span class="n">what</span> <span class="o">|=</span> <span class="n">MASK_TC_BIT</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="n">SYNC</span><span class="p">);</span>
	<span class="n">what</span> <span class="o">|=</span> <span class="n">MASK_TC_BIT</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="n">RAHEAD</span><span class="p">);</span>
	<span class="n">what</span> <span class="o">|=</span> <span class="n">MASK_TC_BIT</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="n">META</span><span class="p">);</span>
	<span class="n">what</span> <span class="o">|=</span> <span class="n">MASK_TC_BIT</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="n">DISCARD</span><span class="p">);</span>
	<span class="n">what</span> <span class="o">|=</span> <span class="n">MASK_TC_BIT</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
	<span class="n">what</span> <span class="o">|=</span> <span class="n">MASK_TC_BIT</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="n">FUA</span><span class="p">);</span>

	<span class="n">pid</span> <span class="o">=</span> <span class="n">tsk</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">act_log_check</span><span class="p">(</span><span class="n">bt</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">pid</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">cpu</span> <span class="o">=</span> <span class="n">raw_smp_processor_id</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">blk_tracer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tracing_record_cmdline</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>

		<span class="n">buffer</span> <span class="o">=</span> <span class="n">blk_tr</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
		<span class="n">pc</span> <span class="o">=</span> <span class="n">preempt_count</span><span class="p">();</span>
		<span class="n">event</span> <span class="o">=</span> <span class="n">trace_buffer_lock_reserve</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">TRACE_BLK</span><span class="p">,</span>
						  <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="n">pdu_len</span><span class="p">,</span>
						  <span class="mi">0</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">event</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">ring_buffer_event_data</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">record_it</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * A word about the locking here - we disable interrupts to reserve</span>
<span class="cm">	 * some space in the relay per-cpu buffer, to prevent an irq</span>
<span class="cm">	 * from coming in and stepping on our toes.</span>
<span class="cm">	 */</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="n">btrace_seq</span> <span class="o">!=</span> <span class="n">blktrace_seq</span><span class="p">))</span>
		<span class="n">trace_note_tsk</span><span class="p">(</span><span class="n">bt</span><span class="p">,</span> <span class="n">tsk</span><span class="p">);</span>

	<span class="n">t</span> <span class="o">=</span> <span class="n">relay_reserve</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">rchan</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="n">pdu_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sequence</span> <span class="o">=</span> <span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

		<span class="n">t</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">BLK_IO_TRACE_MAGIC</span> <span class="o">|</span> <span class="n">BLK_IO_TRACE_VERSION</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">sequence</span> <span class="o">=</span> <span class="o">++</span><span class="p">(</span><span class="o">*</span><span class="n">sequence</span><span class="p">);</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">time</span> <span class="o">=</span> <span class="n">ktime_to_ns</span><span class="p">(</span><span class="n">ktime_get</span><span class="p">());</span>
<span class="nl">record_it:</span>
		<span class="cm">/*</span>
<span class="cm">		 * These two are not needed in ftrace as they are in the</span>
<span class="cm">		 * generic trace_entry, filled by tracing_generic_entry_update,</span>
<span class="cm">		 * but for the trace_event-&gt;bin() synthesizer benefit we do it</span>
<span class="cm">		 * here too.</span>
<span class="cm">		 */</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">cpu</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="n">pid</span><span class="p">;</span>

		<span class="n">t</span><span class="o">-&gt;</span><span class="n">sector</span> <span class="o">=</span> <span class="n">sector</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">what</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">bt</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">pdu_len</span> <span class="o">=</span> <span class="n">pdu_len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pdu_len</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">t</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">),</span> <span class="n">pdu_data</span><span class="p">,</span> <span class="n">pdu_len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">blk_tracer</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">trace_buffer_unlock_commit</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">blk_tree_root</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">blk_tree_mutex</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">blk_trace_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">blk_trace</span> <span class="o">*</span><span class="n">bt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">msg_file</span><span class="p">);</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">dropped_file</span><span class="p">);</span>
	<span class="n">relay_close</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">rchan</span><span class="p">);</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">);</span>
	<span class="n">free_percpu</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">);</span>
	<span class="n">free_percpu</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">msg_data</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">bt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">blk_trace_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">blk_trace</span> <span class="o">*</span><span class="n">bt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">blk_trace_free</span><span class="p">(</span><span class="n">bt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">blk_probes_ref</span><span class="p">))</span>
		<span class="n">blk_unregister_tracepoints</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">blk_trace_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">blk_trace</span> <span class="o">*</span><span class="n">bt</span><span class="p">;</span>

	<span class="n">bt</span> <span class="o">=</span> <span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">blk_trace</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bt</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">trace_state</span> <span class="o">!=</span> <span class="n">Blktrace_running</span><span class="p">)</span>
		<span class="n">blk_trace_cleanup</span><span class="p">(</span><span class="n">bt</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">blk_trace_remove</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">blk_dropped_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
				<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">blk_trace</span> <span class="o">*</span><span class="n">bt</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">dropped</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">blk_dropped_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span>		<span class="n">blk_dropped_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span>	<span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">blk_msg_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
				<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">blk_trace</span> <span class="o">*</span><span class="n">bt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">BLK_TN_MAX_MSG</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">msg</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">bt</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">__trace_note_message</span><span class="p">(</span><span class="n">bt</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">blk_msg_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span>	<span class="n">blk_msg_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span>	<span class="n">noop_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Keep track of how many times we encountered a full subbuffer, to aid</span>
<span class="cm"> * the user space app in telling how many lost events there were.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">blk_subbuf_start_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">rchan_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">subbuf</span><span class="p">,</span>
				     <span class="kt">void</span> <span class="o">*</span><span class="n">prev_subbuf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">prev_padding</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">blk_trace</span> <span class="o">*</span><span class="n">bt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">relay_buf_full</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">bt</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">dropped</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">blk_remove_buf_file_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="nf">blk_create_buf_file_callback</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span>
						   <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span>
						   <span class="n">umode_t</span> <span class="n">mode</span><span class="p">,</span>
						   <span class="k">struct</span> <span class="n">rchan_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
						   <span class="kt">int</span> <span class="o">*</span><span class="n">is_global</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">relay_file_operations</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rchan_callbacks</span> <span class="n">blk_relay_callbacks</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">subbuf_start</span>		<span class="o">=</span> <span class="n">blk_subbuf_start_callback</span><span class="p">,</span>
	<span class="p">.</span><span class="n">create_buf_file</span>	<span class="o">=</span> <span class="n">blk_create_buf_file_callback</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove_buf_file</span>	<span class="o">=</span> <span class="n">blk_remove_buf_file_callback</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">blk_trace_setup_lba</span><span class="p">(</span><span class="k">struct</span> <span class="n">blk_trace</span> <span class="o">*</span><span class="n">bt</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hd_struct</span> <span class="o">*</span><span class="n">part</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bdev</span><span class="p">)</span>
		<span class="n">part</span> <span class="o">=</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_part</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">part</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bt</span><span class="o">-&gt;</span><span class="n">start_lba</span> <span class="o">=</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">start_sect</span><span class="p">;</span>
		<span class="n">bt</span><span class="o">-&gt;</span><span class="n">end_lba</span> <span class="o">=</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">start_sect</span> <span class="o">+</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">nr_sects</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bt</span><span class="o">-&gt;</span><span class="n">start_lba</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bt</span><span class="o">-&gt;</span><span class="n">end_lba</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1ULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Setup everything required to start tracing</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">do_blk_trace_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">dev_t</span> <span class="n">dev</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">blk_user_trace_setup</span> <span class="o">*</span><span class="n">buts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">blk_trace</span> <span class="o">*</span><span class="n">old_bt</span><span class="p">,</span> <span class="o">*</span><span class="n">bt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dir</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buts</span><span class="o">-&gt;</span><span class="n">buf_size</span> <span class="o">||</span> <span class="o">!</span><span class="n">buts</span><span class="o">-&gt;</span><span class="n">buf_nr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">buts</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">BLKTRACE_BDEV_SIZE</span><span class="p">);</span>
	<span class="n">buts</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="n">BLKTRACE_BDEV_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * some device names have larger paths - convert the slashes</span>
<span class="cm">	 * to underscores for this to work as expected</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buts</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buts</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span>
			<span class="n">buts</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;_&#39;</span><span class="p">;</span>

	<span class="n">bt</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bt</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bt</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">bt</span><span class="o">-&gt;</span><span class="n">sequence</span> <span class="o">=</span> <span class="n">alloc_percpu</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">bt</span><span class="o">-&gt;</span><span class="n">msg_data</span> <span class="o">=</span> <span class="n">__alloc_percpu</span><span class="p">(</span><span class="n">BLK_TN_MAX_MSG</span><span class="p">,</span> <span class="n">__alignof__</span><span class="p">(</span><span class="kt">char</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">msg_data</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">blk_tree_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blk_tree_root</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">blk_tree_root</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="s">&quot;block&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blk_tree_root</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">blk_tree_mutex</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">blk_tree_mutex</span><span class="p">);</span>

	<span class="n">dir</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="n">buts</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">blk_tree_root</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dir</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">bt</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">=</span> <span class="n">dir</span><span class="p">;</span>
	<span class="n">bt</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">dropped</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">bt</span><span class="o">-&gt;</span><span class="n">dropped_file</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;dropped&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">bt</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">blk_dropped_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">dropped_file</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">bt</span><span class="o">-&gt;</span><span class="n">msg_file</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;msg&quot;</span><span class="p">,</span> <span class="mo">0222</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">bt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blk_msg_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">msg_file</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">bt</span><span class="o">-&gt;</span><span class="n">rchan</span> <span class="o">=</span> <span class="n">relay_open</span><span class="p">(</span><span class="s">&quot;trace&quot;</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">buts</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">,</span>
				<span class="n">buts</span><span class="o">-&gt;</span><span class="n">buf_nr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blk_relay_callbacks</span><span class="p">,</span> <span class="n">bt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">rchan</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">bt</span><span class="o">-&gt;</span><span class="n">act_mask</span> <span class="o">=</span> <span class="n">buts</span><span class="o">-&gt;</span><span class="n">act_mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">act_mask</span><span class="p">)</span>
		<span class="n">bt</span><span class="o">-&gt;</span><span class="n">act_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">blk_trace_setup_lba</span><span class="p">(</span><span class="n">bt</span><span class="p">,</span> <span class="n">bdev</span><span class="p">);</span>

	<span class="cm">/* overwrite with user settings */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buts</span><span class="o">-&gt;</span><span class="n">start_lba</span><span class="p">)</span>
		<span class="n">bt</span><span class="o">-&gt;</span><span class="n">start_lba</span> <span class="o">=</span> <span class="n">buts</span><span class="o">-&gt;</span><span class="n">start_lba</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buts</span><span class="o">-&gt;</span><span class="n">end_lba</span><span class="p">)</span>
		<span class="n">bt</span><span class="o">-&gt;</span><span class="n">end_lba</span> <span class="o">=</span> <span class="n">buts</span><span class="o">-&gt;</span><span class="n">end_lba</span><span class="p">;</span>

	<span class="n">bt</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="n">buts</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
	<span class="n">bt</span><span class="o">-&gt;</span><span class="n">trace_state</span> <span class="o">=</span> <span class="n">Blktrace_setup</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">old_bt</span> <span class="o">=</span> <span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">blk_trace</span><span class="p">,</span> <span class="n">bt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_bt</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">blk_trace</span><span class="p">,</span> <span class="n">old_bt</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">blk_probes_ref</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">blk_register_tracepoints</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">blk_trace_free</span><span class="p">(</span><span class="n">bt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">blk_trace_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">dev_t</span> <span class="n">dev</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span>
		    <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">blk_user_trace_setup</span> <span class="n">buts</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buts</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buts</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">do_blk_trace_setup</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">bdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buts</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buts</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buts</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">blk_trace_remove</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">blk_trace_setup</span><span class="p">);</span>

<span class="cp">#if defined(CONFIG_COMPAT) &amp;&amp; defined(CONFIG_X86_64)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">compat_blk_trace_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
				  <span class="n">dev_t</span> <span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span>
				  <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">blk_user_trace_setup</span> <span class="n">buts</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">compat_blk_user_trace_setup</span> <span class="n">cbuts</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cbuts</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cbuts</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">buts</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">blk_user_trace_setup</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">act_mask</span> <span class="o">=</span> <span class="n">cbuts</span><span class="p">.</span><span class="n">act_mask</span><span class="p">,</span>
		<span class="p">.</span><span class="n">buf_size</span> <span class="o">=</span> <span class="n">cbuts</span><span class="p">.</span><span class="n">buf_size</span><span class="p">,</span>
		<span class="p">.</span><span class="n">buf_nr</span> <span class="o">=</span> <span class="n">cbuts</span><span class="p">.</span><span class="n">buf_nr</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start_lba</span> <span class="o">=</span> <span class="n">cbuts</span><span class="p">.</span><span class="n">start_lba</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end_lba</span> <span class="o">=</span> <span class="n">cbuts</span><span class="p">.</span><span class="n">end_lba</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">cbuts</span><span class="p">.</span><span class="n">pid</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buts</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cbuts</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">do_blk_trace_setup</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">bdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buts</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buts</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="mi">32</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">blk_trace_remove</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="kt">int</span> <span class="nf">blk_trace_startstop</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">blk_trace</span> <span class="o">*</span><span class="n">bt</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">blk_trace</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * For starting a trace, we can transition from a setup or stopped</span>
<span class="cm">	 * trace. For stopping a trace, the state must be running</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">trace_state</span> <span class="o">==</span> <span class="n">Blktrace_setup</span> <span class="o">||</span>
		    <span class="n">bt</span><span class="o">-&gt;</span><span class="n">trace_state</span> <span class="o">==</span> <span class="n">Blktrace_stopped</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">blktrace_seq</span><span class="o">++</span><span class="p">;</span>
			<span class="n">smp_mb</span><span class="p">();</span>
			<span class="n">bt</span><span class="o">-&gt;</span><span class="n">trace_state</span> <span class="o">=</span> <span class="n">Blktrace_running</span><span class="p">;</span>

			<span class="n">trace_note_time</span><span class="p">(</span><span class="n">bt</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">trace_state</span> <span class="o">==</span> <span class="n">Blktrace_running</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bt</span><span class="o">-&gt;</span><span class="n">trace_state</span> <span class="o">=</span> <span class="n">Blktrace_stopped</span><span class="p">;</span>
			<span class="n">relay_flush</span><span class="p">(</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">rchan</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">blk_trace_startstop</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * blk_trace_ioctl: - handle the ioctls associated with tracing</span>
<span class="cm"> * @bdev:	the block device</span>
<span class="cm"> * @cmd:	the ioctl cmd</span>
<span class="cm"> * @arg:	the argument data, if any</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="nf">blk_trace_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>

	<span class="n">q</span> <span class="o">=</span> <span class="n">bdev_get_queue</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_mutex</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BLKTRACESETUP</span>:
		<span class="n">bdevname</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">blk_trace_setup</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_dev</span><span class="p">,</span> <span class="n">bdev</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#if defined(CONFIG_COMPAT) &amp;&amp; defined(CONFIG_X86_64)</span>
	<span class="k">case</span> <span class="n">BLKTRACESETUP32</span>:
		<span class="n">bdevname</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">compat_blk_trace_setup</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_dev</span><span class="p">,</span> <span class="n">bdev</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="n">BLKTRACESTART</span>:
		<span class="n">start</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BLKTRACESTOP</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">blk_trace_startstop</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BLKTRACETEARDOWN</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">blk_trace_remove</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * blk_trace_shutdown: - stop and cleanup trace structures</span>
<span class="cm"> * @q:    the request queue associated with the device</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="kt">void</span> <span class="nf">blk_trace_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">blk_trace</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">blk_trace_startstop</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">blk_trace_remove</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * blktrace probes</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * blk_add_trace_rq - Add a trace for a request oriented action</span>
<span class="cm"> * @q:		queue the io is for</span>
<span class="cm"> * @rq:		the source request</span>
<span class="cm"> * @what:	the action</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *     Records an action against a request. Will log the bio offset + size.</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">blk_add_trace_rq</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="n">what</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">blk_trace</span> <span class="o">*</span><span class="n">bt</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">blk_trace</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">bt</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_BLOCK_PC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">what</span> <span class="o">|=</span> <span class="n">BLK_TC_ACT</span><span class="p">(</span><span class="n">BLK_TC_PC</span><span class="p">);</span>
		<span class="n">__blk_add_trace</span><span class="p">(</span><span class="n">bt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">rq</span><span class="p">),</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_flags</span><span class="p">,</span>
				<span class="n">what</span><span class="p">,</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span><span class="p">,</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">,</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>  <span class="p">{</span>
		<span class="n">what</span> <span class="o">|=</span> <span class="n">BLK_TC_ACT</span><span class="p">(</span><span class="n">BLK_TC_FS</span><span class="p">);</span>
		<span class="n">__blk_add_trace</span><span class="p">(</span><span class="n">bt</span><span class="p">,</span> <span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">rq</span><span class="p">),</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">rq</span><span class="p">),</span>
				<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_flags</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">blk_add_trace_rq_abort</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ignore</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">blk_add_trace_rq</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">rq</span><span class="p">,</span> <span class="n">BLK_TA_ABORT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">blk_add_trace_rq_insert</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ignore</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">blk_add_trace_rq</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">rq</span><span class="p">,</span> <span class="n">BLK_TA_INSERT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">blk_add_trace_rq_issue</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ignore</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">blk_add_trace_rq</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">rq</span><span class="p">,</span> <span class="n">BLK_TA_ISSUE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">blk_add_trace_rq_requeue</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ignore</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">blk_add_trace_rq</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">rq</span><span class="p">,</span> <span class="n">BLK_TA_REQUEUE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">blk_add_trace_rq_complete</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ignore</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">blk_add_trace_rq</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">rq</span><span class="p">,</span> <span class="n">BLK_TA_COMPLETE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * blk_add_trace_bio - Add a trace for a bio oriented action</span>
<span class="cm"> * @q:		queue the io is for</span>
<span class="cm"> * @bio:	the source bio</span>
<span class="cm"> * @what:	the action</span>
<span class="cm"> * @error:	error, if any</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *     Records an action against a bio. Will log the bio offset + size.</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">blk_add_trace_bio</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span>
			      <span class="n">u32</span> <span class="n">what</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">blk_trace</span> <span class="o">*</span><span class="n">bt</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">blk_trace</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">bt</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bio_flagged</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">BIO_UPTODATE</span><span class="p">))</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">EIO</span><span class="p">;</span>

	<span class="n">__blk_add_trace</span><span class="p">(</span><span class="n">bt</span><span class="p">,</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">,</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span><span class="p">,</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span>
			<span class="n">error</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">blk_add_trace_bio_bounce</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ignore</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">blk_add_trace_bio</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">bio</span><span class="p">,</span> <span class="n">BLK_TA_BOUNCE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">blk_add_trace_bio_complete</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ignore</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">blk_add_trace_bio</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">bio</span><span class="p">,</span> <span class="n">BLK_TA_COMPLETE</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">blk_add_trace_bio_backmerge</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ignore</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">blk_add_trace_bio</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">bio</span><span class="p">,</span> <span class="n">BLK_TA_BACKMERGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">blk_add_trace_bio_frontmerge</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ignore</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">blk_add_trace_bio</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">bio</span><span class="p">,</span> <span class="n">BLK_TA_FRONTMERGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">blk_add_trace_bio_queue</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ignore</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">blk_add_trace_bio</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">bio</span><span class="p">,</span> <span class="n">BLK_TA_QUEUE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">blk_add_trace_getrq</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ignore</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bio</span><span class="p">)</span>
		<span class="n">blk_add_trace_bio</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">bio</span><span class="p">,</span> <span class="n">BLK_TA_GETRQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">blk_trace</span> <span class="o">*</span><span class="n">bt</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">blk_trace</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bt</span><span class="p">)</span>
			<span class="n">__blk_add_trace</span><span class="p">(</span><span class="n">bt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rw</span><span class="p">,</span> <span class="n">BLK_TA_GETRQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">blk_add_trace_sleeprq</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ignore</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bio</span><span class="p">)</span>
		<span class="n">blk_add_trace_bio</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">bio</span><span class="p">,</span> <span class="n">BLK_TA_SLEEPRQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">blk_trace</span> <span class="o">*</span><span class="n">bt</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">blk_trace</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bt</span><span class="p">)</span>
			<span class="n">__blk_add_trace</span><span class="p">(</span><span class="n">bt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rw</span><span class="p">,</span> <span class="n">BLK_TA_SLEEPRQ</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">blk_add_trace_plug</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ignore</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">blk_trace</span> <span class="o">*</span><span class="n">bt</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">blk_trace</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bt</span><span class="p">)</span>
		<span class="n">__blk_add_trace</span><span class="p">(</span><span class="n">bt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BLK_TA_PLUG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">blk_add_trace_unplug</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ignore</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="n">bool</span> <span class="n">explicit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">blk_trace</span> <span class="o">*</span><span class="n">bt</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">blk_trace</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__be64</span> <span class="n">rpdu</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">depth</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">what</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">explicit</span><span class="p">)</span>
			<span class="n">what</span> <span class="o">=</span> <span class="n">BLK_TA_UNPLUG_IO</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">what</span> <span class="o">=</span> <span class="n">BLK_TA_UNPLUG_TIMER</span><span class="p">;</span>

		<span class="n">__blk_add_trace</span><span class="p">(</span><span class="n">bt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rpdu</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rpdu</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">blk_add_trace_split</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ignore</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pdu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">blk_trace</span> <span class="o">*</span><span class="n">bt</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">blk_trace</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__be64</span> <span class="n">rpdu</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">pdu</span><span class="p">);</span>

		<span class="n">__blk_add_trace</span><span class="p">(</span><span class="n">bt</span><span class="p">,</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">,</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span><span class="p">,</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span><span class="p">,</span>
				<span class="n">BLK_TA_SPLIT</span><span class="p">,</span> <span class="o">!</span><span class="n">bio_flagged</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">BIO_UPTODATE</span><span class="p">),</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">rpdu</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rpdu</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * blk_add_trace_bio_remap - Add a trace for a bio-remap operation</span>
<span class="cm"> * @ignore:	trace callback data parameter (not used)</span>
<span class="cm"> * @q:		queue the io is for</span>
<span class="cm"> * @bio:	the source bio</span>
<span class="cm"> * @dev:	target device</span>
<span class="cm"> * @from:	source sector</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *     Device mapper or raid target sometimes need to split a bio because</span>
<span class="cm"> *     it spans a stripe (or similar). Add a trace for that action.</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">blk_add_trace_bio_remap</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ignore</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">,</span>
				    <span class="n">dev_t</span> <span class="n">dev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">from</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">blk_trace</span> <span class="o">*</span><span class="n">bt</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">blk_trace</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">blk_io_trace_remap</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">bt</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">r</span><span class="p">.</span><span class="n">device_from</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">r</span><span class="p">.</span><span class="n">device_to</span>   <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_bdev</span><span class="o">-&gt;</span><span class="n">bd_dev</span><span class="p">);</span>
	<span class="n">r</span><span class="p">.</span><span class="n">sector_from</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">from</span><span class="p">);</span>

	<span class="n">__blk_add_trace</span><span class="p">(</span><span class="n">bt</span><span class="p">,</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_sector</span><span class="p">,</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_size</span><span class="p">,</span> <span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_rw</span><span class="p">,</span>
			<span class="n">BLK_TA_REMAP</span><span class="p">,</span> <span class="o">!</span><span class="n">bio_flagged</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">BIO_UPTODATE</span><span class="p">),</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * blk_add_trace_rq_remap - Add a trace for a request-remap operation</span>
<span class="cm"> * @ignore:	trace callback data parameter (not used)</span>
<span class="cm"> * @q:		queue the io is for</span>
<span class="cm"> * @rq:		the source request</span>
<span class="cm"> * @dev:	target device</span>
<span class="cm"> * @from:	source sector</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *     Device mapper remaps request to other devices.</span>
<span class="cm"> *     Add a trace for that action.</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">blk_add_trace_rq_remap</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ignore</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="n">dev_t</span> <span class="n">dev</span><span class="p">,</span>
				   <span class="n">sector_t</span> <span class="n">from</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">blk_trace</span> <span class="o">*</span><span class="n">bt</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">blk_trace</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">blk_io_trace_remap</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">bt</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">r</span><span class="p">.</span><span class="n">device_from</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">r</span><span class="p">.</span><span class="n">device_to</span>   <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">disk_devt</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">rq_disk</span><span class="p">));</span>
	<span class="n">r</span><span class="p">.</span><span class="n">sector_from</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">from</span><span class="p">);</span>

	<span class="n">__blk_add_trace</span><span class="p">(</span><span class="n">bt</span><span class="p">,</span> <span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">rq</span><span class="p">),</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">rq</span><span class="p">),</span>
			<span class="n">rq_data_dir</span><span class="p">(</span><span class="n">rq</span><span class="p">),</span> <span class="n">BLK_TA_REMAP</span><span class="p">,</span> <span class="o">!!</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * blk_add_driver_data - Add binary message with driver-specific data</span>
<span class="cm"> * @q:		queue the io is for</span>
<span class="cm"> * @rq:		io request</span>
<span class="cm"> * @data:	driver-specific data</span>
<span class="cm"> * @len:	length of driver-specific data</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *     Some drivers might want to write driver-specific data per request.</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="kt">void</span> <span class="nf">blk_add_driver_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span>
			 <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">blk_trace</span> <span class="o">*</span><span class="n">bt</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">blk_trace</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">bt</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">REQ_TYPE_BLOCK_PC</span><span class="p">)</span>
		<span class="n">__blk_add_trace</span><span class="p">(</span><span class="n">bt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">rq</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">BLK_TA_DRV_DATA</span><span class="p">,</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">__blk_add_trace</span><span class="p">(</span><span class="n">bt</span><span class="p">,</span> <span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">rq</span><span class="p">),</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">rq</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">BLK_TA_DRV_DATA</span><span class="p">,</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">errors</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">blk_add_driver_data</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">blk_register_tracepoints</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_trace_block_rq_abort</span><span class="p">(</span><span class="n">blk_add_trace_rq_abort</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_trace_block_rq_insert</span><span class="p">(</span><span class="n">blk_add_trace_rq_insert</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_trace_block_rq_issue</span><span class="p">(</span><span class="n">blk_add_trace_rq_issue</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_trace_block_rq_requeue</span><span class="p">(</span><span class="n">blk_add_trace_rq_requeue</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_trace_block_rq_complete</span><span class="p">(</span><span class="n">blk_add_trace_rq_complete</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_trace_block_bio_bounce</span><span class="p">(</span><span class="n">blk_add_trace_bio_bounce</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_trace_block_bio_complete</span><span class="p">(</span><span class="n">blk_add_trace_bio_complete</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_trace_block_bio_backmerge</span><span class="p">(</span><span class="n">blk_add_trace_bio_backmerge</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_trace_block_bio_frontmerge</span><span class="p">(</span><span class="n">blk_add_trace_bio_frontmerge</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_trace_block_bio_queue</span><span class="p">(</span><span class="n">blk_add_trace_bio_queue</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_trace_block_getrq</span><span class="p">(</span><span class="n">blk_add_trace_getrq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_trace_block_sleeprq</span><span class="p">(</span><span class="n">blk_add_trace_sleeprq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_trace_block_plug</span><span class="p">(</span><span class="n">blk_add_trace_plug</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_trace_block_unplug</span><span class="p">(</span><span class="n">blk_add_trace_unplug</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_trace_block_split</span><span class="p">(</span><span class="n">blk_add_trace_split</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_trace_block_bio_remap</span><span class="p">(</span><span class="n">blk_add_trace_bio_remap</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_trace_block_rq_remap</span><span class="p">(</span><span class="n">blk_add_trace_rq_remap</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">blk_unregister_tracepoints</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unregister_trace_block_rq_remap</span><span class="p">(</span><span class="n">blk_add_trace_rq_remap</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">unregister_trace_block_bio_remap</span><span class="p">(</span><span class="n">blk_add_trace_bio_remap</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">unregister_trace_block_split</span><span class="p">(</span><span class="n">blk_add_trace_split</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">unregister_trace_block_unplug</span><span class="p">(</span><span class="n">blk_add_trace_unplug</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">unregister_trace_block_plug</span><span class="p">(</span><span class="n">blk_add_trace_plug</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">unregister_trace_block_sleeprq</span><span class="p">(</span><span class="n">blk_add_trace_sleeprq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">unregister_trace_block_getrq</span><span class="p">(</span><span class="n">blk_add_trace_getrq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">unregister_trace_block_bio_queue</span><span class="p">(</span><span class="n">blk_add_trace_bio_queue</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">unregister_trace_block_bio_frontmerge</span><span class="p">(</span><span class="n">blk_add_trace_bio_frontmerge</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">unregister_trace_block_bio_backmerge</span><span class="p">(</span><span class="n">blk_add_trace_bio_backmerge</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">unregister_trace_block_bio_complete</span><span class="p">(</span><span class="n">blk_add_trace_bio_complete</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">unregister_trace_block_bio_bounce</span><span class="p">(</span><span class="n">blk_add_trace_bio_bounce</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">unregister_trace_block_rq_complete</span><span class="p">(</span><span class="n">blk_add_trace_rq_complete</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">unregister_trace_block_rq_requeue</span><span class="p">(</span><span class="n">blk_add_trace_rq_requeue</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">unregister_trace_block_rq_issue</span><span class="p">(</span><span class="n">blk_add_trace_rq_issue</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">unregister_trace_block_rq_insert</span><span class="p">(</span><span class="n">blk_add_trace_rq_insert</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">unregister_trace_block_rq_abort</span><span class="p">(</span><span class="n">blk_add_trace_rq_abort</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">tracepoint_synchronize_unregister</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * struct blk_io_tracer formatting routines</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fill_rwbs</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">rwbs</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">blk_io_trace</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tc</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">&gt;&gt;</span> <span class="n">BLK_TC_SHIFT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">==</span> <span class="n">BLK_TN_MESSAGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rwbs</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;N&#39;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tc</span> <span class="o">&amp;</span> <span class="n">BLK_TC_FLUSH</span><span class="p">)</span>
		<span class="n">rwbs</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;F&#39;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tc</span> <span class="o">&amp;</span> <span class="n">BLK_TC_DISCARD</span><span class="p">)</span>
		<span class="n">rwbs</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;D&#39;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tc</span> <span class="o">&amp;</span> <span class="n">BLK_TC_WRITE</span><span class="p">)</span>
		<span class="n">rwbs</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;W&#39;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">)</span>
		<span class="n">rwbs</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;R&#39;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rwbs</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;N&#39;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tc</span> <span class="o">&amp;</span> <span class="n">BLK_TC_FUA</span><span class="p">)</span>
		<span class="n">rwbs</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;F&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tc</span> <span class="o">&amp;</span> <span class="n">BLK_TC_AHEAD</span><span class="p">)</span>
		<span class="n">rwbs</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;A&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tc</span> <span class="o">&amp;</span> <span class="n">BLK_TC_SYNC</span><span class="p">)</span>
		<span class="n">rwbs</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;S&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tc</span> <span class="o">&amp;</span> <span class="n">BLK_TC_META</span><span class="p">)</span>
		<span class="n">rwbs</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;M&#39;</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">rwbs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="k">const</span> <span class="k">struct</span> <span class="n">blk_io_trace</span> <span class="o">*</span><span class="nf">te_blk_io_trace</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">trace_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">blk_io_trace</span> <span class="o">*</span><span class="p">)</span><span class="n">ent</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">pdu_start</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">trace_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">te_blk_io_trace</span><span class="p">(</span><span class="n">ent</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">t_action</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">trace_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">te_blk_io_trace</span><span class="p">(</span><span class="n">ent</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">t_bytes</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">trace_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">te_blk_io_trace</span><span class="p">(</span><span class="n">ent</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">t_sec</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">trace_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">te_blk_io_trace</span><span class="p">(</span><span class="n">ent</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="nf">t_sector</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">trace_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">te_blk_io_trace</span><span class="p">(</span><span class="n">ent</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__u16</span> <span class="nf">t_error</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">trace_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">te_blk_io_trace</span><span class="p">(</span><span class="n">ent</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__u64</span> <span class="nf">get_pdu_int</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">trace_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">__u64</span> <span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">pdu_start</span><span class="p">(</span><span class="n">ent</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_pdu_remap</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">trace_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">blk_io_trace_remap</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">blk_io_trace_remap</span> <span class="o">*</span><span class="n">__r</span> <span class="o">=</span> <span class="n">pdu_start</span><span class="p">(</span><span class="n">ent</span><span class="p">);</span>
	<span class="n">__u64</span> <span class="n">sector_from</span> <span class="o">=</span> <span class="n">__r</span><span class="o">-&gt;</span><span class="n">sector_from</span><span class="p">;</span>

	<span class="n">r</span><span class="o">-&gt;</span><span class="n">device_from</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">__r</span><span class="o">-&gt;</span><span class="n">device_from</span><span class="p">);</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">device_to</span>   <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">__r</span><span class="o">-&gt;</span><span class="n">device_to</span><span class="p">);</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">sector_from</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">sector_from</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">typedef</span> <span class="kt">int</span> <span class="p">(</span><span class="n">blk_log_action_t</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">trace_iterator</span> <span class="o">*</span><span class="n">iter</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">act</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">blk_log_action_classic</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_iterator</span> <span class="o">*</span><span class="n">iter</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">act</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">rwbs</span><span class="p">[</span><span class="n">RWBS_LEN</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">ts</span>  <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">ts</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nsec_rem</span> <span class="o">=</span> <span class="n">do_div</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">NSEC_PER_SEC</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">secs</span>	       <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ts</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">blk_io_trace</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">te_blk_io_trace</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">ent</span><span class="p">);</span>

	<span class="n">fill_rwbs</span><span class="p">(</span><span class="n">rwbs</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">,</span>
				<span class="s">&quot;%3d,%-3d %2d %5d.%09lu %5u %2s %3s &quot;</span><span class="p">,</span>
				<span class="n">MAJOR</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">),</span> <span class="n">MINOR</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">),</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">,</span>
				<span class="n">secs</span><span class="p">,</span> <span class="n">nsec_rem</span><span class="p">,</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">act</span><span class="p">,</span> <span class="n">rwbs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">blk_log_action</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_iterator</span> <span class="o">*</span><span class="n">iter</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">act</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">rwbs</span><span class="p">[</span><span class="n">RWBS_LEN</span><span class="p">];</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">blk_io_trace</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">te_blk_io_trace</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">ent</span><span class="p">);</span>

	<span class="n">fill_rwbs</span><span class="p">(</span><span class="n">rwbs</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;%3d,%-3d %2s %3s &quot;</span><span class="p">,</span>
				<span class="n">MAJOR</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">),</span> <span class="n">MINOR</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">),</span> <span class="n">act</span><span class="p">,</span> <span class="n">rwbs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">blk_log_dump_pdu</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">trace_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pdu_buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pdu_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pdu_buf</span> <span class="o">=</span> <span class="n">pdu_start</span><span class="p">(</span><span class="n">ent</span><span class="p">);</span>
	<span class="n">pdu_len</span> <span class="o">=</span> <span class="n">te_blk_io_trace</span><span class="p">(</span><span class="n">ent</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pdu_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdu_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* find the last zero that needs to be printed */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">end</span> <span class="o">=</span> <span class="n">pdu_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">end</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">end</span><span class="o">--</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdu_buf</span><span class="p">[</span><span class="n">end</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="n">end</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">trace_seq_putc</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="sc">&#39;(&#39;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pdu_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%s%02x&quot;</span><span class="p">,</span>
				       <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="n">pdu_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * stop when the rest is just zeroes and indicate so</span>
<span class="cm">		 * with a &quot;..&quot; appended</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">end</span> <span class="o">&amp;&amp;</span> <span class="n">end</span> <span class="o">!=</span> <span class="n">pdu_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">trace_seq_puts</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot; ..) &quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">trace_seq_puts</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;) &quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">blk_log_generic</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">trace_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="n">TASK_COMM_LEN</span><span class="p">];</span>

	<span class="n">trace_find_cmdline</span><span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t_action</span><span class="p">(</span><span class="n">ent</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BLK_TC_ACT</span><span class="p">(</span><span class="n">BLK_TC_PC</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%u &quot;</span><span class="p">,</span> <span class="n">t_bytes</span><span class="p">(</span><span class="n">ent</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">blk_log_dump_pdu</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ent</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;[%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t_sec</span><span class="p">(</span><span class="n">ent</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%llu + %u [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">t_sector</span><span class="p">(</span><span class="n">ent</span><span class="p">),</span> <span class="n">t_sec</span><span class="p">(</span><span class="n">ent</span><span class="p">),</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;[%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">blk_log_with_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">trace_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t_action</span><span class="p">(</span><span class="n">ent</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BLK_TC_ACT</span><span class="p">(</span><span class="n">BLK_TC_PC</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">blk_log_dump_pdu</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ent</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">t_error</span><span class="p">(</span><span class="n">ent</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t_sec</span><span class="p">(</span><span class="n">ent</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%llu + %u [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">t_sector</span><span class="p">(</span><span class="n">ent</span><span class="p">),</span>
						<span class="n">t_sec</span><span class="p">(</span><span class="n">ent</span><span class="p">),</span> <span class="n">t_error</span><span class="p">(</span><span class="n">ent</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%llu [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">t_sector</span><span class="p">(</span><span class="n">ent</span><span class="p">),</span> <span class="n">t_error</span><span class="p">(</span><span class="n">ent</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">blk_log_remap</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">trace_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">blk_io_trace_remap</span> <span class="n">r</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">device_from</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">};</span>

	<span class="n">get_pdu_remap</span><span class="p">(</span><span class="n">ent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%llu + %u &lt;- (%d,%d) %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">t_sector</span><span class="p">(</span><span class="n">ent</span><span class="p">),</span> <span class="n">t_sec</span><span class="p">(</span><span class="n">ent</span><span class="p">),</span>
				<span class="n">MAJOR</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">device_from</span><span class="p">),</span> <span class="n">MINOR</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">device_from</span><span class="p">),</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">r</span><span class="p">.</span><span class="n">sector_from</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">blk_log_plug</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">trace_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="n">TASK_COMM_LEN</span><span class="p">];</span>

	<span class="n">trace_find_cmdline</span><span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;[%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">blk_log_unplug</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">trace_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="n">TASK_COMM_LEN</span><span class="p">];</span>

	<span class="n">trace_find_cmdline</span><span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;[%s] %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">get_pdu_int</span><span class="p">(</span><span class="n">ent</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">blk_log_split</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">trace_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="n">TASK_COMM_LEN</span><span class="p">];</span>

	<span class="n">trace_find_cmdline</span><span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%llu / %llu [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">t_sector</span><span class="p">(</span><span class="n">ent</span><span class="p">),</span>
				<span class="n">get_pdu_int</span><span class="p">(</span><span class="n">ent</span><span class="p">),</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">blk_log_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">trace_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">blk_io_trace</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">te_blk_io_trace</span><span class="p">(</span><span class="n">ent</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_putmem</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">pdu_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">trace_seq_putc</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * struct tracer operations</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">blk_tracer_print_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">blk_tracer_flags</span><span class="p">.</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">TRACE_BLK_OPT_CLASSIC</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;# DEV   CPU TIMESTAMP     PID ACT FLG</span><span class="se">\n</span><span class="s">&quot;</span>
		    <span class="s">&quot;#  |     |     |           |   |   |</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">blk_tracer_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_array</span> <span class="o">*</span><span class="n">tr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">blk_tracer_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">blk_tracer_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_array</span> <span class="o">*</span><span class="n">tr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">blk_tr</span> <span class="o">=</span> <span class="n">tr</span><span class="p">;</span>
	<span class="n">blk_tracer_start</span><span class="p">(</span><span class="n">tr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">blk_tracer_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_array</span> <span class="o">*</span><span class="n">tr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">blk_tracer_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">blk_tracer_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_array</span> <span class="o">*</span><span class="n">tr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">blk_tracer_stop</span><span class="p">(</span><span class="n">tr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">act</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span>	   <span class="p">(</span><span class="o">*</span><span class="n">print</span><span class="p">)(</span><span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">trace_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">);</span>
<span class="p">}</span> <span class="n">what2act</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">__BLK_TA_QUEUE</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{{</span>  <span class="s">&quot;Q&quot;</span><span class="p">,</span> <span class="s">&quot;queue&quot;</span> <span class="p">},</span>	   <span class="n">blk_log_generic</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">__BLK_TA_BACKMERGE</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{{</span>  <span class="s">&quot;M&quot;</span><span class="p">,</span> <span class="s">&quot;backmerge&quot;</span> <span class="p">},</span>  <span class="n">blk_log_generic</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">__BLK_TA_FRONTMERGE</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{{</span>  <span class="s">&quot;F&quot;</span><span class="p">,</span> <span class="s">&quot;frontmerge&quot;</span> <span class="p">},</span> <span class="n">blk_log_generic</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">__BLK_TA_GETRQ</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{{</span>  <span class="s">&quot;G&quot;</span><span class="p">,</span> <span class="s">&quot;getrq&quot;</span> <span class="p">},</span>	   <span class="n">blk_log_generic</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">__BLK_TA_SLEEPRQ</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{{</span>  <span class="s">&quot;S&quot;</span><span class="p">,</span> <span class="s">&quot;sleeprq&quot;</span> <span class="p">},</span>	   <span class="n">blk_log_generic</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">__BLK_TA_REQUEUE</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{{</span>  <span class="s">&quot;R&quot;</span><span class="p">,</span> <span class="s">&quot;requeue&quot;</span> <span class="p">},</span>	   <span class="n">blk_log_with_error</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">__BLK_TA_ISSUE</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{{</span>  <span class="s">&quot;D&quot;</span><span class="p">,</span> <span class="s">&quot;issue&quot;</span> <span class="p">},</span>	   <span class="n">blk_log_generic</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">__BLK_TA_COMPLETE</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{{</span>  <span class="s">&quot;C&quot;</span><span class="p">,</span> <span class="s">&quot;complete&quot;</span> <span class="p">},</span>   <span class="n">blk_log_with_error</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">__BLK_TA_PLUG</span><span class="p">]</span>		<span class="o">=</span> <span class="p">{{</span>  <span class="s">&quot;P&quot;</span><span class="p">,</span> <span class="s">&quot;plug&quot;</span> <span class="p">},</span>	   <span class="n">blk_log_plug</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">__BLK_TA_UNPLUG_IO</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{{</span>  <span class="s">&quot;U&quot;</span><span class="p">,</span> <span class="s">&quot;unplug_io&quot;</span> <span class="p">},</span>  <span class="n">blk_log_unplug</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">__BLK_TA_UNPLUG_TIMER</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{{</span> <span class="s">&quot;UT&quot;</span><span class="p">,</span> <span class="s">&quot;unplug_timer&quot;</span> <span class="p">},</span> <span class="n">blk_log_unplug</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">__BLK_TA_INSERT</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{{</span>  <span class="s">&quot;I&quot;</span><span class="p">,</span> <span class="s">&quot;insert&quot;</span> <span class="p">},</span>	   <span class="n">blk_log_generic</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">__BLK_TA_SPLIT</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{{</span>  <span class="s">&quot;X&quot;</span><span class="p">,</span> <span class="s">&quot;split&quot;</span> <span class="p">},</span>	   <span class="n">blk_log_split</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">__BLK_TA_BOUNCE</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{{</span>  <span class="s">&quot;B&quot;</span><span class="p">,</span> <span class="s">&quot;bounce&quot;</span> <span class="p">},</span>	   <span class="n">blk_log_generic</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">__BLK_TA_REMAP</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{{</span>  <span class="s">&quot;A&quot;</span><span class="p">,</span> <span class="s">&quot;remap&quot;</span> <span class="p">},</span>	   <span class="n">blk_log_remap</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">print_line_t</span> <span class="nf">print_one_line</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_iterator</span> <span class="o">*</span><span class="n">iter</span><span class="p">,</span>
					<span class="n">bool</span> <span class="n">classic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">blk_io_trace</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">what</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">long_act</span><span class="p">;</span>
	<span class="n">blk_log_action_t</span> <span class="o">*</span><span class="n">log_action</span><span class="p">;</span>

	<span class="n">t</span>	   <span class="o">=</span> <span class="n">te_blk_io_trace</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">ent</span><span class="p">);</span>
	<span class="n">what</span>	   <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BLK_TC_SHIFT</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">long_act</span>   <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">trace_flags</span> <span class="o">&amp;</span> <span class="n">TRACE_ITER_VERBOSE</span><span class="p">);</span>
	<span class="n">log_action</span> <span class="o">=</span> <span class="n">classic</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">blk_log_action_classic</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">blk_log_action</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">==</span> <span class="n">BLK_TN_MESSAGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">log_action</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">long_act</span> <span class="o">?</span> <span class="s">&quot;message&quot;</span> <span class="o">:</span> <span class="s">&quot;m&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">blk_log_msg</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">ent</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">what</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">what</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">what2act</span><span class="p">)))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">trace_seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;Unknown action %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">what</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">log_action</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">what2act</span><span class="p">[</span><span class="n">what</span><span class="p">].</span><span class="n">act</span><span class="p">[</span><span class="n">long_act</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">what2act</span><span class="p">[</span><span class="n">what</span><span class="p">].</span><span class="n">print</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">ent</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="n">TRACE_TYPE_HANDLED</span> <span class="o">:</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">print_line_t</span> <span class="nf">blk_trace_event_print</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_iterator</span> <span class="o">*</span><span class="n">iter</span><span class="p">,</span>
					       <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="k">struct</span> <span class="n">trace_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">print_one_line</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">blk_trace_synthesize_old_trace</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_iterator</span> <span class="o">*</span><span class="n">iter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">trace_seq</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">blk_io_trace</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">blk_io_trace</span> <span class="o">*</span><span class="p">)</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">ent</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">blk_io_trace</span><span class="p">,</span> <span class="n">sector</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">blk_io_trace</span> <span class="n">old</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">magic</span>	  <span class="o">=</span> <span class="n">BLK_IO_TRACE_MAGIC</span> <span class="o">|</span> <span class="n">BLK_IO_TRACE_VERSION</span><span class="p">,</span>
		<span class="p">.</span><span class="n">time</span>     <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">ts</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">trace_seq_putmem</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old</span><span class="p">,</span> <span class="n">offset</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">trace_seq_putmem</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">sector</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">old</span><span class="p">)</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">pdu_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">print_line_t</span>
<span class="nf">blk_trace_event_print_binary</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_iterator</span> <span class="o">*</span><span class="n">iter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">trace_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">blk_trace_synthesize_old_trace</span><span class="p">(</span><span class="n">iter</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">TRACE_TYPE_HANDLED</span> <span class="o">:</span> <span class="n">TRACE_TYPE_PARTIAL_LINE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">print_line_t</span> <span class="nf">blk_tracer_print_line</span><span class="p">(</span><span class="k">struct</span> <span class="n">trace_iterator</span> <span class="o">*</span><span class="n">iter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">blk_tracer_flags</span><span class="p">.</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">TRACE_BLK_OPT_CLASSIC</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">TRACE_TYPE_UNHANDLED</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">print_one_line</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">blk_tracer_set_flag</span><span class="p">(</span><span class="n">u32</span> <span class="n">old_flags</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bit</span><span class="p">,</span> <span class="kt">int</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* don&#39;t output context-info for blk_classic output */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bit</span> <span class="o">==</span> <span class="n">TRACE_BLK_OPT_CLASSIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="p">)</span>
			<span class="n">trace_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TRACE_ITER_CONTEXT_INFO</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">trace_flags</span> <span class="o">|=</span> <span class="n">TRACE_ITER_CONTEXT_INFO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tracer</span> <span class="n">blk_tracer</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;blk&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">blk_tracer_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset</span>		<span class="o">=</span> <span class="n">blk_tracer_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span>		<span class="o">=</span> <span class="n">blk_tracer_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>		<span class="o">=</span> <span class="n">blk_tracer_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">print_header</span>	<span class="o">=</span> <span class="n">blk_tracer_print_header</span><span class="p">,</span>
	<span class="p">.</span><span class="n">print_line</span>	<span class="o">=</span> <span class="n">blk_tracer_print_line</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">blk_tracer_flags</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_flag</span>	<span class="o">=</span> <span class="n">blk_tracer_set_flag</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">trace_event_functions</span> <span class="n">trace_blk_event_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">trace</span>		<span class="o">=</span> <span class="n">blk_trace_event_print</span><span class="p">,</span>
	<span class="p">.</span><span class="n">binary</span>		<span class="o">=</span> <span class="n">blk_trace_event_print_binary</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">trace_event</span> <span class="n">trace_blk_event</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">TRACE_BLK</span><span class="p">,</span>
	<span class="p">.</span><span class="n">funcs</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">trace_blk_event_funcs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_blk_tracer</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">register_ftrace_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trace_blk_event</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Warning: could not register block events</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">register_tracer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">blk_tracer</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Warning: could not register the block tracer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">unregister_ftrace_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trace_blk_event</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">device_initcall</span><span class="p">(</span><span class="n">init_blk_tracer</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">blk_trace_remove_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">blk_trace</span> <span class="o">*</span><span class="n">bt</span><span class="p">;</span>

	<span class="n">bt</span> <span class="o">=</span> <span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">blk_trace</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">blk_probes_ref</span><span class="p">))</span>
		<span class="n">blk_unregister_tracepoints</span><span class="p">();</span>

	<span class="n">blk_trace_free</span><span class="p">(</span><span class="n">bt</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Setup everything required to start tracing</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">blk_trace_setup_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">blk_trace</span> <span class="o">*</span><span class="n">old_bt</span><span class="p">,</span> <span class="o">*</span><span class="n">bt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">bt</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bt</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bt</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">bt</span><span class="o">-&gt;</span><span class="n">msg_data</span> <span class="o">=</span> <span class="n">__alloc_percpu</span><span class="p">(</span><span class="n">BLK_TN_MAX_MSG</span><span class="p">,</span> <span class="n">__alignof__</span><span class="p">(</span><span class="kt">char</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">msg_data</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_bt</span><span class="p">;</span>

	<span class="n">bt</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_dev</span><span class="p">;</span>
	<span class="n">bt</span><span class="o">-&gt;</span><span class="n">act_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">blk_trace_setup_lba</span><span class="p">(</span><span class="n">bt</span><span class="p">,</span> <span class="n">bdev</span><span class="p">);</span>

	<span class="n">old_bt</span> <span class="o">=</span> <span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">blk_trace</span><span class="p">,</span> <span class="n">bt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_bt</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">blk_trace</span><span class="p">,</span> <span class="n">old_bt</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_bt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">blk_probes_ref</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">blk_register_tracepoints</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">free_bt:</span>
	<span class="n">blk_trace_free</span><span class="p">(</span><span class="n">bt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * sysfs interface to enable and configure tracing</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">sysfs_blk_trace_attr_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">sysfs_blk_trace_attr_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">);</span>
<span class="cp">#define BLK_TRACE_DEVICE_ATTR(_name) \</span>
<span class="cp">	DEVICE_ATTR(_name, S_IRUGO | S_IWUSR, \</span>
<span class="cp">		    sysfs_blk_trace_attr_show, \</span>
<span class="cp">		    sysfs_blk_trace_attr_store)</span>

<span class="k">static</span> <span class="n">BLK_TRACE_DEVICE_ATTR</span><span class="p">(</span><span class="n">enable</span><span class="p">);</span>
<span class="k">static</span> <span class="n">BLK_TRACE_DEVICE_ATTR</span><span class="p">(</span><span class="n">act_mask</span><span class="p">);</span>
<span class="k">static</span> <span class="n">BLK_TRACE_DEVICE_ATTR</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>
<span class="k">static</span> <span class="n">BLK_TRACE_DEVICE_ATTR</span><span class="p">(</span><span class="n">start_lba</span><span class="p">);</span>
<span class="k">static</span> <span class="n">BLK_TRACE_DEVICE_ATTR</span><span class="p">(</span><span class="n">end_lba</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">blk_trace_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_enable</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_act_mask</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_pid</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_start_lba</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_end_lba</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">blk_trace_attr_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;trace&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">blk_trace_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
<span class="p">}</span> <span class="n">mask_maps</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">BLK_TC_READ</span><span class="p">,</span>		<span class="s">&quot;read&quot;</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">BLK_TC_WRITE</span><span class="p">,</span>		<span class="s">&quot;write&quot;</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">BLK_TC_FLUSH</span><span class="p">,</span>		<span class="s">&quot;flush&quot;</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">BLK_TC_SYNC</span><span class="p">,</span>		<span class="s">&quot;sync&quot;</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">BLK_TC_QUEUE</span><span class="p">,</span>		<span class="s">&quot;queue&quot;</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">BLK_TC_REQUEUE</span><span class="p">,</span>	<span class="s">&quot;requeue&quot;</span>	<span class="p">},</span>
	<span class="p">{</span> <span class="n">BLK_TC_ISSUE</span><span class="p">,</span>		<span class="s">&quot;issue&quot;</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">BLK_TC_COMPLETE</span><span class="p">,</span>	<span class="s">&quot;complete&quot;</span>	<span class="p">},</span>
	<span class="p">{</span> <span class="n">BLK_TC_FS</span><span class="p">,</span>		<span class="s">&quot;fs&quot;</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">BLK_TC_PC</span><span class="p">,</span>		<span class="s">&quot;pc&quot;</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">BLK_TC_AHEAD</span><span class="p">,</span>		<span class="s">&quot;ahead&quot;</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">BLK_TC_META</span><span class="p">,</span>		<span class="s">&quot;meta&quot;</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">BLK_TC_DISCARD</span><span class="p">,</span>	<span class="s">&quot;discard&quot;</span>	<span class="p">},</span>
	<span class="p">{</span> <span class="n">BLK_TC_DRV_DATA</span><span class="p">,</span>	<span class="s">&quot;drv_data&quot;</span>	<span class="p">},</span>
	<span class="p">{</span> <span class="n">BLK_TC_FUA</span><span class="p">,</span>		<span class="s">&quot;fua&quot;</span>		<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">blk_trace_str2mask</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">token</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">strstrip</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">token</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mask_maps</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">mask_maps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">str</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mask</span> <span class="o">|=</span> <span class="n">mask_maps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mask_maps</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">blk_trace_mask2str</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mask_maps</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">mask_maps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;%s%s&quot;</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">buf</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;,&quot;</span><span class="p">,</span> <span class="n">mask_maps</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">str</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">p</span> <span class="o">-</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="nf">blk_trace_get_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">bdev_get_queue</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sysfs_blk_trace_attr_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hd_struct</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev_to_part</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">bdev</span> <span class="o">=</span> <span class="n">bdget</span><span class="p">(</span><span class="n">part_devt</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">q</span> <span class="o">=</span> <span class="n">blk_trace_get_queue</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_bdput</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">dev_attr_enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">!!</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">blk_trace</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unlock_bdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">blk_trace</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">dev_attr_act_mask</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">blk_trace_mask2str</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">blk_trace</span><span class="o">-&gt;</span><span class="n">act_mask</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">dev_attr_pid</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">blk_trace</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">dev_attr_start_lba</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">blk_trace</span><span class="o">-&gt;</span><span class="n">start_lba</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">dev_attr_end_lba</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">blk_trace</span><span class="o">-&gt;</span><span class="n">end_lba</span><span class="p">);</span>

<span class="nl">out_unlock_bdev:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_mutex</span><span class="p">);</span>
<span class="nl">out_bdput:</span>
	<span class="n">bdput</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sysfs_blk_trace_attr_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hd_struct</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">dev_attr_act_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%llx&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Assume it is a list of trace category names */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">blk_trace_str2mask</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%llu&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">dev_to_part</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">bdev</span> <span class="o">=</span> <span class="n">bdget</span><span class="p">(</span><span class="n">part_devt</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">q</span> <span class="o">=</span> <span class="n">blk_trace_get_queue</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_bdput</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">dev_attr_enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">blk_trace_setup_queue</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">bdev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">blk_trace_remove_queue</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unlock_bdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">blk_trace</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">blk_trace_setup_queue</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">bdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">dev_attr_act_mask</span><span class="p">)</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">blk_trace</span><span class="o">-&gt;</span><span class="n">act_mask</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">dev_attr_pid</span><span class="p">)</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">blk_trace</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">dev_attr_start_lba</span><span class="p">)</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">blk_trace</span><span class="o">-&gt;</span><span class="n">start_lba</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">dev_attr_end_lba</span><span class="p">)</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">blk_trace</span><span class="o">-&gt;</span><span class="n">end_lba</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out_unlock_bdev:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_mutex</span><span class="p">);</span>
<span class="nl">out_bdput:</span>
	<span class="n">bdput</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">blk_trace_init_sysfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blk_trace_attr_group</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">blk_trace_remove_sysfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blk_trace_attr_group</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_BLK_DEV_IO_TRACE */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_EVENT_TRACING</span>

<span class="kt">void</span> <span class="nf">blk_dump_cmd</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">!=</span> <span class="n">REQ_TYPE_BLOCK_PC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">end</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">end</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">end</span><span class="o">--</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="n">end</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="n">end</span><span class="o">++</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s%02x&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">end</span> <span class="o">&amp;&amp;</span> <span class="n">end</span> <span class="o">!=</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot; ..&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">blk_fill_rwbs</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">rwbs</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rw</span> <span class="o">&amp;</span> <span class="n">REQ_FLUSH</span><span class="p">)</span>
		<span class="n">rwbs</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;F&#39;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rw</span> <span class="o">&amp;</span> <span class="n">WRITE</span><span class="p">)</span>
		<span class="n">rwbs</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;W&#39;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rw</span> <span class="o">&amp;</span> <span class="n">REQ_DISCARD</span><span class="p">)</span>
		<span class="n">rwbs</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;D&#39;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bytes</span><span class="p">)</span>
		<span class="n">rwbs</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;R&#39;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rwbs</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;N&#39;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rw</span> <span class="o">&amp;</span> <span class="n">REQ_FUA</span><span class="p">)</span>
		<span class="n">rwbs</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;F&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rw</span> <span class="o">&amp;</span> <span class="n">REQ_RAHEAD</span><span class="p">)</span>
		<span class="n">rwbs</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;A&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rw</span> <span class="o">&amp;</span> <span class="n">REQ_SYNC</span><span class="p">)</span>
		<span class="n">rwbs</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;S&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rw</span> <span class="o">&amp;</span> <span class="n">REQ_META</span><span class="p">)</span>
		<span class="n">rwbs</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;M&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rw</span> <span class="o">&amp;</span> <span class="n">REQ_SECURE</span><span class="p">)</span>
		<span class="n">rwbs</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;E&#39;</span><span class="p">;</span>

	<span class="n">rwbs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_EVENT_TRACING */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
