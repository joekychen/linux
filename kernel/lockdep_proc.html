<!DOCTYPE html>
<html><head><title>joekychen/linux » kernel › lockdep_proc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../index.html"></a><h1>lockdep_proc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * kernel/lockdep_proc.c</span>
<span class="cm"> *</span>
<span class="cm"> * Runtime locking correctness validator</span>
<span class="cm"> *</span>
<span class="cm"> * Started by Ingo Molnar:</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2006,2007 Red Hat, Inc., Ingo Molnar &lt;mingo@redhat.com&gt;</span>
<span class="cm"> *  Copyright (C) 2007 Red Hat, Inc., Peter Zijlstra &lt;pzijlstr@redhat.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Code for /proc/lockdep and /proc/lockdep_stats:</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/kallsyms.h&gt;</span>
<span class="cp">#include &lt;linux/debug_locks.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/sort.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/div64.h&gt;</span>

<span class="cp">#include &quot;lockdep_internals.h&quot;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">l_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">seq_list_next</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">all_lock_classes</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">l_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">seq_list_start_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">all_lock_classes</span><span class="p">,</span> <span class="o">*</span><span class="n">pos</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">l_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lock_class</span> <span class="o">*</span><span class="n">class</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">str</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">class</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">__get_key_name</span><span class="p">(</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span><span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">name_version</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;#%d&quot;</span><span class="p">,</span> <span class="n">class</span><span class="o">-&gt;</span><span class="n">name_version</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">subclass</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;/%d&quot;</span><span class="p">,</span> <span class="n">class</span><span class="o">-&gt;</span><span class="n">subclass</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">l_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lock_class</span> <span class="o">*</span><span class="n">class</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lock_class</span><span class="p">,</span> <span class="n">lock_entry</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lock_list</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">usage</span><span class="p">[</span><span class="n">LOCK_USAGE_CHARS</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">all_lock_classes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;all lock classes:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%p&quot;</span><span class="p">,</span> <span class="n">class</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_DEBUG_LOCKDEP</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; OPS:%8ld&quot;</span><span class="p">,</span> <span class="n">class</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_PROVE_LOCKING</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; FD:%5ld&quot;</span><span class="p">,</span> <span class="n">lockdep_count_forward_deps</span><span class="p">(</span><span class="n">class</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; BD:%5ld&quot;</span><span class="p">,</span> <span class="n">lockdep_count_backward_deps</span><span class="p">(</span><span class="n">class</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="n">get_usage_chars</span><span class="p">(</span><span class="n">class</span><span class="p">,</span> <span class="n">usage</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">usage</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;: &quot;</span><span class="p">);</span>
	<span class="n">print_name</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">class</span><span class="p">);</span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">locks_after</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">distance</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; -&gt; [%p] &quot;</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">);</span>
			<span class="n">print_name</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">);</span>
			<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">lockdep_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">l_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>	<span class="o">=</span> <span class="n">l_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>	<span class="o">=</span> <span class="n">l_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>	<span class="o">=</span> <span class="n">l_show</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lockdep_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">seq_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lockdep_ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">proc_lockdep_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">lockdep_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">seq_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_PROVE_LOCKING</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">lc_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SEQ_START_TOKEN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">nr_lock_chains</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">lock_chains</span> <span class="o">+</span> <span class="p">(</span><span class="o">*</span><span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">lc_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">lc_start</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lc_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lock_chain</span> <span class="o">*</span><span class="n">chain</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lock_class</span> <span class="o">*</span><span class="n">class</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">SEQ_START_TOKEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;all lock chains:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;irq_context: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">irq_context</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">class</span> <span class="o">=</span> <span class="n">lock_chain_get_class</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;[%p] &quot;</span><span class="p">,</span> <span class="n">class</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">);</span>
		<span class="n">print_name</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">class</span><span class="p">);</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">lockdep_chains_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">lc_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>	<span class="o">=</span> <span class="n">lc_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>	<span class="o">=</span> <span class="n">lc_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>	<span class="o">=</span> <span class="n">lc_show</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lockdep_chains_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">seq_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lockdep_chains_ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">proc_lockdep_chains_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">lockdep_chains_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">seq_release</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PROVE_LOCKING */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lockdep_stats_debug_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_DEBUG_LOCKDEP</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">hi1</span> <span class="o">=</span> <span class="n">debug_atomic_read</span><span class="p">(</span><span class="n">hardirqs_on_events</span><span class="p">),</span>
			   <span class="n">hi2</span> <span class="o">=</span> <span class="n">debug_atomic_read</span><span class="p">(</span><span class="n">hardirqs_off_events</span><span class="p">),</span>
			   <span class="n">hr1</span> <span class="o">=</span> <span class="n">debug_atomic_read</span><span class="p">(</span><span class="n">redundant_hardirqs_on</span><span class="p">),</span>
			   <span class="n">hr2</span> <span class="o">=</span> <span class="n">debug_atomic_read</span><span class="p">(</span><span class="n">redundant_hardirqs_off</span><span class="p">),</span>
			   <span class="n">si1</span> <span class="o">=</span> <span class="n">debug_atomic_read</span><span class="p">(</span><span class="n">softirqs_on_events</span><span class="p">),</span>
			   <span class="n">si2</span> <span class="o">=</span> <span class="n">debug_atomic_read</span><span class="p">(</span><span class="n">softirqs_off_events</span><span class="p">),</span>
			   <span class="n">sr1</span> <span class="o">=</span> <span class="n">debug_atomic_read</span><span class="p">(</span><span class="n">redundant_softirqs_on</span><span class="p">),</span>
			   <span class="n">sr2</span> <span class="o">=</span> <span class="n">debug_atomic_read</span><span class="p">(</span><span class="n">redundant_softirqs_off</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; chain lookup misses:           %11llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">debug_atomic_read</span><span class="p">(</span><span class="n">chain_lookup_misses</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; chain lookup hits:             %11llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">debug_atomic_read</span><span class="p">(</span><span class="n">chain_lookup_hits</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; cyclic checks:                 %11llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">debug_atomic_read</span><span class="p">(</span><span class="n">nr_cyclic_checks</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; find-mask forwards checks:     %11llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">debug_atomic_read</span><span class="p">(</span><span class="n">nr_find_usage_forwards_checks</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; find-mask backwards checks:    %11llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">debug_atomic_read</span><span class="p">(</span><span class="n">nr_find_usage_backwards_checks</span><span class="p">));</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; hardirq on events:             %11llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hi1</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; hardirq off events:            %11llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hi2</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; redundant hardirq ons:         %11llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hr1</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; redundant hardirq offs:        %11llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hr2</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; softirq on events:             %11llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">si1</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; softirq off events:            %11llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">si2</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; redundant softirq ons:         %11llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sr1</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; redundant softirq offs:        %11llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sr2</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lockdep_stats_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lock_class</span> <span class="o">*</span><span class="n">class</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr_unused</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nr_uncategorized</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		      <span class="n">nr_irq_safe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nr_irq_unsafe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		      <span class="n">nr_softirq_safe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nr_softirq_unsafe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		      <span class="n">nr_hardirq_safe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nr_hardirq_unsafe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		      <span class="n">nr_irq_read_safe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nr_irq_read_unsafe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		      <span class="n">nr_softirq_read_safe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nr_softirq_read_unsafe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		      <span class="n">nr_hardirq_read_safe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nr_hardirq_read_unsafe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		      <span class="n">sum_forward_deps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">class</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">all_lock_classes</span><span class="p">,</span> <span class="n">lock_entry</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">usage_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">nr_unused</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">usage_mask</span> <span class="o">==</span> <span class="n">LOCKF_USED</span><span class="p">)</span>
			<span class="n">nr_uncategorized</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">usage_mask</span> <span class="o">&amp;</span> <span class="n">LOCKF_USED_IN_IRQ</span><span class="p">)</span>
			<span class="n">nr_irq_safe</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">usage_mask</span> <span class="o">&amp;</span> <span class="n">LOCKF_ENABLED_IRQ</span><span class="p">)</span>
			<span class="n">nr_irq_unsafe</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">usage_mask</span> <span class="o">&amp;</span> <span class="n">LOCKF_USED_IN_SOFTIRQ</span><span class="p">)</span>
			<span class="n">nr_softirq_safe</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">usage_mask</span> <span class="o">&amp;</span> <span class="n">LOCKF_ENABLED_SOFTIRQ</span><span class="p">)</span>
			<span class="n">nr_softirq_unsafe</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">usage_mask</span> <span class="o">&amp;</span> <span class="n">LOCKF_USED_IN_HARDIRQ</span><span class="p">)</span>
			<span class="n">nr_hardirq_safe</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">usage_mask</span> <span class="o">&amp;</span> <span class="n">LOCKF_ENABLED_HARDIRQ</span><span class="p">)</span>
			<span class="n">nr_hardirq_unsafe</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">usage_mask</span> <span class="o">&amp;</span> <span class="n">LOCKF_USED_IN_IRQ_READ</span><span class="p">)</span>
			<span class="n">nr_irq_read_safe</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">usage_mask</span> <span class="o">&amp;</span> <span class="n">LOCKF_ENABLED_IRQ_READ</span><span class="p">)</span>
			<span class="n">nr_irq_read_unsafe</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">usage_mask</span> <span class="o">&amp;</span> <span class="n">LOCKF_USED_IN_SOFTIRQ_READ</span><span class="p">)</span>
			<span class="n">nr_softirq_read_safe</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">usage_mask</span> <span class="o">&amp;</span> <span class="n">LOCKF_ENABLED_SOFTIRQ_READ</span><span class="p">)</span>
			<span class="n">nr_softirq_read_unsafe</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">usage_mask</span> <span class="o">&amp;</span> <span class="n">LOCKF_USED_IN_HARDIRQ_READ</span><span class="p">)</span>
			<span class="n">nr_hardirq_read_safe</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">usage_mask</span> <span class="o">&amp;</span> <span class="n">LOCKF_ENABLED_HARDIRQ_READ</span><span class="p">)</span>
			<span class="n">nr_hardirq_read_unsafe</span><span class="o">++</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PROVE_LOCKING</span>
		<span class="n">sum_forward_deps</span> <span class="o">+=</span> <span class="n">lockdep_count_forward_deps</span><span class="p">(</span><span class="n">class</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_DEBUG_LOCKDEP</span>
	<span class="n">DEBUG_LOCKS_WARN_ON</span><span class="p">(</span><span class="n">debug_atomic_read</span><span class="p">(</span><span class="n">nr_unused_locks</span><span class="p">)</span> <span class="o">!=</span> <span class="n">nr_unused</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; lock-classes:                  %11lu [max: %lu]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nr_lock_classes</span><span class="p">,</span> <span class="n">MAX_LOCKDEP_KEYS</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; direct dependencies:           %11lu [max: %lu]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nr_list_entries</span><span class="p">,</span> <span class="n">MAX_LOCKDEP_ENTRIES</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; indirect dependencies:         %11lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sum_forward_deps</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Total number of dependencies:</span>
<span class="cm">	 *</span>
<span class="cm">	 * All irq-safe locks may nest inside irq-unsafe locks,</span>
<span class="cm">	 * plus all the other known dependencies:</span>
<span class="cm">	 */</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; all direct dependencies:       %11lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nr_irq_unsafe</span> <span class="o">*</span> <span class="n">nr_irq_safe</span> <span class="o">+</span>
			<span class="n">nr_hardirq_unsafe</span> <span class="o">*</span> <span class="n">nr_hardirq_safe</span> <span class="o">+</span>
			<span class="n">nr_list_entries</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PROVE_LOCKING</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; dependency chains:             %11lu [max: %lu]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nr_lock_chains</span><span class="p">,</span> <span class="n">MAX_LOCKDEP_CHAINS</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; dependency chain hlocks:       %11d [max: %lu]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nr_chain_hlocks</span><span class="p">,</span> <span class="n">MAX_LOCKDEP_CHAIN_HLOCKS</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TRACE_IRQFLAGS</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; in-hardirq chains:             %11u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nr_hardirq_chains</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; in-softirq chains:             %11u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nr_softirq_chains</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; in-process chains:             %11u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nr_process_chains</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; stack-trace entries:           %11lu [max: %lu]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nr_stack_trace_entries</span><span class="p">,</span> <span class="n">MAX_STACK_TRACE_ENTRIES</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; combined max dependencies:     %11u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">nr_hardirq_chains</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
			<span class="p">(</span><span class="n">nr_softirq_chains</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
			<span class="p">(</span><span class="n">nr_process_chains</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
	<span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; hardirq-safe locks:            %11lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nr_hardirq_safe</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; hardirq-unsafe locks:          %11lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nr_hardirq_unsafe</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; softirq-safe locks:            %11lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nr_softirq_safe</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; softirq-unsafe locks:          %11lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nr_softirq_unsafe</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; irq-safe locks:                %11lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nr_irq_safe</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; irq-unsafe locks:              %11lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nr_irq_unsafe</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; hardirq-read-safe locks:       %11lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nr_hardirq_read_safe</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; hardirq-read-unsafe locks:     %11lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nr_hardirq_read_unsafe</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; softirq-read-safe locks:       %11lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nr_softirq_read_safe</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; softirq-read-unsafe locks:     %11lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nr_softirq_read_unsafe</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; irq-read-safe locks:           %11lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nr_irq_read_safe</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; irq-read-unsafe locks:         %11lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nr_irq_read_unsafe</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; uncategorized locks:           %11lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nr_uncategorized</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; unused locks:                  %11lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">nr_unused</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; max locking depth:             %11u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">max_lockdep_depth</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PROVE_LOCKING</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; max bfs queue depth:           %11u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">max_bfs_queue_depth</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">lockdep_stats_debug_show</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; debug_locks:                   %11u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">debug_locks</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lockdep_stats_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">lockdep_stats_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">proc_lockdep_stats_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">lockdep_stats_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_LOCK_STAT</span>

<span class="k">struct</span> <span class="n">lock_stat_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">lock_class</span> <span class="o">*</span><span class="n">class</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lock_class_stats</span> <span class="n">stats</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">lock_stat_seq</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">lock_stat_data</span> <span class="o">*</span><span class="n">iter_end</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lock_stat_data</span> <span class="n">stats</span><span class="p">[</span><span class="n">MAX_LOCKDEP_KEYS</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * sort on absolute number of contentions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lock_stat_cmp</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">l</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">lock_stat_data</span> <span class="o">*</span><span class="n">dl</span> <span class="o">=</span> <span class="n">l</span><span class="p">,</span> <span class="o">*</span><span class="n">dr</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nl</span><span class="p">,</span> <span class="n">nr</span><span class="p">;</span>

	<span class="n">nl</span> <span class="o">=</span> <span class="n">dl</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">read_waittime</span><span class="p">.</span><span class="n">nr</span> <span class="o">+</span> <span class="n">dl</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">write_waittime</span><span class="p">.</span><span class="n">nr</span><span class="p">;</span>
	<span class="n">nr</span> <span class="o">=</span> <span class="n">dr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">read_waittime</span><span class="p">.</span><span class="n">nr</span> <span class="o">+</span> <span class="n">dr</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">write_waittime</span><span class="p">.</span><span class="n">nr</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nr</span> <span class="o">-</span> <span class="n">nl</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">seq_line</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">char</span> <span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">offset</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%c&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snprint_time</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">bufsiz</span><span class="p">,</span> <span class="n">s64</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s64</span> <span class="n">div</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">rem</span><span class="p">;</span>

	<span class="n">nr</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span> <span class="cm">/* for display rounding */</span>
	<span class="n">div</span> <span class="o">=</span> <span class="n">div_s64_rem</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rem</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bufsiz</span><span class="p">,</span> <span class="s">&quot;%lld.%02d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">div</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">rem</span><span class="o">/</span><span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">seq_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">s64</span> <span class="n">time</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">num</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>

	<span class="n">snprint_time</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">num</span><span class="p">),</span> <span class="n">time</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; %14s&quot;</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">seq_lock_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lock_time</span> <span class="o">*</span><span class="n">lt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%14lu&quot;</span><span class="p">,</span> <span class="n">lt</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
	<span class="n">seq_time</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">lt</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">);</span>
	<span class="n">seq_time</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">lt</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">);</span>
	<span class="n">seq_time</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">lt</span><span class="o">-&gt;</span><span class="n">total</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">seq_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lock_stat_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">39</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">lock_class</span> <span class="o">*</span><span class="n">class</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lock_class_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">namelen</span><span class="p">;</span>

	<span class="n">class</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">;</span>
	<span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>

	<span class="n">namelen</span> <span class="o">=</span> <span class="mi">38</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">name_version</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">namelen</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* XXX truncates versions &gt; 9 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">subclass</span><span class="p">)</span>
		<span class="n">namelen</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">str</span><span class="p">[</span><span class="n">KSYM_NAME_LEN</span><span class="p">];</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key_name</span><span class="p">;</span>

		<span class="n">key_name</span> <span class="o">=</span> <span class="n">__get_key_name</span><span class="p">(</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">namelen</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">key_name</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">namelen</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">class</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">namelen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">name_version</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="n">namelen</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;#%d&quot;</span><span class="p">,</span> <span class="n">class</span><span class="o">-&gt;</span><span class="n">name_version</span><span class="p">);</span>
		<span class="n">namelen</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">subclass</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="n">namelen</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;/%d&quot;</span><span class="p">,</span> <span class="n">class</span><span class="o">-&gt;</span><span class="n">subclass</span><span class="p">);</span>
		<span class="n">namelen</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">write_holdtime</span><span class="p">.</span><span class="n">nr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">read_holdtime</span><span class="p">.</span><span class="n">nr</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%38s-W:&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%40s:&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%14lu &quot;</span><span class="p">,</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">bounces</span><span class="p">[</span><span class="n">bounce_contended_write</span><span class="p">]);</span>
		<span class="n">seq_lock_time</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">write_waittime</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; %14lu &quot;</span><span class="p">,</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">bounces</span><span class="p">[</span><span class="n">bounce_acquired_write</span><span class="p">]);</span>
		<span class="n">seq_lock_time</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">write_holdtime</span><span class="p">);</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">read_holdtime</span><span class="p">.</span><span class="n">nr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%38s-R:&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%14lu &quot;</span><span class="p">,</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">bounces</span><span class="p">[</span><span class="n">bounce_contended_read</span><span class="p">]);</span>
		<span class="n">seq_lock_time</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">read_waittime</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; %14lu &quot;</span><span class="p">,</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">bounces</span><span class="p">[</span><span class="n">bounce_acquired_read</span><span class="p">]);</span>
		<span class="n">seq_lock_time</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">read_holdtime</span><span class="p">);</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">read_waittime</span><span class="p">.</span><span class="n">nr</span> <span class="o">+</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">write_waittime</span><span class="p">.</span><span class="n">nr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">read_holdtime</span><span class="p">.</span><span class="n">nr</span><span class="p">)</span>
		<span class="n">namelen</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">LOCKSTAT_POINTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">ip</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">contention_point</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span>
			<span class="n">seq_line</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span> <span class="mi">40</span><span class="o">-</span><span class="n">namelen</span><span class="p">,</span> <span class="n">namelen</span><span class="p">);</span>

		<span class="n">snprintf</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ip</span><span class="p">),</span> <span class="s">&quot;[&lt;%p&gt;]&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">contention_point</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%40s %14lu %29s %pS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">name</span><span class="p">,</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">contention_point</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			   <span class="n">ip</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">contention_point</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">LOCKSTAT_POINTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">ip</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">contending_point</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span>
			<span class="n">seq_line</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span> <span class="mi">40</span><span class="o">-</span><span class="n">namelen</span><span class="p">,</span> <span class="n">namelen</span><span class="p">);</span>

		<span class="n">snprintf</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ip</span><span class="p">),</span> <span class="s">&quot;[&lt;%p&gt;]&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">contending_point</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%40s %14lu %29s %pS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">name</span><span class="p">,</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">contending_point</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			   <span class="n">ip</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">contending_point</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">seq_line</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="sc">&#39;.&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">40</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="p">(</span><span class="mi">14</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">seq_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;lock_stat version 0.3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">debug_locks</span><span class="p">))</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;*WARNING* lock debugging disabled!! - possibly due to a lockdep warning</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">seq_line</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">40</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="p">(</span><span class="mi">14</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%40s %14s %14s %14s %14s %14s %14s %14s %14s &quot;</span>
			<span class="s">&quot;%14s %14s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;class name&quot;</span><span class="p">,</span>
			<span class="s">&quot;con-bounces&quot;</span><span class="p">,</span>
			<span class="s">&quot;contentions&quot;</span><span class="p">,</span>
			<span class="s">&quot;waittime-min&quot;</span><span class="p">,</span>
			<span class="s">&quot;waittime-max&quot;</span><span class="p">,</span>
			<span class="s">&quot;waittime-total&quot;</span><span class="p">,</span>
			<span class="s">&quot;acq-bounces&quot;</span><span class="p">,</span>
			<span class="s">&quot;acquisitions&quot;</span><span class="p">,</span>
			<span class="s">&quot;holdtime-min&quot;</span><span class="p">,</span>
			<span class="s">&quot;holdtime-max&quot;</span><span class="p">,</span>
			<span class="s">&quot;holdtime-total&quot;</span><span class="p">);</span>
	<span class="n">seq_line</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">40</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="p">(</span><span class="mi">14</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">ls_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lock_stat_seq</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lock_stat_data</span> <span class="o">*</span><span class="n">iter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SEQ_START_TOKEN</span><span class="p">;</span>

	<span class="n">iter</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">stats</span> <span class="o">+</span> <span class="p">(</span><span class="o">*</span><span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iter</span> <span class="o">&gt;=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">iter_end</span><span class="p">)</span>
		<span class="n">iter</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">iter</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">ls_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ls_start</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ls_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ls_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">SEQ_START_TOKEN</span><span class="p">)</span>
		<span class="n">seq_header</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">seq_stats</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">lockstat_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">ls_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>	<span class="o">=</span> <span class="n">ls_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>	<span class="o">=</span> <span class="n">ls_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>	<span class="o">=</span> <span class="n">ls_show</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lock_stat_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lock_class</span> <span class="o">*</span><span class="n">class</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lock_stat_seq</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lock_stat_seq</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">seq_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lockstat_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">lock_stat_data</span> <span class="o">*</span><span class="n">iter</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">class</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">all_lock_classes</span><span class="p">,</span> <span class="n">lock_entry</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iter</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">=</span> <span class="n">class</span><span class="p">;</span>
			<span class="n">iter</span><span class="o">-&gt;</span><span class="n">stats</span> <span class="o">=</span> <span class="n">lock_stats</span><span class="p">(</span><span class="n">class</span><span class="p">);</span>
			<span class="n">iter</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">iter_end</span> <span class="o">=</span> <span class="n">iter</span><span class="p">;</span>

		<span class="n">sort</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">iter_end</span> <span class="o">-</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lock_stat_data</span><span class="p">),</span>
				<span class="n">lock_stat_cmp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">lock_stat_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			       <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lock_class</span> <span class="o">*</span><span class="n">class</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">c</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">count</span><span class="p">;</span>

		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">class</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">all_lock_classes</span><span class="p">,</span> <span class="n">lock_entry</span><span class="p">)</span>
			<span class="n">clear_lock_stats</span><span class="p">(</span><span class="n">class</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lock_stat_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">vfree</span><span class="p">(</span><span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">seq_release</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">proc_lock_stat_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">lock_stat_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">lock_stat_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">lock_stat_release</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_LOCK_STAT */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">lockdep_proc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;lockdep&quot;</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc_lockdep_operations</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PROVE_LOCKING</span>
	<span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;lockdep_chains&quot;</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">proc_lockdep_chains_operations</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;lockdep_stats&quot;</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">proc_lockdep_stats_operations</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_LOCK_STAT</span>
	<span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;lock_stat&quot;</span><span class="p">,</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">proc_lock_stat_operations</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__initcall</span><span class="p">(</span><span class="n">lockdep_proc_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:1}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../javascript/docco.min.js"></script>
</html>
