<!DOCTYPE html>
<html><head><title>joekychen/linux » kernel › rtmutex-tester.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../index.html"></a><h1>rtmutex-tester.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * RT-Mutex-tester: scriptable tester for rt mutexes</span>
<span class="cm"> *</span>
<span class="cm"> * started by Thomas Gleixner:</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2006, Timesys Corp., Thomas Gleixner &lt;tglx@timesys.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/freezer.h&gt;</span>

<span class="cp">#include &quot;rtmutex.h&quot;</span>

<span class="cp">#define MAX_RT_TEST_THREADS	8</span>
<span class="cp">#define MAX_RT_TEST_MUTEXES	8</span>

<span class="k">static</span> <span class="n">spinlock_t</span> <span class="n">rttest_lock</span><span class="p">;</span>
<span class="k">static</span> <span class="n">atomic_t</span> <span class="n">rttest_event</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">test_thread_data</span> <span class="p">{</span>
	<span class="kt">int</span>			<span class="n">opcode</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">opdata</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">mutexes</span><span class="p">[</span><span class="n">MAX_RT_TEST_MUTEXES</span><span class="p">];</span>
	<span class="kt">int</span>			<span class="n">event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span>		<span class="n">dev</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">test_thread_data</span> <span class="n">thread_data</span><span class="p">[</span><span class="n">MAX_RT_TEST_THREADS</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">threads</span><span class="p">[</span><span class="n">MAX_RT_TEST_THREADS</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rt_mutex</span> <span class="n">mutexes</span><span class="p">[</span><span class="n">MAX_RT_TEST_MUTEXES</span><span class="p">];</span>

<span class="k">enum</span> <span class="n">test_opcodes</span> <span class="p">{</span>
	<span class="n">RTTEST_NOP</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">RTTEST_SCHEDOT</span><span class="p">,</span>		<span class="cm">/* 1 Sched other, data = nice */</span>
	<span class="n">RTTEST_SCHEDRT</span><span class="p">,</span>		<span class="cm">/* 2 Sched fifo, data = prio */</span>
	<span class="n">RTTEST_LOCK</span><span class="p">,</span>		<span class="cm">/* 3 Lock uninterruptible, data = lockindex */</span>
	<span class="n">RTTEST_LOCKNOWAIT</span><span class="p">,</span>	<span class="cm">/* 4 Lock uninterruptible no wait in wakeup, data = lockindex */</span>
	<span class="n">RTTEST_LOCKINT</span><span class="p">,</span>		<span class="cm">/* 5 Lock interruptible, data = lockindex */</span>
	<span class="n">RTTEST_LOCKINTNOWAIT</span><span class="p">,</span>	<span class="cm">/* 6 Lock interruptible no wait in wakeup, data = lockindex */</span>
	<span class="n">RTTEST_LOCKCONT</span><span class="p">,</span>	<span class="cm">/* 7 Continue locking after the wakeup delay */</span>
	<span class="n">RTTEST_UNLOCK</span><span class="p">,</span>		<span class="cm">/* 8 Unlock, data = lockindex */</span>
	<span class="cm">/* 9, 10 - reserved for BKL commemoration */</span>
	<span class="n">RTTEST_SIGNAL</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>	<span class="cm">/* 11 Signal other test thread, data = thread id */</span>
	<span class="n">RTTEST_RESETEVENT</span> <span class="o">=</span> <span class="mi">98</span><span class="p">,</span>	<span class="cm">/* 98 Reset event counter */</span>
	<span class="n">RTTEST_RESET</span> <span class="o">=</span> <span class="mi">99</span><span class="p">,</span>	<span class="cm">/* 99 Reset all pending operations */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">handle_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">test_thread_data</span> <span class="o">*</span><span class="n">td</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lockwakeup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">RTTEST_NOP</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RTTEST_LOCKCONT</span>:
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">mutexes</span><span class="p">[</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">opdata</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">atomic_add_return</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rttest_event</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RTTEST_RESET</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_RT_TEST_MUTEXES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">mutexes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rt_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutexes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">td</span><span class="o">-&gt;</span><span class="n">mutexes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RTTEST_RESETEVENT</span>:
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rttest_event</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lockwakeup</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">RTTEST_LOCK</span>:
	<span class="k">case</span> <span class="n">RTTEST_LOCKNOWAIT</span>:
		<span class="n">id</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">opdata</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">id</span> <span class="o">&gt;=</span> <span class="n">MAX_RT_TEST_MUTEXES</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">td</span><span class="o">-&gt;</span><span class="n">mutexes</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">atomic_add_return</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rttest_event</span><span class="p">);</span>
		<span class="n">rt_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutexes</span><span class="p">[</span><span class="n">id</span><span class="p">]);</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">atomic_add_return</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rttest_event</span><span class="p">);</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">mutexes</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RTTEST_LOCKINT</span>:
	<span class="k">case</span> <span class="n">RTTEST_LOCKINTNOWAIT</span>:
		<span class="n">id</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">opdata</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">id</span> <span class="o">&gt;=</span> <span class="n">MAX_RT_TEST_MUTEXES</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">td</span><span class="o">-&gt;</span><span class="n">mutexes</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">atomic_add_return</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rttest_event</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rt_mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutexes</span><span class="p">[</span><span class="n">id</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">atomic_add_return</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rttest_event</span><span class="p">);</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">mutexes</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="o">-</span><span class="n">EINTR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RTTEST_UNLOCK</span>:
		<span class="n">id</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">opdata</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">id</span> <span class="o">&gt;=</span> <span class="n">MAX_RT_TEST_MUTEXES</span> <span class="o">||</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">mutexes</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">td</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">atomic_add_return</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rttest_event</span><span class="p">);</span>
		<span class="n">rt_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutexes</span><span class="p">[</span><span class="n">id</span><span class="p">]);</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">atomic_add_return</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rttest_event</span><span class="p">);</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">mutexes</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Schedule replacement for rtsem_down(). Only called for threads with</span>
<span class="cm"> * PF_MUTEX_TESTER set.</span>
<span class="cm"> *</span>
<span class="cm"> * This allows us to have finegrained control over the event flow.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">schedule_rt_mutex_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt_mutex</span> <span class="o">*</span><span class="n">mutex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tid</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">dat</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">test_thread_data</span> <span class="o">*</span><span class="n">td</span><span class="p">;</span>

	<span class="cm">/* We have to lookup the task */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tid</span> <span class="o">&lt;</span> <span class="n">MAX_RT_TEST_THREADS</span><span class="p">;</span> <span class="n">tid</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">==</span> <span class="n">current</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">tid</span> <span class="o">==</span> <span class="n">MAX_RT_TEST_THREADS</span><span class="p">);</span>

	<span class="n">td</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">thread_data</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>

	<span class="n">op</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">;</span>
	<span class="n">dat</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">opdata</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RTTEST_LOCK</span>:
	<span class="k">case</span> <span class="n">RTTEST_LOCKINT</span>:
	<span class="k">case</span> <span class="n">RTTEST_LOCKNOWAIT</span>:
	<span class="k">case</span> <span class="n">RTTEST_LOCKINTNOWAIT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">mutex</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">mutexes</span><span class="p">[</span><span class="n">dat</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">mutexes</span><span class="p">[</span><span class="n">dat</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">td</span><span class="o">-&gt;</span><span class="n">mutexes</span><span class="p">[</span><span class="n">dat</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">atomic_add_return</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rttest_event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">schedule</span><span class="p">();</span>


	<span class="k">switch</span> <span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RTTEST_LOCK</span>:
	<span class="k">case</span> <span class="n">RTTEST_LOCKINT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">mutex</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">mutexes</span><span class="p">[</span><span class="n">dat</span><span class="p">])</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">mutexes</span><span class="p">[</span><span class="n">dat</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">td</span><span class="o">-&gt;</span><span class="n">mutexes</span><span class="p">[</span><span class="n">dat</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">atomic_add_return</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rttest_event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RTTEST_LOCKNOWAIT</span>:
	<span class="k">case</span> <span class="n">RTTEST_LOCKINTNOWAIT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">mutex</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">mutexes</span><span class="p">[</span><span class="n">dat</span><span class="p">])</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">mutexes</span><span class="p">[</span><span class="n">dat</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">td</span><span class="o">-&gt;</span><span class="n">mutexes</span><span class="p">[</span><span class="n">dat</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">atomic_add_return</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rttest_event</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">td</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

			<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">handle_op</span><span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">RTTEST_LOCKCONT</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">td</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Wait for the next command to be executed */</span>
		<span class="n">schedule</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/* Restore previous command and data */</span>
	<span class="n">td</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">op</span><span class="p">;</span>
	<span class="n">td</span><span class="o">-&gt;</span><span class="n">opdata</span> <span class="o">=</span> <span class="n">dat</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">test_func</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">test_thread_data</span> <span class="o">*</span><span class="n">td</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">current</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">PF_MUTEX_TESTER</span><span class="p">;</span>
	<span class="n">set_freezable</span><span class="p">();</span>
	<span class="n">allow_signal</span><span class="p">(</span><span class="n">SIGHUP</span><span class="p">);</span>

	<span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>

		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">handle_op</span><span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
			<span class="n">td</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Wait for the next command to be executed */</span>
		<span class="n">schedule</span><span class="p">();</span>
		<span class="n">try_to_freeze</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="n">flush_signals</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">kthread_should_stop</span><span class="p">())</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sysfs_test_command - interface for test commands</span>
<span class="cm"> * @dev:	thread reference</span>
<span class="cm"> * @buf:	command for actual step</span>
<span class="cm"> * @count:	length of buffer</span>
<span class="cm"> *</span>
<span class="cm"> * command syntax:</span>
<span class="cm"> *</span>
<span class="cm"> * opcode:data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sysfs_test_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sched_param</span> <span class="n">schedpar</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">test_thread_data</span> <span class="o">*</span><span class="n">td</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">cmdbuf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">op</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">td</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">test_thread_data</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">tid</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>

	<span class="cm">/* strings from sysfs write are not 0 terminated! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmdbuf</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* strip of \n: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">count</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmdbuf</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">cmdbuf</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">cmdbuf</span><span class="p">,</span> <span class="s">&quot;%d:%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dat</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RTTEST_SCHEDOT</span>:
		<span class="n">schedpar</span><span class="p">.</span><span class="n">sched_priority</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sched_setscheduler</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">tid</span><span class="p">],</span> <span class="n">SCHED_NORMAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">schedpar</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">set_user_nice</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RTTEST_SCHEDRT</span>:
		<span class="n">schedpar</span><span class="p">.</span><span class="n">sched_priority</span> <span class="o">=</span> <span class="n">dat</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sched_setscheduler</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">tid</span><span class="p">],</span> <span class="n">SCHED_FIFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">schedpar</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RTTEST_SIGNAL</span>:
		<span class="n">send_sig</span><span class="p">(</span><span class="n">SIGHUP</span><span class="p">,</span> <span class="n">threads</span><span class="p">[</span><span class="n">tid</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">opdata</span> <span class="o">=</span> <span class="n">dat</span><span class="p">;</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">op</span><span class="p">;</span>
		<span class="n">wake_up_process</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">tid</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sysfs_test_status - sysfs interface for rt tester</span>
<span class="cm"> * @dev:	thread to query</span>
<span class="cm"> * @buf:	char buffer to be filled with thread status info</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sysfs_test_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">test_thread_data</span> <span class="o">*</span><span class="n">td</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">tsk</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">curr</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">td</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">test_thread_data</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">tsk</span> <span class="o">=</span> <span class="n">threads</span><span class="p">[</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">id</span><span class="p">];</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rttest_lock</span><span class="p">);</span>

	<span class="n">curr</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span>
		<span class="s">&quot;O: %4d, E:%8d, S: 0x%08lx, P: %4d, N: %4d, B: %p, M:&quot;</span><span class="p">,</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">,</span> <span class="n">tsk</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span>
			<span class="p">(</span><span class="n">MAX_RT_PRIO</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">tsk</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">,</span>
			<span class="p">(</span><span class="n">MAX_RT_PRIO</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">tsk</span><span class="o">-&gt;</span><span class="n">normal_prio</span><span class="p">,</span>
		<span class="n">tsk</span><span class="o">-&gt;</span><span class="n">pi_blocked_on</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">MAX_RT_TEST_MUTEXES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="n">curr</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">mutexes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rttest_lock</span><span class="p">);</span>

	<span class="n">curr</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="s">&quot;, T: %p, R: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tsk</span><span class="p">,</span>
			<span class="n">mutexes</span><span class="p">[</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">id</span><span class="p">].</span><span class="n">owner</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">curr</span> <span class="o">-</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">sysfs_test_status</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">sysfs_test_command</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bus_type</span> <span class="n">rttest_subsys</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;rttest&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev_name</span> <span class="o">=</span> <span class="s">&quot;rttest&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_test_thread</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">thread_data</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">dev</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rttest_subsys</span><span class="p">;</span>
	<span class="n">thread_data</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">dev</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">threads</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">test_func</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">thread_data</span><span class="p">[</span><span class="n">id</span><span class="p">],</span> <span class="s">&quot;rt-test-%d&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">id</span><span class="p">]))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">id</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thread_data</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_rttest</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rttest_lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_RT_TEST_MUTEXES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rt_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutexes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">subsys_system_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rttest_subsys</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_RT_TEST_THREADS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">init_test_thread</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thread_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thread_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_command</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Initializing RT-Tester: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span> <span class="o">?</span> <span class="s">&quot;Failed&quot;</span> <span class="o">:</span> <span class="s">&quot;OK&quot;</span> <span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">device_initcall</span><span class="p">(</span><span class="n">init_rttest</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:1}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../javascript/docco.min.js"></script>
</html>
