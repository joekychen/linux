<!DOCTYPE html>
<html><head><title>joekychen/linux » kernel › compat.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../index.html"></a><h1>compat.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/kernel/compat.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Kernel compatibililty routines for e.g. 32 bit syscall support</span>
<span class="cm"> *  on 64 bit kernels.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2002-2003 Stephen Rothwell, IBM Corporation</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> *  published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/linkage.h&gt;</span>
<span class="cp">#include &lt;linux/compat.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/signal.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;	</span><span class="cm">/* for MAX_SCHEDULE_TIMEOUT */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/syscalls.h&gt;</span>
<span class="cp">#include &lt;linux/unistd.h&gt;</span>
<span class="cp">#include &lt;linux/security.h&gt;</span>
<span class="cp">#include &lt;linux/timex.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/migrate.h&gt;</span>
<span class="cp">#include &lt;linux/posix-timers.h&gt;</span>
<span class="cp">#include &lt;linux/times.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * Get/set struct timeval with struct timespec on the native side</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">compat_get_timeval_convert</span><span class="p">(</span><span class="k">struct</span> <span class="n">timespec</span> <span class="o">*</span><span class="n">o</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">compat_timeval</span> <span class="n">__user</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">usec</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">tv_sec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">get_user</span><span class="p">(</span><span class="n">usec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">tv_usec</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">o</span><span class="o">-&gt;</span><span class="n">tv_nsec</span> <span class="o">=</span> <span class="n">usec</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">compat_put_timeval_convert</span><span class="p">(</span><span class="k">struct</span> <span class="n">compat_timeval</span> <span class="n">__user</span> <span class="o">*</span><span class="n">o</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">tv_sec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">put_user</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">tv_usec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">tv_usec</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">compat_get_timex</span><span class="p">(</span><span class="k">struct</span> <span class="n">timex</span> <span class="o">*</span><span class="n">txc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">compat_timex</span> <span class="n">__user</span> <span class="o">*</span><span class="n">utp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">txc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">timex</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">utp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">compat_timex</span><span class="p">))</span> <span class="o">||</span>
			<span class="n">__get_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__get_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__get_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__get_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">maxerror</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">maxerror</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__get_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">esterror</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">esterror</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__get_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__get_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">constant</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">constant</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__get_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">precision</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">precision</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__get_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">tolerance</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">tolerance</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__get_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__get_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__get_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">tick</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">tick</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__get_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">ppsfreq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">ppsfreq</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__get_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">jitter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">jitter</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__get_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__get_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">stabil</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">stabil</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__get_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">jitcnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">jitcnt</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__get_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">calcnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">calcnt</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__get_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">errcnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">errcnt</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__get_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">stbcnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">stbcnt</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">compat_put_timex</span><span class="p">(</span><span class="k">struct</span> <span class="n">compat_timex</span> <span class="n">__user</span> <span class="o">*</span><span class="n">utp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">timex</span> <span class="o">*</span><span class="n">txc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">utp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">compat_timex</span><span class="p">))</span> <span class="o">||</span>
			<span class="n">__put_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__put_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__put_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__put_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">maxerror</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">maxerror</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__put_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">esterror</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">esterror</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__put_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__put_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">constant</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">constant</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__put_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">precision</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">precision</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__put_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">tolerance</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">tolerance</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__put_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__put_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__put_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">tick</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">tick</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__put_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">ppsfreq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">ppsfreq</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__put_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">jitter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">jitter</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__put_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__put_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">stabil</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">stabil</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__put_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">jitcnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">jitcnt</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__put_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">calcnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">calcnt</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__put_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">errcnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">errcnt</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__put_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">stbcnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">stbcnt</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__put_user</span><span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">tai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utp</span><span class="o">-&gt;</span><span class="n">tai</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">asmlinkage</span> <span class="kt">long</span> <span class="nf">compat_sys_gettimeofday</span><span class="p">(</span><span class="k">struct</span> <span class="n">compat_timeval</span> <span class="n">__user</span> <span class="o">*</span><span class="n">tv</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">timezone</span> <span class="n">__user</span> <span class="o">*</span><span class="n">tz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tv</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">timeval</span> <span class="n">ktv</span><span class="p">;</span>
		<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ktv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">compat_put_timeval_convert</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ktv</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tz</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">tz</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sys_tz</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sys_tz</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">asmlinkage</span> <span class="kt">long</span> <span class="nf">compat_sys_settimeofday</span><span class="p">(</span><span class="k">struct</span> <span class="n">compat_timeval</span> <span class="n">__user</span> <span class="o">*</span><span class="n">tv</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">timezone</span> <span class="n">__user</span> <span class="o">*</span><span class="n">tz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">kts</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timezone</span> <span class="n">ktz</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tv</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">compat_get_timeval_convert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kts</span><span class="p">,</span> <span class="n">tv</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tz</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ktz</span><span class="p">,</span> <span class="n">tz</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ktz</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">do_sys_settimeofday</span><span class="p">(</span><span class="n">tv</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">kts</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">tz</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">ktz</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">get_compat_timeval</span><span class="p">(</span><span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="n">tv</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">compat_timeval</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ctv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">ctv</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ctv</span><span class="p">))</span> <span class="o">||</span>
			<span class="n">__get_user</span><span class="p">(</span><span class="n">tv</span><span class="o">-&gt;</span><span class="n">tv_sec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctv</span><span class="o">-&gt;</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__get_user</span><span class="p">(</span><span class="n">tv</span><span class="o">-&gt;</span><span class="n">tv_usec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctv</span><span class="o">-&gt;</span><span class="n">tv_usec</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">get_compat_timeval</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">put_compat_timeval</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="n">tv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">compat_timeval</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ctv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">ctv</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ctv</span><span class="p">))</span> <span class="o">||</span>
			<span class="n">__put_user</span><span class="p">(</span><span class="n">tv</span><span class="o">-&gt;</span><span class="n">tv_sec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctv</span><span class="o">-&gt;</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__put_user</span><span class="p">(</span><span class="n">tv</span><span class="o">-&gt;</span><span class="n">tv_usec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctv</span><span class="o">-&gt;</span><span class="n">tv_usec</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">put_compat_timeval</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">get_compat_timespec</span><span class="p">(</span><span class="k">struct</span> <span class="n">timespec</span> <span class="o">*</span><span class="n">ts</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">compat_timespec</span> <span class="n">__user</span> <span class="o">*</span><span class="n">cts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">cts</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cts</span><span class="p">))</span> <span class="o">||</span>
			<span class="n">__get_user</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">tv_sec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cts</span><span class="o">-&gt;</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__get_user</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">tv_nsec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cts</span><span class="o">-&gt;</span><span class="n">tv_nsec</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">get_compat_timespec</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">put_compat_timespec</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">timespec</span> <span class="o">*</span><span class="n">ts</span><span class="p">,</span> <span class="k">struct</span> <span class="n">compat_timespec</span> <span class="n">__user</span> <span class="o">*</span><span class="n">cts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">cts</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cts</span><span class="p">))</span> <span class="o">||</span>
			<span class="n">__put_user</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">tv_sec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cts</span><span class="o">-&gt;</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">__put_user</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">tv_nsec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cts</span><span class="o">-&gt;</span><span class="n">tv_nsec</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">put_compat_timespec</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">compat_get_timeval</span><span class="p">(</span><span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="n">tv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">utv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">COMPAT_USE_64BIT_TIME</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">utv</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">tv</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">get_compat_timeval</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">utv</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">compat_get_timeval</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">compat_put_timeval</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="n">tv</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">utv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">COMPAT_USE_64BIT_TIME</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">utv</span><span class="p">,</span> <span class="n">tv</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">tv</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">put_compat_timeval</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">utv</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">compat_put_timeval</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">compat_get_timespec</span><span class="p">(</span><span class="k">struct</span> <span class="n">timespec</span> <span class="o">*</span><span class="n">ts</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">COMPAT_USE_64BIT_TIME</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">uts</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">ts</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">get_compat_timespec</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">uts</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">compat_get_timespec</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">compat_put_timespec</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">timespec</span> <span class="o">*</span><span class="n">ts</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">COMPAT_USE_64BIT_TIME</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">uts</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">ts</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">put_compat_timespec</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">uts</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">compat_put_timespec</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">compat_nanosleep_restart</span><span class="p">(</span><span class="k">struct</span> <span class="n">restart_block</span> <span class="o">*</span><span class="n">restart</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">compat_timespec</span> <span class="n">__user</span> <span class="o">*</span><span class="n">rmtp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">rmt</span><span class="p">;</span>
	<span class="n">mm_segment_t</span> <span class="n">oldfs</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">restart</span><span class="o">-&gt;</span><span class="n">nanosleep</span><span class="p">.</span><span class="n">rmtp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">timespec</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rmt</span><span class="p">;</span>
	<span class="n">oldfs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">hrtimer_nanosleep_restart</span><span class="p">(</span><span class="n">restart</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">oldfs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rmtp</span> <span class="o">=</span> <span class="n">restart</span><span class="o">-&gt;</span><span class="n">nanosleep</span><span class="p">.</span><span class="n">compat_rmtp</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rmtp</span> <span class="o">&amp;&amp;</span> <span class="n">put_compat_timespec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmt</span><span class="p">,</span> <span class="n">rmtp</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">asmlinkage</span> <span class="kt">long</span> <span class="nf">compat_sys_nanosleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">compat_timespec</span> <span class="n">__user</span> <span class="o">*</span><span class="n">rqtp</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">compat_timespec</span> <span class="n">__user</span> <span class="o">*</span><span class="n">rmtp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">tu</span><span class="p">,</span> <span class="n">rmt</span><span class="p">;</span>
	<span class="n">mm_segment_t</span> <span class="n">oldfs</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_compat_timespec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tu</span><span class="p">,</span> <span class="n">rqtp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timespec_valid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tu</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">oldfs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">hrtimer_nanosleep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tu</span><span class="p">,</span>
				<span class="n">rmtp</span> <span class="o">?</span> <span class="p">(</span><span class="k">struct</span> <span class="n">timespec</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rmt</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">,</span>
				<span class="n">HRTIMER_MODE_REL</span><span class="p">,</span> <span class="n">CLOCK_MONOTONIC</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">oldfs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">restart_block</span> <span class="o">*</span><span class="n">restart</span>
			<span class="o">=</span> <span class="o">&amp;</span><span class="n">current_thread_info</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">restart_block</span><span class="p">;</span>

		<span class="n">restart</span><span class="o">-&gt;</span><span class="n">fn</span> <span class="o">=</span> <span class="n">compat_nanosleep_restart</span><span class="p">;</span>
		<span class="n">restart</span><span class="o">-&gt;</span><span class="n">nanosleep</span><span class="p">.</span><span class="n">compat_rmtp</span> <span class="o">=</span> <span class="n">rmtp</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rmtp</span> <span class="o">&amp;&amp;</span> <span class="n">put_compat_timespec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmt</span><span class="p">,</span> <span class="n">rmtp</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">long</span> <span class="nf">get_compat_itimerval</span><span class="p">(</span><span class="k">struct</span> <span class="n">itimerval</span> <span class="o">*</span><span class="n">o</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">compat_itimerval</span> <span class="n">__user</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">i</span><span class="p">))</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">__get_user</span><span class="p">(</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">it_interval</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">it_interval</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">|</span>
		 <span class="n">__get_user</span><span class="p">(</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">it_interval</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">it_interval</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">)</span> <span class="o">|</span>
		 <span class="n">__get_user</span><span class="p">(</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">it_value</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">it_value</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">|</span>
		 <span class="n">__get_user</span><span class="p">(</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">it_value</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">it_value</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">long</span> <span class="nf">put_compat_itimerval</span><span class="p">(</span><span class="k">struct</span> <span class="n">compat_itimerval</span> <span class="n">__user</span> <span class="o">*</span><span class="n">o</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">itimerval</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">o</span><span class="p">))</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">__put_user</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">it_interval</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">it_interval</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">|</span>
		 <span class="n">__put_user</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">it_interval</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">it_interval</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">)</span> <span class="o">|</span>
		 <span class="n">__put_user</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">it_value</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">it_value</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">|</span>
		 <span class="n">__put_user</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">it_value</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">it_value</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">)));</span>
<span class="p">}</span>

<span class="n">asmlinkage</span> <span class="kt">long</span> <span class="nf">compat_sys_getitimer</span><span class="p">(</span><span class="kt">int</span> <span class="n">which</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">compat_itimerval</span> <span class="n">__user</span> <span class="o">*</span><span class="n">it</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">itimerval</span> <span class="n">kit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">do_getitimer</span><span class="p">(</span><span class="n">which</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span> <span class="o">&amp;&amp;</span> <span class="n">put_compat_itimerval</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kit</span><span class="p">))</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">asmlinkage</span> <span class="kt">long</span> <span class="nf">compat_sys_setitimer</span><span class="p">(</span><span class="kt">int</span> <span class="n">which</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">compat_itimerval</span> <span class="n">__user</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">compat_itimerval</span> <span class="n">__user</span> <span class="o">*</span><span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">itimerval</span> <span class="n">kin</span><span class="p">,</span> <span class="n">kout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_compat_itimerval</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kin</span><span class="p">,</span> <span class="n">in</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kin</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">kin</span><span class="p">));</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">do_setitimer</span><span class="p">(</span><span class="n">which</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kin</span><span class="p">,</span> <span class="n">out</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">kout</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">||</span> <span class="o">!</span><span class="n">out</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">put_compat_itimerval</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kout</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">compat_clock_t</span> <span class="nf">clock_t_to_compat_clock_t</span><span class="p">(</span><span class="kt">clock_t</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">compat_jiffies_to_clock_t</span><span class="p">(</span><span class="n">clock_t_to_jiffies</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
<span class="p">}</span>

<span class="n">asmlinkage</span> <span class="kt">long</span> <span class="nf">compat_sys_times</span><span class="p">(</span><span class="k">struct</span> <span class="n">compat_tms</span> <span class="n">__user</span> <span class="o">*</span><span class="n">tbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tbuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tms</span> <span class="n">tms</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">compat_tms</span> <span class="n">tmp</span><span class="p">;</span>

		<span class="n">do_sys_times</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tms</span><span class="p">);</span>
		<span class="cm">/* Convert our struct tms to the compat version. */</span>
		<span class="n">tmp</span><span class="p">.</span><span class="n">tms_utime</span> <span class="o">=</span> <span class="n">clock_t_to_compat_clock_t</span><span class="p">(</span><span class="n">tms</span><span class="p">.</span><span class="n">tms_utime</span><span class="p">);</span>
		<span class="n">tmp</span><span class="p">.</span><span class="n">tms_stime</span> <span class="o">=</span> <span class="n">clock_t_to_compat_clock_t</span><span class="p">(</span><span class="n">tms</span><span class="p">.</span><span class="n">tms_stime</span><span class="p">);</span>
		<span class="n">tmp</span><span class="p">.</span><span class="n">tms_cutime</span> <span class="o">=</span> <span class="n">clock_t_to_compat_clock_t</span><span class="p">(</span><span class="n">tms</span><span class="p">.</span><span class="n">tms_cutime</span><span class="p">);</span>
		<span class="n">tmp</span><span class="p">.</span><span class="n">tms_cstime</span> <span class="o">=</span> <span class="n">clock_t_to_compat_clock_t</span><span class="p">(</span><span class="n">tms</span><span class="p">.</span><span class="n">tms_cstime</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">tbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">force_successful_syscall_return</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">compat_jiffies_to_clock_t</span><span class="p">(</span><span class="n">jiffies</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef __ARCH_WANT_SYS_SIGPENDING</span>

<span class="cm">/*</span>
<span class="cm"> * Assumption: old_sigset_t and compat_old_sigset_t are both</span>
<span class="cm"> * types that can be passed to put_user()/get_user().</span>
<span class="cm"> */</span>

<span class="n">asmlinkage</span> <span class="kt">long</span> <span class="nf">compat_sys_sigpending</span><span class="p">(</span><span class="n">compat_old_sigset_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">old_sigset_t</span> <span class="n">s</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">mm_segment_t</span> <span class="n">old_fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>

	<span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sys_sigpending</span><span class="p">((</span><span class="n">old_sigset_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">old_fs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">set</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cp">#ifdef __ARCH_WANT_SYS_SIGPROCMASK</span>

<span class="cm">/*</span>
<span class="cm"> * sys_sigprocmask SIG_SETMASK sets the first (compat) word of the</span>
<span class="cm"> * blocked set of signals to the supplied signal set</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">compat_sig_setmask</span><span class="p">(</span><span class="n">sigset_t</span> <span class="o">*</span><span class="n">blocked</span><span class="p">,</span> <span class="n">compat_sigset_word</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">blocked</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">set</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">set</span><span class="p">));</span>
<span class="p">}</span>

<span class="n">asmlinkage</span> <span class="kt">long</span> <span class="nf">compat_sys_sigprocmask</span><span class="p">(</span><span class="kt">int</span> <span class="n">how</span><span class="p">,</span>
				       <span class="n">compat_old_sigset_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">nset</span><span class="p">,</span>
				       <span class="n">compat_old_sigset_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">oset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">old_sigset_t</span> <span class="n">old_set</span><span class="p">,</span> <span class="n">new_set</span><span class="p">;</span>
	<span class="n">sigset_t</span> <span class="n">new_blocked</span><span class="p">;</span>

	<span class="n">old_set</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">blocked</span><span class="p">.</span><span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nset</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">new_set</span><span class="p">,</span> <span class="n">nset</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">new_set</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">sigmask</span><span class="p">(</span><span class="n">SIGKILL</span><span class="p">)</span> <span class="o">|</span> <span class="n">sigmask</span><span class="p">(</span><span class="n">SIGSTOP</span><span class="p">));</span>

		<span class="n">new_blocked</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">blocked</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">how</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SIG_BLOCK</span>:
			<span class="n">sigaddsetmask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_blocked</span><span class="p">,</span> <span class="n">new_set</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SIG_UNBLOCK</span>:
			<span class="n">sigdelsetmask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_blocked</span><span class="p">,</span> <span class="n">new_set</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SIG_SETMASK</span>:
			<span class="n">compat_sig_setmask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_blocked</span><span class="p">,</span> <span class="n">new_set</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">set_current_blocked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_blocked</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">oset</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">old_set</span><span class="p">,</span> <span class="n">oset</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="n">asmlinkage</span> <span class="kt">long</span> <span class="nf">compat_sys_setrlimit</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">resource</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">compat_rlimit</span> <span class="n">__user</span> <span class="o">*</span><span class="n">rlim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rlimit</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">rlim</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rlim</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">__get_user</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">rlim_cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rlim</span><span class="o">-&gt;</span><span class="n">rlim_cur</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">__get_user</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">rlim_max</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rlim</span><span class="o">-&gt;</span><span class="n">rlim_max</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">rlim_cur</span> <span class="o">==</span> <span class="n">COMPAT_RLIM_INFINITY</span><span class="p">)</span>
		<span class="n">r</span><span class="p">.</span><span class="n">rlim_cur</span> <span class="o">=</span> <span class="n">RLIM_INFINITY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">rlim_max</span> <span class="o">==</span> <span class="n">COMPAT_RLIM_INFINITY</span><span class="p">)</span>
		<span class="n">r</span><span class="p">.</span><span class="n">rlim_max</span> <span class="o">=</span> <span class="n">RLIM_INFINITY</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">do_prlimit</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef COMPAT_RLIM_OLD_INFINITY</span>

<span class="n">asmlinkage</span> <span class="kt">long</span> <span class="nf">compat_sys_old_getrlimit</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">resource</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">compat_rlimit</span> <span class="n">__user</span> <span class="o">*</span><span class="n">rlim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rlimit</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">mm_segment_t</span> <span class="n">old_fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>

	<span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sys_old_getrlimit</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">old_fs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">rlim_cur</span> <span class="o">&gt;</span> <span class="n">COMPAT_RLIM_OLD_INFINITY</span><span class="p">)</span>
			<span class="n">r</span><span class="p">.</span><span class="n">rlim_cur</span> <span class="o">=</span> <span class="n">COMPAT_RLIM_INFINITY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">rlim_max</span> <span class="o">&gt;</span> <span class="n">COMPAT_RLIM_OLD_INFINITY</span><span class="p">)</span>
			<span class="n">r</span><span class="p">.</span><span class="n">rlim_max</span> <span class="o">=</span> <span class="n">COMPAT_RLIM_INFINITY</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">rlim</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rlim</span><span class="p">))</span> <span class="o">||</span>
		    <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">rlim_cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rlim</span><span class="o">-&gt;</span><span class="n">rlim_cur</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">rlim_max</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rlim</span><span class="o">-&gt;</span><span class="n">rlim_max</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="n">asmlinkage</span> <span class="kt">long</span> <span class="nf">compat_sys_getrlimit</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">resource</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">compat_rlimit</span> <span class="n">__user</span> <span class="o">*</span><span class="n">rlim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rlimit</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">do_prlimit</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">rlim_cur</span> <span class="o">&gt;</span> <span class="n">COMPAT_RLIM_INFINITY</span><span class="p">)</span>
			<span class="n">r</span><span class="p">.</span><span class="n">rlim_cur</span> <span class="o">=</span> <span class="n">COMPAT_RLIM_INFINITY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">rlim_max</span> <span class="o">&gt;</span> <span class="n">COMPAT_RLIM_INFINITY</span><span class="p">)</span>
			<span class="n">r</span><span class="p">.</span><span class="n">rlim_max</span> <span class="o">=</span> <span class="n">COMPAT_RLIM_INFINITY</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">rlim</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rlim</span><span class="p">))</span> <span class="o">||</span>
		    <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">rlim_cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rlim</span><span class="o">-&gt;</span><span class="n">rlim_cur</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">rlim_max</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rlim</span><span class="o">-&gt;</span><span class="n">rlim_max</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">put_compat_rusage</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">rusage</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="k">struct</span> <span class="n">compat_rusage</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ru</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">ru</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ru</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">ru_utime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ru</span><span class="o">-&gt;</span><span class="n">ru_utime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">ru_utime</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ru</span><span class="o">-&gt;</span><span class="n">ru_utime</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">ru_stime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ru</span><span class="o">-&gt;</span><span class="n">ru_stime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">ru_stime</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ru</span><span class="o">-&gt;</span><span class="n">ru_stime</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">ru_maxrss</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ru</span><span class="o">-&gt;</span><span class="n">ru_maxrss</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">ru_ixrss</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ru</span><span class="o">-&gt;</span><span class="n">ru_ixrss</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">ru_idrss</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ru</span><span class="o">-&gt;</span><span class="n">ru_idrss</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">ru_isrss</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ru</span><span class="o">-&gt;</span><span class="n">ru_isrss</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">ru_minflt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ru</span><span class="o">-&gt;</span><span class="n">ru_minflt</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">ru_majflt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ru</span><span class="o">-&gt;</span><span class="n">ru_majflt</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">ru_nswap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ru</span><span class="o">-&gt;</span><span class="n">ru_nswap</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">ru_inblock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ru</span><span class="o">-&gt;</span><span class="n">ru_inblock</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">ru_oublock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ru</span><span class="o">-&gt;</span><span class="n">ru_oublock</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">ru_msgsnd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ru</span><span class="o">-&gt;</span><span class="n">ru_msgsnd</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">ru_msgrcv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ru</span><span class="o">-&gt;</span><span class="n">ru_msgrcv</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">ru_nsignals</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ru</span><span class="o">-&gt;</span><span class="n">ru_nsignals</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">ru_nvcsw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ru</span><span class="o">-&gt;</span><span class="n">ru_nvcsw</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">ru_nivcsw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ru</span><span class="o">-&gt;</span><span class="n">ru_nivcsw</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">asmlinkage</span> <span class="kt">long</span> <span class="nf">compat_sys_getrusage</span><span class="p">(</span><span class="kt">int</span> <span class="n">who</span><span class="p">,</span> <span class="k">struct</span> <span class="n">compat_rusage</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ru</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rusage</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">mm_segment_t</span> <span class="n">old_fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>

	<span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sys_getrusage</span><span class="p">(</span><span class="n">who</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rusage</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">old_fs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">put_compat_rusage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="p">,</span> <span class="n">ru</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">asmlinkage</span> <span class="kt">long</span>
<span class="nf">compat_sys_wait4</span><span class="p">(</span><span class="n">compat_pid_t</span> <span class="n">pid</span><span class="p">,</span> <span class="n">compat_uint_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">stat_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">options</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">compat_rusage</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ru</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ru</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">sys_wait4</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">stat_addr</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rusage</span> <span class="n">r</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">mm_segment_t</span> <span class="n">old_fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>

		<span class="n">set_fs</span> <span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sys_wait4</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span>
				<span class="p">(</span><span class="n">stat_addr</span> <span class="o">?</span>
				 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">status</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">),</span>
				<span class="n">options</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rusage</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
		<span class="n">set_fs</span> <span class="p">(</span><span class="n">old_fs</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">put_compat_rusage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="p">,</span> <span class="n">ru</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stat_addr</span> <span class="o">&amp;&amp;</span> <span class="n">put_user</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">stat_addr</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">asmlinkage</span> <span class="kt">long</span> <span class="nf">compat_sys_waitid</span><span class="p">(</span><span class="kt">int</span> <span class="n">which</span><span class="p">,</span> <span class="n">compat_pid_t</span> <span class="n">pid</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">compat_siginfo</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">options</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">compat_rusage</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uru</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">siginfo_t</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rusage</span> <span class="n">ru</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">mm_segment_t</span> <span class="n">old_fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>

	<span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sys_waitid</span><span class="p">(</span><span class="n">which</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="p">(</span><span class="n">siginfo_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span>
			 <span class="n">uru</span> <span class="o">?</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rusage</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ru</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">old_fs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uru</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">put_compat_rusage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ru</span><span class="p">,</span> <span class="n">uru</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">&amp;</span> <span class="n">__SI_MASK</span><span class="p">);</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">|=</span> <span class="n">__SI_CHLD</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">copy_siginfo_to_user32</span><span class="p">(</span><span class="n">uinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">compat_get_user_cpu_mask</span><span class="p">(</span><span class="n">compat_ulong_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_mask_ptr</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="n">len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cpumask</span> <span class="o">*</span><span class="n">new_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">k</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">cpumask_size</span><span class="p">())</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">new_mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cpumask_size</span><span class="p">());</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">cpumask_size</span><span class="p">())</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">cpumask_size</span><span class="p">();</span>

	<span class="n">k</span> <span class="o">=</span> <span class="n">cpumask_bits</span><span class="p">(</span><span class="n">new_mask</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">compat_get_bitmap</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">user_mask_ptr</span><span class="p">,</span> <span class="n">len</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">asmlinkage</span> <span class="kt">long</span> <span class="nf">compat_sys_sched_setaffinity</span><span class="p">(</span><span class="n">compat_pid_t</span> <span class="n">pid</span><span class="p">,</span>
					     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
					     <span class="n">compat_ulong_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_mask_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cpumask_var_t</span> <span class="n">new_mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">alloc_cpumask_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_mask</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">compat_get_user_cpu_mask</span><span class="p">(</span><span class="n">user_mask_ptr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">new_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sched_setaffinity</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">new_mask</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">free_cpumask_var</span><span class="p">(</span><span class="n">new_mask</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">asmlinkage</span> <span class="kt">long</span> <span class="nf">compat_sys_sched_getaffinity</span><span class="p">(</span><span class="n">compat_pid_t</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
					     <span class="n">compat_ulong_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_mask_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">cpumask_var_t</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">*</span> <span class="n">BITS_PER_BYTE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">nr_cpu_ids</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">compat_ulong_t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">alloc_cpumask_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sched_getaffinity</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">size_t</span> <span class="n">retlen</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">cpumask_size</span><span class="p">());</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">compat_put_bitmap</span><span class="p">(</span><span class="n">user_mask_ptr</span><span class="p">,</span> <span class="n">cpumask_bits</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="n">retlen</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">retlen</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">free_cpumask_var</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">get_compat_itimerspec</span><span class="p">(</span><span class="k">struct</span> <span class="n">itimerspec</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
			  <span class="k">const</span> <span class="k">struct</span> <span class="n">compat_itimerspec</span> <span class="n">__user</span> <span class="o">*</span><span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_compat_timespec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">it_interval</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">it_interval</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">get_compat_timespec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">it_value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">it_value</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">put_compat_itimerspec</span><span class="p">(</span><span class="k">struct</span> <span class="n">compat_itimerspec</span> <span class="n">__user</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
			  <span class="k">const</span> <span class="k">struct</span> <span class="n">itimerspec</span> <span class="o">*</span><span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">put_compat_timespec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">it_interval</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">it_interval</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">put_compat_timespec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">it_value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">it_value</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">long</span> <span class="nf">compat_sys_timer_create</span><span class="p">(</span><span class="n">clockid_t</span> <span class="n">which_clock</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">compat_sigevent</span> <span class="n">__user</span> <span class="o">*</span><span class="n">timer_event_spec</span><span class="p">,</span>
			<span class="n">timer_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">created_timer_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sigevent</span> <span class="n">__user</span> <span class="o">*</span><span class="n">event</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timer_event_spec</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sigevent</span> <span class="n">kevent</span><span class="p">;</span>

		<span class="n">event</span> <span class="o">=</span> <span class="n">compat_alloc_user_space</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">event</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_compat_sigevent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kevent</span><span class="p">,</span> <span class="n">timer_event_spec</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">copy_to_user</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kevent</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">event</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">sys_timer_create</span><span class="p">(</span><span class="n">which_clock</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">created_timer_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">long</span> <span class="nf">compat_sys_timer_settime</span><span class="p">(</span><span class="n">timer_t</span> <span class="n">timer_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">compat_itimerspec</span> <span class="n">__user</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">compat_itimerspec</span> <span class="n">__user</span> <span class="o">*</span><span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">mm_segment_t</span> <span class="n">oldfs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">itimerspec</span> <span class="n">newts</span><span class="p">,</span> <span class="n">oldts</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_compat_itimerspec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newts</span><span class="p">,</span> <span class="n">new</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">oldfs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sys_timer_settime</span><span class="p">(</span><span class="n">timer_id</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">itimerspec</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">newts</span><span class="p">,</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">itimerspec</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">oldts</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">oldfs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">old</span> <span class="o">&amp;&amp;</span> <span class="n">put_compat_itimerspec</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldts</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">long</span> <span class="nf">compat_sys_timer_gettime</span><span class="p">(</span><span class="n">timer_t</span> <span class="n">timer_id</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">compat_itimerspec</span> <span class="n">__user</span> <span class="o">*</span><span class="n">setting</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">mm_segment_t</span> <span class="n">oldfs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">itimerspec</span> <span class="n">ts</span><span class="p">;</span>

	<span class="n">oldfs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sys_timer_gettime</span><span class="p">(</span><span class="n">timer_id</span><span class="p">,</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">itimerspec</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ts</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">oldfs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">put_compat_itimerspec</span><span class="p">(</span><span class="n">setting</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">long</span> <span class="nf">compat_sys_clock_settime</span><span class="p">(</span><span class="n">clockid_t</span> <span class="n">which_clock</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">compat_timespec</span> <span class="n">__user</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">mm_segment_t</span> <span class="n">oldfs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">ts</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_compat_timespec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts</span><span class="p">,</span> <span class="n">tp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">oldfs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sys_clock_settime</span><span class="p">(</span><span class="n">which_clock</span><span class="p">,</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">timespec</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ts</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">oldfs</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">long</span> <span class="nf">compat_sys_clock_gettime</span><span class="p">(</span><span class="n">clockid_t</span> <span class="n">which_clock</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">compat_timespec</span> <span class="n">__user</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">mm_segment_t</span> <span class="n">oldfs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">ts</span><span class="p">;</span>

	<span class="n">oldfs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sys_clock_gettime</span><span class="p">(</span><span class="n">which_clock</span><span class="p">,</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">timespec</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ts</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">oldfs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">put_compat_timespec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts</span><span class="p">,</span> <span class="n">tp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">long</span> <span class="nf">compat_sys_clock_adjtime</span><span class="p">(</span><span class="n">clockid_t</span> <span class="n">which_clock</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">compat_timex</span> <span class="n">__user</span> <span class="o">*</span><span class="n">utp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">timex</span> <span class="n">txc</span><span class="p">;</span>
	<span class="n">mm_segment_t</span> <span class="n">oldfs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">compat_get_timex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txc</span><span class="p">,</span> <span class="n">utp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">oldfs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sys_clock_adjtime</span><span class="p">(</span><span class="n">which_clock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">timex</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">txc</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">oldfs</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">compat_put_timex</span><span class="p">(</span><span class="n">utp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">long</span> <span class="nf">compat_sys_clock_getres</span><span class="p">(</span><span class="n">clockid_t</span> <span class="n">which_clock</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">compat_timespec</span> <span class="n">__user</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">mm_segment_t</span> <span class="n">oldfs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">ts</span><span class="p">;</span>

	<span class="n">oldfs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sys_clock_getres</span><span class="p">(</span><span class="n">which_clock</span><span class="p">,</span>
			       <span class="p">(</span><span class="k">struct</span> <span class="n">timespec</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ts</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">oldfs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">tp</span> <span class="o">&amp;&amp;</span> <span class="n">put_compat_timespec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts</span><span class="p">,</span> <span class="n">tp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">compat_clock_nanosleep_restart</span><span class="p">(</span><span class="k">struct</span> <span class="n">restart_block</span> <span class="o">*</span><span class="n">restart</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">mm_segment_t</span> <span class="n">oldfs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">tu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">compat_timespec</span> <span class="o">*</span><span class="n">rmtp</span> <span class="o">=</span> <span class="n">restart</span><span class="o">-&gt;</span><span class="n">nanosleep</span><span class="p">.</span><span class="n">compat_rmtp</span><span class="p">;</span>

	<span class="n">restart</span><span class="o">-&gt;</span><span class="n">nanosleep</span><span class="p">.</span><span class="n">rmtp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">timespec</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">tu</span><span class="p">;</span>
	<span class="n">oldfs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">clock_nanosleep_restart</span><span class="p">(</span><span class="n">restart</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">oldfs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERESTART_RESTARTBLOCK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">rmtp</span> <span class="o">&amp;&amp;</span>
	    <span class="n">put_compat_timespec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tu</span><span class="p">,</span> <span class="n">rmtp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERESTART_RESTARTBLOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">restart</span><span class="o">-&gt;</span><span class="n">fn</span> <span class="o">=</span> <span class="n">compat_clock_nanosleep_restart</span><span class="p">;</span>
		<span class="n">restart</span><span class="o">-&gt;</span><span class="n">nanosleep</span><span class="p">.</span><span class="n">compat_rmtp</span> <span class="o">=</span> <span class="n">rmtp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">long</span> <span class="nf">compat_sys_clock_nanosleep</span><span class="p">(</span><span class="n">clockid_t</span> <span class="n">which_clock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">compat_timespec</span> <span class="n">__user</span> <span class="o">*</span><span class="n">rqtp</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">compat_timespec</span> <span class="n">__user</span> <span class="o">*</span><span class="n">rmtp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">mm_segment_t</span> <span class="n">oldfs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">in</span><span class="p">,</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">restart_block</span> <span class="o">*</span><span class="n">restart</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_compat_timespec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in</span><span class="p">,</span> <span class="n">rqtp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">oldfs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sys_clock_nanosleep</span><span class="p">(</span><span class="n">which_clock</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span>
				  <span class="p">(</span><span class="k">struct</span> <span class="n">timespec</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">in</span><span class="p">,</span>
				  <span class="p">(</span><span class="k">struct</span> <span class="n">timespec</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">out</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">oldfs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERESTART_RESTARTBLOCK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">rmtp</span> <span class="o">&amp;&amp;</span>
	    <span class="n">put_compat_timespec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out</span><span class="p">,</span> <span class="n">rmtp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERESTART_RESTARTBLOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">restart</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">current_thread_info</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">restart_block</span><span class="p">;</span>
		<span class="n">restart</span><span class="o">-&gt;</span><span class="n">fn</span> <span class="o">=</span> <span class="n">compat_clock_nanosleep_restart</span><span class="p">;</span>
		<span class="n">restart</span><span class="o">-&gt;</span><span class="n">nanosleep</span><span class="p">.</span><span class="n">compat_rmtp</span> <span class="o">=</span> <span class="n">rmtp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We currently only need the following fields from the sigevent</span>
<span class="cm"> * structure: sigev_value, sigev_signo, sig_notify and (sometimes</span>
<span class="cm"> * sigev_notify_thread_id).  The others are handled in user mode.</span>
<span class="cm"> * We also assume that copying sigev_value.sival_int is sufficient</span>
<span class="cm"> * to keep all the bits of sigev_value.sival_ptr intact.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">get_compat_sigevent</span><span class="p">(</span><span class="k">struct</span> <span class="n">sigevent</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">compat_sigevent</span> <span class="n">__user</span> <span class="o">*</span><span class="n">u_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">event</span><span class="p">));</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">u_event</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">u_event</span><span class="p">))</span> <span class="o">||</span>
		<span class="n">__get_user</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">sigev_value</span><span class="p">.</span><span class="n">sival_int</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">u_event</span><span class="o">-&gt;</span><span class="n">sigev_value</span><span class="p">.</span><span class="n">sival_int</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">__get_user</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">sigev_signo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u_event</span><span class="o">-&gt;</span><span class="n">sigev_signo</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">__get_user</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">sigev_notify</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u_event</span><span class="o">-&gt;</span><span class="n">sigev_notify</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">__get_user</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">sigev_notify_thread_id</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">u_event</span><span class="o">-&gt;</span><span class="n">sigev_notify_thread_id</span><span class="p">))</span>
		<span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">long</span> <span class="nf">compat_get_bitmap</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">mask</span><span class="p">,</span> <span class="k">const</span> <span class="n">compat_ulong_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">umask</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bitmap_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">m</span><span class="p">;</span>
	<span class="n">compat_ulong_t</span> <span class="n">um</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr_compat_longs</span><span class="p">;</span>

	<span class="cm">/* align bitmap up to nearest compat_long_t boundary */</span>
	<span class="n">bitmap_size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">bitmap_size</span><span class="p">,</span> <span class="n">BITS_PER_COMPAT_LONG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">umask</span><span class="p">,</span> <span class="n">bitmap_size</span> <span class="o">/</span> <span class="mi">8</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">nr_compat_longs</span> <span class="o">=</span> <span class="n">BITS_TO_COMPAT_LONGS</span><span class="p">(</span><span class="n">bitmap_size</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">bitmap_size</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">um</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * We dont want to read past the end of the userspace</span>
<span class="cm">			 * bitmap. We must however ensure the end of the</span>
<span class="cm">			 * kernel bitmap is zeroed.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nr_compat_longs</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">__get_user</span><span class="p">(</span><span class="n">um</span><span class="p">,</span> <span class="n">umask</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">um</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">umask</span><span class="o">++</span><span class="p">;</span>
			<span class="n">m</span> <span class="o">|=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">um</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="n">BITS_PER_COMPAT_LONG</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">mask</span><span class="o">++</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">long</span> <span class="nf">compat_put_bitmap</span><span class="p">(</span><span class="n">compat_ulong_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">umask</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">mask</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bitmap_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">m</span><span class="p">;</span>
	<span class="n">compat_ulong_t</span> <span class="n">um</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr_compat_longs</span><span class="p">;</span>

	<span class="cm">/* align bitmap up to nearest compat_long_t boundary */</span>
	<span class="n">bitmap_size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">bitmap_size</span><span class="p">,</span> <span class="n">BITS_PER_COMPAT_LONG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">umask</span><span class="p">,</span> <span class="n">bitmap_size</span> <span class="o">/</span> <span class="mi">8</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">nr_compat_longs</span> <span class="o">=</span> <span class="n">BITS_TO_COMPAT_LONGS</span><span class="p">(</span><span class="n">bitmap_size</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">bitmap_size</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">m</span> <span class="o">=</span> <span class="o">*</span><span class="n">mask</span><span class="o">++</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">um</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">um</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * We dont want to write past the end of the userspace</span>
<span class="cm">			 * bitmap.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nr_compat_longs</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">__put_user</span><span class="p">(</span><span class="n">um</span><span class="p">,</span> <span class="n">umask</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">umask</span><span class="o">++</span><span class="p">;</span>
			<span class="n">m</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">um</span><span class="p">);</span>
			<span class="n">m</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">um</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">sigset_from_compat</span> <span class="p">(</span><span class="n">sigset_t</span> <span class="o">*</span><span class="n">set</span><span class="p">,</span> <span class="n">compat_sigset_t</span> <span class="o">*</span><span class="n">compat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">_NSIG_WORDS</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">4</span>: <span class="n">set</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">compat</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">|</span> <span class="p">(((</span><span class="kt">long</span><span class="p">)</span><span class="n">compat</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="p">);</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="n">set</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">compat</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|</span> <span class="p">(((</span><span class="kt">long</span><span class="p">)</span><span class="n">compat</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="p">);</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="n">set</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">compat</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|</span> <span class="p">(((</span><span class="kt">long</span><span class="p">)</span><span class="n">compat</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="p">);</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="n">set</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">compat</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">(((</span><span class="kt">long</span><span class="p">)</span><span class="n">compat</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">sigset_from_compat</span><span class="p">);</span>

<span class="n">asmlinkage</span> <span class="kt">long</span>
<span class="nf">compat_sys_rt_sigtimedwait</span> <span class="p">(</span><span class="n">compat_sigset_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uthese</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">compat_siginfo</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">compat_timespec</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uts</span><span class="p">,</span> <span class="n">compat_size_t</span> <span class="n">sigsetsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">compat_sigset_t</span> <span class="n">s32</span><span class="p">;</span>
	<span class="n">sigset_t</span> <span class="n">s</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">t</span><span class="p">;</span>
	<span class="n">siginfo_t</span> <span class="n">info</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sigsetsize</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sigset_t</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s32</span><span class="p">,</span> <span class="n">uthese</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">compat_sigset_t</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">sigset_from_compat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s32</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uts</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_compat_timespec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">,</span> <span class="n">uts</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">do_sigtimedwait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">uts</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">t</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">uinfo</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_siginfo_to_user32</span><span class="p">(</span><span class="n">uinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

<span class="n">asmlinkage</span> <span class="kt">long</span>
<span class="nf">compat_sys_rt_tgsigqueueinfo</span><span class="p">(</span><span class="n">compat_pid_t</span> <span class="n">tgid</span><span class="p">,</span> <span class="n">compat_pid_t</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sig</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">compat_siginfo</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">siginfo_t</span> <span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_siginfo_from_user32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">uinfo</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">do_rt_tgsigqueueinfo</span><span class="p">(</span><span class="n">tgid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef __ARCH_WANT_COMPAT_SYS_TIME</span>

<span class="cm">/* compat_time_t is a 32 bit &quot;long&quot; and needs to get converted. */</span>

<span class="n">asmlinkage</span> <span class="kt">long</span> <span class="nf">compat_sys_time</span><span class="p">(</span><span class="n">compat_time_t</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">tloc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">compat_time_t</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">tv</span><span class="p">;</span>

	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tloc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">tloc</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">force_successful_syscall_return</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">asmlinkage</span> <span class="kt">long</span> <span class="nf">compat_sys_stime</span><span class="p">(</span><span class="n">compat_time_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">tptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">tv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span> <span class="n">tptr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">tv</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">security_settime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">do_settimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* __ARCH_WANT_COMPAT_SYS_TIME */</span><span class="cp"></span>

<span class="cp">#ifdef __ARCH_WANT_COMPAT_SYS_RT_SIGSUSPEND</span>
<span class="n">asmlinkage</span> <span class="kt">long</span> <span class="nf">compat_sys_rt_sigsuspend</span><span class="p">(</span><span class="n">compat_sigset_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">unewset</span><span class="p">,</span> <span class="n">compat_size_t</span> <span class="n">sigsetsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sigset_t</span> <span class="n">newset</span><span class="p">;</span>
	<span class="n">compat_sigset_t</span> <span class="n">newset32</span><span class="p">;</span>

	<span class="cm">/* XXX: Don&#39;t preclude handling different sized sigset_t&#39;s.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sigsetsize</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sigset_t</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newset32</span><span class="p">,</span> <span class="n">unewset</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">compat_sigset_t</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">sigset_from_compat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newset32</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sigsuspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newset</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* __ARCH_WANT_COMPAT_SYS_RT_SIGSUSPEND */</span><span class="cp"></span>

<span class="n">asmlinkage</span> <span class="kt">long</span> <span class="nf">compat_sys_adjtimex</span><span class="p">(</span><span class="k">struct</span> <span class="n">compat_timex</span> <span class="n">__user</span> <span class="o">*</span><span class="n">utp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">timex</span> <span class="n">txc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">compat_get_timex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txc</span><span class="p">,</span> <span class="n">utp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">do_adjtimex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txc</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">compat_put_timex</span><span class="p">(</span><span class="n">utp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NUMA</span>
<span class="n">asmlinkage</span> <span class="kt">long</span> <span class="nf">compat_sys_move_pages</span><span class="p">(</span><span class="n">pid_t</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr_pages</span><span class="p">,</span>
		<span class="n">compat_uptr_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">pages32</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">nodes</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">status</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">__user</span> <span class="o">*</span><span class="n">pages</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pages</span> <span class="o">=</span> <span class="n">compat_alloc_user_space</span><span class="p">(</span><span class="n">nr_pages</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">compat_uptr_t</span> <span class="n">p</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pages32</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">put_user</span><span class="p">(</span><span class="n">compat_ptr</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">pages</span> <span class="o">+</span> <span class="n">i</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">sys_move_pages</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">nr_pages</span><span class="p">,</span> <span class="n">pages</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">asmlinkage</span> <span class="kt">long</span> <span class="nf">compat_sys_migrate_pages</span><span class="p">(</span><span class="n">compat_pid_t</span> <span class="n">pid</span><span class="p">,</span>
			<span class="n">compat_ulong_t</span> <span class="n">maxnode</span><span class="p">,</span>
			<span class="k">const</span> <span class="n">compat_ulong_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">old_nodes</span><span class="p">,</span>
			<span class="k">const</span> <span class="n">compat_ulong_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">new_nodes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="n">old</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="n">new</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">nodemask_t</span> <span class="n">tmp_mask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr_bits</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">nr_bits</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">maxnode</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MAX_NUMNODES</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">nr_bits</span><span class="p">,</span> <span class="n">BITS_PER_LONG</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_nodes</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">compat_get_bitmap</span><span class="p">(</span><span class="n">nodes_addr</span><span class="p">(</span><span class="n">tmp_mask</span><span class="p">),</span> <span class="n">old_nodes</span><span class="p">,</span> <span class="n">nr_bits</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">old</span> <span class="o">=</span> <span class="n">compat_alloc_user_space</span><span class="p">(</span><span class="n">new_nodes</span> <span class="o">?</span> <span class="n">size</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">:</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_nodes</span><span class="p">)</span>
			<span class="n">new</span> <span class="o">=</span> <span class="n">old</span> <span class="o">+</span> <span class="n">size</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">nodes_addr</span><span class="p">(</span><span class="n">tmp_mask</span><span class="p">),</span> <span class="n">size</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_nodes</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">compat_get_bitmap</span><span class="p">(</span><span class="n">nodes_addr</span><span class="p">(</span><span class="n">tmp_mask</span><span class="p">),</span> <span class="n">new_nodes</span><span class="p">,</span> <span class="n">nr_bits</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">new</span> <span class="o">=</span> <span class="n">compat_alloc_user_space</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">nodes_addr</span><span class="p">(</span><span class="n">tmp_mask</span><span class="p">),</span> <span class="n">size</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">sys_migrate_pages</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">nr_bits</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">struct</span> <span class="n">compat_sysinfo</span> <span class="p">{</span>
	<span class="n">s32</span> <span class="n">uptime</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">loads</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">totalram</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">freeram</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sharedram</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bufferram</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">totalswap</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">freeswap</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">procs</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pad</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">totalhigh</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">freehigh</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mem_unit</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">_f</span><span class="p">[</span><span class="mi">20</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">-</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)];</span>
<span class="p">};</span>

<span class="n">asmlinkage</span> <span class="kt">long</span>
<span class="nf">compat_sys_sysinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">compat_sysinfo</span> <span class="n">__user</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sysinfo</span> <span class="n">s</span><span class="p">;</span>

	<span class="n">do_sysinfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>

	<span class="cm">/* Check to see if any memory value is too large for 32-bit and scale</span>
<span class="cm">	 *  down if needed</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">s</span><span class="p">.</span><span class="n">totalram</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">totalswap</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">bitcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">mem_unit</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s</span><span class="p">.</span><span class="n">mem_unit</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">bitcount</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">s</span><span class="p">.</span><span class="n">totalram</span> <span class="o">&gt;&gt;=</span> <span class="n">bitcount</span><span class="p">;</span>
		<span class="n">s</span><span class="p">.</span><span class="n">freeram</span> <span class="o">&gt;&gt;=</span> <span class="n">bitcount</span><span class="p">;</span>
		<span class="n">s</span><span class="p">.</span><span class="n">sharedram</span> <span class="o">&gt;&gt;=</span> <span class="n">bitcount</span><span class="p">;</span>
		<span class="n">s</span><span class="p">.</span><span class="n">bufferram</span> <span class="o">&gt;&gt;=</span> <span class="n">bitcount</span><span class="p">;</span>
		<span class="n">s</span><span class="p">.</span><span class="n">totalswap</span> <span class="o">&gt;&gt;=</span> <span class="n">bitcount</span><span class="p">;</span>
		<span class="n">s</span><span class="p">.</span><span class="n">freeswap</span> <span class="o">&gt;&gt;=</span> <span class="n">bitcount</span><span class="p">;</span>
		<span class="n">s</span><span class="p">.</span><span class="n">totalhigh</span> <span class="o">&gt;&gt;=</span> <span class="n">bitcount</span><span class="p">;</span>
		<span class="n">s</span><span class="p">.</span><span class="n">freehigh</span> <span class="o">&gt;&gt;=</span> <span class="n">bitcount</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">compat_sysinfo</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">__put_user</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">uptime</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">uptime</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">__put_user</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">loads</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">loads</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">||</span>
	    <span class="n">__put_user</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">loads</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">loads</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">||</span>
	    <span class="n">__put_user</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">loads</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">loads</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">||</span>
	    <span class="n">__put_user</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">totalram</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">totalram</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">__put_user</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">freeram</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">freeram</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">__put_user</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">sharedram</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sharedram</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">__put_user</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">bufferram</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bufferram</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">__put_user</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">totalswap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">totalswap</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">__put_user</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">freeswap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">freeswap</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">__put_user</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">procs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">procs</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">__put_user</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">totalhigh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">totalhigh</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">__put_user</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">freehigh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">freehigh</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">__put_user</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">mem_unit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mem_unit</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate user-space memory for the duration of a single system call,</span>
<span class="cm"> * in order to marshall parameters inside a compat thunk.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="nf">compat_alloc_user_space</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="cm">/* If len would occupy more than half of the entire compat space... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="p">(((</span><span class="n">compat_uptr_t</span><span class="p">)</span><span class="o">~</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">arch_compat_alloc_user_space</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">len</span><span class="p">)))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ptr</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">compat_alloc_user_space</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:1}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../javascript/docco.min.js"></script>
</html>
