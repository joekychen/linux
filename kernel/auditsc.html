<!DOCTYPE html>
<html><head><title>joekychen/linux » kernel › auditsc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../index.html"></a><h1>auditsc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* auditsc.c -- System-call auditing support</span>
<span class="cm"> * Handles all system-call specific auditing features.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2003-2004 Red Hat Inc., Durham, North Carolina.</span>
<span class="cm"> * Copyright 2005 Hewlett-Packard Development Company, L.P.</span>
<span class="cm"> * Copyright (C) 2005, 2006 IBM Corporation</span>
<span class="cm"> * All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> *</span>
<span class="cm"> * Written by Rickard E. (Rik) Faith &lt;faith@redhat.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Many of the ideas implemented here are from Stephen C. Tweedie,</span>
<span class="cm"> * especially the idea of avoiding a copy by using getname.</span>
<span class="cm"> *</span>
<span class="cm"> * The method for actual interception of syscall entry and exit (not in</span>
<span class="cm"> * this file -- see entry.S) is based on a GPL&#39;d patch written by</span>
<span class="cm"> * okir@suse.de and Copyright 2003 SuSE Linux AG.</span>
<span class="cm"> *</span>
<span class="cm"> * POSIX message queue support added by George Wilson &lt;ltcgcw@us.ibm.com&gt;,</span>
<span class="cm"> * 2006.</span>
<span class="cm"> *</span>
<span class="cm"> * The support of additional filter rules compares (&gt;, &lt;, &gt;=, &lt;=) was</span>
<span class="cm"> * added by Dustin Kirkland &lt;dustin.kirkland@us.ibm.com&gt;, 2005.</span>
<span class="cm"> *</span>
<span class="cm"> * Modified by Amy Griffis &lt;amy.griffis@hp.com&gt; to collect additional</span>
<span class="cm"> * filesystem information.</span>
<span class="cm"> *</span>
<span class="cm"> * Subject and object context labeling support added by &lt;danjones@us.ibm.com&gt;</span>
<span class="cm"> * and &lt;dustin.kirkland@us.ibm.com&gt; for LSPP certification compliance.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;asm/types.h&gt;</span>
<span class="cp">#include &lt;linux/atomic.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/namei.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/mount.h&gt;</span>
<span class="cp">#include &lt;linux/socket.h&gt;</span>
<span class="cp">#include &lt;linux/mqueue.h&gt;</span>
<span class="cp">#include &lt;linux/audit.h&gt;</span>
<span class="cp">#include &lt;linux/personality.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/netlink.h&gt;</span>
<span class="cp">#include &lt;linux/compiler.h&gt;</span>
<span class="cp">#include &lt;asm/unistd.h&gt;</span>
<span class="cp">#include &lt;linux/security.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/binfmts.h&gt;</span>
<span class="cp">#include &lt;linux/highmem.h&gt;</span>
<span class="cp">#include &lt;linux/syscalls.h&gt;</span>
<span class="cp">#include &lt;linux/capability.h&gt;</span>
<span class="cp">#include &lt;linux/fs_struct.h&gt;</span>
<span class="cp">#include &lt;linux/compat.h&gt;</span>

<span class="cp">#include &quot;audit.h&quot;</span>

<span class="cm">/* flags stating the success for a syscall */</span>
<span class="cp">#define AUDITSC_INVALID 0</span>
<span class="cp">#define AUDITSC_SUCCESS 1</span>
<span class="cp">#define AUDITSC_FAILURE 2</span>

<span class="cm">/* AUDIT_NAMES is the number of slots we reserve in the audit_context</span>
<span class="cm"> * for saving names from getname().  If we get more names we will allocate</span>
<span class="cm"> * a name dynamically and also add those to the list anchored by names_list. */</span>
<span class="cp">#define AUDIT_NAMES	5</span>

<span class="cm">/* Indicates that audit should log the full pathname. */</span>
<span class="cp">#define AUDIT_NAME_FULL -1</span>

<span class="cm">/* no execve audit message should be longer than this (userspace limits) */</span>
<span class="cp">#define MAX_EXECVE_AUDIT_LEN 7500</span>

<span class="cm">/* number of audit rules */</span>
<span class="kt">int</span> <span class="n">audit_n_rules</span><span class="p">;</span>

<span class="cm">/* determines whether we collect data for signals sent */</span>
<span class="kt">int</span> <span class="n">audit_signals</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">audit_cap_data</span> <span class="p">{</span>
	<span class="n">kernel_cap_t</span>		<span class="n">permitted</span><span class="p">;</span>
	<span class="n">kernel_cap_t</span>		<span class="n">inheritable</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">fE</span><span class="p">;</span>		<span class="cm">/* effective bit of a file capability */</span>
		<span class="n">kernel_cap_t</span>	<span class="n">effective</span><span class="p">;</span>	<span class="cm">/* effective set of a process */</span>
	<span class="p">};</span>
<span class="p">};</span>

<span class="cm">/* When fs/namei.c:getname() is called, we store the pointer in name and</span>
<span class="cm"> * we don&#39;t let putname() free it (instead we free all of the saved</span>
<span class="cm"> * pointers at syscall exit time).</span>
<span class="cm"> *</span>
<span class="cm"> * Further, in fs/namei.c:path_lookup() we store the inode and device. */</span>
<span class="k">struct</span> <span class="n">audit_names</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>		<span class="cm">/* audit_context-&gt;names_list */</span>
	<span class="k">const</span> <span class="kt">char</span>	<span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">ino</span><span class="p">;</span>
	<span class="n">dev_t</span>		<span class="n">dev</span><span class="p">;</span>
	<span class="n">umode_t</span>		<span class="n">mode</span><span class="p">;</span>
	<span class="n">uid_t</span>		<span class="n">uid</span><span class="p">;</span>
	<span class="n">gid_t</span>		<span class="n">gid</span><span class="p">;</span>
	<span class="n">dev_t</span>		<span class="n">rdev</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">osid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">audit_cap_data</span> <span class="n">fcap</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">fcap_ver</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">name_len</span><span class="p">;</span>	<span class="cm">/* number of name&#39;s characters to log */</span>
	<span class="n">bool</span>		<span class="n">name_put</span><span class="p">;</span>	<span class="cm">/* call __putname() for this name */</span>
	<span class="cm">/*</span>
<span class="cm">	 * This was an allocated audit_names and not from the array of</span>
<span class="cm">	 * names allocated in the task audit context.  Thus this name</span>
<span class="cm">	 * should be freed on syscall exit</span>
<span class="cm">	 */</span>
	<span class="n">bool</span>		<span class="n">should_free</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">audit_aux_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_aux_data</span>	<span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">type</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define AUDIT_AUX_IPCPERM	0</span>

<span class="cm">/* Number of target pids per aux struct. */</span>
<span class="cp">#define AUDIT_AUX_PIDS	16</span>

<span class="k">struct</span> <span class="n">audit_aux_data_execve</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_aux_data</span>	<span class="n">d</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">argc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">envc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">audit_aux_data_pids</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_aux_data</span>	<span class="n">d</span><span class="p">;</span>
	<span class="n">pid_t</span>			<span class="n">target_pid</span><span class="p">[</span><span class="n">AUDIT_AUX_PIDS</span><span class="p">];</span>
	<span class="n">uid_t</span>			<span class="n">target_auid</span><span class="p">[</span><span class="n">AUDIT_AUX_PIDS</span><span class="p">];</span>
	<span class="n">uid_t</span>			<span class="n">target_uid</span><span class="p">[</span><span class="n">AUDIT_AUX_PIDS</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">target_sessionid</span><span class="p">[</span><span class="n">AUDIT_AUX_PIDS</span><span class="p">];</span>
	<span class="n">u32</span>			<span class="n">target_sid</span><span class="p">[</span><span class="n">AUDIT_AUX_PIDS</span><span class="p">];</span>
	<span class="kt">char</span> 			<span class="n">target_comm</span><span class="p">[</span><span class="n">AUDIT_AUX_PIDS</span><span class="p">][</span><span class="n">TASK_COMM_LEN</span><span class="p">];</span>
	<span class="kt">int</span>			<span class="n">pid_count</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">audit_aux_data_bprm_fcaps</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_aux_data</span>	<span class="n">d</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">audit_cap_data</span>	<span class="n">fcap</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">fcap_ver</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">audit_cap_data</span>	<span class="n">old_pcap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">audit_cap_data</span>	<span class="n">new_pcap</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">audit_aux_data_capset</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_aux_data</span>	<span class="n">d</span><span class="p">;</span>
	<span class="n">pid_t</span>			<span class="n">pid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">audit_cap_data</span>	<span class="n">cap</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">audit_tree_refs</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_tree_refs</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">audit_chunk</span> <span class="o">*</span><span class="n">c</span><span class="p">[</span><span class="mi">31</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* The per-task audit context. */</span>
<span class="k">struct</span> <span class="n">audit_context</span> <span class="p">{</span>
	<span class="kt">int</span>		    <span class="n">dummy</span><span class="p">;</span>	<span class="cm">/* must be the first element */</span>
	<span class="kt">int</span>		    <span class="n">in_syscall</span><span class="p">;</span>	<span class="cm">/* 1 if task is in a syscall */</span>
	<span class="k">enum</span> <span class="n">audit_state</span>    <span class="n">state</span><span class="p">,</span> <span class="n">current_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	    <span class="n">serial</span><span class="p">;</span>     <span class="cm">/* serial number for record */</span>
	<span class="kt">int</span>		    <span class="n">major</span><span class="p">;</span>      <span class="cm">/* syscall number */</span>
	<span class="k">struct</span> <span class="n">timespec</span>	    <span class="n">ctime</span><span class="p">;</span>      <span class="cm">/* time of syscall entry */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	    <span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>    <span class="cm">/* syscall arguments */</span>
	<span class="kt">long</span>		    <span class="n">return_code</span><span class="p">;</span><span class="cm">/* syscall return code */</span>
	<span class="n">u64</span>		    <span class="n">prio</span><span class="p">;</span>
	<span class="kt">int</span>		    <span class="n">return_valid</span><span class="p">;</span> <span class="cm">/* return code is valid */</span>
	<span class="cm">/*</span>
<span class="cm">	 * The names_list is the list of all audit_names collected during this</span>
<span class="cm">	 * syscall.  The first AUDIT_NAMES entries in the names_list will</span>
<span class="cm">	 * actually be from the preallocated_names array for performance</span>
<span class="cm">	 * reasons.  Except during allocation they should never be referenced</span>
<span class="cm">	 * through the preallocated_names array and should only be found/used</span>
<span class="cm">	 * by running the names_list.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">audit_names</span>  <span class="n">preallocated_names</span><span class="p">[</span><span class="n">AUDIT_NAMES</span><span class="p">];</span>
	<span class="kt">int</span>		    <span class="n">name_count</span><span class="p">;</span> <span class="cm">/* total records in names_list */</span>
	<span class="k">struct</span> <span class="n">list_head</span>    <span class="n">names_list</span><span class="p">;</span>	<span class="cm">/* anchor for struct audit_names-&gt;list */</span>
	<span class="kt">char</span> <span class="o">*</span>		    <span class="n">filterkey</span><span class="p">;</span>	<span class="cm">/* key for rule that triggered record */</span>
	<span class="k">struct</span> <span class="n">path</span>	    <span class="n">pwd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">previous</span><span class="p">;</span> <span class="cm">/* For nested syscalls */</span>
	<span class="k">struct</span> <span class="n">audit_aux_data</span> <span class="o">*</span><span class="n">aux</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">audit_aux_data</span> <span class="o">*</span><span class="n">aux_pids</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="o">*</span><span class="n">sockaddr</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">sockaddr_len</span><span class="p">;</span>
				<span class="cm">/* Save things to print about task_struct */</span>
	<span class="n">pid_t</span>		    <span class="n">pid</span><span class="p">,</span> <span class="n">ppid</span><span class="p">;</span>
	<span class="n">uid_t</span>		    <span class="n">uid</span><span class="p">,</span> <span class="n">euid</span><span class="p">,</span> <span class="n">suid</span><span class="p">,</span> <span class="n">fsuid</span><span class="p">;</span>
	<span class="n">gid_t</span>		    <span class="n">gid</span><span class="p">,</span> <span class="n">egid</span><span class="p">,</span> <span class="n">sgid</span><span class="p">,</span> <span class="n">fsgid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	    <span class="n">personality</span><span class="p">;</span>
	<span class="kt">int</span>		    <span class="n">arch</span><span class="p">;</span>

	<span class="n">pid_t</span>		    <span class="n">target_pid</span><span class="p">;</span>
	<span class="n">uid_t</span>		    <span class="n">target_auid</span><span class="p">;</span>
	<span class="n">uid_t</span>		    <span class="n">target_uid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	    <span class="n">target_sessionid</span><span class="p">;</span>
	<span class="n">u32</span>		    <span class="n">target_sid</span><span class="p">;</span>
	<span class="kt">char</span>		    <span class="n">target_comm</span><span class="p">[</span><span class="n">TASK_COMM_LEN</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">audit_tree_refs</span> <span class="o">*</span><span class="n">trees</span><span class="p">,</span> <span class="o">*</span><span class="n">first_trees</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">killed_trees</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tree_count</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">nargs</span><span class="p">;</span>
			<span class="kt">long</span> <span class="n">args</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
		<span class="p">}</span> <span class="n">socketcall</span><span class="p">;</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">uid_t</span>			<span class="n">uid</span><span class="p">;</span>
			<span class="n">gid_t</span>			<span class="n">gid</span><span class="p">;</span>
			<span class="n">umode_t</span>			<span class="n">mode</span><span class="p">;</span>
			<span class="n">u32</span>			<span class="n">osid</span><span class="p">;</span>
			<span class="kt">int</span>			<span class="n">has_perm</span><span class="p">;</span>
			<span class="n">uid_t</span>			<span class="n">perm_uid</span><span class="p">;</span>
			<span class="n">gid_t</span>			<span class="n">perm_gid</span><span class="p">;</span>
			<span class="n">umode_t</span>			<span class="n">perm_mode</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">qbytes</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">ipc</span><span class="p">;</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">mqd_t</span>			<span class="n">mqdes</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">mq_attr</span> 		<span class="n">mqstat</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">mq_getsetattr</span><span class="p">;</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">mqd_t</span>			<span class="n">mqdes</span><span class="p">;</span>
			<span class="kt">int</span>			<span class="n">sigev_signo</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">mq_notify</span><span class="p">;</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">mqd_t</span>			<span class="n">mqdes</span><span class="p">;</span>
			<span class="kt">size_t</span>			<span class="n">msg_len</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">msg_prio</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">timespec</span>		<span class="n">abs_timeout</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">mq_sendrecv</span><span class="p">;</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="kt">int</span>			<span class="n">oflag</span><span class="p">;</span>
			<span class="n">umode_t</span>			<span class="n">mode</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">mq_attr</span>		<span class="n">attr</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">mq_open</span><span class="p">;</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">pid_t</span>			<span class="n">pid</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">audit_cap_data</span>	<span class="n">cap</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">capset</span><span class="p">;</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="kt">int</span>			<span class="n">fd</span><span class="p">;</span>
			<span class="kt">int</span>			<span class="n">flags</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">mmap</span><span class="p">;</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">fds</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="cp">#if AUDIT_DEBUG</span>
	<span class="kt">int</span>		    <span class="n">put_count</span><span class="p">;</span>
	<span class="kt">int</span>		    <span class="n">ino_count</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">open_arg</span><span class="p">(</span><span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">ACC_MODE</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">O_TRUNC</span> <span class="o">|</span> <span class="n">O_CREAT</span><span class="p">))</span>
		<span class="n">n</span> <span class="o">|=</span> <span class="n">AUDIT_PERM_WRITE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">n</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">audit_match_perm</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">audit_classify_syscall</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:	<span class="cm">/* native */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AUDIT_PERM_WRITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">audit_match_class</span><span class="p">(</span><span class="n">AUDIT_CLASS_WRITE</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AUDIT_PERM_READ</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">audit_match_class</span><span class="p">(</span><span class="n">AUDIT_CLASS_READ</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AUDIT_PERM_ATTR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">audit_match_class</span><span class="p">(</span><span class="n">AUDIT_CLASS_CHATTR</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* 32bit on biarch */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AUDIT_PERM_WRITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">audit_match_class</span><span class="p">(</span><span class="n">AUDIT_CLASS_WRITE_32</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AUDIT_PERM_READ</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">audit_match_class</span><span class="p">(</span><span class="n">AUDIT_CLASS_READ_32</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AUDIT_PERM_ATTR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">audit_match_class</span><span class="p">(</span><span class="n">AUDIT_CLASS_CHATTR_32</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* open */</span>
		<span class="k">return</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">ACC_MODE</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* openat */</span>
		<span class="k">return</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">ACC_MODE</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="k">case</span> <span class="mi">4</span>: <span class="cm">/* socketcall */</span>
		<span class="k">return</span> <span class="p">((</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AUDIT_PERM_WRITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">SYS_BIND</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">5</span>: <span class="cm">/* execve */</span>
		<span class="k">return</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AUDIT_PERM_EXEC</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">audit_match_filetype</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_names</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="n">umode_t</span> <span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">umode_t</span><span class="p">)</span><span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">names_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">ino</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">S_IFMT</span><span class="p">)</span> <span class="o">==</span> <span class="n">mode</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We keep a linked list of fixed-sized (31 pointer) arrays of audit_chunk *;</span>
<span class="cm"> * -&gt;first_trees points to its beginning, -&gt;trees - to the current end of data.</span>
<span class="cm"> * -&gt;tree_count is the number of free entries in array pointed to by -&gt;trees.</span>
<span class="cm"> * Original condition is (NULL, NULL, 0); as soon as it grows we never revert to NULL,</span>
<span class="cm"> * &quot;empty&quot; becomes (p, p, 31) afterwards.  We don&#39;t shrink the list (and seriously,</span>
<span class="cm"> * it&#39;s going to remain 1-element for almost any setup) until we free context itself.</span>
<span class="cm"> * References in it _are_ dropped - at the same time we free/drop aux stuff.</span>
<span class="cm"> */</span>

<span class="cp">#ifdef CONFIG_AUDIT_TREE</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">audit_set_auditable</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">prio</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">current_state</span> <span class="o">=</span> <span class="n">AUDIT_RECORD_CONTEXT</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">put_tree_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">audit_chunk</span> <span class="o">*</span><span class="n">chunk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_tree_refs</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">trees</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">left</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tree_count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">left</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="o">--</span><span class="n">left</span><span class="p">]</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tree_count</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">trees</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tree_count</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">grow_tree_refs</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_tree_refs</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">trees</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">trees</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_tree_refs</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">trees</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">trees</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">trees</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">first_trees</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">trees</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tree_count</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">unroll_tree_refs</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">audit_tree_refs</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_AUDIT_TREE</span>
	<span class="k">struct</span> <span class="n">audit_tree_refs</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we started with empty chain */</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">first_trees</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span>
		<span class="cm">/* if the very first allocation has failed, nothing to do */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">q</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span> <span class="n">q</span> <span class="o">!=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">trees</span><span class="p">;</span> <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">31</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">audit_put_chunk</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">n</span><span class="p">]);</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="o">--</span> <span class="o">&gt;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tree_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">audit_put_chunk</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">n</span><span class="p">]);</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">trees</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tree_count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_tree_refs</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_tree_refs</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">first_trees</span><span class="p">;</span> <span class="n">p</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">q</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">match_tree_refs</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">audit_tree</span> <span class="o">*</span><span class="n">tree</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_AUDIT_TREE</span>
	<span class="k">struct</span> <span class="n">audit_tree_refs</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tree</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* full ones */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">first_trees</span><span class="p">;</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">trees</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">31</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">audit_tree_match</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">tree</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* partial */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tree_count</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">31</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">audit_tree_match</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">tree</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">audit_compare_id</span><span class="p">(</span><span class="n">uid_t</span> <span class="n">uid1</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">audit_names</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">name_offset</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">audit_field</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_names</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">uid_t</span> <span class="n">uid2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">uid_t</span><span class="p">)</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gid_t</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">name</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="n">name_offset</span><span class="p">;</span>

		<span class="n">uid2</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">uid_t</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">audit_comparator</span><span class="p">(</span><span class="n">uid1</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">uid2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">names_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">n</span><span class="p">;</span>
			<span class="n">addr</span> <span class="o">+=</span> <span class="n">name_offset</span><span class="p">;</span>

			<span class="n">uid2</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">uid_t</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>

			<span class="n">rc</span> <span class="o">=</span> <span class="n">audit_comparator</span><span class="p">(</span><span class="n">uid1</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">uid2</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">audit_field_compare</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">tsk</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">audit_field</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">audit_names</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* process to file object comparisons */</span>
	<span class="k">case</span> <span class="n">AUDIT_COMPARE_UID_TO_OBJ_UID</span>:
		<span class="k">return</span> <span class="n">audit_compare_id</span><span class="p">(</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">,</span>
					<span class="n">name</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_names</span><span class="p">,</span> <span class="n">uid</span><span class="p">),</span>
					<span class="n">f</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">AUDIT_COMPARE_GID_TO_OBJ_GID</span>:
		<span class="k">return</span> <span class="n">audit_compare_id</span><span class="p">(</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">gid</span><span class="p">,</span>
					<span class="n">name</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_names</span><span class="p">,</span> <span class="n">gid</span><span class="p">),</span>
					<span class="n">f</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">AUDIT_COMPARE_EUID_TO_OBJ_UID</span>:
		<span class="k">return</span> <span class="n">audit_compare_id</span><span class="p">(</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">euid</span><span class="p">,</span>
					<span class="n">name</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_names</span><span class="p">,</span> <span class="n">uid</span><span class="p">),</span>
					<span class="n">f</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">AUDIT_COMPARE_EGID_TO_OBJ_GID</span>:
		<span class="k">return</span> <span class="n">audit_compare_id</span><span class="p">(</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">egid</span><span class="p">,</span>
					<span class="n">name</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_names</span><span class="p">,</span> <span class="n">gid</span><span class="p">),</span>
					<span class="n">f</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">AUDIT_COMPARE_AUID_TO_OBJ_UID</span>:
		<span class="k">return</span> <span class="n">audit_compare_id</span><span class="p">(</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="n">loginuid</span><span class="p">,</span>
					<span class="n">name</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_names</span><span class="p">,</span> <span class="n">uid</span><span class="p">),</span>
					<span class="n">f</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">AUDIT_COMPARE_SUID_TO_OBJ_UID</span>:
		<span class="k">return</span> <span class="n">audit_compare_id</span><span class="p">(</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">suid</span><span class="p">,</span>
					<span class="n">name</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_names</span><span class="p">,</span> <span class="n">uid</span><span class="p">),</span>
					<span class="n">f</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">AUDIT_COMPARE_SGID_TO_OBJ_GID</span>:
		<span class="k">return</span> <span class="n">audit_compare_id</span><span class="p">(</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">sgid</span><span class="p">,</span>
					<span class="n">name</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_names</span><span class="p">,</span> <span class="n">gid</span><span class="p">),</span>
					<span class="n">f</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">AUDIT_COMPARE_FSUID_TO_OBJ_UID</span>:
		<span class="k">return</span> <span class="n">audit_compare_id</span><span class="p">(</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">fsuid</span><span class="p">,</span>
					<span class="n">name</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_names</span><span class="p">,</span> <span class="n">uid</span><span class="p">),</span>
					<span class="n">f</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">AUDIT_COMPARE_FSGID_TO_OBJ_GID</span>:
		<span class="k">return</span> <span class="n">audit_compare_id</span><span class="p">(</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">fsgid</span><span class="p">,</span>
					<span class="n">name</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_names</span><span class="p">,</span> <span class="n">gid</span><span class="p">),</span>
					<span class="n">f</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
	<span class="cm">/* uid comparisons */</span>
	<span class="k">case</span> <span class="n">AUDIT_COMPARE_UID_TO_AUID</span>:
		<span class="k">return</span> <span class="n">audit_comparator</span><span class="p">(</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">tsk</span><span class="o">-&gt;</span><span class="n">loginuid</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">AUDIT_COMPARE_UID_TO_EUID</span>:
		<span class="k">return</span> <span class="n">audit_comparator</span><span class="p">(</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">cred</span><span class="o">-&gt;</span><span class="n">euid</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">AUDIT_COMPARE_UID_TO_SUID</span>:
		<span class="k">return</span> <span class="n">audit_comparator</span><span class="p">(</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">cred</span><span class="o">-&gt;</span><span class="n">suid</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">AUDIT_COMPARE_UID_TO_FSUID</span>:
		<span class="k">return</span> <span class="n">audit_comparator</span><span class="p">(</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">cred</span><span class="o">-&gt;</span><span class="n">fsuid</span><span class="p">);</span>
	<span class="cm">/* auid comparisons */</span>
	<span class="k">case</span> <span class="n">AUDIT_COMPARE_AUID_TO_EUID</span>:
		<span class="k">return</span> <span class="n">audit_comparator</span><span class="p">(</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="n">loginuid</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">cred</span><span class="o">-&gt;</span><span class="n">euid</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">AUDIT_COMPARE_AUID_TO_SUID</span>:
		<span class="k">return</span> <span class="n">audit_comparator</span><span class="p">(</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="n">loginuid</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">cred</span><span class="o">-&gt;</span><span class="n">suid</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">AUDIT_COMPARE_AUID_TO_FSUID</span>:
		<span class="k">return</span> <span class="n">audit_comparator</span><span class="p">(</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="n">loginuid</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">cred</span><span class="o">-&gt;</span><span class="n">fsuid</span><span class="p">);</span>
	<span class="cm">/* euid comparisons */</span>
	<span class="k">case</span> <span class="n">AUDIT_COMPARE_EUID_TO_SUID</span>:
		<span class="k">return</span> <span class="n">audit_comparator</span><span class="p">(</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">euid</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">cred</span><span class="o">-&gt;</span><span class="n">suid</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">AUDIT_COMPARE_EUID_TO_FSUID</span>:
		<span class="k">return</span> <span class="n">audit_comparator</span><span class="p">(</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">euid</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">cred</span><span class="o">-&gt;</span><span class="n">fsuid</span><span class="p">);</span>
	<span class="cm">/* suid comparisons */</span>
	<span class="k">case</span> <span class="n">AUDIT_COMPARE_SUID_TO_FSUID</span>:
		<span class="k">return</span> <span class="n">audit_comparator</span><span class="p">(</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">suid</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">cred</span><span class="o">-&gt;</span><span class="n">fsuid</span><span class="p">);</span>
	<span class="cm">/* gid comparisons */</span>
	<span class="k">case</span> <span class="n">AUDIT_COMPARE_GID_TO_EGID</span>:
		<span class="k">return</span> <span class="n">audit_comparator</span><span class="p">(</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">gid</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">cred</span><span class="o">-&gt;</span><span class="n">egid</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">AUDIT_COMPARE_GID_TO_SGID</span>:
		<span class="k">return</span> <span class="n">audit_comparator</span><span class="p">(</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">gid</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">cred</span><span class="o">-&gt;</span><span class="n">sgid</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">AUDIT_COMPARE_GID_TO_FSGID</span>:
		<span class="k">return</span> <span class="n">audit_comparator</span><span class="p">(</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">gid</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">cred</span><span class="o">-&gt;</span><span class="n">fsgid</span><span class="p">);</span>
	<span class="cm">/* egid comparisons */</span>
	<span class="k">case</span> <span class="n">AUDIT_COMPARE_EGID_TO_SGID</span>:
		<span class="k">return</span> <span class="n">audit_comparator</span><span class="p">(</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">egid</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">cred</span><span class="o">-&gt;</span><span class="n">sgid</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">AUDIT_COMPARE_EGID_TO_FSGID</span>:
		<span class="k">return</span> <span class="n">audit_comparator</span><span class="p">(</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">egid</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">cred</span><span class="o">-&gt;</span><span class="n">fsgid</span><span class="p">);</span>
	<span class="cm">/* sgid comparison */</span>
	<span class="k">case</span> <span class="n">AUDIT_COMPARE_SGID_TO_FSGID</span>:
		<span class="k">return</span> <span class="n">audit_comparator</span><span class="p">(</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">sgid</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">cred</span><span class="o">-&gt;</span><span class="n">fsgid</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="n">WARN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Missing AUDIT_COMPARE define.  Report as a bug</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Determine if any context name data matches a rule&#39;s watch data */</span>
<span class="cm">/* Compare a task_struct with an audit_rule.  Return 1 on match, 0</span>
<span class="cm"> * otherwise.</span>
<span class="cm"> *</span>
<span class="cm"> * If task_creation is true, this is an explicit indication that we are</span>
<span class="cm"> * filtering a task rule at task creation time.  This and tsk == current are</span>
<span class="cm"> * the only situations where tsk-&gt;cred may be accessed without an rcu read lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">audit_filter_rules</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">tsk</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">audit_krule</span> <span class="o">*</span><span class="n">rule</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">audit_names</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
			      <span class="k">enum</span> <span class="n">audit_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
			      <span class="n">bool</span> <span class="n">task_creation</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">need_sid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sid</span><span class="p">;</span>

	<span class="n">cred</span> <span class="o">=</span> <span class="n">rcu_dereference_check</span><span class="p">(</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="n">cred</span><span class="p">,</span> <span class="n">tsk</span> <span class="o">==</span> <span class="n">current</span> <span class="o">||</span> <span class="n">task_creation</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rule</span><span class="o">-&gt;</span><span class="n">field_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">audit_field</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rule</span><span class="o">-&gt;</span><span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">audit_names</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">AUDIT_PID</span>:
			<span class="n">result</span> <span class="o">=</span> <span class="n">audit_comparator</span><span class="p">(</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AUDIT_PPID</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ppid</span><span class="p">)</span>
					<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ppid</span> <span class="o">=</span> <span class="n">sys_getppid</span><span class="p">();</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">audit_comparator</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ppid</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AUDIT_UID</span>:
			<span class="n">result</span> <span class="o">=</span> <span class="n">audit_comparator</span><span class="p">(</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AUDIT_EUID</span>:
			<span class="n">result</span> <span class="o">=</span> <span class="n">audit_comparator</span><span class="p">(</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">euid</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AUDIT_SUID</span>:
			<span class="n">result</span> <span class="o">=</span> <span class="n">audit_comparator</span><span class="p">(</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">suid</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AUDIT_FSUID</span>:
			<span class="n">result</span> <span class="o">=</span> <span class="n">audit_comparator</span><span class="p">(</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">fsuid</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AUDIT_GID</span>:
			<span class="n">result</span> <span class="o">=</span> <span class="n">audit_comparator</span><span class="p">(</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">gid</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AUDIT_EGID</span>:
			<span class="n">result</span> <span class="o">=</span> <span class="n">audit_comparator</span><span class="p">(</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">egid</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AUDIT_SGID</span>:
			<span class="n">result</span> <span class="o">=</span> <span class="n">audit_comparator</span><span class="p">(</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">sgid</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AUDIT_FSGID</span>:
			<span class="n">result</span> <span class="o">=</span> <span class="n">audit_comparator</span><span class="p">(</span><span class="n">cred</span><span class="o">-&gt;</span><span class="n">fsgid</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AUDIT_PERS</span>:
			<span class="n">result</span> <span class="o">=</span> <span class="n">audit_comparator</span><span class="p">(</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="n">personality</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AUDIT_ARCH</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">audit_comparator</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">AUDIT_EXIT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span> <span class="o">&amp;&amp;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">return_valid</span><span class="p">)</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">audit_comparator</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">return_code</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AUDIT_SUCCESS</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span> <span class="o">&amp;&amp;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">return_valid</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span>
					<span class="n">result</span> <span class="o">=</span> <span class="n">audit_comparator</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">return_valid</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">AUDITSC_SUCCESS</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">result</span> <span class="o">=</span> <span class="n">audit_comparator</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">return_valid</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">AUDITSC_FAILURE</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AUDIT_DEVMAJOR</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">audit_comparator</span><span class="p">(</span><span class="n">MAJOR</span><span class="p">(</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span> <span class="o">||</span>
				    <span class="n">audit_comparator</span><span class="p">(</span><span class="n">MAJOR</span><span class="p">(</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">),</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">))</span>
					<span class="o">++</span><span class="n">result</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">names_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">audit_comparator</span><span class="p">(</span><span class="n">MAJOR</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span> <span class="o">||</span>
					    <span class="n">audit_comparator</span><span class="p">(</span><span class="n">MAJOR</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">),</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">))</span> <span class="p">{</span>
						<span class="o">++</span><span class="n">result</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AUDIT_DEVMINOR</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">audit_comparator</span><span class="p">(</span><span class="n">MINOR</span><span class="p">(</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span> <span class="o">||</span>
				    <span class="n">audit_comparator</span><span class="p">(</span><span class="n">MINOR</span><span class="p">(</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">),</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">))</span>
					<span class="o">++</span><span class="n">result</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">names_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">audit_comparator</span><span class="p">(</span><span class="n">MINOR</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span> <span class="o">||</span>
					    <span class="n">audit_comparator</span><span class="p">(</span><span class="n">MINOR</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">),</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">))</span> <span class="p">{</span>
						<span class="o">++</span><span class="n">result</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AUDIT_INODE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span>
				<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">ino</span> <span class="o">==</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">names_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">audit_comparator</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">))</span> <span class="p">{</span>
						<span class="o">++</span><span class="n">result</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AUDIT_OBJ_UID</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">audit_comparator</span><span class="p">(</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">names_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">audit_comparator</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">))</span> <span class="p">{</span>
						<span class="o">++</span><span class="n">result</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AUDIT_OBJ_GID</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">audit_comparator</span><span class="p">(</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">gid</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">names_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">audit_comparator</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">gid</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">))</span> <span class="p">{</span>
						<span class="o">++</span><span class="n">result</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AUDIT_WATCH</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">audit_watch_compare</span><span class="p">(</span><span class="n">rule</span><span class="o">-&gt;</span><span class="n">watch</span><span class="p">,</span> <span class="n">name</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">,</span> <span class="n">name</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AUDIT_DIR</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">match_tree_refs</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">rule</span><span class="o">-&gt;</span><span class="n">tree</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AUDIT_LOGINUID</span>:
			<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">audit_comparator</span><span class="p">(</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="n">loginuid</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AUDIT_SUBJ_USER</span>:
		<span class="k">case</span> <span class="n">AUDIT_SUBJ_ROLE</span>:
		<span class="k">case</span> <span class="n">AUDIT_SUBJ_TYPE</span>:
		<span class="k">case</span> <span class="n">AUDIT_SUBJ_SEN</span>:
		<span class="k">case</span> <span class="n">AUDIT_SUBJ_CLR</span>:
			<span class="cm">/* NOTE: this may return negative values indicating</span>
<span class="cm">			   a temporary error.  We simply treat this as a</span>
<span class="cm">			   match for now to avoid losing information that</span>
<span class="cm">			   may be wanted.   An error message will also be</span>
<span class="cm">			   logged upon error */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">lsm_rule</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">need_sid</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">security_task_getsecid</span><span class="p">(</span><span class="n">tsk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sid</span><span class="p">);</span>
					<span class="n">need_sid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">security_audit_rule_match</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
				                                  <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span>
				                                  <span class="n">f</span><span class="o">-&gt;</span><span class="n">lsm_rule</span><span class="p">,</span>
				                                  <span class="n">ctx</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AUDIT_OBJ_USER</span>:
		<span class="k">case</span> <span class="n">AUDIT_OBJ_ROLE</span>:
		<span class="k">case</span> <span class="n">AUDIT_OBJ_TYPE</span>:
		<span class="k">case</span> <span class="n">AUDIT_OBJ_LEV_LOW</span>:
		<span class="k">case</span> <span class="n">AUDIT_OBJ_LEV_HIGH</span>:
			<span class="cm">/* The above note for AUDIT_SUBJ_USER...AUDIT_SUBJ_CLR</span>
<span class="cm">			   also applies here */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">lsm_rule</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Find files that match */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">result</span> <span class="o">=</span> <span class="n">security_audit_rule_match</span><span class="p">(</span>
					           <span class="n">name</span><span class="o">-&gt;</span><span class="n">osid</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span>
					           <span class="n">f</span><span class="o">-&gt;</span><span class="n">lsm_rule</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">names_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">security_audit_rule_match</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">osid</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
									      <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">lsm_rule</span><span class="p">,</span>
									      <span class="n">ctx</span><span class="p">))</span> <span class="p">{</span>
							<span class="o">++</span><span class="n">result</span><span class="p">;</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="cm">/* Find ipc objects that match */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span> <span class="o">||</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">AUDIT_IPC</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">security_audit_rule_match</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ipc</span><span class="p">.</span><span class="n">osid</span><span class="p">,</span>
							      <span class="n">f</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span>
							      <span class="n">f</span><span class="o">-&gt;</span><span class="n">lsm_rule</span><span class="p">,</span> <span class="n">ctx</span><span class="p">))</span>
					<span class="o">++</span><span class="n">result</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AUDIT_ARG0</span>:
		<span class="k">case</span> <span class="n">AUDIT_ARG1</span>:
		<span class="k">case</span> <span class="n">AUDIT_ARG2</span>:
		<span class="k">case</span> <span class="n">AUDIT_ARG3</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">audit_comparator</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-</span><span class="n">AUDIT_ARG0</span><span class="p">],</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AUDIT_FILTERKEY</span>:
			<span class="cm">/* ignore this field for filtering */</span>
			<span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AUDIT_PERM</span>:
			<span class="n">result</span> <span class="o">=</span> <span class="n">audit_match_perm</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AUDIT_FILETYPE</span>:
			<span class="n">result</span> <span class="o">=</span> <span class="n">audit_match_filetype</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AUDIT_FIELD_COMPARE</span>:
			<span class="n">result</span> <span class="o">=</span> <span class="n">audit_field_compare</span><span class="p">(</span><span class="n">tsk</span><span class="p">,</span> <span class="n">cred</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rule</span><span class="o">-&gt;</span><span class="n">prio</span> <span class="o">&lt;=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rule</span><span class="o">-&gt;</span><span class="n">filterkey</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">filterkey</span><span class="p">);</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">filterkey</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">rule</span><span class="o">-&gt;</span><span class="n">filterkey</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">prio</span> <span class="o">=</span> <span class="n">rule</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rule</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AUDIT_NEVER</span>:    <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">AUDIT_DISABLED</span><span class="p">;</span>	    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AUDIT_ALWAYS</span>:   <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">AUDIT_RECORD_CONTEXT</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* At process creation time, we can determine if system-call auditing is</span>
<span class="cm"> * completely disabled for this task.  Since we only have the task</span>
<span class="cm"> * structure at this point, we can only check uid and gid.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">audit_state</span> <span class="nf">audit_filter_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">tsk</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">audit_state</span>   <span class="n">state</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">audit_filter_list</span><span class="p">[</span><span class="n">AUDIT_FILTER_TASK</span><span class="p">],</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">audit_filter_rules</span><span class="p">(</span><span class="n">tsk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">rule</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">state</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">AUDIT_RECORD_CONTEXT</span><span class="p">)</span>
				<span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">rule</span><span class="p">.</span><span class="n">filterkey</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="n">rcu_read_unlock</span><span class="p">();</span>
			<span class="k">return</span> <span class="n">state</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">AUDIT_BUILD_CONTEXT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* At syscall entry and exit time, this filter is called if the</span>
<span class="cm"> * audit_state is not low enough that auditing cannot take place, but is</span>
<span class="cm"> * also not high enough that we already know we have to write an audit</span>
<span class="cm"> * record (i.e., the state is AUDIT_SETUP_CONTEXT or AUDIT_BUILD_CONTEXT).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">audit_state</span> <span class="nf">audit_filter_syscall</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">tsk</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">audit_state</span> <span class="n">state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">audit_pid</span> <span class="o">&amp;&amp;</span> <span class="n">tsk</span><span class="o">-&gt;</span><span class="n">tgid</span> <span class="o">==</span> <span class="n">audit_pid</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">AUDIT_DISABLED</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">list</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">word</span> <span class="o">=</span> <span class="n">AUDIT_WORD</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">bit</span>  <span class="o">=</span> <span class="n">AUDIT_BIT</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">);</span>

		<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">rule</span><span class="p">.</span><span class="n">mask</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">)</span> <span class="o">==</span> <span class="n">bit</span> <span class="o">&amp;&amp;</span>
			    <span class="n">audit_filter_rules</span><span class="p">(</span><span class="n">tsk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">rule</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">state</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rcu_read_unlock</span><span class="p">();</span>
				<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">current_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">state</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">AUDIT_BUILD_CONTEXT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Given an audit_name check the inode hash table to see if they match.</span>
<span class="cm"> * Called holding the rcu read lock to protect the use of audit_inode_hash</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">audit_filter_inode_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">tsk</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">audit_names</span> <span class="o">*</span><span class="n">n</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">word</span><span class="p">,</span> <span class="n">bit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="n">audit_hash_ino</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">audit_inode_hash</span><span class="p">[</span><span class="n">h</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">audit_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">audit_state</span> <span class="n">state</span><span class="p">;</span>

	<span class="n">word</span> <span class="o">=</span> <span class="n">AUDIT_WORD</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">);</span>
	<span class="n">bit</span>  <span class="o">=</span> <span class="n">AUDIT_BIT</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="n">list</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">rule</span><span class="p">.</span><span class="n">mask</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">)</span> <span class="o">==</span> <span class="n">bit</span> <span class="o">&amp;&amp;</span>
		    <span class="n">audit_filter_rules</span><span class="p">(</span><span class="n">tsk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">rule</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">current_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* At syscall exit time, this filter is called if any audit_names have been</span>
<span class="cm"> * collected during syscall processing.  We only check rules in sublists at hash</span>
<span class="cm"> * buckets applicable to the inode numbers in audit_names.</span>
<span class="cm"> * Regarding audit_state, same rules apply as for audit_filter_syscall().</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">audit_filter_inodes</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">tsk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_names</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">audit_pid</span> <span class="o">&amp;&amp;</span> <span class="n">tsk</span><span class="o">-&gt;</span><span class="n">tgid</span> <span class="o">==</span> <span class="n">audit_pid</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">names_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">audit_filter_inode_name</span><span class="p">(</span><span class="n">tsk</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">ctx</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="nf">audit_get_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">tsk</span><span class="p">,</span>
						      <span class="kt">int</span> <span class="n">return_valid</span><span class="p">,</span>
						      <span class="kt">long</span> <span class="n">return_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span> <span class="o">=</span> <span class="n">tsk</span><span class="o">-&gt;</span><span class="n">audit_context</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">context</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">return_valid</span> <span class="o">=</span> <span class="n">return_valid</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * we need to fix up the return code in the audit logs if the actual</span>
<span class="cm">	 * return codes are later going to be fixed up by the arch specific</span>
<span class="cm">	 * signal handlers</span>
<span class="cm">	 *</span>
<span class="cm">	 * This is actually a test for:</span>
<span class="cm">	 * (rc == ERESTARTSYS ) || (rc == ERESTARTNOINTR) ||</span>
<span class="cm">	 * (rc == ERESTARTNOHAND) || (rc == ERESTART_RESTARTBLOCK)</span>
<span class="cm">	 *</span>
<span class="cm">	 * but is faster than a bunch of ||</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">return_code</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">return_code</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="n">ERESTART_RESTARTBLOCK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">return_code</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">))</span>
		<span class="n">context</span><span class="o">-&gt;</span><span class="n">return_code</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">context</span><span class="o">-&gt;</span><span class="n">return_code</span>  <span class="o">=</span> <span class="n">return_code</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">in_syscall</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">dummy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">audit_filter_syscall</span><span class="p">(</span><span class="n">tsk</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">audit_filter_list</span><span class="p">[</span><span class="n">AUDIT_FILTER_EXIT</span><span class="p">]);</span>
		<span class="n">audit_filter_inodes</span><span class="p">(</span><span class="n">tsk</span><span class="p">,</span> <span class="n">context</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tsk</span><span class="o">-&gt;</span><span class="n">audit_context</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">context</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">audit_free_names</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_names</span> <span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

<span class="cp">#if AUDIT_DEBUG == 2</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">put_count</span> <span class="o">+</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">ino_count</span> <span class="o">!=</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">name_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:%d(:%d): major=%d in_syscall=%d&quot;</span>
		       <span class="s">&quot; name_count=%d put_count=%d&quot;</span>
		       <span class="s">&quot; ino_count=%d [NOT freeing]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
		       <span class="n">context</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">in_syscall</span><span class="p">,</span>
		       <span class="n">context</span><span class="o">-&gt;</span><span class="n">name_count</span><span class="p">,</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">put_count</span><span class="p">,</span>
		       <span class="n">context</span><span class="o">-&gt;</span><span class="n">ino_count</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">names_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;names[%d] = %p = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			       <span class="n">n</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">?:</span> <span class="s">&quot;(null)&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">dump_stack</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#if AUDIT_DEBUG</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">put_count</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">ino_count</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">names_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">&amp;&amp;</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">name_put</span><span class="p">)</span>
			<span class="n">__putname</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">should_free</span><span class="p">)</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">name_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">path_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">pwd</span><span class="p">);</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">pwd</span><span class="p">.</span><span class="n">dentry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">pwd</span><span class="p">.</span><span class="n">mnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">audit_free_aux</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_aux_data</span> <span class="o">*</span><span class="n">aux</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">aux</span> <span class="o">=</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">aux</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">context</span><span class="o">-&gt;</span><span class="n">aux</span> <span class="o">=</span> <span class="n">aux</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">aux</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">aux</span> <span class="o">=</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">aux_pids</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">context</span><span class="o">-&gt;</span><span class="n">aux_pids</span> <span class="o">=</span> <span class="n">aux</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">aux</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">audit_zero_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span>
				      <span class="k">enum</span> <span class="n">audit_state</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">context</span><span class="p">));</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">state</span>      <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">prio</span> <span class="o">=</span> <span class="n">state</span> <span class="o">==</span> <span class="n">AUDIT_RECORD_CONTEXT</span> <span class="o">?</span> <span class="o">~</span><span class="mi">0ULL</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="nf">audit_alloc_context</span><span class="p">(</span><span class="k">enum</span> <span class="n">audit_state</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">context</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">context</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">)))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">audit_zero_context</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">killed_trees</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">names_list</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">context</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * audit_alloc - allocate an audit context block for a task</span>
<span class="cm"> * @tsk: task</span>
<span class="cm"> *</span>
<span class="cm"> * Filter on the task information and allocate a per-task audit context</span>
<span class="cm"> * if necessary.  Doing so turns on system call auditing for the</span>
<span class="cm"> * specified task.  This is called from copy_process, so no lock is</span>
<span class="cm"> * needed.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">audit_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">tsk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">audit_state</span>     <span class="n">state</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">audit_ever_enabled</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Return if not auditing. */</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">audit_filter_task</span><span class="p">(</span><span class="n">tsk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">AUDIT_DISABLED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">context</span> <span class="o">=</span> <span class="n">audit_alloc_context</span><span class="p">(</span><span class="n">state</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
		<span class="n">audit_log_lost</span><span class="p">(</span><span class="s">&quot;out of memory in audit_alloc&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">filterkey</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>

	<span class="n">tsk</span><span class="o">-&gt;</span><span class="n">audit_context</span>  <span class="o">=</span> <span class="n">context</span><span class="p">;</span>
	<span class="n">set_tsk_thread_flag</span><span class="p">(</span><span class="n">tsk</span><span class="p">,</span> <span class="n">TIF_SYSCALL_AUDIT</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">audit_free_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">previous</span><span class="p">;</span>
	<span class="kt">int</span>		     <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">previous</span> <span class="o">=</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">previous</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">previous</span> <span class="o">||</span> <span class="p">(</span><span class="n">count</span> <span class="o">&amp;&amp;</span>  <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">++</span><span class="n">count</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;audit(:%d): major=%d name_count=%d:&quot;</span>
			       <span class="s">&quot; freeing multiple contexts (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">context</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span>
			       <span class="n">context</span><span class="o">-&gt;</span><span class="n">name_count</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">audit_free_names</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
		<span class="n">unroll_tree_refs</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">free_tree_refs</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
		<span class="n">audit_free_aux</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">filterkey</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">sockaddr</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
		<span class="n">context</span>  <span class="o">=</span> <span class="n">previous</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">context</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;audit: freed %d contexts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">audit_log_task_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_buffer</span> <span class="o">*</span><span class="n">ab</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sid</span><span class="p">;</span>

	<span class="n">security_task_getsecid</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sid</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">security_secid_to_secctx</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_path</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot; subj=%s&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
	<span class="n">security_release_secctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">error_path:</span>
	<span class="n">audit_panic</span><span class="p">(</span><span class="s">&quot;error in audit_log_task_context&quot;</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">audit_log_task_context</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">audit_log_task_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_buffer</span> <span class="o">*</span><span class="n">ab</span><span class="p">,</span> <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">tsk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">)];</span>
	<span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span> <span class="o">=</span> <span class="n">tsk</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">;</span>

	<span class="cm">/* tsk == current */</span>

	<span class="n">get_task_comm</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">tsk</span><span class="p">);</span>
	<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot; comm=&quot;</span><span class="p">);</span>
	<span class="n">audit_log_untrustedstring</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>
		<span class="n">vma</span> <span class="o">=</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">vma</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">&amp;</span> <span class="n">VM_EXECUTABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_file</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">audit_log_d_path</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot; exe=&quot;</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">vma</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">audit_log_task_context</span><span class="p">(</span><span class="n">ab</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">audit_log_pid_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="n">pid_t</span> <span class="n">pid</span><span class="p">,</span>
				 <span class="n">uid_t</span> <span class="n">auid</span><span class="p">,</span> <span class="n">uid_t</span> <span class="n">uid</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sessionid</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="n">sid</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">comm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_buffer</span> <span class="o">*</span><span class="n">ab</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ab</span> <span class="o">=</span> <span class="n">audit_log_start</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">AUDIT_OBJ_PID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ab</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot;opid=%d oauid=%d ouid=%d oses=%d&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">auid</span><span class="p">,</span>
			 <span class="n">uid</span><span class="p">,</span> <span class="n">sessionid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">security_secid_to_secctx</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot; obj=(none)&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot; obj=%s&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
		<span class="n">security_release_secctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot; ocomm=&quot;</span><span class="p">);</span>
	<span class="n">audit_log_untrustedstring</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">comm</span><span class="p">);</span>
	<span class="n">audit_log_end</span><span class="p">(</span><span class="n">ab</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * to_send and len_sent accounting are very loose estimates.  We aren&#39;t</span>
<span class="cm"> * really worried about a hard cap to MAX_EXECVE_AUDIT_LEN so much as being</span>
<span class="cm"> * within about 500 bytes (next page boundary)</span>
<span class="cm"> *</span>
<span class="cm"> * why snprintf?  an int is up to 12 digits long.  if we just assumed when</span>
<span class="cm"> * logging that a[%d]= was going to be 16 characters long we would be wasting</span>
<span class="cm"> * space in every audit message.  In one 7500 byte message we can log up to</span>
<span class="cm"> * about 1000 min size arguments.  That comes down to about 50% waste of space</span>
<span class="cm"> * if we didn&#39;t do the snprintf to find out how long arg_num_len was.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">audit_log_single_execve_arg</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">audit_buffer</span> <span class="o">**</span><span class="n">ab</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">arg_num</span><span class="p">,</span>
					<span class="kt">size_t</span> <span class="o">*</span><span class="n">len_sent</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">arg_num_len_buf</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">tmp_p</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="cm">/* how many digits are in arg_num? 5 is the length of &#39; a=&quot;&quot;&#39; */</span>
	<span class="kt">size_t</span> <span class="n">arg_num_len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">arg_num_len_buf</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">arg_num</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">len_left</span><span class="p">,</span> <span class="n">to_send</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">max_execve_audit_len</span> <span class="o">=</span> <span class="n">MAX_EXECVE_AUDIT_LEN</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">has_cntl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">too_long</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* strnlen_user includes the null we don&#39;t want to send */</span>
	<span class="n">len_left</span> <span class="o">=</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strnlen_user</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">MAX_ARG_STRLEN</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We just created this mm, if we can&#39;t find the strings</span>
<span class="cm">	 * we just copied into it something is _very_ wrong. Similar</span>
<span class="cm">	 * for strings that are too long, we should not have created</span>
<span class="cm">	 * any.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">len</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">MAX_ARG_STRLEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">send_sig</span><span class="p">(</span><span class="n">SIGKILL</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* walk the whole argument looking for non-ascii chars */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len_left</span> <span class="o">&gt;</span> <span class="n">MAX_EXECVE_AUDIT_LEN</span><span class="p">)</span>
			<span class="n">to_send</span> <span class="o">=</span> <span class="n">MAX_EXECVE_AUDIT_LEN</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">to_send</span> <span class="o">=</span> <span class="n">len_left</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">tmp_p</span><span class="p">,</span> <span class="n">to_send</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * There is no reason for this copy to be short. We just</span>
<span class="cm">		 * copied them here, and the mm hasn&#39;t been exposed to user-</span>
<span class="cm">		 * space yet.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">send_sig</span><span class="p">(</span><span class="n">SIGKILL</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">to_send</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">has_cntl</span> <span class="o">=</span> <span class="n">audit_string_contains_control</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">to_send</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">has_cntl</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * hex messages get logged as 2 bytes, so we can only</span>
<span class="cm">			 * send half as much in each message</span>
<span class="cm">			 */</span>
			<span class="n">max_execve_audit_len</span> <span class="o">=</span> <span class="n">MAX_EXECVE_AUDIT_LEN</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">len_left</span> <span class="o">-=</span> <span class="n">to_send</span><span class="p">;</span>
		<span class="n">tmp_p</span> <span class="o">+=</span> <span class="n">to_send</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">len_left</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">len_left</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">max_execve_audit_len</span><span class="p">)</span>
		<span class="n">too_long</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* rewalk the argument actually logging the message */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">len_left</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">room_left</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len_left</span> <span class="o">&gt;</span> <span class="n">max_execve_audit_len</span><span class="p">)</span>
			<span class="n">to_send</span> <span class="o">=</span> <span class="n">max_execve_audit_len</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">to_send</span> <span class="o">=</span> <span class="n">len_left</span><span class="p">;</span>

		<span class="cm">/* do we have space left to send this argument in this ab? */</span>
		<span class="n">room_left</span> <span class="o">=</span> <span class="n">MAX_EXECVE_AUDIT_LEN</span> <span class="o">-</span> <span class="n">arg_num_len</span> <span class="o">-</span> <span class="o">*</span><span class="n">len_sent</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">has_cntl</span><span class="p">)</span>
			<span class="n">room_left</span> <span class="o">-=</span> <span class="p">(</span><span class="n">to_send</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">room_left</span> <span class="o">-=</span> <span class="n">to_send</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">room_left</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">len_sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">audit_log_end</span><span class="p">(</span><span class="o">*</span><span class="n">ab</span><span class="p">);</span>
			<span class="o">*</span><span class="n">ab</span> <span class="o">=</span> <span class="n">audit_log_start</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">AUDIT_EXECVE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">ab</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * first record needs to say how long the original string was</span>
<span class="cm">		 * so we can be sure nothing was lost.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">too_long</span><span class="p">))</span>
			<span class="n">audit_log_format</span><span class="p">(</span><span class="o">*</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot; a%d_len=%zu&quot;</span><span class="p">,</span> <span class="n">arg_num</span><span class="p">,</span>
					 <span class="n">has_cntl</span> <span class="o">?</span> <span class="mi">2</span><span class="o">*</span><span class="n">len</span> <span class="o">:</span> <span class="n">len</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * normally arguments are small enough to fit and we already</span>
<span class="cm">		 * filled buf above when we checked for control characters</span>
<span class="cm">		 * so don&#39;t bother with another copy_from_user</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">max_execve_audit_len</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">to_send</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">send_sig</span><span class="p">(</span><span class="n">SIGKILL</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">to_send</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

		<span class="cm">/* actually log it */</span>
		<span class="n">audit_log_format</span><span class="p">(</span><span class="o">*</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot; a%d&quot;</span><span class="p">,</span> <span class="n">arg_num</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">too_long</span><span class="p">)</span>
			<span class="n">audit_log_format</span><span class="p">(</span><span class="o">*</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot;[%d]&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">audit_log_format</span><span class="p">(</span><span class="o">*</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot;=&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">has_cntl</span><span class="p">)</span>
			<span class="n">audit_log_n_hex</span><span class="p">(</span><span class="o">*</span><span class="n">ab</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">to_send</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">audit_log_string</span><span class="p">(</span><span class="o">*</span><span class="n">ab</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

		<span class="n">p</span> <span class="o">+=</span> <span class="n">to_send</span><span class="p">;</span>
		<span class="n">len_left</span> <span class="o">-=</span> <span class="n">to_send</span><span class="p">;</span>
		<span class="o">*</span><span class="n">len_sent</span> <span class="o">+=</span> <span class="n">arg_num_len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">has_cntl</span><span class="p">)</span>
			<span class="o">*</span><span class="n">len_sent</span> <span class="o">+=</span> <span class="n">to_send</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">len_sent</span> <span class="o">+=</span> <span class="n">to_send</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* include the null we didn&#39;t log */</span>
	<span class="k">return</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">audit_log_execve_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">audit_buffer</span> <span class="o">**</span><span class="n">ab</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">audit_aux_data_execve</span> <span class="o">*</span><span class="n">axi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len_sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">axi</span><span class="o">-&gt;</span><span class="n">mm</span> <span class="o">!=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* execve failed, no additional info */</span>

	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">axi</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">arg_start</span><span class="p">;</span>

	<span class="n">audit_log_format</span><span class="p">(</span><span class="o">*</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot;argc=%d&quot;</span><span class="p">,</span> <span class="n">axi</span><span class="o">-&gt;</span><span class="n">argc</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * we need some kernel buffer to hold the userspace args.  Just</span>
<span class="cm">	 * allocate one big one rather than allocating one of the right size</span>
<span class="cm">	 * for every single argument inside audit_log_single_execve_arg()</span>
<span class="cm">	 * should be &lt;8k allocation so should be pretty safe.</span>
<span class="cm">	 */</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">MAX_EXECVE_AUDIT_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">audit_panic</span><span class="p">(</span><span class="s">&quot;out of memory for argv string</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">axi</span><span class="o">-&gt;</span><span class="n">argc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">audit_log_single_execve_arg</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ab</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">len_sent</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">audit_log_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_buffer</span> <span class="o">*</span><span class="n">ab</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span><span class="p">,</span> <span class="n">kernel_cap_t</span> <span class="o">*</span><span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot; %s=&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">);</span>
	<span class="n">CAP_FOR_EACH_U32</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot;%08x&quot;</span><span class="p">,</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">[(</span><span class="n">_KERNEL_CAPABILITY_U32S</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">audit_log_fcaps</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_buffer</span> <span class="o">*</span><span class="n">ab</span><span class="p">,</span> <span class="k">struct</span> <span class="n">audit_names</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kernel_cap_t</span> <span class="o">*</span><span class="n">perm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">fcap</span><span class="p">.</span><span class="n">permitted</span><span class="p">;</span>
	<span class="n">kernel_cap_t</span> <span class="o">*</span><span class="n">inh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">fcap</span><span class="p">.</span><span class="n">inheritable</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">log</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cap_isclear</span><span class="p">(</span><span class="o">*</span><span class="n">perm</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">audit_log_cap</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot;cap_fp&quot;</span><span class="p">,</span> <span class="n">perm</span><span class="p">);</span>
		<span class="n">log</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cap_isclear</span><span class="p">(</span><span class="o">*</span><span class="n">inh</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">audit_log_cap</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot;cap_fi&quot;</span><span class="p">,</span> <span class="n">inh</span><span class="p">);</span>
		<span class="n">log</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">)</span>
		<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot; cap_fe=%d cap_fver=%x&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">-&gt;</span><span class="n">fcap</span><span class="p">.</span><span class="n">fE</span><span class="p">,</span> <span class="n">name</span><span class="o">-&gt;</span><span class="n">fcap_ver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">show_special</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">call_panic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_buffer</span> <span class="o">*</span><span class="n">ab</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ab</span> <span class="o">=</span> <span class="n">audit_log_start</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ab</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AUDIT_SOCKETCALL</span>: <span class="p">{</span>
		<span class="kt">int</span> <span class="n">nargs</span> <span class="o">=</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">socketcall</span><span class="p">.</span><span class="n">nargs</span><span class="p">;</span>
		<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot;nargs=%d&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nargs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot; a%d=%lx&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="n">context</span><span class="o">-&gt;</span><span class="n">socketcall</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span> <span class="p">}</span>
	<span class="k">case</span> <span class="n">AUDIT_IPC</span>: <span class="p">{</span>
		<span class="n">u32</span> <span class="n">osid</span> <span class="o">=</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">ipc</span><span class="p">.</span><span class="n">osid</span><span class="p">;</span>

		<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot;ouid=%u ogid=%u mode=%#ho&quot;</span><span class="p">,</span>
			 <span class="n">context</span><span class="o">-&gt;</span><span class="n">ipc</span><span class="p">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">ipc</span><span class="p">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">ipc</span><span class="p">.</span><span class="n">mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">osid</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">security_secid_to_secctx</span><span class="p">(</span><span class="n">osid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot; osid=%u&quot;</span><span class="p">,</span> <span class="n">osid</span><span class="p">);</span>
				<span class="o">*</span><span class="n">call_panic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot; obj=%s&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
				<span class="n">security_release_secctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">ipc</span><span class="p">.</span><span class="n">has_perm</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">audit_log_end</span><span class="p">(</span><span class="n">ab</span><span class="p">);</span>
			<span class="n">ab</span> <span class="o">=</span> <span class="n">audit_log_start</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span>
					     <span class="n">AUDIT_IPC_SET_PERM</span><span class="p">);</span>
			<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span>
				<span class="s">&quot;qbytes=%lx ouid=%u ogid=%u mode=%#ho&quot;</span><span class="p">,</span>
				<span class="n">context</span><span class="o">-&gt;</span><span class="n">ipc</span><span class="p">.</span><span class="n">qbytes</span><span class="p">,</span>
				<span class="n">context</span><span class="o">-&gt;</span><span class="n">ipc</span><span class="p">.</span><span class="n">perm_uid</span><span class="p">,</span>
				<span class="n">context</span><span class="o">-&gt;</span><span class="n">ipc</span><span class="p">.</span><span class="n">perm_gid</span><span class="p">,</span>
				<span class="n">context</span><span class="o">-&gt;</span><span class="n">ipc</span><span class="p">.</span><span class="n">perm_mode</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ab</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span> <span class="p">}</span>
	<span class="k">case</span> <span class="n">AUDIT_MQ_OPEN</span>: <span class="p">{</span>
		<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span>
			<span class="s">&quot;oflag=0x%x mode=%#ho mq_flags=0x%lx mq_maxmsg=%ld &quot;</span>
			<span class="s">&quot;mq_msgsize=%ld mq_curmsgs=%ld&quot;</span><span class="p">,</span>
			<span class="n">context</span><span class="o">-&gt;</span><span class="n">mq_open</span><span class="p">.</span><span class="n">oflag</span><span class="p">,</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">mq_open</span><span class="p">.</span><span class="n">mode</span><span class="p">,</span>
			<span class="n">context</span><span class="o">-&gt;</span><span class="n">mq_open</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">mq_flags</span><span class="p">,</span>
			<span class="n">context</span><span class="o">-&gt;</span><span class="n">mq_open</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">mq_maxmsg</span><span class="p">,</span>
			<span class="n">context</span><span class="o">-&gt;</span><span class="n">mq_open</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">mq_msgsize</span><span class="p">,</span>
			<span class="n">context</span><span class="o">-&gt;</span><span class="n">mq_open</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">mq_curmsgs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span> <span class="p">}</span>
	<span class="k">case</span> <span class="n">AUDIT_MQ_SENDRECV</span>: <span class="p">{</span>
		<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span>
			<span class="s">&quot;mqdes=%d msg_len=%zd msg_prio=%u &quot;</span>
			<span class="s">&quot;abs_timeout_sec=%ld abs_timeout_nsec=%ld&quot;</span><span class="p">,</span>
			<span class="n">context</span><span class="o">-&gt;</span><span class="n">mq_sendrecv</span><span class="p">.</span><span class="n">mqdes</span><span class="p">,</span>
			<span class="n">context</span><span class="o">-&gt;</span><span class="n">mq_sendrecv</span><span class="p">.</span><span class="n">msg_len</span><span class="p">,</span>
			<span class="n">context</span><span class="o">-&gt;</span><span class="n">mq_sendrecv</span><span class="p">.</span><span class="n">msg_prio</span><span class="p">,</span>
			<span class="n">context</span><span class="o">-&gt;</span><span class="n">mq_sendrecv</span><span class="p">.</span><span class="n">abs_timeout</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span>
			<span class="n">context</span><span class="o">-&gt;</span><span class="n">mq_sendrecv</span><span class="p">.</span><span class="n">abs_timeout</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span> <span class="p">}</span>
	<span class="k">case</span> <span class="n">AUDIT_MQ_NOTIFY</span>: <span class="p">{</span>
		<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot;mqdes=%d sigev_signo=%d&quot;</span><span class="p">,</span>
				<span class="n">context</span><span class="o">-&gt;</span><span class="n">mq_notify</span><span class="p">.</span><span class="n">mqdes</span><span class="p">,</span>
				<span class="n">context</span><span class="o">-&gt;</span><span class="n">mq_notify</span><span class="p">.</span><span class="n">sigev_signo</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span> <span class="p">}</span>
	<span class="k">case</span> <span class="n">AUDIT_MQ_GETSETATTR</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mq_attr</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">mq_getsetattr</span><span class="p">.</span><span class="n">mqstat</span><span class="p">;</span>
		<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span>
			<span class="s">&quot;mqdes=%d mq_flags=0x%lx mq_maxmsg=%ld mq_msgsize=%ld &quot;</span>
			<span class="s">&quot;mq_curmsgs=%ld &quot;</span><span class="p">,</span>
			<span class="n">context</span><span class="o">-&gt;</span><span class="n">mq_getsetattr</span><span class="p">.</span><span class="n">mqdes</span><span class="p">,</span>
			<span class="n">attr</span><span class="o">-&gt;</span><span class="n">mq_flags</span><span class="p">,</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">mq_maxmsg</span><span class="p">,</span>
			<span class="n">attr</span><span class="o">-&gt;</span><span class="n">mq_msgsize</span><span class="p">,</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">mq_curmsgs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span> <span class="p">}</span>
	<span class="k">case</span> <span class="n">AUDIT_CAPSET</span>: <span class="p">{</span>
		<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot;pid=%d&quot;</span><span class="p">,</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">capset</span><span class="p">.</span><span class="n">pid</span><span class="p">);</span>
		<span class="n">audit_log_cap</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot;cap_pi&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">capset</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">inheritable</span><span class="p">);</span>
		<span class="n">audit_log_cap</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot;cap_pp&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">capset</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">permitted</span><span class="p">);</span>
		<span class="n">audit_log_cap</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot;cap_pe&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">capset</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">effective</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span> <span class="p">}</span>
	<span class="k">case</span> <span class="n">AUDIT_MMAP</span>: <span class="p">{</span>
		<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot;fd=%d flags=0x%x&quot;</span><span class="p">,</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">fd</span><span class="p">,</span>
				 <span class="n">context</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span> <span class="p">}</span>
	<span class="p">}</span>
	<span class="n">audit_log_end</span><span class="p">(</span><span class="n">ab</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">audit_log_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="k">struct</span> <span class="n">audit_names</span> <span class="o">*</span><span class="n">n</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">record_num</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">call_panic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_buffer</span> <span class="o">*</span><span class="n">ab</span><span class="p">;</span>
	<span class="n">ab</span> <span class="o">=</span> <span class="n">audit_log_start</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">AUDIT_PATH</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ab</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* audit_panic has been called */</span>

	<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot;item=%d&quot;</span><span class="p">,</span> <span class="n">record_num</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">name_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">AUDIT_NAME_FULL</span>:
			<span class="cm">/* log the full path */</span>
			<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot; name=&quot;</span><span class="p">);</span>
			<span class="n">audit_log_untrustedstring</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="cm">/* name was specified as a relative path and the</span>
<span class="cm">			 * directory component is the cwd */</span>
			<span class="n">audit_log_d_path</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot; name=&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">pwd</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* log the name&#39;s directory component */</span>
			<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot; name=&quot;</span><span class="p">);</span>
			<span class="n">audit_log_n_untrustedstring</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
						    <span class="n">n</span><span class="o">-&gt;</span><span class="n">name_len</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot; name=(null)&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">ino</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot; inode=%lu&quot;</span>
				 <span class="s">&quot; dev=%02x:%02x mode=%#ho&quot;</span>
				 <span class="s">&quot; ouid=%u ogid=%u rdev=%02x:%02x&quot;</span><span class="p">,</span>
				 <span class="n">n</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">,</span>
				 <span class="n">MAJOR</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
				 <span class="n">MINOR</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
				 <span class="n">n</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">,</span>
				 <span class="n">n</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">,</span>
				 <span class="n">n</span><span class="o">-&gt;</span><span class="n">gid</span><span class="p">,</span>
				 <span class="n">MAJOR</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">),</span>
				 <span class="n">MINOR</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">osid</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">security_secid_to_secctx</span><span class="p">(</span>
			<span class="n">n</span><span class="o">-&gt;</span><span class="n">osid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot; osid=%u&quot;</span><span class="p">,</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">osid</span><span class="p">);</span>
			<span class="o">*</span><span class="n">call_panic</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot; obj=%s&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
			<span class="n">security_release_secctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">audit_log_fcaps</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>

	<span class="n">audit_log_end</span><span class="p">(</span><span class="n">ab</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">audit_log_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">tsk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">call_panic</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">audit_buffer</span> <span class="o">*</span><span class="n">ab</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">audit_aux_data</span> <span class="o">*</span><span class="n">aux</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">audit_names</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

	<span class="cm">/* tsk == current */</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="n">tsk</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">ppid</span><span class="p">)</span>
		<span class="n">context</span><span class="o">-&gt;</span><span class="n">ppid</span> <span class="o">=</span> <span class="n">sys_getppid</span><span class="p">();</span>
	<span class="n">cred</span> <span class="o">=</span> <span class="n">current_cred</span><span class="p">();</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">uid</span>   <span class="o">=</span> <span class="n">cred</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">gid</span>   <span class="o">=</span> <span class="n">cred</span><span class="o">-&gt;</span><span class="n">gid</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">euid</span>  <span class="o">=</span> <span class="n">cred</span><span class="o">-&gt;</span><span class="n">euid</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">suid</span>  <span class="o">=</span> <span class="n">cred</span><span class="o">-&gt;</span><span class="n">suid</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">fsuid</span> <span class="o">=</span> <span class="n">cred</span><span class="o">-&gt;</span><span class="n">fsuid</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">egid</span>  <span class="o">=</span> <span class="n">cred</span><span class="o">-&gt;</span><span class="n">egid</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">sgid</span>  <span class="o">=</span> <span class="n">cred</span><span class="o">-&gt;</span><span class="n">sgid</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">fsgid</span> <span class="o">=</span> <span class="n">cred</span><span class="o">-&gt;</span><span class="n">fsgid</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">personality</span> <span class="o">=</span> <span class="n">tsk</span><span class="o">-&gt;</span><span class="n">personality</span><span class="p">;</span>

	<span class="n">ab</span> <span class="o">=</span> <span class="n">audit_log_start</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">AUDIT_SYSCALL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ab</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* audit_panic has been called */</span>
	<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot;arch=%x syscall=%d&quot;</span><span class="p">,</span>
			 <span class="n">context</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">,</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">personality</span> <span class="o">!=</span> <span class="n">PER_LINUX</span><span class="p">)</span>
		<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot; per=%lx&quot;</span><span class="p">,</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">personality</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">return_valid</span><span class="p">)</span>
		<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot; success=%s exit=%ld&quot;</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">return_valid</span><span class="o">==</span><span class="n">AUDITSC_SUCCESS</span><span class="p">)</span><span class="o">?</span><span class="s">&quot;yes&quot;</span><span class="o">:</span><span class="s">&quot;no&quot;</span><span class="p">,</span>
				 <span class="n">context</span><span class="o">-&gt;</span><span class="n">return_code</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="n">sighand</span><span class="o">-&gt;</span><span class="n">siglock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">&amp;&amp;</span> <span class="n">tsk</span><span class="o">-&gt;</span><span class="n">signal</span><span class="o">-&gt;</span><span class="n">tty</span> <span class="o">&amp;&amp;</span> <span class="n">tsk</span><span class="o">-&gt;</span><span class="n">signal</span><span class="o">-&gt;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
		<span class="n">tty</span> <span class="o">=</span> <span class="n">tsk</span><span class="o">-&gt;</span><span class="n">signal</span><span class="o">-&gt;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tty</span> <span class="o">=</span> <span class="s">&quot;(none)&quot;</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="n">sighand</span><span class="o">-&gt;</span><span class="n">siglock</span><span class="p">);</span>

	<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span>
		  <span class="s">&quot; a0=%lx a1=%lx a2=%lx a3=%lx items=%d&quot;</span>
		  <span class="s">&quot; ppid=%d pid=%d auid=%u uid=%u gid=%u&quot;</span>
		  <span class="s">&quot; euid=%u suid=%u fsuid=%u&quot;</span>
		  <span class="s">&quot; egid=%u sgid=%u fsgid=%u tty=%s ses=%u&quot;</span><span class="p">,</span>
		  <span class="n">context</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		  <span class="n">context</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		  <span class="n">context</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
		  <span class="n">context</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
		  <span class="n">context</span><span class="o">-&gt;</span><span class="n">name_count</span><span class="p">,</span>
		  <span class="n">context</span><span class="o">-&gt;</span><span class="n">ppid</span><span class="p">,</span>
		  <span class="n">context</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
		  <span class="n">tsk</span><span class="o">-&gt;</span><span class="n">loginuid</span><span class="p">,</span>
		  <span class="n">context</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">,</span>
		  <span class="n">context</span><span class="o">-&gt;</span><span class="n">gid</span><span class="p">,</span>
		  <span class="n">context</span><span class="o">-&gt;</span><span class="n">euid</span><span class="p">,</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">suid</span><span class="p">,</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">fsuid</span><span class="p">,</span>
		  <span class="n">context</span><span class="o">-&gt;</span><span class="n">egid</span><span class="p">,</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">sgid</span><span class="p">,</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">fsgid</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span>
		  <span class="n">tsk</span><span class="o">-&gt;</span><span class="n">sessionid</span><span class="p">);</span>


	<span class="n">audit_log_task_info</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">tsk</span><span class="p">);</span>
	<span class="n">audit_log_key</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">filterkey</span><span class="p">);</span>
	<span class="n">audit_log_end</span><span class="p">(</span><span class="n">ab</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">aux</span> <span class="o">=</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">aux</span><span class="p">;</span> <span class="n">aux</span><span class="p">;</span> <span class="n">aux</span> <span class="o">=</span> <span class="n">aux</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">ab</span> <span class="o">=</span> <span class="n">audit_log_start</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">aux</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ab</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span> <span class="cm">/* audit_panic has been called */</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">aux</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">case</span> <span class="n">AUDIT_EXECVE</span>: <span class="p">{</span>
			<span class="k">struct</span> <span class="n">audit_aux_data_execve</span> <span class="o">*</span><span class="n">axi</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">aux</span><span class="p">;</span>
			<span class="n">audit_log_execve_info</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="n">axi</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span> <span class="p">}</span>

		<span class="k">case</span> <span class="n">AUDIT_BPRM_FCAPS</span>: <span class="p">{</span>
			<span class="k">struct</span> <span class="n">audit_aux_data_bprm_fcaps</span> <span class="o">*</span><span class="n">axs</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">aux</span><span class="p">;</span>
			<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot;fver=%x&quot;</span><span class="p">,</span> <span class="n">axs</span><span class="o">-&gt;</span><span class="n">fcap_ver</span><span class="p">);</span>
			<span class="n">audit_log_cap</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot;fp&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">axs</span><span class="o">-&gt;</span><span class="n">fcap</span><span class="p">.</span><span class="n">permitted</span><span class="p">);</span>
			<span class="n">audit_log_cap</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot;fi&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">axs</span><span class="o">-&gt;</span><span class="n">fcap</span><span class="p">.</span><span class="n">inheritable</span><span class="p">);</span>
			<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot; fe=%d&quot;</span><span class="p">,</span> <span class="n">axs</span><span class="o">-&gt;</span><span class="n">fcap</span><span class="p">.</span><span class="n">fE</span><span class="p">);</span>
			<span class="n">audit_log_cap</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot;old_pp&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">axs</span><span class="o">-&gt;</span><span class="n">old_pcap</span><span class="p">.</span><span class="n">permitted</span><span class="p">);</span>
			<span class="n">audit_log_cap</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot;old_pi&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">axs</span><span class="o">-&gt;</span><span class="n">old_pcap</span><span class="p">.</span><span class="n">inheritable</span><span class="p">);</span>
			<span class="n">audit_log_cap</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot;old_pe&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">axs</span><span class="o">-&gt;</span><span class="n">old_pcap</span><span class="p">.</span><span class="n">effective</span><span class="p">);</span>
			<span class="n">audit_log_cap</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot;new_pp&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">axs</span><span class="o">-&gt;</span><span class="n">new_pcap</span><span class="p">.</span><span class="n">permitted</span><span class="p">);</span>
			<span class="n">audit_log_cap</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot;new_pi&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">axs</span><span class="o">-&gt;</span><span class="n">new_pcap</span><span class="p">.</span><span class="n">inheritable</span><span class="p">);</span>
			<span class="n">audit_log_cap</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot;new_pe&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">axs</span><span class="o">-&gt;</span><span class="n">new_pcap</span><span class="p">.</span><span class="n">effective</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span> <span class="p">}</span>

		<span class="p">}</span>
		<span class="n">audit_log_end</span><span class="p">(</span><span class="n">ab</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
		<span class="n">show_special</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call_panic</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">fds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ab</span> <span class="o">=</span> <span class="n">audit_log_start</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">AUDIT_FD_PAIR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ab</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot;fd0=%d fd1=%d&quot;</span><span class="p">,</span>
					<span class="n">context</span><span class="o">-&gt;</span><span class="n">fds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">fds</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">audit_log_end</span><span class="p">(</span><span class="n">ab</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">sockaddr_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ab</span> <span class="o">=</span> <span class="n">audit_log_start</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">AUDIT_SOCKADDR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ab</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot;saddr=&quot;</span><span class="p">);</span>
			<span class="n">audit_log_n_hex</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">sockaddr</span><span class="p">,</span>
					<span class="n">context</span><span class="o">-&gt;</span><span class="n">sockaddr_len</span><span class="p">);</span>
			<span class="n">audit_log_end</span><span class="p">(</span><span class="n">ab</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">aux</span> <span class="o">=</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">aux_pids</span><span class="p">;</span> <span class="n">aux</span><span class="p">;</span> <span class="n">aux</span> <span class="o">=</span> <span class="n">aux</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">audit_aux_data_pids</span> <span class="o">*</span><span class="n">axs</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">aux</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">axs</span><span class="o">-&gt;</span><span class="n">pid_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">audit_log_pid_context</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">axs</span><span class="o">-&gt;</span><span class="n">target_pid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						  <span class="n">axs</span><span class="o">-&gt;</span><span class="n">target_auid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						  <span class="n">axs</span><span class="o">-&gt;</span><span class="n">target_uid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						  <span class="n">axs</span><span class="o">-&gt;</span><span class="n">target_sessionid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						  <span class="n">axs</span><span class="o">-&gt;</span><span class="n">target_sid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						  <span class="n">axs</span><span class="o">-&gt;</span><span class="n">target_comm</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
				<span class="n">call_panic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">target_pid</span> <span class="o">&amp;&amp;</span>
	    <span class="n">audit_log_pid_context</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">target_pid</span><span class="p">,</span>
				  <span class="n">context</span><span class="o">-&gt;</span><span class="n">target_auid</span><span class="p">,</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">target_uid</span><span class="p">,</span>
				  <span class="n">context</span><span class="o">-&gt;</span><span class="n">target_sessionid</span><span class="p">,</span>
				  <span class="n">context</span><span class="o">-&gt;</span><span class="n">target_sid</span><span class="p">,</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">target_comm</span><span class="p">))</span>
			<span class="n">call_panic</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">pwd</span><span class="p">.</span><span class="n">dentry</span> <span class="o">&amp;&amp;</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">pwd</span><span class="p">.</span><span class="n">mnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ab</span> <span class="o">=</span> <span class="n">audit_log_start</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">AUDIT_CWD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ab</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">audit_log_d_path</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot; cwd=&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">pwd</span><span class="p">);</span>
			<span class="n">audit_log_end</span><span class="p">(</span><span class="n">ab</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">names_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">audit_log_name</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">call_panic</span><span class="p">);</span>

	<span class="cm">/* Send end of event record to help user space know we are finished */</span>
	<span class="n">ab</span> <span class="o">=</span> <span class="n">audit_log_start</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">AUDIT_EOE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ab</span><span class="p">)</span>
		<span class="n">audit_log_end</span><span class="p">(</span><span class="n">ab</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">call_panic</span><span class="p">)</span>
		<span class="n">audit_panic</span><span class="p">(</span><span class="s">&quot;error converting sid to string&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * audit_free - free a per-task audit context</span>
<span class="cm"> * @tsk: task whose audit context block to free</span>
<span class="cm"> *</span>
<span class="cm"> * Called from copy_process and do_exit</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">__audit_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">tsk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span><span class="p">;</span>

	<span class="n">context</span> <span class="o">=</span> <span class="n">audit_get_context</span><span class="p">(</span><span class="n">tsk</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">context</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Check for system calls that do not go through the exit</span>
<span class="cm">	 * function (e.g., exit_group), then free context block.</span>
<span class="cm">	 * We use GFP_ATOMIC here because we might be doing this</span>
<span class="cm">	 * in the context of the idle thread */</span>
	<span class="cm">/* that can happen only if we are called from do_exit() */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">in_syscall</span> <span class="o">&amp;&amp;</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">current_state</span> <span class="o">==</span> <span class="n">AUDIT_RECORD_CONTEXT</span><span class="p">)</span>
		<span class="n">audit_log_exit</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">tsk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">killed_trees</span><span class="p">))</span>
		<span class="n">audit_kill_trees</span><span class="p">(</span><span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">killed_trees</span><span class="p">);</span>

	<span class="n">audit_free_context</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * audit_syscall_entry - fill in an audit record at syscall entry</span>
<span class="cm"> * @arch: architecture type</span>
<span class="cm"> * @major: major syscall type (function)</span>
<span class="cm"> * @a1: additional syscall register 1</span>
<span class="cm"> * @a2: additional syscall register 2</span>
<span class="cm"> * @a3: additional syscall register 3</span>
<span class="cm"> * @a4: additional syscall register 4</span>
<span class="cm"> *</span>
<span class="cm"> * Fill in audit context at syscall entry.  This only happens if the</span>
<span class="cm"> * audit context was created when the task was created and the state or</span>
<span class="cm"> * filters demand the audit context be built.  If the state from the</span>
<span class="cm"> * per-task filter or from the per-syscall filter is AUDIT_RECORD_CONTEXT,</span>
<span class="cm"> * then the record will be written at syscall exit time (otherwise, it</span>
<span class="cm"> * will only be written if another part of the kernel requests that it</span>
<span class="cm"> * be written).</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">__audit_syscall_entry</span><span class="p">(</span><span class="kt">int</span> <span class="n">arch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">major</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">a1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">a2</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">a3</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">a4</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">tsk</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span> <span class="o">=</span> <span class="n">tsk</span><span class="o">-&gt;</span><span class="n">audit_context</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">audit_state</span>     <span class="n">state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">context</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This happens only on certain architectures that make system</span>
<span class="cm">	 * calls in kernel_thread via the entry.S interface, instead of</span>
<span class="cm">	 * with direct calls.  (If you are porting to a new</span>
<span class="cm">	 * architecture, hitting this condition can indicate that you</span>
<span class="cm">	 * got the _exit/_leave calls backward in entry.S.)</span>
<span class="cm">	 *</span>
<span class="cm">	 * i386     no</span>
<span class="cm">	 * x86_64   no</span>
<span class="cm">	 * ppc64    yes (see arch/powerpc/platforms/iseries/misc.S)</span>
<span class="cm">	 *</span>
<span class="cm">	 * This also happens with vm86 emulation in a non-nested manner</span>
<span class="cm">	 * (entries without exits), so this case must be caught.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">in_syscall</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">newctx</span><span class="p">;</span>

<span class="cp">#if AUDIT_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;audit(:%d) pid=%d in syscall=%d;&quot;</span>
		       <span class="s">&quot; entering syscall=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">context</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span> <span class="n">tsk</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span> <span class="n">major</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">newctx</span> <span class="o">=</span> <span class="n">audit_alloc_context</span><span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">newctx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">newctx</span><span class="o">-&gt;</span><span class="n">previous</span>   <span class="o">=</span> <span class="n">context</span><span class="p">;</span>
			<span class="n">context</span>		   <span class="o">=</span> <span class="n">newctx</span><span class="p">;</span>
			<span class="n">tsk</span><span class="o">-&gt;</span><span class="n">audit_context</span> <span class="o">=</span> <span class="n">newctx</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>	<span class="p">{</span>
			<span class="cm">/* If we can&#39;t alloc a new context, the best we</span>
<span class="cm">			 * can do is to leak memory (any pending putname</span>
<span class="cm">			 * will be lost).  The only other alternative is</span>
<span class="cm">			 * to abandon auditing. */</span>
			<span class="n">audit_zero_context</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">in_syscall</span> <span class="o">||</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">name_count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">audit_enabled</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">context</span><span class="o">-&gt;</span><span class="n">arch</span>	    <span class="o">=</span> <span class="n">arch</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">major</span>      <span class="o">=</span> <span class="n">major</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>    <span class="o">=</span> <span class="n">a1</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>    <span class="o">=</span> <span class="n">a2</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>    <span class="o">=</span> <span class="n">a3</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>    <span class="o">=</span> <span class="n">a4</span><span class="p">;</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">dummy</span> <span class="o">=</span> <span class="o">!</span><span class="n">audit_n_rules</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">dummy</span> <span class="o">&amp;&amp;</span> <span class="n">state</span> <span class="o">==</span> <span class="n">AUDIT_BUILD_CONTEXT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">context</span><span class="o">-&gt;</span><span class="n">prio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">state</span> <span class="o">=</span> <span class="n">audit_filter_syscall</span><span class="p">(</span><span class="n">tsk</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">audit_filter_list</span><span class="p">[</span><span class="n">AUDIT_FILTER_ENTRY</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">AUDIT_DISABLED</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">context</span><span class="o">-&gt;</span><span class="n">serial</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">ctime</span>      <span class="o">=</span> <span class="n">CURRENT_TIME</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">in_syscall</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">current_state</span>  <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">ppid</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * audit_syscall_exit - deallocate audit context after a system call</span>
<span class="cm"> * @success: success value of the syscall</span>
<span class="cm"> * @return_code: return value of the syscall</span>
<span class="cm"> *</span>
<span class="cm"> * Tear down after system call.  If the audit context has been marked as</span>
<span class="cm"> * auditable (either because of the AUDIT_RECORD_CONTEXT state from</span>
<span class="cm"> * filtering, or because some other part of the kernel wrote an audit</span>
<span class="cm"> * message), then write out the syscall information.  In call cases,</span>
<span class="cm"> * free the names stored from getname().</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">__audit_syscall_exit</span><span class="p">(</span><span class="kt">int</span> <span class="n">success</span><span class="p">,</span> <span class="kt">long</span> <span class="n">return_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">tsk</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">success</span><span class="p">)</span>
		<span class="n">success</span> <span class="o">=</span> <span class="n">AUDITSC_SUCCESS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">success</span> <span class="o">=</span> <span class="n">AUDITSC_FAILURE</span><span class="p">;</span>

	<span class="n">context</span> <span class="o">=</span> <span class="n">audit_get_context</span><span class="p">(</span><span class="n">tsk</span><span class="p">,</span> <span class="n">success</span><span class="p">,</span> <span class="n">return_code</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">context</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">in_syscall</span> <span class="o">&amp;&amp;</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">current_state</span> <span class="o">==</span> <span class="n">AUDIT_RECORD_CONTEXT</span><span class="p">)</span>
		<span class="n">audit_log_exit</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">tsk</span><span class="p">);</span>

	<span class="n">context</span><span class="o">-&gt;</span><span class="n">in_syscall</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">prio</span> <span class="o">=</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">AUDIT_RECORD_CONTEXT</span> <span class="o">?</span> <span class="o">~</span><span class="mi">0ULL</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">killed_trees</span><span class="p">))</span>
		<span class="n">audit_kill_trees</span><span class="p">(</span><span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">killed_trees</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">previous</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">new_context</span> <span class="o">=</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">previous</span><span class="p">;</span>
		<span class="n">context</span><span class="o">-&gt;</span><span class="n">previous</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">audit_free_context</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
		<span class="n">tsk</span><span class="o">-&gt;</span><span class="n">audit_context</span> <span class="o">=</span> <span class="n">new_context</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">audit_free_names</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
		<span class="n">unroll_tree_refs</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">audit_free_aux</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
		<span class="n">context</span><span class="o">-&gt;</span><span class="n">aux</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">context</span><span class="o">-&gt;</span><span class="n">aux_pids</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">context</span><span class="o">-&gt;</span><span class="n">target_pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">context</span><span class="o">-&gt;</span><span class="n">target_sid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">context</span><span class="o">-&gt;</span><span class="n">sockaddr_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">context</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">context</span><span class="o">-&gt;</span><span class="n">fds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">AUDIT_RECORD_CONTEXT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">filterkey</span><span class="p">);</span>
			<span class="n">context</span><span class="o">-&gt;</span><span class="n">filterkey</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tsk</span><span class="o">-&gt;</span><span class="n">audit_context</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">handle_one</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_AUDIT_TREE</span>
	<span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">audit_tree_refs</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">audit_chunk</span> <span class="o">*</span><span class="n">chunk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">hlist_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_fsnotify_marks</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">context</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">audit_context</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">trees</span><span class="p">;</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">tree_count</span><span class="p">;</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">chunk</span> <span class="o">=</span> <span class="n">audit_tree_lookup</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chunk</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">put_tree_ref</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">chunk</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">grow_tree_refs</span><span class="p">(</span><span class="n">context</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;out of memory, audit has lost a tree reference</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">audit_set_auditable</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
		<span class="n">audit_put_chunk</span><span class="p">(</span><span class="n">chunk</span><span class="p">);</span>
		<span class="n">unroll_tree_refs</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">put_tree_ref</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">chunk</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_path</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_AUDIT_TREE</span>
	<span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">audit_tree_refs</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="o">*</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">audit_chunk</span> <span class="o">*</span><span class="n">drop</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">seq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">context</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">audit_context</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">trees</span><span class="p">;</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">tree_count</span><span class="p">;</span>
<span class="nl">retry:</span>
	<span class="n">drop</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">d</span> <span class="o">=</span> <span class="n">dentry</span><span class="p">;</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">seq</span> <span class="o">=</span> <span class="n">read_seqbegin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rename_lock</span><span class="p">);</span>
	<span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inode</span> <span class="o">&amp;&amp;</span> <span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">hlist_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_fsnotify_marks</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">audit_chunk</span> <span class="o">*</span><span class="n">chunk</span><span class="p">;</span>
			<span class="n">chunk</span> <span class="o">=</span> <span class="n">audit_tree_lookup</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">put_tree_ref</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">chunk</span><span class="p">)))</span> <span class="p">{</span>
					<span class="n">drop</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">d_parent</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">parent</span> <span class="o">==</span> <span class="n">d</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">d</span> <span class="o">=</span> <span class="n">parent</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">read_seqretry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rename_lock</span><span class="p">,</span> <span class="n">seq</span><span class="p">)</span> <span class="o">||</span> <span class="n">drop</span><span class="p">))</span> <span class="p">{</span>  <span class="cm">/* in this order */</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drop</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* just a race with rename */</span>
			<span class="n">unroll_tree_refs</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">audit_put_chunk</span><span class="p">(</span><span class="n">drop</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">grow_tree_refs</span><span class="p">(</span><span class="n">context</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* OK, got more space */</span>
			<span class="n">unroll_tree_refs</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* too bad */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			<span class="s">&quot;out of memory, audit has lost a tree reference</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">unroll_tree_refs</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">audit_set_auditable</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">audit_names</span> <span class="o">*</span><span class="nf">audit_alloc_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_names</span> <span class="o">*</span><span class="n">aname</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">name_count</span> <span class="o">&lt;</span> <span class="n">AUDIT_NAMES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">aname</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">preallocated_names</span><span class="p">[</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">name_count</span><span class="p">];</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">aname</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">aname</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">aname</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">aname</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aname</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">aname</span><span class="o">-&gt;</span><span class="n">should_free</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">aname</span><span class="o">-&gt;</span><span class="n">ino</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aname</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">names_list</span><span class="p">);</span>

	<span class="n">context</span><span class="o">-&gt;</span><span class="n">name_count</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#if AUDIT_DEBUG</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">ino_count</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">aname</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * audit_getname - add a name to the list</span>
<span class="cm"> * @name: name to add</span>
<span class="cm"> *</span>
<span class="cm"> * Add a name to the list of audit names for this context.</span>
<span class="cm"> * Called from fs/namei.c:getname().</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">__audit_getname</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">audit_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">audit_names</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">in_syscall</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if AUDIT_DEBUG == 2</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:%d(:%d): ignoring getname(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">dump_stack</span><span class="p">();</span>
<span class="cp">#endif</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">audit_alloc_name</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">n</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
	<span class="n">n</span><span class="o">-&gt;</span><span class="n">name_len</span> <span class="o">=</span> <span class="n">AUDIT_NAME_FULL</span><span class="p">;</span>
	<span class="n">n</span><span class="o">-&gt;</span><span class="n">name_put</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">pwd</span><span class="p">.</span><span class="n">dentry</span><span class="p">)</span>
		<span class="n">get_fs_pwd</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">pwd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* audit_putname - intercept a putname request</span>
<span class="cm"> * @name: name to intercept and delay for putname</span>
<span class="cm"> *</span>
<span class="cm"> * If we have stored the name from getname in the audit context,</span>
<span class="cm"> * then we delay the putname until syscall exit.</span>
<span class="cm"> * Called from include/linux/fs.h:putname().</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">audit_putname</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">audit_context</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">context</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">in_syscall</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if AUDIT_DEBUG == 2</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:%d(:%d): __putname(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">name_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">audit_names</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">names_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;name[%d] = %p = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				       <span class="n">n</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">?:</span> <span class="s">&quot;(null)&quot;</span><span class="p">);</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">__putname</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#if AUDIT_DEBUG</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="o">++</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">put_count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">put_count</span> <span class="o">&gt;</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">name_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:%d(:%d): major=%d&quot;</span>
			       <span class="s">&quot; in_syscall=%d putname(%p) name_count=%d&quot;</span>
			       <span class="s">&quot; put_count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
			       <span class="n">context</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span>
			       <span class="n">context</span><span class="o">-&gt;</span><span class="n">in_syscall</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">name_count</span><span class="p">,</span>
			       <span class="n">context</span><span class="o">-&gt;</span><span class="n">put_count</span><span class="p">);</span>
			<span class="n">dump_stack</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">audit_copy_fcaps</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_names</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpu_vfs_cap_data</span> <span class="n">caps</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dentry</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">get_vfs_caps_from_disk</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">caps</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">name</span><span class="o">-&gt;</span><span class="n">fcap</span><span class="p">.</span><span class="n">permitted</span> <span class="o">=</span> <span class="n">caps</span><span class="p">.</span><span class="n">permitted</span><span class="p">;</span>
	<span class="n">name</span><span class="o">-&gt;</span><span class="n">fcap</span><span class="p">.</span><span class="n">inheritable</span> <span class="o">=</span> <span class="n">caps</span><span class="p">.</span><span class="n">inheritable</span><span class="p">;</span>
	<span class="n">name</span><span class="o">-&gt;</span><span class="n">fcap</span><span class="p">.</span><span class="n">fE</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">caps</span><span class="p">.</span><span class="n">magic_etc</span> <span class="o">&amp;</span> <span class="n">VFS_CAP_FLAGS_EFFECTIVE</span><span class="p">);</span>
	<span class="n">name</span><span class="o">-&gt;</span><span class="n">fcap_ver</span> <span class="o">=</span> <span class="p">(</span><span class="n">caps</span><span class="p">.</span><span class="n">magic_etc</span> <span class="o">&amp;</span> <span class="n">VFS_CAP_REVISION_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">VFS_CAP_REVISION_SHIFT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Copy inode data into an audit_names. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">audit_copy_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_names</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">name</span><span class="o">-&gt;</span><span class="n">ino</span>   <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">;</span>
	<span class="n">name</span><span class="o">-&gt;</span><span class="n">dev</span>   <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_dev</span><span class="p">;</span>
	<span class="n">name</span><span class="o">-&gt;</span><span class="n">mode</span>  <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">;</span>
	<span class="n">name</span><span class="o">-&gt;</span><span class="n">uid</span>   <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_uid</span><span class="p">;</span>
	<span class="n">name</span><span class="o">-&gt;</span><span class="n">gid</span>   <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_gid</span><span class="p">;</span>
	<span class="n">name</span><span class="o">-&gt;</span><span class="n">rdev</span>  <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_rdev</span><span class="p">;</span>
	<span class="n">security_inode_getsecid</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">osid</span><span class="p">);</span>
	<span class="n">audit_copy_fcaps</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">dentry</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * audit_inode - store the inode and device from a lookup</span>
<span class="cm"> * @name: name being audited</span>
<span class="cm"> * @dentry: dentry being audited</span>
<span class="cm"> *</span>
<span class="cm"> * Called from fs/namei.c:path_lookup().</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">__audit_inode</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">audit_context</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">audit_names</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">in_syscall</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">list_for_each_entry_reverse</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">names_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* unable to find the name from a previous getname() */</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">audit_alloc_name</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">handle_path</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
	<span class="n">audit_copy_inode</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">inode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * audit_inode_child - collect inode info for created/removed objects</span>
<span class="cm"> * @dentry: dentry being audited</span>
<span class="cm"> * @parent: inode of dentry parent</span>
<span class="cm"> *</span>
<span class="cm"> * For syscalls that create or remove filesystem objects, audit_inode</span>
<span class="cm"> * can only collect information for the filesystem object&#39;s parent.</span>
<span class="cm"> * This call updates the audit context with the child&#39;s information.</span>
<span class="cm"> * Syscalls that create a new filesystem object must be hooked after</span>
<span class="cm"> * the object is created.  Syscalls that remove a filesystem object</span>
<span class="cm"> * must be hooked prior, in order to capture the target inode during</span>
<span class="cm"> * unsuccessful attempts.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">__audit_inode_child</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">parent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">audit_context</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">found_parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">found_child</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dname</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">audit_names</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dirlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">in_syscall</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inode</span><span class="p">)</span>
		<span class="n">handle_one</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="cm">/* parent is more likely, look for it first */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">names_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">ino</span> <span class="o">==</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">i_ino</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">audit_compare_dname_path</span><span class="p">(</span><span class="n">dname</span><span class="p">,</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dirlen</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">n</span><span class="o">-&gt;</span><span class="n">name_len</span> <span class="o">=</span> <span class="n">dirlen</span><span class="p">;</span> <span class="cm">/* update parent data in place */</span>
			<span class="n">found_parent</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">add_names</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* no matching parent, look for matching child */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">names_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* strcmp() is the more likely scenario */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">dname</span><span class="p">,</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">||</span>
		     <span class="o">!</span><span class="n">audit_compare_dname_path</span><span class="p">(</span><span class="n">dname</span><span class="p">,</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dirlen</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">inode</span><span class="p">)</span>
				<span class="n">audit_copy_inode</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">inode</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">n</span><span class="o">-&gt;</span><span class="n">ino</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">found_child</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">add_names</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">add_names:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found_parent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">audit_alloc_name</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">audit_copy_inode</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">parent</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found_child</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">audit_alloc_name</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="cm">/* Re-use the name belonging to the slot for a matching parent</span>
<span class="cm">		 * directory. All names for this context are relinquished in</span>
<span class="cm">		 * audit_free_names() */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">found_parent</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">n</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">found_parent</span><span class="p">;</span>
			<span class="n">n</span><span class="o">-&gt;</span><span class="n">name_len</span> <span class="o">=</span> <span class="n">AUDIT_NAME_FULL</span><span class="p">;</span>
			<span class="cm">/* don&#39;t call __putname() */</span>
			<span class="n">n</span><span class="o">-&gt;</span><span class="n">name_put</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">inode</span><span class="p">)</span>
			<span class="n">audit_copy_inode</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">inode</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">__audit_inode_child</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * auditsc_get_stamp - get local copies of audit_context values</span>
<span class="cm"> * @ctx: audit_context for the task</span>
<span class="cm"> * @t: timespec to store time recorded in the audit_context</span>
<span class="cm"> * @serial: serial value that is recorded in the audit_context</span>
<span class="cm"> *</span>
<span class="cm"> * Also sets the context as auditable.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">auditsc_get_stamp</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">timespec</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">serial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">in_syscall</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">)</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">serial</span> <span class="o">=</span> <span class="n">audit_serial</span><span class="p">();</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">tv_sec</span>  <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">tv_nsec</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctime</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">;</span>
	<span class="o">*</span><span class="n">serial</span>    <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">prio</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">current_state</span> <span class="o">=</span> <span class="n">AUDIT_RECORD_CONTEXT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* global counter which is incremented every time something logs in */</span>
<span class="k">static</span> <span class="n">atomic_t</span> <span class="n">session_id</span> <span class="o">=</span> <span class="n">ATOMIC_INIT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * audit_set_loginuid - set current task&#39;s audit_context loginuid</span>
<span class="cm"> * @loginuid: loginuid value</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0.</span>
<span class="cm"> *</span>
<span class="cm"> * Called (set) from fs/proc/base.c::proc_loginuid_write().</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">audit_set_loginuid</span><span class="p">(</span><span class="n">uid_t</span> <span class="n">loginuid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">audit_context</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sessionid</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_AUDIT_LOGINUID_IMMUTABLE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">loginuid</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
<span class="cp">#else </span><span class="cm">/* CONFIG_AUDIT_LOGINUID_IMMUTABLE */</span><span class="cp"></span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_AUDIT_CONTROL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
<span class="cp">#endif  </span><span class="cm">/* CONFIG_AUDIT_LOGINUID_IMMUTABLE */</span><span class="cp"></span>

	<span class="n">sessionid</span> <span class="o">=</span> <span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">context</span> <span class="o">&amp;&amp;</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">in_syscall</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">audit_buffer</span> <span class="o">*</span><span class="n">ab</span><span class="p">;</span>

		<span class="n">ab</span> <span class="o">=</span> <span class="n">audit_log_start</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">AUDIT_LOGIN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ab</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot;login pid=%d uid=%u &quot;</span>
				<span class="s">&quot;old auid=%u new auid=%u&quot;</span>
				<span class="s">&quot; old ses=%u new ses=%u&quot;</span><span class="p">,</span>
				<span class="n">task</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">task_uid</span><span class="p">(</span><span class="n">task</span><span class="p">),</span>
				<span class="n">task</span><span class="o">-&gt;</span><span class="n">loginuid</span><span class="p">,</span> <span class="n">loginuid</span><span class="p">,</span>
				<span class="n">task</span><span class="o">-&gt;</span><span class="n">sessionid</span><span class="p">,</span> <span class="n">sessionid</span><span class="p">);</span>
			<span class="n">audit_log_end</span><span class="p">(</span><span class="n">ab</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">sessionid</span> <span class="o">=</span> <span class="n">sessionid</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">loginuid</span> <span class="o">=</span> <span class="n">loginuid</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * __audit_mq_open - record audit data for a POSIX MQ open</span>
<span class="cm"> * @oflag: open flag</span>
<span class="cm"> * @mode: mode bits</span>
<span class="cm"> * @attr: queue attributes</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">__audit_mq_open</span><span class="p">(</span><span class="kt">int</span> <span class="n">oflag</span><span class="p">,</span> <span class="n">umode_t</span> <span class="n">mode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mq_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">audit_context</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attr</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">mq_open</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mq_attr</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">mq_open</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mq_attr</span><span class="p">));</span>

	<span class="n">context</span><span class="o">-&gt;</span><span class="n">mq_open</span><span class="p">.</span><span class="n">oflag</span> <span class="o">=</span> <span class="n">oflag</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">mq_open</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">context</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">AUDIT_MQ_OPEN</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * __audit_mq_sendrecv - record audit data for a POSIX MQ timed send/receive</span>
<span class="cm"> * @mqdes: MQ descriptor</span>
<span class="cm"> * @msg_len: Message length</span>
<span class="cm"> * @msg_prio: Message priority</span>
<span class="cm"> * @abs_timeout: Message timeout in absolute time</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">__audit_mq_sendrecv</span><span class="p">(</span><span class="n">mqd_t</span> <span class="n">mqdes</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">msg_len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">msg_prio</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">timespec</span> <span class="o">*</span><span class="n">abs_timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">audit_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">mq_sendrecv</span><span class="p">.</span><span class="n">abs_timeout</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">abs_timeout</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">abs_timeout</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">timespec</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">timespec</span><span class="p">));</span>

	<span class="n">context</span><span class="o">-&gt;</span><span class="n">mq_sendrecv</span><span class="p">.</span><span class="n">mqdes</span> <span class="o">=</span> <span class="n">mqdes</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">mq_sendrecv</span><span class="p">.</span><span class="n">msg_len</span> <span class="o">=</span> <span class="n">msg_len</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">mq_sendrecv</span><span class="p">.</span><span class="n">msg_prio</span> <span class="o">=</span> <span class="n">msg_prio</span><span class="p">;</span>

	<span class="n">context</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">AUDIT_MQ_SENDRECV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * __audit_mq_notify - record audit data for a POSIX MQ notify</span>
<span class="cm"> * @mqdes: MQ descriptor</span>
<span class="cm"> * @notification: Notification event</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">__audit_mq_notify</span><span class="p">(</span><span class="n">mqd_t</span> <span class="n">mqdes</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sigevent</span> <span class="o">*</span><span class="n">notification</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">audit_context</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">notification</span><span class="p">)</span>
		<span class="n">context</span><span class="o">-&gt;</span><span class="n">mq_notify</span><span class="p">.</span><span class="n">sigev_signo</span> <span class="o">=</span> <span class="n">notification</span><span class="o">-&gt;</span><span class="n">sigev_signo</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">context</span><span class="o">-&gt;</span><span class="n">mq_notify</span><span class="p">.</span><span class="n">sigev_signo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">context</span><span class="o">-&gt;</span><span class="n">mq_notify</span><span class="p">.</span><span class="n">mqdes</span> <span class="o">=</span> <span class="n">mqdes</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">AUDIT_MQ_NOTIFY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * __audit_mq_getsetattr - record audit data for a POSIX MQ get/set attribute</span>
<span class="cm"> * @mqdes: MQ descriptor</span>
<span class="cm"> * @mqstat: MQ flags</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">__audit_mq_getsetattr</span><span class="p">(</span><span class="n">mqd_t</span> <span class="n">mqdes</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mq_attr</span> <span class="o">*</span><span class="n">mqstat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">audit_context</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">mq_getsetattr</span><span class="p">.</span><span class="n">mqdes</span> <span class="o">=</span> <span class="n">mqdes</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">mq_getsetattr</span><span class="p">.</span><span class="n">mqstat</span> <span class="o">=</span> <span class="o">*</span><span class="n">mqstat</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">AUDIT_MQ_GETSETATTR</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * audit_ipc_obj - record audit data for ipc object</span>
<span class="cm"> * @ipcp: ipc permissions</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">__audit_ipc_obj</span><span class="p">(</span><span class="k">struct</span> <span class="n">kern_ipc_perm</span> <span class="o">*</span><span class="n">ipcp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">audit_context</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">ipc</span><span class="p">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">ipcp</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">ipc</span><span class="p">.</span><span class="n">gid</span> <span class="o">=</span> <span class="n">ipcp</span><span class="o">-&gt;</span><span class="n">gid</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">ipc</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">ipcp</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">ipc</span><span class="p">.</span><span class="n">has_perm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">security_ipc_getsecid</span><span class="p">(</span><span class="n">ipcp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">ipc</span><span class="p">.</span><span class="n">osid</span><span class="p">);</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">AUDIT_IPC</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * audit_ipc_set_perm - record audit data for new ipc permissions</span>
<span class="cm"> * @qbytes: msgq bytes</span>
<span class="cm"> * @uid: msgq user id</span>
<span class="cm"> * @gid: msgq group id</span>
<span class="cm"> * @mode: msgq mode (permissions)</span>
<span class="cm"> *</span>
<span class="cm"> * Called only after audit_ipc_obj().</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">__audit_ipc_set_perm</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">qbytes</span><span class="p">,</span> <span class="n">uid_t</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid_t</span> <span class="n">gid</span><span class="p">,</span> <span class="n">umode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">audit_context</span><span class="p">;</span>

	<span class="n">context</span><span class="o">-&gt;</span><span class="n">ipc</span><span class="p">.</span><span class="n">qbytes</span> <span class="o">=</span> <span class="n">qbytes</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">ipc</span><span class="p">.</span><span class="n">perm_uid</span> <span class="o">=</span> <span class="n">uid</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">ipc</span><span class="p">.</span><span class="n">perm_gid</span> <span class="o">=</span> <span class="n">gid</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">ipc</span><span class="p">.</span><span class="n">perm_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">ipc</span><span class="p">.</span><span class="n">has_perm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">__audit_bprm</span><span class="p">(</span><span class="k">struct</span> <span class="n">linux_binprm</span> <span class="o">*</span><span class="n">bprm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_aux_data_execve</span> <span class="o">*</span><span class="n">ax</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">audit_context</span><span class="p">;</span>

	<span class="n">ax</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ax</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ax</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">argc</span> <span class="o">=</span> <span class="n">bprm</span><span class="o">-&gt;</span><span class="n">argc</span><span class="p">;</span>
	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">envc</span> <span class="o">=</span> <span class="n">bprm</span><span class="o">-&gt;</span><span class="n">envc</span><span class="p">;</span>
	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">mm</span> <span class="o">=</span> <span class="n">bprm</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">;</span>
	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AUDIT_EXECVE</span><span class="p">;</span>
	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">aux</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">aux</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ax</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * audit_socketcall - record audit data for sys_socketcall</span>
<span class="cm"> * @nargs: number of args</span>
<span class="cm"> * @args: args array</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">__audit_socketcall</span><span class="p">(</span><span class="kt">int</span> <span class="n">nargs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">audit_context</span><span class="p">;</span>

	<span class="n">context</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">AUDIT_SOCKETCALL</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">socketcall</span><span class="p">.</span><span class="n">nargs</span> <span class="o">=</span> <span class="n">nargs</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">socketcall</span><span class="p">.</span><span class="n">args</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">nargs</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * __audit_fd_pair - record audit data for pipe and socketpair</span>
<span class="cm"> * @fd1: the first file descriptor</span>
<span class="cm"> * @fd2: the second file descriptor</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">__audit_fd_pair</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">audit_context</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">fds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fd1</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">fds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fd2</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * audit_sockaddr - record audit data for sys_bind, sys_connect, sys_sendto</span>
<span class="cm"> * @len: data length in user space</span>
<span class="cm"> * @a: data address in kernel space</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success or NULL context or &lt; 0 on error.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">__audit_sockaddr</span><span class="p">(</span><span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">audit_context</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">sockaddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_storage</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">context</span><span class="o">-&gt;</span><span class="n">sockaddr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">context</span><span class="o">-&gt;</span><span class="n">sockaddr_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">sockaddr</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">__audit_ptrace</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">audit_context</span><span class="p">;</span>

	<span class="n">context</span><span class="o">-&gt;</span><span class="n">target_pid</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">target_auid</span> <span class="o">=</span> <span class="n">audit_get_loginuid</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">target_uid</span> <span class="o">=</span> <span class="n">task_uid</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">target_sessionid</span> <span class="o">=</span> <span class="n">audit_get_sessionid</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
	<span class="n">security_task_getsecid</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">target_sid</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">target_comm</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">TASK_COMM_LEN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * audit_signal_info - record signal info for shutting down audit subsystem</span>
<span class="cm"> * @sig: signal value</span>
<span class="cm"> * @t: task being signaled</span>
<span class="cm"> *</span>
<span class="cm"> * If the audit subsystem is being terminated, record the task (pid)</span>
<span class="cm"> * and uid that is doing that.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">__audit_signal_info</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">,</span> <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_aux_data_pids</span> <span class="o">*</span><span class="n">axp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">tsk</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">tsk</span><span class="o">-&gt;</span><span class="n">audit_context</span><span class="p">;</span>
	<span class="n">uid_t</span> <span class="n">uid</span> <span class="o">=</span> <span class="n">current_uid</span><span class="p">(),</span> <span class="n">t_uid</span> <span class="o">=</span> <span class="n">task_uid</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">audit_pid</span> <span class="o">&amp;&amp;</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">tgid</span> <span class="o">==</span> <span class="n">audit_pid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sig</span> <span class="o">==</span> <span class="n">SIGTERM</span> <span class="o">||</span> <span class="n">sig</span> <span class="o">==</span> <span class="n">SIGHUP</span> <span class="o">||</span> <span class="n">sig</span> <span class="o">==</span> <span class="n">SIGUSR1</span> <span class="o">||</span> <span class="n">sig</span> <span class="o">==</span> <span class="n">SIGUSR2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">audit_sig_pid</span> <span class="o">=</span> <span class="n">tsk</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="n">loginuid</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">audit_sig_uid</span> <span class="o">=</span> <span class="n">tsk</span><span class="o">-&gt;</span><span class="n">loginuid</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">audit_sig_uid</span> <span class="o">=</span> <span class="n">uid</span><span class="p">;</span>
			<span class="n">security_task_getsecid</span><span class="p">(</span><span class="n">tsk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">audit_sig_sid</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">audit_signals</span> <span class="o">||</span> <span class="n">audit_dummy_context</span><span class="p">())</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* optimize the common case by putting first signal recipient directly</span>
<span class="cm">	 * in audit_context */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">target_pid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">target_pid</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">tgid</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">target_auid</span> <span class="o">=</span> <span class="n">audit_get_loginuid</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">target_uid</span> <span class="o">=</span> <span class="n">t_uid</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">target_sessionid</span> <span class="o">=</span> <span class="n">audit_get_sessionid</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
		<span class="n">security_task_getsecid</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">target_sid</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">target_comm</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">TASK_COMM_LEN</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">axp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">aux_pids</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">axp</span> <span class="o">||</span> <span class="n">axp</span><span class="o">-&gt;</span><span class="n">pid_count</span> <span class="o">==</span> <span class="n">AUDIT_AUX_PIDS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">axp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">axp</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">axp</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">axp</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AUDIT_OBJ_PID</span><span class="p">;</span>
		<span class="n">axp</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">aux_pids</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">aux_pids</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">axp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">axp</span><span class="o">-&gt;</span><span class="n">pid_count</span> <span class="o">&gt;=</span> <span class="n">AUDIT_AUX_PIDS</span><span class="p">);</span>

	<span class="n">axp</span><span class="o">-&gt;</span><span class="n">target_pid</span><span class="p">[</span><span class="n">axp</span><span class="o">-&gt;</span><span class="n">pid_count</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">tgid</span><span class="p">;</span>
	<span class="n">axp</span><span class="o">-&gt;</span><span class="n">target_auid</span><span class="p">[</span><span class="n">axp</span><span class="o">-&gt;</span><span class="n">pid_count</span><span class="p">]</span> <span class="o">=</span> <span class="n">audit_get_loginuid</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
	<span class="n">axp</span><span class="o">-&gt;</span><span class="n">target_uid</span><span class="p">[</span><span class="n">axp</span><span class="o">-&gt;</span><span class="n">pid_count</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_uid</span><span class="p">;</span>
	<span class="n">axp</span><span class="o">-&gt;</span><span class="n">target_sessionid</span><span class="p">[</span><span class="n">axp</span><span class="o">-&gt;</span><span class="n">pid_count</span><span class="p">]</span> <span class="o">=</span> <span class="n">audit_get_sessionid</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
	<span class="n">security_task_getsecid</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">axp</span><span class="o">-&gt;</span><span class="n">target_sid</span><span class="p">[</span><span class="n">axp</span><span class="o">-&gt;</span><span class="n">pid_count</span><span class="p">]);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">axp</span><span class="o">-&gt;</span><span class="n">target_comm</span><span class="p">[</span><span class="n">axp</span><span class="o">-&gt;</span><span class="n">pid_count</span><span class="p">],</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">TASK_COMM_LEN</span><span class="p">);</span>
	<span class="n">axp</span><span class="o">-&gt;</span><span class="n">pid_count</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * __audit_log_bprm_fcaps - store information about a loading bprm and relevant fcaps</span>
<span class="cm"> * @bprm: pointer to the bprm being processed</span>
<span class="cm"> * @new: the proposed new credentials</span>
<span class="cm"> * @old: the old credentials</span>
<span class="cm"> *</span>
<span class="cm"> * Simply check if the proc already has the caps given by the file and if not</span>
<span class="cm"> * store the priv escalation info for later auditing at the end of the syscall</span>
<span class="cm"> *</span>
<span class="cm"> * -Eric</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">__audit_log_bprm_fcaps</span><span class="p">(</span><span class="k">struct</span> <span class="n">linux_binprm</span> <span class="o">*</span><span class="n">bprm</span><span class="p">,</span>
			   <span class="k">const</span> <span class="k">struct</span> <span class="n">cred</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cred</span> <span class="o">*</span><span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_aux_data_bprm_fcaps</span> <span class="o">*</span><span class="n">ax</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">audit_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpu_vfs_cap_data</span> <span class="n">vcaps</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">;</span>

	<span class="n">ax</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ax</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ax</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AUDIT_BPRM_FCAPS</span><span class="p">;</span>
	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">aux</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">aux</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ax</span><span class="p">;</span>

	<span class="n">dentry</span> <span class="o">=</span> <span class="n">dget</span><span class="p">(</span><span class="n">bprm</span><span class="o">-&gt;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_dentry</span><span class="p">);</span>
	<span class="n">get_vfs_caps_from_disk</span><span class="p">(</span><span class="n">dentry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcaps</span><span class="p">);</span>
	<span class="n">dput</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>

	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">fcap</span><span class="p">.</span><span class="n">permitted</span> <span class="o">=</span> <span class="n">vcaps</span><span class="p">.</span><span class="n">permitted</span><span class="p">;</span>
	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">fcap</span><span class="p">.</span><span class="n">inheritable</span> <span class="o">=</span> <span class="n">vcaps</span><span class="p">.</span><span class="n">inheritable</span><span class="p">;</span>
	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">fcap</span><span class="p">.</span><span class="n">fE</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">vcaps</span><span class="p">.</span><span class="n">magic_etc</span> <span class="o">&amp;</span> <span class="n">VFS_CAP_FLAGS_EFFECTIVE</span><span class="p">);</span>
	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">fcap_ver</span> <span class="o">=</span> <span class="p">(</span><span class="n">vcaps</span><span class="p">.</span><span class="n">magic_etc</span> <span class="o">&amp;</span> <span class="n">VFS_CAP_REVISION_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">VFS_CAP_REVISION_SHIFT</span><span class="p">;</span>

	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">old_pcap</span><span class="p">.</span><span class="n">permitted</span>   <span class="o">=</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">cap_permitted</span><span class="p">;</span>
	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">old_pcap</span><span class="p">.</span><span class="n">inheritable</span> <span class="o">=</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">cap_inheritable</span><span class="p">;</span>
	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">old_pcap</span><span class="p">.</span><span class="n">effective</span>   <span class="o">=</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">cap_effective</span><span class="p">;</span>

	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">new_pcap</span><span class="p">.</span><span class="n">permitted</span>   <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">cap_permitted</span><span class="p">;</span>
	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">new_pcap</span><span class="p">.</span><span class="n">inheritable</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">cap_inheritable</span><span class="p">;</span>
	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">new_pcap</span><span class="p">.</span><span class="n">effective</span>   <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">cap_effective</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * __audit_log_capset - store information about the arguments to the capset syscall</span>
<span class="cm"> * @pid: target pid of the capset call</span>
<span class="cm"> * @new: the new credentials</span>
<span class="cm"> * @old: the old (current) credentials</span>
<span class="cm"> *</span>
<span class="cm"> * Record the aguments userspace sent to sys_capset for later printing by the</span>
<span class="cm"> * audit system if applicable</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">__audit_log_capset</span><span class="p">(</span><span class="n">pid_t</span> <span class="n">pid</span><span class="p">,</span>
		       <span class="k">const</span> <span class="k">struct</span> <span class="n">cred</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cred</span> <span class="o">*</span><span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">audit_context</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">capset</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">pid</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">capset</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">effective</span>   <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">cap_effective</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">capset</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">inheritable</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">cap_effective</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">capset</span><span class="p">.</span><span class="n">cap</span><span class="p">.</span><span class="n">permitted</span>   <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">cap_permitted</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">AUDIT_CAPSET</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">__audit_mmap_fd</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">context</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">audit_context</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">fd</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">AUDIT_MMAP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">audit_log_abend</span><span class="p">(</span><span class="k">struct</span> <span class="n">audit_buffer</span> <span class="o">*</span><span class="n">ab</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">reason</span><span class="p">,</span> <span class="kt">long</span> <span class="n">signr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uid_t</span> <span class="n">auid</span><span class="p">,</span> <span class="n">uid</span><span class="p">;</span>
	<span class="n">gid_t</span> <span class="n">gid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sessionid</span><span class="p">;</span>

	<span class="n">auid</span> <span class="o">=</span> <span class="n">audit_get_loginuid</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="n">sessionid</span> <span class="o">=</span> <span class="n">audit_get_sessionid</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="n">current_uid_gid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gid</span><span class="p">);</span>

	<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot;auid=%u uid=%u gid=%u ses=%u&quot;</span><span class="p">,</span>
			 <span class="n">auid</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">sessionid</span><span class="p">);</span>
	<span class="n">audit_log_task_context</span><span class="p">(</span><span class="n">ab</span><span class="p">);</span>
	<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot; pid=%d comm=&quot;</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">audit_log_untrustedstring</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">);</span>
	<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot; reason=&quot;</span><span class="p">);</span>
	<span class="n">audit_log_string</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
	<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot; sig=%ld&quot;</span><span class="p">,</span> <span class="n">signr</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm"> * audit_core_dumps - record information about processes that end abnormally</span>
<span class="cm"> * @signr: signal value</span>
<span class="cm"> *</span>
<span class="cm"> * If a process ends with a core dump, something fishy is going on and we</span>
<span class="cm"> * should record the event for investigation.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">audit_core_dumps</span><span class="p">(</span><span class="kt">long</span> <span class="n">signr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_buffer</span> <span class="o">*</span><span class="n">ab</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">audit_enabled</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">signr</span> <span class="o">==</span> <span class="n">SIGQUIT</span><span class="p">)</span>	<span class="cm">/* don&#39;t care for those */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ab</span> <span class="o">=</span> <span class="n">audit_log_start</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">AUDIT_ANOM_ABEND</span><span class="p">);</span>
	<span class="n">audit_log_abend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot;memory violation&quot;</span><span class="p">,</span> <span class="n">signr</span><span class="p">);</span>
	<span class="n">audit_log_end</span><span class="p">(</span><span class="n">ab</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">__audit_seccomp</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">syscall</span><span class="p">,</span> <span class="kt">long</span> <span class="n">signr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_buffer</span> <span class="o">*</span><span class="n">ab</span><span class="p">;</span>

	<span class="n">ab</span> <span class="o">=</span> <span class="n">audit_log_start</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">AUDIT_ANOM_ABEND</span><span class="p">);</span>
	<span class="n">audit_log_abend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot;seccomp&quot;</span><span class="p">,</span> <span class="n">signr</span><span class="p">);</span>
	<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot; syscall=%ld&quot;</span><span class="p">,</span> <span class="n">syscall</span><span class="p">);</span>
	<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot; compat=%d&quot;</span><span class="p">,</span> <span class="n">is_compat_task</span><span class="p">());</span>
	<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot; ip=0x%lx&quot;</span><span class="p">,</span> <span class="n">KSTK_EIP</span><span class="p">(</span><span class="n">current</span><span class="p">));</span>
	<span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&quot; code=0x%x&quot;</span><span class="p">,</span> <span class="n">code</span><span class="p">);</span>
	<span class="n">audit_log_end</span><span class="p">(</span><span class="n">ab</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="nf">audit_killed_trees</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audit_context</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">audit_context</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">ctx</span> <span class="o">||</span> <span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">in_syscall</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">killed_trees</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:1}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../javascript/docco.min.js"></script>
</html>
