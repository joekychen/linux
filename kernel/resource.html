<!DOCTYPE html>
<html><head><title>joekychen/linux » kernel › resource.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../index.html"></a><h1>resource.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *	linux/kernel/resource.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1999	Linus Torvalds</span>
<span class="cm"> * Copyright (C) 1999	Martin Mares &lt;mj@ucw.cz&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Arbitrary resource management.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/pfn.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>


<span class="k">struct</span> <span class="n">resource</span> <span class="n">ioport_resource</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;PCI IO&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">IO_SPACE_LIMIT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IO</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ioport_resource</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">resource</span> <span class="n">iomem_resource</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;PCI mem&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">iomem_resource</span><span class="p">);</span>

<span class="cm">/* constraints to be met while allocating resources */</span>
<span class="k">struct</span> <span class="n">resource_constraint</span> <span class="p">{</span>
	<span class="n">resource_size_t</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">align</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="p">(</span><span class="o">*</span><span class="n">alignf</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="p">,</span>
			<span class="n">resource_size_t</span><span class="p">,</span> <span class="n">resource_size_t</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">alignf_data</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">DEFINE_RWLOCK</span><span class="p">(</span><span class="n">resource_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">r_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sibling</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>

<span class="k">enum</span> <span class="p">{</span> <span class="n">MAX_IORES_LEVEL</span> <span class="o">=</span> <span class="mi">5</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">r_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
	<span class="n">__acquires</span><span class="p">(</span><span class="n">resource_lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">;</span> <span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">r_next</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">))</span>
		<span class="p">;</span>
	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
	<span class="n">__releases</span><span class="p">(</span><span class="n">resource_lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resource_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">root</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">v</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">&lt;</span> <span class="mh">0x10000</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">8</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">depth</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span> <span class="n">depth</span> <span class="o">&lt;</span> <span class="n">MAX_IORES_LEVEL</span><span class="p">;</span> <span class="n">depth</span><span class="o">++</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">==</span> <span class="n">root</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%*s%0*llx-%0*llx : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">depth</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">width</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
			<span class="n">width</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">,</span>
			<span class="n">r</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">?</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;&lt;BAD&gt;&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">resource_op</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">r_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>	<span class="o">=</span> <span class="n">r_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>	<span class="o">=</span> <span class="n">r_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>	<span class="o">=</span> <span class="n">r_show</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioports_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">seq_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resource_op</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioport_resource</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">iomem_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">seq_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resource_op</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iomem_resource</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">proc_ioports_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">ioports_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">seq_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">proc_iomem_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">iomem_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">seq_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ioresources_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;ioports&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc_ioports_operations</span><span class="p">);</span>
	<span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;iomem&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc_iomem_operations</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">__initcall</span><span class="p">(</span><span class="n">ioresources_init</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PROC_FS */</span><span class="cp"></span>

<span class="cm">/* Return the conflict entry if you can&#39;t request it */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span> <span class="nf">__request_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">resource_size_t</span> <span class="n">start</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">end</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">tmp</span><span class="p">,</span> <span class="o">**</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">&lt;</span> <span class="n">start</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">root</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">root</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">root</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp</span> <span class="o">||</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">new</span><span class="o">-&gt;</span><span class="n">sibling</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
			<span class="n">new</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">root</span><span class="p">;</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">&lt;</span> <span class="n">start</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__release_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">tmp</span><span class="p">,</span> <span class="o">**</span><span class="n">p</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="n">old</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">;</span>
			<span class="n">old</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__release_child_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">child</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">;</span>

		<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">sibling</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">__release_child_resources</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;release child resource %pR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="cm">/* need to restore size, and keep flags */</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
		<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">release_child_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="n">__release_child_resources</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resource_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * request_resource_conflict - request and reserve an I/O or memory resource</span>
<span class="cm"> * @root: root resource descriptor</span>
<span class="cm"> * @new: resource descriptor desired by caller</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success, conflict resource on error.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="nf">request_resource_conflict</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">conflict</span><span class="p">;</span>

	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="n">conflict</span> <span class="o">=</span> <span class="n">__request_resource</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">conflict</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * request_resource - request and reserve an I/O or memory resource</span>
<span class="cm"> * @root: root resource descriptor</span>
<span class="cm"> * @new: resource descriptor desired by caller</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success, negative error code on error.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">request_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">conflict</span><span class="p">;</span>

	<span class="n">conflict</span> <span class="o">=</span> <span class="n">request_resource_conflict</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">conflict</span> <span class="o">?</span> <span class="o">-</span><span class="n">EBUSY</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">request_resource</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * release_resource - release a previously reserved resource</span>
<span class="cm"> * @old: resource pointer</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">release_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">__release_resource</span><span class="p">(</span><span class="n">old</span><span class="p">);</span>
	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">release_resource</span><span class="p">);</span>

<span class="cp">#if !defined(CONFIG_ARCH_HAS_WALK_MEMORY)</span>
<span class="cm">/*</span>
<span class="cm"> * Finds the lowest memory reosurce exists within [res-&gt;start.res-&gt;end)</span>
<span class="cm"> * the caller must specify res-&gt;start, res-&gt;end, res-&gt;flags and &quot;name&quot;.</span>
<span class="cm"> * If found, returns 0, res is overwritten, if not found, returns -1.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">find_next_system_ram</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">resource_size_t</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">);</span>

	<span class="n">start</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="n">end</span><span class="p">);</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">iomem_resource</span><span class="p">.</span><span class="n">child</span><span class="p">;</span> <span class="n">p</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* system ram is just marked as IORESOURCE_MEM */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">!=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* copy data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function calls callback against all memory range of &quot;System RAM&quot;</span>
<span class="cm"> * which are marked as IORESOURCE_MEM and IORESOUCE_BUSY.</span>
<span class="cm"> * Now, this function is only for &quot;System RAM&quot;.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">walk_system_ram_range</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_pfn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr_pages</span><span class="p">,</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pfn</span><span class="p">,</span> <span class="n">end_pfn</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">orig_end</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">res</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">start_pfn</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">res</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">start_pfn</span> <span class="o">+</span> <span class="n">nr_pages</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">res</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_MEM</span> <span class="o">|</span> <span class="n">IORESOURCE_BUSY</span><span class="p">;</span>
	<span class="n">orig_end</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">end</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">res</span><span class="p">.</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">res</span><span class="p">.</span><span class="n">end</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">find_next_system_ram</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="p">,</span> <span class="s">&quot;System RAM&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pfn</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
		<span class="n">end_pfn</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">end_pfn</span> <span class="o">&gt;</span> <span class="n">pfn</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="n">pfn</span><span class="p">,</span> <span class="n">end_pfn</span> <span class="o">-</span> <span class="n">pfn</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">res</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">res</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">orig_end</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__is_ram</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pfn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr_pages</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * This generic page_is_ram() returns true if specified address is</span>
<span class="cm"> * registered as &quot;System RAM&quot; in iomem_resource list.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">__weak</span> <span class="nf">page_is_ram</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pfn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">walk_system_ram_range</span><span class="p">(</span><span class="n">pfn</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">__is_ram</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__weak</span> <span class="nf">arch_remove_reservations</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">avail</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">resource_size_t</span> <span class="nf">simple_align_resource</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
					     <span class="k">const</span> <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">avail</span><span class="p">,</span>
					     <span class="n">resource_size_t</span> <span class="n">size</span><span class="p">,</span>
					     <span class="n">resource_size_t</span> <span class="n">align</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">avail</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">resource_clip</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="n">resource_size_t</span> <span class="n">min</span><span class="p">,</span>
			  <span class="n">resource_size_t</span> <span class="n">max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">min</span><span class="p">)</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">min</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">resource_contains</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res1</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">res1</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&lt;=</span> <span class="n">res2</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&amp;&amp;</span> <span class="n">res1</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">&gt;=</span> <span class="n">res2</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Find empty slot in the resource tree with the given range and</span>
<span class="cm"> * alignment constraints</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__find_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">old</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span>
			 <span class="n">resource_size_t</span>  <span class="n">size</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">resource_constraint</span> <span class="o">*</span><span class="n">constraint</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span> <span class="n">avail</span><span class="p">,</span> <span class="n">alloc</span><span class="p">;</span>

	<span class="n">tmp</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Skip past an allocated resource that starts at 0, since the assignment</span>
<span class="cm">	 * of this-&gt;start - 1 to tmp-&gt;end below would cause an underflow.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this</span> <span class="o">&amp;&amp;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">==</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">this</span> <span class="o">==</span> <span class="n">old</span><span class="p">)</span> <span class="o">?</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">:</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">this</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="p">)</span>
			<span class="n">tmp</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">this</span> <span class="o">==</span> <span class="n">old</span><span class="p">)</span> <span class="o">?</span>  <span class="n">this</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">:</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tmp</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">end</span> <span class="o">&lt;</span> <span class="n">tmp</span><span class="p">.</span><span class="n">start</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">next</span><span class="p">;</span>

		<span class="n">resource_clip</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="n">constraint</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">,</span> <span class="n">constraint</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">);</span>
		<span class="n">arch_remove_reservations</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>

		<span class="cm">/* Check for overflow after ALIGN() */</span>
		<span class="n">avail</span> <span class="o">=</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>
		<span class="n">avail</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">constraint</span><span class="o">-&gt;</span><span class="n">align</span><span class="p">);</span>
		<span class="n">avail</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">.</span><span class="n">end</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">avail</span><span class="p">.</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="n">tmp</span><span class="p">.</span><span class="n">start</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">alloc</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">constraint</span><span class="o">-&gt;</span><span class="n">alignf</span><span class="p">(</span><span class="n">constraint</span><span class="o">-&gt;</span><span class="n">alignf_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">avail</span><span class="p">,</span>
					<span class="n">size</span><span class="p">,</span> <span class="n">constraint</span><span class="o">-&gt;</span><span class="n">align</span><span class="p">);</span>
			<span class="n">alloc</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">alloc</span><span class="p">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">resource_contains</span><span class="p">(</span><span class="o">&amp;</span><span class="n">avail</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">alloc</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">new</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">alloc</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
				<span class="n">new</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">alloc</span><span class="p">.</span><span class="n">end</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

<span class="nl">next:</span>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span> <span class="o">||</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">==</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">this</span> <span class="o">!=</span> <span class="n">old</span><span class="p">)</span>
			<span class="n">tmp</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">this</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Find empty slot in the resource tree given range and alignment.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">find_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span>
			<span class="n">resource_size_t</span> <span class="n">size</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">resource_constraint</span>  <span class="o">*</span><span class="n">constraint</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span>  <span class="n">__find_resource</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">constraint</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * reallocate_resource - allocate a slot in the resource tree given range &amp; alignment.</span>
<span class="cm"> *	The resource will be relocated if the new size cannot be reallocated in the</span>
<span class="cm"> *	current location.</span>
<span class="cm"> *</span>
<span class="cm"> * @root: root resource descriptor</span>
<span class="cm"> * @old:  resource descriptor desired by caller</span>
<span class="cm"> * @newsize: new size of the resource descriptor</span>
<span class="cm"> * @constraint: the size and alignment constraints to be met.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">reallocate_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">old</span><span class="p">,</span>
			<span class="n">resource_size_t</span> <span class="n">newsize</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">resource_constraint</span>  <span class="o">*</span><span class="n">constraint</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">new</span> <span class="o">=</span> <span class="o">*</span><span class="n">old</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">conflict</span><span class="p">;</span>

	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">__find_resource</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="p">,</span> <span class="n">newsize</span><span class="p">,</span> <span class="n">constraint</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">resource_contains</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="p">,</span> <span class="n">old</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">old</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">new</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
		<span class="n">old</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">new</span><span class="p">.</span><span class="n">end</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">resource_contains</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">old</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">new</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
		<span class="n">old</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">new</span><span class="p">.</span><span class="n">end</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">__release_resource</span><span class="p">(</span><span class="n">old</span><span class="p">);</span>
		<span class="o">*</span><span class="n">old</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
		<span class="n">conflict</span> <span class="o">=</span> <span class="n">__request_resource</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">old</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">conflict</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * allocate_resource - allocate empty slot in the resource tree given range &amp; alignment.</span>
<span class="cm"> * 	The resource will be reallocated with a new size if it was already allocated</span>
<span class="cm"> * @root: root resource descriptor</span>
<span class="cm"> * @new: resource descriptor desired by caller</span>
<span class="cm"> * @size: requested resource region size</span>
<span class="cm"> * @min: minimum boundary to allocate</span>
<span class="cm"> * @max: maximum boundary to allocate</span>
<span class="cm"> * @align: alignment requested, in bytes</span>
<span class="cm"> * @alignf: alignment function, optional, called if not NULL</span>
<span class="cm"> * @alignf_data: arbitrary data to pass to the @alignf function</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">allocate_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span>
		      <span class="n">resource_size_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">resource_size_t</span> <span class="n">min</span><span class="p">,</span>
		      <span class="n">resource_size_t</span> <span class="n">max</span><span class="p">,</span> <span class="n">resource_size_t</span> <span class="n">align</span><span class="p">,</span>
		      <span class="n">resource_size_t</span> <span class="p">(</span><span class="o">*</span><span class="n">alignf</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span>
						<span class="k">const</span> <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="p">,</span>
						<span class="n">resource_size_t</span><span class="p">,</span>
						<span class="n">resource_size_t</span><span class="p">),</span>
		      <span class="kt">void</span> <span class="o">*</span><span class="n">alignf_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_constraint</span> <span class="n">constraint</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">alignf</span><span class="p">)</span>
		<span class="n">alignf</span> <span class="o">=</span> <span class="n">simple_align_resource</span><span class="p">;</span>

	<span class="n">constraint</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">min</span><span class="p">;</span>
	<span class="n">constraint</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
	<span class="n">constraint</span><span class="p">.</span><span class="n">align</span> <span class="o">=</span> <span class="n">align</span><span class="p">;</span>
	<span class="n">constraint</span><span class="p">.</span><span class="n">alignf</span> <span class="o">=</span> <span class="n">alignf</span><span class="p">;</span>
	<span class="n">constraint</span><span class="p">.</span><span class="n">alignf_data</span> <span class="o">=</span> <span class="n">alignf_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* resource is already allocated, try reallocating with</span>
<span class="cm">		   the new constraints */</span>
		<span class="k">return</span> <span class="n">reallocate_resource</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">constraint</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">find_resource</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">constraint</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">__request_resource</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">new</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">allocate_resource</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * lookup_resource - find an existing resource by a resource start address</span>
<span class="cm"> * @root: root resource descriptor</span>
<span class="cm"> * @start: resource start address</span>
<span class="cm"> *</span>
<span class="cm"> * Returns a pointer to the resource if found, NULL otherwise</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="nf">lookup_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="n">resource_size_t</span> <span class="n">start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">res</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">;</span> <span class="n">res</span><span class="p">;</span> <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">==</span> <span class="n">start</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Insert a resource into the resource tree. If successful, return NULL,</span>
<span class="cm"> * otherwise return the conflicting resource (compare to __request_resource())</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span> <span class="nf">__insert_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">first</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">first</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">first</span> <span class="o">=</span> <span class="n">__request_resource</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">first</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">first</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">first</span> <span class="o">==</span> <span class="n">parent</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">first</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">first</span> <span class="o">==</span> <span class="n">new</span><span class="p">))</span>	<span class="cm">/* duplicated insertion */</span>
			<span class="k">return</span> <span class="n">first</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">&lt;</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">==</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">==</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">next</span> <span class="o">=</span> <span class="n">first</span><span class="p">;</span> <span class="p">;</span> <span class="n">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Partial overlap? Bad, and unfixable */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">||</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">new</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">sibling</span> <span class="o">=</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">child</span> <span class="o">=</span> <span class="n">first</span><span class="p">;</span>

	<span class="n">next</span><span class="o">-&gt;</span><span class="n">sibling</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">next</span> <span class="o">=</span> <span class="n">first</span><span class="p">;</span> <span class="n">next</span><span class="p">;</span> <span class="n">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">)</span>
		<span class="n">next</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">child</span> <span class="o">==</span> <span class="n">first</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span><span class="o">-&gt;</span><span class="n">child</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">sibling</span> <span class="o">!=</span> <span class="n">first</span><span class="p">)</span>
			<span class="n">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">;</span>
		<span class="n">next</span><span class="o">-&gt;</span><span class="n">sibling</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * insert_resource_conflict - Inserts resource in the resource tree</span>
<span class="cm"> * @parent: parent of the new resource</span>
<span class="cm"> * @new: new resource to insert</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, conflict resource if the resource can&#39;t be inserted.</span>
<span class="cm"> *</span>
<span class="cm"> * This function is equivalent to request_resource_conflict when no conflict</span>
<span class="cm"> * happens. If a conflict happens, and the conflicting resources</span>
<span class="cm"> * entirely fit within the range of the new resource, then the new</span>
<span class="cm"> * resource is inserted and the conflicting resources become children of</span>
<span class="cm"> * the new resource.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="nf">insert_resource_conflict</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">conflict</span><span class="p">;</span>

	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="n">conflict</span> <span class="o">=</span> <span class="n">__insert_resource</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">conflict</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * insert_resource - Inserts a resource in the resource tree</span>
<span class="cm"> * @parent: parent of the new resource</span>
<span class="cm"> * @new: new resource to insert</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, -EBUSY if the resource can&#39;t be inserted.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">insert_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">conflict</span><span class="p">;</span>

	<span class="n">conflict</span> <span class="o">=</span> <span class="n">insert_resource_conflict</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">conflict</span> <span class="o">?</span> <span class="o">-</span><span class="n">EBUSY</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * insert_resource_expand_to_fit - Insert a resource into the resource tree</span>
<span class="cm"> * @root: root resource descriptor</span>
<span class="cm"> * @new: new resource to insert</span>
<span class="cm"> *</span>
<span class="cm"> * Insert a resource into the resource tree, possibly expanding it in order</span>
<span class="cm"> * to make it encompass any conflicting resources.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">insert_resource_expand_to_fit</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">conflict</span><span class="p">;</span>

		<span class="n">conflict</span> <span class="o">=</span> <span class="n">__insert_resource</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conflict</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conflict</span> <span class="o">==</span> <span class="n">root</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Ok, expand resource to cover the conflict, then try again .. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conflict</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span>
			<span class="n">new</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">conflict</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conflict</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span>
			<span class="n">new</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">conflict</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Expanded resource %s due to conflict with %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">conflict</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resource_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * adjust_resource - modify a resource&#39;s start and size</span>
<span class="cm"> * @res: resource to modify</span>
<span class="cm"> * @start: new start value</span>
<span class="cm"> * @size: new size</span>
<span class="cm"> *</span>
<span class="cm"> * Given an existing resource, change its start and size to match the</span>
<span class="cm"> * arguments.  Returns 0 on success, -EBUSY if it can&#39;t fit.</span>
<span class="cm"> * Existing children of the resource are assumed to be immutable.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">adjust_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="n">resource_size_t</span> <span class="n">start</span><span class="p">,</span> <span class="n">resource_size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">;</span> <span class="n">tmp</span><span class="p">;</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">start</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">sibling</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">sibling</span> <span class="o">!=</span> <span class="n">res</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&lt;=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">end</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">adjust_resource</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">__reserve_region_with_split</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span>
		<span class="n">resource_size_t</span> <span class="n">start</span><span class="p">,</span> <span class="n">resource_size_t</span> <span class="n">end</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">root</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">conflict</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">res</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">end</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_BUSY</span><span class="p">;</span>

	<span class="n">conflict</span> <span class="o">=</span> <span class="n">__request_resource</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conflict</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* failed, split and try again */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>

	<span class="cm">/* conflict covered whole area */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conflict</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&lt;=</span> <span class="n">start</span> <span class="o">&amp;&amp;</span> <span class="n">conflict</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">&gt;=</span> <span class="n">end</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conflict</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">start</span><span class="p">)</span>
		<span class="n">__reserve_region_with_split</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">conflict</span><span class="o">-&gt;</span><span class="n">start</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conflict</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
		<span class="n">__reserve_region_with_split</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">conflict</span><span class="o">-&gt;</span><span class="n">end</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">reserve_region_with_split</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span>
		<span class="n">resource_size_t</span> <span class="n">start</span><span class="p">,</span> <span class="n">resource_size_t</span> <span class="n">end</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="n">__reserve_region_with_split</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resource_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * resource_alignment - calculate resource&#39;s alignment</span>
<span class="cm"> * @res: resource pointer</span>
<span class="cm"> *</span>
<span class="cm"> * Returns alignment on success, 0 (invalid alignment) on failure.</span>
<span class="cm"> */</span>
<span class="n">resource_size_t</span> <span class="nf">resource_alignment</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IORESOURCE_SIZEALIGN</span> <span class="o">|</span> <span class="n">IORESOURCE_STARTALIGN</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IORESOURCE_SIZEALIGN</span>:
		<span class="k">return</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">IORESOURCE_STARTALIGN</span>:
		<span class="k">return</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is compatibility stuff for IO resources.</span>
<span class="cm"> *</span>
<span class="cm"> * Note how this, unlike the above, knows about</span>
<span class="cm"> * the IO flag meanings (busy etc).</span>
<span class="cm"> *</span>
<span class="cm"> * request_region creates a new busy region.</span>
<span class="cm"> *</span>
<span class="cm"> * check_region returns non-zero if the area is already busy.</span>
<span class="cm"> *</span>
<span class="cm"> * release_region releases a matching busy region.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">DECLARE_WAIT_QUEUE_HEAD</span><span class="p">(</span><span class="n">muxed_resource_wait</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * __request_region - create a new busy resource region</span>
<span class="cm"> * @parent: parent resource descriptor</span>
<span class="cm"> * @start: resource start address</span>
<span class="cm"> * @n: resource region size</span>
<span class="cm"> * @name: reserving caller&#39;s ID string</span>
<span class="cm"> * @flags: IO resource flags</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span> <span class="nf">__request_region</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span>
				   <span class="n">resource_size_t</span> <span class="n">start</span><span class="p">,</span> <span class="n">resource_size_t</span> <span class="n">n</span><span class="p">,</span>
				   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">res</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_BUSY</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">conflict</span><span class="p">;</span>

		<span class="n">conflict</span> <span class="o">=</span> <span class="n">__request_resource</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conflict</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conflict</span> <span class="o">!=</span> <span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">parent</span> <span class="o">=</span> <span class="n">conflict</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">conflict</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_BUSY</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conflict</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MUXED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">muxed_resource_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
			<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resource_lock</span><span class="p">);</span>
			<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
			<span class="n">schedule</span><span class="p">();</span>
			<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">muxed_resource_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
			<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resource_lock</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Uhhuh, that didn&#39;t work out.. */</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__request_region</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * __check_region - check if a resource region is busy or free</span>
<span class="cm"> * @parent: parent resource descriptor</span>
<span class="cm"> * @start: resource start address</span>
<span class="cm"> * @n: resource region size</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 if the region is free at the moment it is checked,</span>
<span class="cm"> * returns %-EBUSY if the region is busy.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE:</span>
<span class="cm"> * This function is deprecated because its use is racy.</span>
<span class="cm"> * Even if it returns 0, a subsequent call to request_region()</span>
<span class="cm"> * may fail because another driver etc. just allocated the region.</span>
<span class="cm"> * Do NOT use it.  It will be removed from the kernel.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">__check_region</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="n">resource_size_t</span> <span class="n">start</span><span class="p">,</span>
			<span class="n">resource_size_t</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">__request_region</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="s">&quot;check-region&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">release_resource</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__check_region</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * __release_region - release a previously reserved resource region</span>
<span class="cm"> * @parent: parent resource descriptor</span>
<span class="cm"> * @start: resource start address</span>
<span class="cm"> * @n: resource region size</span>
<span class="cm"> *</span>
<span class="cm"> * The described resource region must match a currently busy region.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">__release_region</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="n">resource_size_t</span> <span class="n">start</span><span class="p">,</span>
			<span class="n">resource_size_t</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">**</span><span class="n">p</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">end</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">;</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&lt;=</span> <span class="n">start</span> <span class="o">&amp;&amp;</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">&gt;=</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_BUSY</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">!=</span> <span class="n">start</span> <span class="o">||</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">!=</span> <span class="n">end</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">;</span>
			<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resource_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MUXED</span><span class="p">)</span>
				<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">muxed_resource_wait</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Trying to free nonexistent resource &quot;</span>
		<span class="s">&quot;&lt;%016llx-%016llx&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">start</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">end</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__release_region</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Managed region resource</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">region_devres</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">parent</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">n</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">devm_region_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">region_devres</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">__release_region</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">devm_region_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">match_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">region_devres</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">res</span><span class="p">,</span> <span class="o">*</span><span class="n">match</span> <span class="o">=</span> <span class="n">match_data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">==</span> <span class="n">match</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">&amp;&amp;</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">==</span> <span class="n">match</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&amp;&amp;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">==</span> <span class="n">match</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span> <span class="nf">__devm_request_region</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="n">resource_size_t</span> <span class="n">start</span><span class="p">,</span>
				<span class="n">resource_size_t</span> <span class="n">n</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">region_devres</span> <span class="o">*</span><span class="n">dr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>

	<span class="n">dr</span> <span class="o">=</span> <span class="n">devres_alloc</span><span class="p">(</span><span class="n">devm_region_release</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">region_devres</span><span class="p">),</span>
			  <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dr</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dr</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="p">;</span>
	<span class="n">dr</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">dr</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">__request_region</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">devres_add</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">devres_free</span><span class="p">(</span><span class="n">dr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__devm_request_region</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">__devm_release_region</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span>
			   <span class="n">resource_size_t</span> <span class="n">start</span><span class="p">,</span> <span class="n">resource_size_t</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">region_devres</span> <span class="n">match_data</span> <span class="o">=</span> <span class="p">{</span> <span class="n">parent</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">n</span> <span class="p">};</span>

	<span class="n">__release_region</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">devres_destroy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">devm_region_release</span><span class="p">,</span> <span class="n">devm_region_match</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">match_data</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__devm_release_region</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Called from init/main.c to reserve IO ports.</span>
<span class="cm"> */</span>
<span class="cp">#define MAXRESERVE 4</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">reserve_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">reserved</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">reserve</span><span class="p">[</span><span class="n">MAXRESERVE</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">io_start</span><span class="p">,</span> <span class="n">io_num</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">reserved</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">get_option</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">io_start</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_option</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">io_num</span><span class="p">)</span>   <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">MAXRESERVE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">reserve</span> <span class="o">+</span> <span class="n">x</span><span class="p">;</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;reserved&quot;</span><span class="p">;</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">io_start</span><span class="p">;</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">io_start</span> <span class="o">+</span> <span class="n">io_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_BUSY</span><span class="p">;</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">child</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">request_resource</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="mh">0x10000</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">iomem_resource</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">ioport_resource</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">reserved</span> <span class="o">=</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;reserve=&quot;</span><span class="p">,</span> <span class="n">reserve_setup</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Check if the requested addr and size spans more than any slot in the</span>
<span class="cm"> * iomem resource tree.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">iomem_map_sanity_check</span><span class="p">(</span><span class="n">resource_size_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iomem_resource</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">l</span><span class="p">;</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">;</span> <span class="n">p</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">r_next</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We can probably skip the resources without</span>
<span class="cm">		 * IORESOURCE_IO attribute?</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">size</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">&lt;</span> <span class="n">addr</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * if a resource is &quot;BUSY&quot;, it&#39;s not a hardware resource</span>
<span class="cm">		 * but a driver mapping of such a resource; we don&#39;t want</span>
<span class="cm">		 * to warn for those; some drivers legitimately map only</span>
<span class="cm">		 * partial hardware resources. (example: vesafb)</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_BUSY</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;resource map sanity check conflict: &quot;</span>
		       <span class="s">&quot;0x%llx 0x%llx 0x%llx 0x%llx %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">addr</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">,</span>
		       <span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_STRICT_DEVMEM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">strict_iomem_checks</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">strict_iomem_checks</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * check if an address is reserved in the iomem resource tree</span>
<span class="cm"> * returns 1 if reserved, 0 if not reserved.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">iomem_is_exclusive</span><span class="p">(</span><span class="n">u64</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iomem_resource</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">l</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strict_iomem_checks</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resource_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">;</span> <span class="n">p</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">r_next</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We can probably skip the resources without</span>
<span class="cm">		 * IORESOURCE_IO attribute?</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">size</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">&lt;</span> <span class="n">addr</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_BUSY</span> <span class="o">&amp;&amp;</span>
		     <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_EXCLUSIVE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resource_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">strict_iomem</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;relaxed&quot;</span><span class="p">))</span>
		<span class="n">strict_iomem_checks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;strict&quot;</span><span class="p">))</span>
		<span class="n">strict_iomem_checks</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;iomem=&quot;</span><span class="p">,</span> <span class="n">strict_iomem</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:1}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../javascript/docco.min.js"></script>
</html>
