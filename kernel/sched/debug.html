<!DOCTYPE html>
<html><head><title>joekychen/linux » kernel › sched › debug.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>debug.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * kernel/sched/debug.c</span>
<span class="cm"> *</span>
<span class="cm"> * Print the CFS rbtree</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright(C) 2007, Red Hat, Inc., Ingo Molnar</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/kallsyms.h&gt;</span>
<span class="cp">#include &lt;linux/utsname.h&gt;</span>

<span class="cp">#include &quot;sched.h&quot;</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">sched_debug_lock</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * This allows printing both to /proc/sched_debug and</span>
<span class="cm"> * to the console</span>
<span class="cm"> */</span>
<span class="cp">#define SEQ_printf(m, x...)			\</span>
<span class="cp"> do {						\</span>
<span class="cp">	if (m)					\</span>
<span class="cp">		seq_printf(m, x);		\</span>
<span class="cp">	else					\</span>
<span class="cp">		printk(x);			\</span>
<span class="cp"> } while (0)</span>

<span class="cm">/*</span>
<span class="cm"> * Ease the printing of nsec fields:</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">long</span> <span class="kt">long</span> <span class="nf">nsec_high</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">nsec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">nsec</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nsec</span> <span class="o">=</span> <span class="o">-</span><span class="n">nsec</span><span class="p">;</span>
		<span class="n">do_div</span><span class="p">(</span><span class="n">nsec</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">nsec</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">nsec</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">nsec</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">nsec_low</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">nsec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">nsec</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">nsec</span> <span class="o">=</span> <span class="o">-</span><span class="n">nsec</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">do_div</span><span class="p">(</span><span class="n">nsec</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define SPLIT_NS(x) nsec_high(x), nsec_low(x)</span>

<span class="cp">#ifdef CONFIG_FAIR_GROUP_SCHED</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_cfs_group_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">task_group</span> <span class="o">*</span><span class="n">tg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sched_entity</span> <span class="o">*</span><span class="n">se</span> <span class="o">=</span> <span class="n">tg</span><span class="o">-&gt;</span><span class="n">se</span><span class="p">[</span><span class="n">cpu</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">se</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

<span class="cp">#define P(F) \</span>
<span class="cp">	SEQ_printf(m, &quot;  .%-30s: %lld\n&quot;, #F, (long long)F)</span>
<span class="cp">#define PN(F) \</span>
<span class="cp">	SEQ_printf(m, &quot;  .%-30s: %lld.%06ld\n&quot;, #F, SPLIT_NS((long long)F))</span>

	<span class="n">PN</span><span class="p">(</span><span class="n">se</span><span class="o">-&gt;</span><span class="n">exec_start</span><span class="p">);</span>
	<span class="n">PN</span><span class="p">(</span><span class="n">se</span><span class="o">-&gt;</span><span class="n">vruntime</span><span class="p">);</span>
	<span class="n">PN</span><span class="p">(</span><span class="n">se</span><span class="o">-&gt;</span><span class="n">sum_exec_runtime</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SCHEDSTATS</span>
	<span class="n">PN</span><span class="p">(</span><span class="n">se</span><span class="o">-&gt;</span><span class="n">statistics</span><span class="p">.</span><span class="n">wait_start</span><span class="p">);</span>
	<span class="n">PN</span><span class="p">(</span><span class="n">se</span><span class="o">-&gt;</span><span class="n">statistics</span><span class="p">.</span><span class="n">sleep_start</span><span class="p">);</span>
	<span class="n">PN</span><span class="p">(</span><span class="n">se</span><span class="o">-&gt;</span><span class="n">statistics</span><span class="p">.</span><span class="n">block_start</span><span class="p">);</span>
	<span class="n">PN</span><span class="p">(</span><span class="n">se</span><span class="o">-&gt;</span><span class="n">statistics</span><span class="p">.</span><span class="n">sleep_max</span><span class="p">);</span>
	<span class="n">PN</span><span class="p">(</span><span class="n">se</span><span class="o">-&gt;</span><span class="n">statistics</span><span class="p">.</span><span class="n">block_max</span><span class="p">);</span>
	<span class="n">PN</span><span class="p">(</span><span class="n">se</span><span class="o">-&gt;</span><span class="n">statistics</span><span class="p">.</span><span class="n">exec_max</span><span class="p">);</span>
	<span class="n">PN</span><span class="p">(</span><span class="n">se</span><span class="o">-&gt;</span><span class="n">statistics</span><span class="p">.</span><span class="n">slice_max</span><span class="p">);</span>
	<span class="n">PN</span><span class="p">(</span><span class="n">se</span><span class="o">-&gt;</span><span class="n">statistics</span><span class="p">.</span><span class="n">wait_max</span><span class="p">);</span>
	<span class="n">PN</span><span class="p">(</span><span class="n">se</span><span class="o">-&gt;</span><span class="n">statistics</span><span class="p">.</span><span class="n">wait_sum</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">se</span><span class="o">-&gt;</span><span class="n">statistics</span><span class="p">.</span><span class="n">wait_count</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">P</span><span class="p">(</span><span class="n">se</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">.</span><span class="n">weight</span><span class="p">);</span>
<span class="cp">#undef PN</span>
<span class="cp">#undef P</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_CGROUP_SCHED</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">group_path</span><span class="p">[</span><span class="n">PATH_MAX</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">task_group_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_group</span> <span class="o">*</span><span class="n">tg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">autogroup_path</span><span class="p">(</span><span class="n">tg</span><span class="p">,</span> <span class="n">group_path</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">group_path</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * May be NULL if the underlying cgroup isn&#39;t fully-created yet</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg</span><span class="o">-&gt;</span><span class="n">css</span><span class="p">.</span><span class="n">cgroup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">group_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">group_path</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cgroup_path</span><span class="p">(</span><span class="n">tg</span><span class="o">-&gt;</span><span class="n">css</span><span class="p">.</span><span class="n">cgroup</span><span class="p">,</span> <span class="n">group_path</span><span class="p">,</span> <span class="n">PATH_MAX</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">group_path</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">print_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">curr</span> <span class="o">==</span> <span class="n">p</span><span class="p">)</span>
		<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;R&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>

	<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%15s %5d %9Ld.%06ld %9Ld %5d &quot;</span><span class="p">,</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
		<span class="n">SPLIT_NS</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">se</span><span class="p">.</span><span class="n">vruntime</span><span class="p">),</span>
		<span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nvcsw</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">nivcsw</span><span class="p">),</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SCHEDSTATS</span>
	<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%9Ld.%06ld %9Ld.%06ld %9Ld.%06ld&quot;</span><span class="p">,</span>
		<span class="n">SPLIT_NS</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">se</span><span class="p">.</span><span class="n">vruntime</span><span class="p">),</span>
		<span class="n">SPLIT_NS</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">se</span><span class="p">.</span><span class="n">sum_exec_runtime</span><span class="p">),</span>
		<span class="n">SPLIT_NS</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">se</span><span class="p">.</span><span class="n">statistics</span><span class="p">.</span><span class="n">sum_sleep_runtime</span><span class="p">));</span>
<span class="cp">#else</span>
	<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%15Ld %15Ld %15Ld.%06ld %15Ld.%06ld %15Ld.%06ld&quot;</span><span class="p">,</span>
		<span class="mi">0LL</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">,</span> <span class="mi">0L</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">,</span> <span class="mi">0L</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">,</span> <span class="mi">0L</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_CGROUP_SCHED</span>
	<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">task_group_path</span><span class="p">(</span><span class="n">task_group</span><span class="p">(</span><span class="n">p</span><span class="p">)));</span>
<span class="cp">#endif</span>

	<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_rq</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rq_cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">g</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span>
	<span class="s">&quot;</span><span class="se">\n</span><span class="s">runnable tasks:</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;            task   PID         tree-key  switches  prio&quot;</span>
	<span class="s">&quot;     exec-runtime         sum-exec        sum-sleep</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;------------------------------------------------------&quot;</span>
	<span class="s">&quot;----------------------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">read_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tasklist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">do_each_thread</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">on_rq</span> <span class="o">||</span> <span class="n">task_cpu</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">!=</span> <span class="n">rq_cpu</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">print_task</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">rq</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="p">}</span> <span class="n">while_each_thread</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

	<span class="n">read_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tasklist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">print_cfs_rq</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cfs_rq</span> <span class="o">*</span><span class="n">cfs_rq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s64</span> <span class="n">MIN_vruntime</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">min_vruntime</span><span class="p">,</span> <span class="n">max_vruntime</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="n">spread</span><span class="p">,</span> <span class="n">rq0_min_vruntime</span><span class="p">,</span> <span class="n">spread0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rq</span> <span class="o">*</span><span class="n">rq</span> <span class="o">=</span> <span class="n">cpu_rq</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sched_entity</span> <span class="o">*</span><span class="n">last</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_FAIR_GROUP_SCHED</span>
	<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">cfs_rq[%d]:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">task_group_path</span><span class="p">(</span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">tg</span><span class="p">));</span>
<span class="cp">#else</span>
	<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">cfs_rq[%d]:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  .%-30s: %Ld.%06ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;exec_clock&quot;</span><span class="p">,</span>
			<span class="n">SPLIT_NS</span><span class="p">(</span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">exec_clock</span><span class="p">));</span>

	<span class="n">raw_spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">rb_leftmost</span><span class="p">)</span>
		<span class="n">MIN_vruntime</span> <span class="o">=</span> <span class="p">(</span><span class="n">__pick_first_entity</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">vruntime</span><span class="p">;</span>
	<span class="n">last</span> <span class="o">=</span> <span class="n">__pick_last_entity</span><span class="p">(</span><span class="n">cfs_rq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">last</span><span class="p">)</span>
		<span class="n">max_vruntime</span> <span class="o">=</span> <span class="n">last</span><span class="o">-&gt;</span><span class="n">vruntime</span><span class="p">;</span>
	<span class="n">min_vruntime</span> <span class="o">=</span> <span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">min_vruntime</span><span class="p">;</span>
	<span class="n">rq0_min_vruntime</span> <span class="o">=</span> <span class="n">cpu_rq</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cfs</span><span class="p">.</span><span class="n">min_vruntime</span><span class="p">;</span>
	<span class="n">raw_spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  .%-30s: %Ld.%06ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;MIN_vruntime&quot;</span><span class="p">,</span>
			<span class="n">SPLIT_NS</span><span class="p">(</span><span class="n">MIN_vruntime</span><span class="p">));</span>
	<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  .%-30s: %Ld.%06ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;min_vruntime&quot;</span><span class="p">,</span>
			<span class="n">SPLIT_NS</span><span class="p">(</span><span class="n">min_vruntime</span><span class="p">));</span>
	<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  .%-30s: %Ld.%06ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;max_vruntime&quot;</span><span class="p">,</span>
			<span class="n">SPLIT_NS</span><span class="p">(</span><span class="n">max_vruntime</span><span class="p">));</span>
	<span class="n">spread</span> <span class="o">=</span> <span class="n">max_vruntime</span> <span class="o">-</span> <span class="n">MIN_vruntime</span><span class="p">;</span>
	<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  .%-30s: %Ld.%06ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;spread&quot;</span><span class="p">,</span>
			<span class="n">SPLIT_NS</span><span class="p">(</span><span class="n">spread</span><span class="p">));</span>
	<span class="n">spread0</span> <span class="o">=</span> <span class="n">min_vruntime</span> <span class="o">-</span> <span class="n">rq0_min_vruntime</span><span class="p">;</span>
	<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  .%-30s: %Ld.%06ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;spread0&quot;</span><span class="p">,</span>
			<span class="n">SPLIT_NS</span><span class="p">(</span><span class="n">spread0</span><span class="p">));</span>
	<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  .%-30s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;nr_spread_over&quot;</span><span class="p">,</span>
			<span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">nr_spread_over</span><span class="p">);</span>
	<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  .%-30s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;nr_running&quot;</span><span class="p">,</span> <span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">nr_running</span><span class="p">);</span>
	<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  .%-30s: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;load&quot;</span><span class="p">,</span> <span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">.</span><span class="n">weight</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_FAIR_GROUP_SCHED</span>
<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  .%-30s: %Ld.%06ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;load_avg&quot;</span><span class="p">,</span>
			<span class="n">SPLIT_NS</span><span class="p">(</span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">load_avg</span><span class="p">));</span>
	<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  .%-30s: %Ld.%06ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;load_period&quot;</span><span class="p">,</span>
			<span class="n">SPLIT_NS</span><span class="p">(</span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">load_period</span><span class="p">));</span>
	<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  .%-30s: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;load_contrib&quot;</span><span class="p">,</span>
			<span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">load_contribution</span><span class="p">);</span>
	<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  .%-30s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;load_tg&quot;</span><span class="p">,</span>
			<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">tg</span><span class="o">-&gt;</span><span class="n">load_weight</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="n">print_cfs_group_stats</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">cfs_rq</span><span class="o">-&gt;</span><span class="n">tg</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">print_rt_rq</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rt_rq</span> <span class="o">*</span><span class="n">rt_rq</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_RT_GROUP_SCHED</span>
	<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">rt_rq[%d]:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">task_group_path</span><span class="p">(</span><span class="n">rt_rq</span><span class="o">-&gt;</span><span class="n">tg</span><span class="p">));</span>
<span class="cp">#else</span>
	<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">rt_rq[%d]:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#define P(x) \</span>
<span class="cp">	SEQ_printf(m, &quot;  .%-30s: %Ld\n&quot;, #x, (long long)(rt_rq-&gt;x))</span>
<span class="cp">#define PN(x) \</span>
<span class="cp">	SEQ_printf(m, &quot;  .%-30s: %Ld.%06ld\n&quot;, #x, SPLIT_NS(rt_rq-&gt;x))</span>

	<span class="n">P</span><span class="p">(</span><span class="n">rt_nr_running</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">rt_throttled</span><span class="p">);</span>
	<span class="n">PN</span><span class="p">(</span><span class="n">rt_time</span><span class="p">);</span>
	<span class="n">PN</span><span class="p">(</span><span class="n">rt_runtime</span><span class="p">);</span>

<span class="cp">#undef PN</span>
<span class="cp">#undef P</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="n">__read_mostly</span> <span class="kt">int</span> <span class="n">sched_clock_running</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_cpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rq</span> <span class="o">*</span><span class="n">rq</span> <span class="o">=</span> <span class="n">cpu_rq</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_X86</span>
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span> <span class="o">=</span> <span class="n">cpu_khz</span> <span class="o">?</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">cpu#%d, %u.%03u MHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">cpu</span><span class="p">,</span> <span class="n">freq</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="p">(</span><span class="n">freq</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">));</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">cpu#%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#define P(x)								\</span>
<span class="cp">do {									\</span>
<span class="cp">	if (sizeof(rq-&gt;x) == 4)						\</span>
<span class="cp">		SEQ_printf(m, &quot;  .%-30s: %ld\n&quot;, #x, (long)(rq-&gt;x));	\</span>
<span class="cp">	else								\</span>
<span class="cp">		SEQ_printf(m, &quot;  .%-30s: %Ld\n&quot;, #x, (long long)(rq-&gt;x));\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define PN(x) \</span>
<span class="cp">	SEQ_printf(m, &quot;  .%-30s: %Ld.%06ld\n&quot;, #x, SPLIT_NS(rq-&gt;x))</span>

	<span class="n">P</span><span class="p">(</span><span class="n">nr_running</span><span class="p">);</span>
	<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  .%-30s: %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;load&quot;</span><span class="p">,</span>
		   <span class="n">rq</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">.</span><span class="n">weight</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">nr_switches</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">nr_load_updates</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">nr_uninterruptible</span><span class="p">);</span>
	<span class="n">PN</span><span class="p">(</span><span class="n">next_balance</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">PN</span><span class="p">(</span><span class="n">clock</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">cpu_load</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">cpu_load</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">cpu_load</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">cpu_load</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">cpu_load</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
<span class="cp">#undef P</span>
<span class="cp">#undef PN</span>

<span class="cp">#ifdef CONFIG_SCHEDSTATS</span>
<span class="cp">#define P(n) SEQ_printf(m, &quot;  .%-30s: %d\n&quot;, #n, rq-&gt;n);</span>
<span class="cp">#define P64(n) SEQ_printf(m, &quot;  .%-30s: %Ld\n&quot;, #n, rq-&gt;n);</span>

	<span class="n">P</span><span class="p">(</span><span class="n">yld_count</span><span class="p">);</span>

	<span class="n">P</span><span class="p">(</span><span class="n">sched_count</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">sched_goidle</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="n">P64</span><span class="p">(</span><span class="n">avg_idle</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">P</span><span class="p">(</span><span class="n">ttwu_count</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">ttwu_local</span><span class="p">);</span>

<span class="cp">#undef P</span>
<span class="cp">#undef P64</span>
<span class="cp">#endif</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sched_debug_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">print_cfs_stats</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
	<span class="n">print_rt_stats</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">print_rq</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">rq</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sched_debug_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sched_tunable_scaling_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;none&quot;</span><span class="p">,</span>
	<span class="s">&quot;logaritmic&quot;</span><span class="p">,</span>
	<span class="s">&quot;linear&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sched_debug_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">ktime</span><span class="p">,</span> <span class="n">sched_clk</span><span class="p">,</span> <span class="n">cpu_clk</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">ktime</span> <span class="o">=</span> <span class="n">ktime_to_ns</span><span class="p">(</span><span class="n">ktime_get</span><span class="p">());</span>
	<span class="n">sched_clk</span> <span class="o">=</span> <span class="n">sched_clock</span><span class="p">();</span>
	<span class="n">cpu_clk</span> <span class="o">=</span> <span class="n">local_clock</span><span class="p">();</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Sched Debug Version: v0.10, %s %.*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">init_utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">strcspn</span><span class="p">(</span><span class="n">init_utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">),</span>
		<span class="n">init_utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>

<span class="cp">#define P(x) \</span>
<span class="cp">	SEQ_printf(m, &quot;%-40s: %Ld\n&quot;, #x, (long long)(x))</span>
<span class="cp">#define PN(x) \</span>
<span class="cp">	SEQ_printf(m, &quot;%-40s: %Ld.%06ld\n&quot;, #x, SPLIT_NS(x))</span>
	<span class="n">PN</span><span class="p">(</span><span class="n">ktime</span><span class="p">);</span>
	<span class="n">PN</span><span class="p">(</span><span class="n">sched_clk</span><span class="p">);</span>
	<span class="n">PN</span><span class="p">(</span><span class="n">cpu_clk</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">jiffies</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_HAVE_UNSTABLE_SCHED_CLOCK</span>
	<span class="n">P</span><span class="p">(</span><span class="n">sched_clock_stable</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#undef PN</span>
<span class="cp">#undef P</span>

	<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;sysctl_sched</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="cp">#define P(x) \</span>
<span class="cp">	SEQ_printf(m, &quot;  .%-40s: %Ld\n&quot;, #x, (long long)(x))</span>
<span class="cp">#define PN(x) \</span>
<span class="cp">	SEQ_printf(m, &quot;  .%-40s: %Ld.%06ld\n&quot;, #x, SPLIT_NS(x))</span>
	<span class="n">PN</span><span class="p">(</span><span class="n">sysctl_sched_latency</span><span class="p">);</span>
	<span class="n">PN</span><span class="p">(</span><span class="n">sysctl_sched_min_granularity</span><span class="p">);</span>
	<span class="n">PN</span><span class="p">(</span><span class="n">sysctl_sched_wakeup_granularity</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">sysctl_sched_child_runs_first</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">sysctl_sched_features</span><span class="p">);</span>
<span class="cp">#undef PN</span>
<span class="cp">#undef P</span>

	<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  .%-40s: %d (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;sysctl_sched_tunable_scaling&quot;</span><span class="p">,</span>
		<span class="n">sysctl_sched_tunable_scaling</span><span class="p">,</span>
		<span class="n">sched_tunable_scaling_names</span><span class="p">[</span><span class="n">sysctl_sched_tunable_scaling</span><span class="p">]);</span>

	<span class="n">for_each_online_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span>
		<span class="n">print_cpu</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

	<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">sysrq_sched_debug_show</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sched_debug_show</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sched_debug_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">sched_debug_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">sched_debug_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">sched_debug_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_sched_debug_procfs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">pe</span><span class="p">;</span>

	<span class="n">pe</span> <span class="o">=</span> <span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;sched_debug&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sched_debug_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pe</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__initcall</span><span class="p">(</span><span class="n">init_sched_debug_procfs</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">proc_sched_show_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr_switches</span><span class="p">;</span>

	<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s (%d, #threads: %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span>
						<span class="n">get_nr_threads</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>
	<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span>
		<span class="s">&quot;---------------------------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#define __P(F) \</span>
<span class="cp">	SEQ_printf(m, &quot;%-35s:%21Ld\n&quot;, #F, (long long)F)</span>
<span class="cp">#define P(F) \</span>
<span class="cp">	SEQ_printf(m, &quot;%-35s:%21Ld\n&quot;, #F, (long long)p-&gt;F)</span>
<span class="cp">#define __PN(F) \</span>
<span class="cp">	SEQ_printf(m, &quot;%-35s:%14Ld.%06ld\n&quot;, #F, SPLIT_NS((long long)F))</span>
<span class="cp">#define PN(F) \</span>
<span class="cp">	SEQ_printf(m, &quot;%-35s:%14Ld.%06ld\n&quot;, #F, SPLIT_NS((long long)p-&gt;F))</span>

	<span class="n">PN</span><span class="p">(</span><span class="n">se</span><span class="p">.</span><span class="n">exec_start</span><span class="p">);</span>
	<span class="n">PN</span><span class="p">(</span><span class="n">se</span><span class="p">.</span><span class="n">vruntime</span><span class="p">);</span>
	<span class="n">PN</span><span class="p">(</span><span class="n">se</span><span class="p">.</span><span class="n">sum_exec_runtime</span><span class="p">);</span>

	<span class="n">nr_switches</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">nvcsw</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">nivcsw</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SCHEDSTATS</span>
	<span class="n">PN</span><span class="p">(</span><span class="n">se</span><span class="p">.</span><span class="n">statistics</span><span class="p">.</span><span class="n">wait_start</span><span class="p">);</span>
	<span class="n">PN</span><span class="p">(</span><span class="n">se</span><span class="p">.</span><span class="n">statistics</span><span class="p">.</span><span class="n">sleep_start</span><span class="p">);</span>
	<span class="n">PN</span><span class="p">(</span><span class="n">se</span><span class="p">.</span><span class="n">statistics</span><span class="p">.</span><span class="n">block_start</span><span class="p">);</span>
	<span class="n">PN</span><span class="p">(</span><span class="n">se</span><span class="p">.</span><span class="n">statistics</span><span class="p">.</span><span class="n">sleep_max</span><span class="p">);</span>
	<span class="n">PN</span><span class="p">(</span><span class="n">se</span><span class="p">.</span><span class="n">statistics</span><span class="p">.</span><span class="n">block_max</span><span class="p">);</span>
	<span class="n">PN</span><span class="p">(</span><span class="n">se</span><span class="p">.</span><span class="n">statistics</span><span class="p">.</span><span class="n">exec_max</span><span class="p">);</span>
	<span class="n">PN</span><span class="p">(</span><span class="n">se</span><span class="p">.</span><span class="n">statistics</span><span class="p">.</span><span class="n">slice_max</span><span class="p">);</span>
	<span class="n">PN</span><span class="p">(</span><span class="n">se</span><span class="p">.</span><span class="n">statistics</span><span class="p">.</span><span class="n">wait_max</span><span class="p">);</span>
	<span class="n">PN</span><span class="p">(</span><span class="n">se</span><span class="p">.</span><span class="n">statistics</span><span class="p">.</span><span class="n">wait_sum</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">se</span><span class="p">.</span><span class="n">statistics</span><span class="p">.</span><span class="n">wait_count</span><span class="p">);</span>
	<span class="n">PN</span><span class="p">(</span><span class="n">se</span><span class="p">.</span><span class="n">statistics</span><span class="p">.</span><span class="n">iowait_sum</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">se</span><span class="p">.</span><span class="n">statistics</span><span class="p">.</span><span class="n">iowait_count</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">se</span><span class="p">.</span><span class="n">nr_migrations</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">se</span><span class="p">.</span><span class="n">statistics</span><span class="p">.</span><span class="n">nr_migrations_cold</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">se</span><span class="p">.</span><span class="n">statistics</span><span class="p">.</span><span class="n">nr_failed_migrations_affine</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">se</span><span class="p">.</span><span class="n">statistics</span><span class="p">.</span><span class="n">nr_failed_migrations_running</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">se</span><span class="p">.</span><span class="n">statistics</span><span class="p">.</span><span class="n">nr_failed_migrations_hot</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">se</span><span class="p">.</span><span class="n">statistics</span><span class="p">.</span><span class="n">nr_forced_migrations</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">se</span><span class="p">.</span><span class="n">statistics</span><span class="p">.</span><span class="n">nr_wakeups</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">se</span><span class="p">.</span><span class="n">statistics</span><span class="p">.</span><span class="n">nr_wakeups_sync</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">se</span><span class="p">.</span><span class="n">statistics</span><span class="p">.</span><span class="n">nr_wakeups_migrate</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">se</span><span class="p">.</span><span class="n">statistics</span><span class="p">.</span><span class="n">nr_wakeups_local</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">se</span><span class="p">.</span><span class="n">statistics</span><span class="p">.</span><span class="n">nr_wakeups_remote</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">se</span><span class="p">.</span><span class="n">statistics</span><span class="p">.</span><span class="n">nr_wakeups_affine</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">se</span><span class="p">.</span><span class="n">statistics</span><span class="p">.</span><span class="n">nr_wakeups_affine_attempts</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">se</span><span class="p">.</span><span class="n">statistics</span><span class="p">.</span><span class="n">nr_wakeups_passive</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">se</span><span class="p">.</span><span class="n">statistics</span><span class="p">.</span><span class="n">nr_wakeups_idle</span><span class="p">);</span>

	<span class="p">{</span>
		<span class="n">u64</span> <span class="n">avg_atom</span><span class="p">,</span> <span class="n">avg_per_cpu</span><span class="p">;</span>

		<span class="n">avg_atom</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">se</span><span class="p">.</span><span class="n">sum_exec_runtime</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nr_switches</span><span class="p">)</span>
			<span class="n">do_div</span><span class="p">(</span><span class="n">avg_atom</span><span class="p">,</span> <span class="n">nr_switches</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">avg_atom</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1LL</span><span class="p">;</span>

		<span class="n">avg_per_cpu</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">se</span><span class="p">.</span><span class="n">sum_exec_runtime</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">se</span><span class="p">.</span><span class="n">nr_migrations</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">avg_per_cpu</span> <span class="o">=</span> <span class="n">div64_u64</span><span class="p">(</span><span class="n">avg_per_cpu</span><span class="p">,</span>
						<span class="n">p</span><span class="o">-&gt;</span><span class="n">se</span><span class="p">.</span><span class="n">nr_migrations</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">avg_per_cpu</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1LL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">__PN</span><span class="p">(</span><span class="n">avg_atom</span><span class="p">);</span>
		<span class="n">__PN</span><span class="p">(</span><span class="n">avg_per_cpu</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">__P</span><span class="p">(</span><span class="n">nr_switches</span><span class="p">);</span>
	<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%-35s:%21Ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="s">&quot;nr_voluntary_switches&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nvcsw</span><span class="p">);</span>
	<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%-35s:%21Ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="s">&quot;nr_involuntary_switches&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">nivcsw</span><span class="p">);</span>

	<span class="n">P</span><span class="p">(</span><span class="n">se</span><span class="p">.</span><span class="n">load</span><span class="p">.</span><span class="n">weight</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">policy</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">prio</span><span class="p">);</span>
<span class="cp">#undef PN</span>
<span class="cp">#undef __PN</span>
<span class="cp">#undef P</span>
<span class="cp">#undef __P</span>

	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">this_cpu</span> <span class="o">=</span> <span class="n">raw_smp_processor_id</span><span class="p">();</span>
		<span class="n">u64</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">;</span>

		<span class="n">t0</span> <span class="o">=</span> <span class="n">cpu_clock</span><span class="p">(</span><span class="n">this_cpu</span><span class="p">);</span>
		<span class="n">t1</span> <span class="o">=</span> <span class="n">cpu_clock</span><span class="p">(</span><span class="n">this_cpu</span><span class="p">);</span>
		<span class="n">SEQ_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%-35s:%21Ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="s">&quot;clock-delta&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span><span class="n">t1</span><span class="o">-</span><span class="n">t0</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">proc_sched_set_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_SCHEDSTATS</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">se</span><span class="p">.</span><span class="n">statistics</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">se</span><span class="p">.</span><span class="n">statistics</span><span class="p">));</span>
<span class="cp">#endif</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
