<!DOCTYPE html>
<html><head><title>joekychen/linux » kernel › rcutree_trace.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../index.html"></a><h1>rcutree_trace.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Read-Copy Update tracing for classic implementation</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright IBM Corporation, 2008</span>
<span class="cm"> *</span>
<span class="cm"> * Papers:  http://www.rdrop.com/users/paulmck/RCU</span>
<span class="cm"> *</span>
<span class="cm"> * For detailed explanation of Read-Copy Update mechanism see -</span>
<span class="cm"> *		Documentation/RCU</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/smp.h&gt;</span>
<span class="cp">#include &lt;linux/rcupdate.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/atomic.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/percpu.h&gt;</span>
<span class="cp">#include &lt;linux/notifier.h&gt;</span>
<span class="cp">#include &lt;linux/cpu.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>

<span class="cp">#define RCU_TREE_NONCORE</span>
<span class="cp">#include &quot;rcutree.h&quot;</span>

<span class="cp">#ifdef CONFIG_RCU_BOOST</span>

<span class="k">static</span> <span class="kt">char</span> <span class="nf">convert_kthread_status</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">kthread_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kthread_status</span> <span class="o">&gt;</span> <span class="n">RCU_KTHREAD_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="sc">&#39;?&#39;</span><span class="p">;</span>
	<span class="k">return</span> <span class="s">&quot;SRWOY&quot;</span><span class="p">[</span><span class="n">kthread_status</span><span class="p">];</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* #ifdef CONFIG_RCU_BOOST */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_one_rcu_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rcu_data</span> <span class="o">*</span><span class="n">rdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdp</span><span class="o">-&gt;</span><span class="n">beenonline</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%3d%cc=%lu g=%lu pq=%d pgp=%lu qp=%d&quot;</span><span class="p">,</span>
		   <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">,</span>
		   <span class="n">cpu_is_offline</span><span class="p">(</span><span class="n">rdp</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;!&#39;</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">,</span>
		   <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">completed</span><span class="p">,</span> <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">gpnum</span><span class="p">,</span>
		   <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">passed_quiesce</span><span class="p">,</span> <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">passed_quiesce_gpnum</span><span class="p">,</span>
		   <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">qs_pending</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; dt=%d/%llx/%d df=%lu&quot;</span><span class="p">,</span>
		   <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdp</span><span class="o">-&gt;</span><span class="n">dynticks</span><span class="o">-&gt;</span><span class="n">dynticks</span><span class="p">),</span>
		   <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">dynticks</span><span class="o">-&gt;</span><span class="n">dynticks_nesting</span><span class="p">,</span>
		   <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">dynticks</span><span class="o">-&gt;</span><span class="n">dynticks_nmi_nesting</span><span class="p">,</span>
		   <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">dynticks_fqs</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; of=%lu&quot;</span><span class="p">,</span> <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">offline_fqs</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; ql=%ld/%ld qs=%c%c%c%c&quot;</span><span class="p">,</span>
		   <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">qlen_lazy</span><span class="p">,</span> <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">qlen</span><span class="p">,</span>
		   <span class="s">&quot;.N&quot;</span><span class="p">[</span><span class="n">rdp</span><span class="o">-&gt;</span><span class="n">nxttail</span><span class="p">[</span><span class="n">RCU_NEXT_READY_TAIL</span><span class="p">]</span> <span class="o">!=</span>
			<span class="n">rdp</span><span class="o">-&gt;</span><span class="n">nxttail</span><span class="p">[</span><span class="n">RCU_NEXT_TAIL</span><span class="p">]],</span>
		   <span class="s">&quot;.R&quot;</span><span class="p">[</span><span class="n">rdp</span><span class="o">-&gt;</span><span class="n">nxttail</span><span class="p">[</span><span class="n">RCU_WAIT_TAIL</span><span class="p">]</span> <span class="o">!=</span>
			<span class="n">rdp</span><span class="o">-&gt;</span><span class="n">nxttail</span><span class="p">[</span><span class="n">RCU_NEXT_READY_TAIL</span><span class="p">]],</span>
		   <span class="s">&quot;.W&quot;</span><span class="p">[</span><span class="n">rdp</span><span class="o">-&gt;</span><span class="n">nxttail</span><span class="p">[</span><span class="n">RCU_DONE_TAIL</span><span class="p">]</span> <span class="o">!=</span>
			<span class="n">rdp</span><span class="o">-&gt;</span><span class="n">nxttail</span><span class="p">[</span><span class="n">RCU_WAIT_TAIL</span><span class="p">]],</span>
		   <span class="s">&quot;.D&quot;</span><span class="p">[</span><span class="o">&amp;</span><span class="n">rdp</span><span class="o">-&gt;</span><span class="n">nxtlist</span> <span class="o">!=</span> <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">nxttail</span><span class="p">[</span><span class="n">RCU_DONE_TAIL</span><span class="p">]]);</span>
<span class="cp">#ifdef CONFIG_RCU_BOOST</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; kt=%d/%c/%d ktl=%x&quot;</span><span class="p">,</span>
		   <span class="n">per_cpu</span><span class="p">(</span><span class="n">rcu_cpu_has_work</span><span class="p">,</span> <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">),</span>
		   <span class="n">convert_kthread_status</span><span class="p">(</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">rcu_cpu_kthread_status</span><span class="p">,</span>
					  <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">)),</span>
		   <span class="n">per_cpu</span><span class="p">(</span><span class="n">rcu_cpu_kthread_cpu</span><span class="p">,</span> <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">),</span>
		   <span class="n">per_cpu</span><span class="p">(</span><span class="n">rcu_cpu_kthread_loops</span><span class="p">,</span> <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* #ifdef CONFIG_RCU_BOOST */</span><span class="cp"></span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; b=%ld&quot;</span><span class="p">,</span> <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">blimit</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; ci=%lu co=%lu ca=%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">n_cbs_invoked</span><span class="p">,</span> <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">n_cbs_orphaned</span><span class="p">,</span> <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">n_cbs_adopted</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define PRINT_RCU_DATA(name, func, m) \</span>
<span class="cp">	do { \</span>
<span class="cp">		int _p_r_d_i; \</span>
<span class="cp">		\</span>
<span class="cp">		for_each_possible_cpu(_p_r_d_i) \</span>
<span class="cp">			func(m, &amp;per_cpu(name, _p_r_d_i)); \</span>
<span class="cp">	} while (0)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">show_rcudata</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_TREE_PREEMPT_RCU</span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;rcu_preempt:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">PRINT_RCU_DATA</span><span class="p">(</span><span class="n">rcu_preempt_data</span><span class="p">,</span> <span class="n">print_one_rcu_data</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* #ifdef CONFIG_TREE_PREEMPT_RCU */</span><span class="cp"></span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;rcu_sched:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">PRINT_RCU_DATA</span><span class="p">(</span><span class="n">rcu_sched_data</span><span class="p">,</span> <span class="n">print_one_rcu_data</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;rcu_bh:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">PRINT_RCU_DATA</span><span class="p">(</span><span class="n">rcu_bh_data</span><span class="p">,</span> <span class="n">print_one_rcu_data</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rcudata_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">show_rcudata</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">rcudata_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">rcudata_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_one_rcu_data_csv</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rcu_data</span> <span class="o">*</span><span class="n">rdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdp</span><span class="o">-&gt;</span><span class="n">beenonline</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%d,%s,%lu,%lu,%d,%lu,%d&quot;</span><span class="p">,</span>
		   <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">,</span>
		   <span class="n">cpu_is_offline</span><span class="p">(</span><span class="n">rdp</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">N</span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="o">:</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">Y</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">completed</span><span class="p">,</span> <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">gpnum</span><span class="p">,</span>
		   <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">passed_quiesce</span><span class="p">,</span> <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">passed_quiesce_gpnum</span><span class="p">,</span>
		   <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">qs_pending</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,%d,%llx,%d,%lu&quot;</span><span class="p">,</span>
		   <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdp</span><span class="o">-&gt;</span><span class="n">dynticks</span><span class="o">-&gt;</span><span class="n">dynticks</span><span class="p">),</span>
		   <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">dynticks</span><span class="o">-&gt;</span><span class="n">dynticks_nesting</span><span class="p">,</span>
		   <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">dynticks</span><span class="o">-&gt;</span><span class="n">dynticks_nmi_nesting</span><span class="p">,</span>
		   <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">dynticks_fqs</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,%lu&quot;</span><span class="p">,</span> <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">offline_fqs</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,%ld,%ld,</span><span class="se">\&quot;</span><span class="s">%c%c%c%c</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">qlen_lazy</span><span class="p">,</span> <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">qlen</span><span class="p">,</span>
		   <span class="s">&quot;.N&quot;</span><span class="p">[</span><span class="n">rdp</span><span class="o">-&gt;</span><span class="n">nxttail</span><span class="p">[</span><span class="n">RCU_NEXT_READY_TAIL</span><span class="p">]</span> <span class="o">!=</span>
			<span class="n">rdp</span><span class="o">-&gt;</span><span class="n">nxttail</span><span class="p">[</span><span class="n">RCU_NEXT_TAIL</span><span class="p">]],</span>
		   <span class="s">&quot;.R&quot;</span><span class="p">[</span><span class="n">rdp</span><span class="o">-&gt;</span><span class="n">nxttail</span><span class="p">[</span><span class="n">RCU_WAIT_TAIL</span><span class="p">]</span> <span class="o">!=</span>
			<span class="n">rdp</span><span class="o">-&gt;</span><span class="n">nxttail</span><span class="p">[</span><span class="n">RCU_NEXT_READY_TAIL</span><span class="p">]],</span>
		   <span class="s">&quot;.W&quot;</span><span class="p">[</span><span class="n">rdp</span><span class="o">-&gt;</span><span class="n">nxttail</span><span class="p">[</span><span class="n">RCU_DONE_TAIL</span><span class="p">]</span> <span class="o">!=</span>
			<span class="n">rdp</span><span class="o">-&gt;</span><span class="n">nxttail</span><span class="p">[</span><span class="n">RCU_WAIT_TAIL</span><span class="p">]],</span>
		   <span class="s">&quot;.D&quot;</span><span class="p">[</span><span class="o">&amp;</span><span class="n">rdp</span><span class="o">-&gt;</span><span class="n">nxtlist</span> <span class="o">!=</span> <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">nxttail</span><span class="p">[</span><span class="n">RCU_DONE_TAIL</span><span class="p">]]);</span>
<span class="cp">#ifdef CONFIG_RCU_BOOST</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,%d,</span><span class="se">\&quot;</span><span class="s">%c</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">per_cpu</span><span class="p">(</span><span class="n">rcu_cpu_has_work</span><span class="p">,</span> <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">),</span>
		   <span class="n">convert_kthread_status</span><span class="p">(</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">rcu_cpu_kthread_status</span><span class="p">,</span>
					  <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">)));</span>
<span class="cp">#endif </span><span class="cm">/* #ifdef CONFIG_RCU_BOOST */</span><span class="cp"></span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,%ld&quot;</span><span class="p">,</span> <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">blimit</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,%lu,%lu,%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">n_cbs_invoked</span><span class="p">,</span> <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">n_cbs_orphaned</span><span class="p">,</span> <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">n_cbs_adopted</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">show_rcudata_csv</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">CPU</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">Online?</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">c</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">g</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">pq</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">pgp</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">pq</span><span class="se">\&quot;</span><span class="s">,&quot;</span><span class="p">);</span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">dt</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">dt nesting</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">dt NMI nesting</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">df</span><span class="se">\&quot;</span><span class="s">,&quot;</span><span class="p">);</span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">of</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">qll</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">ql</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">qs</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_RCU_BOOST</span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">kt</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">ktl</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* #ifdef CONFIG_RCU_BOOST */</span><span class="cp"></span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;,</span><span class="se">\&quot;</span><span class="s">b</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">ci</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">co</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">ca</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_TREE_PREEMPT_RCU</span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">rcu_preempt:</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">PRINT_RCU_DATA</span><span class="p">(</span><span class="n">rcu_preempt_data</span><span class="p">,</span> <span class="n">print_one_rcu_data_csv</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* #ifdef CONFIG_TREE_PREEMPT_RCU */</span><span class="cp"></span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">rcu_sched:</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">PRINT_RCU_DATA</span><span class="p">(</span><span class="n">rcu_sched_data</span><span class="p">,</span> <span class="n">print_one_rcu_data_csv</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">rcu_bh:</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">PRINT_RCU_DATA</span><span class="p">(</span><span class="n">rcu_bh_data</span><span class="p">,</span> <span class="n">print_one_rcu_data_csv</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rcudata_csv_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">show_rcudata_csv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">rcudata_csv_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">rcudata_csv_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_RCU_BOOST</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_one_rcu_node_boost</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rcu_node</span> <span class="o">*</span><span class="n">rnp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span>  <span class="s">&quot;%d:%d tasks=%c%c%c%c kt=%c ntb=%lu neb=%lu nnb=%lu &quot;</span>
		   <span class="s">&quot;j=%04x bt=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">rnp</span><span class="o">-&gt;</span><span class="n">grplo</span><span class="p">,</span> <span class="n">rnp</span><span class="o">-&gt;</span><span class="n">grphi</span><span class="p">,</span>
		   <span class="s">&quot;T.&quot;</span><span class="p">[</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rnp</span><span class="o">-&gt;</span><span class="n">blkd_tasks</span><span class="p">)],</span>
		   <span class="s">&quot;N.&quot;</span><span class="p">[</span><span class="o">!</span><span class="n">rnp</span><span class="o">-&gt;</span><span class="n">gp_tasks</span><span class="p">],</span>
		   <span class="s">&quot;E.&quot;</span><span class="p">[</span><span class="o">!</span><span class="n">rnp</span><span class="o">-&gt;</span><span class="n">exp_tasks</span><span class="p">],</span>
		   <span class="s">&quot;B.&quot;</span><span class="p">[</span><span class="o">!</span><span class="n">rnp</span><span class="o">-&gt;</span><span class="n">boost_tasks</span><span class="p">],</span>
		   <span class="n">convert_kthread_status</span><span class="p">(</span><span class="n">rnp</span><span class="o">-&gt;</span><span class="n">boost_kthread_status</span><span class="p">),</span>
		   <span class="n">rnp</span><span class="o">-&gt;</span><span class="n">n_tasks_boosted</span><span class="p">,</span> <span class="n">rnp</span><span class="o">-&gt;</span><span class="n">n_exp_boosts</span><span class="p">,</span>
		   <span class="n">rnp</span><span class="o">-&gt;</span><span class="n">n_normal_boosts</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">jiffies</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">),</span>
		   <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">rnp</span><span class="o">-&gt;</span><span class="n">boost_time</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s: nt=%lu egt=%lu bt=%lu nb=%lu ny=%lu nos=%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="s">&quot;     balk&quot;</span><span class="p">,</span>
		   <span class="n">rnp</span><span class="o">-&gt;</span><span class="n">n_balk_blkd_tasks</span><span class="p">,</span>
		   <span class="n">rnp</span><span class="o">-&gt;</span><span class="n">n_balk_exp_gp_tasks</span><span class="p">,</span>
		   <span class="n">rnp</span><span class="o">-&gt;</span><span class="n">n_balk_boost_tasks</span><span class="p">,</span>
		   <span class="n">rnp</span><span class="o">-&gt;</span><span class="n">n_balk_notblocked</span><span class="p">,</span>
		   <span class="n">rnp</span><span class="o">-&gt;</span><span class="n">n_balk_notyet</span><span class="p">,</span>
		   <span class="n">rnp</span><span class="o">-&gt;</span><span class="n">n_balk_nos</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">show_rcu_node_boost</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rcu_node</span> <span class="o">*</span><span class="n">rnp</span><span class="p">;</span>

	<span class="n">rcu_for_each_leaf_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rcu_preempt_state</span><span class="p">,</span> <span class="n">rnp</span><span class="p">)</span>
		<span class="n">print_one_rcu_node_boost</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">rnp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rcu_node_boost_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">show_rcu_node_boost</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">rcu_node_boost_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">rcu_node_boost_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Create the rcuboost debugfs entry.  Standard error return.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rcu_boost_trace_create_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">rcudir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;rcuboost&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">rcudir</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">rcu_node_boost_fops</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else </span><span class="cm">/* #ifdef CONFIG_RCU_BOOST */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rcu_boost_trace_create_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">rcudir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* There cannot be an error if we didn&#39;t create it! */</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* #else #ifdef CONFIG_RCU_BOOST */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_one_rcu_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rcu_state</span> <span class="o">*</span><span class="n">rsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">gpnum</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rcu_node</span> <span class="o">*</span><span class="n">rnp</span><span class="p">;</span>

	<span class="n">gpnum</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">gpnum</span><span class="p">;</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;c=%lu g=%lu s=%d jfq=%ld j=%x &quot;</span>
		      <span class="s">&quot;nfqs=%lu/nfqsng=%lu(%lu) fqlh=%lu oqlen=%ld/%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">completed</span><span class="p">,</span> <span class="n">gpnum</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">fqs_state</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">jiffies_force_qs</span> <span class="o">-</span> <span class="n">jiffies</span><span class="p">),</span>
		   <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">jiffies</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">),</span>
		   <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">n_force_qs</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">n_force_qs_ngp</span><span class="p">,</span>
		   <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">n_force_qs</span> <span class="o">-</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">n_force_qs_ngp</span><span class="p">,</span>
		   <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">n_force_qs_lh</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">qlen_lazy</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">qlen</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">rnp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">rnp</span> <span class="o">-</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">NUM_RCU_NODES</span><span class="p">;</span> <span class="n">rnp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rnp</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">!=</span> <span class="n">level</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">level</span> <span class="o">=</span> <span class="n">rnp</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%lx/%lx %c%c&gt;%c %d:%d ^%d    &quot;</span><span class="p">,</span>
			   <span class="n">rnp</span><span class="o">-&gt;</span><span class="n">qsmask</span><span class="p">,</span> <span class="n">rnp</span><span class="o">-&gt;</span><span class="n">qsmaskinit</span><span class="p">,</span>
			   <span class="s">&quot;.G&quot;</span><span class="p">[</span><span class="n">rnp</span><span class="o">-&gt;</span><span class="n">gp_tasks</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">],</span>
			   <span class="s">&quot;.E&quot;</span><span class="p">[</span><span class="n">rnp</span><span class="o">-&gt;</span><span class="n">exp_tasks</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">],</span>
			   <span class="s">&quot;.T&quot;</span><span class="p">[</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rnp</span><span class="o">-&gt;</span><span class="n">blkd_tasks</span><span class="p">)],</span>
			   <span class="n">rnp</span><span class="o">-&gt;</span><span class="n">grplo</span><span class="p">,</span> <span class="n">rnp</span><span class="o">-&gt;</span><span class="n">grphi</span><span class="p">,</span> <span class="n">rnp</span><span class="o">-&gt;</span><span class="n">grpnum</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">show_rcuhier</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_TREE_PREEMPT_RCU</span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;rcu_preempt:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">print_one_rcu_state</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rcu_preempt_state</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* #ifdef CONFIG_TREE_PREEMPT_RCU */</span><span class="cp"></span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;rcu_sched:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">print_one_rcu_state</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rcu_sched_state</span><span class="p">);</span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;rcu_bh:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">print_one_rcu_state</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rcu_bh_state</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rcuhier_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">show_rcuhier</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">rcuhier_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">rcuhier_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">show_one_rcugp</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rcu_state</span> <span class="o">*</span><span class="n">rsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">completed</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">gpnum</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">gpage</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">gpmax</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rcu_node</span> <span class="o">*</span><span class="n">rnp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">raw_spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rnp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">completed</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">completed</span><span class="p">;</span>
	<span class="n">gpnum</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">gpnum</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">completed</span> <span class="o">==</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">gpnum</span><span class="p">)</span>
		<span class="n">gpage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">gpage</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">gp_start</span><span class="p">;</span>
	<span class="n">gpmax</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">gp_max</span><span class="p">;</span>
	<span class="n">raw_spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rnp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s: completed=%ld  gpnum=%lu  age=%ld  max=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">completed</span><span class="p">,</span> <span class="n">gpnum</span><span class="p">,</span> <span class="n">gpage</span><span class="p">,</span> <span class="n">gpmax</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">show_rcugp</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_TREE_PREEMPT_RCU</span>
	<span class="n">show_one_rcugp</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rcu_preempt_state</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* #ifdef CONFIG_TREE_PREEMPT_RCU */</span><span class="cp"></span>
	<span class="n">show_one_rcugp</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rcu_sched_state</span><span class="p">);</span>
	<span class="n">show_one_rcugp</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rcu_bh_state</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rcugp_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">show_rcugp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">rcugp_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">rcugp_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_one_rcu_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rcu_data</span> <span class="o">*</span><span class="n">rdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%3d%cnp=%ld &quot;</span>
		   <span class="s">&quot;qsp=%ld rpq=%ld cbr=%ld cng=%ld &quot;</span>
		   <span class="s">&quot;gpc=%ld gps=%ld nf=%ld nn=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">,</span>
		   <span class="n">cpu_is_offline</span><span class="p">(</span><span class="n">rdp</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;!&#39;</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">,</span>
		   <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">n_rcu_pending</span><span class="p">,</span>
		   <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">n_rp_qs_pending</span><span class="p">,</span>
		   <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">n_rp_report_qs</span><span class="p">,</span>
		   <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">n_rp_cb_ready</span><span class="p">,</span>
		   <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">n_rp_cpu_needs_gp</span><span class="p">,</span>
		   <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">n_rp_gp_completed</span><span class="p">,</span>
		   <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">n_rp_gp_started</span><span class="p">,</span>
		   <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">n_rp_need_fqs</span><span class="p">,</span>
		   <span class="n">rdp</span><span class="o">-&gt;</span><span class="n">n_rp_need_nothing</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_rcu_pendings</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rcu_state</span> <span class="o">*</span><span class="n">rsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rcu_data</span> <span class="o">*</span><span class="n">rdp</span><span class="p">;</span>

	<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rdp</span> <span class="o">=</span> <span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">rda</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdp</span><span class="o">-&gt;</span><span class="n">beenonline</span><span class="p">)</span>
			<span class="n">print_one_rcu_pending</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">rdp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">show_rcu_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_TREE_PREEMPT_RCU</span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;rcu_preempt:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">print_rcu_pendings</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rcu_preempt_state</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* #ifdef CONFIG_TREE_PREEMPT_RCU */</span><span class="cp"></span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;rcu_sched:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">print_rcu_pendings</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rcu_sched_state</span><span class="p">);</span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;rcu_bh:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">print_rcu_pendings</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rcu_bh_state</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rcu_pending_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">show_rcu_pending</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">rcu_pending_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">rcu_pending_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">show_rcutorture</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;rcutorture test sequence: %lu %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">rcutorture_testseq</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">rcutorture_testseq</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;(test in progress)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;rcutorture update version number: %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">rcutorture_vernum</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rcutorture_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">show_rcutorture</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">rcutorture_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">rcutorture_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">rcudir</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">rcutree_trace_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">retval</span><span class="p">;</span>

	<span class="n">rcudir</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="s">&quot;rcu&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rcudir</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_out</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;rcudata&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">rcudir</span><span class="p">,</span>
						<span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rcudata_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_out</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;rcudata.csv&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">rcudir</span><span class="p">,</span>
						<span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rcudata_csv_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rcu_boost_trace_create_file</span><span class="p">(</span><span class="n">rcudir</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">free_out</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;rcugp&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">rcudir</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rcugp_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_out</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;rcuhier&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">rcudir</span><span class="p">,</span>
						<span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rcuhier_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_out</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;rcu_pending&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">rcudir</span><span class="p">,</span>
						<span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rcu_pending_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_out</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;rcutorture&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">rcudir</span><span class="p">,</span>
						<span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rcutorture_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_out</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">free_out:</span>
	<span class="n">debugfs_remove_recursive</span><span class="p">(</span><span class="n">rcudir</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">rcutree_trace_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debugfs_remove_recursive</span><span class="p">(</span><span class="n">rcudir</span><span class="p">);</span>
<span class="p">}</span>


<span class="n">module_init</span><span class="p">(</span><span class="n">rcutree_trace_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">rcutree_trace_cleanup</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Paul E. McKenney&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Read-Copy Update tracing for hierarchical implementation&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:1}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../javascript/docco.min.js"></script>
</html>
