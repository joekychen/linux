<!DOCTYPE html>
<html><head><title>joekychen/linux » kernel › acct.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../index.html"></a><h1>acct.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/kernel/acct.c</span>
<span class="cm"> *</span>
<span class="cm"> *  BSD Process Accounting for Linux</span>
<span class="cm"> *</span>
<span class="cm"> *  Author: Marco van Wieringen &lt;mvw@planets.elm.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  Some code based on ideas and code from:</span>
<span class="cm"> *  Thomas K. Dyas &lt;tdyas@eden.rutgers.edu&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This file implements BSD-style process accounting. Whenever any</span>
<span class="cm"> *  process exits, an accounting record of type &quot;struct acct&quot; is</span>
<span class="cm"> *  written to the file specified with the acct() system call. It is</span>
<span class="cm"> *  up to user-level programs to do useful things with the accounting</span>
<span class="cm"> *  log. The kernel just provides the raw accounting information.</span>
<span class="cm"> *</span>
<span class="cm"> * (C) Copyright 1995 - 1997 Marco van Wieringen - ELM Consultancy B.V.</span>
<span class="cm"> *</span>
<span class="cm"> *  Plugged two leaks. 1) It didn&#39;t return acct_file into the free_filps if</span>
<span class="cm"> *  the file happened to be read-only. 2) If the accounting was suspended</span>
<span class="cm"> *  due to the lack of space it happily allowed to reopen it and completely</span>
<span class="cm"> *  lost the old acct_file. 3/10/98, Al Viro.</span>
<span class="cm"> *</span>
<span class="cm"> *  Now we silently close acct_file on attempt to reopen. Cleaned sys_acct().</span>
<span class="cm"> *  XTerms and EMACS are manifestations of pure evil. 21/10/98, AV.</span>
<span class="cm"> *</span>
<span class="cm"> *  Fixed a nasty interaction with with sys_umount(). If the accointing</span>
<span class="cm"> *  was suspeneded we failed to stop it on umount(). Messy.</span>
<span class="cm"> *  Another one: remount to readonly didn&#39;t stop accounting.</span>
<span class="cm"> *	Question: what should we do if we have CAP_SYS_ADMIN but not</span>
<span class="cm"> *  CAP_SYS_PACCT? Current code does the following: umount returns -EBUSY</span>
<span class="cm"> *  unless we are messing with the root. In that case we are getting a</span>
<span class="cm"> *  real mess with do_remount_sb(). 9/11/98, AV.</span>
<span class="cm"> *</span>
<span class="cm"> *  Fixed a bunch of races (and pair of leaks). Probably not the best way,</span>
<span class="cm"> *  but this one obviously doesn&#39;t introduce deadlocks. Later. BTW, found</span>
<span class="cm"> *  one race (and leak) in BSD implementation.</span>
<span class="cm"> *  OK, that&#39;s better. ANOTHER race and leak in BSD variant. There always</span>
<span class="cm"> *  is one more bug... 10/11/98, AV.</span>
<span class="cm"> *</span>
<span class="cm"> *	Oh, fsck... Oopsable SMP race in do_process_acct() - we must hold</span>
<span class="cm"> * -&gt;mmap_sem to walk the vma list of current-&gt;mm. Nasty, since it leaks</span>
<span class="cm"> * a struct file opened for write. Fixed. 2/6/2000, AV.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/acct.h&gt;</span>
<span class="cp">#include &lt;linux/capability.h&gt;</span>
<span class="cp">#include &lt;linux/file.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/security.h&gt;</span>
<span class="cp">#include &lt;linux/vfs.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/times.h&gt;</span>
<span class="cp">#include &lt;linux/syscalls.h&gt;</span>
<span class="cp">#include &lt;linux/mount.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/div64.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt; </span><span class="cm">/* sector_div */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/pid_namespace.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * These constants control the amount of freespace that suspend and</span>
<span class="cm"> * resume the process accounting system, and the time delay between</span>
<span class="cm"> * each check.</span>
<span class="cm"> * Turned into sysctl-controllable parameters. AV, 12/11/98</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="n">acct_parm</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">30</span><span class="p">};</span>
<span class="cp">#define RESUME		(acct_parm[0])	</span><span class="cm">/* &gt;foo% free space - resume */</span><span class="cp"></span>
<span class="cp">#define SUSPEND		(acct_parm[1])	</span><span class="cm">/* &lt;foo% free space - suspend */</span><span class="cp"></span>
<span class="cp">#define ACCT_TIMEOUT	(acct_parm[2])	</span><span class="cm">/* foo second timeout between checks */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * External references and all of the globals.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">do_acct_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">bsd_acct_struct</span> <span class="o">*</span><span class="n">acct</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">pid_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * This structure is used so that all the data protected by lock</span>
<span class="cm"> * can be placed in the same cache line as the lock.  This primes</span>
<span class="cm"> * the cache line to have the data after getting the lock.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">bsd_acct_struct</span> <span class="p">{</span>
	<span class="kt">int</span>			<span class="n">active</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">needcheck</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">file</span>		<span class="o">*</span><span class="n">file</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pid_namespace</span>	<span class="o">*</span><span class="n">ns</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">list</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">acct_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">acct_list</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Check the amount of free space and suspend/resume accordingly.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_free_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">bsd_acct_struct</span> <span class="o">*</span><span class="n">acct</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kstatfs</span> <span class="n">sbuf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">act</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">resume</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">suspend</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acct_lock</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">acct</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">file</span> <span class="o">||</span> <span class="n">time_is_before_jiffies</span><span class="p">(</span><span class="n">acct</span><span class="o">-&gt;</span><span class="n">needcheck</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acct_lock</span><span class="p">);</span>

	<span class="cm">/* May block */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vfs_statfs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sbuf</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">suspend</span> <span class="o">=</span> <span class="n">sbuf</span><span class="p">.</span><span class="n">f_blocks</span> <span class="o">*</span> <span class="n">SUSPEND</span><span class="p">;</span>
	<span class="n">resume</span> <span class="o">=</span> <span class="n">sbuf</span><span class="p">.</span><span class="n">f_blocks</span> <span class="o">*</span> <span class="n">RESUME</span><span class="p">;</span>

	<span class="n">do_div</span><span class="p">(</span><span class="n">suspend</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">resume</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbuf</span><span class="p">.</span><span class="n">f_bavail</span> <span class="o">&lt;=</span> <span class="n">suspend</span><span class="p">)</span>
		<span class="n">act</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sbuf</span><span class="p">.</span><span class="n">f_bavail</span> <span class="o">&gt;=</span> <span class="n">resume</span><span class="p">)</span>
		<span class="n">act</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">act</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If some joker switched acct-&gt;file under us we&#39;ld better be</span>
<span class="cm">	 * silent and _not_ touch anything.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acct_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">file</span> <span class="o">!=</span> <span class="n">acct</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">act</span><span class="p">)</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">act</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acct</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">act</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">acct</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Process accounting paused</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">act</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">acct</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Process accounting resumed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">acct</span><span class="o">-&gt;</span><span class="n">needcheck</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">ACCT_TIMEOUT</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">acct</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acct_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Close the old accounting file (if currently open) and then replace</span>
<span class="cm"> * it with file (if non-NULL).</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: acct_lock MUST be held on entry and exit.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">acct_file_reopen</span><span class="p">(</span><span class="k">struct</span> <span class="n">bsd_acct_struct</span> <span class="o">*</span><span class="n">acct</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">pid_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">old_acct</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pid_namespace</span> <span class="o">*</span><span class="n">old_ns</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acct</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">old_acct</span> <span class="o">=</span> <span class="n">acct</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">;</span>
		<span class="n">old_ns</span> <span class="o">=</span> <span class="n">acct</span><span class="o">-&gt;</span><span class="n">ns</span><span class="p">;</span>
		<span class="n">acct</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">acct</span><span class="o">-&gt;</span><span class="n">file</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">acct</span><span class="o">-&gt;</span><span class="n">ns</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acct</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">acct</span><span class="o">-&gt;</span><span class="n">file</span> <span class="o">=</span> <span class="n">file</span><span class="p">;</span>
		<span class="n">acct</span><span class="o">-&gt;</span><span class="n">ns</span> <span class="o">=</span> <span class="n">ns</span><span class="p">;</span>
		<span class="n">acct</span><span class="o">-&gt;</span><span class="n">needcheck</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">ACCT_TIMEOUT</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
		<span class="n">acct</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acct</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acct_list</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_acct</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mnt_unpin</span><span class="p">(</span><span class="n">old_acct</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">mnt</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acct_lock</span><span class="p">);</span>
		<span class="n">do_acct_process</span><span class="p">(</span><span class="n">acct</span><span class="p">,</span> <span class="n">old_ns</span><span class="p">,</span> <span class="n">old_acct</span><span class="p">);</span>
		<span class="n">filp_close</span><span class="p">(</span><span class="n">old_acct</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acct_lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acct_on</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vfsmount</span> <span class="o">*</span><span class="n">mnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pid_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bsd_acct_struct</span> <span class="o">*</span><span class="n">acct</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Difference from BSD - they don&#39;t do O_APPEND */</span>
	<span class="n">file</span> <span class="o">=</span> <span class="n">filp_open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">O_WRONLY</span><span class="o">|</span><span class="n">O_APPEND</span><span class="o">|</span><span class="n">O_LARGEFILE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">filp_close</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">filp_close</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ns</span> <span class="o">=</span> <span class="n">task_active_pid_ns</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">bacct</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">acct</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bsd_acct_struct</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acct</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">filp_close</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acct_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">bacct</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">bacct</span> <span class="o">=</span> <span class="n">acct</span><span class="p">;</span>
		<span class="n">acct</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mnt</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">mnt</span><span class="p">;</span>
	<span class="n">mnt_pin</span><span class="p">(</span><span class="n">mnt</span><span class="p">);</span>
	<span class="n">acct_file_reopen</span><span class="p">(</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">bacct</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">ns</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acct_lock</span><span class="p">);</span>

	<span class="n">mntput</span><span class="p">(</span><span class="n">mnt</span><span class="p">);</span> <span class="cm">/* it&#39;s pinned, now give up active reference */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acct</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sys_acct - enable/disable process accounting</span>
<span class="cm"> * @name: file name for accounting records or NULL to shutdown accounting</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success or negative errno values for failure.</span>
<span class="cm"> *</span>
<span class="cm"> * sys_acct() is the only system call needed to implement process</span>
<span class="cm"> * accounting. It takes the name of the file where accounting records</span>
<span class="cm"> * should be written. If the filename is NULL, accounting will be</span>
<span class="cm"> * shutdown.</span>
<span class="cm"> */</span>
<span class="n">SYSCALL_DEFINE1</span><span class="p">(</span><span class="n">acct</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_PACCT</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">getname</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">tmp</span><span class="p">))</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">acct_on</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
		<span class="n">putname</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bsd_acct_struct</span> <span class="o">*</span><span class="n">acct</span><span class="p">;</span>

		<span class="n">acct</span> <span class="o">=</span> <span class="n">task_active_pid_ns</span><span class="p">(</span><span class="n">current</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bacct</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acct</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acct_lock</span><span class="p">);</span>
		<span class="n">acct_file_reopen</span><span class="p">(</span><span class="n">acct</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acct_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * acct_auto_close - turn off a filesystem&#39;s accounting if it is on</span>
<span class="cm"> * @m: vfsmount being shut down</span>
<span class="cm"> *</span>
<span class="cm"> * If the accounting is turned on for a file in the subtree pointed to</span>
<span class="cm"> * to by m, turn accounting off.  Done when m is about to die.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">acct_auto_close_mnt</span><span class="p">(</span><span class="k">struct</span> <span class="n">vfsmount</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bsd_acct_struct</span> <span class="o">*</span><span class="n">acct</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acct_lock</span><span class="p">);</span>
<span class="nl">restart:</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">acct</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acct_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acct</span><span class="o">-&gt;</span><span class="n">file</span> <span class="o">&amp;&amp;</span> <span class="n">acct</span><span class="o">-&gt;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">mnt</span> <span class="o">==</span> <span class="n">m</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">acct_file_reopen</span><span class="p">(</span><span class="n">acct</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acct_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * acct_auto_close - turn off a filesystem&#39;s accounting if it is on</span>
<span class="cm"> * @sb: super block for the filesystem</span>
<span class="cm"> *</span>
<span class="cm"> * If the accounting is turned on for a file in the filesystem pointed</span>
<span class="cm"> * to by sb, turn accounting off.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">acct_auto_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bsd_acct_struct</span> <span class="o">*</span><span class="n">acct</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acct_lock</span><span class="p">);</span>
<span class="nl">restart:</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">acct</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acct_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acct</span><span class="o">-&gt;</span><span class="n">file</span> <span class="o">&amp;&amp;</span> <span class="n">acct</span><span class="o">-&gt;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_sb</span> <span class="o">==</span> <span class="n">sb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">acct_file_reopen</span><span class="p">(</span><span class="n">acct</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acct_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">acct_exit_ns</span><span class="p">(</span><span class="k">struct</span> <span class="n">pid_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bsd_acct_struct</span> <span class="o">*</span><span class="n">acct</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">bacct</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acct</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acct_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acct</span><span class="o">-&gt;</span><span class="n">file</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">acct_file_reopen</span><span class="p">(</span><span class="n">acct</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acct_lock</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">acct</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  encode an unsigned long into a comp_t</span>
<span class="cm"> *</span>
<span class="cm"> *  This routine has been adopted from the encode_comp_t() function in</span>
<span class="cm"> *  the kern_acct.c file of the FreeBSD operating system. The encoding</span>
<span class="cm"> *  is a 13-bit fraction with a 3-bit (base 8) exponent.</span>
<span class="cm"> */</span>

<span class="cp">#define	MANTSIZE	13			</span><span class="cm">/* 13 bit mantissa. */</span><span class="cp"></span>
<span class="cp">#define	EXPSIZE		3			</span><span class="cm">/* Base 8 (3 bit) exponent. */</span><span class="cp"></span>
<span class="cp">#define	MAXFRACT	((1 &lt;&lt; MANTSIZE) - 1)	</span><span class="cm">/* Maximum fractional value. */</span><span class="cp"></span>

<span class="k">static</span> <span class="n">comp_t</span> <span class="n">encode_comp_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">exp</span><span class="p">,</span> <span class="n">rnd</span><span class="p">;</span>

	<span class="n">exp</span> <span class="o">=</span> <span class="n">rnd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">MAXFRACT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rnd</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">EXPSIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>	<span class="cm">/* Round up? */</span>
		<span class="n">value</span> <span class="o">&gt;&gt;=</span> <span class="n">EXPSIZE</span><span class="p">;</span>	<span class="cm">/* Base 8 exponent == 3 bit shift. */</span>
		<span class="n">exp</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we need to round up, do it (and handle overflow correctly).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rnd</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">++</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">MAXFRACT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">&gt;&gt;=</span> <span class="n">EXPSIZE</span><span class="p">;</span>
		<span class="n">exp</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clean it up and polish it off.</span>
<span class="cm">	 */</span>
	<span class="n">exp</span> <span class="o">&lt;&lt;=</span> <span class="n">MANTSIZE</span><span class="p">;</span>		<span class="cm">/* Shift the exponent into place */</span>
	<span class="n">exp</span> <span class="o">+=</span> <span class="n">value</span><span class="p">;</span>			<span class="cm">/* and add on the mantissa. */</span>
	<span class="k">return</span> <span class="n">exp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if ACCT_VERSION==1 || ACCT_VERSION==2</span>
<span class="cm">/*</span>
<span class="cm"> * encode an u64 into a comp2_t (24 bits)</span>
<span class="cm"> *</span>
<span class="cm"> * Format: 5 bit base 2 exponent, 20 bits mantissa.</span>
<span class="cm"> * The leading bit of the mantissa is not stored, but implied for</span>
<span class="cm"> * non-zero exponents.</span>
<span class="cm"> * Largest encodable value is 50 bits.</span>
<span class="cm"> */</span>

<span class="cp">#define MANTSIZE2       20                      </span><span class="cm">/* 20 bit mantissa. */</span><span class="cp"></span>
<span class="cp">#define EXPSIZE2        5                       </span><span class="cm">/* 5 bit base 2 exponent. */</span><span class="cp"></span>
<span class="cp">#define MAXFRACT2       ((1ul &lt;&lt; MANTSIZE2) - 1) </span><span class="cm">/* Maximum fractional value. */</span><span class="cp"></span>
<span class="cp">#define MAXEXP2         ((1 &lt;&lt;EXPSIZE2) - 1)    </span><span class="cm">/* Maximum exponent. */</span><span class="cp"></span>

<span class="k">static</span> <span class="n">comp2_t</span> <span class="n">encode_comp2_t</span><span class="p">(</span><span class="n">u64</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">exp</span><span class="p">,</span> <span class="n">rnd</span><span class="p">;</span>

	<span class="n">exp</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">MAXFRACT2</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">rnd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">MAXFRACT2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rnd</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">exp</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we need to round up, do it (and handle overflow correctly).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rnd</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">++</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">MAXFRACT2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">exp</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">exp</span> <span class="o">&gt;</span> <span class="n">MAXEXP2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Overflow. Return largest representable number instead. */</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">1ul</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">MANTSIZE2</span><span class="o">+</span><span class="n">EXPSIZE2</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MAXFRACT2</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">exp</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">MANTSIZE2</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#if ACCT_VERSION==3</span>
<span class="cm">/*</span>
<span class="cm"> * encode an u64 into a 32 bit IEEE float</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">encode_float</span><span class="p">(</span><span class="n">u64</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">exp</span> <span class="o">=</span> <span class="mi">190</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">u</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">s64</span><span class="p">)</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
		<span class="n">value</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">exp</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">u</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">40</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7fffffu</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">u</span> <span class="o">|</span> <span class="p">(</span><span class="n">exp</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> *  Write an accounting entry for an exiting process</span>
<span class="cm"> *</span>
<span class="cm"> *  The acct_process() call is the workhorse of the process</span>
<span class="cm"> *  accounting system. The struct acct is built here and then written</span>
<span class="cm"> *  into the accounting file. This function should only be called from</span>
<span class="cm"> *  do_exit() or when switching to a different output file.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *  do_acct_process does all actual work. Caller holds the reference to file.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">do_acct_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">bsd_acct_struct</span> <span class="o">*</span><span class="n">acct</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">pid_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pacct_struct</span> <span class="o">*</span><span class="n">pacct</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">signal</span><span class="o">-&gt;</span><span class="n">pacct</span><span class="p">;</span>
	<span class="n">acct_t</span> <span class="n">ac</span><span class="p">;</span>
	<span class="n">mm_segment_t</span> <span class="n">fs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flim</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">elapsed</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">run_time</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">uptime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">cred</span> <span class="o">*</span><span class="n">orig_cred</span><span class="p">;</span>

	<span class="cm">/* Perform file operations on behalf of whoever enabled accounting */</span>
	<span class="n">orig_cred</span> <span class="o">=</span> <span class="n">override_creds</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_cred</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * First check to see if there is enough free_space to continue</span>
<span class="cm">	 * the process accounting system.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_free_space</span><span class="p">(</span><span class="n">acct</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fill the accounting struct with the needed info as recorded</span>
<span class="cm">	 * by the different kernel functions.</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">acct_t</span><span class="p">));</span>

	<span class="n">ac</span><span class="p">.</span><span class="n">ac_version</span> <span class="o">=</span> <span class="n">ACCT_VERSION</span> <span class="o">|</span> <span class="n">ACCT_BYTEORDER</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">ac</span><span class="p">.</span><span class="n">ac_comm</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ac</span><span class="p">.</span><span class="n">ac_comm</span><span class="p">));</span>

	<span class="cm">/* calculate run_time in nsec*/</span>
	<span class="n">do_posix_clock_monotonic_gettime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uptime</span><span class="p">);</span>
	<span class="n">run_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">uptime</span><span class="p">.</span><span class="n">tv_sec</span><span class="o">*</span><span class="n">NSEC_PER_SEC</span> <span class="o">+</span> <span class="n">uptime</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">;</span>
	<span class="n">run_time</span> <span class="o">-=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">group_leader</span><span class="o">-&gt;</span><span class="n">start_time</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">*</span> <span class="n">NSEC_PER_SEC</span>
		       <span class="o">+</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">group_leader</span><span class="o">-&gt;</span><span class="n">start_time</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">;</span>
	<span class="cm">/* convert nsec -&gt; AHZ */</span>
	<span class="n">elapsed</span> <span class="o">=</span> <span class="n">nsec_to_AHZ</span><span class="p">(</span><span class="n">run_time</span><span class="p">);</span>
<span class="cp">#if ACCT_VERSION==3</span>
	<span class="n">ac</span><span class="p">.</span><span class="n">ac_etime</span> <span class="o">=</span> <span class="n">encode_float</span><span class="p">(</span><span class="n">elapsed</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">ac</span><span class="p">.</span><span class="n">ac_etime</span> <span class="o">=</span> <span class="n">encode_comp_t</span><span class="p">(</span><span class="n">elapsed</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">-</span><span class="mi">1l</span> <span class="o">?</span>
	                       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">elapsed</span> <span class="o">:</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">-</span><span class="mi">1l</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#if ACCT_VERSION==1 || ACCT_VERSION==2</span>
	<span class="p">{</span>
		<span class="cm">/* new enlarged etime field */</span>
		<span class="n">comp2_t</span> <span class="n">etime</span> <span class="o">=</span> <span class="n">encode_comp2_t</span><span class="p">(</span><span class="n">elapsed</span><span class="p">);</span>
		<span class="n">ac</span><span class="p">.</span><span class="n">ac_etime_hi</span> <span class="o">=</span> <span class="n">etime</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">ac</span><span class="p">.</span><span class="n">ac_etime_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">etime</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">elapsed</span><span class="p">,</span> <span class="n">AHZ</span><span class="p">);</span>
	<span class="n">ac</span><span class="p">.</span><span class="n">ac_btime</span> <span class="o">=</span> <span class="n">get_seconds</span><span class="p">()</span> <span class="o">-</span> <span class="n">elapsed</span><span class="p">;</span>
	<span class="cm">/* we really need to bite the bullet and change layout */</span>
	<span class="n">ac</span><span class="p">.</span><span class="n">ac_uid</span> <span class="o">=</span> <span class="n">orig_cred</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">;</span>
	<span class="n">ac</span><span class="p">.</span><span class="n">ac_gid</span> <span class="o">=</span> <span class="n">orig_cred</span><span class="o">-&gt;</span><span class="n">gid</span><span class="p">;</span>
<span class="cp">#if ACCT_VERSION==2</span>
	<span class="n">ac</span><span class="p">.</span><span class="n">ac_ahz</span> <span class="o">=</span> <span class="n">AHZ</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if ACCT_VERSION==1 || ACCT_VERSION==2</span>
	<span class="cm">/* backward-compatible 16 bit fields */</span>
	<span class="n">ac</span><span class="p">.</span><span class="n">ac_uid16</span> <span class="o">=</span> <span class="n">ac</span><span class="p">.</span><span class="n">ac_uid</span><span class="p">;</span>
	<span class="n">ac</span><span class="p">.</span><span class="n">ac_gid16</span> <span class="o">=</span> <span class="n">ac</span><span class="p">.</span><span class="n">ac_gid</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if ACCT_VERSION==3</span>
	<span class="n">ac</span><span class="p">.</span><span class="n">ac_pid</span> <span class="o">=</span> <span class="n">task_tgid_nr_ns</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">ns</span><span class="p">);</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">ac</span><span class="p">.</span><span class="n">ac_ppid</span> <span class="o">=</span> <span class="n">task_tgid_nr_ns</span><span class="p">(</span><span class="n">rcu_dereference</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">real_parent</span><span class="p">),</span> <span class="n">ns</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="cp">#endif</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">sighand</span><span class="o">-&gt;</span><span class="n">siglock</span><span class="p">);</span>
	<span class="n">tty</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">signal</span><span class="o">-&gt;</span><span class="n">tty</span><span class="p">;</span>	<span class="cm">/* Safe as we hold the siglock */</span>
	<span class="n">ac</span><span class="p">.</span><span class="n">ac_tty</span> <span class="o">=</span> <span class="n">tty</span> <span class="o">?</span> <span class="n">old_encode_dev</span><span class="p">(</span><span class="n">tty_devnum</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ac</span><span class="p">.</span><span class="n">ac_utime</span> <span class="o">=</span> <span class="n">encode_comp_t</span><span class="p">(</span><span class="n">jiffies_to_AHZ</span><span class="p">(</span><span class="n">cputime_to_jiffies</span><span class="p">(</span><span class="n">pacct</span><span class="o">-&gt;</span><span class="n">ac_utime</span><span class="p">)));</span>
	<span class="n">ac</span><span class="p">.</span><span class="n">ac_stime</span> <span class="o">=</span> <span class="n">encode_comp_t</span><span class="p">(</span><span class="n">jiffies_to_AHZ</span><span class="p">(</span><span class="n">cputime_to_jiffies</span><span class="p">(</span><span class="n">pacct</span><span class="o">-&gt;</span><span class="n">ac_stime</span><span class="p">)));</span>
	<span class="n">ac</span><span class="p">.</span><span class="n">ac_flag</span> <span class="o">=</span> <span class="n">pacct</span><span class="o">-&gt;</span><span class="n">ac_flag</span><span class="p">;</span>
	<span class="n">ac</span><span class="p">.</span><span class="n">ac_mem</span> <span class="o">=</span> <span class="n">encode_comp_t</span><span class="p">(</span><span class="n">pacct</span><span class="o">-&gt;</span><span class="n">ac_mem</span><span class="p">);</span>
	<span class="n">ac</span><span class="p">.</span><span class="n">ac_minflt</span> <span class="o">=</span> <span class="n">encode_comp_t</span><span class="p">(</span><span class="n">pacct</span><span class="o">-&gt;</span><span class="n">ac_minflt</span><span class="p">);</span>
	<span class="n">ac</span><span class="p">.</span><span class="n">ac_majflt</span> <span class="o">=</span> <span class="n">encode_comp_t</span><span class="p">(</span><span class="n">pacct</span><span class="o">-&gt;</span><span class="n">ac_majflt</span><span class="p">);</span>
	<span class="n">ac</span><span class="p">.</span><span class="n">ac_exitcode</span> <span class="o">=</span> <span class="n">pacct</span><span class="o">-&gt;</span><span class="n">ac_exitcode</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">sighand</span><span class="o">-&gt;</span><span class="n">siglock</span><span class="p">);</span>
	<span class="n">ac</span><span class="p">.</span><span class="n">ac_io</span> <span class="o">=</span> <span class="n">encode_comp_t</span><span class="p">(</span><span class="mi">0</span> <span class="cm">/* current-&gt;io_usage */</span><span class="p">);</span>	<span class="cm">/* %% */</span>
	<span class="n">ac</span><span class="p">.</span><span class="n">ac_rw</span> <span class="o">=</span> <span class="n">encode_comp_t</span><span class="p">(</span><span class="n">ac</span><span class="p">.</span><span class="n">ac_io</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>
	<span class="n">ac</span><span class="p">.</span><span class="n">ac_swaps</span> <span class="o">=</span> <span class="n">encode_comp_t</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Kernel segment override to datasegment and write it</span>
<span class="cm">	 * to the accounting file.</span>
<span class="cm">	 */</span>
	<span class="n">fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Accounting records are not subject to resource limits.</span>
<span class="cm">	 */</span>
	<span class="n">flim</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">signal</span><span class="o">-&gt;</span><span class="n">rlim</span><span class="p">[</span><span class="n">RLIMIT_FSIZE</span><span class="p">].</span><span class="n">rlim_cur</span><span class="p">;</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="n">signal</span><span class="o">-&gt;</span><span class="n">rlim</span><span class="p">[</span><span class="n">RLIMIT_FSIZE</span><span class="p">].</span><span class="n">rlim_cur</span> <span class="o">=</span> <span class="n">RLIM_INFINITY</span><span class="p">;</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ac</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="n">acct_t</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="p">);</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="n">signal</span><span class="o">-&gt;</span><span class="n">rlim</span><span class="p">[</span><span class="n">RLIMIT_FSIZE</span><span class="p">].</span><span class="n">rlim_cur</span> <span class="o">=</span> <span class="n">flim</span><span class="p">;</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">revert_creds</span><span class="p">(</span><span class="n">orig_cred</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * acct_collect - collect accounting information into pacct_struct</span>
<span class="cm"> * @exitcode: task exit code</span>
<span class="cm"> * @group_dead: not 0, if this thread is the last one in the process.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">acct_collect</span><span class="p">(</span><span class="kt">long</span> <span class="n">exitcode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">group_dead</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pacct_struct</span> <span class="o">*</span><span class="n">pacct</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">signal</span><span class="o">-&gt;</span><span class="n">pacct</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">group_dead</span> <span class="o">&amp;&amp;</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">;</span>
		<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>
		<span class="n">vma</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">vma</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vsize</span> <span class="o">+=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">;</span>
			<span class="n">vma</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">sighand</span><span class="o">-&gt;</span><span class="n">siglock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">group_dead</span><span class="p">)</span>
		<span class="n">pacct</span><span class="o">-&gt;</span><span class="n">ac_mem</span> <span class="o">=</span> <span class="n">vsize</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thread_group_leader</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pacct</span><span class="o">-&gt;</span><span class="n">ac_exitcode</span> <span class="o">=</span> <span class="n">exitcode</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PF_FORKNOEXEC</span><span class="p">)</span>
			<span class="n">pacct</span><span class="o">-&gt;</span><span class="n">ac_flag</span> <span class="o">|=</span> <span class="n">AFORK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PF_SUPERPRIV</span><span class="p">)</span>
		<span class="n">pacct</span><span class="o">-&gt;</span><span class="n">ac_flag</span> <span class="o">|=</span> <span class="n">ASU</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PF_DUMPCORE</span><span class="p">)</span>
		<span class="n">pacct</span><span class="o">-&gt;</span><span class="n">ac_flag</span> <span class="o">|=</span> <span class="n">ACORE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PF_SIGNALED</span><span class="p">)</span>
		<span class="n">pacct</span><span class="o">-&gt;</span><span class="n">ac_flag</span> <span class="o">|=</span> <span class="n">AXSIG</span><span class="p">;</span>
	<span class="n">pacct</span><span class="o">-&gt;</span><span class="n">ac_utime</span> <span class="o">+=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">utime</span><span class="p">;</span>
	<span class="n">pacct</span><span class="o">-&gt;</span><span class="n">ac_stime</span> <span class="o">+=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">stime</span><span class="p">;</span>
	<span class="n">pacct</span><span class="o">-&gt;</span><span class="n">ac_minflt</span> <span class="o">+=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">min_flt</span><span class="p">;</span>
	<span class="n">pacct</span><span class="o">-&gt;</span><span class="n">ac_majflt</span> <span class="o">+=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">maj_flt</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">sighand</span><span class="o">-&gt;</span><span class="n">siglock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">acct_process_in_ns</span><span class="p">(</span><span class="k">struct</span> <span class="n">pid_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bsd_acct_struct</span> <span class="o">*</span><span class="n">acct</span><span class="p">;</span>

	<span class="n">acct</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">bacct</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * accelerate the common fastpath:</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acct</span> <span class="o">||</span> <span class="o">!</span><span class="n">acct</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acct_lock</span><span class="p">);</span>
	<span class="n">file</span> <span class="o">=</span> <span class="n">acct</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acct_lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">get_file</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acct_lock</span><span class="p">);</span>

	<span class="n">do_acct_process</span><span class="p">(</span><span class="n">acct</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
	<span class="n">fput</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * acct_process - now just a wrapper around acct_process_in_ns,</span>
<span class="cm"> * which in turn is a wrapper around do_acct_process.</span>
<span class="cm"> *</span>
<span class="cm"> * handles process accounting for an exiting task</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">acct_process</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pid_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This loop is safe lockless, since current is still</span>
<span class="cm">	 * alive and holds its namespace, which in turn holds</span>
<span class="cm">	 * its parent.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ns</span> <span class="o">=</span> <span class="n">task_active_pid_ns</span><span class="p">(</span><span class="n">current</span><span class="p">);</span> <span class="n">ns</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">ns</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span>
		<span class="n">acct_process_in_ns</span><span class="p">(</span><span class="n">ns</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:1}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../javascript/docco.min.js"></script>
</html>
